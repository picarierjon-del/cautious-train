<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Finanza Smart 6.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family:'Inter',sans-serif; }
    .dark body, body.dark{background:#0f172a;color:#f1f5f9;}
    .card{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.06);}
  </style>
  <link id="dynamic-manifest" rel="manifest">
</head>
<body class="min-h-screen">

<div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl card w-80 text-center">
    <h2 class="text-xl font-bold mb-3">ğŸ” Accesso</h2>
    <input type="password" id="pin-input" placeholder="Inserisci PIN" class="w-full p-2 border rounded-lg mb-4"/>
    <button id="login-btn" class="w-full bg-emerald-500 text-white p-2 rounded-lg font-bold">Accedi</button>
    <p id="pin-msg" class="text-sm text-red-500 mt-2 hidden"></p>
  </div>
</div>

<div id="app" class="hidden max-w-4xl mx-auto p-4 md:p-6">
  <header class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Finanza Smart 6.0 ğŸš€</h1>
    <button id="theme-toggle" class="px-3 py-1 border rounded">ğŸŒ™</button>
  </header>
  <nav id="navbar" class="flex justify-around bg-white dark:bg-gray-800 p-2 rounded-xl card"></nav>
  <div id="content-area" class="mt-4"></div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-xl shadow-lg opacity-0">Toast</div>

<script>
/* === CONFIG === */
const LOCAL_KEY="finanzaSmart6";
let pinKey=null; // verrÃ  settata al login
let appData={invoices:[],expenses:[],reminders:[],contacts:[],categories:[],lastId:0};

/* === STORAGE cifrato === */
function encryptData(data,pin){
  return CryptoJS.AES.encrypt(JSON.stringify(data),pin).toString();
}
function decryptData(cipher,pin){
  try{
    const bytes=CryptoJS.AES.decrypt(cipher,pin);
    return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
  }catch(e){return null;}
}
function loadData(){
  const raw=localStorage.getItem(LOCAL_KEY);
  if(!raw) return appData;
  const dec=decryptData(raw,pinKey);
  if(dec){ appData={...appData,...dec}; }
}
function saveData(){
  localStorage.setItem(LOCAL_KEY, encryptData(appData,pinKey));
}
function getNextId(){ appData.lastId++; saveData(); return appData.lastId; }

/* === UI === */
function showToast(msg,color="green"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=`fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-lg opacity-100 bg-${color}-500 text-white`;
  setTimeout(()=>t.classList.replace("opacity-100","opacity-0"),2000);
}
function toggleTheme(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme", document.body.classList.contains("dark")?"dark":"light");
}

/* === LOGIN === */
document.getElementById("login-btn").onclick=()=>{
  const pin=document.getElementById("pin-input").value;
  pinKey=pin;
  const raw=localStorage.getItem(LOCAL_KEY);
  if(!raw){ // prima volta
    saveData(); document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    renderPage("report");
  } else {
    const test=decryptData(raw,pin);
    if(test){ appData=test; document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      renderPage("report");
    } else {
      document.getElementById("pin-msg").classList.remove("hidden");
      document.getElementById("pin-msg").textContent="PIN errato!";
    }
  }
};/* === NAVBAR === */
let currentPage="report";
function renderNavbar(){
  const nav=document.getElementById("navbar");
  const items=[
    {id:"activity",label:"AttivitÃ ",icon:"ğŸ’¼"},
    {id:"personal",label:"Personale",icon:"ğŸ "},
    {id:"report",label:"Riepilogo",icon:"ğŸ“Š"},
    {id:"reminders",label:"Scadenze",icon:"ğŸ””"},
    {id:"settings",label:"Dati",icon:"âš™ï¸"}
  ];
  nav.innerHTML=items.map(i=>
    `<button onclick="renderPage('${i.id}')" class="p-2 ${currentPage===i.id?'border-b-2 border-emerald-500':''}">${i.icon} ${i.label}</button>`
  ).join("");
}

/* === LOGICA FINANZIARIA === */
function calculateFinancialSummary(type="global"){
  const txs=[...appData.invoices.map(t=>({...t,isIncome:true})),...appData.expenses.map(t=>({...t,isIncome:false}))];
  const filtered=type==="global"?txs:txs.filter(t=>t.type===type);
  let totalIn=0,totalOut=0;
  filtered.forEach(t=>{ if(t.isIncome) totalIn+=t.gross; else totalOut+=t.gross;});
  return {totalIn,totalOut,net:totalIn-totalOut,transactions:filtered};
}

/* === CSV IMPORT === */
function importCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split("\n").map(l=>l.split(","));
    if(lines.length<2){showToast("CSV vuoto","red");return;}
    // prima riga = intestazioni
    const headers=lines[0];
    const dateIdx=headers.findIndex(h=>/data/i.test(h));
    const descIdx=headers.findIndex(h=>/desc/i.test(h));
    const amtIdx=headers.findIndex(h=>/importo|amount/i.test(h));
    lines.slice(1).forEach(row=>{
      const date=row[dateIdx], desc=row[descIdx], amt=parseFloat(row[amtIdx]);
      if(!date||isNaN(amt)) return;
      const isIn=amt>0;
      const obj={id:getNextId(),type:"activity",date,description:desc,net:Math.abs(amt),vatRate:0,vatAmount:0,gross:Math.abs(amt)};
      if(isIn) appData.invoices.push(obj); else appData.expenses.push(obj);
    });
    saveData(); showToast("Import CSV completato!");
    renderPage("report");
  };
  reader.readAsText(file);
}

/* === FORECAST === */
function forecastCashflow(){
  const txs=calculateFinancialSummary("global").transactions;
  if(txs.length<3) return [];
  // raggruppo per mese
  const monthly={};
  txs.forEach(t=>{
    const ym=t.date.slice(0,7);
    if(!monthly[ym]) monthly[ym]=0;
    monthly[ym]+= t.isIncome?t.gross:-t.gross;
  });
  const labels=Object.keys(monthly).sort();
  const values=labels.map(l=>monthly[l]);
  const avg=values.reduce((a,b)=>a+b,0)/values.length;
  const last=new Date(labels[labels.length-1]+"-01");
  const forecasts=[];
  for(let i=1;i<=3;i++){
    const f=new Date(last); f.setMonth(f.getMonth()+i);
    forecasts.push({label:f.toISOString().slice(0,7),value:avg});
  }
  return {labels,values,forecasts};
}

/* === PAGINE === */
function renderReportPage(){
  const summary=calculateFinancialSummary("global");
  const fc=forecastCashflow();
  return `
  <div class="space-y-6">
    <h2 class="text-2xl font-bold">ğŸ“Š Riepilogo</h2>
    <div class="grid grid-cols-3 gap-4">
      <div class="card p-4 text-center">Entrate<br><b class="text-green-600">${summary.totalIn.toFixed(2)} â‚¬</b></div>
      <div class="card p-4 text-center">Uscite<br><b class="text-red-600">${summary.totalOut.toFixed(2)} â‚¬</b></div>
      <div class="card p-4 text-center">Saldo<br><b class="${summary.net>=0?'text-green-600':'text-red-600'}">${summary.net.toFixed(2)} â‚¬</b></div>
    </div>
    <canvas id="trendChart"></canvas>
    <canvas id="forecastChart"></canvas>
  </div>`;
}
function renderSettingsPage(){
  return `
    <h2 class="text-xl font-bold mb-4">âš™ï¸ Gestione Dati</h2>
    <div class="space-y-4">
      <button onclick="exportData()" class="bg-indigo-500 text-white p-2 rounded">Esporta JSON</button>
      <input type="file" id="import-file" accept=".json" class="block mt-2"/>
      <label class="block mt-4">Importa CSV Bancario:<input type="file" id="import-csv" accept=".csv" class="block mt-1"/></label>
    </div>`;
}
function renderRemindersPage(){
  const list=appData.reminders||[];
  return `
    <h2 class="text-xl font-bold mb-4">ğŸ”” Promemoria</h2>
    <button onclick="addDummyReminder()" class="bg-emerald-500 text-white px-2 py-1 rounded">+ Aggiungi finto</button>
    <ul class="mt-3 space-y-2">${list.map(r=>`<li class="card p-2">${r.description} - ${r.date}</li>`).join("")}</ul>`;
}
function renderActivityOrPersonalPage(type){
  return `<h2 class="text-xl">ğŸ“‘ ${type==="activity"?"AttivitÃ ":"Personale"}</h2>
    <p>Gestione entrate/uscite (placeholder semplificato).</p>`;
}

/* === EXPORT === */
function exportData(){
  const blob=new Blob([JSON.stringify(appData,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="backup.json";a.click();
}

/* === EVENTI === */
function renderPage(id){
  currentPage=id; renderNavbar();
  const area=document.getElementById("content-area");
  if(id==="report") area.innerHTML=renderReportPage();
  if(id==="settings") area.innerHTML=renderSettingsPage();
  if(id==="reminders") area.innerHTML=renderRemindersPage();
  if(id==="activity"||id==="personal") area.innerHTML=renderActivityOrPersonalPage(id);

  if(id==="report"){
    const sum=calculateFinancialSummary("global");
    const ctx=document.getElementById("trendChart").getContext("2d");
    const txs=sum.transactions;
    const grouped={}; txs.forEach(t=>{const ym=t.date.slice(0,7); if(!grouped[ym]) grouped[ym]={in:0,out:0}; if(t.isIncome) grouped[ym].in+=t.gross; else grouped[ym].out+=t.gross;});
    const labels=Object.keys(grouped).sort(); const inVals=labels.map(l=>grouped[l].in); const outVals=labels.map(l=>grouped[l].out);
    new Chart(ctx,{type:"line",data:{labels,datasets:[{label:"Entrate",data:inVals,borderColor:"green"},{label:"Uscite",data:outVals,borderColor:"red"}]}});

    const fc=forecastCashflow();
    if(fc.labels){
      const ctx2=document.getElementById("forecastChart").getContext("2d");
      new Chart(ctx2,{type:"line",data:{labels:[...fc.labels,...fc.forecasts.map(f=>f.label)],datasets:[{label:"Saldo mensile",data:[...fc.values,...fc.forecasts.map(f=>f.value)],borderColor:"blue"}]}});
    }
  }
  if(id==="settings"){
    document.getElementById("import-file").onchange=e=>{
      const f=e.target.files[0]; if(!f)return;
      const r=new FileReader(); r.onload=ev=>{const d=JSON.parse(ev.target.result); appData=d; saveData(); showToast("Import JSON fatto!"); renderPage("report");}; r.readAsText(f);
    };
    document.getElementById("import-csv").onchange=e=>{
      const f=e.target.files[0]; if(f) importCSV(f);
    };
  }
}

/* === DUMMY per reminder === */
function addDummyReminder(){
  appData.reminders.push({id:getNextId(),description:"Pagamento IVA",date:new Date().toISOString().slice(0,10)});
  saveData(); renderPage("reminders");
}

/* === INIT === */
window.onload=()=>{
  if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
  document.getElementById("theme-toggle").onclick=toggleTheme;
};
</script>
</body>
</html>
