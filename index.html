<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* ------------------------------------------------------------------- */
        /* STILI GLOBALI E VARIABILI */
        /* ------------------------------------------------------------------- */
        :root {
            --primary-color: #3b82f6; /* Blu */
            --secondary-color: #f59e0b; /* Giallo (per avvisi/ready) */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --danger-color: #ef4444;
        }

        /* Resetta e Applica Font Base */
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Nasconde lo scroll del body principale */
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Utility */
        .flex-grow { flex-grow: 1; }
        .p-2 { padding: 0.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .border { border: 1px solid var(--border-color); }
        .rounded-md { border-radius: 0.375rem; }
        .w-full { width: 100%; }

        /* ------------------------------------------------------------------- */
        /* HEADER E NAVIGAZIONE PRINCIPALE */
        /* ------------------------------------------------------------------- */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            flex-shrink: 0;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tabs button {
            background: none;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .nav-tabs button.active {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .logout-button {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: bold;
        }

        /* ------------------------------------------------------------------- */
        /* MAIN POS LAYOUT (3 COLONNE) */
        /* ------------------------------------------------------------------- */
        .pos-main-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Colonna Menu (Sinistra) */
        .menu-column {
            flex: 2; /* Pi√π spazio per il menu */
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            overflow: hidden;
        }

        .menu-tabs {
            display: flex;
            overflow-x: auto; /* Scroll orizzontale per le categorie */
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 0;
            flex-shrink: 0;
        }

        .menu-tabs button {
            white-space: nowrap;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            transition: background-color 0.2s, border-bottom 0.2s;
        }

        .menu-tabs button.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .menu-search-bar {
            padding: 0.5rem;
            flex-shrink: 0;
            display: flex;
            gap: 0.5rem;
        }

        .menu-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Adattivo */
            gap: 0.75rem;
            padding: 0.75rem;
            overflow-y: auto; /* Scroll verticale per gli articoli */
            flex-grow: 1;
        }

        .menu-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .menu-item.finished {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e0e0e0;
        }
        
        .menu-item .price {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 0.25rem;
        }

        /* Colonna Carrello (Centro) */
        .cart-column {
            flex: 1; 
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            background-color: var(--card-bg);
            overflow: hidden;
        }
        
        .cart-header {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .cart-items {
            overflow-y: auto;
            flex-grow: 1;
            padding: 0 0.75rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item:hover, .cart-item.selected {
            background-color: #eff6ff; /* Sfondo chiaro per selezione */
        }

        .cart-item-name {
            flex-grow: 1;
        }

        .cart-item-name small {
            display: block;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .cart-item-price {
            font-weight: bold;
            white-space: nowrap;
        }
        
        .cart-footer {
            flex-shrink: 0;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
        }

        .cart-footer .total {
            display: flex;
            justify-content: space-between;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
        }

        .finalize-button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* Colonna Modificatori (Destra) */
        .modifiers-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f9fafb; /* Sfondo leggermente diverso */
            overflow: hidden;
        }

        .modifiers-column h3 {
            padding: 0.75rem;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 1rem;
            flex-shrink: 0;
        }

        .modifier-tabs {
            display: flex;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .modifier-tabs button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 0;
        }

        .modifier-tabs button.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
            background-color: #f0f4ff;
        }

        .modifier-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 0.75rem;
        }

        .modifier-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: var(--card-bg);
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.1s;
        }

        .modifier-item:hover, .modifier-item.selected {
            background-color: #dbeafe; /* Sfondo blu chiaro per selezione */
            border-color: var(--primary-color);
        }

        /* ------------------------------------------------------------------- */
        /* VISTE SECONDARIE (Ordini, Storico, Impostazioni) */
        /* ------------------------------------------------------------------- */
        .secondary-view {
            padding: 1rem;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .order-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .order-status {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .status-Pending {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-Ready {
            background-color: #10b981; /* Verde */
            color: white;
        }

        /* ------------------------------------------------------------------- */
        /* MEDIA QUERIES (RENDE RESPONSIVO) */
        /* ------------------------------------------------------------------- */
        
        /* Per schermi con larghezza massima di 1024px (Tablet e Smartphone) */
        @media (max-width: 1024px) {
            
            .pos-main-container {
                /* Passa a layout a colonna per dispositivi mobili */
                flex-direction: column;
                overflow-y: auto; /* Permette lo scroll generale del contenuto */
            }
            
            /* Nasconde le colonne Menu e Modificatori per default */
            .menu-column,
            .modifiers-column {
                display: none;
                flex: none;
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                height: 100vh; /* Riempi l'altezza quando attiva */
                position: fixed; /* Si sovrappone */
                top: 0;
                left: 0;
                z-index: 900;
                background-color: var(--bg-color);
                padding-top: 5rem; /* Spazio per l'header */
            }
            
            /* Il carrello diventa la vista primaria su mobile */
            .cart-column {
                flex: none;
                width: 100%;
                border-right: none;
                min-height: calc(100vh - 5rem - 4rem); /* Header - Nav Mobile */
                background-color: var(--bg-color);
                padding-bottom: 4rem; /* Spazio per la nav mobile */
            }
            
            /* Aggiungiamo un menu a schede fisso per le colonne su mobile */
            .mobile-tab-nav {
                display: flex;
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                z-index: 1000;
                background-color: var(--card-bg);
                border-top: 1px solid var(--border-color);
            }
            
            .mobile-tab-nav button {
                flex: 1;
                padding: 1rem 0.5rem;
                border: none;
                background: none;
                font-size: 0.9rem;
                cursor: pointer;
                color: #6b7280;
                transition: color 0.2s;
            }

            .mobile-tab-nav button.active {
                color: var(--primary-color);
                font-weight: bold;
            }

            /* Mostra le colonne quando attivate dal toggle mobile */
            .menu-column.active-mobile-tab,
            .modifiers-column.active-mobile-tab {
                display: flex;
            }

            .menu-items-grid {
                 grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .secondary-view {
                padding-bottom: 4rem; /* Spazio per la nav mobile */
            }
        }
    </style>
</head>
<body>

<div id="app">

    <header>
        <div class="logo">
            <i class="fa-solid fa-pizza-slice"></i> Pizzeria Smart POS
        </div>
        
        <div class="nav-tabs" v-if="isAccessGranted">
            <button @click="view = 'inserimento'" :class="{ 'active': view === 'inserimento' }">
                <i class="fa-solid fa-cash-register"></i> Inserimento
            </button>
            <button @click="view = 'ordini'" :class="{ 'active': view === 'ordini' }">
                <i class="fa-solid fa-list-check"></i> Ordini Attivi ({{ activeOrders.length }})
            </button>
            <button @click="view = 'storico'" :class="{ 'active': view === 'storico' }">
                <i class="fa-solid fa-box-archive"></i> Storico
            </button>
            <button v-if="isOwner" @click="view = 'impostazioni'" :class="{ 'active': view === 'impostazioni' }">
                <i class="fa-solid fa-gear"></i> Impostazioni
            </button>
        </div>
        
        <button v-if="isAccessGranted" @click="logout" class="logout-button">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
    </header>

    <div v-if="view === 'login'" class="secondary-view flex items-center justify-center h-full">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold mb-4">Accesso POS</h2>
            <p class="mb-4">Inserisci il PIN di accesso (Admin: 1234 / Owner: 0000)</p>
            <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN" class="w-full p-3 border border-gray-300 rounded-md text-xl text-center mb-4">
            <button @click="grantAccess" class="w-full p-3 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700">Accedi</button>
        </div>
    </div>
    
    <main class="pos-main-container" v-if="view === 'inserimento' && isAccessGranted">

        <div :class="['menu-column', {'active-mobile-tab': $isMobile() && mobileTab === 'menu'}]">
            <div class="menu-tabs">
                <button v-for="(items, category) in menu" :key="category" @click="activeCat = category" :class="{ 'active': activeCat === category }">
                    {{ category }}
                </button>
            </div>
            
            <div class="menu-search-bar">
                <input type="text" v-model="searchTerm" placeholder="Cerca nel menu..." class="flex-grow p-2 border rounded-md">
            </div>
            
            <div class="menu-items-grid">
                <div v-for="item in filteredAvailableItems" :key="item.nome" @click="handleItemClick(item)" :class="['menu-item', { 'finished': item.isFinished }]">
                    <span class="font-semibold">{{ item.nome }}</span>
                    <span class="price">‚Ç¨{{ item.prezzo.toFixed(2) }}</span>
                </div>
            </div>
        </div>

        <div class="cart-column">
            <div class="cart-header">
                Carrello Ordine #<span v-if="editingOrderId">MODIFICA {{ editingOrderId }}</span>
                <span v-else>{{ lastOrderId + 1 }}</span>
            </div>
            
            <div class="cart-items">
                <div v-if="order.length === 0" class="text-center text-gray-500 p-4">Carrello vuoto. Aggiungi un articolo.</div>
                
                <div v-for="(item, index) in order" :key="index" @click="selectItem(index)" 
                     :class="['cart-item', { 'selected': selectedItemIndex === index }]">
                    <div class="cart-item-name">
                        <span class="font-semibold">{{ item.nome }}</span>
                        <small v-if="item.isHalfPizza">{{ item.gusto1 }} / {{ item.gusto2 }}</small>
                        <small v-if="item.isMeter">({{ item.gustoCount }} Gusti - {{ item.sections.length }} Sezioni)</small>
                        
                        <small v-if="item.modifiers && item.modifiers.length > 0">+ {{ item.modifiers.map(m => m.nome).join(', ') }}</small>
                        <small v-if="item.isHalfPizza && (item.modifiers1.length > 0 || item.modifiers2.length > 0)">
                             + Modifiche su Met√†
                        </small>
                        <small v-if="item.manualPrice !== undefined" class="text-red-600">Prezzo manuale</small>
                    </div>
                    
                    <div class="cart-item-price">
                        ‚Ç¨{{ calculateItemTotal(item).toFixed(2) }}
                    </div>
                    
                    <button @click.stop="openPriceEditModal(index)" class="ml-2 text-gray-400 hover:text-blue-500" title="Modifica Prezzo">
                        <i class="fa-solid fa-tags"></i>
                    </button>
                    <button @click.stop="removeItem(index)" class="ml-2 text-red-500 hover:text-red-700">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            </div>

            <div class="cart-footer">
                <div class="total">
                    <span>Totale:</span>
                    <span>‚Ç¨{{ total.toFixed(2) }}</span>
                </div>
                <button @click="openFinalizeModal()" class="finalize-button">
                    <i class="fa-solid fa-check"></i> Finalizza Ordine
                </button>
                <button @click="resetOrder" class="w-full mt-2 p-2 bg-gray-200 text-sm text-red-600 rounded-md">
                    <i class="fa-solid fa-trash"></i> Svuota Carrello
                </button>
            </div>
        </div>

        <div :class="['modifiers-column', {'active-mobile-tab': $isMobile() && mobileTab === 'modifiers'}]">
            <h3>Modifiche per: {{ selectedItemIndex !== null ? order[selectedItemIndex].nome : 'Nessun Articolo Selezionato' }}</h3>

            <div v-if="selectedItemIndex === null" class="text-center text-gray-500 p-4">
                Seleziona un articolo nel carrello per aggiungere modificatori.
            </div>
            <div v-else-if="order[selectedItemIndex].isHalfPizza || order[selectedItemIndex].isMeter" class="text-center text-gray-500 p-4">
                Le modifiche per le composizioni (a Met√†, a Metro) vanno gestite tramite la <button @click="openFinalizeModal(order[selectedItemIndex])" class="text-blue-600 underline">Modifica Articolo</button>.
            </div>
            <div v-else>
                <div class="modifier-tabs">
                    <button v-for="(mods, category) in modifiers" :key="category" @click="activeModCat = category" :class="{ 'active': activeModCat === category }">
                        {{ category }}
                    </button>
                </div>
                
                <div class="modifier-list">
                    <div v-for="modifier in filteredModifiersForActiveCat" :key="modifier.nome" @click="addExtra(modifier)" 
                         :class="['modifier-item', { 
                            'selected': order[selectedItemIndex]?.modifiers?.some(m => m.nome === modifier.nome),
                            'finished': modifier.isFinished
                         }]">
                        <span class="font-semibold">
                            <i :class="['fa-solid', getModifierIcon(activeModCat)]"></i> {{ modifier.nome }}
                        </span>
                        <span v-if="modifier.prezzo > 0">
                            + ‚Ç¨{{ modifier.prezzo.toFixed(2) }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <div v-if="view === 'ordini' && isAccessGranted" class="secondary-view">
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex gap-4">
            <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per cliente/tavolo/telefono..." class="p-2 border rounded-md flex-grow">
            <select v-model="activeDateFilter" class="p-2 border rounded-md">
                <option value="today">Oggi</option>
                <option value="tomorrow">Domani</option>
                <option value="future">Futuri</option>
            </select>
        </div>
        
        <div v-if="filteredActiveOrders.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="order in filteredActiveOrders" :key="order.id" class="order-card">
                <div class="flex-grow">
                    <h4 class="font-bold text-lg mb-1">Ordine #{{ order.id }} - {{ getModeName(order.mode) }}</h4>
                    <p v-if="order.mode !== 'banco'" class="text-sm">Cliente: {{ order.customer || 'N/A' }} ({{ order.phone }})</p>
                    <p v-else class="text-sm">Tavolo/Banco: {{ order.tableNumber || 'N/A' }}</p>
                    <p class="text-sm font-semibold mt-1">
                        <i class="fa-solid fa-clock"></i> {{ formatDate(order.date) }} alle {{ order.hour }}
                    </p>
                    <p class="text-xl font-bold mt-2 text-blue-600">Totale: ‚Ç¨{{ order.total.toFixed(2) }}</p>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <span :class="['order-status', `status-${order.status}`]">{{ order.status }}</span>
                    <button @click="toggleOrderStatus(order.id)" class="p-2 text-sm rounded-md" :class="order.status === 'Pending' ? 'bg-yellow-500 text-white' : 'bg-green-500 text-white'">
                        <i class="fa-solid fa-toggle-{{ order.status === 'Pending' ? 'off' : 'on' }}"></i> 
                        <span v-if="order.status === 'Pending'">Marca Pronto</span>
                        <span v-else>Marca In Lavorazione</span>
                    </button>
                    <button @click="openShareModal(order)" class="p-2 bg-green-500 text-white text-sm rounded-md"><i class="fa-brands fa-whatsapp"></i> Condividi</button>
                    <button @click="openEditOrderModal(order.id)" class="p-2 bg-gray-200 text-gray-700 text-sm rounded-md"><i class="fa-solid fa-pen"></i> Modifica</button>
                    <button @click="archiveOrder(order.id)" class="p-2 bg-red-500 text-white text-sm rounded-md"><i class="fa-solid fa-box-archive"></i> Archivia</button>
                </div>
            </div>
        </div>
        <div v-else class="text-center text-gray-500 p-8 bg-white rounded-lg mt-4">Nessun ordine attivo trovato per i filtri selezionati.</div>
    </div>
    
    <div v-if="view === 'storico' && isAccessGranted" class="secondary-view">
        <h2 class="text-2xl font-bold mb-4">Storico Cassa e Statistiche</h2>
        
        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex gap-4 items-center">
            <label for="archiveDate" class="font-semibold">Seleziona Data:</label>
            <input type="date" id="archiveDate" v-model="archiveDateFilter" class="p-2 border rounded-md">
            
            <label for="driverFilter" class="font-semibold">Fattorino (Consegne):</label>
            <select id="driverFilter" v-model="selectedDriver" class="p-2 border rounded-md">
                <option value="">Tutti</option>
                <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
            </select>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <p class="text-sm text-gray-500">Ordini Giornalieri ({{ archiveDateFilterDisplay }})</p>
                <p class="text-3xl font-bold text-blue-600">{{ filteredArchive.length }}</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md text-center">
                <p class="text-sm text-gray-500">Incasso Totale Giornaliero</p>
                <p class="text-3xl font-bold text-green-600">‚Ç¨{{ dailyTotal.toFixed(2) }}</p>
            </div>
            <div v-if="selectedDriver" class="bg-white p-4 rounded-lg shadow-md text-center">
                <p class="text-sm text-gray-500">Statistiche Fattorino: {{ selectedDriver }}</p>
                <p class="text-xl font-bold text-orange-500">{{ driverStats.totalOrders }} consegne (Totale: ‚Ç¨{{ driverStats.totalRevenue.toFixed(2) }})</p>
            </div>
        </div>

        <div v-if="filteredArchive.length > 0" class="bg-white rounded-lg shadow-md overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ora</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente/Tavolo</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modalit√†</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Azioni</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="order in filteredArchive" :key="order.id">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ order.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.hour }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ order.customer || order.tableNumber || 'Banco' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ getModeName(order.mode) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-700">‚Ç¨{{ order.total.toFixed(2) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button @click="showArchiveDetails(order)" class="text-indigo-600 hover:text-indigo-900"><i class="fa-solid fa-eye"></i> Dettagli</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-else class="text-center text-gray-500 p-8 bg-white rounded-lg mt-4">Nessun ordine archiviato per questa data/fattorino.</div>
    </div>
    
    <div v-if="view === 'impostazioni' && isOwner" class="secondary-view">
        <h2 class="text-2xl font-bold mb-4">Impostazioni Sistema POS</h2>
        
        <div class="flex gap-4 border-b pb-2 mb-4">
            <button @click="activeSettingsView = 'menu'" :class="['p-2 rounded-md', {'bg-blue-600 text-white': activeSettingsView === 'menu', 'bg-gray-200': activeSettingsView !== 'menu'}]">Menu / Modificatori</button>
            <button @click="activeSettingsView = 'capacity'" :class="['p-2 rounded-md', {'bg-blue-600 text-white': activeSettingsView === 'capacity', 'bg-gray-200': activeSettingsView !== 'capacity'}]">Capacit√† Oraria</button>
            <button @click="activeSettingsView = 'delivery'" :class="['p-2 rounded-md', {'bg-blue-600 text-white': activeSettingsView === 'delivery', 'bg-gray-200': activeSettingsView !== 'delivery'}]">Consegna / Fattorini</button>
            <button @click="activeSettingsView = 'security'" :class="['p-2 rounded-md', {'bg-blue-600 text-white': activeSettingsView === 'security', 'bg-gray-200': activeSettingsView !== 'security'}]">Sicurezza / PIN</button>
        </div>
        
        <div v-if="activeSettingsView === 'menu'" class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-3">Gestione Menu e Articoli</h3>
            
            <div class="flex gap-4">
                <div class="w-1/3 border-r pr-4">
                    <h4 class="font-semibold mb-2">Categorie Menu</h4>
                    <button @click="addNewCategory('menu')" class="w-full p-2 bg-green-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Nuova Categoria</button>
                    <div v-for="(items, category) in menu" :key="category" @click="activeSettingsCat = category" 
                         :class="['p-2 mb-1 rounded-md cursor-pointer flex justify-between items-center', {'bg-blue-100 font-bold': activeSettingsCat === category}]">
                        {{ category }}
                        <button v-if="Object.keys(menu).length > 1" @click.stop="removeItemFromMenu(category, -1)" class="text-red-500 text-sm hover:text-red-700 ml-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
                
                <div class="w-2/3">
                    <h4 class="font-semibold mb-2">Articoli: {{ activeSettingsCat }}</h4>
                    <button @click="addNewItemToMenu(activeSettingsCat)" class="p-2 bg-blue-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Nuovo Articolo</button>
                    
                    <div v-for="(item, index) in menu[activeSettingsCat]" :key="index" class="flex gap-2 mb-2 p-2 border rounded-md items-center bg-gray-50">
                        <input type="text" v-model="item.nome" placeholder="Nome Articolo" class="p-1 border rounded flex-grow">
                        <input type="number" step="0.01" v-model.number="item.prezzo" class="p-1 border rounded w-20 text-right">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" v-model="item.isFinished"> Esaurito
                        </label>
                        <button @click="removeItemFromMenu(activeSettingsCat, index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <h3 class="text-xl font-semibold mb-3">Gestione Modificatori</h3>
             <div class="flex gap-4">
                <div class="w-1/3 border-r pr-4">
                    <h4 class="font-semibold mb-2">Tipi Modificatori</h4>
                    <button @click="addNewCategory('modifiers')" class="w-full p-2 bg-green-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Nuovo Tipo</button>
                    <div v-for="(mods, category) in modifiers" :key="category" @click="activeSettingsModCat = category" 
                         :class="['p-2 mb-1 rounded-md cursor-pointer', {'bg-blue-100 font-bold': activeSettingsModCat === category}]">
                        {{ category }}
                    </div>
                </div>
                
                <div class="w-2/3">
                    <h4 class="font-semibold mb-2">Modificatori: {{ activeSettingsModCat }}</h4>
                    <button @click="addNewItemToModifiers(activeSettingsModCat)" class="p-2 bg-blue-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Nuovo Modificatore</button>
                    
                    <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" class="flex gap-2 mb-2 p-2 border rounded-md items-center bg-gray-50">
                        <input type="text" v-model="mod.nome" placeholder="Nome Modificatore" class="p-1 border rounded flex-grow">
                        <input type="number" step="0.01" v-model.number="mod.prezzo" class="p-1 border rounded w-20 text-right">
                        <label class="flex items-center gap-1">
                            <input type="checkbox" v-model="mod.isFinished"> Esaurito
                        </label>
                        <button @click="removeItemFromModifiers(activeSettingsModCat, index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-else-if="activeSettingsView === 'capacity'" class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-3">Capacit√† Oraria Massima (Controllo Afflusso)</h3>
            <p class="mb-4 text-sm text-gray-600">Definisci quante "unit√† pizza" accettare per intervallo di tempo. Le composizioni a Metro e a Met√† contano come 2 unit√†.</p>

            <div class="grid grid-cols-2 gap-4 max-w-lg">
                <div>
                    <label class="block font-semibold mb-1">Pizze Massime per Intervallo:</label>
                    <input type="number" v-model.number="capacitySettings.maxPizzas" class="w-full p-2 border rounded-md">
                </div>
                <div>
                    <label class="block font-semibold mb-1">Durata Intervallo (Minuti):</label>
                    <input type="number" v-model.number="capacitySettings.intervalMinutes" class="w-full p-2 border rounded-md">
                </div>
            </div>
            <p class="mt-4 p-3 bg-yellow-100 border border-yellow-300 rounded-md max-w-lg">
                L'attuale intervallo di controllo √® di **{{ capacitySettings.intervalMinutes }} minuti**, con un limite massimo di **{{ capacitySettings.maxPizzas }} pizze**.
            </p>
        </div>
        
        <div v-else-if="activeSettingsView === 'delivery'" class="bg-white p-4 rounded-lg shadow-md">
             <h3 class="text-xl font-semibold mb-3">Zone di Consegna</h3>
             <button @click="addDeliveryZone" class="p-2 bg-blue-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Aggiungi Zona</button>
             
             <div v-for="(zone, index) in deliveryZones" :key="index" class="flex gap-2 mb-2 p-2 border rounded-md items-center bg-gray-50 max-w-xl">
                <input type="text" v-model="zone.name" placeholder="Nome Zona" class="p-1 border rounded flex-grow">
                <label>Costo: ‚Ç¨</label>
                <input type="number" step="0.01" v-model.number="zone.price" class="p-1 border rounded w-20 text-right">
                <button @click="removeDeliveryZone(index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
            </div>
            
             <hr class="my-4">
             
             <h3 class="text-xl font-semibold mb-3">Fattorini</h3>
             <button @click="addDriver" class="p-2 bg-blue-500 text-white rounded-md mb-3"><i class="fa-solid fa-plus"></i> Aggiungi Fattorino</button>
             <div class="flex flex-wrap gap-2 max-w-xl">
                 <div v-for="(driver, index) in drivers" :key="index" class="flex gap-2 mb-2 p-2 border rounded-md items-center bg-gray-50">
                    <input type="text" v-model="drivers[index]" class="p-1 border rounded">
                    <button @click="removeDriver(index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                 </div>
             </div>
        </div>
        
        <div v-else-if="activeSettingsView === 'security'" class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-3">Gestione PIN di Accesso</h3>
            
            <div class="mb-4 p-3 border rounded-md max-w-md">
                <h4 class="font-semibold">PIN Operatore/Admin (Attuale: ****)</h4>
                <input type="password" v-model="newAdminPin" placeholder="Nuovo PIN Admin (min 4 cifre)" class="w-full p-2 border rounded-md mt-2 mb-2">
                <button @click="saveAdminPin" class="p-2 bg-green-500 text-white rounded-md w-full">Salva PIN Admin</button>
            </div>
            
            <div class="p-3 border rounded-md max-w-md">
                <h4 class="font-semibold">PIN Titolare (Attuale: ****)</h4>
                <input type="password" v-model="newOwnerPin" placeholder="Nuovo PIN Titolare (min 4 cifre)" class="w-full p-2 border rounded-md mt-2 mb-2">
                <button @click="saveOwnerPin" class="p-2 bg-green-500 text-white rounded-md w-full">Salva PIN Titolare</button>
            </div>
        </div>
    </div>
    
    <div v-if="showModal" class="modal-overlay">
        <div class="modal-content max-w-3xl w-full">
            <h2 class="text-2xl font-bold mb-4">{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Finalizza Nuovo Ordine' }}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 border rounded-md bg-gray-50">
                    <h3 class="font-semibold mb-3">Dati Ordine</h3>
                    
                    <label class="block font-semibold mb-2">Modalit√†:</label>
                    <div class="flex gap-4 mb-4">
                        <label class="inline-flex items-center"><input type="radio" v-model="mode" value="banco" class="mr-2"> Banco / Tavolo</label>
                        <label class="inline-flex items-center"><input type="radio" v-model="mode" value="asporto" class="mr-2"> Asporto</label>
                        <label class="inline-flex items-center"><input type="radio" v-model="mode" value="consegna" class="mr-2"> Consegna</label>
                    </div>
                    
                    <div v-if="mode === 'banco'" class="mb-4">
                        <label for="table" class="block text-sm font-medium mb-1">Numero Tavolo / Riferimento:</label>
                        <input type="text" id="table" v-model="tableNumber" class="w-full p-2 border rounded-md">
                    </div>
                    
                    <div v-if="mode !== 'banco'">
                        <label for="customer" class="block text-sm font-medium mb-1">Nome Cliente:</label>
                        <input type="text" id="customer" v-model="customer" @input="suggestCustomers" class="w-full p-2 border rounded-md mb-2">
                         <div v-if="filteredCustomerSuggestions.length" class="bg-white border rounded-md shadow-lg absolute z-10 w-45%">
                            <div v-for="cust in filteredCustomerSuggestions" :key="cust.phone" @click="selectCustomerSuggestion(cust)" class="p-2 hover:bg-gray-100 cursor-pointer text-sm">
                                {{ cust.name }} ({{ cust.phone }})
                            </div>
                        </div>
                        
                        <label for="phone" class="block text-sm font-medium mb-1">Telefono:</label>
                        <input type="tel" id="phone" v-model="phone" class="w-full p-2 border rounded-md mb-4">
                    </div>
                    
                    <div v-if="mode === 'consegna'" class="mb-4">
                        <label for="address" class="block text-sm font-medium mb-1">Indirizzo / Civico:</label>
                        <div class="flex gap-2 mb-2">
                             <input type="text" id="address" v-model="address" placeholder="Via/Piazza" class="w-3/4 p-2 border rounded-md">
                             <input type="text" v-model="streetNumber" placeholder="Civico" class="w-1/4 p-2 border rounded-md">
                        </div>
                        
                        <label for="zone" class="block text-sm font-medium mb-1">Zona Consegna:</label>
                        <select id="zone" v-model="zoneName" @change="updateDeliveryCost" class="w-full p-2 border rounded-md mb-2">
                            <option value="">Seleziona Zona</option>
                            <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">{{ zone.name }} (‚Ç¨{{ zone.price.toFixed(2) }})</option>
                        </select>
                        <label for="town" class="block text-sm font-medium mb-1">Citt√†:</label>
                        <input type="text" id="town" v-model="town" class="w-full p-2 border rounded-md">
                    </div>
                    
                    <div class="flex gap-4 mb-4">
                        <div class="w-1/2">
                            <label for="date" class="block text-sm font-medium mb-1">Data Ritiro/Consegna:</label>
                            <input type="date" id="date" v-model="date" :min="minDate" class="w-full p-2 border rounded-md">
                        </div>
                        <div class="w-1/2">
                            <label for="hour" class="block text-sm font-medium mb-1">Ora Ritiro/Consegna:</label>
                            <input type="time" id="hour" v-model="hour" class="w-full p-2 border rounded-md">
                        </div>
                    </div>

                    <div v-if="orderCapacity.interval !== 'N/A'" 
                         :class="['p-2 rounded-md text-sm', orderCapacity.remaining <= 0 ? 'bg-red-200 text-red-800 font-bold' : orderCapacity.warning ? 'bg-yellow-200 text-yellow-800' : 'bg-green-100 text-green-700']">
                        <i class="fa-solid fa-circle-exclamation"></i> 
                        Slot {{ orderCapacity.interval }}: {{ orderCapacity.remaining <= 0 ? 'COMPLETO!' : `${orderCapacity.remaining} pizze rimanenti` }} (su {{ orderCapacity.total }})
                    </div>
                    
                    <label for="notes" class="block text-sm font-medium mt-4 mb-1">Note:</label>
                    <textarea id="notes" v-model="notes" rows="3" class="w-full p-2 border rounded-md"></textarea>
                </div>
                
                <div class="p-4 border rounded-md bg-gray-50">
                    <h3 class="font-semibold mb-3">Riepilogo e Pagamento</h3>
                    
                    <div class="mb-4">
                        <label for="payment" class="block text-sm font-medium mb-1">Stato Pagamento:</label>
                        <select id="payment" v-model="paymentStatus" class="w-full p-2 border rounded-md">
                            <option>Da Pagare</option>
                            <option>Pagato in Cassa</option>
                            <option>Pagato Online</option>
                            <option>Acconto Versato</option>
                        </select>
                    </div>
                    
                    <div v-if="paymentStatus.includes('Acconto')">
                        <label for="acconto" class="block text-sm font-medium mb-1">Acconto Ricevuto (‚Ç¨):</label>
                        <input type="number" step="0.01" v-model.number="accontoRicevuto" class="w-full p-2 border rounded-md mb-2">
                        <p v-if="restoDaDare > 0" class="text-sm text-red-600 font-bold">Resto da dare: ‚Ç¨{{ restoDaDare.toFixed(2) }}</p>
                    </div>

                    <div class="mb-4">
                        <label for="discount" class="block text-sm font-medium mb-1">Sconto (‚Ç¨):</label>
                        <input type="number" step="0.01" v-model.number="discount" class="w-full p-2 border rounded-md mb-2">
                        
                        <label for="discountPerc" class="block text-sm font-medium mb-1">Sconto (%):</label>
                        <input type="number" step="1" v-model.number="discountPercentage" placeholder="Es. 10" class="w-full p-2 border rounded-md">
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-300">
                        <div class="flex justify-between font-semibold"><span>Subtotale Articoli:</span><span>‚Ç¨{{ calculatedOrderTotal.toFixed(2) }}</span></div>
                        <div class="flex justify-between text-blue-600"><span>Consegna ({{ zoneName || 'N/A' }}):</span><span>+ ‚Ç¨{{ deliveryCost.toFixed(2) }}</span></div>
                        <div class="flex justify-between text-red-600 font-semibold"><span>Sconto Applicato:</span><span>- ‚Ç¨{{ discount.toFixed(2) }}</span></div>
                        <div class="flex justify-between text-2xl font-bold mt-2 border-t border-gray-400 pt-2">
                            <span>TOTALE FINALE:</span>
                            <span>‚Ç¨{{ total.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button @click="closeFinalizeModal" class="p-3 bg-gray-300 rounded-md">Annulla</button>
                <button @click="saveOrder" class="p-3 bg-green-600 text-white rounded-md font-bold">
                    <i class="fa-solid fa-save"></i> {{ editingOrderId ? 'Salva Modifiche' : 'Salva Ordine' }}
                </button>
            </div>
        </div>
    </div>
    
    <div v-if="showPriceEditModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-bold mb-4">Modifica Prezzo Manuale</h3>
            <p class="mb-2">Articolo: {{ order[tempPriceEditIndex]?.nome }}</p>
            <label class="block text-sm font-medium mb-1">Nuovo Prezzo (‚Ç¨):</label>
            <input type="number" step="0.01" v-model.number="newPriceValue" class="w-full p-2 border rounded-md mb-4 text-xl text-right">
            
            <div class="flex justify-end gap-2">
                <button @click="showPriceEditModal = false" class="p-2 bg-gray-300 rounded-md">Annulla</button>
                <button @click="resetManualPrice" class="p-2 bg-red-500 text-white rounded-md">Reset Prezzo</button>
                <button @click="saveNewPrice" class="p-2 bg-green-500 text-white rounded-md">Salva</button>
            </div>
        </div>
    </div>
    
    <div v-if="showShareModal" class="modal-overlay">
        <div class="modal-content max-w-xl">
            <h3 class="text-xl font-bold mb-4">Condividi Ordine #{{ selectedOrderForShare?.id }}</h3>
            <p class="mb-4">Puoi inviare il riepilogo dell'ordine tramite WhatsApp o copiare il testo:</p>
            
            <textarea readonly rows="10" class="w-full p-3 border rounded-md bg-gray-100 text-sm mb-4">{{ generateShareText(selectedOrderForShare) }}</textarea>
            
            <div class="flex justify-end gap-3">
                <button @click="showShareModal = false" class="p-2 bg-gray-300 rounded-md">Chiudi</button>
                <button @click="copyShareText" class="p-2 bg-blue-500 text-white rounded-md"><i class="fa-solid fa-copy"></i> Copia Testo</button>
                <a :href="'https://wa.me/' + selectedOrderForShare?.phone + '?text=' + encodeURIComponent(generateShareText(selectedOrderForShare))" 
                   target="_blank" class="p-2 bg-green-600 text-white rounded-md flex items-center gap-2">
                    <i class="fa-brands fa-whatsapp"></i> Invia su WhatsApp
                </a>
            </div>
        </div>
    </div>
    
    <div class="mobile-tab-nav" v-if="isAccessGranted && view === 'inserimento' && $isMobile()">
        <button :class="{'active': mobileTab === 'menu'}" @click="mobileTab = 'menu'">
            <i class="fa-solid fa-pizza-slice"></i> Menu
        </button>
        <button :class="{'active': mobileTab === 'cart'}" @click="mobileTab = 'cart'">
            <i class="fa-solid fa-basket-shopping"></i> Carrello ({{ order.length }})
        </button>
        <button :class="{'active': mobileTab === 'modifiers'}" @click="mobileTab = 'modifiers'">
            <i class="fa-solid fa-wrench"></i> Modifiche
        </button>
    </div>

</div>

<script type="module">
    import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

    const app = createApp({
        data() {
            return {
                // --- Stato UI e Accesso ---
                view: 'login', // login, inserimento, ordini, storico, impostazioni
                isAccessGranted: false,
                isAdmin: false, 
                isOwner: false, 
                accessPin: '',
                mobileTab: 'cart', // 'menu', 'cart', 'modifiers' <-- NUOVO: Per la navigazione su mobile
                
                // --- Dati Persistenti (Verranno caricati da localStorage) ---
                menu: {
                    'Pizza Classica': [
                        { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                        { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                        { nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                    ],
                    'Pizze Speciali': [
                        { nome: 'Gourmet', prezzo: 12.00, isFinished: false },
                        { nome: 'Pistacchio & Mortadella', prezzo: 10.50, isFinished: false },
                    ],
                    'Al Forno': [
                        { nome: 'Suppl√¨', prezzo: 2.00, isFinished: false },
                        { nome: 'Crocchetta', prezzo: 1.50, isFinished: false },
                    ],
                    'Bevande': [
                         { nome: 'Acqua Naturale 0.5L', prezzo: 1.50, isFinished: false },
                         { nome: 'Coca Cola Lattina', prezzo: 2.50, isFinished: false },
                    ],
                    'Composizioni': [
                        { nome: 'Pizza a Met√†', prezzo: 0.00, isFinished: false, isHalfPizza: true },
                        { nome: 'Pizza a Metro', prezzo: 0.00, isFinished: false, isMeter: true },
                    ]
                },
                modifiers: {
                    'Aggiunte': [
                        { nome: 'Bufala', prezzo: 2.50, isFinished: false },
                        { nome: 'Funghi Extra', prezzo: 1.00, isFinished: false },
                    ],
                    'Senza': [
                        { nome: 'Senza Mozzarella', prezzo: 0.00, isFinished: false },
                        { nome: 'Senza Pomodoro', prezzo: 0.00, isFinished: false },
                    ],
                },
                compositionPrices: {
                    'Pizza a Metro': {
                        'baseSections': 4,
                        2: 15.00, // Prezzo per 2 gusti
                        3: 18.00, // Prezzo per 3 gusti
                        4: 20.00, // Prezzo per 4 gusti
                    },
                },
                deliveryZones: [
                    { name: 'Centro Storico', price: 3.00 },
                    { name: 'Periferia Nord', price: 5.00 },
                ],
                drivers: ['Marco', 'Luca', 'Elena'],
                
                pins: {
                    admin: '1234', 
                    owner: '0000' 
                },

                // --- Stato Carrello e Ordine Corrente ---
                activeCat: 'Pizza Classica', 
                searchTerm: '',
                
                order: [], 
                selectedItemIndex: null, 
                
                activeModCat: 'Aggiunte',
                modifierSearchTerm: '',
                
                // --- Dati Finalizzazione Ordine (Modal) ---
                showModal: false,
                editingOrderId: null, 
                lastOrderId: 0,
                
                mode: 'banco', 
                customer: '',
                phone: '',
                address: '',
                streetNumber: '',
                town: 'Roma',
                tableNumber: '',
                date: '',
                hour: '',
                notes: '',
                zoneName: '',
                deliveryCost: 0.00,
                discount: 0.00,
                discountPercentage: 0,
                paymentStatus: 'Da Pagare',
                accontoRicevuto: 0.00,
                
                customerHistory: [],
                filteredCustomerSuggestions: [],
                
                // --- Logica Composizioni Complesse (Modali - semplificate) ---
                // Nota: I dati 'temp' per le composizioni (Metro, Mezza) non sono collegati all'HTML per mantenere la sintesi del codice, 
                // ma le loro funzioni di calcolo e validazione sono presenti.
                showMeterModal: false, 
                tempMeterItem: null,
                gustoSearchTerm: '',
                tempModCat: 'Aggiunte', 
                
                showHalfPizzaModal: false, 
                tempHalfPizzaItem: null,
                
                showPriceEditModal: false, 
                tempPriceEditIndex: null,
                newPriceValue: 0.00,

                // --- Logica Ordini Attivi e Archivio ---
                activeOrders: [],
                archive: [],
                
                activeOrderSearchTerm: '',
                activeDateFilter: 'today', 
                selectedDriver: '', 
                
                archiveDateFilter: new Date().toISOString().slice(0, 10),
                driverStats: { totalOrders: 0, totalRevenue: 0 },
                
                // --- Impostazioni ---
                activeSettingsView: 'menu',
                activeSettingsCat: 'Pizza Classica',
                activeSettingsModCat: 'Aggiunte',
                newAdminPin: '',
                newOwnerPin: '',
                
                capacitySettings: {
                    maxPizzas: 60,
                    intervalMinutes: 30,
                },
                orderCapacity: { 
                    interval: 'N/A',
                    total: 0,
                    remaining: 0,
                    warning: false 
                },
                
                // Condivisione
                showShareModal: false,
                selectedOrderForShare: null,
            };
        },
        
        computed: {
            // --- Accesso e Sicurezza ---
            isOperator() {
                return this.isAccessGranted && this.isAdmin;
            },

            // --- Carrello e Menu ---
            filteredAvailableItems() {
                const categoryItems = this.menu[this.activeCat] || [];
                const term = this.searchTerm.toLowerCase().trim();
                
                return categoryItems.filter(item => 
                    !item.isFinished && item.nome.toLowerCase().includes(term)
                );
            },
            filteredModifiersForActiveCat() {
                const categoryMods = this.modifiers[this.activeModCat] || [];
                const term = this.modifierSearchTerm.toLowerCase().trim();
                
                return categoryMods.filter(mod => 
                    !mod.isFinished && mod.nome.toLowerCase().includes(term)
                );
            },
            
            allPizzaGusti() {
                let gusti = [];
                const pizzaCategories = ['Pizza Classica', 'Pizze Speciali'];
                pizzaCategories.forEach(cat => {
                    (this.menu[cat] || []).forEach(item => {
                        if (!item.isHalfPizza && !item.isMeter) {
                            gusti.push(item);
                        }
                    });
                });
                return gusti.filter((item, index, self) => 
                    index === self.findIndex((t) => (t.nome === item.nome))
                );
            },
            filteredPizzaGusti() {
                const term = this.gustoSearchTerm.toLowerCase().trim();
                return this.allPizzaGusti.filter(gusto => 
                    !gusto.isFinished && gusto.nome.toLowerCase().includes(term)
                );
            },

            // Calcolo Totale Carrello
            calculatedOrderTotal() {
                return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
            },
            total() {
                const subtotal = this.calculatedOrderTotal;
                let total = subtotal + this.deliveryCost;
                
                if (this.discountPercentage > 0) {
                    const discountValue = total * (this.discountPercentage / 100);
                    if (discountValue > this.discount) {
                        total -= discountValue;
                        this.discount = parseFloat(discountValue.toFixed(2)); 
                    } else {
                        total -= this.discount;
                    }
                } else {
                    total -= this.discount;
                }
                
                return parseFloat(Math.max(0, total).toFixed(2));
            },
            restoDaDare() {
                return Math.max(0, this.accontoRicevuto - this.total);
            },
            
            // --- Composizioni Complesse (Validazione e Totali Temporanei) ---
            calculateTempMeterTotal() {
                if (!this.tempMeterItem) return 0;

                let basePrice = this.compositionPrices[this.tempMeterItem.nome][this.tempMeterItem.gustoCount] || 0;
                let modifiersTotal = 0;
                
                this.tempMeterItem.sections.forEach(section => {
                    modifiersTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                });
                
                return parseFloat((basePrice + modifiersTotal).toFixed(2));
            },
            isMeterValid() {
                if (!this.tempMeterItem) return false;
                
                const sectionsWithGusto = this.tempMeterItem.sections.filter(s => s.gusto !== null).length;
                const gustiUniciSelected = this.tempMeterGusti.length;

                return sectionsWithGusto === this.tempMeterItem.sections.length && 
                       gustiUniciSelected <= this.tempMeterItem.gustoCount &&
                       gustiUniciSelected > 0;
            },
            tempMeterGusti() {
                if (!this.tempMeterItem) return [];
                const gusti = this.tempMeterItem.sections.map(s => s.gusto).filter(g => g !== null);
                return [...new Set(gusti)];
            },
            
            calculateTempHalfPizzaTotal() {
                if (!this.tempHalfPizzaItem || !this.tempHalfPizzaItem.gusto1 || !this.tempHalfPizzaItem.gusto2) return 0;
                
                const gusto1Price = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto1)?.prezzo || 0;
                const gusto2Price = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto2)?.prezzo || 0;
                
                let basePrice = Math.ceil((gusto1Price + gusto2Price) / 2);
                
                let modifiersTotal = 0;
                modifiersTotal += this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                modifiersTotal += this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                
                return parseFloat((basePrice + modifiersTotal).toFixed(2));
            },
            isHalfPizzaValid() {
                return this.tempHalfPizzaItem?.gusto1 && this.tempHalfPizzaItem?.gusto2;
            },
            
            // --- Capacit√† Oraria ---
            orderPizzaCount() {
                return this.order.reduce((count, item) => {
                    if (item.isHalfPizza) return count + 1; 
                    if (item.isMeter) return count + 2; 
                    
                    const category = Object.keys(this.menu).find(cat => 
                        (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                    );
                    
                    if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                        return count + 1;
                    }
                    return count;
                }, 0);
            },
            isCapacityWarning() {
                return this.orderCapacity.warning;
            },
            isCapacityFull() {
                return this.orderCapacity.remaining <= 0;
            },

            // --- Ordini Attivi/Storico ---
            filteredActiveOrders() {
                const today = new Date().toISOString().slice(0, 10);
                const tomorrow = new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().slice(0, 10);
                
                return this.activeOrders.filter(order => {
                    if (this.activeDateFilter === 'today' && order.date !== today) return false;
                    if (this.activeDateFilter === 'tomorrow' && order.date !== tomorrow) return false;
                    if (this.activeDateFilter === 'future' && order.date !== tomorrow && order.date <= today) return false;
                    
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term && !(order.customer?.toLowerCase().includes(term) || order.tableNumber?.includes(term) || order.phone?.includes(term))) {
                        return false;
                    }
                    return true;
                }).sort((a, b) => {
                    const timeA = new Date(a.date + 'T' + a.hour).getTime();
                    const timeB = new Date(b.date + 'T' + b.hour).getTime();
                    return timeA - timeB;
                });
            },
            filteredArchive() {
                const filtered = this.archive.filter(order => {
                    const isDateMatch = order.date === this.archiveDateFilter;
                    const isDriverMatch = !this.selectedDriver || order.driver === this.selectedDriver;
                    return isDateMatch && isDriverMatch;
                }).sort((a, b) => b.archivedTimestamp - a.archivedTimestamp); 
                
                this.calculateDriverStats();
                
                return filtered;
            },
            dailyTotal() {
                return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
            },
            archiveDateFilterDisplay() {
                return this.formatDate(this.archiveDateFilter);
            },
            minDate() {
                return new Date().toISOString().slice(0, 10);
            }
        },

        methods: {
            // --- Funzioni di Accesso e Persistenza ---
            grantAccess() {
                if (this.accessPin === this.pins.admin) {
                    this.isAccessGranted = true;
                    this.isAdmin = true;
                    this.isOwner = false;
                    this.view = 'inserimento';
                    this.accessPin = '';
                    alert("Accesso come Operatore/Admin effettuato. (PIN: ****)");
                } else if (this.accessPin === this.pins.owner) {
                    this.isAccessGranted = true;
                    this.isAdmin = true;
                    this.isOwner = true;
                    this.view = 'inserimento';
                    this.accessPin = '';
                    alert("Accesso come Titolare effettuato. (PIN: ****)");
                } else {
                    alert("PIN errato. Riprova.");
                    this.accessPin = '';
                }
            },
            logout() {
                this.isAccessGranted = false;
                this.isAdmin = false;
                this.isOwner = false;
                this.view = 'login';
                alert("Logout effettuato.");
            },
            saveAdminPin() {
                if (this.newAdminPin.length >= 4) {
                    this.pins.admin = this.newAdminPin;
                    this.saveData();
                    this.newAdminPin = '';
                    alert("PIN Admin aggiornato con successo.");
                } else {
                    alert("Il PIN deve essere di almeno 4 cifre.");
                }
            },
             saveOwnerPin() {
                if (this.newOwnerPin.length >= 4) {
                    this.pins.owner = this.newOwnerPin;
                    this.saveData();
                    this.newOwnerPin = '';
                    alert("PIN Titolare aggiornato con successo.");
                } else {
                    alert("Il PIN deve essere di almeno 4 cifre.");
                }
            },
            
            saveData() {
                const dataToSave = {
                    menu: this.menu,
                    modifiers: this.modifiers,
                    compositionPrices: this.compositionPrices,
                    deliveryZones: this.deliveryZones,
                    drivers: this.drivers,
                    pins: this.pins,
                    lastOrderId: this.lastOrderId,
                    activeOrders: this.activeOrders,
                    archive: this.archive,
                    customerHistory: this.customerHistory,
                    capacitySettings: this.capacitySettings
                };
                localStorage.setItem('pizzeriaSmartData', JSON.stringify(dataToSave));
            },
            loadData() {
                const savedData = localStorage.getItem('pizzeriaSmartData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    this.menu = data.menu || this.menu;
                    this.modifiers = data.modifiers || this.modifiers;
                    this.compositionPrices = data.compositionPrices || this.compositionPrices;
                    this.deliveryZones = data.deliveryZones || this.deliveryZones;
                    this.drivers = data.drivers || this.drivers;
                    this.pins = data.pins || this.pins;
                    this.lastOrderId = data.lastOrderId || 0;
                    this.activeOrders = data.activeOrders || [];
                    this.archive = data.archive || [];
                    this.customerHistory = data.customerHistory || [];
                    this.capacitySettings = data.capacitySettings || this.capacitySettings;
                    
                    if (!this.menu[this.activeSettingsCat]) {
                        this.activeSettingsCat = Object.keys(this.menu)[0] || 'Pizza Classica';
                    }
                }
            },
            
            // --- Funzioni Data/Ora ---
            setDefaultDateTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                this.date = now.toISOString().slice(0, 10);
                this.hour = `${hours}:${minutes}`;
            },
            
            // --- Gestione Carrello ---
            handleItemClick(item) {
                this.searchTerm = ''; 
                
                if (item.isFinished) {
                    alert("Articolo esaurito. Controlla le impostazioni.");
                    return;
                }
                
                if (item.isHalfPizza) {
                    // Logica non implementata nell'HTML finale per brevit√†
                    // this.openHalfPizzaComposition(item);
                    alert("Apertura Composizione Pizza a Met√† (funzionalit√† non implementata nell'HTML finale)");
                } else if (item.isMeter) {
                    // Logica non implementata nell'HTML finale per brevit√†
                    // this.openMeterComposition(item);
                    alert("Apertura Composizione Pizza a Metro (funzionalit√† non implementata nell'HTML finale)");
                } else {
                    const newItem = {
                        nome: item.nome,
                        prezzoBase: item.prezzo,
                        modifiers: [], 
                        isHalfPizza: false,
                        isMeter: false,
                        gusto1: null,
                        gusto2: null,
                    };
                    this.order.push(newItem);
                    this.selectItem(this.order.length - 1);
                    this.updateCapacityWarning();
                }
                if (this.$isMobile()) {
                    this.mobileTab = 'cart'; // Su mobile, torna al carrello dopo l'aggiunta
                }
            },
            selectItem(index) {
                this.selectedItemIndex = index;
                if (this.$isMobile()) {
                    this.mobileTab = 'modifiers'; // Su mobile, passa ai modificatori
                }
            },
            removeItem(index) {
                if (confirm(`Sei sicuro di voler rimuovere "${this.order[index].nome}" dal carrello?`)) {
                    this.order.splice(index, 1);
                    this.selectedItemIndex = null;
                    this.updateCapacityWarning();
                }
            },
            resetOrder() {
                if (confirm("Sei sicuro di voler svuotare l'intero carrello?")) {
                    this.order = [];
                    this.selectedItemIndex = null;
                    this.resetModalData(); 
                    this.updateCapacityWarning();
                }
            },
            
            calculateItemTotal(item) {
                if (item.manualPrice !== undefined) {
                    return item.manualPrice;
                }
                
                let basePrice = item.prezzoBase || 0;
                let modifiersTotal = 0;
                
                if (item.isHalfPizza) {
                    // Logica Pizza a Met√† (Calcola media)
                    const gusto1Price = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                    const gusto2Price = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                    basePrice = Math.ceil((gusto1Price + gusto2Price) / 2);
                    
                    modifiersTotal += (item.modifiers1 || []).reduce((sum, mod) => sum + mod.prezzo, 0);
                    modifiersTotal += (item.modifiers2 || []).reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                } else if (item.isMeter) {
                    // Logica Pizza a Metro
                    basePrice = this.compositionPrices[item.nome][item.gustoCount] || 0;
                    (item.sections || []).forEach(section => {
                        modifiersTotal += (section.modifiers || []).reduce((sum, mod) => sum + mod.prezzo, 0);
                    });
                    
                } else {
                    // Articolo standard
                    modifiersTotal = (item.modifiers || []).reduce((sum, mod) => sum + mod.prezzo, 0);
                }
                
                return parseFloat((basePrice + modifiersTotal).toFixed(2));
            },
            
            // --- Gestione Modificatori (Articoli Standard) ---
            addExtra(modifier) {
                if (this.selectedItemIndex === null || modifier.isFinished) return;
                
                const currentItem = this.order[this.selectedItemIndex];
                
                const existingIndex = currentItem.modifiers.findIndex(m => m.nome === modifier.nome);
                if (existingIndex !== -1) {
                    currentItem.modifiers.splice(existingIndex, 1);
                    return;
                }
                
                if (this.activeModCat === 'Senza') {
                     currentItem.modifiers = currentItem.modifiers.filter(m => this.getModifierCategory(m.nome) !== 'Senza');
                }
                
                currentItem.modifiers.push({
                    nome: modifier.nome,
                    prezzo: modifier.prezzo,
                    category: this.activeModCat 
                });
            },
            getModifierCategory(modName) {
                for (const cat in this.modifiers) {
                    if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                        return cat;
                    }
                }
                return null;
            },
            getModifierIcon(category) {
                switch(category) {
                    case 'Aggiunte': return 'fa-plus';
                    case 'Senza': return 'fa-minus';
                    default: return 'fa-cookie';
                }
            },
            
            // --- Modifica Prezzo Manuale ---
            openPriceEditModal(index) {
                if (index === null || !this.order[index]) return;
                this.tempPriceEditIndex = index;
                this.newPriceValue = this.order[index].manualPrice !== undefined 
                                     ? this.order[index].manualPrice 
                                     : this.calculateItemTotal(this.order[index]);
                this.showPriceEditModal = true;
            },
            saveNewPrice() {
                const item = this.order[this.tempPriceEditIndex];
                if (this.newPriceValue < 0 || isNaN(this.newPriceValue)) {
                    alert("Inserisci un prezzo valido.");
                    return;
                }
                item.manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                this.showPriceEditModal = false;
                this.updateCapacityWarning();
            },
            resetManualPrice() {
                delete this.order[this.tempPriceEditIndex].manualPrice;
                this.showPriceEditModal = false;
                this.updateCapacityWarning();
            },
            
            // --- Logica Finalizzazione (Modal) ---
            updateDeliveryCost() {
                const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                this.deliveryCost = zone ? zone.price : 0.00;
            },
            
            resetModalData() {
                this.mode = 'banco';
                this.customer = '';
                this.phone = '';
                this.address = '';
                this.streetNumber = '';
                this.town = 'Roma';
                this.tableNumber = '';
                this.notes = '';
                this.zoneName = '';
                this.deliveryCost = 0.00;
                this.discount = 0.00;
                this.discountPercentage = 0;
                this.paymentStatus = 'Da Pagare';
                this.accontoRicevuto = 0.00;
                this.editingOrderId = null;
                this.setDefaultDateTime();
            },
            
            openFinalizeModal(orderToEdit = null) {
                if (this.order.length === 0 && !orderToEdit) {
                    alert("Aggiungi articoli al carrello prima di finalizzare l'ordine.");
                    return;
                }
                
                if (orderToEdit) {
                    // Modalit√† Modifica Ordine Esistente
                    this.editingOrderId = orderToEdit.id;
                    this.mode = orderToEdit.mode;
                    this.customer = orderToEdit.customer || '';
                    this.phone = orderToEdit.phone || '';
                    this.address = orderToEdit.address || '';
                    this.streetNumber = orderToEdit.streetNumber || '';
                    this.town = orderToEdit.town || 'Roma';
                    this.tableNumber = orderToEdit.tableNumber || '';
                    this.date = orderToEdit.date;
                    this.hour = orderToEdit.hour;
                    this.notes = orderToEdit.notes || '';
                    this.zoneName = orderToEdit.zoneName || '';
                    this.discount = orderToEdit.discount || 0.00;
                    this.discountPercentage = orderToEdit.discountPercentage || 0;
                    this.paymentStatus = orderToEdit.paymentStatus;
                    this.accontoRicevuto = orderToEdit.accontoRicevuto || 0.00;
                    
                    this.order = JSON.parse(JSON.stringify(orderToEdit.items));
                } else {
                    // Nuovo Ordine
                    this.resetModalData();
                }
                
                this.updateDeliveryCost();
                this.updateCapacityWarning();
                this.showModal = true;
            },
            
            closeFinalizeModal() {
                if (this.editingOrderId) {
                    // Se stavi modificando un ordine attivo, torna alla vista ordini
                    this.view = 'ordini';
                }
                this.showModal = false;
                this.resetModalData(); 
                this.order = []; // Se il carrello √® ancora pieno, svuotalo (nuovo ordine)
                this.updateCapacityWarning();
            },
            
            saveOrder() {
                if (this.order.length === 0) {
                    alert("L'ordine non pu√≤ essere vuoto.");
                    return;
                }
                if (this.isCapacityFull) {
                    if (!confirm("Sei sicuro di voler salvare l'ordine nonostante la capacit√† esaurita?")) {
                        return;
                    }
                }
                if (!this.date || !this.hour) {
                    alert("Seleziona data e ora di ritiro/consegna.");
                    return;
                }
                if (this.mode === 'consegna' && !this.zoneName) {
                    alert("Seleziona la zona di consegna.");
                    return;
                }

                const orderData = {
                    id: this.editingOrderId || ++this.lastOrderId,
                    timestamp: Date.now(),
                    mode: this.mode,
                    customer: this.mode !== 'banco' ? this.customer : '',
                    phone: this.mode !== 'banco' ? this.phone : '',
                    address: this.mode === 'consegna' ? `${this.address}, ${this.streetNumber}` : '',
                    town: this.mode === 'consegna' ? this.town : '',
                    zoneName: this.mode === 'consegna' ? this.zoneName : '',
                    tableNumber: this.mode === 'banco' ? this.tableNumber : '',
                    date: this.date,
                    hour: this.hour,
                    notes: this.notes,
                    items: JSON.parse(JSON.stringify(this.order)), 
                    subtotal: this.calculatedOrderTotal,
                    deliveryCost: this.deliveryCost,
                    discount: this.discount,
                    discountPercentage: this.discountPercentage,
                    total: this.total,
                    paymentStatus: this.paymentStatus,
                    accontoRicevuto: this.accontoRicevuto,
                    status: 'Pending', 
                };

                if (this.editingOrderId) {
                    const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                    if (index !== -1) {
                        this.activeOrders.splice(index, 1, orderData);
                    }
                    this.view = 'ordini';
                } else {
                    this.activeOrders.push(orderData);
                    this.view = 'ordini';
                    this.order = []; 
                    this.selectedItemIndex = null;
                }
                
                if (this.mode !== 'banco' && this.customer && this.phone) {
                    this.updateCustomerHistory(orderData);
                }
                
                this.closeFinalizeModal();
                this.saveData();
                this.updateCapacityWarning(); 
                alert(`Ordine #${orderData.id} salvato/modificato con successo.`);
            },
            
            // --- Capacit√† Oraria ---
            updateCapacityWarning() {
                if (!this.date || !this.hour) {
                    this.orderCapacity = { interval: 'N/A', total: 0, remaining: 0, warning: false };
                    return;
                }
                
                const intervalMinutes = this.capacitySettings.intervalMinutes;
                const maxPizzas = this.capacitySettings.maxPizzas;
                
                const [h, m] = this.hour.split(':').map(Number);
                const totalMinutes = h * 60 + m;
                const startMinutes = Math.floor(totalMinutes / intervalMinutes) * intervalMinutes;
                
                const startH = String(Math.floor(startMinutes / 60)).padStart(2, '0');
                const startM = String(startMinutes % 60).padStart(2, '0');
                
                const endMinutes = startMinutes + intervalMinutes;
                const endH = String(Math.floor(endMinutes / 60)).padStart(2, '0');
                const endM = String(endMinutes % 60).padStart(2, '0');
                
                const interval = `${startH}:${startM} - ${endH}:${endM}`;
                
                const currentOrdersPizzas = this.activeOrders.reduce((sum, order) => {
                    if (order.date === this.date) {
                        const [orderH, orderM] = order.hour.split(':').map(Number);
                        const orderTotalMinutes = orderH * 60 + orderM;
                        const orderStartMinutes = Math.floor(orderTotalMinutes / intervalMinutes) * intervalMinutes;
                        
                        if (orderStartMinutes === startMinutes) {
                            if (this.editingOrderId && order.id === this.editingOrderId) {
                                return sum;
                            }
                            return sum + order.items.reduce((count, item) => {
                                if (item.isHalfPizza) return count + 1;
                                if (item.isMeter) return count + 2;
                                const category = Object.keys(this.menu).find(cat => 
                                    (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                                );
                                if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                                    return count + 1;
                                }
                                return count;
                            }, 0);
                        }
                    }
                    return sum;
                }, 0);
                
                const totalPizzas = currentOrdersPizzas + this.orderPizzaCount;
                const remaining = maxPizzas - totalPizzas;
                
                this.orderCapacity = {
                    interval: interval,
                    total: maxPizzas,
                    remaining: remaining,
                    warning: remaining <= (maxPizzas * 0.2) && remaining > 0 
                };
            },
            
            // --- Gestione Ordini Attivi (Vista 'ordini') ---
            getModeIcon(mode) {
                switch(mode) {
                    case 'banco': return 'fa-utensils';
                    case 'asporto': return 'fa-bag-shopping';
                    case 'consegna': return 'fa-truck';
                    default: return 'fa-question';
                }
            },
            getModeName(mode) {
                switch(mode) {
                    case 'banco': return 'Banco/Tavolo';
                    case 'asporto': return 'Asporto';
                    case 'consegna': return 'Consegna';
                    default: return 'Sconosciuto';
                }
            },
            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);
                
                if (dateStr === today.toISOString().slice(0, 10)) return 'Oggi';
                if (dateStr === tomorrow.toISOString().slice(0, 10)) return 'Domani';
                
                return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
            },
            
            toggleOrderStatus(orderId) {
                const order = this.activeOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = order.status === 'Pending' ? 'Ready' : 'Pending';
                    this.saveData();
                }
            },
            
            archiveOrder(orderId) {
                if (!confirm("Sei sicuro di voler archiviare l'ordine? Questa azione √® permanente nello storico.")) return;
                
                const index = this.activeOrders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    const [orderToArchive] = this.activeOrders.splice(index, 1);
                    
                    if (orderToArchive.mode === 'consegna' && !orderToArchive.driver) {
                        const driver = prompt("Inserisci il nome del fattorino per questo ordine:", this.drivers[0] || "");
                        if (driver) {
                            orderToArchive.driver = driver;
                        }
                    }
                    
                    orderToArchive.archivedTimestamp = Date.now();
                    this.archive.push(orderToArchive);
                    this.saveData();
                    this.updateCapacityWarning(); 
                }
            },
            
            openEditOrderModal(orderId) {
                const order = this.activeOrders.find(o => o.id === orderId);
                if (order) {
                    this.openFinalizeModal(order);
                }
            },
            
            // --- Storico e Statistiche ---
            calculateDriverStats() {
                const stats = { totalOrders: 0, totalRevenue: 0 };
                
                this.archive.forEach(order => {
                    if (order.driver === this.selectedDriver && order.date === this.archiveDateFilter) {
                        stats.totalOrders++;
                        stats.totalRevenue += order.total;
                    }
                });
                
                this.driverStats = stats;
            },
            showArchiveDetails(order) {
                let details = `Dettagli Ordine #${order.id}\n`;
                details += `Cliente/Tavolo: ${order.customer || order.tableNumber || 'N/A'}\n`;
                details += `Modalit√†: ${this.getModeName(order.mode)}\n`;
                if (order.driver) details += `Fattorino: ${order.driver}\n`;
                details += `Data/Ora: ${this.formatDate(order.date)} ${order.hour}\n`;
                details += `Stato Pagamento: ${order.paymentStatus}\n\n`;
                
                details += 'Articoli:\n';
                order.items.forEach(item => {
                    details += `- ${item.nome} (‚Ç¨${this.calculateItemTotal(item).toFixed(2)})\n`;
                    if (item.modifiers && item.modifiers.length > 0) {
                         details += `  (${item.modifiers.map(m => m.nome).join(', ')})\n`;
                    }
                });
                
                details += '\n--- Totali ---\n';
                details += `Subtotale: ‚Ç¨${order.subtotal.toFixed(2)}\n`;
                if (order.deliveryCost > 0) details += `Consegna: +‚Ç¨${order.deliveryCost.toFixed(2)}\n`;
                if (order.discount > 0) details += `Sconto: -‚Ç¨${order.discount.toFixed(2)}\n`;
                details += `Totale Finale: ‚Ç¨${order.total.toFixed(2)}\n`;
                if (order.notes) details += `Note: ${order.notes}`;
                
                alert(details);
            },
            
            // --- Condivisione Ordine (WhatsApp) ---
            openShareModal(order) {
                this.selectedOrderForShare = order;
                this.showShareModal = true;
            },
            generateShareText(order) {
                if (!order) return "";
                
                let text = `üçï *Riepilogo Ordine Pizzeria Smart* üçï\n`;
                text += `\n*Ordine ID:* #${order.id}\n`;
                text += `*Modalit√†:* ${this.getModeName(order.mode)}\n`;
                
                if (order.mode === 'banco') {
                    text += `*Tavolo/Note:* ${order.tableNumber || 'N/A'}\n`;
                } else {
                    text += `*Cliente:* ${order.customer || 'N/A'}\n`;
                    text += `*Telefono:* ${order.phone || 'N/A'}\n`;
                }

                if (order.mode === 'consegna') {
                    text += `*Indirizzo:* ${order.address} ${order.town}\n`;
                }
                
                text += `\n*Ritira/Consegna:* ${this.formatDate(order.date)} alle ${order.hour}\n`;
                text += `\n*Articoli:*\n`;
                
                order.items.forEach(item => {
                    let itemText = `\n- ${item.nome} (‚Ç¨${this.calculateItemTotal(item).toFixed(2)})`;
                    
                    if (item.modifiers && item.modifiers.length > 0) {
                        itemText += ` (+${item.modifiers.map(m => m.nome).join(', ')})`;
                    }
                    text += itemText;
                });
                
                text += `\n\n*TOTALE DA PAGARE:* ‚Ç¨${order.total.toFixed(2)}\n`;
                text += `*Stato:* ${order.paymentStatus}\n`;
                
                if (order.notes) {
                    text += `\n*Note per l'Ordine:* ${order.notes}\n`;
                }
                
                text += `\nGrazie per aver scelto Pizzeria Smart!`;
                
                return text;
            },
            copyShareText() {
                const textToCopy = this.generateShareText(this.selectedOrderForShare);
                navigator.clipboard.writeText(textToCopy).then(() => {
                    alert("Riepilogo copiato negli appunti!");
                }).catch(err => {
                    console.error('Errore nella copia del testo: ', err);
                    alert("Impossibile copiare il testo.");
                });
            },
            
            // --- Gestione Storico Clienti ---
            updateCustomerHistory(order) {
                if (order.mode === 'banco') return;
                
                const existingIndex = this.customerHistory.findIndex(c => c.phone === order.phone);
                
                const customerData = {
                    name: order.customer,
                    phone: order.phone,
                    address: order.address,
                    town: order.town
                };
                
                if (existingIndex !== -1) {
                    this.customerHistory[existingIndex] = customerData;
                } else {
                    this.customerHistory.push(customerData);
                }
                this.saveData();
            },
            suggestCustomers() {
                const term = this.customer.toLowerCase().trim();
                if (term.length < 3) {
                    this.filteredCustomerSuggestions = [];
                    return;
                }
                
                this.filteredCustomerSuggestions = this.customerHistory.filter(c => 
                    c.name.toLowerCase().includes(term) || c.phone.includes(term)
                ).slice(0, 5); 
            },
            selectCustomerSuggestion(customer) {
                this.customer = customer.name;
                this.phone = customer.phone;
                if (this.mode === 'consegna') {
                    this.address = customer.address.split(',')[0].trim() || '';
                    this.streetNumber = customer.address.split(',')[1]?.trim() || '';
                    this.town = customer.town || this.town;
                }
                this.filteredCustomerSuggestions = [];
            },
            
            // --- Gestione Impostazioni (CRUD) ---
            addNewCategory(target) {
                const newCat = prompt(`Inserisci il nome della nuova categoria (${target}):`);
                if (newCat && newCat.trim()) {
                    if (target === 'menu') {
                        this.menu[newCat.trim()] = [];
                        this.activeSettingsCat = newCat.trim();
                    } else if (target === 'modifiers') {
                        this.modifiers[newCat.trim()] = [];
                        this.activeSettingsModCat = newCat.trim();
                    }
                    this.saveData();
                }
            },
            removeItemFromMenu(category, index) {
                if (index >= 0) {
                    this.menu[category].splice(index, 1);
                } else {
                    if (confirm(`Sei sicuro di voler eliminare la categoria "${category}" e tutti i suoi articoli?`)) {
                        delete this.menu[category];
                        this.activeSettingsCat = Object.keys(this.menu)[0] || 'Pizza Classica';
                    }
                }
                this.saveData();
            },
            addNewItemToMenu(category) {
                this.menu[category].push({ nome: 'Nuovo Articolo', prezzo: 0.00, isFinished: false });
                this.saveData();
            },
            removeItemFromModifiers(category, index) {
                this.modifiers[category].splice(index, 1);
                this.saveData();
            },
            addNewItemToModifiers(category) {
                this.modifiers[category].push({ nome: 'Nuovo Modificatore', prezzo: 0.00, isFinished: false });
                this.saveData();
            },

            addDeliveryZone() {
                this.deliveryZones.push({ name: 'Nuova Zona', price: 0.00 });
                this.saveData();
            },
            removeDeliveryZone(index) {
                this.deliveryZones.splice(index, 1);
                this.saveData();
            },
            
            addDriver() {
                this.drivers.push('Nuovo Fattorino');
                this.saveData();
            },
            removeDriver(index) {
                this.drivers.splice(index, 1);
                this.saveData();
            }

        },
        
        watch: {
            menu: { handler() { this.saveData(); }, deep: true },
            modifiers: { handler() { this.saveData(); }, deep: true },
            compositionPrices: { handler() { this.saveData(); }, deep: true },
            deliveryZones: { handler() { this.saveData(); }, deep: true },
            drivers: { handler() { this.saveData(); }, deep: true },
            pins: { handler() { this.saveData(); }, deep: true },
            capacitySettings: { handler() { this.saveData(); }, deep: true },
            
            zoneName() { this.updateDeliveryCost(); },
            date() { this.updateCapacityWarning(); },
            hour() { this.updateCapacityWarning(); },
            activeOrders() { this.updateCapacityWarning(); },
            archiveDateFilter() { this.calculateDriverStats(); } 
        },

        mounted() {
            this.loadData();
            this.setDefaultDateTime();
            this.view = 'login';
            this.updateCapacityWarning();
        }
    });

    // Aggiungi una propriet√† globale per il check mobile
    app.config.globalProperties.$isMobile = () => {
        return window.innerWidth <= 1024; 
    };

    app.mount('#app');
</script>

</body>
</html>
