<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gestionale SmartApp ‚Äî Smart UI (tutto-in-uno)</title>
<meta name="theme-color" content="#0b1223" />
<style>
  :root{
    --bg:#0b1223; --panel:#0f172a; --bar:#0c1426; --muted:#1f2937;
    --ink:#e5e7eb; --ink-dim:#9aa4bf; --ring:rgba(255,255,255,.08);
    --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;display:flex;flex-direction:column}
  /* Header app-like */
  header{
    position:fixed; top:0; left:0; right:0; z-index:40;
    background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(11,18,35,.92));
    border-bottom:1px solid var(--ring); backdrop-filter:blur(12px);
    padding:calc(env(safe-area-inset-top)+8px) 10px 8px;
  }
  .hbar{display:flex; align-items:center; gap:8px}
  .brand{font-weight:800; letter-spacing:.2px}
  .grow{flex:1}
  .btn{cursor:pointer; border:1px solid var(--ring); padding:8px 12px; border-radius:12px;
       background:linear-gradient(180deg,#1f2937,#0b1223); color:var(--ink); font-weight:700}
  .btn.icon{padding:8px; width:44px; display:inline-flex; align-items:center; justify-content:center}
  .btn.primary{border-color:rgba(59,130,246,.4)}
  .btn.danger{border-color:rgba(239,68,68,.4)}
  .btn.ok{border-color:rgba(34,197,94,.4)}
  /* Top tabs ‚Äì 2 righe forzate */
  .topwrap{margin-top:8px; display:grid; gap:6px}
  .toprow{display:flex; gap:6px; overflow:auto; padding-bottom:2px}
  .tab{border:1px solid var(--ring); border-radius:12px; padding:8px 12px; background:#0e1427; white-space:nowrap; cursor:pointer; font-weight:700}
  .tab.active{outline:2px solid rgba(255,255,255,.18)}
  /* Search */
  .searchbox{margin-top:8px; display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:8px 10px}
  .searchbox input{flex:1; background:#0b1223; color:#e5e7eb; border:1px solid var(--ring); border-radius:10px; padding:10px}
  /* Layout principale */
  main{flex:1; display:grid; grid-template-columns:320px 1fr; min-height:0;
       margin-top:calc(env(safe-area-inset-top)+132px); /* header alto (brand+2 righe+search) */
       margin-bottom:calc(env(safe-area-inset-bottom)+110px); } /* footer alto 2 righe */
  @media (max-width:1060px){ main{grid-template-columns:1fr} }
  /* Ticket */
  aside{background:var(--panel); border-right:1px solid var(--ring); padding:10px; overflow:auto}
  .line{display:flex; justify-content:space-between; align-items:baseline; gap:8px; flex-wrap:wrap}
  .ticket-item{border:1px dashed var(--ring); border-radius:10px; padding:8px; cursor:pointer; margin-bottom:8px; background:#0b1327}
  .ticket-item.active{outline:2px solid var(--accent)}
  .qtybtn{background:#101a30; border:1px solid var(--ring); border-radius:8px; padding:2px 8px; cursor:pointer}
  .extra{font-size:.92rem; color:var(--ink-dim); display:flex; align-items:center; gap:6px; justify-content:space-between}
  .total{padding-top:8px; margin-top:8px; border-top:1px solid var(--ring); font-weight:800; font-size:1.1rem}
  .small{font-size:.85rem; opacity:.85}
  /* Stage (grid centrale) */
  .stage{display:flex; flex-direction:column; min-width:0; padding:10px}
  .grid{flex:1; overflow:auto; padding-top:6px; display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px}
  .gridbtn{border:none; border-radius:14px; padding:18px 10px; color:#fff; font-weight:800; cursor:pointer; text-shadow:0 1px 1px rgba(0,0,0,.3); box-shadow:0 4px 14px rgba(0,0,0,.25)}
  .gridbtn small{display:block; opacity:.92; font-weight:700}
  /* Footer ‚Äì 2 righe gruppi */
  footer{
    position:fixed; left:0; right:0; bottom:0; z-index:35;
    background:linear-gradient(180deg, rgba(11,18,35,.92), rgba(8,12,24,.94));
    border-top:1px solid var(--ring); backdrop-filter:blur(12px);
    padding:8px 10px calc(env(safe-area-inset-bottom)+8px);
  }
  .botwrap{display:grid; gap:6px}
  .botrow{display:flex; gap:6px; overflow:auto; padding-bottom:2px}
  .quick{border:1px solid var(--ring); border-radius:12px; padding:10px 12px; background:linear-gradient(180deg,#1f2937,#0b1223); color:#fff; cursor:pointer; font-weight:800; white-space:nowrap}
  /* Modal impostazioni */
  .modal{position:fixed; inset:0; z-index:50; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.55)}
  .modal.show{display:flex}
  .panel{width:min(1200px,96vw); max-height:84vh; overflow:auto; background:#0b1223; color:#e5e7eb; border:1px solid var(--ring); border-radius:16px; padding:12px}
  .card{border:1px solid var(--ring); border-radius:12px; padding:10px; background:#0e1427}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .hr{height:1px; background:var(--ring); margin:8px 0}
  input[type="text"], input[type="number"]{background:#0b1223; color:#e5e7eb; border:1px solid var(--ring); border-radius:8px; padding:8px}
  .section{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width: 900px){ .section{grid-template-columns:1fr} }
  .swatches{display:flex; flex-wrap:wrap; gap:6px}
  .sw{width:26px; height:26px; border-radius:6px; border:2px solid rgba(255,255,255,.2); cursor:pointer}
  .sw.active{outline:2px solid #fff}
  /* Print */
  @media print{
    header, footer, .modal{display:none !important}
    main{grid-template-columns:1fr}
    aside{border:none}
    body{background:#fff; color:#000}
  }
</style>
</head>
<body v-scope="App" @vue:mounted="init()">
  <header>
    <div class="hbar">
      <div class="brand">üßæ Gestionale SmartApp</div>
      <div class="grow"></div>
      <button class="btn" @click="printOrder" title="Stampa / PDF">üñ®Ô∏è</button>
      <button class="btn" @click="shareWA" title="WhatsApp">üü¢</button>
      <button class="btn" @click="shareEmail" title="Email">‚úâÔ∏è</button>
      <button class="btn" @click="copyOrder" title="Copia">üìã</button>
      <button class="btn icon" @click="openSettings" title="Impostazioni">‚öôÔ∏è</button>
      <button class="btn danger" @click="clearOrder" title="Svuota">üóëÔ∏è</button>
    </div>

    <!-- TOP: 2 righe categorie -->
    <div class="topwrap">
      <div class="toprow">
        <button class="tab" v-for="(g,i) in topRow1" :key="g._uid"
          :class="{active: currentBottomGroup==null && currentTopIndex===i}"
          @click="currentBottomGroup=null; currentTopIndex=i; search='';">
          {{ g.icon }} {{ g.label }}
        </button>
      </div>
      <div class="toprow">
        <button class="tab" v-for="(g,i) in topRow2" :key="g._uid"
          :class="{active: currentBottomGroup==null && currentTopIndex===i+topRow1.length}"
          @click="currentBottomGroup=null; currentTopIndex=i+topRow1.length; search='';">
          {{ g.icon }} {{ g.label }}
        </button>
      </div>
    </div>

    <!-- Ricerca contestuale -->
    <div class="searchbox">
      üîç
      <input type="text" v-model.trim="search"
        :placeholder="currentBottomGroup ? ('Cerca in '+currentBottomGroup.label) : ('Cerca in '+(topGroups[currentTopIndex]?.label||'categoria'))" />
      <button class="btn ok" @click="search=''" title="Pulisci ricerca">‚úñ</button>
    </div>
  </header>

  <main>
    <!-- Ticket -->
    <aside>
      <div class="line" style="margin-bottom:6px">
        <strong>Ordine</strong>
        <span class="small">{{ now }}</span>
      </div>

      <template v-if="cart.length>0">
        <div class="ticket-item" :class="{active: activeIndex===i}"
             v-for="(it,i) in cart" :key="i" @click="activeIndex=i">
          <div class="line">
            <div>
              <strong contenteditable @input="e=>editName(i,e)">{{ it.name }}</strong>
              <span class="small" v-if="it.isService">(servizio)</span>
            </div>
            <div>
              <button class="qtybtn" @click.stop="decQty(i)">‚àí</button>
              <span contenteditable @input="e=>editQty(i,e)">{{ it.qty }}</span>
              <button class="qtybtn" @click.stop="incQty(i)">+</button>
              &nbsp;√ó&nbsp;‚Ç¨ <span contenteditable @input="e=>editPrice(i,e)">{{ it.price.toFixed(2) }}</span>
              <button class="qtybtn" @click.stop="removeItem(i)" title="Elimina">üóëÔ∏è</button>
            </div>
          </div>

          <div class="extra" v-for="(ex,ei) in it.extras" :key="ei">
            <span>‚Ä¢ <span contenteditable @input="e=>editExText(i,ei,e)">{{ ex.text }}</span></span>
            <span class="small">+ ‚Ç¨ <span contenteditable @input="e=>editExPrice(i,ei,e)">{{ ex.price.toFixed(2) }}</span></span>
            <button class="qtybtn" @click.stop="removeExtra(i,ei)">‚úñ</button>
          </div>

          <div class="line">
            <span class="small">Subtotale</span>
            <strong>{{ money(lineTotal(it)) }}</strong>
          </div>
        </div>
      </template>
      <template v-else>
        <div class="small" style="opacity:.7">Nessun articolo ancora.</div>
      </template>

      <div class="total">Totale: <span>{{ money(grandTotal) }}</span></div>
    </aside>

    <!-- Stage (griglia centrale) -->
    <section class="stage">
      <div class="grid">
        <!-- Articoli di categoria -->
        <template v-if="currentBottomGroup==null">
          <button v-for="it in filteredTopItems" :key="it._uid"
                  class="gridbtn" :style="bgStyle(it)" @click="addItem(it)">
            {{ it.icon }} {{ it.label }} <small>{{ money(it.price) }}</small>
          </button>
        </template>
        <!-- Voci del gruppo modificatore -->
        <template v-else>
          <button v-for="ex in filteredBottomItems" :key="ex._uid"
                  class="gridbtn" :style="bgStyle(ex)" @click="applyModifier(ex)">
            {{ ex.icon }} {{ ex.label }} <small>{{ money(ex.price) }}</small>
          </button>
        </template>
      </div>
    </section>
  </main>

  <!-- FOOTER: 2 righe gruppi -->
  <footer>
    <div class="botwrap">
      <!-- Riga 1: intensit√† (Pi√π, Senza, Poco, Abbondante) -->
      <div class="botrow">
        <button v-for="g in bottomPrimary" :key="g._uid"
                class="quick" :style="bgStyle(g)" @click="selectBottomGroup(g)">
          {{ g.icon }} {{ g.label }}
        </button>
      </div>
      <!-- Riga 2: resto (consegna, asporto, banco, ‚Ä¶) -->
      <div class="botrow">
        <button v-for="g in bottomSecondary" :key="g._uid"
                class="quick" :style="bgStyle(g)" @click="selectBottomGroup(g)">
          {{ g.icon }} {{ g.label }}
        </button>
      </div>
    </div>
  </footer>

  <!-- MODAL IMPOSTAZIONI -->
  <div class="modal" :class="{show: showSettings}" @click.self="showSettings=false">
    <div class="panel">
      <div class="line" style="margin-bottom:10px">
        <strong>Impostazioni avanzate</strong>
        <div class="grow"></div>
        <button class="btn" @click="applyAndSave">üíæ Salva</button>
        <button class="btn danger" @click="resetConfig">Ripristina</button>
        <button class="btn" @click="showSettings=false">Chiudi</button>
      </div>

      <div class="section">
        <!-- Categorie (Top) -->
        <div class="card">
          <h3 style="margin:6px 0">Barra superiore ‚Äî Categorie</h3>
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" @click="addTopGroup">‚ûï Aggiungi categoria</button>
          </div>
          <div class="hr"></div>

          <div v-for="(g,gi) in editTop" :key="g._uid" class="card" style="margin-bottom:10px">
            <div class="row">
              <label>Icona</label>
              <input type="text" style="width:80px" v-model="g.icon" />
              <label>Nome</label>
              <input type="text" style="flex:1" v-model="g.label" />
              <label>Colore</label>
              <div class="swatches">
                <div v-for="c in PALETTE" :key="c" class="sw" :class="{active: g.color===c}" :style="{background:c}" @click="g.color=c"></div>
              </div>
              <button class="btn danger" @click="removeTopGroup(gi)">Elimina categoria</button>
            </div>

            <div class="hr"></div>
            <div class="small" style="opacity:.8;margin-bottom:6px">Articoli</div>

            <div v-for="(it,ii) in g.items" :key="it._uid" class="row" style="gap:6px;margin-bottom:6px">
              <input type="text" placeholder="Icona" style="width:80px" v-model="it.icon" />
              <input type="text" placeholder="Nome" style="flex:1" v-model="it.label" />
              <input type="number" step="0.01" placeholder="Prezzo" style="width:140px" v-model.number="it.price" />
              <div class="swatches">
                <div v-for="c in PALETTE" :key="c" class="sw" :class="{active: it.color===c}" :style="{background:c}" @click="it.color=c"></div>
              </div>
              <button class="btn danger" @click="removeTopItem(gi,ii)">üóëÔ∏è</button>
            </div>

            <div class="row">
              <button class="btn" @click="addTopItem(gi)">‚ûï Aggiungi articolo</button>
            </div>
          </div>
        </div>

        <!-- Modificatori (Bottom) -->
        <div class="card">
          <h3 style="margin:6px 0">Barra inferiore ‚Äî Modificatori</h3>
          <div class="row" style="margin-bottom:10px">
            <button class="btn primary" @click="addBottomGroup">‚ûï Aggiungi gruppo</button>
          </div>
          <div class="hr"></div>

          <div v-for="(g,gi) in editBottom" :key="g._uid" class="card" style="margin-bottom:10px">
            <div class="row">
              <label>Icona</label>
              <input type="text" style="width:80px" v-model="g.icon" />
              <label>Nome</label>
              <input type="text" style="flex:1" v-model="g.label" />
              <label>Colore</label>
              <div class="swatches">
                <div v-for="c in PALETTE" :key="c" class="sw" :class="{active: g.color===c}" :style="{background:c}" @click="g.color=c"></div>
              </div>
              <button class="btn danger" @click="removeBottomGroup(gi)">Elimina gruppo</button>
            </div>

            <div class="hr"></div>
            <div class="small" style="opacity:.8;margin-bottom:6px">Voci / modificatori</div>

            <div v-for="(it,ii) in g.items" :key="it._uid" class="row" style="gap:6px;margin-bottom:6px">
              <input type="text" placeholder="Icona" style="width:80px" v-model="it.icon" />
              <input type="text" placeholder="Nome" style="flex:1" v-model="it.label" />
              <input type="number" step="0.01" placeholder="Prezzo" style="width:140px" v-model.number="it.price" />
              <label class="small" style="display:flex;gap:6px;align-items:center">
                <input type="checkbox" v-model="it.applyToOrder"> Applica all‚Äôordine
              </label>
              <div class="swatches">
                <div v-for="c in PALETTE" :key="c" class="sw" :class="{active: it.color===c}" :style="{background:c}" @click="it.color=c"></div>
              </div>
              <button class="btn danger" @click="removeBottomItem(gi,ii)">üóëÔ∏è</button>
            </div>

            <div class="row">
              <button class="btn" @click="addBottomItem(gi)">‚ûï Aggiungi voce</button>
            </div>
          </div>
        </div>
      </div>

      <p class="small" style="margin-top:10px;opacity:.8">
        Le modifiche vengono salvate in locale sul dispositivo (<code>localStorage</code>).
      </p>
    </div>
  </div>

  <!-- Petite-Vue -->
  <script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
  <script>
  const money = n => (isNaN(n)?0:n).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
  const uid = () => Math.random().toString(36).slice(2,9);
  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
  function ensureUidList(arr){
    if(!arr) return;
    arr.forEach(g=>{
      if (g._uid == null) g._uid = uid();
      var its = g.items || [];
      its.forEach(it=>{ if (it._uid == null) it._uid = uid(); });
    });
  }

  const DEFAULT_CONFIG = {
    topGroups: [
      {icon:"üçï", label:"Pizze", color:"#f43f5e", _uid:uid(), items:[
        {icon:"üçï",label:"Margherita",price:6,color:"#f43f5e",_uid:uid()},
        {icon:"üå∂Ô∏è",label:"Diavola",price:7,color:"#ef4444",_uid:uid()},
        {icon:"üçÑ",label:"Funghi",price:7,color:"#10b981",_uid:uid()},
        {icon:"ü•ì",label:"Capricciosa",price:7.5,color:"#f43f5e",_uid:uid()},
        {icon:"üïì",label:"Quattro Stagioni",price:7.5,color:"#f43f5e",_uid:uid()},
        {icon:"üêÉ",label:"Bufala",price:8,color:"#ec4899",_uid:uid()}
      ]},
      {icon:"ü•ü", label:"Calzoni", color:"#f97316", _uid:uid(), items:[
        {icon:"ü•ü",label:"Classico",price:7,color:"#f97316",_uid:uid()},
        {icon:"üßÄ",label:"Ripieno",price:8,color:"#f97316",_uid:uid()}
      ]},
      {icon:"ü•™", label:"Panini", color:"#eab308", _uid:uid(), items:[
        {icon:"üçî",label:"Hamburger",price:5.5,color:"#eab308",_uid:uid()},
        {icon:"üå≠",label:"Hot Dog",price:4.5,color:"#eab308",_uid:uid()}
      ]},
      {icon:"üçû", label:"Schiacciata grande", color:"#22c55e", _uid:uid(), items:[
        {icon:"üçû",label:"Semplice",price:9,color:"#22c55e",_uid:uid()}
      ]},
      {icon:"üìè", label:"Mezzo metro", color:"#6366f1", _uid:uid(), items:[
        {icon:"ü•ì",label:"Salumi",price:14,color:"#6366f1",_uid:uid()}
      ]},
      {icon:"ü•§", label:"Bibite", color:"#0ea5e9", _uid:uid(), items:[
        {icon:"ü•§",label:"Cola 33cl",price:2,color:"#0ea5e9",_uid:uid()},
        {icon:"üíß",label:"Acqua",price:1,color:"#06b6d4",_uid:uid()},
        {icon:"üç∫",label:"Birra",price:3,color:"#0ea5e9",_uid:uid()}
      ]},
      {icon:"üßæ", label:"Ordini", color:"#475569", _uid:uid(), items:[]}
    ],
    bottomGroups: [
      {icon:"‚ûï",label:"Pi√π",color:"#22c55e",_uid:uid(),items:[
        {icon:"üßÄ",label:"Mozzarella",price:1,color:"#22c55e",applyToOrder:false,_uid:uid()},
        {icon:"üçÑ",label:"Funghi",price:1,color:"#22c55e",applyToOrder:false,_uid:uid()},
        {icon:"ü•ì",label:"Prosciutto",price:1.5,color:"#22c55e",applyToOrder:false,_uid:uid()}
      ]},
      {icon:"‚ûñ",label:"Senza",color:"#6b7280",_uid:uid(),items:[
        {icon:"üçÖ",label:"Pomodoro",price:0,color:"#6b7280",applyToOrder:false,_uid:uid()},
        {icon:"üßÖ",label:"Cipolla",price:0,color:"#6b7280",applyToOrder:false,_uid:uid()}
      ]},
      {icon:"ü•Ñ",label:"Poco",color:"#eab308",_uid:uid(),items:[
        {icon:"ü´í",label:"Olio",price:0,color:"#eab308",applyToOrder:false,_uid:uid()}
      ]},
      {icon:"üçΩÔ∏è",label:"Abbondante",color:"#8b5cf6",_uid:uid(),items:[
        {icon:"üßÄ",label:"Formaggio",price:1,color:"#8b5cf6",applyToOrder:false,_uid:uid()},
        {icon:"ü´í",label:"Olive",price:0.5,color:"#8b5cf6",applyToOrder:false,_uid:uid()}
      ]},
      {icon:"üöö",label:"Consegna a domicilio",color:"#3b82f6",_uid:uid(),items:[
        {icon:"üöö",label:"Consegna",price:1.5,color:"#3b82f6",applyToOrder:true,_uid:uid()}
      ]},
      {icon:"ü•°",label:"Da asporto",color:"#14b8a6",_uid:uid(),items:[]},
      {icon:"ü™ë",label:"Banco",color:"#71717a",_uid:uid(),items:[]}
    ]
  };

  function App(){
    return {
      /* ===== STATO ===== */
      now: new Date().toLocaleString('it-IT', {dateStyle:'short', timeStyle:'short'}),
      search: '',
      activeIndex: -1,
      currentTopIndex: 0,
      currentBottomGroup: null,
      showSettings: false,

      topGroups: [],
      bottomGroups: [],
      cart: [],

      PALETTE: ["#f43f5e","#ef4444","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899","#475569","#6b7280","#71717a","#78716c"],

      /* ===== LIFECYCLE ===== */
      init(){
        var self=this;
        setInterval(function(){ self.now=new Date().toLocaleString('it-IT',{dateStyle:'short',timeStyle:'short'}) }, 1000);

        // Config
        var cfgRaw = localStorage.getItem('smartapp_cfg_v3');
        if(cfgRaw){
          try{
            var cfg = JSON.parse(cfgRaw);
            ensureUidList(cfg.topGroups);
            ensureUidList(cfg.bottomGroups);
            this.topGroups = cfg.topGroups || [];
            this.bottomGroups = cfg.bottomGroups || [];
          }catch(e){
            this.resetConfig(true);
          }
        }else{
          this.resetConfig(true);
        }

        // Cart
        var cartRaw = localStorage.getItem('smartapp_cart_v1');
        if(cartRaw){ try{ this.cart = JSON.parse(cartRaw) || []; }catch(e){} }

        // Watchers
        this.$watch(()=>[this.topGroups,this.bottomGroups], ()=> this.saveConfig(), {deep:true});
        this.$watch('cart', ()=> localStorage.setItem('smartapp_cart_v1', JSON.stringify(this.cart)), {deep:true});
      },

      /* ===== DERIVATI ===== */
      get topRow1(){
        var n=this.topGroups.length, mid=Math.ceil(n/2);
        return this.topGroups.slice(0,mid);
      },
      get topRow2(){
        var n=this.topGroups.length, mid=Math.ceil(n/2);
        return this.topGroups.slice(mid);
      },
      get topItems(){
        var g = this.topGroups[this.currentTopIndex];
        return (g && g.items) ? g.items : [];
      },
      get filteredTopItems(){
        var q=this.search.toLowerCase();
        return this.topItems.filter(p=> ( (p.icon||'') + ' ' + p.label ).toLowerCase().includes(q));
      },
      get filteredBottomItems(){
        var q=this.search.toLowerCase();
        var list = (this.currentBottomGroup && this.currentBottomGroup.items) ? this.currentBottomGroup.items : [];
        return list.filter(p=> ( (p.icon||'') + ' ' + p.label ).toLowerCase().includes(q));
      },
      // Gruppi intensit√† (prima riga) vs altri (seconda riga)
      isIntensity(g){
        var n=(g.label||'').toLowerCase();
        return n.indexOf('pi√π')===0 || n.indexOf('senza')===0 || n.indexOf('poco')===0 || n.indexOf('abbondante')===0;
      },
      get bottomPrimary(){ return this.bottomGroups.filter(g=>this.isIntensity(g)); },
      get bottomSecondary(){ return this.bottomGroups.filter(g=>!this.isIntensity(g)); },
      get grandTotal(){ return this.cart.reduce((sum,it)=> sum + this.lineTotal(it), 0); },

      /* ===== STYLE ===== */
      bgStyle(obj){ return {background: obj.color || '#6b7280'}; },
      money,

      /* ===== AZIONI GRIGLIA ===== */
      selectBottomGroup(g){ this.currentBottomGroup=g; this.search=''; },
      addItem(p){
        this.cart.push({name:p.label, price:+p.price||0, qty:1, extras:[], isService:false});
        this.activeIndex=this.cart.length-1;
      },
      applyModifier(ex){
        if(ex.applyToOrder){
          this.cart.push({name:ex.label, price:+ex.price||0, qty:1, extras:[], isService:true});
          this.activeIndex=this.cart.length-1;
          return;
        }
        if(!this.cart.length){ alert('Aggiungi prima un articolo.'); return; }
        var idx = this.activeIndex>=0 ? this.activeIndex : this.cart.length-1;
        var target = this.cart[idx];
        var gname = this.currentBottomGroup ? (this.currentBottomGroup.label || '') : '';
        var prefixNeeded = /Pi√π|Senza|Poco|Abbondante/i.test(gname) ? (gname+' ') : '';
        target.extras.push({text: prefixNeeded + ex.label, price:+ex.price||0});
        this.activeIndex = idx;
      },

      /* ===== TICKET ===== */
      lineTotal(it){
        var extras = (it.extras||[]).reduce((s,e)=> s + (+e.price||0), 0);
        return ((+it.price||0) + extras) * (it.qty||1);
      },
      incQty(i){ this.cart[i].qty = (this.cart[i].qty||1)+1; },
      decQty(i){ this.cart[i].qty = Math.max(1,(this.cart[i].qty||1)-1); },
      removeItem(i){ this.cart.splice(i,1); if(this.activeIndex>=this.cart.length) this.activeIndex=this.cart.length-1; },
      removeExtra(i,ei){ this.cart[i].extras.splice(ei,1); },

      editName(i,e){ this.cart[i].name = e.target.textContent.trim(); },
      editQty(i,e){ var n=parseInt(e.target.textContent)||1; this.cart[i].qty = Math.max(1,n); },
      editPrice(i,e){ var n=parseFloat(e.target.textContent.replace(',','.'))||0; this.cart[i].price = n; },
      editExText(i,ei,e){ this.cart[i].extras[ei].text = e.target.textContent.trim(); },
      editExPrice(i,ei,e){ var n=parseFloat(e.target.textContent.replace(',','.'))||0; this.cart[i].extras[ei].price = n; },

      clearOrder(){ if(confirm('Svuotare l‚Äôordine?')){ this.cart.splice(0); this.activeIndex=-1; } },

      /* ===== Condivisione ===== */
      orderText(){
        const lines = this.cart.map(it=>{
          const cad = (+it.price||0) + (it.extras||[]).reduce((s,e)=>s+(+e.price||0),0);
          const extras = (it.extras||[]).map(e=>`   ‚Ä¢ ${e.text} ${e.price?`(+${money(e.price)})`:''}`).join('\n');
          return `${it.qty}√ó ${it.name} ‚Äî ${money(cad)} cad.\n${extras}`;
        }).join('\n');
        return `ORDINE\n${lines}\nTotale: ${money(this.grandTotal)}\nOra: ${this.now}`;
      },
      printOrder(){ window.print(); },
      async copyOrder(){ try{ await navigator.clipboard.writeText(this.orderText()); alert('Riepilogo copiato!'); }catch{ alert('Copia non disponibile.'); } },
      shareWA(){ const t=encodeURIComponent(this.orderText()); window.open(`https://wa.me/?text=${t}`,'_blank'); },
      shareEmail(){ const s=encodeURIComponent('Nuovo ordine'); const b=encodeURIComponent(this.orderText()); location.href=`mailto:?subject=${s}&body=${b}`; },

      /* ===== Impostazioni ===== */
      editTop: [], editBottom: [],
      openSettings(){
        this.editTop = deepClone(this.topGroups);
        this.editBottom = deepClone(this.bottomGroups);
        ensureUidList(this.editTop); ensureUidList(this.editBottom);
        this.showSettings = true;
      },
      applyAndSave(){
        this.editTop.forEach(g=>{
          g.label = (g.label && g.label.trim()) || 'Senza nome';
          (g.items||[]).forEach(it=> it.label = (it.label && it.label.trim()) || 'Voce');
        });
        this.editBottom.forEach(g=>{
          g.label = (g.label && g.label.trim()) || 'Senza nome';
          (g.items||[]).forEach(it=> it.label = (it.label && it.label.trim()) || 'Voce');
        });
        this.topGroups = deepClone(this.editTop);
        this.bottomGroups = deepClone(this.editBottom);
        if(this.currentTopIndex >= this.topGroups.length) this.currentTopIndex = 0;
        if(this.currentBottomGroup){
          var found = this.bottomGroups.find(g=>g._uid===this.currentBottomGroup._uid);
          this.currentBottomGroup = found || null;
        }
        this.saveConfig();
        this.showSettings=false;
        alert('Impostazioni salvate!');
      },
      saveConfig(){
        const cfg = { topGroups: this.topGroups, bottomGroups: this.bottomGroups };
        localStorage.setItem('smartapp_cfg_v3', JSON.stringify(cfg));
      },
      resetConfig(quiet=false){
        const cfg = deepClone(DEFAULT_CONFIG);
        this.topGroups = cfg.topGroups;
        this.bottomGroups = cfg.bottomGroups;
        this.saveConfig();
        if(!quiet) alert('Configurazione ripristinata.');
      },

      // === CRUD TOP ===
      addTopGroup(){
        this.editTop.push({icon:"üîò",label:"Nuova categoria",color:this.PALETTE[0],_uid:uid(),items:[]});
      },
      removeTopGroup(gi){
        if(!confirm('Eliminare questa categoria?')) return;
        this.editTop.splice(gi,1);
      },
      addTopItem(gi){
        const color = this.editTop[gi].color || this.PALETTE[0];
        this.editTop[gi].items.push({icon:"‚Ä¢",label:"Nuovo articolo",price:0,color:color,_uid:uid()});
      },
      removeTopItem(gi,ii){
        this.editTop[gi].items.splice(ii,1);
      },

      // === CRUD BOTTOM ===
      addBottomGroup(){
        this.editBottom.push({icon:"üîò",label:"Nuovo gruppo",color:this.PALETTE[2],_uid:uid(),items:[]});
      },
      removeBottomGroup(gi){
        if(!confirm('Eliminare questo gruppo?')) return;
        this.editBottom.splice(gi,1);
      },
      addBottomItem(gi){
        const color = this.editBottom[gi].color || this.PALETTE[2];
        this.editBottom[gi].items.push({icon:"‚Ä¢",label:"Nuova voce",price:0,color:color,applyToOrder:false,_uid:uid()});
      },
      removeBottomItem(gi,ii){
        this.editBottom[gi].items.splice(ii,1);
      }
    }
  }

  PetiteVue.createApp({ App }).mount()
  </script>
</body>
</html>
