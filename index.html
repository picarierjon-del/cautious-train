<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart ‚Äì Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; }
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; }
        .mod-btn.yellow { border-color: #facc15; color: #facc15; }
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; }
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item strong { display: block; margin-bottom: 4px; }
        
        /* Selettori Gusto Metro */
        .metro-selector { margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        .metro-selector h4 { margin-top: 0; color: #e31b23; }
        .metro-size-btns { display: flex; gap: 10px; margin-bottom: 10px; }
        .metro-size-btns button { flex: 1; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 6px; font-weight: 700; cursor: pointer; }
        .metro-size-btns button.active { border-color: #e31b23; background: #ffecec; }
        .metro-gusti-btns { display: flex; gap: 5px; margin-top: 10px; }
        .metro-gusti-btns button { flex: 1; padding: 8px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 4px; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
        .metro-gusti-btns button.active { border-color: #3b82f6; background: #e0f2fe; color: #3b82f6; }


        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale Finalizza Ordine */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .mode-card i { font-size: 1.4rem; color: #e31b23; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }
        
        /* Stili Ordini Attivi */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .order-card h4 { margin: 0 0 6px; color: #e31b23; }
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        
        /* Stili Impostazioni (mantenuti) */
        .settings h3 { margin-top: 16px; color: #e31b23; }
        .settings input[type="text"], .settings input[type="number"], .settings select { width: 100%; padding: 8px; margin: 4px 0; border: 1px solid #ccc; border-radius: 6px; }
        .settings button { margin-top: 6px; margin-right: 4px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; }
        .settings button.remove { background: #b91c1c; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 6px; }

        /* Stile per la stampa (nasconde elementi non necessari) */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 12pt; }
            .print-container h3, .print-container p { margin: 2px 0; }
            .print-container ul { list-style: none; padding: 0; margin-bottom: 10px; }
            .print-container li { border-bottom: 1px dotted #ccc; padding: 2px 0; }
        }
    </style>
</head>
<body>
<header>Pizzeria Smart</header>

<main id="app">
    <section v-show="view==='inserimento'">
        <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Crea Nuovo Ordine' }}</h2>
        <div class="cat-row">
            <button class="cat-btn" v-for="c in Object.keys(menu)" :key="c"
                    :class="{active:activeCat===c}" @click="activeCat=c">{{c}}</button>
        </div>

        <div class="metro-selector" v-if="currentMetroItem">
            <h4>Seleziona la composizione del Metro</h4>
            <div class="metro-size-btns">
                <button :class="{active: currentMetroItem.gusti.length === 1}" @click="setMetroSize(1)">
                    <i class="fa-solid fa-square-full"></i> Intero (1 Gusto)
                </button>
                <button :class="{active: currentMetroItem.gusti.length === 2}" @click="setMetroSize(2)">
                    <i class="fa-solid fa-square-half"></i> Diviso (2 Gusti)
                </button>
                <button :class="{active: currentMetroItem.gusti.length === 3}" @click="setMetroSize(3)">
                    <i class="fa-solid fa-puzzle-piece" style="transform: rotate(90deg);"></i> In Tre (3 Gusti)
                </button>
            </div>

            <div v-if="currentMetroItem.gusti.length > 0">
                <p>Seleziona il **gusto base** per ciascuna sezione e i **modificatori**.</p>
                <div class="metro-gusti-btns">
                    <button v-for="n in currentMetroItem.gusti.length" :key="n" 
                            :class="{active: activeMetroGusto === n - 1}" 
                            @click="activeMetroGusto = n - 1">
                        Gusto {{ n }}: {{ currentMetroItem.gusti[n-1].nome || 'VUOTO' }}
                    </button>
                </div>
            </div>
        </div>

        <div class="mod-row">
            <button class="mod-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                    :class="{green:cat==='Pi√π', gray:cat==='Senza', yellow:cat==='Poco', blue:cat==='Abbondante', active: activeModCat===cat}"
                    @click="activeModCat=cat" :disabled="!isAnyItemSelected">{{cat.toUpperCase()}}</button>
        </div>
        <div class="grid" v-if="modifiers[activeModCat]">
            <div class="item" v-for="m in modifiers[activeModCat]" :key="m.nome + m.prezzo" @click="addExtra(m)" 
                 :style="{opacity: !isAnyItemSelected ? 0.5 : 1, cursor: !isAnyItemSelected ? 'not-allowed' : 'pointer'}">
                <strong>{{m.nome}}</strong>
                <span v-if="m.prezzo > 0">‚Ç¨{{m.prezzo.toFixed(2)}}</span>
            </div>
        </div>
        
        <div class="grid" v-if="menu[activeCat]">
            <div class="item" v-for="p in menu[activeCat]" :key="p.nome" @click="addItem(p)">
                <strong>{{p.nome}}</strong>
                ‚Ç¨{{p.prezzo.toFixed(2)}}
            </div>
        </div>

        <div class="order-box">
            <h3>Ordine Corrente 
                <span v-if="selectedItemIndex !== null" style="color: #e31b23; font-size: 0.8rem; font-weight: 400;">
                    (Selezionato: {{order[selectedItemIndex].nome}})
                </span>
            </h3>
            <ul>
                <li v-for="(i,idx) in order" :key="idx" @click="selectItem(idx)">
                    <div class="order-item" :class="{selected: selectedItemIndex === idx}">
                        <span v-if="!i.isMetro">{{i.nome}}</span>
                        <span v-else>
                            **{{i.nome}} ({{i.gusti.length}} Gusti)** <span v-if="i.gusti.every(g => g.nome)">: {{ i.gusti.map(g => g.nome).join(' / ') }}</span>
                        </span>
                        <span>‚Ç¨{{calculateItemTotal(i).toFixed(2)}} <button @click.stop="removeItem(idx)" style="border:none;background:none;color:#e31b23">‚úñÔ∏è</button></span>
                    </div>
                    
                    <template v-if="!i.isMetro">
                        <ul v-if="i.modifiers && i.modifiers.length > 0" class="modifiers-list">
                            <li v-for="(mod, modIdx) in i.modifiers" :key="modIdx">
                                <span>* {{mod.nome}} <span v-if="mod.prezzo > 0">(+‚Ç¨{{mod.prezzo.toFixed(2)}})</span></span>
                                <button class="mod-remove-btn" @click.stop="removeModifier(idx, modIdx)">‚ùå</button>
                            </li>
                        </ul>
                    </template>
                    <template v-else>
                        <div v-for="(gusto, gIdx) in i.gusti" :key="gIdx">
                            <span style="font-size: 0.8rem; font-weight: 600; margin-left: 5px;">Gusto {{gIdx+1}} ({{gusto.nome}}):</span>
                            <ul v-if="gusto.modifiers && gusto.modifiers.length > 0" class="modifiers-list">
                                <li v-for="(mod, modIdx) in gusto.modifiers" :key="modIdx">
                                    <span>* {{mod.nome}} <span v-if="mod.prezzo > 0">(+‚Ç¨{{mod.prezzo.toFixed(2)}})</span></span>
                                    <button class="mod-remove-btn" @click.stop="removeMetroModifier(idx, gIdx, modIdx)">‚ùå</button>
                                </li>
                            </ul>
                        </div>
                    </template>
                </li>
            </ul>
            <div class="total">Totale Ordine: ‚Ç¨{{calculatedOrderTotal.toFixed(2)}}</div>
            <div v-if="deliveryCost > 0" class="total">Costo Consegna: +‚Ç¨{{deliveryCost.toFixed(2)}} ({{zoneName}})</div>
            <div class="total" style="font-size: 1.2rem; margin-top: 10px;">TOTALE COMPLESSIVO: ‚Ç¨{{total.toFixed(2)}}</div>
            
            <button class="final-btn" @click="openModal" :disabled="order.length === 0">{{ editingOrderId ? 'Aggiorna Ordine #' + editingOrderId : 'Finalizza Ordine' }}</button>
            
            <button v-if="editingOrderId" class="final-btn cancel-edit-btn" @click="cancelEdit">Annulla Modifica</button>
        </div>
    </section>

    <section v-show="view==='ordini'">
        <h2>Ordini Attivi</h2>
        <div v-if="!orders.length">Nessun ordine attivo.</div>
        <div class="order-card" v-for="o in orders" :key="o.id">
            <h4>#{{o.id}} ‚Äì {{o.mode.toUpperCase()}} ({{o.status}})</h4>
            <p><strong>Cliente: {{o.customer}}</strong></p>
            <p>Ritiro/Consegna: {{o.hour}}</p>
            <p v-if="o.phone">üìû {{o.phone}}</p>
            <p v-if="o.mode === 'consegna'">
                üìç {{o.address}} {{o.streetNumber}}, **{{o.zone}}** ({{o.town}})
                <br>Costo Consegna: ‚Ç¨{{o.deliveryCost.toFixed(2)}}
            </p>
            <ul class="order-items">
                <template v-for="it in o.items">
                    <li v-if="!it.isMetro">
                        {{it.nome}} ‚Äì ‚Ç¨{{calculateItemTotal(it).toFixed(2)}}
                        <ul v-if="it.modifiers && it.modifiers.length > 0">
                            <li v-for="mod in it.modifiers">
                                * {{mod.nome}} <span v-if="mod.prezzo > 0">(+‚Ç¨{{mod.prezzo.toFixed(2)}})</span>
                            </li>
                        </ul>
                    </li>
                    <li v-else>
                        **{{it.nome}} ({{it.gusti.length}} Gusti)** ‚Äì ‚Ç¨{{calculateItemTotal(it).toFixed(2)}}
                        <div v-for="(gusto, gIdx) in it.gusti">
                            <span style="font-size: 0.9rem; font-weight: 600;">Gusto {{gIdx+1}}: {{gusto.nome}}</span>
                            <ul v-if="gusto.modifiers && gusto.modifiers.length > 0">
                                <li v-for="mod in gusto.modifiers">
                                    * {{mod.nome}} <span v-if="mod.prezzo > 0">(+‚Ç¨{{mod.prezzo.toFixed(2)}})</span>
                                </li>
                            </ul>
                        </div>
                    </li>
                </template>
            </ul>
            <p><strong>Totale: ‚Ç¨{{o.total.toFixed(2)}}</strong></p>
            <div class="order-actions">
                <button class="edit" @click="editOrder(o.id)">Modifica</button>
                <button @click="advance(o)">Avanza Stato</button>
                <button class="share" @click="showShareMenu(o.id)"><i class="fa-solid fa-share-alt"></i> Azioni</button>
                <button class="delete" @click="delOrder(o.id)">Elimina</button>
            </div>
        </div>
    </section>

    <section v-show="view==='impostazioni'" class="settings">
        <h2>Impostazioni Menu</h2>
        </section>
</main>

<nav>
    <button :class="{active:view==='inserimento'}" @click="view='inserimento'"><i class="fa-solid fa-cash-register"></i>Inserimento</button>
    <button :class="{active:view==='ordini'}" @click="view='ordini'"><i class="fa-solid fa-clipboard-list"></i>Ordini</button>
    <button :class="{active:view==='impostazioni'}" @click="view='impostazioni'"><i class="fa-solid fa-gear"></i>Impostazioni</button>
</nav>

<div class="modal-overlay" v-show="showModal" @click.self="showModal=false">
    </div>

<div class="modal-overlay" v-show="showShareModal" @click.self="showShareModal=false">
    </div>


<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<script>
    function getDefaultHour() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    PetiteVue.createApp({
        view:'inserimento',
        showModal: false, 
        showShareModal: false, 
        selectedOrderIdForShare: null, 
        editingOrderId: null, 
        
        // Dati salvati
        // **AGGIUNTO LA PIZZA METRO COME PRODOTTO BASE**
        menu: JSON.parse(localStorage.getItem('pz_menu')||'{"Pizze":[{"nome":"Margherita","prezzo":5},{"nome":"Diavola","prezzo":7.5},{"nome":"Capricciosa","prezzo":8},{"nome":"Pizza Metro (Gusti multipli)","prezzo":20, "isMetro":true}],"Bibite":[{"nome":"Acqua","prezzo":1.5},{"nome":"Cola","prezzo":2.5}]}'),
        modifiers: JSON.parse(localStorage.getItem('pz_modifiers')||'{"Pi√π":[{"nome":"Extra mozzarella","prezzo":1.5},{"nome":"Doppia salsiccia","prezzo":2}],"Senza":[{"nome":"Senza olive","prezzo":0}]}'),
        deliveryZones: JSON.parse(localStorage.getItem('pz_zones')||'[{"name":"Centro","price":2.5},{"name":"Periferia","price":4}]'),
        orders: JSON.parse(localStorage.getItem('pz_orders')||'[]'),

        // Stato Ordine Corrente
        activeCat:'Pizze',
        activeModCat: 'Pi√π',
        order:[],
        calculatedOrderTotal: 0, 
        total:0, 
        selectedItemIndex: null,
        activeMetroGusto: 0, // 0, 1, 2 (indice dell'array gusti)

        // Dati per il Modale/Finalizzazione (mantenuti)
        modes:[
            {id:"consegna",label:"Consegna a domicilio",icon:"fa-solid fa-truck"},
            {id:"asporto",label:"Asporto",icon:"fa-solid fa-bag-shopping"},
            {id:"banco",label:"Banco",icon:"fa-solid fa-chair"}
        ],
        mode:'',
        customer:'',
        phone:'',
        address:'',
        streetNumber:'',
        zoneName:'', 
        deliveryCost: 0, 
        town:'',
        hour: getDefaultHour(),

        // Dati per Impostazioni (mantenuti)
        newMenuCat: '', newProdCat: '', newName: '', newPrice: '',
        newModCat: '', newModProdCat: '', newModName: '', newModPrice: 0,
        newZoneName: '', newZonePrice: 0, 

        saveData(){
            localStorage.setItem('pz_menu',JSON.stringify(this.menu));
            localStorage.setItem('pz_orders',JSON.stringify(this.orders));
            localStorage.setItem('pz_modifiers',JSON.stringify(this.modifiers));
            localStorage.setItem('pz_zones',JSON.stringify(this.deliveryZones));
        },
        
        // --- PROPRIET√Ä COMPUTATE ---
        get isAnyItemSelected() {
            return this.selectedItemIndex !== null;
        },

        get currentMetroItem() {
            if (this.selectedItemIndex === null) return null;
            const item = this.order[this.selectedItemIndex];
            return item.isMetro ? item : null;
        },

        // --- Logica Ordine e Modificatori (MODIFICATA PER METRO) ---
        calculateItemTotal(item) {
            let total = item.prezzo;
            if (item.isMetro) {
                // Per il metro, sommiamo i prezzi base dei gusti e i modificatori dei gusti
                item.gusti.forEach(gusto => {
                    if (gusto.basePrice) total += gusto.basePrice; // Aggiunge il costo base della pizza usata come gusto
                    total += gusto.modifiers.reduce((s, m) => s + m.prezzo, 0);
                });
            } else {
                // Per gli articoli standard
                total += item.modifiers.reduce((s, m) => s + m.prezzo, 0);
            }
            return total;
        },
        
        calc(){
            this.calculatedOrderTotal = this.order.reduce((sum, item) => {
                return sum + this.calculateItemTotal(item);
            }, 0);
            this.total = this.calculatedOrderTotal + this.deliveryCost;
        },
        
        addItem(p){
            // Seleziona prima di tutto un altro elemento per deselezionare quello corrente
            this.selectedItemIndex = null;
            
            let newItem;
            if (p.isMetro) {
                // Struttura base per la pizza Metro
                newItem = {
                    ...p, 
                    isMetro: true,
                    gusti: [], // L'utente sceglier√† la divisione (1, 2, o 3) dopo
                };
            } else {
                // Struttura per prodotti standard
                newItem = {
                    ...p, 
                    modifiers: []
                };
            }
            
            this.order.push(newItem);
            this.selectedItemIndex = this.order.length - 1; 
            this.activeMetroGusto = 0; // Resetta il gusto attivo
            
            // Se √® Metro, chiedi all'utente di selezionare la dimensione/gusti
            if (p.isMetro) {
                // Nient'altro da fare, la UI chieder√† la dimensione
            } else {
                this.calc();
            }
        },

        // NUOVA FUNZIONE: Imposta la dimensione e i gusti iniziali del Metro
        setMetroSize(size) {
            const item = this.currentMetroItem;
            if (!item) return;

            // Mantieni i gusti esistenti se il nuovo size √® minore o uguale
            item.gusti = item.gusti.slice(0, size);

            // Aggiungi sezioni vuote se il nuovo size √® maggiore
            while (item.gusti.length < size) {
                item.gusti.push({ 
                    nome: `Gusto ${item.gusti.length + 1} da definire`,
                    basePrice: 0, // Prezzo base della pizza usata come gusto
                    modifiers: []
                });
            }
            this.activeMetroGusto = 0;
            this.calc();
        },
        
        selectItem(index) {
            this.selectedItemIndex = index;
            // Se l'elemento selezionato √® un Metro, assicurati che il gusto attivo sia valido
            if (this.currentMetroItem && this.currentMetroItem.gusti.length > 0) {
                this.activeMetroGusto = Math.min(this.activeMetroGusto, this.currentMetroItem.gusti.length - 1);
            } else {
                this.activeMetroGusto = 0; // Default per elementi non Metro o Metro non configurati
            }
        },
        
        addExtra(mod){
            if (!this.isAnyItemSelected) {
                alert("Seleziona prima un prodotto dall'ordine corrente.");
                return;
            }
            
            const item = this.order[this.selectedItemIndex];

            if (item.isMetro) {
                // Logica per Metro: aggiunge il modificatore al gusto attivo
                if (item.gusti.length === 0) {
                    alert("Seleziona prima la composizione (1, 2 o 3 gusti) per il Metro.");
                    return;
                }
                const gusto = item.gusti[this.activeMetroGusto];
                
                // Se il gusto non ha ancora un nome (vuol dire che non √® stato scelto un gusto base)
                if (gusto.basePrice === 0 && gusto.modifiers.length === 0) {
                    alert("Seleziona prima un gusto base (Margherita, Capricciosa, ecc.) per il Gusto " + (this.activeMetroGusto + 1));
                    return;
                }
                
                gusto.modifiers.push(mod);
            } else {
                // Logica per prodotti standard
                item.modifiers.push(mod);
            }
            this.calc();
        },
        
        // NUOVA FUNZIONE: Rimuovi modificatore dal Gusto Metro
        removeMetroModifier(itemIndex, gustoIndex, modIndex) {
            const item = this.order[itemIndex];
            if (item && item.isMetro) {
                item.gusti[gustoIndex].modifiers.splice(modIndex, 1);
            }
            this.calc();
        },

        removeModifier(itemIndex, modIndex) {
            this.order[itemIndex].modifiers.splice(modIndex, 1);
            this.calc();
        },
        
        removeItem(i){
            if (this.selectedItemIndex === i) {
                this.selectedItemIndex = null;
            } else if (this.selectedItemIndex > i) {
                this.selectedItemIndex--;
            }
            this.order.splice(i,1);
            this.calc();
        },
        
        // La funzione addItem viene modificata per gestire il caso in cui il prodotto √® la pizza base di un Metro.
        // Adesso, se l'elemento selezionato √® un Metro, l'aggiunta di un prodotto "normale"
        // non lo aggiunge all'ordine ma lo usa come gusto per la sezione attiva.
        addItem(p) {
            const item = this.currentMetroItem;
            
            // CASO 1: √à selezionato un Metro E non √® la 'Pizza Metro' (per evitare loop)
            if (item && p.nome !== item.nome) {
                if (item.gusti.length === 0) {
                    alert("Seleziona prima la composizione (1, 2 o 3 gusti) per il Metro.");
                    return;
                }
                
                const currentGusto = item.gusti[this.activeMetroGusto];
                
                // Se stiamo riassegnando un gusto, chiedi conferma
                if (currentGusto.nome !== `Gusto ${this.activeMetroGusto + 1} da definire`) {
                    if (!confirm(`Sei sicuro di voler sostituire il gusto corrente '${currentGusto.nome}' con '${p.nome}'? Tutti i modificatori esistenti per questa sezione verranno mantenuti.`)) {
                        return;
                    }
                }
                
                // Imposta il gusto base
                currentGusto.nome = p.nome;
                currentGusto.basePrice = p.prezzo;
                
                this.calc();
            } 
            // CASO 2: Prodotto Standard o Aggiunta di un nuovo Metro
            else {
                // Se √® un Metro, inizializza la struttura interna (setMetroSize viene chiamata dopo il click del prodotto base)
                this.order.push(p.isMetro ? {...p, isMetro: true, gusti: []} : {...p, modifiers: []});
                this.selectedItemIndex = this.order.length - 1; 
                this.activeMetroGusto = 0;
                this.calc();
            }
        },

        // --- Logica Modifica Ordine (mantenuta) ---
        resetCurrentOrderState() {
            this.order = [];
            this.selectedItemIndex = null;
            this.calculatedOrderTotal = 0;
            this.total = 0;
            this.editingOrderId = null;
            this.activeMetroGusto = 0; // Aggiunto reset
            
            this.mode = '';
            this.customer = this.phone = this.address = this.streetNumber = this.town = '';
            this.zoneName = '';
            this.deliveryCost = 0;
            this.hour = getDefaultHour();
        },
        
        editOrder(id) {
            const orderToEdit = this.orders.find(o => o.id === id);
            if (!orderToEdit) return;

            this.resetCurrentOrderState();
            this.editingOrderId = id;
            
            // IMPORTANTE: Clonazione profonda dei dati dell'ordine, inclusa la struttura Metro
            this.order = JSON.parse(JSON.stringify(orderToEdit.items)); 
            
            this.mode = orderToEdit.mode;
            this.customer = orderToEdit.customer;
            this.phone = orderToEdit.phone || '';
            this.address = orderToEdit.address || '';
            this.streetNumber = orderToEdit.streetNumber || '';
            this.zoneName = orderToEdit.zone || '';
            this.deliveryCost = orderToEdit.deliveryCost || 0;
            this.town = orderToEdit.town || '';
            this.hour = orderToEdit.hour;

            this.calc();
            this.view = 'inserimento';
        },
        
        // --- Condivisione / Stampa (MODIFICATA PER GESTIRE METRO) ---
        formatOrderForSharing(id) {
            const order = this.orders.find(o => o.id === id);
            if (!order) return "";
            
            let text = `================================\n`;
            text += `*COMANDA #${order.id} - ${order.mode.toUpperCase()}*\n`;
            text += `Ora: ${order.hour} | Stato: ${order.status}\n`;
            text += `Cliente: ${order.customer}`;
            if (order.phone) text += ` | Tel: ${order.phone}\n`;
            else text += `\n`;

            if (order.mode === 'consegna') {
                text += `üìç Indirizzo: ${order.address} ${order.streetNumber}, ${order.town}\n`;
                text += `Zona: ${order.zone} (+‚Ç¨${order.deliveryCost.toFixed(2)})\n`;
            }
            text += `--------------------------------\n`;
            text += `*ARTICOLI:*\n`;

            order.items.forEach(item => {
                const itemTotal = this.calculateItemTotal(item);
                
                if (item.isMetro) {
                    text += `üìè *${item.nome} (${item.gusti.length} Gusti)* - ‚Ç¨${itemTotal.toFixed(2)}\n`;
                    item.gusti.forEach((gusto, gIdx) => {
                        text += `  -> Gusto ${gIdx+1}: ${gusto.nome} (Base: ‚Ç¨${gusto.basePrice.toFixed(2)})\n`;
                        gusto.modifiers.forEach(mod => {
                            text += `    -> ${mod.nome}` + (mod.prezzo > 0 ? ` (+‚Ç¨${mod.prezzo.toFixed(2)})` : '') + `\n`;
                        });
                    });
                } else {
                    text += `üçï ${item.nome} - ‚Ç¨${itemTotal.toFixed(2)}\n`;
                    item.modifiers.forEach(mod => {
                        text += `  -> ${mod.nome}` + (mod.prezzo > 0 ? ` (+‚Ç¨${mod.prezzo.toFixed(2)})` : '') + `\n`;
                    });
                }
            });

            text += `--------------------------------\n`;
            text += `Totale prodotti: ‚Ç¨${(order.total - order.deliveryCost).toFixed(2)}\n`;
            if (order.deliveryCost > 0) {
                text += `Costo Consegna: ‚Ç¨${order.deliveryCost.toFixed(2)}\n`;
            }
            text += `*TOTALE COMPLESSIVO: ‚Ç¨${order.total.toFixed(2)}*\n`;
            text += `================================`;

            return text;
        },

        printOrder(id) {
            this.showShareModal = false;

            const order = this.orders.find(o => o.id === id);
            if (!order) return;

            const printWindow = window.open('', '', 'height=600,width=800');
            
            let printContent = `
                <div class="print-container">
                    <h3>Pizzeria Smart - Comanda</h3>
                    <p>Ordine #<strong>${order.id}</strong> - ${order.mode.toUpperCase()}</p>
                    <p>Ora: ${order.hour}</p>
                    <p>Cliente: <strong>${order.customer}</strong> ${order.phone ? `(${order.phone})` : ''}</p>
            `;
            
            if (order.mode === 'consegna') {
                printContent += `
                    <p>Indirizzo: ${order.address} ${order.streetNumber}, ${order.town}</p>
                    <p>Zona: ${order.zone} (Costo: ‚Ç¨${order.deliveryCost.toFixed(2)})</p>
                `;
            }
            
            printContent += `
                    <hr>
                    <h4>Articoli:</h4>
                    <ul>
            `;
            
            order.items.forEach(item => {
                const itemTotal = this.calculateItemTotal(item);
                
                if (item.isMetro) {
                    printContent += `<li>**${item.nome} (${item.gusti.length} Gusti)** - ‚Ç¨${itemTotal.toFixed(2)}</li>`;
                    item.gusti.forEach((gusto, gIdx) => {
                        printContent += `<li>&nbsp; &nbsp; &nbsp; ‚Ü≥ Gusto ${gIdx+1}: ${gusto.nome} (Base: ‚Ç¨${gusto.basePrice.toFixed(2)})</li>`;
                        gusto.modifiers.forEach(mod => {
                            printContent += `<li>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ‚Ü≥ ${mod.nome} ${mod.prezzo > 0 ? `(+‚Ç¨${mod.prezzo.toFixed(2)})` : ''}</li>`;
                        });
                    });
                } else {
                    printContent += `<li><strong>${item.nome}</strong> - ‚Ç¨${itemTotal.toFixed(2)}</li>`;
                    item.modifiers.forEach(mod => {
                        printContent += `<li>&nbsp; &nbsp; &nbsp; ‚Ü≥ ${mod.nome} ${mod.prezzo > 0 ? `(+‚Ç¨${mod.prezzo.toFixed(2)})` : ''}</li>`;
                    });
                }
            });

            printContent += `
                    </ul>
                    <hr>
                    <p>Totale: ‚Ç¨${(order.total - order.deliveryCost).toFixed(2)}</p>
                    ${order.deliveryCost > 0 ? `<p>Costo Consegna: ‚Ç¨${order.deliveryCost.toFixed(2)}</p>` : ''}
                    <h3>TOTALE COMPLESSIVO: ‚Ç¨${order.total.toFixed(2)}</h3>
                    <p style="text-align: center;">Grazie per l'ordine!</p>
                </div>
            `;
            
            printWindow.document.write('<html><head><title>Stampa Ordine</title>');
            printWindow.document.write('<style>@media print { body > * { display: none; } .print-container { display: block; max-width: 100%; font-family: monospace; font-size: 11pt; padding: 10px; } .print-container h3, .print-container h4, .print-container p { margin: 2px 0; } .print-container ul { list-style: none; padding: 0; margin-bottom: 10px; } .print-container li { padding: 1px 0; } }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 300);
        },

        async shareOrder(id) {
            this.showShareModal = false; 
            const textToShare = this.formatOrderForSharing(id);

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Ordine #${id} - Pizzeria Smart`,
                        text: textToShare,
                    });
                } catch (error) {
                    console.error('Errore nella condivisione:', error);
                    alert("Impossibile condividere. Verr√† eseguita la copia.");
                    this.copyToClipboard(textToShare);
                }
            } 
            else if (navigator.clipboard) {
                 this.copyToClipboard(textToShare);
            } 
            else {
                alert("Il tuo browser non supporta la copia o la condivisione. Usa la funzione stampa per i dettagli.");
            }
        },
        
        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                alert("Dettagli ordine copiati negli appunti!");
            } catch (err) {
                alert('Errore durante la copia: ' + err);
            }
        },

        showShareMenu(id) {
            this.selectedOrderIdForShare = id;
            this.showShareModal = true;
        },
        
        // --- Logica Impostazioni (mantenuta, ma con nuovi campi da gestire) ---
        addZone() { 
            if (this.newZoneName && this.newZonePrice >= 0) {
                if (this.deliveryZones.some(z => z.name === this.newZoneName)) {
                    alert("Una zona con questo nome esiste gi√†.");
                    return;
                }
                this.deliveryZones.push({name: this.newZoneName, price: this.newZonePrice});
                this.saveData();
                this.newZoneName = '';
                this.newZonePrice = 0;
            } else {
                alert("Inserisci un nome valido e un costo non negativo.");
            }
        },

        deleteZone(i) {
            if(confirm("Sei sicuro di voler eliminare questa zona?")) {
                this.deliveryZones.splice(i, 1);
                this.saveData();
            }
        },
        
        addMenuCategory() { 
            if (this.newMenuCat && !this.menu[this.newMenuCat]) {
                this.menu[this.newMenuCat] = [];
                this.saveData();
                this.newMenuCat = '';
            } else {
                alert("Inserisci una categoria valida o il nome √® gi√† in uso.");
            }
        }, 
        deleteMenuCategory(cat) { 
            if (confirm("Sei sicuro di voler eliminare la categoria '" + cat + "' e tutti i suoi prodotti?")) {
                delete this.menu[cat];
                this.activeCat = Object.keys(this.menu)[0] || '';
                this.saveData();
            }
        },
        addProd(){ 
            if(!this.newProdCat||!this.newName||!this.newPrice)return;
            // Se il prodotto aggiunto √® la Pizza Metro, assicurati che abbia la propriet√† isMetro
            const isMetro = this.newName.toLowerCase().includes('metro'); // Semplice euristica
            this.menu[this.newProdCat].push({nome:this.newName,prezzo:this.newPrice, isMetro: isMetro});
            this.saveData();
            this.newName='';this.newPrice='';
        }, 
        deleteProd(cat,i){ 
            if(confirm("Sei sicuro di voler eliminare questo prodotto?")) {
                this.menu[cat].splice(i,1);
                if(!this.menu[cat].length)delete this.menu[cat];
                this.saveData();
            }
        },

        addModCategory() {
            if (this.newModCat && !this.modifiers[this.newModCat]) {
                this.modifiers[this.newModCat] = [];
                this.saveData();
                this.newModCat = '';
            } else {
                alert("Inserisci una categoria valida o il nome √® gi√† in uso.");
            }
        },
        deleteModCategory(cat) {
            if (confirm("Sei sicuro di voler eliminare la categoria di modificatori '" + cat + "' e tutti i suoi elementi?")) {
                delete this.modifiers[cat];
                this.activeModCat = Object.keys(this.modifiers)[0] || '';
                this.saveData();
            }
        },
        addMod(){
            if(!this.newModProdCat || !this.newModName) return;
            this.modifiers[this.newModProdCat].push({nome: this.newModName, prezzo: this.newModPrice});
            this.saveData();
            this.newModProdCat = this.newModName = '';
            this.newModPrice = 0;
        },
        deleteMod(cat, i){
            if(confirm("Sei sicuro di voler eliminare questo modificatore?")) {
                this.modifiers[cat].splice(i, 1);
                if(!this.modifiers[cat].length) delete this.modifiers[cat];
                this.saveData();
            }
        }

    }).mount()
</script>
</body>
</html>
