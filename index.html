<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart - POS Prototype</title>
    <script src="https://unpkg.com/petite-vue"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ************************************************************ */
        /* PARTE 1: CODICE CSS COMPLETO */
        /* ************************************************************ */

        :root {
            --primary-color: #e74c3c; /* Rosso pizza */
            --secondary-color: #3498db; /* Blu */
            --dark-color: #2c3e50; /* Blu scuro */
            --light-color: #ecf0f1; /* Grigio chiaro */
            --success-color: #27ae60; /* Verde */
            --warning-color: #f39c12; /* Giallo/Arancio */
            --danger-color: #c0392b; /* Rosso scuro */
            --header-height: 60px;
        }

        /* 1. Reset e Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* 2. Layout Principale */
        .app-container {
            display: flex;
            flex-grow: 1;
        }

        .main-header {
            background-color: var(--dark-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        /* 3. Login View */
        .login-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            width: 100%;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .login-box input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 3px;
        }

        .btn-login {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-login:hover {
            background-color: var(--danger-color);
        }

        /* 4. Barra di Navigazione */
        .navbar {
            display: flex;
            background-color: var(--dark-color);
            color: white;
            padding: 0 20px;
            justify-content: flex-start;
            gap: 15px;
            height: 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            background: none;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-item.active,
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-bottom: 3px solid var(--primary-color);
        }
        
        /* 5. Sezione Inserimento (POS) */
        .pos-grid {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr; /* Menu | Modificatori | Carrello */
            gap: 15px;
            padding: 15px;
            flex-grow: 1;
        }

        .menu-items, .modifiers-panel, .cart-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .menu-categories, .modifier-categories {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .cat-btn {
            background: var(--dark-color);
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 0 5px 5px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .cat-btn:hover {
            background-color: var(--secondary-color);
        }

        .cat-btn.active {
            background-color: var(--primary-color);
        }
        
        .search-bar {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
        }

        /* Griglie Articoli e Modificatori */
        .item-grid, .modifier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            overflow-y: auto;
            padding-right: 5px; /* Spazio per scrollbar */
        }
        
        .grid-item {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s;
            border: 1px solid #ddd;
            font-size: 0.85rem;
            position: relative;
        }

        .grid-item:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .grid-item.finished {
            background-color: #f7d794; /* Giallo/Arancio tenue */
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        
        .grid-item.finished::after {
            content: "ESAURITO";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--danger-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        /* Cart Panel */
        .cart-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 5px solid transparent;
            transition: background-color 0.2s, border-left 0.2s;
            background-color: #f9f9f9;
        }
        
        .cart-item.selected {
            background-color: #ffeaa7; /* Giallo tenue */
            border-left: 5px solid var(--warning-color);
        }

        .cart-item span {
            flex-grow: 1;
        }

        .cart-item-details {
             display: flex;
             flex-direction: column;
             align-items: flex-start;
             flex-grow: 1;
             padding-left: 5px;
             font-size: 0.9rem;
        }

        .item-mods {
            font-size: 0.75rem;
            color: var(--secondary-color);
            margin-top: 2px;
            font-style: italic;
        }

        .cart-remove-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.1rem;
        }

        .cart-summary {
            border-top: 1px solid #ccc;
            padding-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .finalize-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .finalize-btn:disabled {
             background-color: #ccc;
             cursor: not-allowed;
        }

        .finalize-btn:hover:not(:disabled) {
            background-color: #2ecc71;
        }
        
        .price-edit-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 5px;
        }

        /* 6. Modale di Finalizzazione */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--danger-color);
        }
        
        .modal-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
            background-color: #f4f4f4;
        }

        .mode-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }
        
        .modal-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--primary-color);
            font-size: 1.4rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        
        .modal-summary-item {
             font-size: 1rem;
             font-weight: normal;
             color: #666;
             display: flex;
             justify-content: space-between;
             margin-top: 5px;
        }
        
        .resto-da-dare {
             color: var(--danger-color);
             font-size: 1.1rem;
        }
        
        .customer-autocomplete-list {
             position: absolute;
             width: 100%;
             max-height: 150px;
             overflow-y: auto;
             background-color: white;
             border: 1px solid #ccc;
             border-top: none;
             z-index: 10;
        }

        .customer-autocomplete-list li {
             list-style: none;
             padding: 8px 10px;
             cursor: pointer;
             font-size: 0.9rem;
        }

        .customer-autocomplete-list li:hover {
             background-color: #f0f0f0;
        }
        
        /* Avviso Capacità */
        .capacity-warning {
             padding: 10px;
             border-radius: 4px;
             margin-bottom: 15px;
             font-weight: bold;
             text-align: center;
        }

        .capacity-warning.full {
             background-color: var(--danger-color);
             color: white;
        }
        
        .capacity-warning.near {
             background-color: var(--warning-color);
             color: var(--dark-color);
        }

        /* 7. Vista Ordini Attivi */
        .orders-list-view {
            padding: 15px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .orders-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
             background: white;
             padding: 10px;
             border-radius: 6px;
        }
        
        .orders-header .filters {
             display: flex;
             gap: 10px;
             align-items: center;
        }

        .orders-header input, .orders-header select {
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
        }

        .order-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            padding-top: 10px;
        }

        .order-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--dark-color);
            transition: border-left 0.3s;
            position: relative;
        }

        .order-card.urgent {
             border-left: 5px solid var(--danger-color);
        }
        
        .order-card.near {
             border-left: 5px solid var(--warning-color);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
        }
        
        .order-header h3 {
             font-size: 1.1rem;
        }

        .order-details p {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .order-items-list {
            margin: 10px 0;
            padding: 0;
            list-style-type: disc;
            padding-left: 20px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .order-items-list li {
            margin-bottom: 3px;
        }

        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            border-top: 1px dashed #ddd;
            padding-top: 10px;
        }

        .order-footer .total {
            font-weight: bold;
            font-size: 1.3rem;
            color: var(--primary-color);
        }

        .status-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .status-in-preparazione { background-color: var(--secondary-color); }
        .status-pronto { background-color: var(--success-color); }
        .status-consegnato { background-color: #7f8c8d; }
        .status-archivia { background-color: var(--dark-color); }

        .status-in-attesa { background-color: var(--warning-color); color: var(--dark-color); }
        
        .status-tag {
             font-weight: bold;
             padding: 4px 8px;
             border-radius: 4px;
             font-size: 0.8rem;
        }
        
        .driver-select-container {
             margin-top: 10px;
             display: flex;
             gap: 5px;
             align-items: center;
        }

        /* 8. Vista Archivio */
        .archive-view {
             padding: 15px;
             flex-grow: 1;
             overflow-y: auto;
        }
        
        .archive-controls {
             display: flex;
             gap: 20px;
             background: white;
             padding: 15px;
             border-radius: 8px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
             margin-bottom: 15px;
        }

        .archive-stats {
             flex: 1;
             display: flex;
             flex-direction: column;
             gap: 10px;
             border-right: 1px solid #eee;
             padding-right: 20px;
        }
        
        .archive-stats h3 {
             margin-bottom: 5px;
             color: var(--primary-color);
             font-size: 1.1rem;
        }
        
        .archive-stats p {
             font-size: 0.9rem;
        }
        
        .archive-filter {
             flex: 1;
             display: flex;
             flex-direction: column;
             gap: 10px;
        }

        .archive-table-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .archive-table {
             width: 100%;
             border-collapse: collapse;
             background: white;
             border-radius: 8px;
             overflow: hidden;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .archive-table th, .archive-table td {
             padding: 12px;
             text-align: left;
             border-bottom: 1px solid #f0f0f0;
             font-size: 0.9rem;
        }

        .archive-table th {
             background-color: var(--dark-color);
             color: white;
             font-weight: bold;
             position: sticky;
             top: 0;
             z-index: 5;
        }

        .archive-table tr:hover {
             background-color: #f5f5f5;
        }

        .archive-table .total-column {
             font-weight: bold;
             color: var(--primary-color);
        }
        
        /* 9. Vista Settings */
        .settings-view {
             padding: 15px;
             flex-grow: 1;
             display: flex;
             gap: 15px;
        }

        .settings-sidebar {
             width: 200px;
             background: white;
             border-radius: 8px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
             padding: 10px;
             align-self: flex-start;
        }

        .settings-sidebar button {
             width: 100%;
             padding: 10px;
             margin-bottom: 5px;
             border: none;
             background: none;
             text-align: left;
             cursor: pointer;
             border-radius: 4px;
             transition: background-color 0.2s;
        }
        
        .settings-sidebar button:hover {
             background-color: #f0f0f0;
        }

        .settings-sidebar button.active {
             background-color: var(--secondary-color);
             color: white;
        }

        .settings-content {
             flex-grow: 1;
             background: white;
             border-radius: 8px;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
             padding: 20px;
             overflow-y: auto;
        }

        .settings-section {
             margin-bottom: 30px;
             padding-bottom: 15px;
             border-bottom: 1px solid #eee;
        }

        .settings-section h2 {
             color: var(--primary-color);
             margin-bottom: 15px;
             font-size: 1.4rem;
        }

        .settings-form {
             display: flex;
             gap: 15px;
             margin-bottom: 15px;
             align-items: flex-end;
        }
        
        .settings-form input, .settings-form select {
             padding: 8px;
             border: 1px solid #ccc;
             border-radius: 4px;
        }

        .settings-form .form-group {
             margin-bottom: 0;
             flex: 1;
        }

        .settings-list {
             list-style: none;
        }

        .settings-list li {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 10px 0;
             border-bottom: 1px dotted #ccc;
        }
        
        .settings-list li:last-child {
             border-bottom: none;
        }
        
        .settings-list .item-info {
             display: flex;
             gap: 10px;
             align-items: center;
        }

        .settings-actions button {
             padding: 5px 10px;
             margin-left: 5px;
             border: none;
             border-radius: 4px;
             cursor: pointer;
        }
        
        .settings-actions .btn-danger { background-color: var(--danger-color); color: white; }
        .settings-actions .btn-success { background-color: var(--success-color); color: white; }
        .settings-actions .btn-primary { background-color: var(--primary-color); color: white; }
        .settings-actions .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        
        /* PIN & Backup */
        .pin-settings, .backup-settings {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 20px;
             margin-top: 15px;
        }
        
        .backup-settings {
             grid-template-columns: 1fr 1fr 1fr;
        }
        
        .capacity-settings .form-row {
             gap: 20px;
        }

        /* 10. Modali Composizione (Mezzo Metro & Metà) */
        .composition-modal-content {
             width: 90%;
             max-width: 900px;
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 20px;
        }
        
        .composition-menu, .composition-details {
             background: #f9f9f9;
             padding: 15px;
             border-radius: 6px;
        }
        
        .composition-gusto-picker {
             padding: 10px;
             border: 1px solid var(--primary-color);
             border-radius: 4px;
             cursor: pointer;
             margin-top: 5px;
             background-color: white;
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-weight: bold;
             color: var(--primary-color);
             position: relative;
        }
        
        .composition-gusto-dropdown {
             position: absolute;
             top: 100%;
             left: 0;
             right: 0;
             background: white;
             border: 1px solid #ccc;
             max-height: 200px;
             overflow-y: auto;
             z-index: 10;
        }
        
        .composition-gusto-dropdown li {
             padding: 8px;
             cursor: pointer;
        }
        
        .composition-gusto-dropdown li:hover {
             background-color: #eee;
        }
        
        /* Meter Specific */
        .meter-sections {
             display: flex;
             margin-bottom: 20px;
        }

        .meter-section-tab {
             flex: 1;
             padding: 10px;
             text-align: center;
             cursor: pointer;
             border: 1px solid #ddd;
             background-color: #eee;
             font-size: 0.85rem;
        }
        
        .meter-section-tab.active {
             background-color: var(--secondary-color);
             color: white;
             border-color: var(--secondary-color);
        }
        
        /* Half Pizza Specific */
        .half-pizza-tabs {
             display: flex;
             margin-bottom: 10px;
             border-bottom: 1px solid #ddd;
        }
        
        .half-pizza-tab {
             flex: 1;
             padding: 10px;
             text-align: center;
             cursor: pointer;
             border-bottom: 3px solid transparent;
             transition: border-bottom 0.2s;
             font-weight: bold;
        }
        
        .half-pizza-tab.active {
             border-bottom: 3px solid var(--primary-color);
             color: var(--primary-color);
        }
        
        .half-pizza-details {
             border: 1px solid #ccc;
             padding: 15px;
             border-radius: 6px;
             margin-top: 10px;
        }

        /* 11. Print Styles (non visibili a schermo) */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                min-height: 100vh;
                padding: 10mm; /* Simula un rotolo di carta */
                font-family: monospace;
                font-size: 10pt;
                line-height: 1.4;
            }
            .main-header, .navbar, .app-container {
                display: none;
            }
            .modal-overlay {
                 display: none;
            }
            #print-area h1 { font-size: 1.2em; margin: 5px 0; border-bottom: 2px solid black; padding-bottom: 3px; }
            #print-area h2 { font-size: 1.1em; margin: 8px 0; border-bottom: 1px dashed #333; padding-bottom: 3px; }
            #print-area ul { list-style-type: none; padding-left: 0; margin-bottom: 10px; }
            #print-area li { margin-bottom: 5px; border-bottom: 1px dotted #ccc; padding-bottom: 3px; }
            #print-area table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            #print-area th, #print-area td { padding: 5px; border-bottom: 1px solid #eee; font-size: 0.9em; }
            #print-area .total-row td { font-size: 1.1em; border-top: 1px solid black; }
        }
        
    </style>
</head>
<body v-scope>

    <header class="main-header">
        <h1><i class="fas fa-pizza-slice"></i> Pizzeria Smart POS</h1>
        <div v-if="userRole">
            <span class="user-info">
                Ruolo: <strong :style="{ color: userRole === 'PROPRIETARIO' ? 'var(--warning-color)' : 'var(--success-color)' }">{{ userRole }}</strong> |
                <button class="nav-item" @click="userRole = null; accessPin = ''; view = 'inserimento';" style="border: none; background: none; color: #ccc;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </span>
        </div>
    </header>

    <nav class="navbar" v-if="userRole">
        <button class="nav-item" :class="{ active: view === 'inserimento' }" @click="view = 'inserimento'; editingOrderId = null; resetOrderState();">
            <i class="fas fa-cash-register"></i> Nuovo Ordine
        </button>
        <button class="nav-item" :class="{ active: view === 'ordini' }" @click="view = 'ordini'">
            <i class="fas fa-clock"></i> Ordini Attivi ({{ filteredActiveOrders.length }})
        </button>
        <button class="nav-item" :class="{ active: view === 'archivio' }" @click="view = 'archivio'; calculateDriverStats()">
            <i class="fas fa-archive"></i> Archivio
        </button>
        <button class="nav-item" :class="{ active: view === 'settings' }" @click="view = 'settings'" v-if="userRole === 'PROPRIETARIO'">
            <i class="fas fa-cog"></i> Impostazioni
        </button>
    </nav>

    <main class="app-container">

        <section class="login-view" v-if="!userRole">
            <div class="login-box">
                <h2>Accesso al Sistema POS</h2>
                <p>Inserisci il tuo PIN di accesso:</p>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="****" maxlength="4">
                <button class="btn-login" @click="grantAccess">Accedi</button>
                <p style="margin-top: 15px; font-size: 0.85rem; color: #999;">
                    PIN di default: Operatore 0000 | Proprietario 1111
                </p>
            </div>
        </section>

        <section class="pos-grid" v-if="userRole && view === 'inserimento'">

            <div class="menu-items">
                <h2>Menu</h2>
                <input type="text" v-model="searchTerm" placeholder="Cerca pizza, bibita, etc..." class="search-bar">
                
                <div class="menu-categories">
                    <button v-for="(items, category) in menu" :key="category" 
                            class="cat-btn" :class="{ active: activeCat === category }" 
                            @click="activeCat = category; searchTerm = ''">
                        {{ category }}
                    </button>
                    <button v-if="userRole === 'PROPRIETARIO' && view === 'settings'" class="cat-btn" @click="openNewCategoryModal()">+</button>
                </div>
                
                <div class="item-grid">
                    <button v-for="(item, index) in filteredAvailableItems" :key="index" 
                            class="grid-item" :class="{ 'finished': item.isFinished }" 
                            @click="handleItemClick(item)">
                        <strong>{{ item.nome }}</strong>
                        <br>€{{ item.prezzo.toFixed(2) }}
                        <span v-if="item.isFinished" style="position: absolute; top: 0; right: 5px; color: var(--danger-color);">🚫</span>
                    </button>
                </div>
            </div>

            <div class="modifiers-panel">
                <h2>Modificatori (Extra/Cottura)</h2>
                <div v-if="selectedItemIndex !== null">
                    <p style="margin-bottom: 10px;">Modifica: <strong>{{ order[selectedItemIndex].nome }}</strong></p>
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-bar">
                    
                    <div class="menu-categories modifier-categories">
                        <button v-for="(mods, category) in modifiers" :key="category" 
                                class="cat-btn" :class="{ active: activeModCat === category }" 
                                @click="activeModCat = category; modifierSearchTerm = ''">
                            {{ category }}
                        </button>
                    </div>
                    
                    <div class="modifier-grid">
                        <button v-for="(mod, index) in filteredModifiersForActiveCat" :key="index"
                                class="grid-item" :class="{ 
                                    'finished': mod.isFinished,
                                    'active-mod': order[selectedItemIndex].modifiers && order[selectedItemIndex].modifiers.some(m => m.nome === mod.nome)
                                }" 
                                @click="addExtra(mod)">
                            {{ getModifierIcon(activeModCat) }} <strong>{{ mod.nome }}</strong>
                            <br><span v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                            <span v-else>&nbsp;</span>
                        </button>
                    </div>
                </div>
                <div v-else>
                    <p style="text-align: center; margin-top: 50px; color: #999;">
                        Seleziona un articolo nel carrello per applicare modificatori.
                    </p>
                </div>
            </div>

            <div class="cart-panel">
                <h2 v-if="editingOrderId">Modifica Ordine #{{ editingOrderId.substring(0, 4) }}</h2>
                <h2 v-else>Carrello</h2>
                
                <div class="cart-list">
                    <div v-if="order.length === 0" style="text-align: center; color: #999; padding: 20px;">
                        Carrello vuoto.
                    </div>
                    <div v-for="(item, index) in order" :key="item.id" 
                         class="cart-item" :class="{ selected: selectedItemIndex === index }" 
                         @click="selectItem(index)">
                        
                        <div class="cart-item-details">
                            <span :style="{ fontWeight: item.manualPrice !== undefined ? 'bold' : 'normal' }">
                                1x {{ item.nome }}
                                <i v-if="item.manualPrice !== undefined" class="fas fa-tag" style="color: var(--warning-color);"></i>
                            </span>
                            <div class="item-mods" v-if="item.modifiers && item.modifiers.length > 0">
                                Extras: {{ item.modifiers.map(m => m.nome).join(', ') }}
                            </div>
                            <div class="item-mods" v-else-if="item.isMeter && item.sections">
                                Gusti: {{ item.sections.map(s => s.gusto || 'N/D').join(' / ') }}
                            </div>
                            <div class="item-mods" v-else-if="item.isHalfPizza">
                                Metà: ({{ item.gusto1 || 'N/D' }}) / ({{ item.gusto2 || 'N/D' }})
                            </div>
                        </div>

                        <span style="font-weight: bold;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                        
                        <button class="price-edit-btn" title="Modifica Prezzo" @click.stop="openPriceEditModal(index)">
                             <i class="fas fa-pencil-alt"></i>
                        </button>
                        
                        <button class="cart-remove-btn" @click.stop="removeItem(index)">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                </div>

                <div v-if="editingOrderId" class="cart-summary" style="color: var(--danger-color); font-size: 1rem;">
                     <button class="btn-danger" @click="cancelEdit">
                          <i class="fas fa-ban"></i> Annulla Modifica
                     </button>
                </div>
                
                <div class="cart-summary">
                    Totale: <span>€{{ calculatedOrderTotal.toFixed(2) }}</span>
                </div>
                
                <button class="finalize-btn" @click="openModal" :disabled="order.length === 0">
                    <i class="fas fa-clipboard-check"></i> Finalizza Ordine
                </button>
            </div>
        </section>

        <section class="orders-list-view" v-if="userRole && view === 'ordini'">
            
            <div class="orders-header">
                 <h2>Ordini Attivi ({{ filteredActiveOrders.length }})</h2>
                 <div class="filters">
                      <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per nome/tavolo/fattorino...">
                      <select v-model="activeDateFilter">
                           <option value="today">Oggi</option>
                           <option value="tomorrow">Domani</option>
                           <option value="future">Futuri</option>
                      </select>
                 </div>
            </div>
            
            <div class="order-card-grid">
                <div v-for="order in filteredActiveOrders" :key="order.id" 
                     class="order-card" :class="{ 'urgent': isUrgent(order), 'near': isNear(order) }">
                    
                    <div class="order-header">
                        <h3>Ordine #{{ order.id.substring(0, 4) }} ({{ order.mode.toUpperCase() }})</h3>
                        <span class="status-tag" :class="`status-${order.status.toLowerCase().replace(/ /g, '-')}`">
                             {{ order.status }}
                        </span>
                    </div>

                    <div class="order-details">
                        <p><strong>Ora:</strong> {{ order.hour }}</p>
                        <p v-if="order.mode === 'banco'"><strong>Tavolo:</strong> {{ order.tableNumber || 'N/D' }}</p>
                        <p v-else-if="order.mode === 'asporto'"><strong>Cliente:</strong> {{ order.customer || 'N/D' }} ({{ order.phone || 'N/D' }})</p>
                        <p v-else-if="order.mode === 'consegna'">
                            <strong>Indirizzo:</strong> {{ order.address }} {{ order.streetNumber }} ({{ order.zone }})
                        </p>
                        <p v-if="order.notes"><strong>Note:</strong> <i style="color: var(--danger-color);">{{ order.notes }}</i></p>
                    </div>

                    <ul class="order-items-list">
                        <li v-for="item in order.items" :key="item.id">
                            {{ item.nome }} <span v-if="item.isMeter"> (Metro)</span> <span v-else-if="item.isHalfPizza"> (Metà)</span>
                            <span v-if="item.manualPrice"> (MANUALE)</span>
                        </li>
                    </ul>

                    <div v-if="order.mode === 'consegna'">
                        <div class="driver-select-container">
                             <label for="driver-{{ order.id }}">Fattorino:</label>
                             <select :id="'driver-' + order.id" 
                                     :value="order.driver"
                                     @change="updateActiveOrderDriver(order.id, $event.target.value)">
                                  <option value="">(Non Assegnato)</option>
                                  <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver }}</option>
                             </select>
                        </div>
                    </div>

                    <div class="order-footer">
                        <span class="total">€{{ order.total.toFixed(2) }}</span>
                        <div style="display: flex; gap: 5px;">
                            <button class="status-btn" style="background-color: var(--secondary-color);" title="Modifica" @click="editOrder(order.id)">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="status-btn" style="background-color: #2c3e50;" title="Stampa Comanda" @click="printOrder(order.id, 'comanda')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="status-btn" style="background-color: #7f8c8d;" title="Stampa Scontrino" @click="printOrder(order.id, 'scontrino')">
                                <i class="fas fa-receipt"></i>
                            </button>
                            <button class="status-btn" style="background-color: #27ae60;" title="Condividi" v-if="order.phone" @click="showShareMenu(order.id)">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="status-btn" :class="`status-${getNextStatus(order.status).toLowerCase().replace(/ /g, '-')}`" @click="advance(order)">
                                {{ getNextStatus(order.status) }} <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="archive-view" v-if="userRole && view === 'archivio'">
            
            <div class="archive-controls">
                
                <div class="archive-stats">
                    <h3>Filtro Data: {{ archiveDateFilterDisplay }}</h3>
                    <div class="form-group">
                         <label for="archive-date">Seleziona Data</label>
                         <input type="date" id="archive-date" v-model="archiveDateFilter" @change="calculateDriverStats">
                    </div>
                    <p><strong>Totale Giornaliero:</strong> <span style="font-size: 1.2rem; color: var(--success-color);">€{{ dailyTotal.toFixed(2) }}</span></p>
                </div>
                
                <div class="archive-filter">
                    <h3>Statistiche Fattorini (Consegne)</h3>
                    <div class="form-group">
                         <label for="driver-stats-filter">Filtra per Fattorino</label>
                         <select id="driver-stats-filter" v-model="selectedDriver" @change="calculateDriverStats">
                             <option value="">Tutti i Fattorini</option>
                             <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver }}</option>
                         </select>
                    </div>
                    <p>Ordini Consegnati: <strong>{{ driverStats.totalOrders }}</strong></p>
                    <p>Ricavo (solo consegne): <strong>€{{ driverStats.totalRevenue.toFixed(2) }}</strong></p>
                </div>
            </div>
            
            <div class="archive-table-container">
                <table class="archive-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tipo</th>
                            <th>Ora Ritiro</th>
                            <th>Dettagli Cliente</th>
                            <th>Articoli</th>
                            <th>Fattorino</th>
                            <th class="total-column">Totale</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="order in filteredArchive" :key="order.id">
                            <td>#{{ order.id.substring(0, 4) }}</td>
                            <td>{{ order.mode.toUpperCase() }}</td>
                            <td>{{ order.hour }}</td>
                            <td>
                                <span v-if="order.mode === 'banco'">Tavolo: {{ order.tableNumber || 'N/D' }}</span>
                                <span v-else-if="order.mode === 'asporto'">{{ order.customer || 'N/D' }} ({{ order.phone || 'N/D' }})</span>
                                <span v-else-if="order.mode === 'consegna'">{{ order.address }} ({{ order.zone }})</span>
                            </td>
                            <td>{{ order.items.length }} Articoli</td>
                            <td>
                                <span v-if="order.mode === 'consegna'">
                                    <select :value="order.driver" @change="updateArchiveDriver(order.id, $event.target.value)">
                                        <option value="">(N/A)</option>
                                        <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver }}</option>
                                    </select>
                                </span>
                                <span v-else>--</span>
                            </td>
                            <td class="total-column">€{{ order.total.toFixed(2) }}</td>
                            <td>
                                <button title="Stampa Scontrino" @click="printOrder(order.id, 'scontrino')" class="settings-actions btn-success" style="padding: 5px;"><i class="fas fa-receipt"></i></button>
                                <button title="Duplica Ordine" @click="duplicateOrder(order)" class="settings-actions btn-primary" style="padding: 5px;"><i class="fas fa-copy"></i></button>
                            </td>
                        </tr>
                        <tr v-if="filteredArchive.length === 0">
                             <td colspan="8" style="text-align: center; color: #999;">Nessun ordine archiviato per questa data.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="settings-view" v-if="userRole === 'PROPRIETARIO' && view === 'settings'">
            
            <div class="settings-sidebar">
                <button :class="{ active: activeSettingsCat === 'Menu' }" @click="activeSettingsCat = 'Menu'">
                    <i class="fas fa-pizza-slice"></i> Menu Articoli
                </button>
                <button :class="{ active: activeSettingsCat === 'Modificatori' }" @click="activeSettingsCat = 'Modificatori'">
                    <i class="fas fa-plus-circle"></i> Modificatori
                </button>
                <button :class="{ active: activeSettingsCat === 'Consegna' }" @click="activeSettingsCat = 'Consegna'">
                    <i class="fas fa-truck"></i> Zone & Fattorini
                </button>
                <button :class="{ active: activeSettingsCat === 'Capacita' }" @click="activeSettingsCat = 'Capacita'">
                    <i class="fas fa-tachometer-alt"></i> Capacità
                </button>
                <button :class="{ active: activeSettingsCat === 'Accesso' }" @click="activeSettingsCat = 'Accesso'">
                    <i class="fas fa-lock"></i> Accesso/PIN
                </button>
                <button :class="{ active: activeSettingsCat === 'Backup' }" @click="activeSettingsCat = 'Backup'">
                    <i class="fas fa-database"></i> Gestione Dati
                </button>
            </div>

            <div class="settings-content">
                
                <div class="settings-section" v-if="activeSettingsCat === 'Menu'">
                    <h2>Gestione Menu Articoli</h2>
                    
                    <div class="settings-form" style="border-bottom: 1px dashed #eee; padding-bottom: 10px;">
                        <div class="form-group" style="flex: 2;">
                            <label>Nome Nuova Categoria</label>
                            <input type="text" v-model="newCategoryName" placeholder="Es: Dolci">
                        </div>
                        <button class="settings-actions btn-primary" @click="addCategory" style="flex: 0.5;">Aggiungi Categoria</button>
                    </div>

                    <div class="menu-categories" style="margin-top: 15px;">
                        <button v-for="(items, category) in menu" :key="category" 
                                class="cat-btn" :class="{ active: activeSettingsCat === category }" 
                                @click="activeSettingsCat = category">
                            {{ category }}
                        </button>
                    </div>

                    <div v-if="activeSettingsCat in menu">
                        <h3 style="margin-top: 20px; color: var(--secondary-color);">Articoli in "{{ activeSettingsCat }}"</h3>
                        
                        <div class="settings-form">
                            <div class="form-group" style="flex: 3;">
                                <label>Nome Articolo</label>
                                <input type="text" v-model="newItemName" placeholder="Nome Articolo">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Prezzo (€)</label>
                                <input type="number" step="0.01" v-model="newItemPrice">
                            </div>
                            <button class="settings-actions btn-success" @click="addItemToCategory" style="flex: 0.8;">Aggiungi Articolo</button>
                        </div>

                        <ul class="settings-list">
                            <li v-for="(item, index) in menu[activeSettingsCat]" :key="index">
                                <div class="item-info">
                                    <strong>{{ item.nome }}</strong> - €{{ item.prezzo.toFixed(2) }}
                                    <span v-if="item.isFinished" style="color: var(--danger-color); font-weight: bold;">[ESAURITO]</span>
                                    <span v-if="item.isMeter" style="color: var(--secondary-color); font-size: 0.8rem;">[METRO]</span>
                                    <span v-if="item.isHalfPizza" style="color: var(--secondary-color); font-size: 0.8rem;">[METÀ]</span>
                                </div>
                                <div class="settings-actions">
                                    <button :class="{ 'btn-danger': !item.isFinished, 'btn-warning': item.isFinished }" @click="toggleItemFinished(activeSettingsCat, index)">
                                        <i class="fas" :class="{ 'fa-ban': !item.isFinished, 'fa-check': item.isFinished }"></i> 
                                        {{ item.isFinished ? 'Disponibile' : 'Esaurito' }}
                                    </button>
                                    <button class="btn-danger" @click="deleteItem(activeSettingsCat, index)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                        
                        <button v-if="activeSettingsCat !== 'Pizze'" class="settings-actions btn-danger" style="margin-top: 20px;" @click="deleteCategory(activeSettingsCat)">
                            <i class="fas fa-trash-alt"></i> Elimina Categoria "{{ activeSettingsCat }}"
                        </button>
                    </div>
                </div>

                <div class="settings-section" v-else-if="activeSettingsCat === 'Modificatori'">
                    <h2>Gestione Modificatori/Extra</h2>
                    
                    <div class="settings-form" style="border-bottom: 1px dashed #eee; padding-bottom: 10px;">
                        <div class="form-group" style="flex: 2;">
                            <label>Nome Nuova Categoria Modificatore</label>
                            <input type="text" v-model="newModifierCategoryName" placeholder="Es: Salse Speciali">
                        </div>
                        <button class="settings-actions btn-primary" @click="addModifierCategory" style="flex: 0.5;">Aggiungi Categoria</button>
                    </div>

                    <div class="menu-categories" style="margin-top: 15px;">
                        <button v-for="(mods, category) in modifiers" :key="category" 
                                class="cat-btn" :class="{ active: activeSettingsModCat === category }" 
                                @click="activeSettingsModCat = category">
                            {{ category }}
                        </button>
                    </div>

                    <div v-if="activeSettingsModCat in modifiers">
                        <h3 style="margin-top: 20px; color: var(--secondary-color);">Modificatori in "{{ activeSettingsModCat }}"</h3>

                        <div class="settings-form">
                            <div class="form-group" style="flex: 3;">
                                <label>Nome Modificatore</label>
                                <input type="text" v-model="newModifierName" placeholder="Nome Modificatore">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Prezzo Agg. (€)</label>
                                <input type="number" step="0.01" v-model="newModifierPrice">
                            </div>
                            <button class="settings-actions btn-success" @click="addModifierToCategory" style="flex: 0.8;">Aggiungi Modificatore</button>
                        </div>

                        <ul class="settings-list">
                            <li v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index">
                                <div class="item-info">
                                    <strong>{{ mod.nome }}</strong> <span v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                                    <span v-if="mod.isFinished" style="color: var(--danger-color); font-weight: bold;">[ESAURITO]</span>
                                </div>
                                <div class="settings-actions">
                                    <button :class="{ 'btn-danger': !mod.isFinished, 'btn-warning': mod.isFinished }" @click="toggleModifierFinished(activeSettingsModCat, index)">
                                        <i class="fas" :class="{ 'fa-ban': !mod.isFinished, 'fa-check': mod.isFinished }"></i> 
                                        {{ mod.isFinished ? 'Disponibile' : 'Esaurito' }}
                                    </button>
                                    <button class="btn-danger" @click="deleteModifier(activeSettingsModCat, index)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                        
                        <button v-if="!isDefaultModifierCategory(activeSettingsModCat)" class="settings-actions btn-danger" style="margin-top: 20px;" @click="deleteModifierCategory(activeSettingsModCat)">
                            <i class="fas fa-trash-alt"></i> Elimina Categoria Modificatore "{{ activeSettingsModCat }}"
                        </button>
                    </div>
                </div>
                
                <div class="settings-section" v-else-if="activeSettingsCat === 'Consegna'">
                    <h2>Zone di Consegna e Costi</h2>
                    
                    <div class="settings-form">
                        <div class="form-group" style="flex: 2;">
                            <label>Nome Zona</label>
                            <input type="text" v-model="newZoneName" placeholder="Es: Centro">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Costo Consegna (€)</label>
                            <input type="number" step="0.50" v-model="newZonePrice">
                        </div>
                        <button class="settings-actions btn-primary" @click="addZone" style="flex: 0.8;">Aggiungi Zona</button>
                    </div>
                    
                    <ul class="settings-list">
                        <li v-for="(zone, index) in deliveryZones" :key="index">
                            <div class="item-info">
                                <strong>{{ zone.name }}</strong> - €{{ zone.price.toFixed(2) }}
                            </div>
                            <div class="settings-actions">
                                <button class="btn-danger" @click="deleteZone(index)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    </ul>

                    <h2 style="margin-top: 30px;">Gestione Fattorini</h2>
                    
                    <div class="settings-form">
                        <div class="form-group" style="flex: 2;">
                            <label>Nome Fattorino</label>
                            <input type="text" v-model="newDriverName" placeholder="Es: Marco Rossi">
                        </div>
                        <button class="settings-actions btn-primary" @click="addDriver" style="flex: 0.8;">Aggiungi Fattorino</button>
                    </div>
                    
                    <ul class="settings-list">
                        <li v-for="(driver, index) in drivers" :key="index">
                            <strong>{{ driver }}</strong>
                            <div class="settings-actions">
                                <button class="btn-danger" @click="deleteDriver(index)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="settings-section" v-else-if="activeSettingsCat === 'Capacita'">
                    <h2>Gestione Capacità Forno</h2>
                    <p style="margin-bottom: 15px;">Imposta il numero massimo di pizze che puoi preparare in un dato intervallo di tempo. Questo attiva un **avviso** al momento della finalizzazione dell'ordine.</p>

                    <div class="capacity-settings">
                        <div class="form-row">
                             <div class="form-group">
                                 <label>Pizze Massime per Intervallo</label>
                                 <input type="number" min="1" v-model.number="capacitySettings.maxPizzas" @change="saveDataAll">
                             </div>
                             <div class="form-group">
                                 <label>Durata Intervallo (minuti)</label>
                                 <select v-model.number="capacitySettings.intervalMinutes" @change="saveDataAll">
                                      <option value="15">15 minuti</option>
                                      <option value="20">20 minuti</option>
                                      <option value="30">30 minuti</option>
                                      <option value="45">45 minuti</option>
                                      <option value="60">60 minuti</option>
                                 </select>
                             </div>
                        </div>
                        <p style="margin-top: 15px; font-style: italic; color: var(--secondary-color);">
                            Attualmente, l'avviso verrà mostrato se l'ordine corrente supera le {{ capacitySettings.maxPizzas }} pizze in un intervallo di {{ capacitySettings.intervalMinutes }} minuti.
                        </p>
                    </div>
                </div>

                <div class="settings-section" v-else-if="activeSettingsCat === 'Accesso'">
                    <h2>Gestione PIN di Accesso</h2>
                    <p style="margin-bottom: 15px;">Cambia i PIN per l'accesso. Il PIN Proprietario ha accesso a questa sezione.</p>

                    <div class="pin-settings">
                        <div class="pin-box">
                             <h3>PIN Operatore</h3>
                             <div class="form-group">
                                 <label>Nuovo PIN Operatore</label>
                                 <input type="password" v-model="newAdminPin" maxlength="4" placeholder="Minimo 4 cifre">
                             </div>
                             <button class="settings-actions btn-success" @click="saveAdminPin">Salva PIN Operatore</button>
                        </div>

                        <div class="pin-box">
                             <h3>PIN Proprietario</h3>
                             <div class="form-group">
                                 <label>Nuovo PIN Proprietario</label>
                                 <input type="password" v-model="newOwnerPin" maxlength="4" placeholder="Minimo 4 cifre">
                             </div>
                             <button class="settings-actions btn-success" @click="saveOwnerPin">Salva PIN Proprietario</button>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section" v-else-if="activeSettingsCat === 'Backup'">
                    <h2>Gestione Dati e Backup</h2>
                    <p style="margin-bottom: 20px;">Esegui il backup o ripristina i dati completi (Menu, Ordini, Storico, Impostazioni).</p>

                    <div class="backup-settings">
                        <button class="settings-actions btn-primary" @click="exportData">
                             <i class="fas fa-download"></i> Esporta Dati Completi (JSON)
                        </button>
                        <button class="settings-actions btn-warning" @click="importData">
                             <i class="fas fa-upload"></i> Importa Dati Completi (JSON)
                        </button>
                        <button class="settings-actions btn-danger" @click="clearCache">
                             <i class="fas fa-trash-alt"></i> Pulisci Ordini/Storico
                        </button>
                    </div>
                    <p style="margin-top: 20px; font-size: 0.8rem; color: #7f8c8d;">
                        Nota: L'importazione sovrascrive tutti i dati. La pulizia mantiene menu e impostazioni.
                    </p>
                </div>
                
            </div>
        </section>

    </main>

    <div class="modal-overlay" v-if="showModal" @click.self="showModal = false">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Finalizza Ordine</h2>
                <button class="modal-close-btn" @click="showModal = false"><i class="fas fa-times"></i></button>
            </div>
            
            <div v-if="isCapacityFull" class="capacity-warning full">
                 <i class="fas fa-exclamation-triangle"></i> ATTENZIONE: Capacità Forno Piena per quest'ora! ({{ orderCapacity.total }}/{{ orderCapacity.max }})
            </div>
            <div v-else-if="isCapacityWarning" class="capacity-warning near">
                 <i class="fas fa-exclamation-triangle"></i> ATTENZIONE: Capacità Forno Quasi Piena per quest'ora! ({{ orderCapacity.total }}/{{ orderCapacity.max }})
            </div>

            <div class="modal-mode-tabs">
                <div v-for="m in modes" :key="m.id" 
                     class="mode-tab" :class="{ active: mode === m.id }" 
                     @click="selectMode(m.id)">
                    <i :class="m.icon"></i> {{ m.label }}
                </div>
            </div>

            <div class="form-row">
                 <div class="form-group">
                     <label>Data Ritiro/Consegna</label>
                     <input type="date" v-model="date" :min="minDate" @change="updateCapacityWarning">
                 </div>
                 <div class="form-group">
                     <label>Ora Ritiro/Consegna</label>
                     <input type="time" v-model="hour" @change="updateCapacityWarning">
                 </div>
            </div>

            <div v-if="mode === 'banco'">
                <div class="form-group">
                    <label>Numero Tavolo/Nome Banco</label>
                    <input type="text" v-model="tableNumber" placeholder="Es: Tavolo 5 o Mario">
                </div>
            </div>

            <div v-if="mode === 'asporto' || mode === 'consegna'">
                <div class="form-group" style="position: relative;">
                    <label>Nome Cliente</label>
                    <input type="text" v-model="customer" @input="filterCustomers" placeholder="Nome/Cognome Cliente">
                    <ul class="customer-autocomplete-list" v-if="filteredCustomerSuggestions.length > 0">
                        <li v-for="(data, index) in filteredCustomerSuggestions" :key="index" @click="loadCustomerData(data)">
                             {{ data.customer }} - {{ data.phone || data.address || '' }}
                        </li>
                    </ul>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" v-model="phone" placeholder="Numero di telefono">
                    </div>
                    <div class="form-group" v-if="mode === 'asporto'">
                        <label>Numero Ritiro/Nome Tavolo</label>
                        <input type="text" v-model="tableNumber" placeholder="Es: N. 10 o Mario">
                    </div>
                </div>
            </div>

            <div v-if="mode === 'consegna'">
                <div class="form-group">
                     <label>Zona di Consegna</label>
                     <select v-model="zoneName" @change="updateDeliveryCost">
                         <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">
                             {{ zone.name }} (€{{ zone.price.toFixed(2) }})
                         </option>
                     </select>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label>Indirizzo (Via/Piazza)</label>
                        <input type="text" v-model="address" placeholder="Es: Via Roma">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Civico</label>
                        <input type="text" v-model="streetNumber" placeholder="Es: 10A">
                    </div>
                </div>
                 <div class="form-group">
                    <label>Città/Paese</label>
                    <input type="text" v-model="town" placeholder="Es: Napoli">
                </div>
            </div>

            <div class="form-group">
                <label>Note per la Comanda/Cucina</label>
                <textarea v-model="notes" rows="2" placeholder="Es: Tutto l'ordine senza cipolla..."></textarea>
            </div>
            
            <div class="form-row">
                 <div class="form-group" style="flex: 2;">
                     <label>Acconto Ricevuto (Contante)</label>
                     <input type="number" step="0.01" v-model.number="accontoRicevuto" placeholder="0.00">
                 </div>
                 <div class="form-group" style="flex: 1; display: flex; align-items: flex-end; justify-content: flex-end;">
                     <p v-if="restoDaDare > 0" class="resto-da-dare">
                          <i class="fas fa-money-bill-wave"></i> Resto: €{{ restoDaDare.toFixed(2) }}
                     </p>
                 </div>
            </div>

            <div class="modal-summary">
                Totale Ordine: <span>€{{ total.toFixed(2) }}</span>
            </div>
            <div v-if="mode === 'consegna'" class="modal-summary-item">
                 Subtotale Articoli: <span>€{{ calculatedOrderTotal.toFixed(2) }}</span>
            </div>
            <div v-if="mode === 'consegna'" class="modal-summary-item">
                 Costo Consegna: <span>+€{{ deliveryCost.toFixed(2) }}</span>
            </div>

            <button class="finalize-btn" @click="confermaOrdine">
                 <i class="fas fa-save"></i> Salva e Metti in Coda
            </button>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showPriceEditModal" @click.self="showPriceEditModal = false">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Modifica Prezzo Manuale</h2>
                <button class="modal-close-btn" @click="showPriceEditModal = false"><i class="fas fa-times"></i></button>
            </div>
            <p style="margin-bottom: 15px;">Imposta un prezzo fisso per l'articolo **{{ order[tempPriceEditIndex] ? order[tempPriceEditIndex].nome : '' }}**.</p>
            <div class="form-group">
                <label>Nuovo Prezzo (€)</label>
                <input type="number" step="0.01" v-model.number="newPriceValue" placeholder="0.00">
            </div>
            <button class="finalize-btn" @click="saveNewPrice">
                 <i class="fas fa-save"></i> Applica Prezzo Manuale
            </button>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showShareModal" @click.self="showShareModal = false">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2>Condividi Ordine</h2>
                <button class="modal-close-btn" @click="showShareModal = false"><i class="fas fa-times"></i></button>
            </div>
            <p v-if="selectedOrderForShare">Invio dettagli Ordine **#{{ selectedOrderForShare.id.substring(0, 4) }}** al numero **{{ selectedOrderForShare.phone }}**.</p>
            <button class="finalize-btn" style="background-color: #25d366; margin-top: 15px;" @click="shareViaWhatsapp(selectedOrderForShare)">
                 <i class="fab fa-whatsapp"></i> Invia su WhatsApp
            </button>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showMeterModal" @click.self="cancelMeterComposition">
        <div class="modal-content composition-modal-content" style="max-width: 900px;">
            <div class="composition-menu">
                <h2>Composizione {{ lastSelectedItem.nome }}</h2>
                
                <div class="meter-sections">
                     <div v-for="(section, index) in tempMeterItem.sections" :key="index"
                          class="meter-section-tab" :class="{ active: section.activeSection }"
                          @click="tempMeterItem.sections.forEach(s => s.activeSection = false); section.activeSection = true; tempModCat = 'Standard'">
                          {{ section.name }}
                     </div>
                </div>

                <div v-for="(section, secIdx) in tempMeterItem.sections" :key="secIdx" v-if="section.activeSection">
                    
                    <h3 style="margin-bottom: 10px; color: var(--primary-color);">Gusto Base ({{ section.name }})</h3>
                    <div class="composition-gusto-picker" @click="section.showGustoDropdown = !section.showGustoDropdown">
                         {{ section.gusto || 'SELEZIONA GUSTO BASE' }} <i class="fas fa-caret-down"></i>
                         <div class="composition-gusto-dropdown" v-if="section.showGustoDropdown">
                              <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto..." class="search-bar" style="border: none;">
                              <ul style="list-style: none; padding: 0;">
                                   <li v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @click.stop="selectMeterGusto(secIdx, pizza.nome)">
                                        {{ pizza.nome }}
                                   </li>
                              </ul>
                         </div>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-color);">Modificatori (Aggiuntivi)</h3>
                    <div class="menu-categories modifier-categories">
                        <button v-for="(mods, category) in modifiers" :key="category" 
                                class="cat-btn" :class="{ active: tempModCat === category }" 
                                @click="tempModCat = category; modifierSearchTerm = ''">
                            {{ category }}
                        </button>
                    </div>
                    
                    <div class="modifier-grid">
                        <button v-for="(mod, index) in filteredTempModifiers" :key="index"
                                class="grid-item" :class="{ 
                                    'finished': mod.isFinished,
                                    'active-mod': section.modifiers && section.modifiers.some(m => m.nome === mod.nome)
                                }" 
                                @click="addMeterModifier(secIdx, mod)">
                            {{ getModifierIcon(tempModCat) }} <strong>{{ mod.nome }}</strong>
                            <br><span v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                            <span v-else>&nbsp;</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="composition-details">
                <h3 style="border-bottom: 1px dashed #ccc; padding-bottom: 10px;">Riepilogo Composizione</h3>
                <p><strong>Articolo Base:</strong> {{ lastSelectedItem.nome }} (€{{ lastSelectedItem.prezzo.toFixed(2) }})</p>
                
                <ul style="list-style: none; padding-left: 0; margin-top: 15px;">
                     <li v-for="(section, index) in tempMeterItem.sections" :key="index" style="margin-bottom: 10px; border-left: 3px solid var(--secondary-color); padding-left: 10px;">
                          <strong>{{ section.name }}:</strong> {{ section.gusto || 'Gusto Non Selezionato' }}
                          <ul v-if="section.modifiers && section.modifiers.length > 0" style="list-style: disc; padding-left: 20px; font-size: 0.9rem; color: #666;">
                               <li v-for="(mod, modIdx) in section.modifiers" :key="modIdx">
                                    {{ mod.nome }} 
                                    <span v-if="mod.prezzo > 0"> (+€{{ mod.prezzo.toFixed(2) }})</span>
                                    <button class="cart-remove-btn" @click="removeMeterModifier(index, modIdx)" style="font-size: 0.8rem;"><i class="fas fa-times"></i></button>
                               </li>
                          </ul>
                     </li>
                </ul>

                <div class="modal-summary" style="margin-top: 20px;">
                    Totale Stimato: <span>€{{ calculateTempMeterTotal.toFixed(2) }}</span>
                </div>
                
                <button class="finalize-btn" @click="addMeterToOrder" :disabled="!isMeterValid">
                     <i class="fas fa-check"></i> Aggiungi a Ordine
                </button>
                <button class="btn-danger finalize-btn" style="background-color: #95a5a6;" @click="cancelMeterComposition">
                     <i class="fas fa-ban"></i> Annulla
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showHalfPizzaModal" @click.self="cancelHalfPizzaComposition">
        <div class="modal-content composition-modal-content" style="max-width: 800px; grid-template-columns: 1fr;">
            <h2 style="text-align: center;">Composizione Pizza a Metà ({{ lastSelectedItem.nome }})</h2>
            
            <div class="half-pizza-tabs">
                 <div class="half-pizza-tab" :class="{ active: tempHalfPizzaItem.activeHalf === 1 }" @click="tempHalfPizzaItem.activeHalf = 1; tempModCat = 'Standard'">
                     <i class="fas fa-divide"></i> Metà 1
                 </div>
                 <div class="half-pizza-tab" :class="{ active: tempHalfPizzaItem.activeHalf === 2 }" @click="tempHalfPizzaItem.activeHalf = 2; tempModCat = 'Standard'">
                     <i class="fas fa-divide"></i> Metà 2
                 </div>
            </div>
            
            <div class="composition-details" v-if="tempHalfPizzaItem">
                
                <h3 style="margin-bottom: 10px; color: var(--primary-color);">Gusto Base</h3>
                <div class="form-row">
                    <div class="form-group" style="flex: 1; position: relative;">
                        <div class="composition-gusto-picker" @click="tempHalfPizzaItem.showGustoDropdown1 = !tempHalfPizzaItem.showGustoDropdown1" v-if="tempHalfPizzaItem.activeHalf === 1">
                             {{ tempHalfPizzaItem.gusto1 || 'SELEZIONA GUSTO PER METÀ 1' }} <i class="fas fa-caret-down"></i>
                             <div class="composition-gusto-dropdown" v-if="tempHalfPizzaItem.showGustoDropdown1">
                                  <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto..." class="search-bar" style="border: none;">
                                  <ul style="list-style: none; padding: 0;">
                                       <li v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @click.stop="selectHalfPizzaGusto(1, pizza.nome)">
                                            {{ pizza.nome }}
                                       </li>
                                  </ul>
                             </div>
                        </div>
                        <div class="composition-gusto-picker" @click="tempHalfPizzaItem.showGustoDropdown2 = !tempHalfPizzaItem.showGustoDropdown2" v-if="tempHalfPizzaItem.activeHalf === 2">
                             {{ tempHalfPizzaItem.gusto2 || 'SELEZIONA GUSTO PER METÀ 2' }} <i class="fas fa-caret-down"></i>
                             <div class="composition-gusto-dropdown" v-if="tempHalfPizzaItem.showGustoDropdown2">
                                  <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto..." class="search-bar" style="border: none;">
                                  <ul style="list-style: none; padding: 0;">
                                       <li v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @click.stop="selectHalfPizzaGusto(2, pizza.nome)">
                                            {{ pizza.nome }}
                                       </li>
                                  </ul>
                             </div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 10px; color: var(--primary-color);">Modificatori (Extra)</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">*Nota: I modificatori aggiuntivi su una metà vengono conteggiati al 50% del loro costo.</p>
                
                <div class="menu-categories modifier-categories">
                    <button v-for="(mods, category) in modifiers" :key="category" 
                            class="cat-btn" :class="{ active: tempModCat === category }" 
                            @click="tempModCat = category; modifierSearchTerm = ''">
                        {{ category }}
                    </button>
                </div>
                
                <div class="modifier-grid" style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    <button v-for="(mod, index) in filteredTempModifiers" :key="index"
                            class="grid-item" :class="{ 
                                'finished': mod.isFinished,
                                'active-mod': (tempHalfPizzaItem.activeHalf === 1 && tempHalfPizzaItem.modifiers1.some(m => m.nome === mod.nome)) || 
                                              (tempHalfPizzaItem.activeHalf === 2 && tempHalfPizzaItem.modifiers2.some(m => m.nome === mod.nome))
                            }" 
                            @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)">
                        {{ getModifierIcon(tempModCat) }} <strong>{{ mod.nome }}</strong>
                        <br><span v-if="mod.prezzo > 0">+€{{ (mod.prezzo * 0.5).toFixed(2) }} (metà)</span>
                        <span v-else>&nbsp;</span>
                    </button>
                </div>
                
                <div class="half-pizza-details">
                    <h4 style="margin-bottom: 5px;">Riepilogo Metà {{ tempHalfPizzaItem.activeHalf }}:</h4>
                    <p>Gusto: <strong>{{ tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.gusto1 : tempHalfPizzaItem.gusto2 || 'Non Selezionato' }}</strong></p>
                    <p>Modificatori: 
                        <span v-if="(tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.modifiers1 : tempHalfPizzaItem.modifiers2).length > 0">
                             {{ (tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.modifiers1 : tempHalfPizzaItem.modifiers2).map(m => m.nome).join(', ') }}
                        </span>
                        <span v-else>Nessuno</span>
                    </p>
                </div>
                
            </div>
            
            <div class="modal-summary" style="margin-top: 20px;">
                Totale Stimato: <span>€{{ calculateTempHalfPizzaTotal.toFixed(2) }}</span>
            </div>
            
            <button class="finalize-btn" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid">
                 <i class="fas fa-check"></i> Aggiungi a Ordine
            </button>
            <button class="btn-danger finalize-btn" style="background-color: #95a5a6;" @click="cancelHalfPizzaComposition">
                 <i class="fas fa-ban"></i> Annulla
            </button>
        </div>
    </div>

    <div id="print-area" style="display: none;">
        <div id="print-content-comanda"></div>
        <div id="print-content-scontrino"></div>
    </div>
    <script>
        const STORAGE_KEY = 'pizzeria_pos_data_v2';

        // --- Funzioni di Utility ---
        function generateUniqueId() {
            return Math.random().toString(36).substring(2, 9);
        }

        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function getTimePlus(minutes) {
             const now = new Date();
             now.setMinutes(now.getMinutes() + minutes);
             const hours = String(now.getHours()).padStart(2, '0');
             const mins = String(now.getMinutes()).padStart(2, '0');
             return `${hours}:${mins}`;
        }

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                try {
                    return JSON.parse(storedData);
                } catch (e) {
                    console.error("Errore nel parsing dei dati da localStorage", e);
                    return {};
                }
            }
            return {};
        }

        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // Dati di Default (usati se non c'è nulla in localStorage)
        const defaultData = {
            menu: {
                'Pizze': [
                    { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                    { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                    { nome: 'Quattro Formaggi', prezzo: 8.00, isFinished: false },
                    { nome: 'Mezzo Metro', prezzo: 20.00, isFinished: false, isMeter: true },
                    { nome: 'Pizza a Metà', prezzo: 9.00, isFinished: false, isHalfPizza: true }
                ],
                'Bibite': [
                    { nome: 'Acqua Nat. 1L', prezzo: 2.00, isFinished: false },
                    { nome: 'Coca Cola 33cl', prezzo: 2.50, isFinished: false }
                ],
                'Dolci': [
                    { nome: 'Tiramisù', prezzo: 4.00, isFinished: false }
                ]
            },
            modifiers: {
                'Standard': [
                    { nome: 'Bufala', prezzo: 2.50, isFinished: false },
                    { nome: 'Salsiccia', prezzo: 2.00, isFinished: false },
                    { nome: 'Extra Pomodoro', prezzo: 0.50, isFinished: false }
                ],
                'Cottura': [
                    { nome: 'Ben Cotta', prezzo: 0.00, isFinished: false },
                    { nome: 'Poco Cotta', prezzo: 0.00, isFinished: false }
                ]
            },
            deliveryZones: [
                { name: 'Zona A (Vicino)', price: 1.50 },
                { name: 'Zona B (Lontano)', price: 3.00 }
            ],
            drivers: ['Andrea', 'Chiara', 'Luca'],
            accessPins: {
                 OPERATORE: '0000',
                 PROPRIETARIO: '1111'
            },
            capacitySettings: {
                 maxPizzas: 30,
                 intervalMinutes: 30
            },
            activeOrders: [],
            archiveOrders: [],
            customerRegistry: [] // Registro per l'autocomplete dei clienti
        };

        // Carica i dati salvati e fonde con i default (per non perdere le chiavi nuove)
        const stored = loadData();
        const initialData = { 
            ...defaultData, 
            ...stored,
            // Assicurati che le sezioni chiave siano sempre caricate correttamente
            menu: stored.menu ? { ...defaultData.menu, ...stored.menu } : defaultData.menu,
            modifiers: stored.modifiers ? { ...defaultData.modifiers, ...stored.modifiers } : defaultData.modifiers,
            accessPins: stored.accessPins ? { ...defaultData.accessPins, ...stored.accessPins } : defaultData.accessPins,
            capacitySettings: stored.capacitySettings ? { ...defaultData.capacitySettings, ...stored.capacitySettings } : defaultData.capacitySettings,
        };


        // --- App State (Petite-Vue) ---
        v = {
            // Dati Generali
            view: 'inserimento', // 'inserimento', 'ordini', 'archivio', 'settings'
            userRole: null, // 'OPERATORE', 'PROPRIETARIO', o null

            // Login
            accessPin: '',
            newAdminPin: initialData.accessPins.OPERATORE,
            newOwnerPin: initialData.accessPins.PROPRIETARIO,
            
            // Ordine Corrente (Carrello)
            order: [], // La lista di oggetti nel carrello
            selectedItemIndex: null,
            searchTerm: '',
            activeCat: 'Pizze',
            modifierSearchTerm: '',
            activeModCat: 'Standard',

            // Ordine in Modifica
            editingOrderId: null, // ID dell'ordine se si è in modalità modifica

            // Modali
            showModal: false,
            showPriceEditModal: false,
            tempPriceEditIndex: null,
            newPriceValue: 0.00,
            showShareModal: false,
            selectedOrderForShare: null,
            
            // Composizione (Mezzo Metro/Metà)
            showMeterModal: false,
            showHalfPizzaModal: false,
            lastSelectedItem: null,
            tempMeterItem: null, // Oggetto per la composizione del Mezzo Metro
            tempHalfPizzaItem: null, // Oggetto per la composizione della Pizza a Metà
            gustoSearchTerm: '',
            tempModCat: 'Standard',

            // Dati Modale Finalizzazione
            mode: 'banco', // 'banco', 'asporto', 'consegna'
            modes: [
                { id: 'banco', label: 'Tavolo/Banco', icon: 'fas fa-chair' },
                { id: 'asporto', label: 'Asporto', icon: 'fas fa-shopping-bag' },
                { id: 'consegna', label: 'Consegna', icon: 'fas fa-biking' }
            ],
            date: getTodayDateString(),
            minDate: getTodayDateString(),
            hour: getTimePlus(15), // Ora corrente + 15 minuti
            tableNumber: '',
            customer: '',
            phone: '',
            address: '',
            streetNumber: '',
            town: 'Napoli', // Default
            zoneName: initialData.deliveryZones.length > 0 ? initialData.deliveryZones[0].name : '',
            deliveryCost: initialData.deliveryZones.length > 0 ? initialData.deliveryZones[0].price : 0.00,
            notes: '',
            accontoRicevuto: 0.00,
            
            // Dati Ordini Attivi
            activeOrderSearchTerm: '',
            activeDateFilter: 'today', // 'today', 'tomorrow', 'future'

            // Dati Archivio
            archiveDateFilter: getTodayDateString(),
            selectedDriver: '',
            driverStats: { totalOrders: 0, totalRevenue: 0 },

            // Dati Impostazioni
            activeSettingsCat: 'Menu', // Categoria in Impostazioni
            activeSettingsModCat: 'Standard', // Categoria Modificatori in Impostazioni
            newItemName: '',
            newItemPrice: 0.00,
            newCategoryName: '',
            newModifierName: '',
            newModifierPrice: 0.00,
            newModifierCategoryName: '',
            newZoneName: '',
            newZonePrice: 0.00,
            newDriverName: '',

            // Dati Master (Persistenti)
            menu: initialData.menu,
            modifiers: initialData.modifiers,
            activeOrders: initialData.activeOrders,
            archiveOrders: initialData.archiveOrders,
            deliveryZones: initialData.deliveryZones,
            drivers: initialData.drivers,
            customerRegistry: initialData.customerRegistry,
            accessPins: initialData.accessPins,
            capacitySettings: initialData.capacitySettings,

            // Dati temporanei per capacità forno
            orderCapacity: { total: 0, max: 0 },
            
            // Autocomplete Clienti
            filteredCustomerSuggestions: [],
            
            // --- Computed Properties ---

            get calculatedOrderTotal() {
                return this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
            },
            
            get total() {
                let cost = this.calculatedOrderTotal;
                if (this.mode === 'consegna') {
                    cost += this.deliveryCost;
                }
                return cost;
            },

            get restoDaDare() {
                return Math.max(0, this.accontoRicevuto - this.total);
            },
            
            get filteredAvailableItems() {
                const category = this.menu[this.activeCat] || [];
                const term = this.searchTerm.toLowerCase().trim();
                
                if (!term) return category;

                return category.filter(item => 
                    item.nome.toLowerCase().includes(term)
                );
            },

            get filteredPizzaGusti() {
                 const pizze = this.menu['Pizze'] || [];
                 const term = this.gustoSearchTerm.toLowerCase().trim();
                 
                 // Filtra per pizze semplici che non siano speciali come Metà o Metro
                 const simplePizze = pizze.filter(p => !p.isMeter && !p.isHalfPizza);

                 if (!term) return simplePizze;
                 
                 return simplePizze.filter(item => 
                     item.nome.toLowerCase().includes(term)
                 );
            },

            get filteredModifiersForActiveCat() {
                const mods = this.modifiers[this.activeModCat] || [];
                const term = this.modifierSearchTerm.toLowerCase().trim();
                
                if (!term) return mods;

                return mods.filter(mod => 
                    mod.nome.toLowerCase().includes(term)
                );
            },
            
            get filteredTempModifiers() {
                 const mods = this.modifiers[this.tempModCat] || [];
                 const term = this.modifierSearchTerm.toLowerCase().trim();

                 if (!term) return mods;

                 return mods.filter(mod => 
                     mod.nome.toLowerCase().includes(term)
                 );
            },

            get filteredActiveOrders() {
                const term = this.activeOrderSearchTerm.toLowerCase().trim();
                
                let filtered = this.activeOrders.filter(order => {
                    // Filtro per data
                    const orderDate = new Date(order.date);
                    const today = new Date(getTodayDateString());
                    
                    if (this.activeDateFilter === 'today') {
                        if (orderDate.toDateString() !== today.toDateString()) return false;
                    } else if (this.activeDateFilter === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        if (orderDate.toDateString() !== tomorrow.toDateString()) return false;
                    } else if (this.activeDateFilter === 'future') {
                         const tomorrow = new Date(today);
                         tomorrow.setDate(tomorrow.getDate() + 1);
                         if (orderDate <= tomorrow) return false;
                    }
                    
                    // Filtro per termine di ricerca
                    if (!term) return true;
                    
                    return order.id.substring(0, 4).includes(term) ||
                           (order.customer && order.customer.toLowerCase().includes(term)) ||
                           (order.tableNumber && order.tableNumber.toLowerCase().includes(term)) ||
                           (order.driver && order.driver.toLowerCase().includes(term));
                });
                
                // Ordina per urgenza (prima l'ora più vicina)
                filtered.sort((a, b) => {
                     const timeA = a.date + 'T' + a.hour;
                     const timeB = b.date + 'T' + b.hour;
                     return new Date(timeA) - new Date(timeB);
                });
                
                return filtered;
            },

            get filteredArchive() {
                 const term = this.selectedDriver.toLowerCase().trim();
                 
                 // Filtra per data
                 let filtered = this.archiveOrders.filter(order => order.date === this.archiveDateFilter);
                 
                 // Filtra per fattorino (solo consegne)
                 if (term) {
                     filtered = filtered.filter(order => order.mode === 'consegna' && order.driver && order.driver.toLowerCase() === term);
                 }
                 
                 // Ordina dal più recente
                 filtered.sort((a, b) => new Date(b.date + 'T' + b.hour) - new Date(a.date + 'T' + a.hour));

                 return filtered;
            },
            
            get archiveDateFilterDisplay() {
                 const date = new Date(this.archiveDateFilter);
                 return date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' });
            },

            get availableDrivers() {
                 return this.drivers.sort();
            },
            
            get isCapacityFull() {
                 return this.orderCapacity.total > this.orderCapacity.max;
            },

            get isCapacityWarning() {
                 const ratio = this.orderCapacity.total / this.orderCapacity.max;
                 return ratio > 0.85 && ratio <= 1; // Avviso se siamo sopra l'85% ma non pieni
            },
            
            get calculateTempMeterTotal() {
                 if (!this.tempMeterItem || !this.tempMeterItem.sections) return 0;
                 
                 let total = this.tempMeterItem.basePrice; // Prezzo base del Mezzo Metro
                 
                 // Aggiungi i costi dei modificatori per ogni sezione
                 this.tempMeterItem.sections.forEach(section => {
                     if (section.modifiers) {
                         total += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                     }
                 });
                 
                 return total;
            },
            
            get isMeterValid() {
                 if (!this.tempMeterItem || !this.tempMeterItem.sections) return false;
                 // Un metro è valido se tutti i gusti sono stati selezionati
                 return this.tempMeterItem.sections.every(s => s.gusto && s.gusto.trim() !== '');
            },
            
            get calculateTempHalfPizzaTotal() {
                 if (!this.tempHalfPizzaItem) return 0;
                 
                 let total = this.tempHalfPizzaItem.basePrice; // Prezzo base della Mezza Pizza
                 
                 // Aggiungi i costi dei modificatori della Metà 1 (al 50%)
                 if (this.tempHalfPizzaItem.modifiers1) {
                     total += this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + (mod.prezzo / 2), 0);
                 }

                 // Aggiungi i costi dei modificatori della Metà 2 (al 50%)
                 if (this.tempHalfPizzaItem.modifiers2) {
                     total += this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + (mod.prezzo / 2), 0);
                 }
                 
                 return total;
            },

            get isHalfPizzaValid() {
                 if (!this.tempHalfPizzaItem) return false;
                 // Una pizza a metà è valida se entrambi i gusti sono stati selezionati
                 return (this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto1.trim() !== '') &&
                        (this.tempHalfPizzaItem.gusto2 && this.tempHalfPizzaItem.gusto2.trim() !== '');
            },

            // --- Metodi (Funzioni) ---
            
            saveDataAll() {
                 saveData({
                    menu: this.menu,
                    modifiers: this.modifiers,
                    activeOrders: this.activeOrders,
                    archiveOrders: this.archiveOrders,
                    deliveryZones: this.deliveryZones,
                    drivers: this.drivers,
                    customerRegistry: this.customerRegistry,
                    accessPins: this.accessPins,
                    capacitySettings: this.capacitySettings,
                 });
                 console.log("Dati salvati in localStorage.");
            },
            
            // --- Login/Accesso ---
            grantAccess() {
                const pin = this.accessPin;
                if (pin === this.accessPins.PROPRIETARIO) {
                    this.userRole = 'PROPRIETARIO';
                    this.accessPin = '';
                    alert('Accesso Proprietario Concesso.');
                } else if (pin === this.accessPins.OPERATORE) {
                    this.userRole = 'OPERATORE';
                    this.accessPin = '';
                    alert('Accesso Operatore Concesso.');
                } else {
                    alert('PIN non valido.');
                    this.accessPin = '';
                }
            },
            
            saveAdminPin() {
                 if (this.newAdminPin.length < 4) {
                      alert("Il PIN deve essere di almeno 4 cifre.");
                      return;
                 }
                 this.accessPins.OPERATORE = this.newAdminPin;
                 this.saveDataAll();
                 alert("PIN Operatore aggiornato con successo.");
            },

            saveOwnerPin() {
                 if (this.newOwnerPin.length < 4) {
                      alert("Il PIN deve essere di almeno 4 cifre.");
                      return;
                 }
                 this.accessPins.PROPRIETARIO = this.newOwnerPin;
                 this.saveDataAll();
                 alert("PIN Proprietario aggiornato con successo.");
            },

            // --- Carrello/POS ---
            calculateItemTotal(item) {
                let total = item.prezzo;
                
                // Prezzo manuale ha la precedenza
                if (item.manualPrice !== undefined) {
                    return item.manualPrice;
                }

                // Aggiungi modificatori (solo se non è una composizione speciale)
                if (item.modifiers && !item.isMeter && !item.isHalfPizza) {
                    total += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                }
                
                // Calcola totale per Mezzo Metro
                if (item.isMeter && item.sections) {
                    // La logica di calcolo dei modificatori del Metro è gestita nel modal
                    // e il prezzo base è già item.prezzo. Aggiungiamo i modificatori.
                    item.sections.forEach(section => {
                         if (section.modifiers) {
                             total += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                         }
                    });
                }
                
                // Calcola totale per Pizza a Metà
                if (item.isHalfPizza && (item.modifiers1 || item.modifiers2)) {
                     // Aggiungi i modificatori della Metà 1 (al 50%)
                     if (item.modifiers1) {
                         total += item.modifiers1.reduce((sum, mod) => sum + (mod.prezzo / 2), 0);
                     }
                     // Aggiungi i modificatori della Metà 2 (al 50%)
                     if (item.modifiers2) {
                         total += item.modifiers2.reduce((sum, mod) => sum + (mod.prezzo / 2), 0);
                     }
                }
                
                return total;
            },

            handleItemClick(item) {
                if (item.isFinished) {
                    alert("Articolo esaurito e non può essere aggiunto.");
                    return;
                }

                if (item.isMeter) {
                    this.lastSelectedItem = item;
                    this.openMeterCompositionModal(item);
                    return;
                }
                
                if (item.isHalfPizza) {
                     this.lastSelectedItem = item;
                     this.openHalfPizzaCompositionModal(item);
                     return;
                }

                this.order.push({
                    id: generateUniqueId(),
                    nome: item.nome,
                    prezzo: item.prezzo,
                    modifiers: []
                });
                this.selectedItemIndex = this.order.length - 1; // Seleziona l'articolo appena aggiunto
                this.activeModCat = 'Standard'; // Resetta la categoria modificatori
            },

            removeItem(index) {
                this.order.splice(index, 1);
                this.selectedItemIndex = null;
            },

            selectItem(index) {
                // Non permettere la selezione se è una composizione (metro o metà)
                if (this.order[index].isMeter || this.order[index].isHalfPizza) {
                    this.selectedItemIndex = null; // Deseleziona l'articolo precedente
                    this.activeModCat = 'Standard';
                    return;
                }
                this.selectedItemIndex = index;
                this.activeModCat = 'Standard';
            },

            addExtra(mod) {
                if (this.selectedItemIndex === null) {
                    alert("Seleziona prima un articolo nel carrello.");
                    return;
                }
                if (mod.isFinished) {
                    alert("Modificatore esaurito.");
                    return;
                }

                const item = this.order[this.selectedItemIndex];
                
                // Modificatori non consentiti su composizioni
                if (item.isMeter || item.isHalfPizza) {
                     alert("Per le pizze speciali, i modificatori vanno aggiunti tramite l'apposito menu di composizione.");
                     return;
                }

                const existingIndex = item.modifiers.findIndex(m => m.nome === mod.nome);

                if (existingIndex !== -1) {
                    // Rimuovi se esiste
                    item.modifiers.splice(existingIndex, 1);
                } else {
                    // Aggiungi se non esiste
                    item.modifiers.push({ ...mod });
                }
            },
            
            getModifierIcon(category) {
                 switch(category) {
                      case 'Standard': return '🍕 ';
                      case 'Cottura': return '🔥 ';
                      default: return '➕ ';
                 }
            },
            
            resetOrderState() {
                 this.order = [];
                 this.selectedItemIndex = null;
                 this.searchTerm = '';
                 this.modifierSearchTerm = '';
                 this.mode = 'banco';
                 this.date = getTodayDateString();
                 this.hour = getTimePlus(15);
                 this.tableNumber = '';
                 this.customer = '';
                 this.phone = '';
                 this.address = '';
                 this.streetNumber = '';
                 this.town = 'Napoli';
                 this.zoneName = this.deliveryZones.length > 0 ? this.deliveryZones[0].name : '';
                 this.deliveryCost = this.deliveryZones.length > 0 ? this.deliveryZones[0].price : 0.00;
                 this.notes = '';
                 this.accontoRicevuto = 0.00;
                 this.editingOrderId = null;
                 this.updateCapacityWarning();
            },

            // --- Modale Prezzo Manuale ---
            openPriceEditModal(index) {
                 this.tempPriceEditIndex = index;
                 const item = this.order[index];
                 // Preimposta il prezzo manuale se già esiste, altrimenti il totale calcolato
                 this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item);
                 this.showPriceEditModal = true;
            },
            
            saveNewPrice() {
                 if (this.tempPriceEditIndex !== null) {
                     const item = this.order[this.tempPriceEditIndex];
                     
                     // Se il prezzo inserito è uguale al prezzo calcolato (prezzo base + extra), rimuovi il manualPrice
                     // Questo permette di "sbloccare" il prezzo manuale
                     let basePrice = item.prezzo;
                     if (item.modifiers) {
                         basePrice += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                     }
                     
                     if (this.newPriceValue === basePrice) {
                          delete item.manualPrice;
                     } else {
                          item.manualPrice = this.newPriceValue;
                     }
                     
                     this.order[this.tempPriceEditIndex] = { ...item }; // Forzo aggiornamento reattivo
                     this.showPriceEditModal = false;
                     this.tempPriceEditIndex = null;
                 }
            },

            // --- Modale Composizione Mezzo Metro ---
            openMeterCompositionModal(item) {
                 // Inizializza l'oggetto temporaneo per la composizione
                 const numSections = 3; // Un metro è diviso in 3 sezioni/gusti
                 this.tempMeterItem = {
                      basePrice: item.prezzo,
                      isMeter: true,
                      sections: Array(numSections).fill(0).map((_, i) => ({
                           name: `Gusto ${i + 1}`,
                           gusto: '',
                           modifiers: [],
                           activeSection: i === 0, // La prima è attiva di default
                           showGustoDropdown: false
                      })),
                      nome: item.nome,
                      prezzo: item.prezzo
                 };
                 this.showMeterModal = true;
                 this.gustoSearchTerm = '';
                 this.tempModCat = 'Standard';
            },

            selectMeterGusto(sectionIndex, gustoName) {
                 this.tempMeterItem.sections[sectionIndex].gusto = gustoName;
                 this.tempMeterItem.sections[sectionIndex].showGustoDropdown = false;
                 this.gustoSearchTerm = '';
            },

            addMeterModifier(sectionIndex, mod) {
                 const section = this.tempMeterItem.sections[sectionIndex];
                 
                 if (mod.isFinished) {
                      alert("Modificatore esaurito.");
                      return;
                 }

                 const existingIndex = section.modifiers.findIndex(m => m.nome === mod.nome);

                 if (existingIndex !== -1) {
                     // Rimuovi se esiste
                     section.modifiers.splice(existingIndex, 1);
                 } else {
                     // Aggiungi se non esiste
                     section.modifiers.push({ ...mod });
                 }
            },
            
            removeMeterModifier(sectionIndex, modIndex) {
                 this.tempMeterItem.sections[sectionIndex].modifiers.splice(modIndex, 1);
            },

            addMeterToOrder() {
                 if (!this.isMeterValid) {
                      alert("Devi selezionare un gusto per tutte le sezioni.");
                      return;
                 }
                 
                 // Calcola il prezzo totale per l'articolo e crea l'oggetto finale
                 const finalItem = {
                      id: generateUniqueId(),
                      nome: this.tempMeterItem.nome,
                      prezzo: this.tempMeterItem.basePrice,
                      isMeter: true,
                      sections: this.tempMeterItem.sections.map(s => ({ 
                           name: s.name, 
                           gusto: s.gusto, 
                           modifiers: s.modifiers 
                      }))
                 };
                 
                 // Il prezzo totale (con modificatori) viene calcolato dinamicamente dalla computed property e dal metodo calculateItemTotal
                 this.order.push(finalItem);
                 this.showMeterModal = false;
                 this.tempMeterItem = null;
                 this.selectedItemIndex = null;
            },
            
            cancelMeterComposition() {
                 this.showMeterModal = false;
                 this.tempMeterItem = null;
            },

            // --- Modale Composizione Pizza a Metà ---
            openHalfPizzaCompositionModal(item) {
                 this.tempHalfPizzaItem = {
                      basePrice: item.prezzo,
                      isHalfPizza: true,
                      nome: item.nome,
                      prezzo: item.prezzo,
                      gusto1: '',
                      modifiers1: [],
                      gusto2: '',
                      modifiers2: [],
                      activeHalf: 1, // Metà 1 attiva di default
                      showGustoDropdown1: false,
                      showGustoDropdown2: false
                 };
                 this.showHalfPizzaModal = true;
                 this.gustoSearchTerm = '';
                 this.tempModCat = 'Standard';
            },

            selectHalfPizzaGusto(halfNumber, gustoName) {
                 if (halfNumber === 1) {
                      this.tempHalfPizzaItem.gusto1 = gustoName;
                      this.tempHalfPizzaItem.showGustoDropdown1 = false;
                 } else {
                      this.tempHalfPizzaItem.gusto2 = gustoName;
                      this.tempHalfPizzaItem.showGustoDropdown2 = false;
                 }
                 this.gustoSearchTerm = '';
            },

            addHalfPizzaModifier(halfNumber, mod) {
                 let modifiersArray = halfNumber === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                 
                 if (mod.isFinished) {
                      alert("Modificatore esaurito.");
                      return;
                 }

                 const existingIndex = modifiersArray.findIndex(m => m.nome === mod.nome);

                 if (existingIndex !== -1) {
                     // Rimuovi se esiste
                     modifiersArray.splice(existingIndex, 1);
                 } else {
                     // Aggiungi se non esiste (il prezzo sarà dimezzato in calculateItemTotal)
                     modifiersArray.push({ ...mod });
                 }
            },

            addHalfPizzaToOrder() {
                 if (!this.isHalfPizzaValid) {
                      alert("Devi selezionare un gusto per entrambe le metà.");
                      return;
                 }
                 
                 const finalItem = {
                      id: generateUniqueId(),
                      nome: this.tempHalfPizzaItem.nome,
                      prezzo: this.tempHalfPizzaItem.basePrice,
                      isHalfPizza: true,
                      gusto1: this.tempHalfPizzaItem.gusto1,
                      modifiers1: this.tempHalfPizzaItem.modifiers1,
                      gusto2: this.tempHalfPizzaItem.gusto2,
                      modifiers2: this.tempHalfPizzaItem.modifiers2
                 };
                 
                 this.order.push(finalItem);
                 this.showHalfPizzaModal = false;
                 this.tempHalfPizzaItem = null;
                 this.selectedItemIndex = null;
            },

            cancelHalfPizzaComposition() {
                 this.showHalfPizzaModal = false;
                 this.tempHalfPizzaItem = null;
            },

            // --- Modale Finalizzazione ---
            openModal() {
                if (this.deliveryZones.length === 0 && this.mode === 'consegna') {
                     alert("Imposta almeno una zona di consegna nelle impostazioni prima di finalizzare una Consegna.");
                     this.selectMode('banco');
                     return;
                }
                this.updateDeliveryCost();
                this.updateCapacityWarning();
                this.showModal = true;
            },

            selectMode(newMode) {
                 this.mode = newMode;
                 this.updateDeliveryCost();
            },

            updateDeliveryCost() {
                 if (this.mode === 'consegna') {
                      const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                      this.deliveryCost = zone ? zone.price : 0.00;
                      if (!zone && this.deliveryZones.length > 0) {
                           this.zoneName = this.deliveryZones[0].name;
                           this.deliveryCost = this.deliveryZones[0].price;
                      } else if (this.deliveryZones.length === 0) {
                           this.deliveryCost = 0.00;
                      }
                 } else {
                      this.deliveryCost = 0.00;
                 }
            },
            
            updateCapacityWarning() {
                 const currentDateTime = this.date + ' ' + this.hour;
                 const interval = this.capacitySettings.intervalMinutes * 60 * 1000;
                 let totalPizzas = 0;

                 // Conteggio pizze nell'ordine corrente
                 let currentPizzas = this.order.filter(item => item.prezzo > 0).length;
                 
                 // Conta le pizze negli ordini attivi che cadono nello stesso intervallo di tempo
                 this.activeOrders.forEach(order => {
                      const orderDateTime = order.date + ' ' + order.hour;
                      const timeDiff = Math.abs(new Date(orderDateTime) - new Date(currentDateTime));
                      
                      if (timeDiff <= interval) {
                           totalPizzas += order.items.filter(item => item.prezzo > 0).length;
                      }
                 });
                 
                 // Aggiungi le pizze dell'ordine corrente al totale
                 this.orderCapacity.total = totalPizzas + currentPizzas;
                 this.orderCapacity.max = this.capacitySettings.maxPizzas;
            },

            // --- Gestione Clienti Autocomplete ---
            filterCustomers() {
                 const term = this.customer.toLowerCase().trim();
                 if (term.length < 3) {
                      this.filteredCustomerSuggestions = [];
                      return;
                 }
                 
                 this.filteredCustomerSuggestions = this.customerRegistry.filter(c => 
                      c.customer.toLowerCase().includes(term)
                 ).slice(0, 5);
            },
            
            loadCustomerData(data) {
                 this.customer = data.customer;
                 this.phone = data.phone || '';
                 this.address = data.address || '';
                 this.streetNumber = data.streetNumber || '';
                 this.zoneName = data.zoneName || (this.deliveryZones.length > 0 ? this.deliveryZones[0].name : '');
                 this.updateDeliveryCost(); // Aggiorna costo di consegna in base alla zona
                 this.filteredCustomerSuggestions = [];
            },

            // --- Conferma Ordine ---
            confermaOrdine() {
                if (this.mode === 'consegna' && (!this.address || !this.zoneName)) {
                    alert("Per la consegna, indirizzo e zona sono obbligatori.");
                    return;
                }
                if ((this.mode === 'asporto' || this.mode === 'consegna') && !this.customer) {
                    alert("Per asporto/consegna, il nome del cliente è obbligatorio.");
                    return;
                }
                
                // Aggiorna o Aggiungi Cliente al Registro
                if (this.customer) {
                     const existingIndex = this.customerRegistry.findIndex(c => c.customer === this.customer);
                     const newCustomerData = {
                          customer: this.customer,
                          phone: this.phone,
                          address: this.address,
                          streetNumber: this.streetNumber,
                          zoneName: this.zoneName
                     };
                     
                     if (existingIndex !== -1) {
                          this.customerRegistry[existingIndex] = newCustomerData;
                     } else {
                          this.customerRegistry.push(newCustomerData);
                     }
                }

                const newOrder = {
                    id: this.editingOrderId || generateUniqueId(),
                    date: this.date,
                    hour: this.hour,
                    mode: this.mode,
                    tableNumber: this.tableNumber,
                    customer: this.customer,
                    phone: this.phone,
                    address: this.address,
                    streetNumber: this.streetNumber,
                    town: this.town,
                    zone: this.zoneName,
                    deliveryCost: this.deliveryCost,
                    notes: this.notes,
                    acconto: this.accontoRicevuto,
                    resto: this.restoDaDare,
                    items: this.order,
                    total: this.total,
                    status: 'IN ATTESA',
                    driver: '', // Assegnato dopo
                    createdAt: new Date().toISOString()
                };

                if (this.editingOrderId) {
                     // Modalità Modifica: Sostituisci l'ordine esistente
                     const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                     if (index !== -1) {
                         // Mantieni lo status e il driver attuali in caso di modifica
                         newOrder.status = this.activeOrders[index].status;
                         newOrder.driver = this.activeOrders[index].driver;
                         this.activeOrders.splice(index, 1, newOrder);
                     }
                     alert(`Ordine #${this.editingOrderId.substring(0, 4)} modificato e reinserito in coda.`);
                } else {
                    // Modalità Nuovo Ordine: Aggiungi
                    this.activeOrders.unshift(newOrder);
                    alert(`Ordine #${newOrder.id.substring(0, 4)} salvato e messo in coda.`);
                }
                
                // Stampa Comanda
                this.printOrder(newOrder.id, 'comanda');

                // Resetta lo stato e chiudi il modale
                this.showModal = false;
                this.resetOrderState();
                this.saveDataAll();
            },

            // --- Gestione Ordini Attivi ---
            
            isUrgent(order) {
                 const orderTime = new Date(order.date + 'T' + order.hour).getTime();
                 const now = new Date().getTime();
                 
                 // Tempo rimanente in minuti
                 const minutesRemaining = (orderTime - now) / 60000; 

                 // Considera urgente se mancano meno di 15 minuti E non è già pronto/consegnato
                 return minutesRemaining > 0 && minutesRemaining < 15 && order.status !== 'PRONTO' && order.status !== 'CONSEGNATO';
            },

            isNear(order) {
                 const orderTime = new Date(order.date + 'T' + order.hour).getTime();
                 const now = new Date().getTime();
                 const minutesRemaining = (orderTime - now) / 60000; 

                 // Considera vicino se mancano tra 15 e 30 minuti
                 return minutesRemaining >= 15 && minutesRemaining < 30 && order.status !== 'PRONTO' && order.status !== 'CONSEGNATO';
            },

            getNextStatus(currentStatus) {
                switch (currentStatus) {
                    case 'IN ATTESA': return 'IN PREPARAZIONE';
                    case 'IN PREPARAZIONE': return 'PRONTO';
                    case 'PRONTO': return 'CONSEGNATO';
                    case 'CONSEGNATO': return 'ARCHIVIA';
                    default: return 'ARCHIVIA';
                }
            },

            advance(order) {
                const nextStatus = this.getNextStatus(order.status);

                if (nextStatus === 'ARCHIVIA') {
                    // Archivia l'ordine
                    const index = this.activeOrders.findIndex(o => o.id === order.id);
                    if (index !== -1) {
                        // Rimuovi dagli attivi e aggiungi all'archivio
                        order.archivedAt = new Date().toISOString();
                        this.archiveOrders.unshift(order); 
                        this.activeOrders.splice(index, 1);
                        this.saveDataAll();
                        alert(`Ordine #${order.id.substring(0, 4)} archiviato.`);
                    }
                } else if (nextStatus === 'PRONTO' && (order.mode === 'asporto' || order.mode === 'consegna')) {
                     // Stampa lo scontrino quando l'ordine è PRONTO per asporto/consegna
                     this.printOrder(order.id, 'scontrino');
                     order.status = nextStatus;
                     this.saveDataAll();
                } else if (nextStatus === 'CONSEGNATO' && order.mode === 'consegna' && !order.driver) {
                     alert("Assegna prima un fattorino per completare la consegna.");
                     return;
                } else {
                    // Cambia status
                    order.status = nextStatus;
                    this.saveDataAll();
                }
            },
            
            editOrder(orderId) {
                 const orderToEdit = this.activeOrders.find(o => o.id === orderId);
                 if (!orderToEdit) return;

                 // Carica i dati dell'ordine nel carrello
                 this.order = orderToEdit.items.map(item => ({ ...item })); // Clona l'array per evitare modifiche dirette
                 
                 // Carica i dati nel modal
                 this.editingOrderId = orderToEdit.id;
                 this.date = orderToEdit.date;
                 this.hour = orderToEdit.hour;
                 this.mode = orderToEdit.mode;
                 this.tableNumber = orderToEdit.tableNumber || '';
                 this.customer = orderToEdit.customer || '';
                 this.phone = orderToEdit.phone || '';
                 this.address = orderToEdit.address || '';
                 this.streetNumber = orderToEdit.streetNumber || '';
                 this.town = orderToEdit.town || 'Napoli';
                 this.zoneName = orderToEdit.zone || (this.deliveryZones.length > 0 ? this.deliveryZones[0].name : '');
                 this.deliveryCost = orderToEdit.deliveryCost || 0.00;
                 this.notes = orderToEdit.notes || '';
                 this.accontoRicevuto = orderToEdit.acconto || 0.00;

                 // Passa alla vista inserimento
                 this.view = 'inserimento';
                 this.selectedItemIndex = null;
                 alert(`Stai modificando l'ordine #${orderToEdit.id.substring(0, 4)}.`);
            },
            
            cancelEdit() {
                 if (confirm("Sei sicuro di voler annullare la modifica? Il carrello verrà svuotato e l'ordine attivo rimarrà invariato.")) {
                      this.resetOrderState();
                 }
            },
            
            updateActiveOrderDriver(orderId, driverName) {
                 const order = this.activeOrders.find(o => o.id === orderId);
                 if (order) {
                      order.driver = driverName;
                      this.saveDataAll();
                 }
            },

            showShareMenu(orderId) {
                 this.selectedOrderForShare = this.activeOrders.find(o => o.id === orderId);
                 if (this.selectedOrderForShare) {
                      this.showShareModal = true;
                 }
            },

            shareViaWhatsapp(order) {
                 if (!order || !order.phone) {
                      alert("Numero di telefono mancante per la condivisione.");
                      return;
                 }
                 
                 let message = `*Aggiornamento Ordine Pizzeria Smart*\n\n`;
                 message += `*Ordine Numero:* #${order.id.substring(0, 4)}\n`;
                 message += `*Status:* ${order.status}\n`;
                 message += `*Orario di Ritiro/Consegna Stimato:* ${order.hour}\n`;
                 message += `*Totale:* €${order.total.toFixed(2)}\n\n`;
                 
                 if (order.status === 'PRONTO' || order.status === 'CONSEGNATO') {
                      message += `Il tuo ordine è *pronto* per il ritiro/consegna!\n\n`;
                 } else {
                      message += `Il tuo ordine è in *preparazione*.\n\n`;
                 }
                 
                 message += `Grazie per aver scelto Pizzeria Smart!`;

                 const encodedMessage = encodeURIComponent(message);
                 const whatsappUrl = `https://wa.me/${order.phone.replace(/[^0-9+]/g, '')}?text=${encodedMessage}`;
                 
                 window.open(whatsappUrl, '_blank');
                 this.showShareModal = false;
            },

            // --- Gestione Archivio ---
            
            calculateDriverStats() {
                 const driver = this.selectedDriver.toLowerCase().trim();
                 let totalOrders = 0;
                 let totalRevenue = 0;

                 const orders = this.archiveOrders.filter(o => o.date === this.archiveDateFilter);

                 orders.forEach(order => {
                      if (order.mode === 'consegna' && (driver === '' || (order.driver && order.driver.toLowerCase() === driver))) {
                           totalOrders++;
                           totalRevenue += order.total;
                      }
                 });
                 
                 this.driverStats.totalOrders = totalOrders;
                 this.driverStats.totalRevenue = totalRevenue;
                 
                 // Calcola il totale giornaliero (tutti i tipi di ordine)
                 this.dailyTotal = orders.reduce((sum, order) => sum + order.total, 0);
            },
            
            updateArchiveDriver(orderId, driverName) {
                 const order = this.archiveOrders.find(o => o.id === orderId);
                 if (order) {
                      order.driver = driverName;
                      this.saveDataAll();
                      this.calculateDriverStats(); // Ricalcola le statistiche dopo la modifica
                 }
            },

            duplicateOrder(order) {
                 if (!confirm(`Sei sicuro di voler duplicare l'ordine #${order.id.substring(0, 4)} e reinserirlo nel carrello?`)) {
                      return;
                 }
                 this.resetOrderState();
                 this.order = order.items.map(item => ({ ...item, id: generateUniqueId() }));
                 this.date = getTodayDateString();
                 this.hour = getTimePlus(15);
                 this.customer = order.customer || '';
                 this.phone = order.phone || '';
                 this.address = order.address || '';
                 this.streetNumber = order.streetNumber || '';
                 this.town = order.town || 'Napoli';
                 this.notes = order.notes || '';
                 this.mode = order.mode;
                 
                 this.view = 'inserimento';
                 alert(`Ordine #${order.id.substring(0, 4)} duplicato nel carrello. Modifica i dettagli se necessario.`);
            },

            // --- Stampa ---
            printOrder(orderId, type) {
                const order = this.activeOrders.find(o => o.id === orderId) || this.archiveOrders.find(o => o.id === orderId);
                if (!order) return;

                const printElement = document.getElementById('print-area');
                let contentHTML = '';

                if (type === 'comanda') {
                     contentHTML = this.generateComandaHTML(order);
                     document.getElementById('print-content-comanda').innerHTML = contentHTML;
                     printElement.style.display = 'block';
                     window.print();
                     printElement.style.display = 'none';
                } else if (type === 'scontrino') {
                     contentHTML = this.generateScontrinoHTML(order);
                     document.getElementById('print-content-scontrino').innerHTML = contentHTML;
                     printElement.style.display = 'block';
                     window.print();
                     printElement.style.display = 'none';
                }
            },

            generateComandaHTML(order) {
                let html = `
                    <h1>COMANDA PIZZERIA SMART</h1>
                    <p><strong>ID Ordine:</strong> #${order.id.substring(0, 4)}</p>
                    <p><strong>Tipo:</strong> ${order.mode.toUpperCase()}</p>
                    <p><strong>Ritiro/Cons:</strong> ${order.hour} del ${new Date(order.date).toLocaleDateString('it-IT')}</p>
                `;
                
                if (order.mode === 'banco') {
                    html += `<p><strong>Tavolo/Nome:</strong> ${order.tableNumber || 'N/D'}</p>`;
                } else if (order.mode === 'asporto') {
                     html += `<p><strong>Cliente:</strong> ${order.customer || 'N/D'}</p>`;
                } else if (order.mode === 'consegna') {
                    html += `
                        <p><strong>Consegna a:</strong> ${order.customer || 'N/D'}</p>
                        <p><strong>Indirizzo:</strong> ${order.address} ${order.streetNumber} (${order.zone})</p>
                        <p><strong>Fattorino:</strong> ${order.driver || 'NON ASSEGNATO'}</p>
                    `;
                }

                html += `<hr>`;
                html += `<h2>ARTICOLI</h2><ul>`;

                order.items.forEach(item => {
                    let totalItemPrice = this.calculateItemTotal(item);
                    html += `<li><strong>1x ${item.nome}</strong> (${item.manualPrice !== undefined ? 'PREZZO MANUALE' : '€' + totalItemPrice.toFixed(2)})`;
                    
                    if (item.modifiers && item.modifiers.length > 0) {
                        html += `<br><em>Extra: ${item.modifiers.map(m => m.nome).join(', ')}</em>`;
                    }
                    if (item.isMeter && item.sections) {
                         html += `<br><em>Gusti (Metro): ${item.sections.map(s => s.gusto || 'N/D').join(' / ')}</em>`;
                         item.sections.forEach(section => {
                             if (section.modifiers && section.modifiers.length > 0) {
                                 html += `<br>-- ${section.name} Extra: ${section.modifiers.map(m => m.nome).join(', ')}`;
                             }
                         });
                    }
                    if (item.isHalfPizza) {
                        html += `<br><em>Metà 1: ${item.gusto1}</em>`;
                        if (item.modifiers1 && item.modifiers1.length > 0) {
                             html += `<br>-- M1 Extra: ${item.modifiers1.map(m => m.nome).join(', ')}`;
                        }
                        html += `<br><em>Metà 2: ${item.gusto2}</em>`;
                        if (item.modifiers2 && item.modifiers2.length > 0) {
                             html += `<br>-- M2 Extra: ${item.modifiers2.map(m => m.nome).join(', ')}`;
                        }
                    }
                    html += `</li>`;
                });

                html += `</ul>`;
                
                if (order.notes) {
                    html += `<hr><p><strong>NOTE:</strong> ${order.notes}</p>`;
                }
                
                html += `<hr><p style="text-align: center; font-size: 0.8em;">Stampato il: ${new Date().toLocaleTimeString('it-IT')}</p>`;

                return html;
            },

            generateScontrinoHTML(order) {
                 let html = `
                    <h1>SCONTRINO NON FISCALE</h1>
                    <p style="text-align: center;">Grazie per il tuo acquisto!</p>
                    <p><strong>ID Ordine:</strong> #${order.id.substring(0, 4)}</p>
                    <p><strong>Data:</strong> ${new Date(order.date).toLocaleDateString('it-IT')} ${order.hour}</p>
                    <p><strong>Tipo:</strong> ${order.mode.toUpperCase()}</p>
                    <p><strong>Cliente:</strong> ${order.customer || order.tableNumber || 'BANCO'}</p>
                    <hr>
                    <table>
                        <thead>
                            <tr>
                                <th>Articolo</th>
                                <th style="text-align: right;">Prezzo</th>
                            </tr>
                        </thead>
                        <tbody>
                 `;
                 
                 let subTotal = 0;
                 
                 order.items.forEach(item => {
                     const totalItemPrice = this.calculateItemTotal(item);
                     subTotal += totalItemPrice;
                     
                     let itemName = item.nome;
                     if (item.isMeter) itemName = item.nome + ` (${item.sections.map(s => s.gusto).join(' / ')})`;
                     if (item.isHalfPizza) itemName = item.nome + ` (${item.gusto1} / ${item.gusto2})`;
                     
                     html += `
                         <tr>
                             <td>${itemName}</td>
                             <td style="text-align: right;">€${totalItemPrice.toFixed(2)}</td>
                         </tr>
                     `;
                     
                     // Se ci sono modificatori extra con prezzo, li mostriamo separatamente
                     let extraMods = [];
                     if (item.modifiers) {
                          extraMods = item.modifiers.filter(m => m.prezzo > 0);
                     }
                     
                     // Modificatori per Mezzo Metro
                     if (item.isMeter && item.sections) {
                         item.sections.forEach(s => {
                             if (s.modifiers) {
                                 extraMods.push(...s.modifiers.filter(m => m.prezzo > 0));
                             }
                         });
                     }

                     // Modificatori per Metà Pizza
                     if (item.isHalfPizza) {
                          if (item.modifiers1) extraMods.push(...item.modifiers1.filter(m => m.prezzo > 0).map(m => ({ ...m, nome: `(M1) ${m.nome} (50%)`, prezzo: m.prezzo / 2 })));
                          if (item.modifiers2) extraMods.push(...item.modifiers2.filter(m => m.prezzo > 0).map(m => ({ ...m, nome: `(M2) ${m.nome} (50%)`, prezzo: m.prezzo / 2 })));
                     }

                     extraMods.forEach(mod => {
                         html += `
                              <tr>
                                   <td style="padding-left: 20px; font-size: 0.9em;">+ ${mod.nome}</td>
                                   <td style="text-align: right; font-size: 0.9em;">+€${mod.prezzo.toFixed(2)}</td>
                              </tr>
                         `;
                     });
                 });
                 
                 // Riga Subtotale Articoli
                 if (order.mode === 'consegna') {
                      html += `
                           <tr class="total-row">
                               <td><strong>Subtotale Articoli</strong></td>
                               <td style="text-align: right;"><strong>€${subTotal.toFixed(2)}</strong></td>
                           </tr>
                      `;
                 }

                 // Costo Consegna
                 if (order.mode === 'consegna' && order.deliveryCost > 0) {
                     html += `
                         <tr>
                             <td>Costo Consegna (${order.zone})</td>
                             <td style="text-align: right;">+€${order.deliveryCost.toFixed(2)}</td>
                         </tr>
                     `;
                 }

                 html += `
                        <tr class="total-row">
                            <td><strong>TOTALE DA PAGARE</strong></td>
                            <td style="text-align: right;"><strong>€${order.total.toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
                 `;

                 if (order.acconto > 0) {
                      html += `<p style="margin-top: 10px;"><strong>Acconto ricevuto:</strong> €${order.acconto.toFixed(2)}</p>`;
                      if (order.resto > 0) {
                           html += `<p class="resto-da-dare"><strong>Resto da dare:</strong> €${order.resto.toFixed(2)}</p>`;
                      }
                 }
                 
                 html += `<hr><p style="text-align: center; font-size: 0.8em;">Stampato il: ${new Date().toLocaleTimeString('it-IT')}</p>`;
                 return html;
            },


            // --- Gestione Impostazioni ---
            
            // Menu
            addCategory() {
                 const name = this.newCategoryName.trim();
                 if (name && !(name in this.menu)) {
                      this.menu[name] = [];
                      this.activeSettingsCat = name;
                      this.newCategoryName = '';
                      this.saveDataAll();
                 } else {
                      alert("Nome categoria non valido o già esistente.");
                 }
            },
            
            deleteCategory(category) {
                 if (confirm(`Sei sicuro di voler eliminare la categoria "${category}"? Tutti gli articoli in essa contenuti verranno persi!`)) {
                      delete this.menu[category];
                      this.activeSettingsCat = 'Menu';
                      this.saveDataAll();
                 }
            },

            addItemToCategory() {
                 const name = this.newItemName.trim();
                 const price = parseFloat(this.newItemPrice);
                 
                 if (!name || isNaN(price) || price < 0) {
                      alert("Nome e prezzo validi sono richiesti.");
                      return;
                 }
                 
                 if (name in this.menu[this.activeSettingsCat].map(i => i.nome)) {
                      alert("Articolo già esistente in questa categoria.");
                      return;
                 }

                 const isMeter = name.toLowerCase().includes('metro');
                 const isHalfPizza = name.toLowerCase().includes('metà');

                 this.menu[this.activeSettingsCat].push({ 
                     nome: name, 
                     prezzo: price, 
                     isFinished: false,
                     isMeter: isMeter,
                     isHalfPizza: isHalfPizza
                 });
                 this.newItemName = '';
                 this.newItemPrice = 0.00;
                 this.saveDataAll();
            },
            
            deleteItem(category, index) {
                 this.menu[category].splice(index, 1);
                 this.saveDataAll();
            },
            
            toggleItemFinished(category, index) {
                 const item = this.menu[category][index];
                 item.isFinished = !item.isFinished;
                 this.saveDataAll();
            },
            
            // Modificatori
            isDefaultModifierCategory(category) {
                 return ['Standard', 'Cottura'].includes(category);
            },

            addModifierCategory() {
                 const name = this.newModifierCategoryName.trim();
                 if (name && !(name in this.modifiers)) {
                      this.modifiers[name] = [];
                      this.activeSettingsModCat = name;
                      this.newModifierCategoryName = '';
                      this.saveDataAll();
                 } else {
                      alert("Nome categoria non valido o già esistente.");
                 }
            },
            
            deleteModifierCategory(category) {
                 if (this.isDefaultModifierCategory(category)) {
                      alert("Non puoi eliminare le categorie di modificatori di default.");
                      return;
                 }
                 if (confirm(`Sei sicuro di voler eliminare la categoria di modificatori "${category}"?`)) {
                      delete this.modifiers[category];
                      this.activeSettingsModCat = 'Standard';
                      this.saveDataAll();
                 }
            },

            addModifierToCategory() {
                 const name = this.newModifierName.trim();
                 const price = parseFloat(this.newModifierPrice);
                 
                 if (!name || isNaN(price) || price < 0) {
                      alert("Nome e prezzo validi sono richiesti.");
                      return;
                 }
                 
                 this.modifiers[this.activeSettingsModCat].push({ 
                     nome: name, 
                     prezzo: price, 
                     isFinished: false 
                 });
                 this.newModifierName = '';
                 this.newModifierPrice = 0.00;
                 this.saveDataAll();
            },
            
            deleteModifier(category, index) {
                 this.modifiers[category].splice(index, 1);
                 this.saveDataAll();
            },
            
            toggleModifierFinished(category, index) {
                 const mod = this.modifiers[category][index];
                 mod.isFinished = !mod.isFinished;
                 this.saveDataAll();
            },
            
            // Consegna
            addZone() {
                 const name = this.newZoneName.trim();
                 const price = parseFloat(this.newZonePrice);
                 
                 if (!name || isNaN(price) || price < 0) {
                      alert("Nome zona e costo validi sono richiesti.");
                      return;
                 }
                 
                 if (this.deliveryZones.some(z => z.name === name)) {
                      alert("Zona già esistente.");
                      return;
                 }

                 this.deliveryZones.push({ name: name, price: price });
                 this.newZoneName = '';
                 this.newZonePrice = 0.00;
                 this.saveDataAll();
            },
            
            deleteZone(index) {
                 this.deliveryZones.splice(index, 1);
                 this.saveDataAll();
            },
            
            addDriver() {
                 const name = this.newDriverName.trim();
                 if (name && !this.drivers.includes(name)) {
                      this.drivers.push(name);
                      this.newDriverName = '';
                      this.saveDataAll();
                 } else {
                      alert("Nome fattorino non valido o già esistente.");
                 }
            },
            
            deleteDriver(index) {
                 this.drivers.splice(index, 1);
                 this.saveDataAll();
            },

            // --- Backup e Dati ---
            exportData() {
                 const data = JSON.stringify({
                      menu: this.menu,
                      modifiers: this.modifiers,
                      deliveryZones: this.deliveryZones,
                      drivers: this.drivers,
                      accessPins: this.accessPins,
                      capacitySettings: this.capacitySettings,
                      activeOrders: this.activeOrders,
                      archiveOrders: this.archiveOrders,
                      customerRegistry: this.customerRegistry
                 }, null, 2);
                 const blob = new Blob([data], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `pizzeria_smart_backup_${getTodayDateString()}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
            },

            importData() {
                 if (!confirm("ATTENZIONE: L'importazione sovrascriverà TUTTI i dati attuali (menu, ordini, impostazioni). Continuare?")) {
                      return;
                 }
                 const input = document.createElement('input');
                 input.type = 'file';
                 input.accept = 'application/json';
                 
                 input.onchange = e => {
                      const file = e.target.files[0];
                      if (!file) return;
                      
                      const reader = new FileReader();
                      reader.onload = event => {
                           try {
                                const importedData = JSON.parse(event.target.result);
                                
                                // Caricamento dati (si basa sullo schema)
                                if (importedData.menu) this.menu = importedData.menu;
                                if (importedData.modifiers) this.modifiers = importedData.modifiers;
                                if (importedData.deliveryZones) this.deliveryZones = importedData.deliveryZones;
                                if (importedData.drivers) this.drivers = importedData.drivers;
                                if (importedData.accessPins) this.accessPins = importedData.accessPins;
                                if (importedData.capacitySettings) this.capacitySettings = importedData.capacitySettings;
                                if (importedData.activeOrders) this.activeOrders = importedData.activeOrders;
                                if (importedData.archiveOrders) this.archiveOrders = importedData.archiveOrders;
                                if (importedData.customerRegistry) this.customerRegistry = importedData.customerRegistry;

                                this.saveDataAll();
                                alert("Dati importati con successo. Ricarica la pagina per applicare pienamente.");
                                // Forzare un aggiornamento della pagina dopo l'importazione è spesso la cosa più sicura
                                window.location.reload(); 
                           } catch (error) {
                                alert("Errore durante l'importazione del file. Assicurati che sia un file JSON valido.");
                                console.error(error);
                           }
                      };
                      reader.readAsText(file);
                 };
                 input.click();
            },

            clearCache() {
                 if (!confirm("Sei sicuro di voler pulire gli Ordini Attivi, l'Archivio e il Registro Clienti? Menu e Impostazioni rimarranno invariati.")) {
                      return;
                 }
                 this.activeOrders = [];
                 this.archiveOrders = [];
                 this.customerRegistry = [];
                 this.saveDataAll();
                 alert("Ordini e registro clienti puliti con successo.");
            }
        };

        // Inizializza Petite-Vue
        PetiteVue.createApp(v).mount('body');

        // Imposta il calcolo delle statistiche driver all'avvio
        v.calculateDriverStats();

    </script>

    </body>
</html>
