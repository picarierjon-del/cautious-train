<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Stili per le icone dei modificatori, se non supportate da Font Awesome */
        .icon-plus::before { content: '+'; }
        .icon-minus::before { content: '-'; }
        .icon-cut::before { content: '‚úÇ'; } 
        /* Altri stili personalizzati, come l'effetto pulsante animato per il KDS */
        .animate-pulse-driver {
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                border-color: #f87171; /* red-400 */
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7);
            }
            50% {
                border-color: #ef4444; /* red-500 */
                box-shadow: 0 0 0 5px rgba(248, 113, 113, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        const app = createApp({
            data() {
                return {
                    // Dati di sistema e accesso
                    view: 'login', // login, inserimento, ordini, storico, impostazioni, cucina
                    accessPin: '',
                    isAccessGranted: false,
                    userRole: 'ospite', // ospite, operatore, admin, owner
                    ownerPin: '1234', // PIN del Titolare
                    adminPin: '5678', // PIN dell'Admin/Manager

                    // Dati Menu
                    menu: {
                        'Pizza Classica': [
                            { id: 101, nome: 'Margherita', prezzo: 7.00, category: 'Pizza Classica' },
                            { id: 102, nome: 'Marinara', prezzo: 6.00, category: 'Pizza Classica' },
                            { id: 103, nome: 'Capricciosa', prezzo: 8.50, category: 'Pizza Classica' },
                            { id: 104, nome: 'Quattro Stagioni', prezzo: 9.00, category: 'Pizza Classica' },
                            { id: 105, nome: 'Diavola', prezzo: 8.00, category: 'Pizza Classica' },
                            { id: 106, nome: 'Napoletana', prezzo: 7.50, category: 'Pizza Classica' },
                            { id: 107, nome: 'Wurstel', prezzo: 7.50, category: 'Pizza Classica', isFinished: true }, // Esaurito
                        ],
                        'Pizze Speciali': [
                            { id: 201, nome: 'Gourmet del Nonno', prezzo: 12.00, category: 'Pizze Speciali' },
                            { id: 202, nome: 'Pistacchio & Mortadella', prezzo: 11.50, category: 'Pizze Speciali' },
                            { id: 203, nome: 'Vegetariana di Stagione', prezzo: 10.00, category: 'Pizze Speciali' },
                        ],
                        'Bevande': [
                            { id: 301, nome: 'Acqua Naturale 1L', prezzo: 2.00, category: 'Bevande' },
                            { id: 302, nome: 'Coca Cola Lattina', prezzo: 2.50, category: 'Bevande' },
                            { id: 303, nome: 'Birra Artigianale', prezzo: 5.00, category: 'Bevande' },
                        ],
                        'Dolci': [
                            { id: 401, nome: 'Tiramis√π Fatto in Casa', prezzo: 4.50, category: 'Dolci' },
                            { id: 402, nome: 'Cheesecake', prezzo: 5.00, category: 'Dolci' },
                        ],
                        'Formati Grandi': [
                            { id: 501, nome: 'Mezzo Metro', prezzo: 28.00, category: 'Formati Grandi', isMeter: true, numGusti: 3 }, // Prezzo base
                            { id: 502, nome: 'Schiacciata Grande', prezzo: 15.00, category: 'Formati Grandi', isMeter: true, numGusti: 2 },
                        ]
                    },
                    modifiers: {
                        'Aggiunte': [
                            { id: 601, nome: 'Bufala', prezzo: 2.50, category: 'Aggiunte' },
                            { id: 602, nome: 'Prosciutto Cotto', prezzo: 1.50, category: 'Aggiunte' },
                            { id: 603, nome: 'Patatine Fritte', prezzo: 1.00, category: 'Aggiunte' },
                            { id: 604, nome: 'Funghi Porcini', prezzo: 3.00, category: 'Aggiunte' },
                        ],
                        'Senza': [
                            { id: 701, nome: 'Senza Mozzarella', prezzo: 0.00, category: 'Senza' },
                            { id: 702, nome: 'Senza Pomodoro', prezzo: 0.00, category: 'Senza' },
                            { id: 703, nome: 'Senza Aglio', prezzo: 0.00, category: 'Senza' },
                        ],
                        'Cottura': [
                            { id: 801, nome: 'Poco Cotta', prezzo: 0.00, category: 'Cottura' },
                            { id: 802, nome: 'Molto Cotta', prezzo: 0.00, category: 'Cottura' },
                            { id: 803, nome: 'Impasto Integrale', prezzo: 1.50, category: 'Cottura' },
                        ]
                    },
                    
                    // Dati Ordine Corrente
                    order: [],
                    selectedItemIndex: null,
                    lastSelectedItem: null,
                    
                    // Gestione Interfaccia Menu
                    activeCat: 'Pizza Classica',
                    activeModCat: 'Aggiunte',
                    searchTerm: '',
                    modifierSearchTerm: '',
                    
                    // Dati Cliente/Logistica
                    mode: 'banco', // banco, asporto, consegna
                    modes: [
                        { id: 'banco', label: 'Banco/Tavolo', icon: 'fa-solid fa-store' },
                        { id: 'asporto', label: 'Ritiro/Asporto', icon: 'fa-solid fa-car' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-motorcycle' },
                    ],
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: '',
                    tableNumber: '',
                    carPlate: '',
                    notes: '',
                    date: '',
                    hour: '',
                    
                    // Dati Logistica e Capacit√†
                    drivers: ['Mario', 'Luigi', 'Yoshi'],
                    selectedDriver: '',
                    deliveryZones: [
                        { name: 'Centro', price: 2.00 },
                        { name: 'Periferia Nord', price: 3.50 },
                        { name: 'Zona Industriale', price: 5.00 },
                    ],
                    zoneName: '',
                    deliveryCost: 0.00,
                    capacitySettings: {
                        maxPizzas: 40, // Max pizze per intervallo
                        intervalMinutes: 30, // Durata intervallo di controllo
                    },
                    orderCapacity: { interval: null, total: 0, remaining: 40, warning: false, estimatedWaitTime: 0 },
                    
                    // Dati Finalizzazione
                    showModal: false,
                    editingOrderId: null,
                    lastOrderId: 0,
                    activeOrders: [],
                    archive: [],
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today',
                    
                    // Filtri Storico
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // Modal Composizione Mezzo Metro/Met√† Pizza
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: {
                        id: 0, nome: 'Pizza Met√†/Met√†', prezzoBase: 0, 
                        gusto1: null, modifiers1: [],
                        gusto2: null, modifiers2: [],
                        activeHalf: 0, // 1 o 2
                    },
                    showMeterModal: false,
                    tempMeterItem: {
                        id: 0, nome: '', prezzoBase: 0, isMeter: true, numGusti: 0, 
                        gusti: [], // [{ name: '1/3', gusto: 'Margherita', modifiers: [] }]
                    },
                    gustoSearchTerm: '',
                    tempModCat: 'Aggiunte',

                    // Prezzo Manuale
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0,

                    // Stampa/Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,

                    // Gestione Pagamento e Sconti
                    paymentMethod: 'contanti',
                    accontoRicevuto: 0.00,
                    discountAmount: 0.00,
                    discountType: 'fixed', // fixed o percent

                    // Storico Clienti (Cache)
                    customerHistory: [],
                    filteredCustomerSuggestions: [],
                    
                    // Orari di Apertura (NUOVO)
                    businessHours: {
                        openTime: '18:30',
                        closeTime: '22:30',
                        closedDays: [1], // Giorno di chiusura (es. 1 = Luned√¨)
                    },

                    // Preferiti Operatore (NUOVO)
                    operatorFavorites: {
                        items: [101, 103, 302],
                        modifiers: [601, 701],
                    }
                };
            },
            
            // --- COMPUTED PROPERTIES ---
            computed: {
                isOwner() {
                    return this.userRole === 'owner';
                },
                isAdmin() {
                    return this.userRole === 'admin' || this.userRole === 'owner';
                },
                isOperator() {
                    return this.userRole === 'operatore' || this.isAdmin;
                },

                // Menu e Articoli
                allMenuItems() {
                    return Object.values(this.menu).flat();
                },
                allModifiers() {
                    return Object.values(this.modifiers).flat();
                },
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    
                    if (!term) return items;
                    
                    return items.filter(item => 
                        item.nome.toLowerCase().includes(term) || 
                        (item.isFinished && term.includes('esaurito')) // Permette di cercare articoli esauriti
                    );
                },
                filteredModifiersForActiveCat() {
                    const modifiers = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();

                    if (!term) return modifiers;

                    return modifiers.filter(mod => 
                        mod.nome.toLowerCase().includes(term)
                    );
                },

                // Calcoli Totale Ordine
                subtotal() {
                    return this.order.reduce((sum, item) => {
                        return sum + this.calculateItemTotal(item);
                    }, 0);
                },
                calculatedOrderTotal() {
                    let total = this.subtotal + this.deliveryCost;

                    if (this.discountAmount > 0) {
                        if (this.discountType === 'percent' && this.discountAmount <= 100) {
                            total = total * (1 - this.discountAmount / 100);
                        } else if (this.discountType === 'fixed') {
                            total = total - this.discountAmount;
                        }
                    }
                    return Math.max(0, total); // Il totale non pu√≤ essere negativo
                },
                total() {
                    return this.calculatedOrderTotal;
                },
                restoDaDare() {
                    return Math.max(0, this.accontoRicevuto - this.total);
                },
                pizzasInCurrentOrder() {
                    return this.calculatePizzasInOrder({ order: this.order });
                },

                // Logica Capacit√†
                isCapacityWarning() {
                    return this.orderCapacity.warning || this.orderCapacity.total > this.capacitySettings.maxPizzas;
                },
                isCapacityFull() {
                    return this.orderCapacity.total > this.capacitySettings.maxPizzas;
                },
                minDate() {
                    return new Date().toISOString().slice(0, 10);
                },

                // Modali Composizione
                filteredPizzaGusti() {
                    const standardPizzas = this.menu['Pizza Classica'].concat(this.menu['Pizze Speciali']);
                    const term = this.gustoSearchTerm.toLowerCase();
                    return standardPizzas.filter(item => 
                        item.nome.toLowerCase().includes(term) && !item.isFinished
                    );
                },
                filteredTempModifiers() {
                    const modifiers = this.modifiers[this.tempModCat] || [];
                    return modifiers;
                },
                isHalfPizzaValid() {
                    return this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto2;
                },
                calculateTempHalfPizzaTotal() {
                    // Prezzo base pizza (prendiamo il maggiore tra i due gusti)
                    const pizzaPrices = this.filteredPizzaGusti
                        .filter(p => p.nome === this.tempHalfPizzaItem.gusto1 || p.nome === this.tempHalfPizzaItem.gusto2)
                        .map(p => p.prezzo);
                    
                    const basePrice = pizzaPrices.length > 0 ? Math.max(...pizzaPrices) : 0;
                    
                    // Calcolo costo modificatori
                    const modCost1 = this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    const modCost2 = this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                    return basePrice + modCost1 + modCost2;
                },
                isMeterValid() {
                    return this.tempMeterItem.numGusti > 0 && 
                           this.tempMeterItem.gusti.length === this.tempMeterItem.numGusti &&
                           this.tempMeterItem.gusti.every(g => g.gusto);
                },
                calculateTempMeterTotal() {
                    const basePrice = this.tempMeterItem.prezzoBase;
                    
                    const modCost = this.tempMeterItem.gusti.reduce((total, gusto) => {
                        return total + gusto.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }, 0);

                    return basePrice + modCost;
                },

                // Filtri Viste
                filteredActiveOrders() {
                    const now = new Date();
                    const todayString = now.toISOString().slice(0, 10);
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    const tomorrowString = tomorrow.toISOString().slice(0, 10);

                    return this.activeOrders
                        .filter(order => {
                            // Filtro per Data
                            let isDateMatch = false;
                            if (this.activeDateFilter === 'today') {
                                isDateMatch = order.date === todayString;
                            } else if (this.activeDateFilter === 'tomorrow') {
                                isDateMatch = order.date === tomorrowString;
                            } else if (this.activeDateFilter === 'future') {
                                isDateMatch = order.date > tomorrowString;
                            }
                            
                            if (!isDateMatch) return false;

                            // Filtro Ricerca
                            const term = this.activeOrderSearchTerm.toLowerCase();
                            if (!term) return true;
                            
                            return order.customer.toLowerCase().includes(term) ||
                                order.phone.includes(term) ||
                                order.address.toLowerCase().includes(term) ||
                                order.carPlate.toLowerCase().includes(term) ||
                                order.id.toString().includes(term);
                        })
                        .sort((a, b) => {
                            // Ordina per ora
                            if (a.date !== b.date) return a.date.localeCompare(b.date);
                            return a.hour.localeCompare(b.hour);
                        });
                },
                filteredArchive() {
                    return this.archive
                        .filter(order => {
                            let isDateMatch = true;
                            if (this.archiveDateFilter) {
                                isDateMatch = order.date === this.archiveDateFilter;
                            }

                            let isDriverMatch = true;
                            if (this.selectedDriver) {
                                isDriverMatch = order.driver === this.selectedDriver;
                            }
                            
                            return isDateMatch && isDriverMatch;
                        })
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                archiveDateFilterDisplay() {
                    if (!this.archiveDateFilter) return 'Tutte le date';
                    return new Date(this.archiveDateFilter).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
            },
            
            // --- WATCHERS ---
            watch: {
                order: {
                    handler() {
                        this.saveData();
                        this.updateCapacityWarning();
                    },
                    deep: true
                },
                activeOrders: {
                    handler() {
                        this.saveData();
                        this.updateCapacityWarning();
                    },
                    deep: true
                },
                customer() {
                    if (this.mode !== 'banco') {
                        this.filterCustomers();
                    }
                },
                phone() {
                    if (this.mode !== 'banco') {
                        this.filterCustomers();
                    }
                },
                address() {
                    if (this.mode === 'consegna') {
                        this.filterCustomers();
                    }
                },
                archiveDateFilter() {
                    this.calculateDriverStats();
                },
                // Assicura che l'indice selezionato sia valido quando l'ordine cambia
                'order.length'(newLen, oldLen) {
                    if (newLen < oldLen && this.selectedItemIndex !== null) {
                         // Se l'elemento rimosso era l'ultimo, deseleziona
                        if (this.selectedItemIndex >= newLen) {
                            this.selectedItemIndex = null;
                        }
                    }
                    if (newLen === 0) {
                        this.selectedItemIndex = null;
                    }
                }
            },

            // --- METHODS ---
            methods: {
                // --- Gestione Dati e Accesso ---
                saveData() {
                    const data = {
                        menu: this.menu,
                        modifiers: this.modifiers,
                        activeOrders: this.activeOrders,
                        archive: this.archive,
                        lastOrderId: this.lastOrderId,
                        drivers: this.drivers,
                        deliveryZones: this.deliveryZones,
                        capacitySettings: this.capacitySettings,
                        customerHistory: this.customerHistory,
                        businessHours: this.businessHours,
                        operatorFavorites: this.operatorFavorites,
                    };
                    localStorage.setItem('pizzeriaSmartData', JSON.stringify(data));
                },
                loadData() {
                    const savedData = localStorage.getItem('pizzeriaSmartData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        this.menu = data.menu || this.menu;
                        this.modifiers = data.modifiers || this.modifiers;
                        this.activeOrders = data.activeOrders || [];
                        this.archive = data.archive || [];
                        this.lastOrderId = data.lastOrderId || 0;
                        this.drivers = data.drivers || this.drivers;
                        this.deliveryZones = data.deliveryZones || this.deliveryZones;
                        this.capacitySettings = data.capacitySettings || this.capacitySettings;
                        this.customerHistory = data.customerHistory || [];
                        this.businessHours = data.businessHours || this.businessHours;
                        this.operatorFavorites = data.operatorFavorites || this.operatorFavorites;
                    }
                },
                grantAccess() {
                    if (this.accessPin === this.ownerPin) {
                        this.userRole = 'owner';
                    } else if (this.accessPin === this.adminPin) {
                        this.userRole = 'admin';
                    } else if (this.accessPin === '0000') { // PIN generico per operatore
                        this.userRole = 'operatore';
                    } else {
                        alert('PIN non valido.');
                        this.accessPin = '';
                        this.isAccessGranted = false;
                        this.userRole = 'ospite';
                        return;
                    }
                    this.isAccessGranted = true;
                    this.view = 'inserimento';
                    this.accessPin = '';
                },
                logout() {
                    this.isAccessGranted = false;
                    this.userRole = 'ospite';
                    this.view = 'login';
                },

                // --- Gestione Menu e Modifiche ---
                findMenuItemById(id) {
                    return this.allMenuItems.find(item => item.id === id);
                },
                findModifierById(id) {
                    return this.allModifiers.find(mod => mod.id === id);
                },
                getCategoryNameByItemName(name) {
                    for (const cat in this.menu) {
                        if (this.menu[cat].some(item => item.nome === name)) {
                            return cat;
                        }
                    }
                    return 'Sconosciuta';
                },
                toggleFinished(id, category) {
                    const item = this.menu[category].find(i => i.id === id);
                    if (item) {
                        item.isFinished = !item.isFinished;
                        this.saveData();
                    }
                },
                addMenuItem() {
                    if (!this.newItem.nome || this.newItem.prezzo <= 0 || !this.newItem.category) {
                        alert("Inserisci un nome, un prezzo valido e seleziona una categoria.");
                        return;
                    }
                    const newId = Math.max(...this.allMenuItems.map(i => i.id)) + 1;
                    const newItem = {
                        id: newId,
                        nome: this.newItem.nome,
                        prezzo: parseFloat(this.newItem.prezzo),
                        category: this.newItem.category,
                    };
                    this.menu[this.newItem.category].push(newItem);
                    this.newItem = { nome: '', prezzo: 0.00, category: 'Pizza Classica' };
                    this.saveData();
                },
                deleteMenuItem(id, category) {
                    if (confirm(`Sei sicuro di voler eliminare l'articolo con ID ${id} dalla categoria ${category}?`)) {
                        const index = this.menu[category].findIndex(i => i.id === id);
                        if (index !== -1) {
                            this.menu[category].splice(index, 1);
                            this.saveData();
                        }
                    }
                },
                addModifier() {
                    if (!this.newModifier.nome || !this.newModifier.category) {
                        alert("Inserisci un nome e seleziona una categoria per il modificatore.");
                        return;
                    }
                    const newId = Math.max(...this.allModifiers.map(i => i.id)) + 1;
                    const newMod = {
                        id: newId,
                        nome: this.newModifier.nome,
                        prezzo: parseFloat(this.newModifier.prezzo) || 0.00,
                        category: this.newModifier.category,
                    };
                    this.modifiers[this.newModifier.category].push(newMod);
                    this.newModifier = { nome: '', prezzo: 0.00, category: 'Aggiunte' };
                    this.saveData();
                },
                getModifierCategory(name) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === name)) {
                            return cat;
                        }
                    }
                    return 'Nessuna';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Aggiunte': return '‚ûï ';
                        case 'Senza': return '‚õî ';
                        case 'Cottura': return 'üî• ';
                        default: return '';
                    }
                },

                // --- Gestione Dati Logistici (Impostazioni) ---
                addDriver() {
                    const name = this.newDriverName.trim();
                    if (name && !this.drivers.includes(name)) {
                        this.drivers.push(name);
                        this.newDriverName = '';
                        this.saveData();
                    }
                },
                removeDriver(name) {
                    this.drivers = this.drivers.filter(d => d !== name);
                    this.saveData();
                },
                addZone() {
                    this.deliveryZones.push({ name: '', price: 0.00 });
                    this.saveData();
                },
                removeZone(index) {
                    this.deliveryZones.splice(index, 1);
                    this.saveData();
                },
                
                // --- Funzioni Ordine Corrente: Base ---
                addItemToOrder(item) {
                    // Prepara un nuovo oggetto per l'ordine, copiando solo i dati necessari
                    const newItem = {
                        id: item.id,
                        nome: item.nome,
                        prezzo: item.prezzo,
                        modifiers: [],
                        isMeter: item.isMeter || false,
                        isHalfPizza: false,
                        // Campi specifici per formati grandi
                        gusti: item.isMeter ? this.initializeMeterGusti(item.numGusti) : undefined,
                    };
                    this.order.push(newItem);
                    this.selectItem(this.order.length - 1); // Seleziona il nuovo articolo
                },
                selectItem(index) {
                    if (this.selectedItemIndex === index) {
                        this.selectedItemIndex = null; // Deseleziona
                    } else {
                        this.selectedItemIndex = index;
                        this.lastSelectedItem = index; // Tiene traccia dell'ultima selezione
                    }
                },
                removeItem(index) {
                    if (confirm(`Sei sicuro di voler rimuovere ${this.order[index].nome} dall'ordine?`)) {
                        this.order.splice(index, 1);
                        this.selectedItemIndex = null;
                    }
                },
                calculateItemTotal(item) {
                    let basePrice = item.manualPrice !== undefined ? item.manualPrice : item.prezzo;
                    
                    // Se √® Met√† Pizza o Formato Grande, usa il prezzo calcolato dalla logica apposita
                    if (item.isHalfPizza) {
                        // Prezzo base pizza (maggiore tra i due gusti, se non c'√® prezzo manuale)
                        const gusto1Price = this.filteredPizzaGusti.find(p => p.nome === item.gusto1)?.prezzo || 0;
                        const gusto2Price = this.filteredPizzaGusti.find(p => p.nome === item.gusto2)?.prezzo || 0;
                        basePrice = item.manualPrice !== undefined ? item.manualPrice : Math.max(gusto1Price, gusto2Price);

                        const modCost1 = item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        const modCost2 = item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                        return basePrice + modCost1 + modCost2;
                    } 
                    
                    if (item.isMeter) {
                        // Il prezzo base √® gi√† nel campo 'prezzo' dell'oggetto meter (come prezzoBase)
                        basePrice = item.manualPrice !== undefined ? item.manualPrice : item.prezzo; 
                        
                        const modCost = item.gusti.reduce((total, gusto) => {
                            return total + gusto.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }, 0);
                        return basePrice + modCost;
                    }

                    // Articoli standard: aggiunge il costo dei modificatori
                    const modCost = item.modifiers ? item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    return basePrice + modCost;
                },
                addExtra(modifier) {
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo nel carrello.");
                        return;
                    }

                    const item = this.order[this.selectedItemIndex];
                    if (item.isMeter || item.isHalfPizza) {
                        alert("Usa il Modale di Composizione per aggiungere modificatori a questo formato.");
                        return;
                    }
                    
                    // Evita duplicati di modificatori senza prezzo (Es. Senza)
                    const existingModIndex = item.modifiers.findIndex(m => m.nome === modifier.nome);
                    if (existingModIndex !== -1) {
                         if (modifier.prezzo === 0) {
                            // Rimuovi se √® un duplicato a costo zero (es. doppia "Senza Cipolla")
                            item.modifiers.splice(existingModIndex, 1);
                        } else {
                            // Permetti duplicati con prezzo (es. doppio Prosciutto)
                            item.modifiers.push({ ...modifier });
                        }
                    } else {
                        item.modifiers.push({ ...modifier });
                    }
                },

                // --- Funzioni Composizione Met√† Pizza ---
                openHalfPizzaModal() {
                    this.tempHalfPizzaItem = {
                        id: 0, nome: 'Pizza Met√†/Met√†', prezzoBase: 0, 
                        gusto1: null, modifiers1: [],
                        gusto2: null, modifiers2: [],
                        activeHalf: 1, 
                    };
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Aggiunte';
                    this.showHalfPizzaModal = true;
                },
                selectHalfPizzaGusto(half, gustoName) {
                    if (half === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                    } else if (half === 2) {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                },
                addHalfPizzaModifier(half, modifier) {
                    const targetModifiers = half === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    
                    const existingModIndex = targetModifiers.findIndex(m => m.nome === modifier.nome);
                    if (existingModIndex !== -1) {
                        if (modifier.prezzo === 0) {
                            targetModifiers.splice(existingModIndex, 1);
                        } else {
                            targetModifiers.push({ ...modifier });
                        }
                    } else {
                        targetModifiers.push({ ...modifier });
                    }
                },
                addHalfPizzaToOrder() {
                    if (!this.isHalfPizzaValid) {
                        alert("Devi selezionare un gusto per entrambe le met√†.");
                        return;
                    }

                    // Trova l'ID della pizza pi√π costosa tra i due gusti per l'ID base
                    const pizza1 = this.filteredPizzaGusti.find(p => p.nome === this.tempHalfPizzaItem.gusto1);
                    const pizza2 = this.filteredPizzaGusti.find(p => p.nome === this.tempHalfPizzaItem.gusto2);
                    const baseItem = (pizza1 && pizza2) ? (pizza1.prezzo >= pizza2.prezzo ? pizza1 : pizza2) : null;
                    
                    const finalItem = {
                        id: baseItem ? baseItem.id : 0, // Usa l'ID del gusto pi√π costoso come riferimento
                        nome: this.tempHalfPizzaItem.nome,
                        prezzo: this.calculateTempHalfPizzaTotal, // Prezzo ricalcolato al momento dell'aggiunta
                        isHalfPizza: true,
                        gusto1: this.tempHalfPizzaItem.gusto1,
                        modifiers1: this.tempHalfPizzaItem.modifiers1,
                        gusto2: this.tempHalfPizzaItem.gusto2,
                        modifiers2: this.tempHalfPizzaItem.modifiers2,
                    };

                    this.order.push(finalItem);
                    this.cancelHalfPizzaComposition();
                    this.selectItem(this.order.length - 1);
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = {
                        id: 0, nome: 'Pizza Met√†/Met√†', prezzoBase: 0, 
                        gusto1: null, modifiers1: [],
                        gusto2: null, modifiers2: [],
                        activeHalf: 0,
                    };
                },

                // --- Funzioni Composizione Formati Grandi (Mezzo Metro/Schiacciata) ---
                initializeMeterGusti(num) {
                    const names = num === 3 ? ['1/3', '2/3', '3/3'] : ['1/2', '2/2'];
                    const initialGusti = [];
                    for (let i = 0; i < num; i++) {
                        initialGusti.push({ name: names[i], gusto: null, modifiers: [] });
                    }
                    return initialGusti;
                },
                openMeterModal(item) {
                    this.tempMeterItem = {
                        id: item.id,
                        nome: item.nome,
                        prezzoBase: item.prezzo,
                        isMeter: true,
                        numGusti: item.numGusti,
                        gusti: this.initializeMeterGusti(item.numGusti),
                    };
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Aggiunte';
                    this.showMeterModal = true;
                },
                setMeterGusti(num) {
                    // Questa funzione permette di cambiare il numero di gusti, resetta i gusti correnti
                    this.tempMeterItem.numGusti = num;
                    this.tempMeterItem.gusti = this.initializeMeterGusti(num);
                },
                selectMeterGusto(index, gustoName) {
                    if (index >= 0 && index < this.tempMeterItem.gusti.length) {
                        this.tempMeterItem.gusti[index].gusto = gustoName;
                    }
                },
                addMeterModifier(index, modifier) {
                    if (index >= 0 && index < this.tempMeterItem.gusti.length) {
                        const targetModifiers = this.tempMeterItem.gusti[index].modifiers;
                        
                        const existingModIndex = targetModifiers.findIndex(m => m.nome === modifier.nome);
                        if (existingModIndex !== -1) {
                            if (modifier.prezzo === 0) {
                                targetModifiers.splice(existingModIndex, 1);
                            } else {
                                targetModifiers.push({ ...modifier });
                            }
                        } else {
                            targetModifiers.push({ ...modifier });
                        }
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert("Devi selezionare un gusto per tutte le sezioni.");
                        return;
                    }

                    const finalItem = {
                        ...this.tempMeterItem, // Copia tutti i dati temporanei
                        prezzo: this.tempMeterItem.prezzoBase, // Mantiene il prezzo base per la visualizzazione
                        modifiers: [], // Modificatori standard non usati qui
                    };

                    this.order.push(finalItem);
                    this.cancelMeterComposition();
                    this.selectItem(this.order.length - 1);
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = {
                        id: 0, nome: '', prezzoBase: 0, isMeter: true, numGusti: 0, gusti: [],
                    };
                },
                // --- Funzioni Ordine Corrente: Modifiche Aggiuntive ---
                openPriceEditModal(index) {
                    if (this.order[index].isMeter || this.order[index].isHalfPizza) {
                        alert("La modifica manuale del prezzo √® disabilitata per le composizioni complesse.");
                        return;
                    }
                    this.tempPriceEditIndex = index;
                    this.newPriceValue = this.order[index].manualPrice !== undefined 
                                         ? this.order[index].manualPrice 
                                         : this.calculateItemTotal(this.order[index]);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        // Salva il prezzo manuale
                        this.order[this.tempPriceEditIndex].manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                        this.order[this.tempPriceEditIndex].notes = (this.order[this.tempPriceEditIndex].notes || '') + ' [Prezzo Modificato Man.]';
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0;
                    } else {
                        alert("Prezzo non valido.");
                    }
                },
                cancelPriceEdit() {
                    this.showPriceEditModal = false;
                    this.tempPriceEditIndex = null;
                    this.newPriceValue = 0;
                },

                // --- Gestione Modificatori e Preferiti (NUOVO) ---
                addToFavorites(id, type) {
                    const favoritesArray = type === 'item' ? this.operatorFavorites.items : this.operatorFavorites.modifiers;
                    
                    if (favoritesArray.includes(id)) {
                        favoritesArray.splice(favoritesArray.indexOf(id), 1);
                    } else {
                        if (favoritesArray.length >= 10) {
                            alert(`Puoi aggiungere al massimo 10 ${type === 'item' ? 'articoli' : 'modificatori'} preferiti.`);
                            return;
                        }
                        favoritesArray.push(id);
                    }
                    this.saveData();
                },
                isFavorite(id, type) {
                    const favoritesArray = type === 'item' ? this.operatorFavorites.items : this.operatorFavorites.modifiers;
                    return favoritesArray.includes(id);
                },
                
                // --- Gestione Capacit√† e Orari ---
                updateDeliveryCost() {
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    this.deliveryCost = zone ? zone.price : 0.00;
                },
                updateCapacityWarning() {
                    if (!this.hour || !this.date) {
                        this.orderCapacity = { interval: null, total: 0, remaining: this.capacitySettings.maxPizzas, warning: false, estimatedWaitTime: 0 };
                        return;
                    }

                    const checkTime = new Date(`${this.date}T${this.hour}`);
                    
                    // Controlla gli ordini attivi per la fascia oraria di 30 minuti (o intervallo definito)
                    let totalPizzasInInterval = 0;
                    const intervalMs = this.capacitySettings.intervalMinutes * 60 * 1000;
                    
                    this.activeOrders.forEach(order => {
                        const orderTime = new Date(`${order.date}T${order.hour}`);
                        if (Math.abs(orderTime.getTime() - checkTime.getTime()) < intervalMs / 2) {
                            totalPizzasInInterval += this.calculatePizzasInOrder(order);
                        }
                    });

                    // Calcola le pizze nell'ordine attuale (aggiunte come carico futuro)
                    totalPizzasInInterval += this.pizzasInCurrentOrder;

                    const maxPizzas = this.capacitySettings.maxPizzas;
                    const remaining = maxPizzas - totalPizzasInInterval;
                    
                    this.orderCapacity.total = totalPizzasInInterval;
                    this.orderCapacity.remaining = Math.max(0, remaining);
                    this.orderCapacity.warning = totalPizzasInInterval > maxPizzas * 0.7; // Warning al 70%
                    
                    // Nuovo: Calcolo Stima Tempo di Attesa
                    if (totalPizzasInInterval > maxPizzas) {
                        this.orderCapacity.estimatedWaitTime = this.capacitySettings.intervalMinutes + 10; // Extra tempo
                    } else if (totalPizzasInInterval > maxPizzas * 0.9) {
                        this.orderCapacity.estimatedWaitTime = this.capacitySettings.intervalMinutes;
                    } else {
                        this.orderCapacity.estimatedWaitTime = Math.round((totalPizzasInInterval / maxPizzas) * this.capacitySettings.intervalMinutes * 0.7);
                    }
                },
                calculatePizzasInOrder(order) {
                    return order.order.reduce((count, item) => {
                        const catName = this.getCategoryNameByItemName(item.nome);
                        if (catName === 'Pizza Classica' || catName === 'Pizze Speciali') {
                            count += 1;
                        } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                            count += 4; 
                        } else if (item.isHalfPizza) {
                            count += 1; 
                        } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                            count += 2; 
                        }
                        return count;
                    }, 0);
                },
                
                // --- Finalizzazione Ordine ---
                validateOrderData() {
                    const errors = [];
                    if (this.order.length === 0) errors.push("L'ordine √® vuoto.");
                    if (!this.date || !this.hour) errors.push("Seleziona data e ora di ritiro/consegna.");
                    
                    if (this.mode === 'asporto' || this.mode === 'consegna') {
                        if (!this.customer) errors.push("Nome Cliente √® obbligatorio.");
                        if (!this.phone) errors.push("Telefono Cliente √® obbligatorio.");
                    }
                    if (this.mode === 'consegna') {
                        if (!this.address || !this.streetNumber) errors.push("Indirizzo completo (Via e Civico) √® obbligatorio.");
                        if (!this.zoneName) errors.push("Seleziona una Zona di Consegna.");
                        if (!this.drivers.includes(this.selectedDriver)) errors.push("Assegna un Fattorino.");
                    }
                    
                    if (errors.length > 0) {
                        alert("ATTENZIONE: Correggi i seguenti errori:\n" + errors.join('\n'));
                        return false;
                    }
                    
                    // Blocco Orari di Chiusura (NUOVO)
                    const orderTime = new Date(`${this.date}T${this.hour}`);
                    const today = new Date();
                    
                    // 1. Controlla il giorno di chiusura
                    if (this.businessHours.closedDays.includes(orderTime.getDay())) {
                        alert(`Giorno di chiusura: La pizzeria √® chiusa di ${orderTime.toLocaleDateString('it-IT', { weekday: 'long' })}.`);
                        return false;
                    }
                    
                    // 2. Controlla orario
                    const timeString = this.hour; // Es. "19:30"
                    const [hour, minute] = timeString.split(':').map(Number);
                    
                    const openTime = this.businessHours.openTime;
                    const closeTime = this.businessHours.closeTime;

                    const isToday = orderTime.toDateString() === today.toDateString();
                    
                    if (isToday) {
                        // Se l'orario √® nel passato e non √® ancora passato l'orario di chiusura
                        if (orderTime < today && today.getHours() < parseInt(closeTime.split(':')[0], 10)) {
                             // Ignora se l'ordine √® per ora (entro i prossimi 5 minuti)
                            if ((orderTime.getTime() - today.getTime()) / 60000 < -5) {
                                alert("L'orario selezionato √® gi√† passato.");
                                return false;
                            }
                        }
                        
                        // Controlla se l'orario √® fuori dall'intervallo di apertura odierno
                        if (timeString < openTime || timeString > closeTime) {
                            alert(`Orario non valido. Orario di apertura: ${openTime} - ${closeTime}.`);
                            return false;
                        }
                    }

                    // 3. Controlla la capacit√†
                    if (this.isCapacityFull && this.orderCapacity.remaining <= 0) {
                        alert(`Siamo al completo per le ${this.hour}. Suggerire orario alternativo. Tempo di attesa stimato: ${this.orderCapacity.estimatedWaitTime} minuti.`);
                        return false;
                    }
                    
                    return true;
                },
                confirmOrder() {
                    if (!this.validateOrderData()) {
                        return;
                    }

                    const now = new Date();
                    const finalOrder = {
                        id: ++this.lastOrderId,
                        order: JSON.parse(JSON.stringify(this.order)),
                        total: this.total,
                        mode: this.mode,
                        customer: this.customer.trim(),
                        phone: this.phone.trim(),
                        address: this.address.trim(),
                        streetNumber: this.streetNumber.trim(),
                        town: this.town.trim(),
                        tableNumber: this.tableNumber.trim(),
                        carPlate: this.carPlate.trim(),
                        notes: this.notes.trim(),
                        date: this.date,
                        hour: this.hour,
                        deliveryCost: this.deliveryCost,
                        zoneName: this.zoneName,
                        driver: this.selectedDriver,
                        timestamp: now.toISOString(),
                        status: 'Nuovo', // Nuovo, In Preparazione, Pronto/In Consegna, Completato/Ritirato
                        paymentMethod: this.paymentMethod, // Nuovo
                        accontoRicevuto: this.accontoRicevuto,
                        discountAmount: this.discountAmount,
                        discountType: this.discountType,
                    };
                    
                    this.activeOrders.push(finalOrder);
                    
                    // Salva lo storico del cliente (NUOVO)
                    if (this.customer && this.phone) {
                        this.saveCustomerHistory(finalOrder);
                    }
                    
                    this.resetOrderForm();
                    this.saveData(); 
                },
                saveCustomerHistory(order) {
                    let existingCustomerIndex = this.customerHistory.findIndex(c => 
                        c.phone === order.phone.trim() || (c.customer === order.customer.trim() && c.address === order.address.trim())
                    );

                    const historyItem = {
                        customer: order.customer.trim(),
                        phone: order.phone.trim(),
                        address: order.address.trim(),
                        streetNumber: order.streetNumber.trim(),
                        town: order.town.trim(),
                        notes: order.notes.trim(), // Salva l'ultima nota usata
                        lastOrderDate: order.timestamp,
                    };

                    if (existingCustomerIndex !== -1) {
                        // Aggiorna
                        Object.assign(this.customerHistory[existingCustomerIndex], historyItem);
                    } else {
                        // Nuovo
                        this.customerHistory.push(historyItem);
                    }
                    // Limita la cronologia per evitare un array troppo grande
                    if (this.customerHistory.length > 500) {
                        this.customerHistory.sort((a, b) => new Date(b.lastOrderDate) - new Date(a.lastOrderDate));
                        this.customerHistory.splice(500); 
                    }
                },
                resetOrderForm() {
                    this.order = [];
                    this.showModal = false;
                    this.selectedItemIndex = null;
                    this.mode = 'banco';
                    this.customer = '';
                    this.phone = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.tableNumber = '';
                    this.carPlate = '';
                    this.notes = '';
                    this.deliveryCost = 0.00;
                    this.zoneName = '';
                    this.selectedDriver = '';
                    this.accontoRicevuto = 0.00;
                    this.paymentMethod = 'contanti';
                    this.discountAmount = 0.00;
                    this.discountType = 'fixed';

                    // Imposta data e ora predefinite al momento della pressione
                    const now = new Date();
                    this.date = now.toISOString().slice(0, 10);
                    // Arrotonda all'intervallo di 5 minuti successivo (es. 19:12 -> 19:15)
                    const minutes = now.getMinutes();
                    const roundedMinutes = Math.ceil(minutes / 5) * 5; 
                    now.setMinutes(roundedMinutes);
                    this.hour = now.toTimeString().slice(0, 5); 
                    
                    this.updateCapacityWarning(); // Aggiorna il check capacit√† dopo il reset
                },

                // --- Funzioni Cliente (NUOVO) ---
                filterCustomers() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory.filter(c => 
                        c.customer.toLowerCase().includes(term) ||
                        c.phone.includes(term) ||
                        c.address.toLowerCase().includes(term)
                    ).slice(0, 5); // Mostra al massimo 5 suggerimenti
                },
                selectCustomerSuggestion(customerData) {
                    this.customer = customerData.customer;
                    this.phone = customerData.phone;
                    this.address = customerData.address;
                    this.streetNumber = customerData.streetNumber;
                    this.town = customerData.town;
                    this.notes = customerData.notes; // Recupera l'ultima nota
                    this.filteredCustomerSuggestions = [];
                    // Aggiorna il costo di consegna in base all'indirizzo se necessario
                    this.updateDeliveryCost();
                },
                
                // --- Funzioni Ordini Attivi ---
                markOrderReady(order) {
                    if (order.status === 'Pronto/In Consegna') {
                        order.status = 'In Preparazione';
                    } else {
                        order.status = 'Pronto/In Consegna';
                        if (order.mode === 'consegna') {
                            // Avviso di assegnazione fattorino se non √® stato fatto
                            if (!order.driver) {
                                alert(`ATTENZIONE: Ordine ${order.id} pronto! Assegna un fattorino.`);
                            }
                        }
                    }
                    this.saveData();
                },
                markOrderCompleted(order) {
                    order.status = 'Completato/Ritirato';
                    this.activeOrders = this.activeOrders.filter(o => o.id !== order.id);
                    this.archive.push(order); // Sposta nell'archivio
                    this.saveData();
                },
                editActiveOrder(order) {
                    // Imposta i dati dell'ordine per la modifica
                    this.order = JSON.parse(JSON.stringify(order.order));
                    this.editingOrderId = order.id;
                    this.mode = order.mode;
                    this.customer = order.customer;
                    this.phone = order.phone;
                    this.address = order.address;
                    this.streetNumber = order.streetNumber;
                    this.town = order.town;
                    this.tableNumber = order.tableNumber;
                    this.carPlate = order.carPlate;
                    this.date = order.date;
                    this.hour = order.hour;
                    this.notes = order.notes;
                    this.deliveryCost = order.deliveryCost;
                    this.zoneName = order.zoneName;
                    this.selectedDriver = order.driver;
                    this.accontoRicevuto = order.accontoRicevuto;
                    this.paymentMethod = order.paymentMethod || 'contanti';
                    this.discountAmount = order.discountAmount || 0.00;
                    this.discountType = order.discountType || 'fixed';

                    this.showModal = true;
                },
                updateOrder() {
                    if (!this.validateOrderData()) {
                        return;
                    }
                    const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                    if (index !== -1) {
                        const updatedOrder = {
                            ...this.activeOrders[index],
                            order: JSON.parse(JSON.stringify(this.order)),
                            total: this.total,
                            mode: this.mode,
                            customer: this.customer.trim(),
                            phone: this.phone.trim(),
                            address: this.address.trim(),
                            streetNumber: this.streetNumber.trim(),
                            town: this.town.trim(),
                            tableNumber: this.tableNumber.trim(),
                            carPlate: this.carPlate.trim(),
                            notes: this.notes.trim(),
                            date: this.date,
                            hour: this.hour,
                            deliveryCost: this.deliveryCost,
                            zoneName: this.zoneName,
                            driver: this.selectedDriver,
                            paymentMethod: this.paymentMethod,
                            accontoRicevuto: this.accontoRicevuto,
                            discountAmount: this.discountAmount,
                            discountType: this.discountType,
                        };
                        this.activeOrders.splice(index, 1, updatedOrder);
                        this.saveCustomerHistory(updatedOrder); // Aggiorna storico cliente
                        this.editingOrderId = null;
                        this.resetOrderForm();
                        this.saveData();
                    }
                },
                cancelEdit() {
                    this.editingOrderId = null;
                    this.resetOrderForm();
                },

                // --- Funzioni Storico (Archivio) ---
                calculateDriverStats() {
                    let totalOrders = 0;
                    let totalRevenue = 0;
                    
                    this.filteredArchive.forEach(o => {
                        if (o.driver === this.selectedDriver) {
                            totalOrders++;
                            totalRevenue += o.total;
                        }
                    });

                    this.driverStats = { totalOrders, totalRevenue };
                },
                exportArchive() {
                    const data = JSON.stringify(this.archive);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `archivio_ordini_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('Archivio esportato con successo!');
                },
                clearArchive() {
                    if (this.isOwner && confirm("SEI SICURO DI VOLER CANCELLARE TUTTO L'ARCHIVIO STORICO? Questa operazione √® IRREVERSIBILE!")) {
                        this.archive = [];
                        this.lastOrderId = 0;
                        this.saveData();
                        alert('Archivio storico cancellato.');
                    } else if (!this.isOwner) {
                        alert('Accesso negato. Solo il Titolare pu√≤ eseguire questa operazione.');
                    }
                },
                
                // --- Funzione Stampa/Condivisione (Modal) ---
                openShareModal(order) {
                    this.selectedOrderForShare = order;
                    this.showShareModal = true;
                },
                closeShareModal() {
                    this.showShareModal = false;
                    this.selectedOrderForShare = null;
                },
                printOrder() {
                    const printContent = document.getElementById('print-content');
                    if (printContent) {
                        const originalContents = document.body.innerHTML;
                        const printWindow = window.open('', '_blank', 'height=600,width=800');
                        printWindow.document.write('<html><head><title>Comanda Ordine</title>');
                        // Potresti voler includere qui i CSS per la stampa
                        printWindow.document.write('<style>body { font-family: monospace; font-size: 10pt; }</style>');
                        printWindow.document.write('</head><body>');
                        printWindow.document.write(printContent.innerHTML);
                        printWindow.document.write('</body></html>');
                        printWindow.document.close();
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }
                },
                
                // Funzioni di Inizializzazione
                mounted() {
                    this.loadData();
                    // Setta l'ora/data al mount
                    this.resetOrderForm();
                    if (!this.isAccessGranted) {
                        this.view = 'login';
                    }
                }
            }
        });
        
        // --- Componente per la Stampa/Comanda ---
        app.component('order-print', {
            props: ['order', 'calculateItemTotal', 'getModifierCategory', 'getModifierIcon'],
            template: `
                <div id="print-content" class="p-4" style="width: 300px; margin: 0 auto; border: 1px dashed black;">
                    <h2 class="text-xl font-bold text-center mb-4">La Tua Pizzeria Smart</h2>
                    <hr class="mb-2 border-dashed border-black">
                    
                    <p class="font-bold">Ordine #{{ order.id }} ({{ order.mode.toUpperCase() }})</p>
                    <p>Ora: {{ order.hour }} del {{ order.date.split('-').reverse().join('/') }}</p>
                    <p v-if="order.tableNumber">Tavolo: {{ order.tableNumber }}</p>
                    
                    <div v-if="order.mode !== 'banco'" class="mt-3">
                        <p class="font-bold">Cliente: {{ order.customer }}</p>
                        <p v-if="order.phone">Tel: {{ order.phone }}</p>
                        <p v-if="order.address">Indirizzo: {{ order.address }} {{ order.streetNumber }} ({{ order.zoneName }})</p>
                        <p v-if="order.carPlate">Targa Ritiro: {{ order.carPlate }}</p>
                        <p v-if="order.driver">Fattorino: {{ order.driver }}</p>
                    </div>
                    
                    <hr class="mb-2 mt-2 border-dashed border-black">
                    <p class="font-bold">Articoli:</p>
                    <div v-for="(item, index) in order.order" :key="index" class="mb-2 border-b border-dashed border-gray-400 pb-1">
                        <p class="font-semibold">{{ item.nome }} <span class="float-right font-normal">‚Ç¨{{ calculateItemTotal(item).toFixed(2) }}</span></p>
                        
                        <div v-if="item.isMeter || item.isHalfPizza">
                            <div v-if="item.isHalfPizza" class="ml-2 text-sm">
                                <p>1/2: {{ item.gusto1 }} <span v-if="item.modifiers1.length">({{ item.modifiers1.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span></p>
                                <p>2/2: {{ item.gusto2 }} <span v-if="item.modifiers2.length">({{ item.modifiers2.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span></p>
                            </div>
                            <div v-else-if="item.isMeter" class="ml-2 text-sm">
                                <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                    <p>{{ gusto.name }}: {{ gusto.gusto }} 
                                        <span v-if="gusto.modifiers.length">({{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else-if="item.modifiers && item.modifiers.length" class="ml-2 text-sm">
                            <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}<span v-if="mod.prezzo > 0"> (+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span><span v-if="mIndex < item.modifiers.length - 1">,</span>
                            </span>
                        </div>

                    </div>
                    
                    <hr class="mb-2 mt-2 border-dashed border-black">

                    <p v-if="order.deliveryCost > 0">Consegna: <span class="float-right">‚Ç¨{{ order.deliveryCost.toFixed(2) }}</span></p>
                    <p v-if="order.discountAmount > 0">Sconto ({{ order.discountType === 'percent' ? order.discountAmount + '%' : 'fisso' }}): <span class="float-right font-bold text-red-600">- ‚Ç¨{{ (order.total - (order.total - (order.total * (order.discountType === 'percent' ? order.discountAmount / 100 : 0)) - (order.discountType === 'fixed' ? order.discountAmount : 0) ) ).toFixed(2) }}</span></p>
                    <p class="text-xl font-bold mt-2">TOTALE: <span class="float-right">‚Ç¨{{ order.total.toFixed(2) }}</span></p>
                    <p class="mt-1 text-sm">Pagamento: {{ order.paymentMethod.toUpperCase() }}</p>

                    <div v-if="order.notes" class="mt-3 p-1 border border-black border-dashed">
                        <p class="font-bold text-sm">NOTE: {{ order.notes }}</p>
                    </div>

                    <p class="text-center mt-4 text-xs">Grazie per aver scelto La Tua Pizzeria Smart!</p>
                </div>
            `
        });
        
        // --- Componente per la CUCINA (KDS) (Nuovo) ---
        app.component('kitchen-display', {
            props: ['activeOrders', 'calculateItemTotal', 'getModifierCategory', 'getModifierIcon', 'markOrderReady', 'markOrderCompleted'],
            template: `
                <div class="p-4">
                    <h1 class="text-2xl font-bold mb-4 text-white">Comande per la Cucina (KDS)</h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div v-for="order in activeOrders" :key="order.id" 
                            :class="[
                                'p-4 rounded-lg shadow-lg text-white border-4',
                                order.status === 'Pronto/In Consegna' ? 'bg-green-700 border-green-400' : 
                                order.status === 'In Preparazione' ? 'bg-yellow-600 border-yellow-300' : 'bg-red-700 border-red-300',
                                { 'animate-pulse': order.status === 'Nuovo' } 
                            ]">
                            
                            <div class="flex justify-between items-center mb-3 border-b pb-2">
                                <h3 class="text-xl font-bold">Ordine #{{ order.id }}</h3>
                                <div class="text-lg font-semibold">{{ order.hour }} ({{ order.mode.toUpperCase().slice(0, 1) }})</div>
                            </div>

                            <p class="text-lg font-semibold">Cliente: {{ order.customer || 'BANCO' }}</p>
                            <p v-if="order.tableNumber" class="text-lg font-semibold">Tavolo: {{ order.tableNumber }}</p>
                            <p v-if="order.address" class="text-sm">{{ order.address }} {{ order.streetNumber }}</p>
                            <p v-if="order.notes" class="mt-2 p-1 bg-black bg-opacity-30 rounded text-sm">Note: {{ order.notes }}</p>

                            <hr class="my-3 border-dashed border-white border-opacity-50">

                            <div v-for="(item, itemIndex) in order.order" :key="itemIndex" class="mb-2">
                                <p class="font-bold text-xl">{{ item.nome }}</p>
                                
                                <div v-if="item.isMeter || item.isHalfPizza" class="ml-2 text-sm">
                                    <div v-if="item.isHalfPizza">
                                        <p>1/2: {{ item.gusto1 }} <span v-if="item.modifiers1.length" class="text-yellow-100">({{ item.modifiers1.map(m => m.nome).join(', ') }})</span></p>
                                        <p>2/2: {{ item.gusto2 }} <span v-if="item.modifiers2.length" class="text-yellow-100">({{ item.modifiers2.map(m => m.nome).join(', ') }})</span></p>
                                    </div>
                                    <div v-else-if="item.isMeter">
                                        <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                            <p>{{ gusto.name }}: {{ gusto.gusto }} 
                                                <span v-if="gusto.modifiers.length" class="text-yellow-100">({{ gusto.modifiers.map(m => m.nome).join(', ') }})</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else-if="item.modifiers && item.modifiers.length" class="ml-2 text-sm text-yellow-100">
                                    <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                        {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}
                                    </span>
                                </div>
                            </div>
                            
                            <hr class="my-3 border-dashed border-white border-opacity-50">

                            <div class="flex justify-between space-x-2">
                                <button @click.stop="markOrderReady(order)"
                                    :class="[
                                        'px-3 py-2 rounded font-bold transition duration-150',
                                        order.status === 'Pronto/In Consegna' ? 'bg-red-400 hover:bg-red-500' : 'bg-yellow-400 hover:bg-yellow-500 text-black'
                                    ]">
                                    {{ order.status === 'Pronto/In Consegna' ? 'RIMETTI IN PREP.' : 'MARCA PRONTO' }}
                                </button>
                                <button @click.stop="markOrderCompleted(order)" class="px-3 py-2 bg-gray-400 hover:bg-gray-500 rounded font-bold text-black transition duration-150">
                                    COMPLETA
                                </button>
                            </div>
                        </div>
                    </div>
                    <p v-if="!activeOrders.length" class="text-center text-gray-500 mt-10 text-xl">Nessun ordine attivo per la preparazione.</p>
                </div>
            `
        });

        app.mount('#app');
    </script>
    <div id="app" class="h-screen flex flex-col bg-gray-100 font-sans">
        
        <header v-if="view !== 'login' && view !== 'cucina'" class="bg-gray-800 text-white shadow-lg p-3 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold tracking-wider">üçï Pizzeria Smart</h1>
            <nav class="flex space-x-4">
                <button @click="view = 'inserimento'" :class="{'bg-gray-700': view === 'inserimento'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Nuovo Ordine</button>
                <button v-if="isAdmin" @click="view = 'ordini'" :class="{'bg-gray-700': view === 'ordini'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Ordini Attivi</button>
                <button v-if="isOwner" @click="view = 'storico'" :class="{'bg-gray-700': view === 'storico'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Storico/Statistiche</button>
                <button v-if="isOwner" @click="view = 'impostazioni'" :class="{'bg-gray-700': view === 'impostazioni'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Impostazioni</button>
                <button v-if="isAdmin" @click="view = 'cucina'" class="px-3 py-2 rounded transition duration-150 bg-red-600 hover:bg-red-700 font-bold">CUCINA</button>
            </nav>
            <div class="flex items-center space-x-3">
                <span v-if="isAdmin" class="text-sm">Accesso: <span class="font-bold">{{ userRole.toUpperCase() }}</span></span>
                <button v-if="isAdmin" @click="logout" class="px-3 py-2 bg-red-500 rounded hover:bg-red-600 transition duration-150">Logout</button>
                <button v-else @click="view = 'login'" class="px-3 py-2 bg-green-500 rounded hover:bg-green-600 transition duration-150">Login</button>
            </div>
        </header>

        <main v-if="view === 'login'" class="flex-grow flex items-center justify-center bg-gray-900">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Accesso Sistema POS</h2>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="grantAccess" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">Accedi</button>
            </div>
        </main>

        <main v-else-if="view === 'cucina'" class="flex-grow bg-gray-900">
            <div class="flex justify-between items-center p-4 bg-gray-800 text-white sticky top-0 z-10">
                <h1 class="text-3xl font-bold">Display Cucina (KDS)</h1>
                <button @click="view = 'ordini'" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Torna a Ordini Attivi</button>
            </div>
            <kitchen-display 
                :activeOrders="filteredActiveOrders" 
                :calculateItemTotal="calculateItemTotal" 
                :getModifierCategory="getModifierCategory" 
                :getModifierIcon="getModifierIcon" 
                :markOrderReady="markOrderReady"
                :markOrderCompleted="markOrderCompleted">
            </kitchen-display>
        </main>

        <main v-else class="flex-grow flex overflow-hidden">
            
            <div v-if="view === 'inserimento'" class="w-2/5 p-4 bg-white border-r border-gray-200 flex flex-col">
                
                <div class="flex-shrink-0 mb-4">
                    <input type="text" v-model="searchTerm" placeholder="Cerca pizza, bevanda..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 mb-2">
                    
                    <div class="flex space-x-2 overflow-x-auto pb-2">
                        <button v-for="(items, category) in menu" :key="category" 
                                @click="activeCat = category; searchTerm = ''" 
                                :class="{'bg-red-600 text-white': activeCat === category, 'bg-gray-200 text-gray-700': activeCat !== category}"
                                class="flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm transition duration-150 hover:bg-red-500 hover:text-white">
                            {{ category }}
                        </button>
                        <button @click="openHalfPizzaModal" class="flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm transition duration-150 bg-purple-600 text-white hover:bg-purple-700">
                            1/2 Pizza
                        </button>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto pr-2 mb-4">
                    <div v-if="!searchTerm" class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h3 class="text-sm font-bold mb-2 text-yellow-800">‚≠ê I Tuoi Preferiti (Click Singolo)</h3>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="id in operatorFavorites.items" :key="'fav-' + id" 
                                    @click="handleItemClick(findMenuItemById(id))"
                                    :class="{'opacity-50 cursor-not-allowed': findMenuItemById(id)?.isFinished}"
                                    class="px-3 py-1 text-xs bg-yellow-400 text-yellow-900 rounded-full font-semibold hover:bg-yellow-500 transition duration-150">
                                {{ findMenuItemById(id)?.nome }}
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold mb-3">{{ activeCat }} ({{ filteredAvailableItems.length }})</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button v-for="item in filteredAvailableItems" :key="item.id" 
                                @click="handleItemClick(item)" 
                                :disabled="item.isFinished"
                                :class="{
                                    'bg-green-100 border-green-400 hover:bg-green-200': item.prezzo < 8 && !item.isFinished,
                                    'bg-blue-100 border-blue-400 hover:bg-blue-200': item.prezzo >= 8 && !item.isFinished,
                                    'opacity-50 cursor-not-allowed bg-gray-200 border-gray-400': item.isFinished,
                                    'bg-purple-100 border-purple-400 hover:bg-purple-200': item.isMeter && !item.isFinished,
                                }"
                                class="p-3 border rounded-lg text-left transition duration-150 relative">
                            <span class="font-bold block">{{ item.nome }}</span>
                            <span class="text-sm text-gray-600">‚Ç¨{{ item.prezzo.toFixed(2) }}</span>
                            
                            <div class="absolute top-1 right-1 flex space-x-1">
                                <span v-if="item.isFinished" class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full">Esaurito</span>
                                <button v-else @click.stop="addToFavorites(item.id, 'item')" 
                                        :class="{'text-yellow-500': isFavorite(item.id, 'item'), 'text-gray-400 hover:text-yellow-500': !isFavorite(item.id, 'item')}" 
                                        class="text-xl leading-none">
                                    ‚≠ê
                                </button>
                            </div>
                        </button>
                    </div>
                    <p v-if="!filteredAvailableItems.length" class="text-center text-gray-500 mt-5">Nessun articolo trovato in {{ activeCat }}.</p>
                </div>
                
                <div v-if="selectedItemIndex !== null && !order[selectedItemIndex].isMeter && !order[selectedItemIndex].isHalfPizza" 
                     class="flex-shrink-0 mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold mb-3">Aggiungi Modificatore ({{ order[selectedItemIndex].nome }})</h3>
                    
                    <div class="flex space-x-2 mb-3 overflow-x-auto">
                        <button v-for="(mods, category) in modifiers" :key="category" 
                                @click="activeModCat = category; modifierSearchTerm = ''"
                                :class="{'bg-red-600 text-white': activeModCat === category, 'bg-gray-200 text-gray-700': activeModCat !== category}"
                                class="flex-shrink-0 px-3 py-1 rounded-lg font-semibold text-xs transition duration-150 hover:bg-red-500 hover:text-white">
                            {{ category }}
                        </button>
                    </div>
                    
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-red-400 mb-3 text-sm">

                    <div v-if="!modifierSearchTerm" class="mb-4 p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h4 class="text-sm font-bold mb-1 text-yellow-800">‚≠ê Modificatori Preferiti</h4>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="id in operatorFavorites.modifiers" :key="'fav-mod-' + id" 
                                    @click="addExtra(findModifierById(id))"
                                    :class="{'opacity-50 cursor-not-allowed': findModifierById(id)?.isFinished}"
                                    class="px-3 py-1 text-xs bg-yellow-400 text-yellow-900 rounded-full font-semibold hover:bg-yellow-500 transition duration-150">
                                {{ findModifierById(id)?.nome }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-1">
                        <button v-for="mod in filteredModifiersForActiveCat" :key="mod.id" 
                                @click="addExtra(mod)" 
                                :class="{'bg-red-100 border-red-400 hover:bg-red-200': activeModCat === 'Senza', 'bg-gray-100 border-gray-400 hover:bg-gray-200': activeModCat !== 'Senza'}"
                                class="p-2 border rounded-lg text-xs font-semibold transition duration-150 relative">
                            {{ getModifierIcon(activeModCat) }} {{ mod.nome }}
                            <span v-if="mod.prezzo > 0" class="block text-gray-600">‚Ç¨{{ mod.prezzo.toFixed(2) }}</span>
                            
                            <button @click.stop="addToFavorites(mod.id, 'modifier')" 
                                    :class="{'text-yellow-500': isFavorite(mod.id, 'modifier'), 'text-gray-400 hover:text-yellow-500': !isFavorite(mod.id, 'modifier')}" 
                                    class="absolute top-0 right-0 p-1 text-xs leading-none">
                                ‚≠ê
                            </button>
                        </button>
                    </div>
                </div>
                <div v-else-if="selectedItemIndex !== null && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza)" 
                     class="flex-shrink-0 mt-4 pt-4 border-t border-gray-200 p-4 bg-red-100 rounded-lg text-sm font-semibold text-red-700">
                    <p><i class="fa-solid fa-triangle-exclamation mr-1"></i> Modificatori disabilitati per le composizioni complesse selezionate. Apri il Modale per la modifica completa.</p>
                </div>

            </div>
            
            <div v-if="view === 'inserimento'" class="w-3/5 p-4 bg-gray-50 flex flex-col">
                ```

---

## Blocco 4/5: Carrello, Riepilogo, Modale Ordine e Viste Secondarie

**Copia e incolla questo blocco subito dopo il commento `` nel blocco 3/5.**

```html
                <div class="flex-grow overflow-y-auto pr-2 mb-4 border border-gray-300 rounded-lg p-3 bg-white">
                    <h2 class="text-xl font-bold mb-3 flex justify-between items-center">
                        Carrello Ordine
                        <button @click="resetOrderForm" v-if="order.length > 0" class="text-sm text-red-600 hover:text-red-800 font-normal">Svuota Carrello</button>
                    </h2>
                    
                    <div v-if="order.length === 0" class="text-center text-gray-500 py-10">Il carrello √® vuoto.</div>
                    
                    <div v-for="(item, index) in order" :key="index"
                         @click="selectItem(index)"
                         :class="{
                             'bg-yellow-100 border-yellow-500': index === selectedItemIndex,
                             'bg-white border-gray-300 hover:bg-gray-50': index !== selectedItemIndex,
                         }"
                         class="p-3 mb-2 rounded-lg border cursor-pointer transition duration-150 relative shadow-sm">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <span class="font-bold block">{{ item.nome }}</span>
                                
                                <div v-if="item.isHalfPizza" class="text-sm ml-2 mt-1">
                                    <span class="font-semibold">1/2:</span> {{ item.gusto1 }} 
                                        <span v-if="item.modifiers1.length" class="text-xs text-gray-600">({{ item.modifiers1.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span><br>
                                    <span class="font-semibold">2/2:</span> {{ item.gusto2 }} 
                                        <span v-if="item.modifiers2.length" class="text-xs text-gray-600">({{ item.modifiers2.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                    <button @click.stop="openHalfPizzaModal(item)" class="text-blue-500 text-xs ml-2 hover:text-blue-700">Modifica Gusti/Mod</button>
                                </div>

                                <div v-else-if="item.isMeter" class="text-sm ml-2 mt-1">
                                    <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                        <span class="font-semibold">{{ gusto.name }}:</span> {{ gusto.gusto }} 
                                        <span v-if="gusto.modifiers.length" class="text-xs text-gray-600">({{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                    </div>
                                    <button @click.stop="openMeterModal(item)" class="text-blue-500 text-xs ml-2 hover:text-blue-700">Modifica Gusti/Mod</button>
                                </div>

                                <div v-else-if="item.modifiers && item.modifiers.length" class="text-sm text-gray-700 mt-1">
                                    <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                        {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}<span v-if="mod.prezzo > 0"> (+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span>
                                    </span>
                                </div>
                                
                                <div v-if="item.manualPrice !== undefined" class="text-xs text-red-600 mt-1">
                                    Prezzo Modificato Man.: ‚Ç¨{{ item.manualPrice.toFixed(2) }}
                                </div>
                            </div>

                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg">‚Ç¨{{ calculateItemTotal(item).toFixed(2) }}</span>
                                
                                <button @click.stop="openPriceEditModal(index)" 
                                        :title="item.isMeter || item.isHalfPizza ? 'Modifica non disponibile' : 'Modifica Prezzo'"
                                        :disabled="item.isMeter || item.isHalfPizza"
                                        :class="{'opacity-50 cursor-not-allowed': item.isMeter || item.isHalfPizza}"
                                        class="text-gray-500 hover:text-blue-500 transition duration-150">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                
                                <button @click.stop="removeItem(index)" class="text-red-500 hover:text-red-700 transition duration-150">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 pt-4 border-t border-gray-300">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-semibold">Totale Parziale:</span>
                        <span class="text-lg font-semibold">‚Ç¨{{ (total - deliveryCost).toFixed(2) }}</span>
                    </div>
                    <div v-if="deliveryCost > 0" class="flex justify-between items-center mb-3 text-sm text-blue-600">
                        <span>Costo Consegna ({{ zoneName }})</span>
                        <span>+ ‚Ç¨{{ deliveryCost.toFixed(2) }}</span>
                    </div>
                    <div v-if="discountAmount > 0" class="flex justify-between items-center mb-3 text-sm text-red-600">
                        <span>Sconto ({{ discountType === 'percent' ? discountAmount + '%' : 'fisso' }}):</span>
                        <span>- ‚Ç¨{{ (subtotal + deliveryCost - calculatedOrderTotal).toFixed(2) }}</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold">TOTALE FINALE:</span>
                        <span class="text-2xl font-bold text-red-600">‚Ç¨{{ total.toFixed(2) }}</span>
                    </div>
                    
                    <button @click="showModal = true" :disabled="order.length === 0"
                            class="w-full bg-red-600 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:bg-red-700 transition duration-200 disabled:bg-gray-400">
                        <i class="fa-solid fa-receipt mr-2"></i> FINALIZZA ORDINE
                    </button>
                    
                    <div v-if="hour && isCapacityWarning" 
                         :class="{'bg-yellow-100 border-yellow-500': !isCapacityFull, 'bg-red-100 border-red-500': isCapacityFull}"
                         class="mt-3 p-2 rounded-lg border text-sm text-center font-semibold">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                        <span v-if="isCapacityFull">ATTENZIONE: Orario {{ hour }} al completo! Tempo di attesa stimato: {{ orderCapacity.estimatedWaitTime }} minuti.</span>
                        <span v-else>Allerta Carico: {{ orderCapacity.total }} pizze per le {{ hour }}. Rimanenti: {{ orderCapacity.remaining }}.</span>
                    </div>
                </div>

            </div>
            
            <div v-else-if="view === 'ordini'" class="w-full p-6 bg-gray-50 flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Ordini Attivi (Totale: {{ filteredActiveOrders.length }})</h2>
                
                <div class="flex space-x-4 mb-4">
                    <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Telefono, Indirizzo o Targa" class="w-1/3 p-2 border border-gray-300 rounded-lg">
                    
                    <select v-model="activeDateFilter" class="p-2 border border-gray-300 rounded-lg">
                        <option value="today">Oggi</option>
                        <option value="tomorrow">Domani</option>
                        <option value="future">Futuro (Dopo Domani)</option>
                    </select>
                </div>

                <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 font-semibold">
                    Totale Comande per Forno: {{ filteredActiveOrders.length }} ordini (Pizze stimate: {{ filteredActiveOrders.reduce((sum, o) => sum + calculatePizzasInOrder(o), 0) }})
                </div>

                <div class="flex-grow overflow-y-auto space-y-4">
                    <div v-for="order in filteredActiveOrders" :key="order.id"
                         :class="[
                             'p-4 rounded-lg shadow-md transition duration-150 relative',
                             order.status === 'Pronto/In Consegna' ? 'bg-green-100 border-l-8 border-green-600' :
                             order.status === 'In Preparazione' ? 'bg-yellow-100 border-l-8 border-yellow-600' :
                             'bg-white border-l-8 border-gray-400',
                             // Evidenzia ordine con fattorino mancante
                             {'border-red-600 animate-pulse-driver': order.status === 'Pronto/In Consegna' && order.mode === 'consegna' && !order.driver }
                         ]">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold">Ordine #{{ order.id }} - {{ order.hour }}</h3>
                                <p class="text-sm text-gray-600">{{ order.date.split('-').reverse().join('/') }} - {{ order.mode.toUpperCase() }}</p>
                                
                                <p class="font-semibold mt-1">{{ order.customer || 'Banco' }} <span v-if="order.tableNumber"> (Tavolo {{ order.tableNumber }})</span></p>
                                <p v-if="order.address" class="text-sm">{{ order.address }} {{ order.streetNumber }}, {{ order.town }} ({{ order.zoneName }})</p>
                                <p v-if="order.phone" class="text-sm">Tel: {{ order.phone }}</p>
                                <p v-if="order.carPlate" class="text-sm font-semibold text-blue-600">Targa: {{ order.carPlate }}</p>

                                <div v-if="order.mode === 'consegna'" class="mt-2 flex items-center space-x-2">
                                    <span class="font-semibold">Fattorino:</span>
                                    <select v-model="order.driver" @change="saveData" class="p-1 border rounded text-sm font-bold"
                                            :class="{'border-red-600 bg-red-200': order.status === 'Pronto/In Consegna' && !order.driver}">
                                        <option value="">ASSEGNA</option>
                                        <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="text-right">
                                <p class="text-3xl font-bold text-red-600">‚Ç¨{{ order.total.toFixed(2) }}</p>
                                <p class="text-sm text-gray-500">{{ order.paymentMethod.toUpperCase() }}</p>
                                <p class="text-xs font-semibold mt-1">Status: {{ order.status }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-sm p-2 bg-gray-100 rounded">
                            <span class="font-semibold">Articoli:</span> {{ order.order.map(i => i.nome).join(', ') }}
                        </div>

                        <div class="mt-3 flex space-x-2 justify-end">
                            <button @click="markOrderReady(order)" 
                                    :class="[
                                        'px-3 py-1 rounded text-sm font-semibold transition duration-150',
                                        order.status === 'Pronto/In Consegna' ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-yellow-500 text-black hover:bg-yellow-600'
                                    ]">
                                {{ order.status === 'Pronto/In Consegna' ? 'RIMETTI IN PREP.' : 'MARCA PRONTO' }}
                            </button>
                            <button @click="openShareModal(order)" class="px-3 py-1 bg-blue-500 text-white rounded text-sm font-semibold hover:bg-blue-600">
                                <i class="fa-solid fa-print"></i> Stampa
                            </button>
                            <button @click="editActiveOrder(order)" class="px-3 py-1 bg-gray-500 text-white rounded text-sm font-semibold hover:bg-gray-600">
                                <i class="fa-solid fa-pen"></i> Modifica
                            </button>
                            <button @click="markOrderCompleted(order)" class="px-3 py-1 bg-green-500 text-white rounded text-sm font-semibold hover:bg-green-600">
                                <i class="fa-solid fa-check"></i> Completa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-else-if="view === 'storico'" class="w-full p-6 bg-gray-50 flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Storico Ordini e Statistiche</h2>
                
                <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-md">
                    <div class="w-1/3">
                        <label class="block text-sm font-medium text-gray-700">Filtra Data:</label>
                        <input type="date" v-model="archiveDateFilter" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-sm font-medium text-gray-700">Filtra Fattorino:</label>
                        <select v-model="selectedDriver" @change="calculateDriverStats" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Tutti</option>
                            <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <div class="w-1/3">
                        <p class="font-bold text-lg">Totale Giornaliero ({{ archiveDateFilterDisplay }}):</p>
                        <p class="text-3xl font-bold text-red-600">‚Ç¨{{ dailyTotal.toFixed(2) }}</p>
                    </div>
                </div>

                <div v-if="selectedDriver" class="mb-4 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-lg font-semibold">
                    <p class="font-bold text-lg">Statistiche per {{ selectedDriver }}:</p>
                    <p>Ordini Consegnati: {{ driverStats.totalOrders }} - Totale Ricavi Gestiti: ‚Ç¨{{ driverStats.totalRevenue.toFixed(2) }}</p>
                </div>

                <div class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <div v-for="order in filteredArchive" :key="order.id" class="p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center">
                            <div class="flex-grow">
                                <h3 class="text-lg font-bold">Ordine #{{ order.id }} - {{ order.hour }} ({{ order.mode.toUpperCase() }})</h3>
                                <p class="text-sm text-gray-600">{{ order.customer || 'Banco' }} - {{ order.address ? order.address + ' ' + order.streetNumber : '' }}</p>
                                <p v-if="order.driver" class="text-xs mt-1">Fattorino: {{ order.driver }}</p>
                                <p class="text-xs mt-1">Articoli: {{ order.order.map(i => i.nome).join(', ') }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">‚Ç¨{{ order.total.toFixed(2) }}</p>
                                <p class="text-sm text-gray-500">{{ order.paymentMethod.toUpperCase() }}</p>
                            </div>
                        </div>
                    </div>
                    <p v-if="!filteredArchive.length" class="text-center text-gray-500 py-10">Nessun ordine archiviato per questa data/filtro.</p>
                </div>
            </div>

            <div v-else-if="view === 'impostazioni'" class="w-full p-6 bg-gray-50 flex flex-col">
                </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Dettagli e Finalizzazione Ordine' }}</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-3/5 space-y-4">
                        <h3 class="text-lg font-semibold mb-2">Modalit√† e Dati Cliente</h3>
                        
                        <div class="flex space-x-2 border p-2 rounded-lg bg-gray-50">
                            <button v-for="m in modes" :key="m.id" @click="mode = m.id"
                                    :class="{'bg-blue-600 text-white hover:bg-blue-700': mode === m.id, 'bg-gray-200 hover:bg-gray-300': mode !== m.id}"
                                    class="flex-1 p-3 rounded-lg font-semibold transition duration-150">
                                <i :class="m.icon" class="mr-2"></i> {{ m.label }}
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Data Ritiro/Consegna</label>
                                <input type="date" v-model="date" :min="minDate" @change="updateCapacityWarning" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ora Ritiro/Consegna</label>
                                <input type="time" v-model="hour" @change="updateCapacityWarning" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div v-if="mode !== 'banco'" class="space-y-4 border p-4 rounded-lg">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700">Nome Cliente*</label>
                                <input type="text" v-model="customer" @input="filterCustomers" placeholder="Nome Cliente" class="w-full p-2 border rounded-lg">
                                <ul v-if="filteredCustomerSuggestions.length" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-xl">
                                    <li v-for="(c, i) in filteredCustomerSuggestions" :key="i" @click="selectCustomerSuggestion(c)"
                                        class="p-2 cursor-pointer hover:bg-blue-100 border-b last:border-b-0 text-sm">
                                        <span class="font-semibold">{{ c.customer }}</span> ({{ c.phone }})<br>
                                        <span class="text-xs text-gray-500">{{ c.address }}</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Telefono*</label>
                                    <input type="tel" v-model="phone" @input="filterCustomers" placeholder="Telefono" class="w-full p-2 border rounded-lg">
                                </div>
                                <div v-if="mode === 'asporto'">
                                    <label class="block text-sm font-medium text-gray-700">Targa Auto (Ritiro)</label>
                                    <input type="text" v-model="carPlate" placeholder="Es. AB123CD" class="w-full p-2 border rounded-lg uppercase">
                                </div>
                                <div v-if="mode === 'banco'">
                                    <label class="block text-sm font-medium text-gray-700">Tavolo/Riferimento</label>
                                    <input type="text" v-model="tableNumber" placeholder="Es. Tavolo 5" class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="mode === 'consegna'" class="space-y-4 border p-4 rounded-lg bg-red-50">
                            <h4 class="font-semibold">Dettagli Consegna</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Via/Piazza*</label>
                                    <input type="text" v-model="address" @input="filterCustomers" placeholder="Via/Piazza" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Civico/Scala*</label>
                                    <input type="text" v-model="streetNumber" placeholder="Civico/Int." class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Zona di Consegna*</label>
                                    <select v-model="zoneName" @change="updateDeliveryCost" class="w-full p-2 border rounded-lg bg-white">
                                        <option value="">Seleziona Zona</option>
                                        <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">
                                            {{ zone.name }} (‚Ç¨{{ zone.price.toFixed(2) }})
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Assegna Fattorino*</label>
                                    <select v-model="selectedDriver" class="w-full p-2 border rounded-lg bg-white">
                                        <option value="">Nessuno</option>
                                        <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <label class="block text-sm font-medium text-gray-700">Note Ordine (Es. Citofono, allergie)</label>
                        <textarea v-model="notes" rows="3" placeholder="Note per la cucina o il fattorino..." class="w-full p-2 border rounded-lg"></textarea>
                    </div>
                    
                    <div class="w-2/5 space-y-4">
                        <h3 class="text-lg font-semibold mb-2">Pagamento e Riepilogo</h3>
                        
                        <div class="p-3 bg-red-100 border border-red-300 rounded-lg">
                            <p class="text-xl font-bold flex justify-between">Totale Ordine: <span class="text-red-700">‚Ç¨{{ total.toFixed(2) }}</span></p>
                            <p v-if="deliveryCost > 0" class="text-sm flex justify-between text-blue-600">Costo Consegna: <span>+ ‚Ç¨{{ deliveryCost.toFixed(2) }}</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Metodo di Pagamento</label>
                            <select v-model="paymentMethod" class="w-full p-2 border rounded-lg bg-white">
                                <option value="contanti">Contanti</option>
                                <option value="carta">Carta/Bancomat</option>
                                <option value="satispay">Satispay</option>
                                <option value="ticket">Ticket/Buoni</option>
                            </select>
                        </div>

                        <div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-semibold mb-2">Applica Sconto</h4>
                            <div class="flex space-x-2 mb-2">
                                <button @click="discountAmount = 10; discountType = 'percent'" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">10%</button>
                                <button @click="discountAmount = 5.00; discountType = 'fixed'" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">5‚Ç¨ Fisso</button>
                                <button @click="discountAmount = 0; discountType = 'fixed'" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">Nessun Sconto</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-2">
                                    <input type="number" v-model.number="discountAmount" step="0.01" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <select v-model="discountType" class="w-full p-2 border rounded-lg">
                                        <option value="fixed">‚Ç¨ Fisso</option>
                                        <option value="percent">% Percentuale</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contanti Ricevuti (Acconto/Cifra Data)</label>
                            <input type="number" v-model.number="accontoRicevuto" step="0.01" placeholder="0.00" class="w-full p-2 border rounded-lg text-2xl font-bold text-center">
                        </div>
                        
                        <div v-if="restoDaDare > 0" class="p-3 bg-green-100 border border-green-400 rounded-lg text-center">
                            <p class="text-lg font-bold">RESTO DA DARE</p>
                            <p class="text-3xl font-bold text-green-700">‚Ç¨{{ restoDaDare.toFixed(2) }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelEdit" v-if="editingOrderId" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-150">
                        Annulla Modifica
                    </button>
                    <button @click="showModal = false" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400 transition duration-150">
                        Torna all'Ordine
                    </button>
                    <button v-if="editingOrderId" @click="updateOrder" class="px-6 py-3 bg-yellow-600 text-white rounded-xl font-bold hover:bg-yellow-700 transition duration-200">
                        AGGIORNA ORDINE #{{ editingOrderId }}
                    </button>
                    <button v-else @click="confirmOrder" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition duration-200">
                        CONFERMA E INSERISCI
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Componi Pizza a Met√†</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-2/5 space-y-4">
                        <div class="p-3 border rounded-lg" :class="{'bg-yellow-100 border-yellow-500': tempHalfPizzaItem.activeHalf === 1}">
                            <h3 class="font-bold text-lg mb-2">MET√Ä 1: {{ tempHalfPizzaItem.gusto1 || 'Seleziona Gusto' }}</h3>
                            <div class="flex justify-between items-center">
                                <button @click="tempHalfPizzaItem.activeHalf = 1" class="px-4 py-2 rounded font-semibold text-white transition duration-150"
                                        :class="{'bg-green-600 hover:bg-green-700': tempHalfPizzaItem.activeHalf !== 1, 'bg-red-600': tempHalfPizzaItem.activeHalf === 1}">
                                    {{ tempHalfPizzaItem.activeHalf === 1 ? 'SELEZIONATO' : 'SELEZIONA' }}
                                </button>
                                <p class="text-sm">Modificatori: {{ tempHalfPizzaItem.modifiers1.length }}</p>
                            </div>
                            <div v-if="tempHalfPizzaItem.gusto1" class="mt-2 text-sm">
                                Modifiche: <span v-for="(mod, i) in tempHalfPizzaItem.modifiers1" :key="i" class="text-gray-600">{{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }} </span>
                            </div>
                        </div>

                        <div class="p-3 border rounded-lg" :class="{'bg-yellow-100 border-yellow-500': tempHalfPizzaItem.activeHalf === 2}">
                            <h3 class="font-bold text-lg mb-2">MET√Ä 2: {{ tempHalfPizzaItem.gusto2 || 'Seleziona Gusto' }}</h3>
                            <div class="flex justify-between items-center">
                                <button @click="tempHalfPizzaItem.activeHalf = 2" class="px-4 py-2 rounded font-semibold text-white transition duration-150"
                                        :class="{'bg-green-600 hover:bg-green-700': tempHalfPizzaItem.activeHalf !== 2, 'bg-red-600': tempHalfPizzaItem.activeHalf === 2}">
                                    {{ tempHalfPizzaItem.activeHalf === 2 ? 'SELEZIONATO' : 'SELEZIONA' }}
                                </button>
                                <p class="text-sm">Modificatori: {{ tempHalfPizzaItem.modifiers2.length }}</p>
                            </div>
                            <div v-if="tempHalfPizzaItem.gusto2" class="mt-2 text-sm">
                                Modifiche: <span v-for="(mod, i) in tempHalfPizzaItem.modifiers2" :key="i" class="text-gray-600">{{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }} </span>
                            </div>
                        </div>

                        <div class="p-3 bg-blue-50 rounded-lg text-center">
                            <p class="text-xl font-bold">TOTALE STIMATO</p>
                            <p class="text-3xl font-bold text-red-600">‚Ç¨{{ calculateTempHalfPizzaTotal.toFixed(2) }}</p>
                        </div>
                    </div>

                    <div class="w-2/5 space-y-4 max-h-[70vh] overflow-y-auto">
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca pizza per Gusto..." class="w-full p-2 border rounded-lg">
                        <div class="grid grid-cols-2 gap-3">
                            <button v-for="gusto in filteredPizzaGusti" :key="gusto.id" 
                                    @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0"
                                    :class="{'opacity-50 cursor-not-allowed': tempHalfPizzaItem.activeHalf === 0}"
                                    class="p-3 border rounded-lg text-left bg-gray-100 hover:bg-gray-200 transition duration-150 relative">
                                <span class="font-bold block">{{ gusto.nome }}</span>
                                <span class="text-sm text-gray-600">‚Ç¨{{ gusto.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="w-1/5 space-y-3">
                        <h3 class="font-bold">Modificatori</h3>
                        
                        <div class="flex space-x-2">
                            <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat"
                                    :class="{'bg-red-600 text-white': tempModCat === cat, 'bg-gray-200': tempModCat !== cat}"
                                    class="flex-1 p-2 rounded-lg text-xs font-semibold">
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="max-h-[50vh] overflow-y-auto space-y-1">
                            <button v-for="mod in filteredTempModifiers" :key="mod.id" 
                                    @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0"
                                    :class="{'opacity-50 cursor-not-allowed': tempHalfPizzaItem.activeHalf === 0}"
                                    class="w-full p-2 border rounded-lg text-left text-sm font-semibold hover:bg-gray-100 transition duration-150">
                                {{ getModifierIcon(tempModCat) }} {{ mod.nome }} <span v-if="mod.prezzo > 0" class="float-right text-gray-600">+‚Ç¨{{ mod.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelHalfPizzaComposition" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid"
                            class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 transition duration-200">
                        Aggiungi Pizza a Met√†
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showMeterModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Componi {{ tempMeterItem.nome }}</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-1/3 space-y-4">
                        <h3 class="font-bold text-lg mb-2">1. Numero di Gusti</h3>
                        <div class="flex space-x-2">
                            <button @click="setMeterGusti(1)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 1, 'bg-gray-200': tempMeterItem.numGusti !== 1}" class="flex-1 p-3 rounded-lg font-semibold">1 Gusto</button>
                            <button @click="setMeterGusti(2)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 2, 'bg-gray-200': tempMeterItem.numGusti !== 2}" class="flex-1 p-3 rounded-lg font-semibold">2 Gusti</button>
                            <button v-if="tempMeterItem.nome === 'Mezzo Metro'" @click="setMeterGusti(3)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 3, 'bg-gray-200': tempMeterItem.numGusti !== 3}" class="flex-1 p-3 rounded-lg font-semibold">3 Gusti</button>
                        </div>

                        <h3 class="font-bold text-lg mb-2 mt-4">2. Riepilogo Gusti</h3>
                        <div v-for="(gusto, gIndex) in tempMeterItem.gusti" :key="gIndex" 
                             class="p-3 border rounded-lg mb-2" :class="{'bg-yellow-100 border-yellow-500': gusto.gusto}">
                            
                            <p class="font-bold">{{ gusto.name }}: <span class="text-blue-700">{{ gusto.gusto || 'In attesa...' }}</span></p>
                            <p v-if="gusto.modifiers.length" class="text-sm">Modifiche: {{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }}</p>
                        </div>
                        
                        <div class="p-3 bg-blue-50 rounded-lg text-center mt-4">
                            <p class="text-xl font-bold">TOTALE STIMATO</p>
                            <p class="text-3xl font-bold text-red-600">‚Ç¨{{ calculateTempMeterTotal.toFixed(2) }}</p>
                            <p class="text-sm text-gray-600">(Base: ‚Ç¨{{ tempMeterItem.prezzoBase.toFixed(2) }} + Modificatori)</p>
                        </div>
                    </div>

                    <div class="w-1/3 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <h3 class="font-bold text-lg">3. Seleziona Gusti</h3>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca pizza per Gusto..." class="w-full p-2 border rounded-lg">
                        
                        <div v-for="(gustoSlot, gIndex) in tempMeterItem.gusti" :key="gIndex" class="mb-4 p-3 border rounded-lg" :class="{'bg-gray-100': gustoSlot.gusto}">
                            <h4 class="font-bold mb-2">{{ gustoSlot.name }}: <span class="text-green-600">{{ gustoSlot.gusto || 'Seleziona' }}</span></h4>
                            <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                <button v-for="gusto in filteredPizzaGusti" :key="gusto.id" 
                                        @click="selectMeterGusto(gIndex, gusto.nome)"
                                        class="p-2 border rounded-lg text-xs text-left bg-white hover:bg-green-100 transition duration-150">
                                    {{ gusto.nome }}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-1/3 space-y-3">
                        <h3 class="font-bold text-lg">4. Modificatori per Gusto</h3>
                        
                        <div v-for="(gustoSlot, gIndex) in tempMeterItem.gusti" :key="gIndex" 
                             class="p-3 border rounded-lg mb-4" :class="{'bg-yellow-50': gustoSlot.gusto}">
                            <h4 class="font-bold mb-2">{{ gustoSlot.name }} ({{ gustoSlot.gusto || 'Senza Gusto' }})</h4>

                            <div class="flex space-x-2 mb-2">
                                <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat"
                                        :class="{'bg-red-600 text-white': tempModCat === cat, 'bg-gray-200': tempModCat !== cat}"
                                        class="flex-1 p-1 rounded-lg text-xs font-semibold">
                                    {{ cat }}
                                </button>
                            </div>
                            
                            <div class="max-h-28 overflow-y-auto space-y-1">
                                <button v-for="mod in filteredTempModifiers" :key="mod.id" 
                                        @click="addMeterModifier(gIndex, mod)"
                                        :disabled="!gustoSlot.gusto"
                                        class="w-full p-1 border rounded-lg text-left text-xs font-semibold hover:bg-gray-100 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ getModifierIcon(tempModCat) }} {{ mod.nome }}
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelMeterComposition" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="addMeterToOrder" :disabled="!isMeterValid"
                            class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 transition duration-200">
                        Aggiungi {{ tempMeterItem.nome }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showPriceEditModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Modifica Prezzo Articolo</h2>
                <p class="mb-4">Articolo: <span class="font-semibold">{{ order[tempPriceEditIndex]?.nome }}</span></p>
                
                <label class="block text-sm font-medium text-gray-700">Nuovo Prezzo (‚Ç¨)</label>
                <input type="number" v-model.number="newPriceValue" step="0.01" class="w-full p-3 border rounded-lg text-3xl font-bold text-center mb-4">
                
                <div class="flex justify-end space-x-4">
                    <button @click="cancelPriceEdit" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="saveNewPrice" :disabled="newPriceValue < 0" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:bg-gray-400">
                        Salva Prezzo
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Stampa Comanda Ordine #{{ selectedOrderForShare.id }}</h2>
                
                <div class="flex justify-center mb-4">
                    <order-print 
                        :order="selectedOrderForShare"
                        :calculateItemTotal="calculateItemTotal"
                        :getModifierCategory="getModifierCategory"
                        :getModifierIcon="getModifierIcon">
                    </order-print>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button @click="closeShareModal" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Chiudi</button>
                    <button @click="printOrder" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">
                        <i class="fa-solid fa-print"></i> Stampa Comanda
                    </button>
                </div>
            </div>
        </div>
                <div v-else-if="view === 'impostazioni'" class="w-full p-6 bg-gray-50 flex flex-col">
                    <h2 class="text-2xl font-bold mb-6">‚öôÔ∏è Impostazioni e Configurazione</h2>

                    <div class="grid grid-cols-2 gap-6 flex-grow overflow-y-auto pr-2">
                        
                        <div class="space-y-6">
                            <h3 class="text-xl font-bold border-b pb-2">Gestione Menu e Articoli</h3>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                                <h4 class="font-bold text-lg mb-3">Aggiungi Nuovo Articolo/Pizza</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="block text-sm">Nome</label><input type="text" v-model="newItem.nome" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm">Prezzo (‚Ç¨)</label><input type="number" v-model.number="newItem.prezzo" step="0.01" class="w-full p-2 border rounded-lg"></div>
                                    <div class="col-span-2">
                                        <label class="block text-sm">Categoria</label>
                                        <select v-model="newItem.category" class="w-full p-2 border rounded-lg">
                                            <option v-for="(items, cat) in menu" :key="cat" :value="cat">{{ cat }}</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="addMenuItem" class="mt-3 w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 font-semibold">Aggiungi Articolo</button>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <h4 class="font-bold text-lg mb-3">Lista Articoli/Disponibilit√† (Tot: {{ allMenuItems.length }})</h4>
                                <div class="max-h-60 overflow-y-auto space-y-2 pr-1">
                                    <div v-for="item in allMenuItems" :key="item.id" class="flex justify-between items-center p-2 border rounded-lg" :class="{'bg-red-100 opacity-70': item.isFinished}">
                                        <div class="text-sm">
                                            <span class="font-semibold">{{ item.nome }}</span> ({{ item.category }}) - ‚Ç¨{{ item.prezzo.toFixed(2) }}
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="toggleFinished(item.id, item.category)" 
                                                    :class="{'bg-green-500 hover:bg-green-600': item.isFinished, 'bg-yellow-500 hover:bg-yellow-600': !item.isFinished}"
                                                    class="px-2 py-1 text-xs text-white rounded">
                                                {{ item.isFinished ? 'Disponibile' : 'Esaurito' }}
                                            </button>
                                            <button @click="deleteMenuItem(item.id, item.category)" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Elimina</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
                                <h4 class="font-bold text-lg mb-3">Aggiungi Nuovo Modificatore</h4>
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="col-span-1">
                                        <label class="block text-sm">Nome Modificatore</label>
                                        <input type="text" v-model="newModifier.nome" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm">Prezzo (‚Ç¨)</label>
                                        <input type="number" v-model.number="newModifier.prezzo" step="0.01" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm">Categoria Mod.</label>
                                        <select v-model="newModifier.category" class="w-full p-2 border rounded-lg">
                                            <option v-for="(mods, cat) in modifiers" :key="cat" :value="cat">{{ cat }}</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="addModifier" class="mt-3 w-full bg-yellow-600 text-white p-2 rounded-lg hover:bg-yellow-700 font-semibold">Aggiungi Modificatore</button>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <h3 class="text-xl font-bold border-b pb-2">Logistica e Orari</h3>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-green-500">
                                <h4 class="font-bold text-lg mb-3">Gestione Fattorini</h4>
                                <div class="flex space-x-2 mb-2">
                                    <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" class="flex-grow p-2 border rounded-lg">
                                    <button @click="addDriver" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 font-semibold">Aggiungi</button>
                                </div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <div v-for="driver in drivers" :key="driver" class="flex items-center bg-gray-100 p-2 rounded text-sm">
                                        {{ driver }}
                                        <button @click="removeDriver(driver)" class="ml-2 text-red-500 hover:text-red-700"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-orange-500">
                                <h4 class="font-bold text-lg mb-3">Zone di Consegna e Costi</h4>
                                <div class="max-h-40 overflow-y-auto space-y-2 pr-1 mb-2">
                                    <div v-for="(zone, index) in deliveryZones" :key="index" class="flex space-x-2 items-center">
                                        <input type="text" v-model="zone.name" placeholder="Nome Zona" class="flex-grow p-2 border rounded-lg text-sm">
                                        <input type="number" v-model.number="zone.price" step="0.01" placeholder="Costo" class="w-20 p-2 border rounded-lg text-sm">
                                        <button @click="removeZone(index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                                <button @click="addZone" class="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 font-semibold">Aggiungi Zona</button>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-red-500">
                                <h4 class="font-bold text-lg mb-3">Gestione Capacit√† (Pizze/Intervallo)</h4>
                                <div>
                                    <label class="block text-sm">Pizze Max per Intervallo (Carico Massimo)</label>
                                    <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" class="w-full p-2 border rounded-lg mb-2">
                                </div>
                                <div>
                                    <label class="block text-sm">Durata Intervallo (Minuti)</label>
                                    <input type="number" v-model.number="capacitySettings.intervalMinutes" min="5" step="5" class="w-full p-2 border rounded-lg">
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Es: 30 pizze / 30 minuti.</p>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                                <h4 class="font-bold text-lg mb-3">Orari di Apertura e Chiusura</h4>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <div><label class="block text-sm">Ora Apertura</label><input type="time" v-model="businessHours.openTime" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm">Ora Chiusura</label><input type="time" v-model="businessHours.closeTime" class="w-full p-2 border rounded-lg"></div>
                                </div>
                                <label class="block text-sm mb-1">Giorni di Chiusura (Domenica=0, Luned√¨=1, ...)</label>
                                <div class="flex flex-wrap gap-2">
                                    <label v-for="(day, index) in ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab']" :key="index" class="flex items-center space-x-1 text-sm">
                                        <input type="checkbox" :value="index" v-model="businessHours.closedDays" class="rounded text-red-600">
                                        <span>{{ day }}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 mt-6 pt-4 border-t border-gray-300 flex justify-end space-x-4">
                        <button @click="exportArchive" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                            <i class="fa-solid fa-file-export"></i> Esporta Storico
                        </button>
                        <button @click="clearArchive" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">
                            <i class="fa-solid fa-eraser"></i> Cancella Storico (Titolare)
                        </button>
                        <button @click="saveData" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                            <i class="fa-solid fa-save"></i> Salva Impostazioni
                        </button>
                    </div>
                </div>

            </div>
        </main>

    </div>
    
    <style>
        /* Stili Tailwind e CSS personalizzati */
        .animate-pulse-driver {
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                border-color: #f87171; /* red-400 */
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7);
            }
            50% {
                border-color: #ef4444; /* red-500 */
                box-shadow: 0 0 0 5px rgba(248, 113, 113, 0);
            }
        }
        
        /* Forza scrollbar per carrello/liste */
        .overflow-y-auto {
            scrollbar-width: thin;
        }

    </style>
</body>
</html>
