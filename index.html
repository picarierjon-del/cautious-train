<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart – Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        
        /* Modificatori */
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; } /* Più */
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; } /* Senza */
        .mod-btn.yellow { border-color: #facc15; color: #facc15; } /* Poco */
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; } /* Abbondante */
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .search-mod-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }


        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item.active-menu-selection { border: 3px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);} 
        .item.disabled { background: #f0f0f0; color: #999; cursor: not-allowed; opacity: 0.7; }
        .item.disabled:hover { background: #f0f0f0; }

        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }
        
        /* Stili Ordini Attivi e Avvisi Temporali */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative;}
        /* NUOVO: Ordini Futuri */
        .order-card.future-order { border-left: 5px solid #3b82f6; } 
        .order-card.future-order:before { content: "PRENOTAZIONE"; position: absolute; top: -10px; right: 10px; background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        
        .order-card h4 { margin: 0 0 6px; color: #e31b23; display: flex; justify-content: space-between;}
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        .order-actions button.duplicate { background: #facc15; color: #333;}
        
        /* Filtro Ordini Attivi */
        .filter-row-top { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-btn-status { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .filter-btn-status.active { background: #e31b23; color: #fff; border-color: #e31b23; }

        /* Avvisi Temporali (Mantenuti) */
        .order-card.warning-near { border-left: 5px solid #facc15; } /* Giallo (15 min) */
        .order-card.warning-urgent { border-left: 5px solid #b91c1c; } /* Rosso (5 min) */
        .order-card.warning-near:before { content: "ATTENZIONE: Vicino!"; position: absolute; top: -10px; right: 10px; background: #facc15; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .order-card.warning-urgent:before { content: "URGENTE: Imminente!"; position: absolute; top: -10px; right: 10px; background: #b91c1c; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Stili per la stampa (nasconde elementi non necessari) */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 11pt; }

            /* Stili specifici per la comanda */
            .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; }
            .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; }
            .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; }
            .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
            .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; }
            .print-comanda .item-name { font-weight: bold; font-size: 13pt; }
            .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; }
            .print-comanda .mod-list li { border: none; }
            .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; }

            /* Stili specifici per lo scontrino */
            .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; }
            .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; }
            .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
            .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; }
            .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; }
        }

        /* Stili per le Impostazioni (aggiunti/integrati) */
        .settings h3 { color: #444; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .settings form { display: flex; gap: 5px; margin-bottom: 15px; }
        .settings form input, .settings form select, .settings form button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .settings form input[type="text"], .settings form input[type="number"], .settings form select { flex-grow: 1; }
        .settings form button { background: #10b981; color: #fff; border: none; cursor: pointer; }
        
        .settings-list { margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
        .settings-item span { flex-grow: 1; }
        .settings-item .remove { background: #b91c1c; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        .item-status button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .item-status .available { background: #22c55e; color: #fff; }
        .item-status .finished { background: #b91c1c; color: #fff; }

        /* Stili Accesso e Notifiche */
        .access-container { text-align: center; padding: 50px 20px; }
        .access-container input { max-width: 250px; margin: 10px auto; display: block; }

        .time-capacity { padding: 10px; border: 1px solid #facc15; background-color: #fffbeb; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; }
        .time-capacity.full { border-color: #b91c1c; background-color: #ffecec; color: #b91c1c; font-weight: 700;}
        .time-capacity.warning { border-color: #facc15; background-color: #fffbeb; }

        .settings-item .actions { display: flex; gap: 5px; }
        
        .composition-options button { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .composition-options button.selected { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }

    </style>
</head>
<body>
<header>Pizzeria Smart</header>

<main id="app">
    <section v-show="view==='inserimento'">
        <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Crea Nuovo Ordine' }}</h2>
        
        <div class="cat-row">
            <button class="cat-btn" v-for="c in Object.keys(menu)" :key="c"
                    :class="{active:activeCat===c}" @click="activeCat=c; lastSelectedItem=null;">{{c}}</button>
        </div>

        <div class="mod-row" v-if="Object.keys(modifiers).length > 0">
            <button class="mod-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                    :class="[cat.toLowerCase().includes('più') ? 'green' : cat.toLowerCase().includes('senza') ? 'gray' : cat.toLowerCase().includes('poco') ? 'yellow' : cat.toLowerCase().includes('abbondante') ? 'blue' : '', {active: activeModCat===cat}]"
                    @click="activeModCat=cat; modifierSearchTerm=''" :disabled="selectedItemIndex === null || (order[selectedItemIndex] && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza))">{{cat.toUpperCase()}}</button>
        </div>
        
        <input type="search" v-model="modifierSearchTerm" placeholder="Filtra aggiunte/modificatori..." class="search-mod-input"
               :disabled="selectedItemIndex === null || (order[selectedItemIndex] && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza))">

        <div class="grid" v-if="filteredModifiersForActiveCat.length > 0">
            <div class="item" v-for="m in filteredModifiersForActiveCat" :key="m.nome + m.prezzo" @click="addExtra(m)" 
                 :class="{disabled: m.isFinished}"
                 :style="{opacity: (selectedItemIndex === null || (order[selectedItemIndex] && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza)) || m.isFinished) ? 0.5 : 1, cursor: (selectedItemIndex === null || (order[selectedItemIndex] && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza)) || m.isFinished) ? 'not-allowed' : 'pointer'}">
                <strong>{{m.nome}}</strong>
                <span v-if="m.isFinished" style="color:#b91c1c; font-weight:700;">(FINITO)</span>
                <span v-else-if="m.prezzo > 0">€{{m.prezzo.toFixed(2)}}</span>
            </div>
        </div>
        <div v-else-if="activeModCat && modifierSearchTerm" style="text-align: center; margin: 10px 0; color: #6b7280;">Nessun modificatore trovato in '{{activeModCat}}'.</div>
        
        <input type="search" v-model="searchTerm" placeholder="Cerca prodotto..." class="search-input">

        <div class="grid">
            <div class="item" v-for="p in filteredAvailableItems" :key="p.nome" @click="handleItemClick(p)" :class="{disabled: p.isFinished || (p.isMeter && !canComposeMeter) || (p.isHalfPizza && !canComposeHalfPizza), 'active-menu-selection': lastSelectedItem === p}">
                <strong>{{p.nome}}</strong>
                <span v-if="p.isFinished" style="color:#b91c1c; font-weight:700;">(FINITO)</span>
                <span v-else-if="p.isMeter || p.isHalfPizza">€{{(p.isMeter || p.isHalfPizza ? p.prezzo.toFixed(2) + ' BASE' : p.prezzo.toFixed(2))}}</span>
                <span v-else>€{{p.prezzo.toFixed(2)}}</span>
                <span v-if="(p.isMeter && !canComposeMeter) || (p.isHalfPizza && !canComposeHalfPizza)" style="color:#b91c1c; font-weight:700; font-size:0.7rem;">(MANCA BASE)</span>
            </div>
        </div>

        <div class="order-box">
            <h3>Ordine Corrente 
                <span v-if="selectedItemIndex !== null && order[selectedItemIndex]" style="color: #e31b23; font-size: 0.8rem; font-weight: 400;">
                    (Selezionato: {{order[selectedItemIndex].nome}})
                </span>
            </h3>
            <ul>
                <li v-for="(i,idx) in order" :key="idx" @click="selectItem(idx)">
                    <div class="order-item" :class="{selected: selectedItemIndex === idx}">
                        <span v-if="i.isHalfPizza">🍕 {{i.nome}} ({{i.gusto1}} / {{i.gusto2}})</span>
                        <span v-else-if="i.isMeter">🍕 {{i.nome}} ({{i.gustiCount}} Gusti)</span>
                        <span v-else>{{i.nome}}</span>
                        
                        <span @dblclick.stop="openPriceEditModal(idx)" @click.stop="openPriceEditModal(idx)" style="cursor: pointer; font-weight: 700; border-bottom: 1px dashed #e31b23;">
                            €{{calculateItemTotal(i).toFixed(2)}} 
                            <button @click.stop="removeItem(idx)" style="border:none;background:none;color:#e31b23; margin-left: 5px;">✖️</button>
                        </span>
                    </div>
                    
                    <ul v-if="i.modifiers && i.modifiers.length > 0 && !i.isMeter && !i.isHalfPizza" class="modifiers-list">
                        <li v-for="(mod, modIdx) in i.modifiers" :key="modIdx">
                            <span>
                                <span :class="['mod-icon', getModifierCategory(mod.nome)]">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                            </span>
                            <button class="mod-remove-btn" @click.stop="removeModifier(idx, modIdx)">❌</button>
                        </li>
                    </ul>
                    
                    <ul v-if="i.isHalfPizza" class="modifiers-list" style="padding-left: 0;">
                        <li style="display: block; margin-bottom: 5px;">
                            <strong style="color: #444; font-weight: 600;">Metà 1 ({{ i.gusto1 }})</strong>
                            <ul v-if="i.modifiers1 && i.modifiers1.length > 0">
                                <li v-for="(mod, modIdx) in i.modifiers1" :key="modIdx">
                                    <span>
                                        <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                        {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                    </span>
                                </li>
                            </ul>
                        </li>
                        <li style="display: block; margin-bottom: 5px;">
                            <strong style="color: #444; font-weight: 600;">Metà 2 ({{ i.gusto2 }})</strong>
                            <ul v-if="i.modifiers2 && i.modifiers2.length > 0">
                                <li v-for="(mod, modIdx) in i.modifiers2" :key="modIdx">
                                    <span>
                                        <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                        {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                    </span>
                                </li>
                            </ul>
                        </li>
                    </ul>

                    <ul v-if="i.isMeter" class="modifiers-list" style="padding-left: 0;">
                        <li v-for="(section, secIdx) in i.sections" :key="secIdx" style="display: block; margin-bottom: 5px;">
                            <strong style="color: #444; font-weight: 600;">{{ section.name }}</strong>: {{ section.gusto }}
                            <ul v-if="section.modifiers && section.modifiers.length > 0">
                                <li v-for="(mod, mIdx) in section.modifiers" :key="mIdx">
                                     <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                    * {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    
                </li>
            </ul>
            <div class="total">Totale Articoli: €{{calculatedOrderTotal.toFixed(2)}}</div>
            <div v-if="deliveryCost > 0" class="total">Costo Consegna: +€{{deliveryCost.toFixed(2)}} ({{zoneName}})</div>
            <div class="total" style="font-size: 1.2rem; margin-top: 10px;">TOTALE COMPLESSIVO: €{{total.toFixed(2)}}</div>
            
            <button class="final-btn" @click="openModal" :disabled="order.length === 0">{{ editingOrderId ? 'Aggiorna Ordine #' + editingOrderId : 'Finalizza Ordine' }}</button>
            
            <button v-if="editingOrderId" class="final-btn cancel-edit-btn" @click="cancelEdit">Annulla Modifica</button>
        </div>
    </section>

    <section v-show="view==='ordini'">
        <h2>Ordini Attivi</h2>
        <input type="search" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Tavolo, Indirizzo..." class="search-input">
        
        <div class="filter-row-top">
            <button class="filter-btn-status" :class="{active: activeDateFilter === 'all'}" @click="activeDateFilter = 'all'">TUTTI</button>
            <button class="filter-btn-status" :class="{active: activeDateFilter === 'today'}" @click="activeDateFilter = 'today'">OGGI</button>
            <button class="filter-btn-status" :class="{active: activeDateFilter === 'tomorrow'}" @click="activeDateFilter = 'tomorrow'">DOMANI</button>
            <button class="filter-btn-status" :class="{active: activeDateFilter === 'future'}" @click="activeDateFilter = 'future'">FUTURI</button>
        </div>

        <div v-if="!filteredActiveOrders.length">Nessun ordine attivo trovato per la data selezionata.</div>
        <div class="order-card" v-for="o in filteredActiveOrders" :key="o.id"
             :class="{'warning-urgent': isUrgent(o), 'warning-near': isNear(o) && !isUrgent(o), 'future-order': isFutureOrder(o)}">
            <h4>
                <span>#{{o.id}} – {{o.mode.toUpperCase()}} ({{o.status}})</span>
                <span v-if="o.tableNumber" style="color:#3b82f6; font-size:1rem;">Tavolo/Ritiro: {{o.tableNumber}}</span>
            </h4>
            <p><strong>Cliente: {{o.customer}}</strong></p>
            <p>Data: **{{ formatDate(o.date) }}** | Ritiro/Consegna: **{{o.hour}}**</p>
            
            <div v-if="o.mode === 'consegna'" style="margin-bottom: 8px; padding-top: 5px; border-top: 1px dotted #ccc;">
                <label style="font-size: 0.9rem; font-weight: 600;">Fattorino Assegnato:</label>
                <select @change="updateActiveOrderDriver(o.id, $event.target.value)" style="padding: 6px; border-radius: 4px; width: 100%;">
                    <option value="">Nessuno</option>
                    <option v-for="driver in drivers" :value="driver" :selected="o.driver === driver">{{ driver }}</option>
                </select>
                <p v-if="o.phone" style="margin-top: 5px;">📞 {{o.phone}}</p>
                <p v-if="o.mode === 'consegna'">
                    📍 {{o.address}} {{o.streetNumber}}, **{{o.zone}}** ({{o.town}})
                    <br>Costo Consegna: €{{o.deliveryCost.toFixed(2)}}
                </p>
            </div>
            <p v-else-if="o.phone">📞 {{o.phone}}</p>
            <p v-else-if="o.driver" style="font-size: 0.9rem;">Fattorino (Asporto/Banco): **{{o.driver}}**</p>
            
            <p v-if="o.notes" style="font-size: 0.9rem; margin-top: 8px;">**Note:** {{o.notes}}</p>
            
            <ul class="order-items">
                <li v-for="it in o.items">
                    <span v-if="it.isHalfPizza">🍕 {{it.nome}} ({{it.gusto1}} / {{it.gusto2}})</span>
                    <span v-else-if="it.isMeter">🍕 {{it.nome}} ({{it.gustiCount}} Gusti)</span>
                    <span v-else>{{ it.nome }}</span>
                     – €{{ calculateItemTotal(it).toFixed(2) }}
                    
                    <ul v-if="it.isHalfPizza">
                        <li>**Metà 1: {{ it.gusto1 }}**
                            <ul v-if="it.modifiers1 && it.modifiers1.length > 0">
                                <li v-for="mod in it.modifiers1">
                                     <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                    * {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                </li>
                            </ul>
                        </li>
                        <li>**Metà 2: {{ it.gusto2 }}**
                             <ul v-if="it.modifiers2 && it.modifiers2.length > 0">
                                <li v-for="mod in it.modifiers2">
                                     <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                    * {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    
                    <ul v-if="it.isMeter" style="padding-left: 0;">
                        <li v-for="sec in it.sections" style="margin-bottom: 3px;">
                            **{{ sec.name }}:** {{ sec.gusto }}
                            <ul v-if="sec.modifiers && sec.modifiers.length > 0">
                                <li v-for="mod in sec.modifiers">
                                     <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                                    * {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                                </li>
                            </ul>
                        </li>
                    </ul>
                    <ul v-if="it.modifiers && it.modifiers.length > 0 && !it.isMeter && !it.isHalfPizza">
                        <li v-for="mod in it.modifiers">
                             <span :class="['mod-icon', getModifierCategory(mod.nome)]" style="width:12px; height:12px; font-size:0.7rem;">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                            * {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                        </li>
                    </ul>
                </li>
            </ul>
            <p><strong>Totale: €{{o.total.toFixed(2)}}</strong></p>
            <div class="order-actions">
                <button class="edit" @click="editOrder(o.id)">Modifica</button>
                <button @click="advance(o)">Avanza Stato: {{ getNextStatus(o.status) }}</button>
                <button class="duplicate" @click="duplicateOrder(o)"><i class="fa-solid fa-copy"></i> Duplica</button>
                <button class="share" @click="showShareMenu(o.id)"><i class="fa-solid fa-share-alt"></i> Azioni</button>
                
                <button @click="printOrder(o.id, 'comanda')" style="background: #e31b23; margin-top: 10px; width: 49%;"><i class="fa-solid fa-pizza-slice"></i> Comanda Cucina</button>
                <button @click="printOrder(o.id, 'scontrino')" style="background: #6b7280; margin-top: 10px; width: 49%; margin-right: 0;"><i class="fa-solid fa-receipt"></i> Scontrino Banco</button>
                <button class="final-btn" style="width: 100%; margin-right: 0;" @click="closeOrderAndArchive(o)">
                    <i class="fa-solid fa-box-archive"></i> **Chiudi Ordine & Archivia**
                </button>
            </div>
        </div>
    </section>

    <section v-show="view==='storico'">
        <div v-if="!isAccessGranted">
            <div class="access-container">
                <h2>Accesso Storico Richiesto</h2>
                <p>Inserisci il PIN/Password per accedere allo storico ordini.</p>
                <input type="password" v-model="accessPin" placeholder="PIN/Password" @keyup.enter="grantAccess" required>
                <button class="final-btn" style="max-width: 200px; margin: 10px auto;" @click="grantAccess">Accedi</button>
            </div>
        </div>
        <div v-else>
            <h2>Storico e Statistiche</h2>
            
            <div class="form-row">
                <label for="archiveDateFilter" style="font-weight: 600;">Filtra Ordini Completati per Data:</label>
                <input type="date" id="archiveDateFilter" v-model="archiveDateFilter" @change="calculateDriverStats" style="padding: 8px; font-size: 1rem;">
            </div>

            <div class="stats-box">
                <h3>Incasso Totale del {{ archiveDateFilterDisplay }}</h3>
                <p>€{{ dailyTotal.toFixed(2) }}</p>
            </div>

            <h3 style="color:#6b7280;">Consegne Giornaliere</h3>
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; display: block; margin-bottom: 5px;">Filtra per Fattorino:</label>
                <select v-model="selectedDriver" @change="calculateDriverStats" style="padding: 8px; border-radius: 6px; width: 100%;">
                    <option value="">Tutti i Fattorini</option>
                    <option v-for="driver in drivers" :value="driver">{{ driver }}</option>
                </select>
            </div>

            <div v-if="selectedDriver || driverStats.totalOrders > 0" style="background: #f0f0f0; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-weight: 700;">{{ selectedDriver ? 'Statistiche di ' + selectedDriver : 'Totale Consegne' }} ({{ archiveDateFilterDisplay }}):</p>
                <p style="margin: 5px 0 0;">Consegne: **{{ driverStats.totalOrders }}** | Totale Incasso: **€{{ driverStats.totalRevenue.toFixed(2) }}**</p>
            </div>

            <h3 style="color:#6b7280;">Ordini Completati</h3>
            <div v-if="!filteredArchive.length">Nessun ordine completato per la data selezionata.</div>
            <div class="archive-order-card" v-for="o in filteredArchive.slice().reverse()" :key="o.id">
                <h5>#{{o.id}} – {{new Date(o.archivedDate).toLocaleTimeString()}} | Cliente: {{o.customer}}</h5>
                <p style="margin: 0;">**Totale: €{{o.total.toFixed(2)}}** ({{o.mode}})
                    <span v-if="o.tableNumber" style="font-size: 0.8rem; color: #3b82f6; margin-left: 10px;">Tavolo/Ritiro: {{o.tableNumber}}</span>
                </p>
                <div class="archive-actions" style="margin-top: 5px; display: flex; align-items: center; justify-content: flex-end;">
                    <div v-if="o.mode === 'consegna'" style="display: flex; align-items: center; gap: 5px; flex-grow: 1;">
                        <label style="font-size: 0.8rem; white-space: nowrap;">Fattorino:</label>
                        <select @change="updateArchiveDriver(o.id, $event.target.value)" style="padding: 4px; border-radius: 4px; font-size: 0.8rem; flex-grow: 1;">
                            <option value="">Nessuno</option>
                            <option v-for="driver in drivers" :value="driver" :selected="o.driver === driver">{{ driver }}</option>
                        </select>
                    </div>
                    <span v-else-if="o.driver" style="font-size: 0.8rem; color: #10b981;">Fattorino: {{o.driver}}</span>
                    <button class="duplicate" @click="duplicateOrder(o)"><i class="fa-solid fa-copy"></i> Duplica</button>
                </div>
            </div>
        </div>
    </section>

    <section v-show="view==='impostazioni'" class="settings">
        <div v-if="!isAccessGranted">
            <div class="access-container">
                <h2>Accesso Impostazioni Richiesto</h2>
                <p>Inserisci il PIN/Password per accedere alle impostazioni.</p>
                <input type="password" v-model="accessPin" placeholder="PIN/Password" @keyup.enter="grantAccess" required>
                <button class="final-btn" style="max-width: 200px; margin: 10px auto;" @click="grantAccess">Accedi</button>
            </div>
        </div>
        <div v-else>
            <h2>Gestione Account e Sicurezza</h2>
            <div class="form-row">
                <label for="adminPin" style="font-weight: 600;">Modifica PIN/Password Amministratore (Attuale: ****)</label>
                <input type="password" id="adminPin" v-model="newAdminPin" placeholder="Nuovo PIN (es. 0000)" @change="saveAdminPin" required>
            </div>
            
            <hr style="margin: 20px 0;">

            <h2>Gestione Capacità (Flusso Ordini)</h2>
            <div class="form-row">
                <label for="maxPizzas">Pizze massime per intervallo:</label>
                <input type="number" id="maxPizzas" v-model.number="capacitySettings.maxPizzas" min="1" required @change="saveData">
            </div>
            <div class="form-row">
                <label for="intervalMinutes">Durata intervallo (minuti):</label>
                <input type="number" id="intervalMinutes" v-model.number="capacitySettings.intervalMinutes" min="5" step="5" required @change="saveData">
            </div>
            <p style="font-size: 0.9rem; color: #6b7280;">Capacità attuale: {{ capacitySettings.maxPizzas }} pizze ogni {{ capacitySettings.intervalMinutes }} minuti.</p>

            <hr style="margin: 20px 0;">

            <h2>Gestione Fattorini</h2>
            <div class="settings-list">
                <div class="settings-item" v-for="(driver, i) in drivers" :key="i">
                    <span>{{driver}}</span>
                    <button class="remove" @click="deleteDriver(i)">Elimina</button>
                </div>
            </div>
            <form @submit.prevent="addDriver">
                <input type="text" v-model="newDriverName" placeholder="Nome Fattorino (es. Mario Rossi)" required>
                <button type="submit">Aggiungi Fattorino</button>
            </form>

            <hr style="margin: 20px 0;">

            <h2>Gestione Menu e Articoli</h2>
            <div class="cat-row">
                <button class="cat-btn" v-for="c in Object.keys(menu)" :key="c"
                        :class="{active:activeSettingsCat===c}" @click="activeSettingsCat=c">{{c}}</button>
            </div>

            <form @submit.prevent="addCategory" style="margin-bottom: 20px;">
                <input type="text" v-model="newCategoryName" placeholder="Nome Nuova Categoria" required>
                <button type="submit">Aggiungi Categoria</button>
            </form>

            <div v-if="activeSettingsCat">
                <h3>Articoli in {{ activeSettingsCat }} <button class="remove" @click="deleteCategory(activeSettingsCat)">Rimuovi Categoria</button></h3>
                
                <div class="settings-list">
                    <div class="settings-item" v-for="(item, i) in menu[activeSettingsCat]" :key="i">
                        <span>
                            {{item.nome}} - €{{item.prezzo.toFixed(2)}} 
                            <span v-if="item.isMeter && item.totalSections===4">(Mezzo Metro)</span>
                            <span v-if="item.isMeter && item.totalSections===2">(Schiacciata Grande)</span>
                            <span v-if="item.isHalfPizza">(Metà Pizza)</span>
                        </span>
                        <div class="item-status">
                            <button v-if="item.isFinished" @click="toggleItemFinished(activeSettingsCat, i)" class="available">Disponibile</button>
                            <button v-else @click="toggleItemFinished(activeSettingsCat, i)" class="finished">Finito</button>
                            <button class="remove" @click="deleteItem(activeSettingsCat, i)">Elimina</button>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="addItemToCategory">
                    <input type="text" v-model="newItemName" placeholder="Nome Articolo" required>
                    <input type="number" step="0.01" v-model.number="newItemPrice" placeholder="Prezzo" required>
                    <button type="submit">Aggiungi Articolo</button>
                </form>
            </div>

            <hr style="margin: 20px 0;">

            <h2>Gestione Modificatori</h2>
            
            <form @submit.prevent="addModifierCategory" style="margin-bottom: 20px;">
                <input type="text" v-model="newModifierCategoryName" placeholder="Nome Nuova Categoria Modificatori" required>
                <button type="submit">Aggiungi Categoria</button>
            </form>

            <div class="cat-row">
                <button class="cat-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                        :class="{active: activeSettingsModCat===cat}"
                        @click="activeSettingsModCat=cat">{{cat.toUpperCase()}}</button>
            </div>

            <div v-if="activeSettingsModCat">
                <h3>Modificatori in {{ activeSettingsModCat }} <button class="remove" v-if="!isDefaultModifierCategory(activeSettingsModCat)" @click="deleteModifierCategory(activeSettingsModCat)">Rimuovi Categoria</button></h3>
                
                <div class="settings-list">
                    <div class="settings-item" v-for="(mod, i) in modifiers[activeSettingsModCat]" :key="i">
                        <span>{{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span></span>
                        <div class="item-status">
                            <button v-if="mod.isFinished" @click="toggleModifierFinished(activeSettingsModCat, i)" class="available">Disponibile</button>
                            <button v-else @click="toggleModifierFinished(activeSettingsModCat, i)" class="finished">Finito</button>
                            <button class="remove" @click="deleteModifier(activeSettingsModCat, i)">Elimina</button>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="addModifierToCategory">
                    <input type="text" v-model="newModifierName" placeholder="Nome Modificatore" required>
                    <input type="number" step="0.01" v-model.number="newModifierPrice" placeholder="Costo (0 per gratis)" required>
                    <button type="submit">Aggiungi Modificatore</button>
                </form>
            </div>

            <hr style="margin: 20px 0;">

            <h2>Zone di Consegna (Delivery)</h2>
            <div class="settings-list">
                <div class="settings-item" v-for="(zone, i) in deliveryZones" :key="i">
                    <span>{{zone.name}} - €{{zone.price.toFixed(2)}}</span>
                    <button class="remove" @click="deleteZone(i)">Elimina</button>
                </div>
            </div>
            <form @submit.prevent="addZone">
                <input type="text" v-model="newZoneName" placeholder="Nome Zona (es. Centro)" required>
                <input type="number" step="0.01" v-model.number="newZonePrice" placeholder="Costo (€)" required>
                <button type="submit">Aggiungi Zona</button>
            </form>

            <hr style="margin: 20px 0;">

            <h2>Manutenzione Dati</h2>
            <p style="font-size: 0.9rem; color: #b91c1c;">La pulizia elimina SOLO gli **Ordini Attivi** e lo **Storico Archiviato**.</p>
            <div class="modal-actions" style="justify-content: flex-start; gap: 10px;">
                <button type="button" class="btn-cancel" style="background: #10b981;" @click="exportData"><i class="fa-solid fa-file-export"></i> Esporta Backup</button>
                <button type="button" class="btn-confirm" style="background: #3b82f6;" @click="importData"><i class="fa-solid fa-file-import"></i> Importa Backup</button>
            </div>
            <div class="modal-actions" style="justify-content: flex-start; margin-top: 10px;">
                <button type="button" class="final-btn cancel-edit-btn" style="background: #b91c1c;" @click="clearCache"><i class="fa-solid fa-broom"></i> Pulisci Ordini e Storico</button>
            </div>
        </div>
    </section>
</main>

<nav>
    <button :class="{active:view==='inserimento'}" @click="view='inserimento'"><i class="fa-solid fa-cash-register"></i>Inserimento</button>
    <button :class="{active:view==='ordini'}" @click="view='ordini'"><i class="fa-solid fa-clipboard-list"></i>Ordini</button>
    <button :class="{active:view==='storico'}" @click="view='storico'; isAccessGranted=false; accessPin='';"><i class="fa-solid fa-chart-line"></i>Storico</button>
    <button :class="{active:view==='impostazioni'}" @click="view='impostazioni'; isAccessGranted=false; accessPin='';"><i class="fa-solid fa-gear"></i>Impostazioni</button>
</nav>

<div class="modal-overlay" v-show="showModal" @click.self="showModal=false">
    <div class="modal-content">
        <h3>Finalizza Ordine - Totale: €{{total.toFixed(2)}}</h3>
        
        <div class="form-row">
            <label>Modalità di Ritiro/Consegna</label>
            <div class="mode-card" v-for="m in modes" :key="m.id"
                 :class="{active:mode===m.id}" @click="selectMode(m.id)">
                <span><i :class="m.icon"></i> {{m.label}}</span>
                <span v-if="mode===m.id">✔️</span>
            </div>
        </div>

        <form v-if="mode" @submit.prevent="confermaOrdine">
            <div class="form-row">
                <label for="customer">Cognome Cliente *</label>
                <input type="text" id="customer" v-model="customer" @input="filterCustomers" list="customer-suggestions" required>
                <datalist id="customer-suggestions">
                    <option v-for="c in filteredCustomerSuggestions" :value="c.customer" :key="c.customer" @click="loadCustomerData(c)"></option>
                </datalist>
            </div>
            
            <div v-if="mode !== 'consegna'" class="form-row">
                <label for="tableNumber">{{ mode === 'banco' ? 'Numero Tavolo' : 'Numero per Ritiro' }} *</label>
                <input type="text" id="tableNumber" v-model="tableNumber" :required="mode !== 'consegna'">
            </div>

            <div v-if="mode !== 'banco'" class="form-row">
                <label for="phone">Telefono *</label>
                <input type="tel" id="phone" v-model="phone" required>
            </div>
            
            <div v-if="mode === 'consegna'">
                <div class="form-row">
                    <label for="address">Indirizzo (Via/Piazza) *</label>
                    <input type="text" id="address" v-model="address" required>
                </div>
                <div class="form-row">
                    <label for="streetNumber">Civico *</label>
                    <input type="text" id="streetNumber" v-model="streetNumber" required>
                </div>
                <div class="form-row">
                    <label for="zone">Zona *</label>
                    <select id="zone" v-model="zoneName" @change="updateDeliveryCost" required>
                        <option value="" disabled>Seleziona una zona</option>
                        <option v-for="z in deliveryZones" :value="z.name">{{z.name}} ({{z.price.toFixed(2)}}€)</option>
                    </select>
                </div>
                <div class="form-row">
                    <label for="town">Paese *</label>
                    <input type="text" id="town" v-model="town" required>
                </div>
            </div>
            
            <div class="form-row">
                <label for="notes">Note/Istruzioni (es. citofono, piano, allergie)</label>
                <textarea id="notes" v-model="notes"></textarea>
            </div>

            <div class="form-row">
                <label for="date">Data Ordine *</label>
                <input type="date" id="date" v-model="date" required :min="minDate">
            </div>

            <div class="form-row">
                <label for="hour">Ora di Ritiro/Consegna *</label>
                <input type="time" id="hour" v-model="hour" required @change="updateCapacityWarning">
            </div>
            
            <div class="time-capacity" :class="{full: isCapacityFull, warning: isCapacityWarning}" v-if="orderCapacity.total > 0 && orderCapacity.remaining <= capacitySettings.maxPizzas">
                <p style="margin: 0; font-weight: 700;">Capacità per le {{ hour }}:</p>
                <p style="margin: 5px 0 0;">Pizze ordinate: **{{ orderCapacity.total }}** | Pizze libere: **{{ orderCapacity.remaining }}** (Max: {{ capacitySettings.maxPizzas }})</p>
                <p v-if="isCapacityFull" style="margin: 5px 0 0;">**ATTENZIONE: Capacità oraria saturata!**</p>
                <p v-else-if="isCapacityWarning" style="margin: 5px 0 0;">**AVVISO: La capacità si sta esaurendo.**</p>
            </div>

            <div class="form-row" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                <label for="acconto">Contanti Ricevuti (opzionale)</label>
                <input type="number" step="0.01" id="acconto" v-model.number="accontoRicevuto" placeholder="0.00">
            </div>
            <div v-if="restoDaDare > 0" class="total" style="color: #e31b23; font-weight: 700;">
                RESTO DA DARE: €{{ restoDaDare.toFixed(2) }}
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" @click="showModal=false">Annulla</button>
                <button type="submit" class="btn-confirm" :disabled="!isOrderFinalizable || isCapacityFull">{{ editingOrderId ? 'Aggiorna Ordine' : 'Conferma e Salva Ordine' }}</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" v-show="showPriceEditModal" @click.self="showPriceEditModal=false">
    <div class="modal-content">
        <h3>Modifica Prezzo Manuale</h3>
        <p>Articolo: <strong>{{ order[tempPriceEditIndex]?.nome }}</strong></p>
        <div class="form-row">
            <label for="newPrice">Nuovo Prezzo Totale per l'Articolo</label>
            <input type="number" step="0.01" id="newPrice" v-model.number="newPriceValue" required>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-cancel" @click="showPriceEditModal=false">Annulla</button>
            <button class="btn-confirm" @click="saveNewPrice">Salva Nuovo Prezzo</button>
        </div>
    </div>
</div>

<div class="modal-overlay" v-show="showMeterModal" @click.self="showMeterModal=false">
    <div class="modal-content">
        <h3>Componi {{ tempMeterItem?.nome }}</h3>
        <p>Prezzo Base: €{{ tempMeterItem?.prezzo.toFixed(2) }}</p>
        <p style="font-size: 0.9rem; color: #6b7280;">Scegli il numero di gusti, seleziona il gusto base, poi aggiungi i modificatori.</p>
        
        <div class="composition-options cat-row" style="margin-bottom: 20px;">
            <button v-for="num in tempMeterGustiOptions" :key="num" 
                    :class="{'selected': tempMeterItem.gustiCount === num}" 
                    @click="setMeterGustiCount(num)">
                {{ num }} Gusto/i
            </button>
        </div>
        
        <div class="order-box" v-for="(section, secIdx) in tempMeterItem.sections" :key="secIdx" style="margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 6px;">
            <strong>{{ section.name }}</strong>
            
            <div class="form-row">
                <label>Gusto Base *</label>
                <input type="text" 
                       v-model="section.gusto" 
                       :placeholder="'Seleziona gusto per ' + section.name" 
                       @input="section.gusto = section.gusto; tempMeterItem.sections[secIdx].activeSection=true"
                       @blur="tempMeterItem.sections[secIdx].activeSection=false">
            </div>
            
            <div class="grid" v-if="filteredPizzaGustiBySection(secIdx).length > 0 && tempMeterItem.sections[secIdx].activeSection" style="margin-top: 10px;">
                <div class="item" v-for="p in filteredPizzaGustiBySection(secIdx)" :key="p.nome" @click="selectMeterGusto(secIdx, p.nome)" :class="{disabled: p.isFinished}">
                    {{p.nome}}
                </div>
            </div>
            <div class="form-row">
                <label style="margin-top: 10px;">Modifiche Aggiuntive per {{ section.name }}</label>
                <div class="mod-row" style="margin-top: 5px;">
                    <button class="mod-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                            :class="[cat.toLowerCase().includes('più') ? 'green' : cat.toLowerCase().includes('senza') ? 'gray' : cat.toLowerCase().includes('poco') ? 'yellow' : cat.toLowerCase().includes('abbondante') ? 'blue' : '', {active: tempModCat===cat}]"
                            @click="tempModCat=cat; modifierSearchTerm=''">{{cat.toUpperCase()}}</button>
                </div>
                
                <input type="search" v-model="modifierSearchTerm" placeholder="Filtra modificatori..." class="search-mod-input">

                <div class="grid" v-if="filteredTempModifiers.length > 0" style="margin-top: 10px;">
                    <div class="item" v-for="m in filteredTempModifiers" :key="m.nome + m.prezzo" 
                         @click="addMeterModifier(secIdx, m)"
                         :class="{disabled: m.isFinished}">
                        {{m.nome}}
                        <span v-if="m.prezzo > 0">(+€{{m.prezzo.toFixed(2)}})</span>
                    </div>
                </div>

                <ul style="list-style: none; padding-left: 0; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px;">
                    <li v-for="(mod, modIdx) in section.modifiers" :key="modIdx" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                        <span>
                            <span :class="['mod-icon', getModifierCategory(mod.nome)]">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                            {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                        </span>
                        <button class="mod-remove-btn" @click.stop="removeMeterModifier(secIdx, modIdx)">❌</button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-cancel" @click="cancelMeterComposition">Annulla</button>
            <button class="btn-confirm" :disabled="!isMeterValid" @click="addMeterToOrder">Aggiungi a Ordine (Totale stimato: €{{ calculateTempMeterTotal.toFixed(2) }})</button>
        </div>
    </div>
</div>

<div class="modal-overlay" v-show="showHalfPizzaModal" @click.self="showHalfPizzaModal=false">
    <div class="modal-content">
        <h3>Componi {{ tempHalfPizzaItem?.nome }}</h3>
        <p>Prezzo Base: €{{ tempHalfPizzaItem?.prezzo.toFixed(2) }}</p>
        <p style="font-size: 0.9rem; color: #6b7280;">La media dei due gusti verrà arrotondata per eccesso.</p>

        <div style="margin-bottom: 15px; border: 1px solid #e31b23; padding: 10px; border-radius: 6px;">
            <strong>Metà 1</strong>
            <div class="form-row">
                <label>Gusto Base *</label>
                <input type="text" v-model="tempHalfPizzaItem.gusto1" placeholder="Nome Pizza/Gusto..." 
                       @input="tempHalfPizzaItem.gusto1 = tempHalfPizzaItem.gusto1; tempHalfPizzaItem.activeHalf=1">
            </div>
            <input type="search" v-model="gustoSearchTerm" placeholder="Cerca gusti base (Pizze)..." class="search-mod-input" @focus="tempHalfPizzaItem.activeHalf=1" @blur="tempHalfPizzaItem.activeHalf=0">
            <div class="grid" v-if="filteredPizzaGustiHalf(1).length > 0 && tempHalfPizzaItem.activeHalf === 1" style="margin-top: 10px;">
                <div class="item" v-for="p in filteredPizzaGustiHalf(1)" :key="p.nome" @click="selectHalfPizzaGusto(1, p.nome)" :class="{disabled: p.isFinished}">
                    {{p.nome}} ({{p.prezzo.toFixed(2)}}€)
                </div>
            </div>

            <label style="margin-top: 10px; display: block;">Modifiche (Metà 1)</label>
            <div class="mod-row" style="margin-top: 5px;">
                 <button class="mod-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                            :class="[cat.toLowerCase().includes('più') ? 'green' : cat.toLowerCase().includes('senza') ? 'gray' : cat.toLowerCase().includes('poco') ? 'yellow' : cat.toLowerCase().includes('abbondante') ? 'blue' : '', {active: tempModCat===cat}]"
                            @click="tempModCat=cat; modifierSearchTerm=''">{{cat.toUpperCase()}}</button>
            </div>
            <input type="search" v-model="modifierSearchTerm" placeholder="Filtra modificatori..." class="search-mod-input">
            <div class="grid" v-if="filteredTempModifiers.length > 0" style="margin-top: 10px;">
                <div class="item" v-for="m in filteredTempModifiers" :key="m.nome + m.prezzo" 
                     @click="addHalfPizzaModifier(1, m)"
                     :class="{disabled: m.isFinished}">
                    {{m.nome}}
                    <span v-if="m.prezzo > 0">(+€{{m.prezzo.toFixed(2)}})</span>
                </div>
            </div>
            <ul style="list-style: none; padding-left: 0; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px;">
                <li v-for="(mod, modIdx) in tempHalfPizzaItem.modifiers1" :key="modIdx" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                    <span>
                        <span :class="['mod-icon', getModifierCategory(mod.nome)]">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                        {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                    </span>
                    <button class="mod-remove-btn" @click.stop="removeHalfPizzaModifier(1, modIdx)">❌</button>
                </li>
            </ul>
        </div>

        <div style="margin-bottom: 15px; border: 1px solid #3b82f6; padding: 10px; border-radius: 6px;">
            <strong>Metà 2</strong>
            <div class="form-row">
                <label>Gusto Base *</label>
                <input type="text" v-model="tempHalfPizzaItem.gusto2" placeholder="Nome Pizza/Gusto..." 
                       @input="tempHalfPizzaItem.gusto2 = tempHalfPizzaItem.gusto2; tempHalfPizzaItem.activeHalf=2">
            </div>
             <input type="search" v-model="gustoSearchTerm" placeholder="Cerca gusti base (Pizze)..." class="search-mod-input" @focus="tempHalfPizzaItem.activeHalf=2" @blur="tempHalfPizzaItem.activeHalf=0">
            <div class="grid" v-if="filteredPizzaGustiHalf(2).length > 0 && tempHalfPizzaItem.activeHalf === 2" style="margin-top: 10px;">
                <div class="item" v-for="p in filteredPizzaGustiHalf(2)" :key="p.nome" @click="selectHalfPizzaGusto(2, p.nome)" :class="{disabled: p.isFinished}">
                    {{p.nome}} ({{p.prezzo.toFixed(2)}}€)
                </div>
            </div>

             <label style="margin-top: 10px; display: block;">Modifiche (Metà 2)</label>
            <div class="mod-row" style="margin-top: 5px;">
                 <button class="mod-btn" v-for="cat in Object.keys(modifiers)" :key="cat"
                            :class="[cat.toLowerCase().includes('più') ? 'green' : cat.toLowerCase().includes('senza') ? 'gray' : cat.toLowerCase().includes('poco') ? 'yellow' : cat.toLowerCase().includes('abbondante') ? 'blue' : '', {active: tempModCat===cat}]"
                            @click="tempModCat=cat; modifierSearchTerm=''">{{cat.toUpperCase()}}</button>
            </div>
            <input type="search" v-model="modifierSearchTerm" placeholder="Filtra modificatori..." class="search-mod-input">
            <div class="grid" v-if="filteredTempModifiers.length > 0" style="margin-top: 10px;">
                <div class="item" v-for="m in filteredTempModifiers" :key="m.nome + m.prezzo" 
                     @click="addHalfPizzaModifier(2, m)"
                     :class="{disabled: m.isFinished}">
                    {{m.nome}}
                    <span v-if="m.prezzo > 0">(+€{{m.prezzo.toFixed(2)}})</span>
                </div>
            </div>
            <ul style="list-style: none; padding-left: 0; margin-top: 10px; border-top: 1px dotted #ccc; padding-top: 5px;">
                <li v-for="(mod, modIdx) in tempHalfPizzaItem.modifiers2" :key="modIdx" style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                    <span>
                        <span :class="['mod-icon', getModifierCategory(mod.nome)]">{{ getModifierIcon(getModifierCategory(mod.nome)) }}</span>
                        {{mod.nome}} <span v-if="mod.prezzo > 0">(+€{{mod.prezzo.toFixed(2)}})</span>
                    </span>
                    <button class="mod-remove-btn" @click.stop="removeHalfPizzaModifier(2, modIdx)">❌</button>
                </li>
            </ul>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-cancel" @click="cancelHalfPizzaComposition">Annulla</button>
            <button class="btn-confirm" :disabled="!isHalfPizzaValid" @click="addHalfPizzaToOrder">Aggiungi a Ordine (Totale arrotondato: €{{ calculateTempHalfPizzaTotal.toFixed(2) }})</button>
        </div>
    </div>
</div>

<div class="modal-overlay" v-show="showShareModal" @click.self="showShareModal=false">
    <div class="modal-content">
        <h3>Azioni Ordine #{{selectedOrderForShare?.id}}</h3>
        <p>Cliente: <strong>{{ selectedOrderForShare?.customer }}</strong></p>
        <p>Ora: <strong>{{ selectedOrderForShare?.hour }}</strong></p>
        
        <button class="final-btn" @click="shareViaWhatsapp(selectedOrderForShare)" style="background: #25d366;"><i class="fa-brands fa-whatsapp"></i> Invia Dettagli (WhatsApp)</button>
        
        <button class="final-btn" @click="printOrder(selectedOrderForShare?.id, 'comanda')" style="background: #e31b23;"><i class="fa-solid fa-pizza-slice"></i> Stampa Comanda Cucina</button>
        <button class="final-btn" @click="printOrder(selectedOrderForShare?.id, 'scontrino')" style="background: #6b7280;"><i class="fa-solid fa-receipt"></i> Stampa Scontrino Banco</button>
        
        <button type="button" class="btn-cancel" @click="showShareModal=false" style="width: 100%; margin-top: 10px;">Chiudi</button>
    </div>
</div>


<div class="print-container">
    <div id="print-content-comanda" class="print-comanda" style="display:none;"></div>
    <div id="print-content-scontrino" class="print-scontrino" style="display:none;"></div>
</div>
<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<script>
    // ⭐ FUNZIONI HELPER PER GESTIRE LE DATE LOCALI ⭐
    function getTodayLocalString() {
        const today = new Date();
        return `${today.getFullYear()}-${
            String(today.getMonth() + 1).padStart(2, '0')
        }-${
            String(today.getDate()).padStart(2, '0')
        }`;
    }

    function getTomorrowLocalString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return `${tomorrow.getFullYear()}-${
            String(tomorrow.getMonth() + 1).padStart(2, '0')
        }-${
            String(tomorrow.getDate()).padStart(2, '0')
        }`;
    }

    function getTodayDateString() {
        return getTodayLocalString();
    }

    function getDefaultHour() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function roundUpToHalf(num) {
        // Arrotonda il numero per eccesso al decimo superiore (es. 7.51 -> 7.6)
        return Math.ceil(num * 10) / 10;
    }
    
    function deepClone(obj) {
        if (obj === null || typeof obj !== 'object') {
            return obj;
        }
        // Correzione di stabilità: Usiamo JSON per una clonazione profonda sicura
        return JSON.parse(JSON.stringify(obj));
    }
    // ⭐ /FUNZIONI HELPER ⭐

    PetiteVue.createApp({
        view:'inserimento',
        showModal: false, 
        showShareModal: false,
        showMeterModal: false, 
        showHalfPizzaModal: false, 
        showPriceEditModal: false,
        selectedOrderIdForShare: null,
        editingOrderId: null, 
        
        // Accesso
        adminPin: localStorage.getItem('pz_admin_pin') || '0000',
        newAdminPin: '',
        accessPin: '',
        isAccessGranted: false, 

        // Capacità Oraria
        capacitySettings: JSON.parse(localStorage.getItem('pz_capacity_settings') || '{"maxPizzas": 20, "intervalMinutes": 30}'),
        orderCapacity: { total: 0, remaining: 0, interval: '' },

        // --- DATI INIZIALI ---
        menu: JSON.parse(localStorage.getItem('pz_menu')||'{"Pizza Classica":[{"nome":"Margherita","prezzo":6.00},{"nome":"Diavola","prezzo":7.50},{"nome":"Capricciosa","prezzo":8.00}],"Pizze Speciali":[{"nome":"Pistacchio & Mortazza","prezzo":12.00}],"Pizza a Metà":[{"nome":"Pizza a Metà","prezzo":0.00,"isHalfPizza":true}],"Mezzo Metro":[{"nome":"Mezzo Metro","prezzo":16.00,"isMeter":true,"totalSections":4}],"Schiacciata Grande":[{"nome":"Schiacciata Grande","prezzo":12.00,"isMeter":true,"totalSections":2}],"Bevande":[{"nome":"Acqua Nat","prezzo":2.00}],"Dolci":[{"nome":"Tiramisù","prezzo":4.50}]}'),
        modifiers: JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[{"nome":"Mozzarella","prezzo":0.50},{"nome":"Wurstel","prezzo":1.00}],"Senza":[{"nome":"Aglio","prezzo":0.00}],"Poco":[{"nome":"Sale","prezzo":0.00}],"Abbondante":[{"nome":"Olio","prezzo":0.00}]}'),
        deliveryZones: JSON.parse(localStorage.getItem('pz_zones')||'[{"name":"Zona A","price":3.00},{"name":"Zona B","price":4.00}]'),
        orders: JSON.parse(localStorage.getItem('pz_orders')||'[]'),
        archive: JSON.parse(localStorage.getItem('pz_archive')||'[]'), 
        drivers: JSON.parse(localStorage.getItem('pz_drivers')||'["Mario","Luigi"]'),
        customerData: JSON.parse(localStorage.getItem('pz_customerData')||'[]'), 

        // Stato Ordine Corrente
        activeCat:'Pizza Classica',
        activeModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più',
        order:[],
        calculatedOrderTotal: 0, 
        total:0, 
        selectedItemIndex: null,
        lastSelectedItem: null, 
        searchTerm: '',
        modifierSearchTerm: '', 
        gustoSearchTerm: '', 

        // Stato Modifica Prezzo
        tempPriceEditIndex: null,
        newPriceValue: 0,

        // Stato Composizione
        tempMeterItem: null, 
        tempHalfPizzaItem: null, 
        tempModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più', 
        
        // Dati per il Modale/Finalizzazione
        modes:[
            {id:"consegna",label:"Consegna a domicilio",icon:"fa-solid fa-truck"},
            {id:"asporto",label:"Asporto",icon:"fa-solid fa-bag-shopping"},
            {id:"banco",label:"Banco",icon:"fa-solid fa-chair"}
        ],
        mode:'',
        customer:'',
        phone:'',
        address:'',
        streetNumber:'',
        zoneName:'', 
        deliveryCost: 0, 
        town:'',
        notes: '',
        tableNumber: '', 
        date: getTodayDateString(), 
        hour: getDefaultHour(),
        driver: '', 
        minDate: getTodayDateString(), 
        accontoRicevuto: null, 

        // Filtri Ordini Attivi
        activeDateFilter: 'today', 
        activeOrderSearchTerm: '', 
        filteredCustomerSuggestions: [],

        // Dati per Storico/Statistiche
        selectedDriver: '', 
        driverStats: { totalOrders: 0, totalRevenue: 0 }, 
        archiveDateFilter: getTodayDateString(),

        // Stati Ordine semplificati
        orderStatuses: ["In preparazione", "Pronto"],

        // Dati per Impostazioni
        activeSettingsCat: 'Pizza Classica', 
        activeSettingsModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più',
        newCategoryName: '',
        newItemName: '',
        newItemPrice: 0,
        newModifierCategoryName: '',
        newModifierName: '',
        newModifierPrice: 0,
        newZoneName: '',
        newZonePrice: 0,
        newDriverName: '',

        get calculatedOrderTotal(){
            if (this.order.length === 0) return 0;
            return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
        },
        get total(){
            return this.calculatedOrderTotal + this.deliveryCost;
        },
        get restoDaDare(){
            if (this.accontoRicevuto > this.total) {
                return this.accontoRicevuto - this.total;
            }
            return 0;
        },
        get archiveDateFilterDisplay(){
             const date = new Date(this.archiveDateFilter.replace(/-/g, '/'));
             return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        },
        get availableDrivers(){
            return this.drivers;
        },
        get selectedOrderForShare() {
            return this.orders.find(o => o.id === this.selectedOrderIdForShare);
        },

        // LOGICA MENU E MODIFICATORI
        get allItems() {
            return Object.values(this.menu).flat();
        },
        get filteredAvailableItems() {
            let items = this.menu[this.activeCat] || [];
            const term = this.searchTerm.toLowerCase().trim();

            if (term) {
                items = this.allItems.filter(p => p.nome.toLowerCase().includes(term));
            }
            return items;
        },
        get filteredModifiersForActiveCat() {
            let mods = this.modifiers[this.activeModCat] || [];
            const term = this.modifierSearchTerm.toLowerCase().trim();
            if (term) {
                mods = mods.filter(m => m.nome.toLowerCase().includes(term));
            }
            return mods;
        },
        get filteredPizzaGusti() {
            const items = (this.menu['Pizza Classica'] || []).concat(this.menu['Pizze Speciali'] || []);
            const term = this.gustoSearchTerm.toLowerCase().trim();
            
            let filtered = items.filter(p => !p.isFinished);
            
            if (term) {
                filtered = filtered.filter(p => p.nome.toLowerCase().includes(term));
            }
            return filtered;
        },
        get allPizzaGusti() {
             return (this.menu['Pizza Classica'] || []).concat(this.menu['Pizze Speciali'] || []).filter(item => !item.isFinished);
        },
        get canComposeMeter(){
            return (this.menu['Pizza Classica']?.length > 0 || this.menu['Pizze Speciali']?.length > 0);
        },
        get canComposeHalfPizza(){
            return (this.menu['Pizza Classica']?.length > 0 || this.menu['Pizze Speciali']?.length > 0);
        },
        get filteredTempModifiers() {
            let mods = this.modifiers[this.tempModCat] || [];
            const term = this.modifierSearchTerm.toLowerCase().trim(); 
            if (term) {
                mods = mods.filter(m => m.nome.toLowerCase().includes(term));
            }
            return mods;
        },
        get tempMeterGustiOptions() {
            if (!this.tempMeterItem) return [1, 2, 3];
            if (this.tempMeterItem.totalSections === 2) return [1, 2]; 
            return [1, 2, 3];
        },
        get isMeterValid() {
            if (!this.tempMeterItem || this.tempMeterItem.gustiCount === 0) return false;
            
            const sectionsWithGusto = this.tempMeterItem.sections
                .filter(s => s.gusto && s.gusto.trim().length > 0)
                .length;
                
            if (sectionsWithGusto !== this.tempMeterItem.gustiCount) return false;

            return true;
        },
        get isHalfPizzaValid() {
            if (!this.tempHalfPizzaItem) return false;
            return this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto1.trim().length > 0 && 
                   this.tempHalfPizzaItem.gusto2 && this.tempHalfPizzaItem.gusto2.trim().length > 0;
        },

        // Logica Capacità
        get isCapacityFull() {
            return this.orderCapacity.remaining <= 0;
        },
        get isCapacityWarning() {
            return this.orderCapacity.remaining <= (this.capacitySettings.maxPizzas * 0.2); 
        },
        // --- FINE LOGICA MENU ---

        // LOGICA ORDINE ATTIVO E FILTRI (Invariata)
        get filteredActiveOrders() {
            let filtered = [...this.orders].sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.hour}`);
                const dateTimeB = new Date(`${b.date}T${b.hour}`);
                return dateTimeA - dateTimeB;
            });

            const todayStr = getTodayDateString();
            const tomorrowStr = getTomorrowLocalString();

            if (this.activeDateFilter === 'today') {
                filtered = filtered.filter(o => o.date === todayStr);
            } else if (this.activeDateFilter === 'tomorrow') {
                filtered = filtered.filter(o => o.date === tomorrowStr);
            } else if (this.activeDateFilter === 'future') {
                filtered = filtered.filter(o => {
                    const orderDate = new Date(o.date.replace(/-/g, '/'));
                    const tomorrowDate = new Date(tomorrowStr.replace(/-/g, '/'));
                    return orderDate.getTime() > tomorrowDate.getTime();
                });
            }

            if (this.activeOrderSearchTerm.trim()) {
                const term = this.activeOrderSearchTerm.toLowerCase().trim();
                filtered = filtered.filter(o =>
                    o.customer.toLowerCase().includes(term) ||
                    o.tableNumber.toLowerCase().includes(term) ||
                    o.address.toLowerCase().includes(term) ||
                    o.notes.toLowerCase().includes(term)
                );
            }

            return filtered;
        },
        // --- FINE LOGICA ORDINE ATTIVO ---

        // LOGICA STORICO (Invariata)
        get filteredArchive() {
            const dateStr = this.archiveDateFilter;
            return this.archive.filter(o => o.archivedDate.startsWith(dateStr));
        },
        get dailyTotal() {
            return this.filteredArchive.reduce((sum, o) => sum + o.total, 0);
        },
        // --- FINE LOGICA STORICO ---

        // METODI PRINCIPALI

        saveData(){
            localStorage.setItem('pz_menu',JSON.stringify(this.menu));
            localStorage.setItem('pz_orders',JSON.stringify(this.orders));
            localStorage.setItem('pz_modifiers',JSON.stringify(this.modifiers));
            localStorage.setItem('pz_zones',JSON.stringify(this.deliveryZones));
            localStorage.setItem('pz_archive',JSON.stringify(this.archive)); 
            localStorage.setItem('pz_drivers',JSON.stringify(this.drivers)); 
            localStorage.setItem('pz_customerData',JSON.stringify(this.customerData)); 
            localStorage.setItem('pz_capacity_settings', JSON.stringify(this.capacitySettings));
            localStorage.setItem('pz_admin_pin', this.adminPin); 
        },

        calculateItemTotal(item) {
            if (item.manualPrice !== undefined) {
                return item.manualPrice;
            }

            let total = item.prezzo || 0;
            
            if (item.modifiers && !item.isMeter && !item.isHalfPizza) {
                total += item.modifiers.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
            }

            if (item.isMeter && item.sections) {
                total += item.sections.reduce((sectionSum, section) => {
                    if (section.modifiers) {
                        return sectionSum + section.modifiers.reduce((modSum, mod) => modSum + (mod.prezzo || 0), 0);
                    }
                    return sectionSum;
                }, 0);
            }

            if (item.isHalfPizza) {
                let gustiPrice = 0;
                
                const gusto1Item = this.allPizzaGusti.find(p => p.nome === item.gusto1);
                if (gusto1Item) gustiPrice += gusto1Item.prezzo;
                
                const gusto2Item = this.allPizzaGusti.find(p => p.nome === item.gusto2);
                if (gusto2Item) gustiPrice += gusto2Item.prezzo;

                let modifiersPrice = 0;
                if (item.modifiers1) {
                    modifiersPrice += item.modifiers1.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
                }
                if (item.modifiers2) {
                    modifiersPrice += item.modifiers2.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
                }

                let subTotal = (total + gustiPrice) / 2;
                subTotal = roundUpToHalf(subTotal);

                total = subTotal + modifiersPrice;
            }
            
            return total;
        },
        
        // Logica per l'aggiunta di un prodotto base o composizione
        handleItemClick(item) {
            if (item.isFinished) return; 
            
            this.lastSelectedItem = item; 
            
            if (item.isMeter) {
                if (!this.canComposeMeter) {
                    alert("Non puoi comporre un Mezzo Metro / Schiacciata se non hai pizze base nel Menu!");
                    return;
                }
                this.tempMeterItem = deepClone(item);
                this.tempMeterItem.gustiCount = 1; 
                this.setMeterGustiCount(1); 
                
                this.tempModCat = Object.keys(this.modifiers)[0] || 'Più';
                this.modifierSearchTerm = '';
                this.gustoSearchTerm = '';
                this.showMeterModal = true;
            } else if (item.isHalfPizza) {
                if (!this.canComposeHalfPizza) {
                     alert("Non puoi comporre una Pizza a Metà se non hai pizze base nel Menu!");
                    return;
                }
                this.tempHalfPizzaItem = deepClone(item);
                this.tempHalfPizzaItem.gusto1 = '';
                this.tempHalfPizzaItem.gusto2 = '';
                this.tempHalfPizzaItem.modifiers1 = [];
                this.tempHalfPizzaItem.modifiers2 = [];
                this.tempHalfPizzaItem.activeHalf = 0; 
                this.tempModCat = Object.keys(this.modifiers)[0] || 'Più';
                this.modifierSearchTerm = '';
                this.gustoSearchTerm = '';
                this.showHalfPizzaModal = true;
            } else {
                this.addItem(item);
            }
        },

        addItem(item) {
             const newItem = deepClone(item); 
             if (!newItem.isMeter && !newItem.isHalfPizza) {
                newItem.modifiers = []; 
             }
             this.order.push(newItem);
             this.selectedItemIndex = this.order.length - 1; 
             this.activeModCat = Object.keys(this.modifiers)[0] || 'Più';
             this.modifierSearchTerm = ''; 
        },

        addExtra(modifier) {
            if (this.selectedItemIndex === null) {
                alert("Seleziona prima un articolo nel carrello!");
                return;
            }
            if (modifier.isFinished) return; 
            
            const item = this.order[this.selectedItemIndex];
            if (item.isMeter || item.isHalfPizza) return; 
            
            const newMod = deepClone(modifier);
            if (!item.modifiers) item.modifiers = [];
            
            item.modifiers.push(newMod);
            if (item.manualPrice !== undefined) delete item.manualPrice;
            this.order = [...this.order]; 
        },

        removeItem(index) {
            this.order.splice(index, 1);
            if (this.selectedItemIndex === index) {
                this.selectedItemIndex = null;
            } else if (this.selectedItemIndex > index) {
                this.selectedItemIndex--;
            }
            this.order = [...this.order];
        },
        removeModifier(itemIndex, modIndex) {
            this.order[itemIndex].modifiers.splice(modIndex, 1);
            if (this.order[itemIndex].manualPrice !== undefined) delete this.order[itemIndex].manualPrice;
            this.order = [...this.order];
        },

        // Logica Modifica Prezzo Manuale
        openPriceEditModal(index) {
            this.tempPriceEditIndex = index;
            const currentPrice = this.calculateItemTotal(this.order[index]);
            this.newPriceValue = parseFloat(currentPrice.toFixed(2)); 
            this.showPriceEditModal = true;
        },
        saveNewPrice() {
            if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                const item = this.order[this.tempPriceEditIndex];
                item.manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                alert(`Prezzo di ${item.nome} aggiornato manualmente a €${this.newPriceValue.toFixed(2)}.`);
                
                this.selectedItemIndex = null; 
            }
            this.showPriceEditModal = false;
            this.tempPriceEditIndex = null;
        },

        // Logica Autocomplete/Clienti (Invariata)
        filterCustomers() {
            const term = this.customer.toLowerCase().trim();
            if (term.length < 2) {
                this.filteredCustomerSuggestions = [];
                return;
            }
            const uniqueCustomers = [];
            const namesAdded = new Set();
            for (const data of this.customerData) {
                if (data.customer.toLowerCase().includes(term) && !namesAdded.has(data.customer)) {
                    uniqueCustomers.push(data);
                    namesAdded.add(data.customer);
                }
                if (uniqueCustomers.length >= 5) break; 
            }
            this.filteredCustomerSuggestions = uniqueCustomers;
        },
        
        loadCustomerData(data) {
            this.customer = data.customer;
            this.phone = data.phone || '';
            this.address = data.address || '';
            this.streetNumber = data.streetNumber || '';
            this.zoneName = data.zone || '';
            this.town = data.town || '';
            this.deliveryCost = data.deliveryCost || 0; 
            this.updateDeliveryCost();
            this.filteredCustomerSuggestions = [];
        },
        
        saveCustomerData() {
            if (!this.customer.trim()) return;

            const existingIndex = this.customerData.findIndex(c => c.customer === this.customer.trim());

            const newCustomerEntry = {
                customer: this.customer.trim(),
                phone: this.phone.trim(),
                address: this.address.trim(),
                streetNumber: this.streetNumber.trim(),
                zone: this.zoneName,
                town: this.town.trim(),
                deliveryCost: this.deliveryCost,
                lastOrder: Date.now() 
            };
            
            if (existingIndex !== -1) {
                this.customerData.splice(existingIndex, 1); 
            }
            this.customerData.unshift(newCustomerEntry);
            this.customerData = this.customerData.slice(0, 50); 
            this.saveData();
        },

        confermaOrdine(){
            if (!this.isOrderFinalizable) {
                alert("Per finalizzare l'ordine devi inserire Cliente e Articoli. Controlla anche Indirizzo e Zona se in modalità Consegna.");
                return;
            }
            if (this.isCapacityFull) {
                if (!confirm("ATTENZIONE: La fascia oraria è al completo. Vuoi comunque confermare l'ordine?")) {
                    return;
                }
            }

            const orderItemsClone = deepClone(this.order);

            let ord = {
                id: this.editingOrderId || Date.now(), 
                items: orderItemsClone,
                total: this.total, 
                mode: this.mode,
                customer: this.customer.trim(),
                phone: this.phone.trim(),
                address: this.address.trim(),
                streetNumber: this.streetNumber.trim(),
                zone: this.zoneName, 
                deliveryCost: this.deliveryCost, 
                town: this.town.trim(),
                notes: this.notes.trim(),
                tableNumber: this.tableNumber.trim(), 
                date: this.date, 
                hour: this.hour,
                driver: this.mode === 'consegna' ? (this.editingOrderId ? (this.orders.find(o => o.id === this.editingOrderId)?.driver || '') : '') : '',
                status: this.editingOrderId ? (this.orders.find(o => o.id === this.editingOrderId)?.status || 'In preparazione') : 'In preparazione', 
                acconto: this.accontoRicevuto || 0 
            };
            
            if (this.editingOrderId) {
                const index = this.orders.findIndex(o => o.id === this.editingOrderId);
                if (index !== -1) {
                    this.orders[index] = ord;
                    alert("Ordine #" + ord.id + " aggiornato!");
                }
            } else {
                this.orders.push(ord);
                alert("Ordine #" + ord.id + " salvato!");
            }
            
            if (this.mode === 'consegna' || (this.mode === 'asporto' && this.customer.trim() && this.phone.trim())) {
                this.saveCustomerData();
            }

            this.saveData();
            this.resetCurrentOrderState();
            this.showModal = false;
            this.view = 'ordini';
        },

        // Logica composizione Mezzo Metro (SEMPLIFICATA)
        setMeterGustiCount(count) {
            this.tempMeterItem.gustiCount = count;
            this.tempMeterItem.sections = []; 
            
            for (let i = 0; i < count; i++) {
                this.tempMeterItem.sections.push({
                    name: `Gusto ${i + 1}`,
                    gusto: null,
                    modifiers: [],
                    activeSection: false 
                });
            }
        },
        // FUNZIONE AGGIUNTA PER FILTRO GUSTI
        filteredPizzaGustiBySection(secIdx) {
            const currentSection = this.tempMeterItem?.sections[secIdx];
            if (!currentSection) return [];
            
            const term = currentSection.gusto?.toLowerCase().trim() || ''; 
            
            let filtered = this.allPizzaGusti;
            if (term) {
                filtered = filtered.filter(p => p.nome.toLowerCase().includes(term));
            }
            return filtered;
        },
        selectMeterGusto(secIdx, gustoName) {
            this.tempMeterItem.sections[secIdx].gusto = gustoName;
            this.tempMeterItem.sections[secIdx].activeSection = false; 
            this.gustoSearchTerm = '';
        },
        addMeterModifier(secIdx, modifier) {
             if (modifier.isFinished) return;
             
             const newMod = deepClone(modifier);
             if (!this.tempMeterItem.sections[secIdx].modifiers) {
                 this.tempMeterItem.sections[secIdx].modifiers = [];
             }
             this.tempMeterItem.sections[secIdx].modifiers.push(newMod);
             
             if (this.tempMeterItem.manualPrice !== undefined) delete this.tempMeterItem.manualPrice;
        },
        removeMeterModifier(secIdx, modIdx) {
            this.tempMeterItem.sections[secIdx].modifiers.splice(modIdx, 1);
            if (this.tempMeterItem.manualPrice !== undefined) delete this.tempMeterItem.manualPrice;
        },
        cancelMeterComposition() {
            this.tempMeterItem = null;
            this.showMeterModal = false;
            this.lastSelectedItem = null; 
        },
        addMeterToOrder() {
            if (!this.isMeterValid) {
                alert("Devi selezionare un gusto per tutti i gusti richiesti!");
                return;
            }
            const itemToAdd = deepClone(this.tempMeterItem);
            this.order.push(itemToAdd);
            this.selectedItemIndex = this.order.length - 1;
            this.tempMeterItem = null;
            this.showMeterModal = false;
        },
        get calculateTempMeterTotal() {
            return this.tempMeterItem ? this.calculateItemTotal(this.tempMeterItem) : 0;
        },

        // Logica composizione Pizza a Metà (AGGIORNATA per filtro)
        filteredPizzaGustiHalf(half) {
            const term = (half === 1 ? this.tempHalfPizzaItem?.gusto1 : this.tempHalfPizzaItem?.gusto2)?.toLowerCase().trim() || '';
            
            let filtered = this.allPizzaGusti;
            if (term) {
                filtered = filtered.filter(p => p.nome.toLowerCase().includes(term));
            }
            return filtered;
        },
        selectHalfPizzaGusto(half, gustoName) {
            if (half === 1) {
                this.tempHalfPizzaItem.gusto1 = gustoName;
            } else {
                this.tempHalfPizzaItem.gusto2 = gustoName;
            }
            this.tempHalfPizzaItem.activeHalf = 0;
            this.gustoSearchTerm = '';
        },
        addHalfPizzaModifier(half, modifier) {
            if (modifier.isFinished) return;

            const newMod = deepClone(modifier);
            if (half === 1) {
                if (!this.tempHalfPizzaItem.modifiers1) this.tempHalfPizzaItem.modifiers1 = [];
                this.tempHalfPizzaItem.modifiers1.push(newMod);
            } else {
                if (!this.tempHalfPizzaItem.modifiers2) this.tempHalfPizzaItem.modifiers2 = [];
                this.tempHalfPizzaItem.modifiers2.push(newMod);
            }
            if (this.tempHalfPizzaItem.manualPrice !== undefined) delete this.tempHalfPizzaItem.manualPrice;
        },
        removeHalfPizzaModifier(half, modIdx) {
            if (half === 1) {
                this.tempHalfPizzaItem.modifiers1.splice(modIdx, 1);
            } else {
                this.tempHalfPizzaItem.modifiers2.splice(modIdx, 1);
            }
             if (this.tempHalfPizzaItem.manualPrice !== undefined) delete this.tempHalfPizzaItem.manualPrice;
        },
        cancelHalfPizzaComposition() {
            this.tempHalfPizzaItem = null;
            this.showHalfPizzaModal = false;
            this.lastSelectedItem = null; 
        },
        addHalfPizzaToOrder() {
            if (!this.isHalfPizzaValid) return;
            const itemToAdd = deepClone(this.tempHalfPizzaItem);
            this.order.push(itemToAdd);
            this.selectedItemIndex = this.order.length - 1;
            this.tempHalfPizzaItem = null;
            this.showHalfPizzaModal = false;
        },
        get calculateTempHalfPizzaTotal() {
            return this.tempHalfPizzaItem ? this.calculateItemTotal(this.tempHalfPizzaItem) : 0;
        },
        selectItem(index) {
            this.selectedItemIndex = this.selectedItemIndex === index ? null : index;
        },

        // Logica Capacità Oraria (Invariata)
        getIntervalStart(dateStr, hourStr) {
            const date = new Date(`${dateStr}T${hourStr}`);
            const intervalMinutes = this.capacitySettings.intervalMinutes;
            const minutes = date.getMinutes();
            const startMinutes = Math.floor(minutes / intervalMinutes) * intervalMinutes;
            
            date.setMinutes(startMinutes);
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            return date.toISOString();
        },
        getPizzasInOrder(order) {
            return order.items.filter(i => 
                (this.menu['Pizza Classica'] && this.menu['Pizza Classica'].some(p => p.nome === i.nome)) ||
                (this.menu['Pizze Speciali'] && this.menu['Pizze Speciali'].some(p => p.nome === i.nome)) ||
                i.isHalfPizza || i.isMeter
            ).length;
        },
        updateCapacityWarning() {
            if (!this.date || !this.hour) return;

            const targetInterval = this.getIntervalStart(this.date, this.hour);
            let pizzasCount = 0;

            this.orders.forEach(o => {
                if (o.date === this.date) {
                    const orderInterval = this.getIntervalStart(o.date, o.hour);
                    if (orderInterval === targetInterval) {
                        if (o.id !== this.editingOrderId) { 
                             pizzasCount += this.getPizzasInOrder(o);
                        }
                    }
                }
            });

            pizzasCount += this.order.filter(i => 
                (this.menu['Pizza Classica'] && this.menu['Pizza Classica'].some(p => p.nome === i.nome)) ||
                (this.menu['Pizze Speciali'] && this.menu['Pizze Speciali'].some(p => p.nome === i.nome)) ||
                i.isHalfPizza || i.isMeter
            ).length;
            
            this.orderCapacity.total = pizzasCount;
            this.orderCapacity.remaining = this.capacitySettings.maxPizzas - pizzasCount;
            this.orderCapacity.interval = targetInterval;
        },
        openModal() {
            this.zoneName = this.deliveryZones[0]?.name || ''; 
            this.updateDeliveryCost(); 
            this.updateCapacityWarning();
            this.showModal = true;
        },

        // --- FUNZIONI DI IMPOSTAZIONI ---
        isDefaultModifierCategory(cat) {
            const defaultCats = ["Più", "Senza", "Poco", "Abbondante"];
            return defaultCats.includes(cat);
        },

        addCategory() {
            const name = this.newCategoryName.trim();
            if (name && !this.menu[name]) {
                this.menu[name] = [];
                this.newCategoryName = '';
                this.activeSettingsCat = name;
                this.saveData();
            } else if (this.menu[name]) {
                alert("Categoria già esistente!");
            }
        },
        deleteCategory(cat) {
            const defaultCategories = ['Pizza Classica', 'Pizze Speciali', 'Pizza a Metà', 'Mezzo Metro', 'Schiacciata Grande', 'Bevande', 'Dolci'];
            if (defaultCategories.includes(cat)) {
                alert(`Non puoi eliminare la categoria predefinita: ${cat}.`);
                return;
            }
            if (Object.keys(this.menu).length <= 1) {
                alert('Non puoi eliminare l\'unica categoria rimasta.');
                return;
            }
            if (confirm(`Sei sicuro di voler eliminare la categoria "${cat}"? Verranno eliminati anche tutti gli articoli al suo interno.`)) {
                delete this.menu[cat];
                this.activeSettingsCat = Object.keys(this.menu)[0] || null;
                this.saveData();
            }
        },

        addItemToCategory() {
            const cat = this.activeSettingsCat;
            const name = this.newItemName.trim();
            const price = parseFloat(this.newItemPrice);

            if (name && price >= 0) {
                const existing = this.menu[cat]?.some(item => item.nome.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Articolo già esistente in questa categoria!");
                    return;
                }
                
                let newItem = { nome: name, prezzo: price, isFinished: false };
                // Forza proprietà per categorie speciali
                if (cat === 'Pizza a Metà') {
                    newItem.isHalfPizza = true;
                } else if (cat === 'Mezzo Metro') {
                    newItem.isMeter = true;
                    newItem.totalSections = 4;
                } else if (cat === 'Schiacciata Grande') {
                    newItem.isMeter = true;
                    newItem.totalSections = 2;
                }

                this.menu[cat].push(newItem);
                this.newItemName = '';
                this.newItemPrice = 0;
                this.saveData();
            }
        },
        deleteItem(cat, index) {
            if (confirm(`Sei sicuro di voler eliminare l'articolo "${this.menu[cat][index].nome}"?`)) {
                this.menu[cat].splice(index, 1);
                this.saveData();
            }
        },
        toggleItemFinished(cat, index) {
            const item = this.menu[cat][index];
            item.isFinished = !item.isFinished;
            this.saveData();
        },

        // Gestione Zone (Invariata)
        addZone() {
            const name = this.newZoneName.trim();
            const price = parseFloat(this.newZonePrice);

            if (name && price >= 0) {
                const existing = this.deliveryZones.some(z => z.name.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Zona già esistente!");
                    return;
                }
                this.deliveryZones.push({ name: name, price: price });
                this.newZoneName = '';
                this.newZonePrice = 0;
                this.saveData();
            }
        },
        deleteZone(index) {
             if (confirm(`Sei sicuro di voler eliminare la zona "${this.deliveryZones[index].name}"?`)) {
                this.deliveryZones.splice(index, 1);
                this.saveData();
            }
        },
        
        // Gestione Fattorini (Invariata)
        addDriver() {
             const name = this.newDriverName.trim();
             if (name && !this.drivers.includes(name)) {
                 this.drivers.push(name);
                 this.newDriverName = '';
                 this.saveData();
             } else if (this.drivers.includes(name)) {
                 alert("Fattorino già esistente!");
             }
        },
        deleteDriver(index) {
            if (confirm(`Sei sicuro di voler eliminare il fattorino "${this.drivers[index]}"?`)) {
                this.drivers.splice(index, 1);
                this.saveData();
            }
        },
        
        // Gestione Modificatori (Invariata)
        addModifierCategory() {
            const name = this.newModifierCategoryName.trim();
            if (name && !this.modifiers[name]) {
                this.modifiers[name] = [];
                this.newModifierCategoryName = '';
                this.activeSettingsModCat = name;
                this.saveData();
            } else if (this.modifiers[name]) {
                alert("Categoria modificatori già esistente!");
            }
        },
        deleteModifierCategory(cat) {
             if (this.isDefaultModifierCategory(cat)) {
                alert("Non puoi eliminare le categorie predefinite (Più, Senza, Poco, Abbondante).");
                return;
            }
            if (this.modifiers[cat] && Object.keys(this.modifiers).length <= 1) {
                alert('Non puoi eliminare l\'unica categoria rimasta.');
                return;
            }
            if (confirm(`Sei sicuro di voler eliminare la categoria di modificatori "${cat}"?`)) {
                delete this.modifiers[cat];
                this.activeSettingsModCat = Object.keys(this.modifiers)[0] || null;
                this.saveData();
            }
        },
        addModifierToCategory() {
            const cat = this.activeSettingsModCat;
            const name = this.newModifierName.trim();
            const price = parseFloat(this.newModifierPrice);

            if (name && price >= 0) {
                const existing = this.modifiers[cat]?.some(mod => mod.nome.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Modificatore già esistente in questa categoria!");
                    return;
                }
                this.modifiers[cat].push({ nome: name, prezzo: price, isFinished: false });
                this.newModifierName = '';
                this.newModifierPrice = 0;
                this.saveData();
            }
        },
        deleteModifier(cat, index) {
            if (confirm(`Sei sicuro di voler eliminare il modificatore "${this.modifiers[cat][index].nome}"?`)) {
                this.modifiers[cat].splice(index, 1);
                this.saveData();
            }
        },
        toggleModifierFinished(cat, index) {
            const mod = this.modifiers[cat][index];
            mod.isFinished = !mod.isFinished;
            this.saveData();
        },


        // Gestione Accesso (Invariata)
        grantAccess() {
            if (this.accessPin === this.adminPin) {
                this.isAccessGranted = true;
                this.accessPin = '';
                alert("Accesso consentito!");
            } else {
                alert("PIN/Password errato.");
                this.accessPin = '';
            }
        },
        saveAdminPin() {
            const newPin = this.newAdminPin.trim();
            if (newPin.length >= 4) {
                this.adminPin = newPin;
                localStorage.setItem('pz_admin_pin', newPin);
                alert("PIN/Password aggiornato!");
                this.newAdminPin = '';
            } else {
                alert("Il PIN deve essere di almeno 4 caratteri/numeri.");
            }
        },

        // Import/Export/Cache (Corretta la logica di clearCache)
        exportData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('pz_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pz_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Dati esportati correttamente come pz_export.json");
        },
        importData() {
            if (!confirm("ATTENZIONE: Sei sicuro di voler importare i dati? Questo sovrascriverà TUTTI i dati attuali (menu, ordini, storico, impostazioni).")) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        for (const key in importedData) {
                            if (key.startsWith('pz_')) {
                                localStorage.setItem(key, importedData[key]);
                            }
                        }
                        alert("Dati importati con successo! Ricarica l'applicazione per applicare le modifiche.");
                        window.location.reload(); 
                    } catch (error) {
                        alert("Errore durante l'importazione del file: " + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        },
        // FUNZIONE CACHE CORRETTA
        clearCache() {
            if (!confirm("ATTENZIONE: Sei sicuro di voler PULIRE gli ordini? Questo eliminerà gli Ordini Attivi e lo Storico Archiviato. Menu, Modificatori e Clienti saranno MANTENUTI.")) return;
            
            // Resetta solo gli array degli ordini
            localStorage.setItem('pz_orders', '[]');
            localStorage.setItem('pz_archive', '[]');
            
            this.orders = [];
            this.archive = [];
            this.resetCurrentOrderState(); 
            this.saveData();

            alert("Ordini e storico puliti. La gestione è stata resettata.");
            window.location.reload(); 
        },

        // Inizializzazione (Invariata)
        mounted() {
            if (this.drivers.length === 0) {
                this.drivers = ["Mario Rossi", "Luca Bianchi"];
                this.saveData();
            }
            this.calculateDriverStats();
        }
    }).mount()
</script>
</body>
</html>
