<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart – Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        
        /* Modificatori */
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; } /* Più */
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; } /* Senza */
        .mod-btn.yellow { border-color: #facc15; color: #facc15; } /* Poco */
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; } /* Abbondante */
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .search-mod-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }


        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item.active-menu-selection { border: 3px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);} 
        .item.disabled { background: #f0f0f0; color: #999; cursor: not-allowed; opacity: 0.7; }
        .item.disabled:hover { background: #f0f0f0; }

        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }
        
        /* Stili Ordini Attivi e Avvisi Temporali */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative;}
        /* NUOVO: Ordini Futuri */
        .order-card.future-order { border-left: 5px solid #3b82f6; } 
        .order-card.future-order:before { content: "PRENOTAZIONE"; position: absolute; top: -10px; right: 10px; background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        
        .order-card h4 { margin: 0 0 6px; color: #e31b23; display: flex; justify-content: space-between;}
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        .order-actions button.duplicate { background: #facc15; color: #333;}
        
        /* Filtro Ordini Attivi */
        .filter-row-top { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-btn-status { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .filter-btn-status.active { background: #e31b23; color: #fff; border-color: #e31b23; }

        /* Avvisi Temporali (Mantenuti) */
        .order-card.warning-near { border-left: 5px solid #facc15; } /* Giallo (15 min) */
        .order-card.warning-urgent { border-left: 5px solid #b91c1c; } /* Rosso (5 min) */
        .order-card.warning-near:before { content: "ATTENZIONE: Vicino!"; position: absolute; top: -10px; right: 10px; background: #facc15; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .order-card.warning-urgent:before { content: "URGENTE: Imminente!"; position: absolute; top: -10px; right: 10px; background: #b91c1c; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Stili per la stampa (nasconde elementi non necessari) */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 11pt; }

            /* Stili specifici per la comanda */
            .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; }
            .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; }
            .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; }
            .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
            .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; }
            .print-comanda .item-name { font-weight: bold; font-size: 13pt; }
            .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; }
            .print-comanda .mod-list li { border: none; }
            .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; }

            /* Stili specifici per lo scontrino */
            .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; }
            .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; }
            .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
            .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; }
            .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; }
        }

        /* Stili per le Impostazioni (aggiunti/integrati) */
        .settings h3 { color: #444; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .settings form { display: flex; gap: 5px; margin-bottom: 15px; }
        .settings form input, .settings form select, .settings form button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .settings form input[type="text"], .settings form input[type="number"], .settings form select { flex-grow: 1; }
        .settings form button { background: #10b981; color: #fff; border: none; cursor: pointer; }
        
        .settings-list { margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
        .settings-item span { flex-grow: 1; }
        .settings-item .remove { background: #b91c1c; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        .item-status button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .item-status .available { background: #22c55e; color: #fff; }
        .item-status .finished { background: #b91c1c; color: #fff; }

        /* Stili Accesso e Notifiche */
        .access-container { text-align: center; padding: 50px 20px; }
        .access-container input { max-width: 250px; margin: 10px auto; display: block; }
        
        /* NUOVI STILI PER I RUOLI */
        .role-indicator { font-size: 0.8rem; margin-top: 5px; padding: 3px 6px; border-radius: 4px; font-weight: 700; }
        .role-indicator.owner { background: #e31b23; color: #fff; } /* Titolare: Rosso Pizzeria */
        .role-indicator.admin { background: #facc15; color: #333; } /* Admin/Operatore: Giallo */
        /* FINE NUOVI STILI */

        .time-capacity { padding: 10px; border: 1px solid #facc15; background-color: #fffbeb; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; }
        .time-capacity.full { border-color: #b91c1c; background-color: #ffecec; color: #b91c1c; font-weight: 700;}
        .time-capacity.warning { border-color: #facc15; background-color: #fffbeb; }

        .settings-item .actions { display: flex; gap: 5px; }

    </style>
</head>
<body>
    <div id="app" v-cloak>
        <header>
            Pizzeria Smart
        </header>

        <main>
            <section v-if="view === 'inserimento'" class="inserimento">
                <div class="order-box">
                    <h2>Ordine Corrente 🍕</h2>
                    <p v-if="order.length === 0" style="text-align: center; color: #777;">Aggiungi articoli al carrello.</p>
                    <ul v-else>
                        <li v-for="(item, index) in order" :key="index" @click="selectItem(index)" :class="{'order-item': true, 'selected': selectedItemIndex === index}">
                            <div style="flex-grow: 1;">
                                <span style="font-weight: 700;">1x {{ item.nome }}</span> 
                                <span v-if="item.manualPrice !== undefined" style="color:#e31b23; font-weight: 700; font-size: 0.8rem;"> (PREZZO MANUALE)</span>
                                
                                <template v-if="item.isHalfPizza">
                                    <p style="font-size: 0.85rem; margin: 2px 0 0 0; color: #3b82f6;">Metà: {{ item.gusto1 }} / {{ item.gusto2 }}</p>
                                    <ul class="modifiers-list" v-if="(item.modifiers1 && item.modifiers1.length) || (item.modifiers2 && item.modifiers2.length)">
                                        <li v-if="item.modifiers1 && item.modifiers1.length">
                                            <span>M1: {{ item.modifiers1.map(m => m.nome).join(', ') }}</span>
                                            <button @click.stop="item.modifiers1.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                        <li v-if="item.modifiers2 && item.modifiers2.length">
                                            <span>M2: {{ item.modifiers2.map(m => m.nome).join(', ') }}</span>
                                            <button @click.stop="item.modifiers2.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                    </ul>
                                </template>

                                <template v-else-if="item.isMeter">
                                    <p style="font-size: 0.85rem; margin: 2px 0 0 0; color: #10b981;">
                                        <span v-for="(section, sIdx) in item.sections" :key="sIdx">
                                            <span v-if="section.gusto"> - {{ section.gusto }} </span>
                                        </span>
                                    </p>
                                    <ul class="modifiers-list" v-for="(section, sIdx) in item.sections" :key="'sec_mod_' + sIdx" v-if="section.modifiers && section.modifiers.length > 0">
                                        <li>
                                            <span>{{ section.name }}: {{ section.modifiers.map(m => m.nome).join(', ') }}</span>
                                            <button @click.stop="section.modifiers.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                    </ul>
                                </template>
                                
                                <ul class="modifiers-list" v-else-if="item.modifiers && item.modifiers.length > 0">
                                    <li v-for="(mod, modIndex) in item.modifiers" :key="modIndex">
                                        <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span></span>
                                        <button @click.stop="item.modifiers.splice(modIndex, 1); selectedItemIndex = index;" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                    </li>
                                </ul>
                            </div>
                            <div style="text-align: right; display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 700;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                                <button @click.stop="openPriceEditModal(index)" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0;"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button @click.stop="removeItem(index)" style="background: none; border: none; color: #b91c1c; cursor: pointer; padding: 0;"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </li>
                    </ul>
                    <p class="total">Totale Articoli: €{{ calculatedOrderTotal.toFixed(2) }}</p>
                    <button class="final-btn" :disabled="order.length === 0" @click="openModal">Finalizza Ordine ({{ order.length }})</button>
                    <button v-if="editingOrderId" class="final-btn cancel-edit-btn" @click="cancelEdit">Annulla Modifica</button>
                </div>

                <h2>Aggiungi Articolo</h2>
                <div class="cat-row">
                    <button v-for="(items, cat) in menu" :key="cat" :class="{'cat-btn': true, 'active': activeCat === cat}" @click="activeCat = cat; searchTerm = ''">
                        {{ cat }}
                    </button>
                </div>
                
                <input type="text" v-model="searchTerm" placeholder="Cerca articolo..." class="search-input">
                
                <div class="grid">
                    <div v-for="item in filteredAvailableItems" :key="item.nome" 
                        :class="{'item': true, 'disabled': item.isFinished, 'active-menu-selection': lastSelectedItem === item}"
                        @click="handleItemClick(item)">
                        {{ item.nome }} <br> 
                        <span style="font-weight: 700; font-size: .9rem;">€{{ item.prezzo.toFixed(2) }}</span>
                        <span v-if="item.isFinished" style="display: block; color: #b91c1c; font-size: 0.7rem; margin-top: 5px;">ESAURITO</span>
                    </div>
                </div>

                <template v-if="selectedItemIndex !== null && !order[selectedItemIndex].isMeter && !order[selectedItemIndex].isHalfPizza">
                    <h2>Aggiungi Modificatore a: {{ order[selectedItemIndex].nome }}</h2>
                    <div class="cat-row">
                        <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': activeModCat === cat}" @click="activeModCat = cat; modifierSearchTerm = ''">
                            {{ cat }}
                        </button>
                    </div>
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                    <div class="mod-row">
                        <button v-for="mod in filteredModifiersForActiveCat" :key="mod.nome"
                            :class="{'mod-btn': true, 'green': activeModCat === 'Più', 'gray': activeModCat === 'Senza', 'yellow': activeModCat === 'Poco', 'blue': activeModCat === 'Abbondante', 'disabled': mod.isFinished}"
                            :disabled="mod.isFinished"
                            @click="addExtra(mod)">
                            {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                            <span v-if="mod.isFinished" style="display: block; color: #b91c1c; font-size: 0.7rem;">ESAURITO</span>
                        </button>
                    </div>
                </template>
            </section>

            <section v-if="view === 'ordini'" class="ordini">
                <div v-if="!isAdmin" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Inserisci il PIN/Password Operatore o Titolare per accedere agli ordini e alle impostazioni.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>Ordini Attivi <i class="fa-solid fa-bell"></i></h2>
                        <span :class="{'role-indicator': true, 'owner': userRole === 'Titolare', 'admin': userRole === 'Operatore'}" v-if="isAccessGranted">{{ userRole }}</span>
                    </div>

                    <div class="filter-row-top">
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'today'}" @click="activeDateFilter = 'today'">Oggi</button>
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'tomorrow'}" @click="activeDateFilter = 'tomorrow'">Domani</button>
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'future'}" @click="activeDateFilter = 'future'">Futuri</button>
                    </div>
                    <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Tavolo o Indirizzo..." class="search-input">

                    <p v-if="filteredActiveOrders.length === 0" style="text-align: center; color: #777;">Nessun ordine attivo trovato per il filtro selezionato.</p>
                    <div v-for="o in filteredActiveOrders" :key="o.id" 
                         :class="{'order-card': true, 'warning-near': isNear(o), 'warning-urgent': isUrgent(o), 'future-order': isFutureOrder(o)}">
                        <h4>
                            Ordine #{{ o.id }} 
                            <span style="font-size: 0.8rem; font-weight: 500;">
                                {{ o.hour }} ({{ formatDate(o.date) }})
                            </span>
                        </h4>
                        <p style="margin: 0 0 6px; font-weight: 700; color: #333;">{{ o.customer }} <span v-if="o.tableNumber">| Tavolo/Ritiro: {{ o.tableNumber }}</span></p>
                        <p v-if="o.mode === 'consegna'" style="margin: 0 0 6px; font-size: 0.9rem;">{{ o.address }} {{ o.streetNumber }}, {{ o.zone }}</p>
                        <ul class="order-items">
                            <li v-for="(item, index) in o.items" :key="index">
                                1x {{ item.nome }} <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                            </li>
                        </ul>
                        <p style="margin: 8px 0 0; text-align: right; font-size: 1.1rem; font-weight: 700;">Totale: €{{ o.total.toFixed(2) }}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 8px;">
                            <div style="font-size: 0.9rem;">
                                Stato: <span style="font-weight: 700;">{{ o.status }}</span> 
                            </div>
                            <div>
                                <select :value="o.driver" @change="updateActiveOrderDriver(o.id, $event.target.value)" v-if="o.mode === 'consegna'">
                                    <option value="">ASSEGNA FATTORE</option>
                                    <option v-for="driver in availableDrivers" :value="driver">{{ driver }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="order-actions">
                            <button @click="advance(o)">{{ getNextStatus(o.status) }}</button>
                            <button class="edit" @click="editOrder(o.id)">Modifica</button>
                            <button @click="printOrder(o.id, 'comanda')"><i class="fa-solid fa-receipt"></i> Comanda</button>
                            <button class="share" @click="showShareMenu(o.id)"><i class="fa-solid fa-share-nodes"></i> Condividi</button>
                            <button class="duplicate" @click="duplicateOrder(o)"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="view === 'storico'" class="storico">
                <div v-if="!isAdmin" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Solo Operatori e Titolari possono accedere allo storico.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <h2>Storico/Riepilogo Giornaliero</h2>
                    <div class="form-row">
                        <label for="archive-date">Seleziona Giorno:</label>
                        <input type="date" id="archive-date" v-model="archiveDateFilter" @change="calculateDriverStats">
                    </div>

                    <p style="font-size: 1.2rem; font-weight: 700; margin-top: 15px; border-bottom: 2px solid #e31b23;">
                        Totale Incasso Archivio {{ archiveDateFilterDisplay }}: €{{ dailyTotal.toFixed(2) }}
                    </p>

                    <h3 style="margin-top: 20px;">Statistiche Fattorini</h3>
                    <div class="form-row">
                        <select v-model="selectedDriver" @change="calculateDriverStats">
                            <option value="">Tutti (Solo Consegne Assegnate)</option>
                            <option v-for="driver in availableDrivers" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <div class="order-box">
                        <p>Ordini (Consegna/Asporto) Assegnati: <strong>{{ driverStats.totalOrders }}</strong></p>
                        <p>Totale Incasso (Ordini Assegnati): <strong>€{{ driverStats.totalRevenue.toFixed(2) }}</strong></p>
                    </div>

                    <h3 style="margin-top: 20px;">Ordini Archiviati ({{ filteredArchive.length }})</h3>
                    <p v-if="filteredArchive.length === 0" style="text-align: center; color: #777;">Nessun ordine archiviato per questa data.</p>
                    <div v-for="o in filteredArchive" :key="o.id" class="order-card">
                        <h4>Ordine #{{ o.id }} - {{ o.customer }} ({{ o.mode }})</h4>
                        <p style="margin: 0 0 6px; font-weight: 700;">Totale: €{{ o.total.toFixed(2) }}</p>
                        <p v-if="o.driver" style="margin: 0 0 6px; font-size: 0.9rem;">Fattorino Assegnato: <strong>{{ o.driver }}</strong></p>
                        <p v-else style="margin: 0 0 6px; font-size: 0.9rem; color: #b91c1c;">Nessun Fattorino Assegnato</p>
                        
                        <select :value="o.driver" @change="updateArchiveDriver(o.id, $event.target.value)" style="margin-bottom: 10px;">
                            <option value="">ASSEGNA FATTORE</option>
                            <option v-for="driver in availableDrivers" :value="driver">{{ driver }}</option>
                        </select>
                        
                        <div class="order-actions">
                            <button @click="printOrder(o.id, 'scontrino')" style="background: #6b7280;"><i class="fa-solid fa-print"></i> Scontrino</button>
                            <button @click="printOrder(o.id, 'comanda')"><i class="fa-solid fa-receipt"></i> Comanda</button>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="view === 'impostazioni'" class="settings">
                <div v-if="!isOwner" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Solo il Titolare può accedere alle impostazioni critiche.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password Titolare">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <h2>Impostazioni <i class="fa-solid fa-gear"></i></h2>
                    
                    <div class="order-box">
                        <h3>Configurazione Accesso</h3>
                        <div class="form-row">
                            <label>PIN/Password Operatore (Attuale: {{ adminPin }})</label>
                            <form @submit.prevent="saveAdminPin">
                                <input type="text" v-model="newAdminPin" placeholder="Nuovo PIN/Password (min 4)">
                                <button type="submit">Salva</button>
                            </form>
                        </div>
                         <div class="form-row">
                            <label>PIN/Password Titolare (Attuale: {{ ownerPin }})</label>
                            <form @submit.prevent="saveOwnerPin">
                                <input type="text" v-model="newOwnerPin" placeholder="Nuovo PIN/Password (min 4)">
                                <button type="submit">Salva</button>
                            </form>
                        </div>
                        <button @click="logout" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Disconnetti</button>
                    </div>

                    <div class="order-box">
                        <h3>Capacità Oraria (Produzione)</h3>
                        <div class="form-row" style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label>Max Articoli per Slot</label>
                                <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" @change="saveData">
                            </div>
                            <div style="flex: 1;">
                                <label>Durata Slot (Minuti)</label>
                                <input type="number" v-model.number="capacitySettings.intervalMinutes" min="10" step="5" @change="saveData">
                            </div>
                        </div>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">Gli ordini sono calcolati in base agli articoli in categorie 'Pizza' o composizioni.</p>
                    </div>

                    <div class="order-box">
                        <h3>Gestione Menu e Prezzi</h3>
                        <div class="cat-row">
                            <button v-for="(items, cat) in menu" :key="cat" :class="{'cat-btn': true, 'active': activeSettingsCat === cat}" @click="activeSettingsCat = cat">
                                {{ cat }}
                            </button>
                        </div>
                        
                        <form @submit.prevent="addItemToCategory">
                            <input type="text" v-model="newItemName" placeholder="Nome Articolo" required>
                            <input type="number" v-model.number="newItemPrice" step="0.50" min="0" placeholder="Prezzo" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>

                        <div class="settings-list">
                            <div v-for="(item, index) in menu[activeSettingsCat]" :key="item.nome" class="settings-item">
                                <span>{{ item.nome }} - €{{ item.prezzo.toFixed(2) }}</span>
                                <div class="actions">
                                    <div class="item-status">
                                        <button :class="{available: !item.isFinished, finished: item.isFinished}" @click="toggleItemFinished(activeSettingsCat, index)">
                                            {{ item.isFinished ? 'Esaurito' : 'Disponibile' }}
                                        </button>
                                    </div>
                                    <button class="remove" @click="deleteItem(activeSettingsCat, index)">X</button>
                                </div>
                            </div>
                        </div>
                        
                        <form @submit.prevent="addCategory" style="margin-top: 10px;">
                            <input type="text" v-model="newCategoryName" placeholder="Nuova Categoria" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i> Cat</button>
                        </form>
                        <button v-if="activeSettingsCat" @click="deleteCategory(activeSettingsCat)" class="final-btn delete" style="background: #b91c1c; margin-top: 10px;">
                            Elimina Categoria ({{ activeSettingsCat }})
                        </button>
                    </div>

                    <div class="order-box">
                        <h3>Gestione Modificatori</h3>
                        <div class="cat-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': activeSettingsModCat === cat}" @click="activeSettingsModCat = cat">
                                {{ cat }}
                            </button>
                        </div>

                        <form @submit.prevent="addModifierToCategory">
                            <input type="text" v-model="newModifierName" placeholder="Nome Modificatore" required>
                            <input type="number" v-model.number="newModifierPrice" step="0.50" min="0" placeholder="Prezzo (0 se gratuito)" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>

                        <div class="settings-list">
                            <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="mod.nome" class="settings-item">
                                <span>{{ mod.nome }} <span v-if="mod.prezzo > 0"> - €{{ mod.prezzo.toFixed(2) }}</span></span>
                                <div class="actions">
                                    <div class="item-status">
                                        <button :class="{available: !mod.isFinished, finished: mod.isFinished}" @click="toggleModifierFinished(activeSettingsModCat, index)">
                                            {{ mod.isFinished ? 'Esaurito' : 'Disponibile' }}
                                        </button>
                                    </div>
                                    <button class="remove" @click="deleteModifier(activeSettingsModCat, index)">X</button>
                                </div>
                            </div>
                        </div>

                        <form @submit.prevent="addModifierCategory" style="margin-top: 10px;">
                            <input type="text" v-model="newModifierCategoryName" placeholder="Nuova Categoria Modificatori" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i> Cat</button>
                        </form>
                        <button v-if="activeSettingsModCat && !isDefaultModifierCategory(activeSettingsModCat)" @click="deleteModifierCategory(activeSettingsModCat)" class="final-btn delete" style="background: #b91c1c; margin-top: 10px;">
                            Elimina Categoria ({{ activeSettingsModCat }})
                        </button>
                    </div>

                    <div class="order-box">
                        <h3>Zone di Consegna e Costi</h3>
                        <form @submit.prevent="addZone">
                            <input type="text" v-model="newZoneName" placeholder="Nome Zona" required>
                            <input type="number" v-model.number="newZonePrice" step="0.50" min="0" placeholder="Costo Consegna" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <div class="settings-list">
                            <div v-for="(zone, index) in deliveryZones" :key="zone.name" class="settings-item">
                                <span>{{ zone.name }} - €{{ zone.price.toFixed(2) }}</span>
                                <button class="remove" @click="deleteZone(index)">X</button>
                            </div>
                        </div>
                    </div>

                    <div class="order-box">
                        <h3>Fattorini/Driver</h3>
                        <form @submit.prevent="addDriver">
                            <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <div class="settings-list">
                            <div v-for="(driver, index) in drivers" :key="driver" class="settings-item">
                                <span>{{ driver }}</span>
                                <button class="remove" @click="deleteDriver(index)">X</button>
                            </div>
                        </div>
                    </div>

                    <div class="order-box">
                        <h3>Dati e Cache</h3>
                        <button @click="exportData" class="final-btn" style="background: #007bff; margin-bottom: 10px;">Esporta Dati (JSON)</button>
                        <button @click="importData" class="final-btn" style="background: #ffc107; color: #333; margin-bottom: 10px;">Importa Dati (JSON)</button>
                        <button @click="clearCache" class="final-btn" style="background: #b91c1c;">Pulisci Cache (Solo Ordini e Storico)</button>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">**Pulisci Cache** rimuove SOLO ordini attivi e storico. Mantiene Menu, Prezzi, Clienti e PIN.</p>
                    </div>
                </div>
            </section>
        </main>

        <nav>
            <button @click="view = 'inserimento'" :class="{'active': view === 'inserimento'}">
                <i class="fa-solid fa-square-plus"></i> Inserimento
            </button>
            <button @click="view = 'ordini'" :class="{'active': view === 'ordini'}">
                <i class="fa-solid fa-list-check"></i> Ordini
            </button>
            <button @click="view = 'storico'" :class="{'active': view === 'storico'}" :disabled="!isAdmin">
                <i class="fa-solid fa-book"></i> Riepilogo
            </button>
            <button @click="view = 'impostazioni'" :class="{'active': view === 'impostazioni'}" :disabled="!isOwner">
                <i class="fa-solid fa-gear"></i> Impostazioni
            </button>
        </nav>
        
        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <h3>Finalizza Ordine - Totale: €{{ total.toFixed(2) }}</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div v-for="m in modes" :key="m.id" :class="{'mode-card': true, 'active': mode === m.id}" @click="selectMode(m.id)">
                        <i :class="m.icon" style="font-size: 1.5rem; margin-right: 10px;"></i>
                        <span>{{ m.label }}</span>
                        <i class="fa-solid fa-circle-check" v-if="mode === m.id" style="color: #e31b23;"></i>
                    </div>
                </div>

                <div class="time-capacity" :class="{'full': isCapacityFull, 'warning': isCapacityWarning && !isCapacityFull}">
                    <div style="font-weight: 700;">Capacità ({{ capacitySettings.intervalMinutes }} min)</div>
                    <p style="margin: 3px 0; font-size: 0.85rem;">Slot: {{ new Date(orderCapacity.interval).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}) }}</p>
                    <p style="margin: 3px 0; font-size: 0.85rem;">Pizze: {{ orderCapacity.total }}/{{ capacitySettings.maxPizzas }} (Rimanenti: {{ orderCapacity.remaining }})</p>
                </div>
                
                <div class="form-row" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="date-input">Data</label>
                        <input type="date" id="date-input" v-model="date" :min="minDate" @change="updateCapacityWarning">
                    </div>
                    <div style="flex: 1;">
                        <label for="hour-input">Ora</label>
                        <input type="time" id="hour-input" v-model="hour" @change="updateCapacityWarning">
                    </div>
                </div>

                <div class="form-row">
                    <label for="customer-input">Cliente/Riferimento</label>
                    <input type="text" id="customer-input" v-model="customer" @input="filterCustomers" placeholder="Nome o Tavolo" required>
                    <div class="customer-suggestions" v-if="filteredCustomerSuggestions.length && customer.length > 1">
                        <div v-for="data in filteredCustomerSuggestions" :key="data.phone" 
                             @click="loadCustomerData(data)" 
                             style="padding: 8px; border-bottom: 1px dashed #ddd; cursor: pointer; background: #fff; font-size: 0.9rem;">
                            {{ data.customer }} ({{ data.address }} - {{ data.phone }})
                        </div>
                    </div>
                </div>

                <template v-if="mode === 'banco' || mode === 'asporto'">
                    <div class="form-row">
                        <label for="table-input">Tavolo / Ritiro</label>
                        <input type="text" id="table-input" v-model="tableNumber" placeholder="Es. Tavolo 5 o Ritiro B">
                    </div>
                    <div v-if="mode === 'asporto'" class="form-row">
                        <label for="phone-input">Telefono</label>
                        <input type="text" id="phone-input" v-model="phone" placeholder="Numero di telefono">
                    </div>
                </template>

                <template v-if="mode === 'consegna'">
                    <div class="form-row">
                        <label for="address-input">Indirizzo</label>
                        <input type="text" id="address-input" v-model="address" placeholder="Via/Piazza" required>
                    </div>
                    <div class="form-row" style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="number-input">Civico</label>
                            <input type="text" id="number-input" v-model="streetNumber" placeholder="N°">
                        </div>
                        <div style="flex: 1;">
                            <label for="town-input">Città</label>
                            <input type="text" id="town-input" v-model="town" placeholder="Città">
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="zone-select">Zona di Consegna (Costo: €{{ deliveryCost.toFixed(2) }})</label>
                        <select id="zone-select" v-model="zoneName" @change="updateDeliveryCost" required>
                            <option value="" disabled>Seleziona Zona</option>
                            <option v-for="zone in deliveryZones" :value="zone.name" :key="zone.name">
                                {{ zone.name }} (€{{ zone.price.toFixed(2) }})
                            </option>
                        </select>
                    </div>
                </template>
                
                <div class="form-row">
                    <label for="notes-input">Note Aggiuntive</label>
                    <textarea id="notes-input" v-model="notes" rows="2" placeholder="Note per la cucina o il fattorino"></textarea>
                </div>
                
                <div class="form-row">
                    <label for="acconto-input">Acconto Ricevuto (Opzionale)</label>
                    <input type="number" id="acconto-input" v-model.number="accontoRicevuto" step="0.50" min="0" placeholder="€0.00">
                    <p v-if="restoDaDare > 0" style="color: #10b981; font-weight: 700; margin-top: 5px;">Resto da dare: €{{ restoDaDare.toFixed(2) }}</p>
                </div>

                <div class="modal-actions">
                    <button class="btn-cancel" @click="showModal = false">Annulla</button>
                    <button class="btn-confirm" @click="confermaOrdine" :disabled="!mode || (mode === 'consegna' && (!customer || !address || !zoneName)) || order.length === 0">
                        Conferma Ordine - €{{ total.toFixed(2) }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showMeterModal && tempMeterItem" class="modal-overlay" @click.self="cancelMeterComposition">
            <div class="modal-content">
                <h3>Componi: {{ tempMeterItem.nome }}</h3>
                <p style="font-size: 0.9rem; color: #666;">Seleziona i gusti e aggiungi i modificatori per ogni sezione.</p>
                
                <div class="order-box" style="margin-bottom: 15px;">
                    <div v-for="(section, sIdx) in tempMeterItem.sections" :key="sIdx" style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
                        <span style="font-weight: 700;">{{ section.name }}:</span> 
                        <span v-if="section.gusto">{{ section.gusto }}</span>
                        <button v-else @click="section.activeSection = true" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                        
                        <div v-if="section.modifiers && section.modifiers.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ section.modifiers.map(m => m.nome).join(', ') }}</span>
                            <button @click="section.modifiers.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                        <button v-if="section.gusto" @click="section.activeSection = true" class="final-btn" style="padding: 5px 10px; max-width: 100px; background: #6b7280; margin: 0 5px;">Modifica</button>
                    </div>
                    <p class="total">Totale stimato: €{{ calculateTempMeterTotal.toFixed(2) }}</p>
                </div>

                <div v-for="(section, sIdx) in tempMeterItem.sections" :key="'mod_form_' + sIdx">
                    <div v-if="section.activeSection">
                        <h4 style="color: #3b82f6; margin-top: 5px;">Componi: {{ section.name }}</h4>
                        
                        <div class="form-row">
                            <label>Seleziona Gusto</label>
                            <input type="text" v-model="gustoSearchTerm" placeholder="Cerca Pizza Base" class="search-mod-input">
                            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                                <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                    :class="{'item': true, 'active-menu-selection': section.gusto === gusto.nome}"
                                    @click="selectMeterGusto(sIdx, gusto.nome)">
                                    {{ gusto.nome }}
                                </div>
                            </div>
                        </div>

                        <label>Aggiungi Modificatori</label>
                        <div class="cat-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': tempModCat === cat}" @click="tempModCat = cat; modifierSearchTerm = ''">
                                {{ cat }}
                            </button>
                        </div>
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                        <div class="mod-row">
                            <button v-for="mod in filteredTempModifiers" :key="mod.nome"
                                :class="{'mod-btn': true, 'green': tempModCat === 'Più', 'gray': tempModCat === 'Senza', 'yellow': tempModCat === 'Poco', 'blue': tempModCat === 'Abbondante'}"
                                @click="addMeterModifier(sIdx, mod)">
                                {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                            </button>
                        </div>
                        <button @click="section.activeSection = false; gustoSearchTerm = ''" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Chiudi Sezione</button>
                        <hr style="margin: 15px 0;">
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-cancel" @click="cancelMeterComposition">Annulla</button>
                    <button class="btn-confirm" @click="addMeterToOrder" :disabled="!isMeterValid">
                        Aggiungi a Ordine (€{{ calculateTempMeterTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaModal && tempHalfPizzaItem" class="modal-overlay" @click.self="cancelHalfPizzaComposition">
            <div class="modal-content">
                <h3>Componi: {{ tempHalfPizzaItem.nome }}</h3>
                <p style="font-size: 0.9rem; color: #666;">Seleziona i due gusti e aggiungi i modificatori specifici.</p>
                
                <div class="order-box" style="margin-bottom: 15px;">
                    <div style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
                        <span style="font-weight: 700;">Gusto 1:</span> 
                        <span v-if="tempHalfPizzaItem.gusto1">{{ tempHalfPizzaItem.gusto1 }}</span>
                        <button @click="tempHalfPizzaItem.activeHalf = 1" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                        <div v-if="tempHalfPizzaItem.modifiers1 && tempHalfPizzaItem.modifiers1.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ tempHalfPizzaItem.modifiers1.map(m => m.nome).join(', ') }}</span>
                            <button @click="tempHalfPizzaItem.modifiers1.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <div style="padding: 5px 0;">
                        <span style="font-weight: 700;">Gusto 2:</span> 
                        <span v-if="tempHalfPizzaItem.gusto2">{{ tempHalfPizzaItem.gusto2 }}</span>
                        <button @click="tempHalfPizzaItem.activeHalf = 2" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                         <div v-if="tempHalfPizzaItem.modifiers2 && tempHalfPizzaItem.modifiers2.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ tempHalfPizzaItem.modifiers2.map(m => m.nome).join(', ') }}</span>
                            <button @click="tempHalfPizzaItem.modifiers2.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <p class="total">Totale stimato: €{{ calculateTempHalfPizzaTotal.toFixed(2) }}</p>
                </div>

                <template v-if="tempHalfPizzaItem.activeHalf > 0">
                    <h4 style="color: #3b82f6; margin-top: 5px;">Componi: Metà {{ tempHalfPizzaItem.activeHalf }}</h4>
                    
                    <div class="form-row">
                        <label>Seleziona Gusto</label>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca Pizza Base" class="search-mod-input">
                        <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                :class="{'item': true, 'active-menu-selection': (tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.gusto1 : tempHalfPizzaItem.gusto2) === gusto.nome}"
                                @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)">
                                {{ gusto.nome }}
                            </div>
                        </div>
                    </div>

                    <label>Aggiungi Modificatori</label>
                    <div class="cat-row">
                        <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': tempModCat === cat}" @click="tempModCat = cat; modifierSearchTerm = ''">
                            {{ cat }}
                        </button>
                    </div>
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                    <div class="mod-row">
                        <button v-for="mod in filteredTempModifiers" :key="mod.nome"
                            :class="{'mod-btn': true, 'green': tempModCat === 'Più', 'gray': tempModCat === 'Senza', 'yellow': tempModCat === 'Poco', 'blue': tempModCat === 'Abbondante'}"
                            @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)">
                            {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                        </button>
                    </div>
                    <button @click="tempHalfPizzaItem.activeHalf = 0; gustoSearchTerm = ''" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Chiudi Sezione</button>
                    <hr style="margin: 15px 0;">
                </template>
                
                <div class="modal-actions">
                    <button class="btn-cancel" @click="cancelHalfPizzaComposition">Annulla</button>
                    <button class="btn-confirm" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid">
                        Aggiungi a Ordine (€{{ calculateTempHalfPizzaTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showPriceEditModal" class="modal-overlay" @click.self="showPriceEditModal = false">
            <div class="modal-content">
                <h3>Modifica Prezzo Articolo</h3>
                <p>Articolo: <span style="font-weight: 700;">{{ order[tempPriceEditIndex]?.nome }}</span></p>
                <div class="form-row">
                    <label for="new-price-input">Nuovo Prezzo (Manuale)</label>
                    <input type="number" id="new-price-input" v-model.number="newPriceValue" step="0.01" min="0" required>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" @click="showPriceEditModal = false">Annulla</button>
                    <button class="btn-confirm" @click="saveNewPrice">Salva Prezzo Man. (€{{ newPriceValue.toFixed(2) }})</button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal && selectedOrderForShare" class="modal-overlay" @click.self="showShareModal = false">
            <div class="modal-content">
                <h3>Condividi Ordine #{{ selectedOrderForShare.id }}</h3>
                <p>Scegli come condividere il riepilogo dell'ordine.</p>
                
                <div class="modal-actions">
                    <button class="btn-cancel" @click="showShareModal = false">Chiudi</button>
                    <button class="btn-confirm" style="background: #25d366;" @click="shareViaWhatsapp(selectedOrderForShare)">
                        <i class="fa-brands fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <div class="print-container">
            <div id="print-content-comanda" class="print-comanda"></div>
            <div id="print-content-scontrino" class="print-scontrino"></div>
        </div>

    </div>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // Dati Base
                    view: 'inserimento', // 'inserimento', 'ordini', 'storico', 'impostazioni', 'cucina'
                    
                    // Accesso e Sicurezza
                    adminPin: '1234',
                    ownerPin: '0000',
                    accessPin: '',
                    isAccessGranted: false, // Indica se l'accesso è stato concesso (Operatore o Titolare)
                    userRole: '', // 'Operatore' o 'Titolare'
                    newAdminPin: '',
                    newOwnerPin: '',
                    lastId: 0, // Contatore globale per ID univoci di Menu/Modificatori

                    // Dati Menu
                    menu: {
                        'Pizza Classica': [
                            { id: 1, nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { id: 2, nome: 'Diavola', prezzo: 7.50, isFinished: false },
                            { id: 3, nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                            { id: 4, nome: '4 Stagioni', prezzo: 8.00, isFinished: false },
                            { id: 5, nome: 'Fornarina', prezzo: 5.00, isFinished: false },
                        ],
                        'Pizze Speciali': [
                            { id: 6, nome: 'Pistacchio & Mortazza', prezzo: 12.00, isFinished: false },
                            { id: 7, nome: 'Gourmet', prezzo: 14.00, isFinished: false },
                        ],
                        'Bevande': [
                            // Esempio di variante (modifica futura opzionale)
                            { id: 8, nome: 'Acqua Nat', prezzo: 2.00, isFinished: false }, 
                            { id: 9, nome: 'Coca Cola Latta', prezzo: 3.00, isFinished: false },
                        ],
                        'Dolci': [
                            { id: 10, nome: 'Tiramisù', prezzo: 4.50, isFinished: false },
                        ],
                        'Composizioni': [
                            // Mezzo Metro e Schiacciata ora non hanno più 'sections' nello stato base
                            { id: 11, nome: 'Mezzo Metro', prezzo: 16.00, isMeter: true, isFinished: false },
                            { id: 12, nome: 'Schiacciata Grande', prezzo: 12.00, isMeter: true, isFinished: false },
                            // Pizza a Metà mantiene le sue proprietà base
                            { id: 13, nome: 'Pizza a Metà', prezzo: 0.00, isHalfPizza: true, isFinished: false, gusto1: null, gusto2: null, modifiers1: [], modifiers2: []}
                        ]
                    },
                    
                    // Dati Modificatori
                    modifiers: {
                        'Più': [
                            { id: 101, nome: 'Mozzarella', prezzo: 0.50, isFinished: false },
                            { id: 102, nome: 'Wurstel', prezzo: 1.00, isFinished: false },
                            { id: 103, nome: 'Prosciutto', prezzo: 1.50, isFinished: false },
                        ],
                        'Senza': [
                            { id: 104, nome: 'Aglio', prezzo: 0.00, isFinished: false },
                            { id: 105, nome: 'Origano', prezzo: 0.00, isFinished: false },
                        ],
                        'Poco': [
                            { id: 106, nome: 'Sale', prezzo: 0.00, isFinished: false },
                        ],
                        'Abbondante': [
                            { id: 107, nome: 'Olio', prezzo: 0.00, isFinished: false },
                        ],
                    },

                    // Controllo Inventario Globale (Nuovo)
                    finishedIngredients: [], // ['Mozzarella di Bufala', 'Funghi Porcini']
                    
                    // Dati Ordine Corrente
                    order: [],
                    selectedItemIndex: null,
                    lastSelectedItem: null, 
                    searchTerm: '', 
                    modifierSearchTerm: '', 
                    activeCat: 'Pizza Classica',
                    activeModCat: 'Più',
                    operatorFavorites: { // Nuovi preferiti per l'operatore
                        items: [], // [{ id: 1, nome: 'Margherita' }, ...]
                        modifiers: [] // [{ id: 101, nome: 'Mozzarella' }, ...]
                    },
                    
                    // Modalità di Finalizzazione Ordine
                    modes: [
                        { id: 'banco', label: 'Tavolo/Banco', icon: 'fa-solid fa-utensils' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck' }
                    ],
                    showModal: false,
                    
                    // Dati Modale
                    editingOrderId: null,
                    mode: 'banco',
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: 'Roma',
                    tableNumber: '', 
                    carPlate: '', // Nuovo: Targa auto per ritiro
                    date: '',
                    hour: '',
                    notes: '',
                    zoneName: '',
                    deliveryCost: 0.00,
                    accontoRicevuto: 0.00,
                    paymentMethod: 'contanti', // Nuovo: Metodo di pagamento
                    discountAmount: 0.00, // Nuovo: Sconto in euro
                    discountType: 'fixed', // 'fixed' o 'percent'

                    // Dati di Sistema
                    lastOrderId: 0,
                    activeOrders: [],
                    archive: [],
                    deliveryZones: [
                        { name: 'Zona A', price: 3.00 },
                        { name: 'Zona B', price: 4.00 },
                    ],
                    drivers: ['Mario', 'Luigi', 'Yoshi'], 
                    
                    // Storico e Statistiche
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    selectedDriver: '',
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', 

                    // Capacità Oraria
                    capacitySettings: {
                        maxPizzas: 20,
                        intervalMinutes: 30
                    },
                    orderCapacity: {
                        interval: null,
                        total: 0,
                        remaining: 0,
                        warning: false, 
                        estimatedWaitTime: 0 // Nuovo: Tempo d'attesa stimato in minuti
                    },
                    
                    // Composizioni (Metri/Mezze Pizze)
                    showMeterModal: false,
                    tempMeterItem: null, // Struttura dinamica per Mezzo Metro/Schiacciata
                    gustoSearchTerm: '',
                    tempModCat: 'Più',
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,

                    // Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0.00,

                    // Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,
                    
                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: [],

                    // Gestione Chiusura
                    businessHours: { // Nuovo: Orari di apertura
                        isClosed: false,
                        closedDays: [0], // 0=Domenica, 1=Lunedì, ecc.
                        openTime: '18:00',
                        closeTime: '23:00'
                    },
                };
            },
            
            computed: {
                isOwner() {
                    return this.userRole === 'Titolare';
                },
                isAdmin() {
                    return this.isAccessGranted;
                },
                
                // --- Calcoli Ordine Corrente ---
                calculatedOrderTotal() {
                    // Calcola il totale degli articoli nel carrello
                    const itemsTotal = this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
                    
                    let preDiscountTotal = itemsTotal + this.deliveryCost;
                    
                    // Applica lo sconto
                    if (this.discountType === 'percent' && this.discountAmount > 0) {
                        preDiscountTotal *= (1 - this.discountAmount / 100);
                    } else if (this.discountType === 'fixed' && this.discountAmount > 0) {
                        preDiscountTotal = Math.max(0, preDiscountTotal - this.discountAmount);
                    }

                    return preDiscountTotal;
                },
                total() {
                    return parseFloat(this.calculatedOrderTotal.toFixed(2));
                },
                restoDaDare() {
                    const totalToPay = this.total;
                    return Math.max(0, this.accontoRicevuto - totalToPay);
                },

                // --- Filtri e Disponibilità ---
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    return items.filter(item => 
                        !item.isFinished && item.nome.toLowerCase().includes(term)
                    );
                },
                filteredModifiersForActiveCat() {
                    const mods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        !mod.isFinished && mod.nome.toLowerCase().includes(term)
                    );
                },
                availableFavorites() {
                    return this.operatorFavorites.items.filter(id => {
                        const item = this.findMenuItemById(id);
                        return item && !item.isFinished;
                    });
                },

                // --- Capacità Oraria Computed ---
                isCapacityWarning() {
                    return this.orderCapacity.warning;
                },
                isCapacityFull() {
                    return this.orderCapacity.remaining <= 0;
                },
                minDate() {
                    return new Date().toISOString().slice(0, 10);
                },
                pizzasInCurrentOrder() {
                    // Calcolo pizze totali nel carrello per la capacità
                    return this.order.reduce((count, item) => {
                        const catName = this.getCategoryNameByItemName(item.nome);
                        if (catName === 'Pizza Classica' || catName === 'Pizze Speciali') {
                            count += 1;
                        } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                            count += 4; 
                        } else if (item.isHalfPizza) {
                            count += 1; 
                        } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                            count += 2; 
                        }
                        return count;
                    }, 0);
                },
                currentOrderPizzasText() {
                    const total = this.pizzasInCurrentOrder;
                    const halfMeterCount = this.order.filter(i => i.isMeter && i.nome === 'Mezzo Metro').length;
                    return `${total} pizze${halfMeterCount > 0 ? ` (+${halfMeterCount} Metri)` : ''}`;
                },

                // --- Composizioni Computed (AGGIORNATO) ---
                allPizzaGusti() {
                    return this.menu['Pizza Classica'].concat(this.menu['Pizze Speciali']);
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase();
                    return this.allPizzaGusti.filter(item => 
                        !item.isFinished && item.nome.toLowerCase().includes(term)
                    );
                },
                filteredTempModifiers() {
                    const mods = this.modifiers[this.tempModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        !mod.isFinished && mod.nome.toLowerCase().includes(term)
                    );
                },
                // Calcolo Totale Mezzo Metro/Schiacciata (AGGIORNATO)
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;
                    
                    let basePrice = this.tempMeterItem.prezzoBase; // Prezzo fisso (16 o 12)
                    let modTotal = 0;

                    this.tempMeterItem.gusti.forEach(gusto => {
                        modTotal += gusto.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    });

                    return basePrice + modTotal;
                },
                // Validità Mezzo Metro/Schiacciata (AGGIORNATO)
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    // Deve esserci almeno un gusto selezionato e non più del massimo definito
                    return this.tempMeterItem.gusti.every(gusto => gusto.gusto !== null) && 
                           this.tempMeterItem.gusti.length > 0 &&
                           this.tempMeterItem.gusti.length <= 3; // Max 3 gusti come richiesto
                },
                // Calcolo Pizza a Metà (NESSUN CAMBIAMENTO)
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    
                    const item = this.tempHalfPizzaItem;
                    const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                    const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                    
                    const avgBasePrice = (price1 + price2) / 2;
                    
                    let modTotal = 0;
                    modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                    return avgBasePrice + modTotal;
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 !== null && this.tempHalfPizzaItem.gusto2 !== null;
                },

                // --- Ordini Attivi ---
                filteredActiveOrders() {
                    let orders = this.activeOrders.filter(o => {
                        const orderTime = new Date(`${o.date}T${o.hour}`);
                        const now = new Date();

                        // Logica di filtro temporale basata sulle fasce orarie
                        if (this.activeDateFilter === 'today') {
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            const orderDate = new Date(orderTime.getFullYear(), orderTime.getMonth(), orderTime.getDate());
                            return orderDate.getTime() === today.getTime();
                        } else if (this.activeDateFilter === 'tomorrow') {
                            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                            const orderDate = new Date(orderTime.getFullYear(), orderTime.getMonth(), orderTime.getDate());
                            return orderDate.getTime() === tomorrow.getTime();
                        } else if (this.activeDateFilter === 'future') {
                            // Ordini dal giorno dopo domani in poi
                            const dayAfterTomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 2);
                            const orderDate = new Date(orderTime.getFullYear(), orderTime.getMonth(), orderTime.getDate());
                            return orderDate.getTime() >= dayAfterTomorrow.getTime();
                        }
                        return true;
                    });
                    
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term) {
                        orders = orders.filter(o => 
                            o.customer.toLowerCase().includes(term) ||
                            (o.tableNumber && o.tableNumber.toLowerCase().includes(term)) ||
                            (o.address && o.address.toLowerCase().includes(term)) ||
                            (o.phone && o.phone.includes(term)) || // Ricerca per telefono
                            (o.carPlate && o.carPlate.toLowerCase().includes(term)) // Ricerca per targa
                        );
                    }

                    // Ordina per data e ora
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },
                
                // --- Storico ---
                filteredArchive() {
                    let orders = this.archive.filter(o => o.date === this.archiveDateFilter);
                    if (this.selectedDriver) {
                        orders = orders.filter(o => o.driver === this.selectedDriver);
                    }
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeB - timeA; // Dal più recente al meno recente
                    });
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, o) => sum + o.total, 0);
                },
                archiveDateFilterDisplay() {
                    const date = new Date(this.archiveDateFilter);
                    return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' });
                },

                // --- Impostazioni ---
                activeSettingsCat: {
                    get() {
                        if (!this.menu[this.activeSettingsCatName]) {
                            this.activeSettingsCatName = Object.keys(this.menu)[0];
                        }
                        return this.activeSettingsCatName;
                    },
                    set(val) {
                        this.activeSettingsCatName = val;
                    }
                },
                activeSettingsModCat: {
                    get() {
                        if (!this.modifiers[this.activeSettingsModCatName]) {
                            this.activeSettingsModCatName = Object.keys(this.modifiers)[0];
                        }
                        return this.activeSettingsModCatName;
                    },
                    set(val) {
                        this.activeSettingsModCatName = val;
                    }
                },
                availableDrivers() {
                    return ['', ...this.drivers];
                }
            },
            
            watch: {
                view(newView) {
                    if (newView !== 'inserimento') {
                        this.selectedItemIndex = null;
                    }
                    if ((newView === 'ordini' || newView === 'storico' || newView === 'cucina') && !this.isAdmin) {
                        // Impedisce l'accesso
                    } else if (newView === 'storico') {
                        this.calculateDriverStats();
                    }
                    this.saveData(); 
                },
                order: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                activeOrders: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                // Watcher per la ricerca suggerimenti cliente
                customer(newVal) {
                    if (this.showModal) {
                        this.filterCustomers();
                    }
                },
                // Watcher per aggiornare il costo di consegna al cambio zona
                zoneName() {
                    this.updateDeliveryCost();
                }
            },
            
            methods: {
                // --- Funzioni Utilità di Ricerca Dati ---
                findMenuItemById(id) {
                    for (const cat in this.menu) {
                        const item = this.menu[cat].find(i => i.id === id);
                        if (item) return item;
                    }
                    return null;
                },
                findModifierById(id) {
                    for (const cat in this.modifiers) {
                        const mod = this.modifiers[cat].find(m => m.id === id);
                        if (mod) return mod;
                    }
                    return null;
                },
                getCategoryNameByItemName(itemName) {
                    for (const cat in this.menu) {
                        if (this.menu[cat].some(menuItem => menuItem.nome === itemName)) {
                            return cat;
                        }
                    }
                    return null;
                },

                // --- Funzioni di Accesso e Logout ---
                grantAccess() {
                    if (this.accessPin === this.ownerPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Titolare';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Titolare Concesso.');
                    } else if (this.accessPin === this.adminPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Operatore';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Operatore Concesso.');
                    } else if (this.accessPin) {
                        alert('PIN/Password errato.');
                        this.accessPin = '';
                    }
                },
                logout() {
                    this.isAccessGranted = false;
                    this.userRole = '';
                    this.view = 'inserimento';
                    alert('Disconnessione effettuata.');
                    this.saveData();
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.adminPin = this.newAdminPin;
                        this.newAdminPin = '';
                        this.saveData();
                        alert('PIN/Password Operatore aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },
                saveOwnerPin() {
                    if (this.newOwnerPin.length >= 4) {
                        this.ownerPin = this.newOwnerPin;
                        this.newOwnerPin = '';
                        this.saveData();
                        alert('PIN/Password Titolare aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },

                // --- Persistenza Dati (LocalStorage) ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeriaSmartData');
                        if (data) {
                            const parsedData = JSON.parse(data);
                            Object.assign(this, parsedData);

                            // Inizializza i valori predefiniti per le nuove proprietà se non esistono
                            this.adminPin = parsedData.adminPin || '1234';
                            this.ownerPin = parsedData.ownerPin || '0000';
                            this.capacitySettings = parsedData.capacitySettings || { maxPizzas: 20, intervalMinutes: 30 };
                            this.drivers = parsedData.drivers || ['Mario', 'Luigi', 'Yoshi'];
                            this.deliveryZones = parsedData.deliveryZones || [
                                { name: 'Zona A', price: 3.00 },
                                { name: 'Zona B', price: 4.00 },
                            ];
                            this.customerHistory = parsedData.customerHistory || [];
                            this.lastId = parsedData.lastId || 107; // Ultimo ID usato se non presente

                            // Nuove Proprietà
                            this.finishedIngredients = parsedData.finishedIngredients || [];
                            this.operatorFavorites = parsedData.operatorFavorites || { items: [], modifiers: [] };
                            this.businessHours = parsedData.businessHours || {
                                isClosed: false, closedDays: [0], openTime: '18:00', closeTime: '23:00'
                            };

                            // Assicura che la data di archivio sia sempre odierna al caricamento
                            this.archiveDateFilter = new Date().toISOString().slice(0, 10);
                            
                            // Assicura che tutti gli elementi del menu e modificatori abbiano isFinished
                            this.ensureItemStatusAndId();
                            
                            // Logica di accesso (mantenuta)
                            if (this.isAccessGranted && this.userRole) {
                                if (this.userRole === 'Operatore' && parsedData.adminPin !== this.adminPin) {
                                    this.logout();
                                }
                                if (this.userRole === 'Titolare' && parsedData.ownerPin !== this.ownerPin) {
                                    this.logout();
                                }
                            }

                        }
                    } catch (e) {
                        console.error("Errore caricamento dati:", e);
                    }
                },
                saveData() {
                    const dataToSave = {
                        adminPin: this.adminPin,
                        ownerPin: this.ownerPin,
                        isAccessGranted: this.isAccessGranted,
                        userRole: this.userRole,
                        menu: this.menu,
                        modifiers: this.modifiers,
                        lastOrderId: this.lastOrderId,
                        activeOrders: this.activeOrders,
                        archive: this.archive,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        capacitySettings: this.capacitySettings,
                        customerHistory: this.customerHistory,
                        lastId: this.lastId, // Salva l'ultimo ID univoco
                        finishedIngredients: this.finishedIngredients,
                        operatorFavorites: this.operatorFavorites,
                        businessHours: this.businessHours
                    };
                    localStorage.setItem('pizzeriaSmartData', JSON.stringify(dataToSave));
                },
                generateUniqueId() {
                    return ++this.lastId;
                },
                ensureItemStatusAndId() {
                    // Aggiunge ID univoci e proprietà mancanti
                    for (const cat in this.menu) {
                        this.menu[cat].forEach(item => {
                            if (item.id === undefined) item.id = this.generateUniqueId();
                            if (item.isFinished === undefined) item.isFinished = false;
                            
                            // Assicura che le composizioni abbiano le loro proprietà (se mancanti da un vecchio salvataggio)
                            if (item.nome === 'Pizza a Metà' && !item.gusto1) {
                                Object.assign(item, { gusto1: null, gusto2: null, modifiers1: [], modifiers2: [] });
                            }
                            // Rimuovi 'sections' dallo stato base se non è più la logica di gestione
                            if (item.isMeter && item.sections !== undefined) {
                                delete item.sections;
                            }
                        });
                    }
                    for (const cat in this.modifiers) {
                        this.modifiers[cat].forEach(mod => {
                            if (mod.id === undefined) mod.id = this.generateUniqueId();
                            if (mod.isFinished === undefined) mod.isFinished = false;
                        });
                    }
                },

                // --- Funzioni Ordine Corrente ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) return item.manualPrice;
                    
                    let basePrice = item.prezzo || 0;
                    let modTotal = 0;
                    
                    if (item.isHalfPizza) {
                        // Il calcolo della media è corretto
                        const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                        const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                        basePrice = (price1 + price2) / 2; 

                        modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);

                    } else if (item.isMeter) {
                        // Prezzo base è quello fisso (16/12) + modificatori (AGGIORNATO)
                        basePrice = item.prezzo; // Prezzo base è quello fisso salvato
                        item.gusti.forEach(gusto => {
                            modTotal += gusto.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        });

                    } else {
                        // Articoli Standard
                        modTotal = item.modifiers ? item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    }
                    
                    return basePrice + modTotal;
                },
                
                handleItemClick(item) {
                    if (item.isFinished) return;
                    
                    this.selectedItemIndex = null; 
                    this.lastSelectedItem = item; 

                    if (item.isMeter) {
                        this.openMeterCompositionModal(item);
                    } else if (item.isHalfPizza) {
                        this.openHalfPizzaCompositionModal(item);
                    } else {
                        this.addItem(item);
                    }
                },
                addItem(item) {
                    if (item.isFinished) return;
                    // Assicurati di copiare anche l'ID per tracciare
                    const newItem = JSON.parse(JSON.stringify(item));
                    
                    // Rimuove le proprietà di composizione se presenti per articoli standard
                    delete newItem.isMeter;
                    delete newItem.isHalfPizza;
                    delete newItem.gusto1;
                    delete newItem.gusto2;
                    delete newItem.modifiers1;
                    delete newItem.modifiers2;
                    // Se l'item è un favorito, potrebbe non avere la categoria, la ricaviamo dal nome per l'ordine
                    newItem.category = this.getCategoryNameByItemName(item.nome);
                    
                    newItem.modifiers = []; 
                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; 
                },
                removeItem(index) {
                    this.order.splice(index, 1);
                    if (this.selectedItemIndex === index) {
                        this.selectedItemIndex = null;
                    } else if (this.selectedItemIndex > index) {
                        this.selectedItemIndex--;
                    }
                },
                selectItem(index) {
                    this.selectedItemIndex = index;
                },
                
                // --- Gestione Modificatori Articolo Standard ---
                addExtra(mod) {
                    if (mod.isFinished) return;
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo nel carrello a cui aggiungere il modificatore.");
                        return;
                    }
                    const selectedItem = this.order[this.selectedItemIndex];
                    if (selectedItem.isMeter || selectedItem.isHalfPizza) {
                        alert("Non è possibile aggiungere modificatori a questo tipo di composizione da qui. Modifica tramite modale.");
                        return;
                    }
                    
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    // Gestione "Senza": se è "Senza", rimuovi l'eventuale "Più" o "Abbondante" dello stesso tipo
                    if (this.activeModCat === 'Senza') {
                        selectedItem.modifiers = selectedItem.modifiers.filter(m => 
                            m.nome !== mod.nome
                        );
                    }
                    
                    // Se non è un modificatore "Senza", aggiungilo
                    if (this.activeModCat !== 'Senza') {
                        selectedItem.modifiers.push(newMod);
                    }
                    this.selectedItemIndex = this.order.length - 1; 
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Più': return '➕';
                        case 'Senza': return '➖';
                        case 'Poco': return '🤏';
                        case 'Abbondante': return '🧅'; 
                        default: return '•';
                    }
                },

                // --- Composizioni (Mezzo Metro/Schiacciata - NUOVO FLUSSO) ---
                openMeterCompositionModal(item) {
                    // Prezzo base è quello fisso (16.00 o 12.00)
                    this.tempMeterItem = {
                        id: item.id,
                        nome: item.nome, 
                        prezzo: item.prezzo, // Questo sarà il prezzo finale, inizializzato al prezzo base
                        prezzoBase: item.prezzo, // Mantiene il prezzo base fisso per il calcolo
                        isMeter: true,
                        numGusti: 1, // Predefinito a 1 gusto
                        gusti: [{ name: 'Gusto 1', gusto: null, modifiers: [] }], // Array di gusti
                    };
                    this.showMeterModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                // NUOVO: Imposta il numero di gusti (1, 2, o 3)
                setMeterGusti(count) {
                    this.tempMeterItem.numGusti = count;
                    // Crea l'array di gusti vuoto della dimensione corretta
                    this.tempMeterItem.gusti = Array.from({ length: count }, (_, i) => ({
                        name: `Gusto ${i + 1}`,
                        gusto: null,
                        modifiers: []
                    }));
                },
                selectMeterGusto(gustoIndex, gustoName) {
                    this.tempMeterItem.gusti[gustoIndex].gusto = gustoName;
                    this.gustoSearchTerm = '';
                },
                addMeterModifier(gustoIndex, mod) {
                    if (mod.isFinished) return;
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    const modifiersArray = this.tempMeterItem.gusti[gustoIndex].modifiers;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        modifiersArray.push(newMod);
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert(`Devi selezionare ${this.tempMeterItem.numGusti} gusti per continuare.`);
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                    finalItem.prezzo = this.calculateTempMeterTotal; 
                    
                    delete finalItem.prezzoBase; // Rimuovi la proprietà temporanea
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelMeterComposition();
                },

                // --- Composizioni (Pizza a Metà) ---
                openHalfPizzaCompositionModal(item) {
                    // Crea un nuovo oggetto con le proprietà base e di composizione inizializzate
                    this.tempHalfPizzaItem = {
                        id: item.id,
                        nome: item.nome, 
                        prezzo: 0.00, 
                        isHalfPizza: true,
                        gusto1: null,
                        gusto2: null,
                        modifiers1: [],
                        modifiers2: [],
                        activeHalf: 1 
                    };
                    this.showHalfPizzaModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                selectHalfPizzaGusto(halfNumber, gustoName) {
                    if (halfNumber === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                    } else if (halfNumber === 2) {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                    this.tempHalfPizzaItem.activeHalf = 0; 
                    this.gustoSearchTerm = '';
                },
                addHalfPizzaModifier(halfNumber, mod) {
                    if (mod.isFinished) return;
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    const modifiersArray = halfNumber === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        modifiersArray.push(newMod);
                    }
                },
                addHalfPizzaToOrder() {
                    if (!this.isHalfPizzaValid) {
                        alert('Devi selezionare entrambi i gusti per la pizza a metà.');
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                    finalItem.prezzo = this.calculateTempHalfPizzaTotal; 
                    delete finalItem.activeHalf; 
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelHalfPizzaComposition();
                },
                // --- Funzioni Ordine Corrente: Modifiche Aggiuntive ---
                openPriceEditModal(index) {
                    if (this.order[index].isMeter || this.order[index].isHalfPizza) {
                        alert("La modifica manuale del prezzo è disabilitata per le composizioni complesse.");
                        return;
                    }
                    this.tempPriceEditIndex = index;
                    this.newPriceValue = this.order[index].manualPrice !== undefined 
                                         ? this.order[index].manualPrice 
                                         : this.calculateItemTotal(this.order[index]);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        // Salva il prezzo manuale
                        this.order[this.tempPriceEditIndex].manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                        this.order[this.tempPriceEditIndex].notes = (this.order[this.tempPriceEditIndex].notes || '') + ' [Prezzo Modificato Man.]';
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0;
                    } else {
                        alert("Prezzo non valido.");
                    }
                },
                cancelPriceEdit() {
                    this.showPriceEditModal = false;
                    this.tempPriceEditIndex = null;
                    this.newPriceValue = 0;
                },

                // --- Gestione Modificatori e Preferiti (NUOVO) ---
                addToFavorites(id, type) {
                    const favoritesArray = type === 'item' ? this.operatorFavorites.items : this.operatorFavorites.modifiers;
                    
                    if (favoritesArray.includes(id)) {
                        favoritesArray.splice(favoritesArray.indexOf(id), 1);
                    } else {
                        if (favoritesArray.length >= 10) {
                            alert(`Puoi aggiungere al massimo 10 ${type === 'item' ? 'articoli' : 'modificatori'} preferiti.`);
                            return;
                        }
                        favoritesArray.push(id);
                    }
                    this.saveData();
                },
                isFavorite(id, type) {
                    const favoritesArray = type === 'item' ? this.operatorFavorites.items : this.operatorFavorites.modifiers;
                    return favoritesArray.includes(id);
                },
                
                // --- Gestione Capacità e Orari ---
                updateDeliveryCost() {
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    this.deliveryCost = zone ? zone.price : 0.00;
                },
                updateCapacityWarning() {
                    if (!this.hour || !this.date) {
                        this.orderCapacity = { interval: null, total: 0, remaining: this.capacitySettings.maxPizzas, warning: false, estimatedWaitTime: 0 };
                        return;
                    }

                    const checkTime = new Date(`${this.date}T${this.hour}`);
                    
                    // Controlla gli ordini attivi per la fascia oraria di 30 minuti (o intervallo definito)
                    let totalPizzasInInterval = 0;
                    const intervalMs = this.capacitySettings.intervalMinutes * 60 * 1000;
                    
                    this.activeOrders.forEach(order => {
                        const orderTime = new Date(`${order.date}T${order.hour}`);
                        if (Math.abs(orderTime.getTime() - checkTime.getTime()) < intervalMs / 2) {
                            totalPizzasInInterval += this.calculatePizzasInOrder(order);
                        }
                    });

                    // Calcola le pizze nell'ordine attuale (aggiunte come carico futuro)
                    totalPizzasInInterval += this.pizzasInCurrentOrder;

                    const maxPizzas = this.capacitySettings.maxPizzas;
                    const remaining = maxPizzas - totalPizzasInInterval;
                    
                    this.orderCapacity.total = totalPizzasInInterval;
                    this.orderCapacity.remaining = Math.max(0, remaining);
                    this.orderCapacity.warning = totalPizzasInInterval > maxPizzas * 0.7; // Warning al 70%
                    
                    // Nuovo: Calcolo Stima Tempo di Attesa
                    if (totalPizzasInInterval > maxPizzas) {
                        this.orderCapacity.estimatedWaitTime = this.capacitySettings.intervalMinutes + 10; // Extra tempo
                    } else if (totalPizzasInInterval > maxPizzas * 0.9) {
                        this.orderCapacity.estimatedWaitTime = this.capacitySettings.intervalMinutes;
                    } else {
                        this.orderCapacity.estimatedWaitTime = Math.round((totalPizzasInInterval / maxPizzas) * this.capacitySettings.intervalMinutes * 0.7);
                    }
                },
                calculatePizzasInOrder(order) {
                    return order.order.reduce((count, item) => {
                        const catName = this.getCategoryNameByItemName(item.nome);
                        if (catName === 'Pizza Classica' || catName === 'Pizze Speciali') {
                            count += 1;
                        } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                            count += 4; 
                        } else if (item.isHalfPizza) {
                            count += 1; 
                        } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                            count += 2; 
                        }
                        return count;
                    }, 0);
                },
                
                // --- Finalizzazione Ordine ---
                validateOrderData() {
                    const errors = [];
                    if (this.order.length === 0) errors.push("L'ordine è vuoto.");
                    if (!this.date || !this.hour) errors.push("Seleziona data e ora di ritiro/consegna.");
                    
                    if (this.mode === 'asporto' || this.mode === 'consegna') {
                        if (!this.customer) errors.push("Nome Cliente è obbligatorio.");
                        if (!this.phone) errors.push("Telefono Cliente è obbligatorio.");
                    }
                    if (this.mode === 'consegna') {
                        if (!this.address || !this.streetNumber) errors.push("Indirizzo completo (Via e Civico) è obbligatorio.");
                        if (!this.zoneName) errors.push("Seleziona una Zona di Consegna.");
                        if (!this.drivers.includes(this.selectedDriver)) errors.push("Assegna un Fattorino.");
                    }
                    
                    if (errors.length > 0) {
                        alert("ATTENZIONE: Correggi i seguenti errori:\n" + errors.join('\n'));
                        return false;
                    }
                    
                    // Blocco Orari di Chiusura (NUOVO)
                    const orderTime = new Date(`${this.date}T${this.hour}`);
                    const today = new Date();
                    
                    // 1. Controlla il giorno di chiusura
                    if (this.businessHours.closedDays.includes(orderTime.getDay())) {
                        alert(`Giorno di chiusura: La pizzeria è chiusa di ${orderTime.toLocaleDateString('it-IT', { weekday: 'long' })}.`);
                        return false;
                    }
                    
                    // 2. Controlla orario
                    const timeString = this.hour; // Es. "19:30"
                    const [hour, minute] = timeString.split(':').map(Number);
                    
                    const openTime = this.businessHours.openTime;
                    const closeTime = this.businessHours.closeTime;

                    const isToday = orderTime.toDateString() === today.toDateString();
                    
                    if (isToday) {
                        // Se l'orario è nel passato e non è ancora passato l'orario di chiusura
                        if (orderTime < today && today.getHours() < parseInt(closeTime.split(':')[0], 10)) {
                             // Ignora se l'ordine è per ora (entro i prossimi 5 minuti)
                            if ((orderTime.getTime() - today.getTime()) / 60000 < -5) {
                                alert("L'orario selezionato è già passato.");
                                return false;
                            }
                        }
                        
                        // Controlla se l'orario è fuori dall'intervallo di apertura odierno
                        if (timeString < openTime || timeString > closeTime) {
                            alert(`Orario non valido. Orario di apertura: ${openTime} - ${closeTime}.`);
                            return false;
                        }
                    }

                    // 3. Controlla la capacità
                    if (this.isCapacityFull && this.orderCapacity.remaining <= 0) {
                        alert(`Siamo al completo per le ${this.hour}. Suggerire orario alternativo. Tempo di attesa stimato: ${this.orderCapacity.estimatedWaitTime} minuti.`);
                        return false;
                    }
                    
                    return true;
                },
                confirmOrder() {
                    if (!this.validateOrderData()) {
                        return;
                    }

                    const now = new Date();
                    const finalOrder = {
                        id: ++this.lastOrderId,
                        order: JSON.parse(JSON.stringify(this.order)),
                        total: this.total,
                        mode: this.mode,
                        customer: this.customer.trim(),
                        phone: this.phone.trim(),
                        address: this.address.trim(),
                        streetNumber: this.streetNumber.trim(),
                        town: this.town.trim(),
                        tableNumber: this.tableNumber.trim(),
                        carPlate: this.carPlate.trim(),
                        notes: this.notes.trim(),
                        date: this.date,
                        hour: this.hour,
                        deliveryCost: this.deliveryCost,
                        zoneName: this.zoneName,
                        driver: this.selectedDriver,
                        timestamp: now.toISOString(),
                        status: 'Nuovo', // Nuovo, In Preparazione, Pronto/In Consegna, Completato/Ritirato
                        paymentMethod: this.paymentMethod, // Nuovo
                        accontoRicevuto: this.accontoRicevuto,
                        discountAmount: this.discountAmount,
                        discountType: this.discountType,
                    };
                    
                    this.activeOrders.push(finalOrder);
                    
                    // Salva lo storico del cliente (NUOVO)
                    if (this.customer && this.phone) {
                        this.saveCustomerHistory(finalOrder);
                    }
                    
                    this.resetOrderForm();
                    this.saveData(); 
                },
                saveCustomerHistory(order) {
                    let existingCustomerIndex = this.customerHistory.findIndex(c => 
                        c.phone === order.phone.trim() || (c.customer === order.customer.trim() && c.address === order.address.trim())
                    );

                    const historyItem = {
                        customer: order.customer.trim(),
                        phone: order.phone.trim(),
                        address: order.address.trim(),
                        streetNumber: order.streetNumber.trim(),
                        town: order.town.trim(),
                        notes: order.notes.trim(), // Salva l'ultima nota usata
                        lastOrderDate: order.timestamp,
                    };

                    if (existingCustomerIndex !== -1) {
                        // Aggiorna
                        Object.assign(this.customerHistory[existingCustomerIndex], historyItem);
                    } else {
                        // Nuovo
                        this.customerHistory.push(historyItem);
                    }
                    // Limita la cronologia per evitare un array troppo grande
                    if (this.customerHistory.length > 500) {
                        this.customerHistory.sort((a, b) => new Date(b.lastOrderDate) - new Date(a.lastOrderDate));
                        this.customerHistory.splice(500); 
                    }
                },
                resetOrderForm() {
                    this.order = [];
                    this.showModal = false;
                    this.selectedItemIndex = null;
                    this.mode = 'banco';
                    this.customer = '';
                    this.phone = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.tableNumber = '';
                    this.carPlate = '';
                    this.notes = '';
                    this.deliveryCost = 0.00;
                    this.zoneName = '';
                    this.selectedDriver = '';
                    this.accontoRicevuto = 0.00;
                    this.paymentMethod = 'contanti';
                    this.discountAmount = 0.00;
                    this.discountType = 'fixed';

                    // Imposta data e ora predefinite al momento della pressione
                    const now = new Date();
                    this.date = now.toISOString().slice(0, 10);
                    // Arrotonda all'intervallo di 5 minuti successivo (es. 19:12 -> 19:15)
                    const minutes = now.getMinutes();
                    const roundedMinutes = Math.ceil(minutes / 5) * 5; 
                    now.setMinutes(roundedMinutes);
                    this.hour = now.toTimeString().slice(0, 5); 
                    
                    this.updateCapacityWarning(); // Aggiorna il check capacità dopo il reset
                },

                // --- Funzioni Cliente (NUOVO) ---
                filterCustomers() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory.filter(c => 
                        c.customer.toLowerCase().includes(term) ||
                        c.phone.includes(term) ||
                        c.address.toLowerCase().includes(term)
                    ).slice(0, 5); // Mostra al massimo 5 suggerimenti
                },
                selectCustomerSuggestion(customerData) {
                    this.customer = customerData.customer;
                    this.phone = customerData.phone;
                    this.address = customerData.address;
                    this.streetNumber = customerData.streetNumber;
                    this.town = customerData.town;
                    this.notes = customerData.notes; // Recupera l'ultima nota
                    this.filteredCustomerSuggestions = [];
                    // Aggiorna il costo di consegna in base all'indirizzo se necessario
                    this.updateDeliveryCost();
                },
                
                // --- Funzioni Ordini Attivi ---
                markOrderReady(order) {
                    if (order.status === 'Pronto/In Consegna') {
                        order.status = 'In Preparazione';
                    } else {
                        order.status = 'Pronto/In Consegna';
                        if (order.mode === 'consegna') {
                            // Avviso di assegnazione fattorino se non è stato fatto
                            if (!order.driver) {
                                alert(`ATTENZIONE: Ordine ${order.id} pronto! Assegna un fattorino.`);
                            }
                        }
                    }
                    this.saveData();
                },
                markOrderCompleted(order) {
                    order.status = 'Completato/Ritirato';
                    this.activeOrders = this.activeOrders.filter(o => o.id !== order.id);
                    this.archive.push(order); // Sposta nell'archivio
                    this.saveData();
                },
                editActiveOrder(order) {
                    // Imposta i dati dell'ordine per la modifica
                    this.order = JSON.parse(JSON.stringify(order.order));
                    this.editingOrderId = order.id;
                    this.mode = order.mode;
                    this.customer = order.customer;
                    this.phone = order.phone;
                    this.address = order.address;
                    this.streetNumber = order.streetNumber;
                    this.town = order.town;
                    this.tableNumber = order.tableNumber;
                    this.carPlate = order.carPlate;
                    this.date = order.date;
                    this.hour = order.hour;
                    this.notes = order.notes;
                    this.deliveryCost = order.deliveryCost;
                    this.zoneName = order.zoneName;
                    this.selectedDriver = order.driver;
                    this.accontoRicevuto = order.accontoRicevuto;
                    this.paymentMethod = order.paymentMethod || 'contanti';
                    this.discountAmount = order.discountAmount || 0.00;
                    this.discountType = order.discountType || 'fixed';

                    this.showModal = true;
                },
                updateOrder() {
                    if (!this.validateOrderData()) {
                        return;
                    }
                    const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                    if (index !== -1) {
                        const updatedOrder = {
                            ...this.activeOrders[index],
                            order: JSON.parse(JSON.stringify(this.order)),
                            total: this.total,
                            mode: this.mode,
                            customer: this.customer.trim(),
                            phone: this.phone.trim(),
                            address: this.address.trim(),
                            streetNumber: this.streetNumber.trim(),
                            town: this.town.trim(),
                            tableNumber: this.tableNumber.trim(),
                            carPlate: this.carPlate.trim(),
                            notes: this.notes.trim(),
                            date: this.date,
                            hour: this.hour,
                            deliveryCost: this.deliveryCost,
                            zoneName: this.zoneName,
                            driver: this.selectedDriver,
                            paymentMethod: this.paymentMethod,
                            accontoRicevuto: this.accontoRicevuto,
                            discountAmount: this.discountAmount,
                            discountType: this.discountType,
                        };
                        this.activeOrders.splice(index, 1, updatedOrder);
                        this.saveCustomerHistory(updatedOrder); // Aggiorna storico cliente
                        this.editingOrderId = null;
                        this.resetOrderForm();
                        this.saveData();
                    }
                },
                cancelEdit() {
                    this.editingOrderId = null;
                    this.resetOrderForm();
                },

                // --- Funzioni Storico (Archivio) ---
                calculateDriverStats() {
                    let totalOrders = 0;
                    let totalRevenue = 0;
                    
                    this.filteredArchive.forEach(o => {
                        if (o.driver === this.selectedDriver) {
                            totalOrders++;
                            totalRevenue += o.total;
                        }
                    });

                    this.driverStats = { totalOrders, totalRevenue };
                },
                exportArchive() {
                    const data = JSON.stringify(this.archive);
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `archivio_ordini_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('Archivio esportato con successo!');
                },
                clearArchive() {
                    if (this.isOwner && confirm("SEI SICURO DI VOLER CANCELLARE TUTTO L'ARCHIVIO STORICO? Questa operazione è IRREVERSIBILE!")) {
                        this.archive = [];
                        this.lastOrderId = 0;
                        this.saveData();
                        alert('Archivio storico cancellato.');
                    } else if (!this.isOwner) {
                        alert('Accesso negato. Solo il Titolare può eseguire questa operazione.');
                    }
                },
                
                // --- Funzione Stampa/Condivisione (Modal) ---
                openShareModal(order) {
                    this.selectedOrderForShare = order;
                    this.showShareModal = true;
                },
                closeShareModal() {
                    this.showShareModal = false;
                    this.selectedOrderForShare = null;
                },
                printOrder() {
                    const printContent = document.getElementById('print-content');
                    if (printContent) {
                        const originalContents = document.body.innerHTML;
                        const printWindow = window.open('', '_blank', 'height=600,width=800');
                        printWindow.document.write('<html><head><title>Comanda Ordine</title>');
                        // Potresti voler includere qui i CSS per la stampa
                        printWindow.document.write('<style>body { font-family: monospace; font-size: 10pt; }</style>');
                        printWindow.document.write('</head><body>');
                        printWindow.document.write(printContent.innerHTML);
                        printWindow.document.write('</body></html>');
                        printWindow.document.close();
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }
                },
                
                // Funzioni di Inizializzazione
                mounted() {
                    this.loadData();
                    // Setta l'ora/data al mount
                    this.resetOrderForm();
                    if (!this.isAccessGranted) {
                        this.view = 'login';
                    }
                }
            }
        });
        
        // --- Componente per la Stampa/Comanda ---
        app.component('order-print', {
            props: ['order', 'calculateItemTotal', 'getModifierCategory', 'getModifierIcon'],
            template: `
                <div id="print-content" class="p-4" style="width: 300px; margin: 0 auto; border: 1px dashed black;">
                    <h2 class="text-xl font-bold text-center mb-4">La Tua Pizzeria Smart</h2>
                    <hr class="mb-2 border-dashed border-black">
                    
                    <p class="font-bold">Ordine #{{ order.id }} ({{ order.mode.toUpperCase() }})</p>
                    <p>Ora: {{ order.hour }} del {{ order.date.split('-').reverse().join('/') }}</p>
                    <p v-if="order.tableNumber">Tavolo: {{ order.tableNumber }}</p>
                    
                    <div v-if="order.mode !== 'banco'" class="mt-3">
                        <p class="font-bold">Cliente: {{ order.customer }}</p>
                        <p v-if="order.phone">Tel: {{ order.phone }}</p>
                        <p v-if="order.address">Indirizzo: {{ order.address }} {{ order.streetNumber }} ({{ order.zoneName }})</p>
                        <p v-if="order.carPlate">Targa Ritiro: {{ order.carPlate }}</p>
                        <p v-if="order.driver">Fattorino: {{ order.driver }}</p>
                    </div>
                    
                    <hr class="mb-2 mt-2 border-dashed border-black">
                    <p class="font-bold">Articoli:</p>
                    <div v-for="(item, index) in order.order" :key="index" class="mb-2 border-b border-dashed border-gray-400 pb-1">
                        <p class="font-semibold">{{ item.nome }} <span class="float-right font-normal">€{{ calculateItemTotal(item).toFixed(2) }}</span></p>
                        
                        <div v-if="item.isMeter || item.isHalfPizza">
                            <div v-if="item.isHalfPizza" class="ml-2 text-sm">
                                <p>1/2: {{ item.gusto1 }} <span v-if="item.modifiers1.length">({{ item.modifiers1.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span></p>
                                <p>2/2: {{ item.gusto2 }} <span v-if="item.modifiers2.length">({{ item.modifiers2.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span></p>
                            </div>
                            <div v-else-if="item.isMeter" class="ml-2 text-sm">
                                <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                    <p>{{ gusto.name }}: {{ gusto.gusto }} 
                                        <span v-if="gusto.modifiers.length">({{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else-if="item.modifiers && item.modifiers.length" class="ml-2 text-sm">
                            <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}<span v-if="mod.prezzo > 0"> (+€{{ mod.prezzo.toFixed(2) }})</span><span v-if="mIndex < item.modifiers.length - 1">,</span>
                            </span>
                        </div>

                    </div>
                    
                    <hr class="mb-2 mt-2 border-dashed border-black">

                    <p v-if="order.deliveryCost > 0">Consegna: <span class="float-right">€{{ order.deliveryCost.toFixed(2) }}</span></p>
                    <p v-if="order.discountAmount > 0">Sconto ({{ order.discountType === 'percent' ? order.discountAmount + '%' : 'fisso' }}): <span class="float-right font-bold text-red-600">- €{{ (order.total - (order.total - order.discountAmount)).toFixed(2) }}</span></p>
                    <p class="text-xl font-bold mt-2">TOTALE: <span class="float-right">€{{ order.total.toFixed(2) }}</span></p>
                    <p class="mt-1 text-sm">Pagamento: {{ order.paymentMethod.toUpperCase() }}</p>

                    <div v-if="order.notes" class="mt-3 p-1 border border-black border-dashed">
                        <p class="font-bold text-sm">NOTE: {{ order.notes }}</p>
                    </div>

                    <p class="text-center mt-4 text-xs">Grazie per aver scelto La Tua Pizzeria Smart!</p>
                </div>
            `
        });
        
        // --- Componente per la CUCINA (KDS) (Nuovo) ---
        app.component('kitchen-display', {
            props: ['activeOrders', 'calculateItemTotal', 'getModifierCategory', 'getModifierIcon', 'markOrderReady', 'markOrderCompleted'],
            template: `
                <div class="p-4">
                    <h1 class="text-2xl font-bold mb-4 text-white">Comande per la Cucina (KDS)</h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div v-for="order in activeOrders" :key="order.id" 
                            :class="[
                                'p-4 rounded-lg shadow-lg text-white border-4',
                                order.status === 'Pronto/In Consegna' ? 'bg-green-700 border-green-400' : 
                                order.status === 'In Preparazione' ? 'bg-yellow-600 border-yellow-300' : 'bg-red-700 border-red-300',
                                { 'animate-pulse': order.status === 'Nuovo' } 
                            ]">
                            
                            <div class="flex justify-between items-center mb-3 border-b pb-2">
                                <h3 class="text-xl font-bold">Ordine #{{ order.id }}</h3>
                                <div class="text-lg font-semibold">{{ order.hour }} ({{ order.mode.toUpperCase().slice(0, 1) }})</div>
                            </div>

                            <p class="text-lg font-semibold">Cliente: {{ order.customer || 'BANCO' }}</p>
                            <p v-if="order.tableNumber" class="text-lg font-semibold">Tavolo: {{ order.tableNumber }}</p>
                            <p v-if="order.address" class="text-sm">{{ order.address }} {{ order.streetNumber }}</p>
                            <p v-if="order.notes" class="mt-2 p-1 bg-black bg-opacity-30 rounded text-sm">Note: {{ order.notes }}</p>

                            <hr class="my-3 border-dashed border-white border-opacity-50">

                            <div v-for="(item, itemIndex) in order.order" :key="itemIndex" class="mb-2">
                                <p class="font-bold text-xl">{{ item.nome }}</p>
                                
                                <div v-if="item.isMeter || item.isHalfPizza" class="ml-2 text-sm">
                                    <div v-if="item.isHalfPizza">
                                        <p>1/2: {{ item.gusto1 }} <span v-if="item.modifiers1.length" class="text-yellow-100">({{ item.modifiers1.map(m => m.nome).join(', ') }})</span></p>
                                        <p>2/2: {{ item.gusto2 }} <span v-if="item.modifiers2.length" class="text-yellow-100">({{ item.modifiers2.map(m => m.nome).join(', ') }})</span></p>
                                    </div>
                                    <div v-else-if="item.isMeter">
                                        <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                            <p>{{ gusto.name }}: {{ gusto.gusto }} 
                                                <span v-if="gusto.modifiers.length" class="text-yellow-100">({{ gusto.modifiers.map(m => m.nome).join(', ') }})</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else-if="item.modifiers && item.modifiers.length" class="ml-2 text-sm text-yellow-100">
                                    <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                        {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}
                                    </span>
                                </div>
                            </div>
                            
                            <hr class="my-3 border-dashed border-white border-opacity-50">

                            <div class="flex justify-between space-x-2">
                                <button @click.stop="markOrderReady(order)"
                                    :class="[
                                        'px-3 py-2 rounded font-bold transition duration-150',
                                        order.status === 'Pronto/In Consegna' ? 'bg-red-400 hover:bg-red-500' : 'bg-yellow-400 hover:bg-yellow-500 text-black'
                                    ]">
                                    {{ order.status === 'Pronto/In Consegna' ? 'RIMETTI IN PREP.' : 'MARCA PRONTO' }}
                                </button>
                                <button @click.stop="markOrderCompleted(order)" class="px-3 py-2 bg-gray-400 hover:bg-gray-500 rounded font-bold text-black transition duration-150">
                                    COMPLETA
                                </button>
                            </div>
                        </div>
                    </div>
                    <p v-if="!activeOrders.length" class="text-center text-gray-500 mt-10 text-xl">Nessun ordine attivo per la preparazione.</p>
                </div>
            `
        });

        app.mount('#app');
    </script>
<div id="app" class="h-screen flex flex-col bg-gray-100 font-sans">
        
        <header v-if="view !== 'login' && view !== 'cucina'" class="bg-gray-800 text-white shadow-lg p-3 flex justify-between items-center z-10">
            <h1 class="text-2xl font-bold tracking-wider">🍕 Pizzeria Smart</h1>
            <nav class="flex space-x-4">
                <button @click="view = 'inserimento'" :class="{'bg-gray-700': view === 'inserimento'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Nuovo Ordine</button>
                <button v-if="isAdmin" @click="view = 'ordini'" :class="{'bg-gray-700': view === 'ordini'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Ordini Attivi</button>
                <button v-if="isOwner" @click="view = 'storico'" :class="{'bg-gray-700': view === 'storico'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Storico/Statistiche</button>
                <button v-if="isOwner" @click="view = 'impostazioni'" :class="{'bg-gray-700': view === 'impostazioni'}" class="px-3 py-2 rounded transition duration-150 hover:bg-gray-700">Impostazioni</button>
                <button v-if="isAdmin" @click="view = 'cucina'" class="px-3 py-2 rounded transition duration-150 bg-red-600 hover:bg-red-700 font-bold">CUCINA</button>
            </nav>
            <div class="flex items-center space-x-3">
                <span v-if="isAdmin" class="text-sm">Accesso: <span class="font-bold">{{ userRole }}</span></span>
                <button v-if="isAdmin" @click="logout" class="px-3 py-2 bg-red-500 rounded hover:bg-red-600 transition duration-150">Logout</button>
                <button v-else @click="view = 'login'" class="px-3 py-2 bg-green-500 rounded hover:bg-green-600 transition duration-150">Login</button>
            </div>
        </header>

        <main v-if="view === 'login'" class="flex-grow flex items-center justify-center bg-gray-900">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 class="text-3xl font-bold mb-6 text-gray-800">Accesso Sistema POS</h2>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-center text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button @click="grantAccess" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">Accedi</button>
            </div>
        </main>

        <main v-else-if="view === 'cucina'" class="flex-grow bg-gray-900">
            <div class="flex justify-between items-center p-4 bg-gray-800 text-white sticky top-0 z-10">
                <h1 class="text-3xl font-bold">Display Cucina (KDS)</h1>
                <button @click="view = 'ordini'" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg">Torna a Ordini Attivi</button>
            </div>
            <kitchen-display 
                :activeOrders="filteredActiveOrders" 
                :calculateItemTotal="calculateItemTotal" 
                :getModifierCategory="getModifierCategory" 
                :getModifierIcon="getModifierIcon" 
                :markOrderReady="markOrderReady"
                :markOrderCompleted="markOrderCompleted">
            </kitchen-display>
        </main>

        <main v-else class="flex-grow flex overflow-hidden">
            
            <div v-if="view === 'inserimento'" class="w-2/5 p-4 bg-white border-r border-gray-200 flex flex-col">
                
                <div class="flex-shrink-0 mb-4">
                    <input type="text" v-model="searchTerm" placeholder="Cerca pizza, bevanda..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 mb-2">
                    
                    <div class="flex space-x-2 overflow-x-auto pb-2">
                        <button v-for="(items, category) in menu" :key="category" 
                                @click="activeCat = category; searchTerm = ''" 
                                :class="{'bg-red-600 text-white': activeCat === category, 'bg-gray-200 text-gray-700': activeCat !== category}"
                                class="flex-shrink-0 px-4 py-2 rounded-lg font-semibold text-sm transition duration-150 hover:bg-red-500 hover:text-white">
                            {{ category }}
                        </button>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto pr-2 mb-4">
                    <div v-if="!searchTerm" class="mb-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h3 class="text-sm font-bold mb-2 text-yellow-800">⭐ I Tuoi Preferiti (Click Singolo)</h3>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="id in operatorFavorites.items" :key="'fav-' + id" 
                                    @click="handleItemClick(findMenuItemById(id))"
                                    :class="{'opacity-50 cursor-not-allowed': findMenuItemById(id)?.isFinished}"
                                    class="px-3 py-1 text-xs bg-yellow-400 text-yellow-900 rounded-full font-semibold hover:bg-yellow-500 transition duration-150">
                                {{ findMenuItemById(id)?.nome }}
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold mb-3">{{ activeCat }} ({{ filteredAvailableItems.length }})</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button v-for="item in filteredAvailableItems" :key="item.id" 
                                @click="handleItemClick(item)" 
                                :class="{
                                    'bg-green-100 border-green-400 hover:bg-green-200': item.prezzo < 8,
                                    'bg-blue-100 border-blue-400 hover:bg-blue-200': item.prezzo >= 8,
                                    'opacity-50 cursor-not-allowed': item.isFinished
                                }"
                                class="p-3 border rounded-lg text-left transition duration-150 relative">
                            <span class="font-bold block">{{ item.nome }}</span>
                            <span class="text-sm text-gray-600">€{{ item.prezzo.toFixed(2) }}</span>
                            
                            <div class="absolute top-1 right-1 flex space-x-1">
                                <span v-if="item.isFinished" class="text-xs bg-red-500 text-white px-2 py-0.5 rounded-full">Esaurito</span>
                                <button v-else @click.stop="addToFavorites(item.id, 'item')" 
                                        :class="{'text-yellow-500': isFavorite(item.id, 'item'), 'text-gray-400 hover:text-yellow-500': !isFavorite(item.id, 'item')}" 
                                        class="text-xl leading-none">
                                    ⭐
                                </button>
                            </div>
                        </button>
                    </div>
                    <p v-if="!filteredAvailableItems.length" class="text-center text-gray-500 mt-5">Nessun articolo trovato in {{ activeCat }}.</p>
                </div>
                
                <div v-if="selectedItemIndex !== null" class="flex-shrink-0 mt-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold mb-3">Aggiungi Modificatore ({{ order[selectedItemIndex].nome }})</h3>
                    
                    <div class="flex space-x-2 mb-3 overflow-x-auto">
                        <button v-for="(mods, category) in modifiers" :key="category" 
                                @click="activeModCat = category; modifierSearchTerm = ''"
                                :class="{'bg-red-600 text-white': activeModCat === category, 'bg-gray-200 text-gray-700': activeModCat !== category}"
                                class="flex-shrink-0 px-3 py-1 rounded-lg font-semibold text-xs transition duration-150 hover:bg-red-500 hover:text-white">
                            {{ category }}
                        </button>
                    </div>
                    
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-red-400 mb-3 text-sm">

                    <div v-if="!modifierSearchTerm" class="mb-4 p-2 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h4 class="text-sm font-bold mb-1 text-yellow-800">⭐ Modificatori Preferiti</h4>
                        <div class="flex flex-wrap gap-2">
                            <button v-for="id in operatorFavorites.modifiers" :key="'fav-mod-' + id" 
                                    @click="addExtra(findModifierById(id))"
                                    :class="{'opacity-50 cursor-not-allowed': findModifierById(id)?.isFinished}"
                                    class="px-3 py-1 text-xs bg-yellow-400 text-yellow-900 rounded-full font-semibold hover:bg-yellow-500 transition duration-150">
                                {{ findModifierById(id)?.nome }}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto pr-1">
                        <button v-for="mod in filteredModifiersForActiveCat" :key="mod.id" 
                                @click="addExtra(mod)" 
                                :class="{'bg-red-100 border-red-400 hover:bg-red-200': activeModCat === 'Senza', 'bg-gray-100 border-gray-400 hover:bg-gray-200': activeModCat !== 'Senza'}"
                                class="p-2 border rounded-lg text-xs font-semibold transition duration-150 relative">
                            {{ getModifierIcon(activeModCat) }} {{ mod.nome }}
                            <span v-if="mod.prezzo > 0" class="block text-gray-600">€{{ mod.prezzo.toFixed(2) }}</span>
                            
                            <button @click.stop="addToFavorites(mod.id, 'modifier')" 
                                    :class="{'text-yellow-500': isFavorite(mod.id, 'modifier'), 'text-gray-400 hover:text-yellow-500': !isFavorite(mod.id, 'modifier')}" 
                                    class="absolute top-0 right-0 p-1 text-xs leading-none">
                                ⭐
                            </button>
                        </button>
                    </div>
                </div>

            </div>
            
            <div v-if="view === 'inserimento'" class="w-3/5 p-4 bg-gray-50 flex flex-col">
                ```

                <div class="flex-grow overflow-y-auto pr-2 mb-4 border border-gray-300 rounded-lg p-3 bg-white">
                    <h2 class="text-xl font-bold mb-3 flex justify-between items-center">
                        Carrello Ordine
                        <button @click="resetOrderForm" v-if="order.length > 0" class="text-sm text-red-600 hover:text-red-800 font-normal">Svuota Carrello</button>
                    </h2>
                    
                    <div v-if="order.length === 0" class="text-center text-gray-500 py-10">Il carrello è vuoto.</div>
                    
                    <div v-for="(item, index) in order" :key="index"
                         @click="selectItem(index)"
                         :class="{
                             'bg-yellow-100 border-yellow-500': index === selectedItemIndex,
                             'bg-white border-gray-300 hover:bg-gray-50': index !== selectedItemIndex,
                             'last-selected': index === lastSelectedItem // Se vuoi usare una classe CSS separata per l'ultima selezione
                         }"
                         class="p-3 mb-2 rounded-lg border cursor-pointer transition duration-150 relative shadow-sm">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <span class="font-bold block">{{ item.nome }}</span>
                                
                                <div v-if="item.isHalfPizza" class="text-sm ml-2 mt-1">
                                    <span class="font-semibold">1/2:</span> {{ item.gusto1 }} 
                                        <span v-if="item.modifiers1.length" class="text-xs text-gray-600">({{ item.modifiers1.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span><br>
                                    <span class="font-semibold">2/2:</span> {{ item.gusto2 }} 
                                        <span v-if="item.modifiers2.length" class="text-xs text-gray-600">({{ item.modifiers2.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                </div>

                                <div v-else-if="item.isMeter" class="text-sm ml-2 mt-1">
                                    <div v-for="(gusto, gIndex) in item.gusti" :key="gIndex">
                                        <span class="font-semibold">{{ gusto.name }}:</span> {{ gusto.gusto }} 
                                        <span v-if="gusto.modifiers.length" class="text-xs text-gray-600">({{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})</span>
                                    </div>
                                </div>

                                <div v-else-if="item.modifiers && item.modifiers.length" class="text-sm text-gray-700 mt-1">
                                    <span v-for="(mod, mIndex) in item.modifiers" :key="mIndex" class="mr-1">
                                        {{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }}<span v-if="mod.prezzo > 0"> (+€{{ mod.prezzo.toFixed(2) }})</span>
                                    </span>
                                </div>
                                
                                <div v-if="item.manualPrice !== undefined" class="text-xs text-red-600 mt-1">
                                    Prezzo Modificato Man.: €{{ item.manualPrice.toFixed(2) }}
                                </div>
                            </div>

                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                                
                                <button @click.stop="openPriceEditModal(index)" 
                                        :title="item.isMeter || item.isHalfPizza ? 'Modifica non disponibile' : 'Modifica Prezzo'"
                                        :disabled="item.isMeter || item.isHalfPizza"
                                        :class="{'opacity-50 cursor-not-allowed': item.isMeter || item.isHalfPizza}"
                                        class="text-gray-500 hover:text-blue-500 transition duration-150">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </button>
                                
                                <button @click.stop="removeItem(index)" class="text-red-500 hover:text-red-700 transition duration-150">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 pt-4 border-t border-gray-300">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-semibold">Totale Parziale:</span>
                        <span class="text-lg font-semibold">€{{ (total - deliveryCost).toFixed(2) }}</span>
                    </div>
                    <div v-if="deliveryCost > 0" class="flex justify-between items-center mb-3 text-sm text-blue-600">
                        <span>Costo Consegna ({{ zoneName }})</span>
                        <span>+ €{{ deliveryCost.toFixed(2) }}</span>
                    </div>
                    <div v-if="discountAmount > 0" class="flex justify-between items-center mb-3 text-sm text-red-600">
                        <span>Sconto ({{ discountType === 'percent' ? discountAmount + '%' : 'fisso' }})</span>
                        <span>- €{{ (calculatedOrderTotal - (total - deliveryCost - discountAmount)).toFixed(2) }}</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-2xl font-bold">TOTALE FINALE:</span>
                        <span class="text-2xl font-bold text-red-600">€{{ total.toFixed(2) }}</span>
                    </div>
                    
                    <button @click="showModal = true" :disabled="order.length === 0"
                            class="w-full bg-red-600 text-white p-4 rounded-xl text-xl font-bold shadow-lg hover:bg-red-700 transition duration-200 disabled:bg-gray-400">
                        <i class="fa-solid fa-receipt mr-2"></i> FINALIZZA ORDINE
                    </button>
                    
                    <div v-if="hour && isCapacityWarning" 
                         :class="{'bg-yellow-100 border-yellow-500': !isCapacityFull, 'bg-red-100 border-red-500': isCapacityFull}"
                         class="mt-3 p-2 rounded-lg border text-sm text-center font-semibold">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                        <span v-if="isCapacityFull">ATTENZIONE: Orario {{ hour }} al completo! Tempo di attesa stimato: {{ orderCapacity.estimatedWaitTime }} minuti.</span>
                        <span v-else>Allerta Carico: {{ orderCapacity.total }} pizze per le {{ hour }}. Rimanenti: {{ orderCapacity.remaining }}.</span>
                    </div>
                </div>

            </div>
            
            <div v-else-if="view === 'ordini'" class="w-full p-6 bg-gray-50 flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Ordini Attivi (Totale: {{ filteredActiveOrders.length }})</h2>
                
                <div class="flex space-x-4 mb-4">
                    <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Telefono, Indirizzo o Targa" class="w-1/3 p-2 border border-gray-300 rounded-lg">
                    
                    <select v-model="activeDateFilter" class="p-2 border border-gray-300 rounded-lg">
                        <option value="today">Oggi</option>
                        <option value="tomorrow">Domani</option>
                        <option value="future">Futuro (Dopo Domani)</option>
                    </select>
                </div>

                <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 font-semibold">
                    Totale Comande "Oggi" per Forno: {{ filteredActiveOrders.length }} ordini (Pizze stimate: {{ filteredActiveOrders.reduce((sum, o) => sum + calculatePizzasInOrder(o), 0) }})
                </div>

                <div class="flex-grow overflow-y-auto space-y-4">
                    <div v-for="order in filteredActiveOrders" :key="order.id"
                         :class="[
                             'p-4 rounded-lg shadow-md transition duration-150 relative',
                             order.status === 'Pronto/In Consegna' ? 'bg-green-100 border-l-8 border-green-600' :
                             order.status === 'In Preparazione' ? 'bg-yellow-100 border-l-8 border-yellow-600' :
                             'bg-white border-l-8 border-gray-400',
                             // Evidenzia ordine con fattorino mancante
                             {'border-red-600 animate-pulse-driver': order.status === 'Pronto/In Consegna' && order.mode === 'consegna' && !order.driver }
                         ]">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold">Ordine #{{ order.id }} - {{ order.hour }}</h3>
                                <p class="text-sm text-gray-600">{{ order.date.split('-').reverse().join('/') }} - {{ order.mode.toUpperCase() }}</p>
                                
                                <p class="font-semibold mt-1">{{ order.customer || 'Banco' }} <span v-if="order.tableNumber"> (Tavolo {{ order.tableNumber }})</span></p>
                                <p v-if="order.address" class="text-sm">{{ order.address }} {{ order.streetNumber }}, {{ order.town }} ({{ order.zoneName }})</p>
                                <p v-if="order.phone" class="text-sm">Tel: {{ order.phone }}</p>
                                <p v-if="order.carPlate" class="text-sm font-semibold text-blue-600">Targa: {{ order.carPlate }}</p>

                                <div v-if="order.mode === 'consegna'" class="mt-2 flex items-center space-x-2">
                                    <span class="font-semibold">Fattorino:</span>
                                    <select v-model="order.driver" @change="saveData" class="p-1 border rounded text-sm font-bold"
                                            :class="{'border-red-600 bg-red-200': order.status === 'Pronto/In Consegna' && !order.driver}">
                                        <option value="">ASSEGNA</option>
                                        <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="text-right">
                                <p class="text-3xl font-bold text-red-600">€{{ order.total.toFixed(2) }}</p>
                                <p class="text-sm text-gray-500">{{ order.paymentMethod.toUpperCase() }}</p>
                                <p class="text-xs font-semibold mt-1">Status: {{ order.status }}</p>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-sm p-2 bg-gray-100 rounded">
                            <span class="font-semibold">Articoli:</span> {{ order.order.map(i => i.nome).join(', ') }}
                        </div>

                        <div class="mt-3 flex space-x-2 justify-end">
                            <button @click="markOrderReady(order)" 
                                    :class="[
                                        'px-3 py-1 rounded text-sm font-semibold transition duration-150',
                                        order.status === 'Pronto/In Consegna' ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-yellow-500 text-black hover:bg-yellow-600'
                                    ]">
                                {{ order.status === 'Pronto/In Consegna' ? 'RIMETTI IN PREP.' : 'MARCA PRONTO' }}
                            </button>
                            <button @click="openShareModal(order)" class="px-3 py-1 bg-blue-500 text-white rounded text-sm font-semibold hover:bg-blue-600">
                                <i class="fa-solid fa-print"></i> Stampa
                            </button>
                            <button @click="editActiveOrder(order)" class="px-3 py-1 bg-gray-500 text-white rounded text-sm font-semibold hover:bg-gray-600">
                                <i class="fa-solid fa-pen"></i> Modifica
                            </button>
                            <button @click="markOrderCompleted(order)" class="px-3 py-1 bg-green-500 text-white rounded text-sm font-semibold hover:bg-green-600">
                                <i class="fa-solid fa-check"></i> Completa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-else-if="view === 'storico'" class="w-full p-6 bg-gray-50 flex flex-col">
                <h2 class="text-2xl font-bold mb-4">Storico Ordini e Statistiche</h2>
                
                <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-md">
                    <div class="w-1/3">
                        <label class="block text-sm font-medium text-gray-700">Filtra Data:</label>
                        <input type="date" v-model="archiveDateFilter" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="w-1/3">
                        <label class="block text-sm font-medium text-gray-700">Filtra Fattorino:</label>
                        <select v-model="selectedDriver" @change="calculateDriverStats" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Tutti</option>
                            <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <div class="w-1/3">
                        <p class="font-bold text-lg">Totale Giornaliero ({{ archiveDateFilterDisplay }}):</p>
                        <p class="text-3xl font-bold text-red-600">€{{ dailyTotal.toFixed(2) }}</p>
                    </div>
                </div>

                <div v-if="selectedDriver" class="mb-4 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-lg font-semibold">
                    <p class="font-bold text-lg">Statistiche per {{ selectedDriver }}:</p>
                    <p>Ordini Consegnati: {{ driverStats.totalOrders }} - Totale Ricavi Gestiti: €{{ driverStats.totalRevenue.toFixed(2) }}</p>
                </div>

                <div class="flex-grow overflow-y-auto space-y-3 pr-2">
                    <div v-for="order in filteredArchive" :key="order.id" class="p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center">
                            <div class="flex-grow">
                                <h3 class="text-lg font-bold">Ordine #{{ order.id }} - {{ order.hour }} ({{ order.mode.toUpperCase() }})</h3>
                                <p class="text-sm text-gray-600">{{ order.customer || 'Banco' }} - {{ order.address ? order.address + ' ' + order.streetNumber : '' }}</p>
                                <p v-if="order.driver" class="text-xs mt-1">Fattorino: {{ order.driver }}</p>
                                <p class="text-xs mt-1">Articoli: {{ order.order.map(i => i.nome).join(', ') }}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-green-600">€{{ order.total.toFixed(2) }}</p>
                                <p class="text-sm text-gray-500">{{ order.paymentMethod.toUpperCase() }}</p>
                            </div>
                        </div>
                    </div>
                    <p v-if="!filteredArchive.length" class="text-center text-gray-500 py-10">Nessun ordine archiviato per questa data/filtro.</p>
                </div>
            </div>

            <div v-else-if="view === 'impostazioni'" class="w-full p-6 bg-gray-50 flex flex-col">
                </div>
        </main>

        <div v-if="showModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Dettagli e Finalizzazione Ordine' }}</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-3/5 space-y-4">
                        <h3 class="text-lg font-semibold mb-2">Modalità e Dati Cliente</h3>
                        
                        <div class="flex space-x-2 border p-2 rounded-lg bg-gray-50">
                            <button v-for="m in modes" :key="m.id" @click="mode = m.id"
                                    :class="{'bg-blue-600 text-white hover:bg-blue-700': mode === m.id, 'bg-gray-200 hover:bg-gray-300': mode !== m.id}"
                                    class="flex-1 p-3 rounded-lg font-semibold transition duration-150">
                                <i :class="m.icon" class="mr-2"></i> {{ m.label }}
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Data Ritiro/Consegna</label>
                                <input type="date" v-model="date" :min="minDate" @change="updateCapacityWarning" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ora Ritiro/Consegna</label>
                                <input type="time" v-model="hour" @change="updateCapacityWarning" class="w-full p-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div v-if="mode !== 'banco'" class="space-y-4 border p-4 rounded-lg">
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700">Nome Cliente*</label>
                                <input type="text" v-model="customer" placeholder="Nome Cliente" class="w-full p-2 border rounded-lg">
                                <ul v-if="filteredCustomerSuggestions.length" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-xl">
                                    <li v-for="(c, i) in filteredCustomerSuggestions" :key="i" @click="selectCustomerSuggestion(c)"
                                        class="p-2 cursor-pointer hover:bg-blue-100 border-b last:border-b-0 text-sm">
                                        <span class="font-semibold">{{ c.customer }}</span> ({{ c.phone }})<br>
                                        <span class="text-xs text-gray-500">{{ c.address }}</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Telefono*</label>
                                    <input type="tel" v-model="phone" placeholder="Telefono" class="w-full p-2 border rounded-lg">
                                </div>
                                <div v-if="mode === 'asporto'">
                                    <label class="block text-sm font-medium text-gray-700">Targa Auto (Ritiro)</label>
                                    <input type="text" v-model="carPlate" placeholder="Es. AB123CD" class="w-full p-2 border rounded-lg uppercase">
                                </div>
                                <div v-if="mode === 'banco'">
                                    <label class="block text-sm font-medium text-gray-700">Tavolo/Riferimento</label>
                                    <input type="text" v-model="tableNumber" placeholder="Es. Tavolo 5" class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="mode === 'consegna'" class="space-y-4 border p-4 rounded-lg bg-red-50">
                            <h4 class="font-semibold">Dettagli Consegna</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">Via/Piazza*</label>
                                    <input type="text" v-model="address" placeholder="Via/Piazza" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Civico/Scala*</label>
                                    <input type="text" v-model="streetNumber" placeholder="Civico/Int." class="w-full p-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Zona di Consegna*</label>
                                    <select v-model="zoneName" @change="updateDeliveryCost" class="w-full p-2 border rounded-lg bg-white">
                                        <option value="">Seleziona Zona</option>
                                        <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">
                                            {{ zone.name }} (€{{ zone.price.toFixed(2) }})
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Assegna Fattorino*</label>
                                    <select v-model="selectedDriver" class="w-full p-2 border rounded-lg bg-white">
                                        <option value="">Nessuno</option>
                                        <option v-for="driver in drivers" :key="driver">{{ driver }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <label class="block text-sm font-medium text-gray-700">Note Ordine (Es. Citofono, allergie)</label>
                        <textarea v-model="notes" rows="3" placeholder="Note per la cucina o il fattorino..." class="w-full p-2 border rounded-lg"></textarea>
                    </div>
                    
                    <div class="w-2/5 space-y-4">
                        <h3 class="text-lg font-semibold mb-2">Pagamento e Riepilogo</h3>
                        
                        <div class="p-3 bg-red-100 border border-red-300 rounded-lg">
                            <p class="text-xl font-bold flex justify-between">Totale Ordine: <span class="text-red-700">€{{ total.toFixed(2) }}</span></p>
                            <p v-if="deliveryCost > 0" class="text-sm flex justify-between text-blue-600">Costo Consegna: <span>+ €{{ deliveryCost.toFixed(2) }}</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Metodo di Pagamento</label>
                            <select v-model="paymentMethod" class="w-full p-2 border rounded-lg bg-white">
                                <option value="contanti">Contanti</option>
                                <option value="carta">Carta/Bancomat</option>
                                <option value="satispay">Satispay</option>
                                <option value="ticket">Ticket/Buoni</option>
                            </select>
                        </div>

                        <div class="p-3 border rounded-lg bg-gray-50">
                            <h4 class="font-semibold mb-2">Applica Sconto</h4>
                            <div class="flex space-x-2 mb-2">
                                <button @click="discountAmount = 10; discountType = 'percent'" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">10%</button>
                                <button @click="discountAmount = 5.00; discountType = 'fixed'" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">5€ Fisso</button>
                                <button @click="discountAmount = 0" class="flex-1 p-2 border rounded-lg text-sm hover:bg-gray-200">Nessun Sconto</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="col-span-2">
                                    <input type="number" v-model.number="discountAmount" step="0.01" class="w-full p-2 border rounded-lg">
                                </div>
                                <div>
                                    <select v-model="discountType" class="w-full p-2 border rounded-lg">
                                        <option value="fixed">€ Fisso</option>
                                        <option value="percent">% Percentuale</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Contanti Ricevuti (Acconto/Cifra Data)</label>
                            <input type="number" v-model.number="accontoRicevuto" step="0.01" placeholder="0.00" class="w-full p-2 border rounded-lg text-2xl font-bold text-center">
                        </div>
                        
                        <div v-if="restoDaDare > 0" class="p-3 bg-green-100 border border-green-400 rounded-lg text-center">
                            <p class="text-lg font-bold">RESTO DA DARE</p>
                            <p class="text-3xl font-bold text-green-700">€{{ restoDaDare.toFixed(2) }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelEdit" v-if="editingOrderId" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-150">
                        Annulla Modifica
                    </button>
                    <button @click="showModal = false" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400 transition duration-150">
                        Torna all'Ordine
                    </button>
                    <button v-if="editingOrderId" @click="updateOrder" class="px-6 py-3 bg-yellow-600 text-white rounded-xl font-bold hover:bg-yellow-700 transition duration-200">
                        AGGIORNA ORDINE #{{ editingOrderId }}
                    </button>
                    <button v-else @click="confirmOrder" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition duration-200">
                        CONFERMA E INSERISCI
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Componi Pizza a Metà</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-2/5 space-y-4">
                        <div class="p-3 border rounded-lg" :class="{'bg-yellow-100 border-yellow-500': tempHalfPizzaItem.activeHalf === 1}">
                            <h3 class="font-bold text-lg mb-2">METÀ 1: {{ tempHalfPizzaItem.gusto1 || 'Seleziona Gusto' }}</h3>
                            <div class="flex justify-between items-center">
                                <button @click="tempHalfPizzaItem.activeHalf = 1" class="px-4 py-2 rounded font-semibold text-white transition duration-150"
                                        :class="{'bg-green-600 hover:bg-green-700': tempHalfPizzaItem.activeHalf !== 1, 'bg-red-600': tempHalfPizzaItem.activeHalf === 1}">
                                    {{ tempHalfPizzaItem.activeHalf === 1 ? 'SELEZIONATO' : 'SELEZIONA' }}
                                </button>
                                <p class="text-sm">Modificatori: {{ tempHalfPizzaItem.modifiers1.length }}</p>
                            </div>
                            <div v-if="tempHalfPizzaItem.gusto1" class="mt-2 text-sm">
                                Modifiche: <span v-for="(mod, i) in tempHalfPizzaItem.modifiers1" :key="i" class="text-gray-600">{{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }} </span>
                            </div>
                        </div>

                        <div class="p-3 border rounded-lg" :class="{'bg-yellow-100 border-yellow-500': tempHalfPizzaItem.activeHalf === 2}">
                            <h3 class="font-bold text-lg mb-2">METÀ 2: {{ tempHalfPizzaItem.gusto2 || 'Seleziona Gusto' }}</h3>
                            <div class="flex justify-between items-center">
                                <button @click="tempHalfPizzaItem.activeHalf = 2" class="px-4 py-2 rounded font-semibold text-white transition duration-150"
                                        :class="{'bg-green-600 hover:bg-green-700': tempHalfPizzaItem.activeHalf !== 2, 'bg-red-600': tempHalfPizzaItem.activeHalf === 2}">
                                    {{ tempHalfPizzaItem.activeHalf === 2 ? 'SELEZIONATO' : 'SELEZIONA' }}
                                </button>
                                <p class="text-sm">Modificatori: {{ tempHalfPizzaItem.modifiers2.length }}</p>
                            </div>
                            <div v-if="tempHalfPizzaItem.gusto2" class="mt-2 text-sm">
                                Modifiche: <span v-for="(mod, i) in tempHalfPizzaItem.modifiers2" :key="i" class="text-gray-600">{{ getModifierIcon(getModifierCategory(mod.nome)) }}{{ mod.nome }} </span>
                            </div>
                        </div>

                        <div class="p-3 bg-blue-50 rounded-lg text-center">
                            <p class="text-xl font-bold">TOTALE STIMATO</p>
                            <p class="text-3xl font-bold text-red-600">€{{ calculateTempHalfPizzaTotal.toFixed(2) }}</p>
                        </div>
                    </div>

                    <div class="w-2/5 space-y-4 max-h-[70vh] overflow-y-auto">
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca pizza per Gusto..." class="w-full p-2 border rounded-lg">
                        <div class="grid grid-cols-2 gap-3">
                            <button v-for="gusto in filteredPizzaGusti" :key="gusto.id" 
                                    @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0"
                                    :class="{'opacity-50 cursor-not-allowed': tempHalfPizzaItem.activeHalf === 0}"
                                    class="p-3 border rounded-lg text-left bg-gray-100 hover:bg-gray-200 transition duration-150 relative">
                                <span class="font-bold block">{{ gusto.nome }}</span>
                                <span class="text-sm text-gray-600">€{{ gusto.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="w-1/5 space-y-3">
                        <h3 class="font-bold">Modificatori</h3>
                        
                        <div class="flex space-x-2">
                            <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat"
                                    :class="{'bg-red-600 text-white': tempModCat === cat, 'bg-gray-200': tempModCat !== cat}"
                                    class="flex-1 p-2 rounded-lg text-xs font-semibold">
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="max-h-[50vh] overflow-y-auto space-y-1">
                            <button v-for="mod in filteredTempModifiers" :key="mod.id" 
                                    @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0"
                                    :class="{'opacity-50 cursor-not-allowed': tempHalfPizzaItem.activeHalf === 0}"
                                    class="w-full p-2 border rounded-lg text-left text-sm font-semibold hover:bg-gray-100 transition duration-150">
                                {{ getModifierIcon(tempModCat) }} {{ mod.nome }} <span v-if="mod.prezzo > 0" class="float-right text-gray-600">+€{{ mod.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelHalfPizzaComposition" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid"
                            class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 transition duration-200">
                        Aggiungi Pizza a Metà
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showMeterModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Componi {{ tempMeterItem.nome }}</h2>
                
                <div class="flex space-x-6">
                    
                    <div class="w-1/3 space-y-4">
                        <h3 class="font-bold text-lg mb-2">1. Numero di Gusti</h3>
                        <div class="flex space-x-2">
                            <button @click="setMeterGusti(1)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 1, 'bg-gray-200': tempMeterItem.numGusti !== 1}" class="flex-1 p-3 rounded-lg font-semibold">1 Gusto</button>
                            <button @click="setMeterGusti(2)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 2, 'bg-gray-200': tempMeterItem.numGusti !== 2}" class="flex-1 p-3 rounded-lg font-semibold">2 Gusti</button>
                            <button @click="setMeterGusti(3)" :class="{'bg-red-600 text-white': tempMeterItem.numGusti === 3, 'bg-gray-200': tempMeterItem.numGusti !== 3}" class="flex-1 p-3 rounded-lg font-semibold">3 Gusti</button>
                        </div>

                        <h3 class="font-bold text-lg mb-2 mt-4">2. Riepilogo Gusti</h3>
                        <div v-for="(gusto, gIndex) in tempMeterItem.gusti" :key="gIndex" 
                             class="p-3 border rounded-lg mb-2" :class="{'bg-yellow-100 border-yellow-500': gIndex === selectedItemIndex}">
                            
                            <p class="font-bold">{{ gusto.name }}: <span class="text-blue-700">{{ gusto.gusto || 'In attesa...' }}</span></p>
                            <p v-if="gusto.modifiers.length" class="text-sm">Modifiche: {{ gusto.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }}</p>
                        </div>
                        
                        <div class="p-3 bg-blue-50 rounded-lg text-center mt-4">
                            <p class="text-xl font-bold">TOTALE STIMATO</p>
                            <p class="text-3xl font-bold text-red-600">€{{ calculateTempMeterTotal.toFixed(2) }}</p>
                            <p class="text-sm text-gray-600">(Base: €{{ tempMeterItem.prezzoBase.toFixed(2) }} + Modificatori)</p>
                        </div>
                    </div>

                    <div class="w-1/3 space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <h3 class="font-bold text-lg">3. Seleziona Gusti</h3>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca pizza per Gusto..." class="w-full p-2 border rounded-lg">
                        
                        <div v-for="(gustoSlot, gIndex) in tempMeterItem.gusti" :key="gIndex" class="mb-4 p-3 border rounded-lg" :class="{'bg-gray-100': gustoSlot.gusto}">
                            <h4 class="font-bold mb-2">{{ gustoSlot.name }}: <span class="text-green-600">{{ gustoSlot.gusto || 'Seleziona' }}</span></h4>
                            <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto">
                                <button v-for="gusto in filteredPizzaGusti" :key="gusto.id" 
                                        @click="selectMeterGusto(gIndex, gusto.nome)"
                                        class="p-2 border rounded-lg text-xs text-left bg-white hover:bg-green-100 transition duration-150">
                                    {{ gusto.nome }}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-1/3 space-y-3">
                        <h3 class="font-bold text-lg">4. Modificatori per Gusto</h3>
                        
                        <div v-for="(gustoSlot, gIndex) in tempMeterItem.gusti" :key="gIndex" 
                             class="p-3 border rounded-lg mb-4" :class="{'bg-yellow-50': gustoSlot.gusto}">
                            <h4 class="font-bold mb-2">{{ gustoSlot.name }} ({{ gustoSlot.gusto || 'Senza Gusto' }})</h4>

                            <div class="flex space-x-2 mb-2">
                                <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat"
                                        :class="{'bg-red-600 text-white': tempModCat === cat, 'bg-gray-200': tempModCat !== cat}"
                                        class="flex-1 p-1 rounded-lg text-xs font-semibold">
                                    {{ cat }}
                                </button>
                            </div>
                            
                            <div class="max-h-28 overflow-y-auto space-y-1">
                                <button v-for="mod in filteredTempModifiers" :key="mod.id" 
                                        @click="addMeterModifier(gIndex, mod)"
                                        :disabled="!gustoSlot.gusto"
                                        class="w-full p-1 border rounded-lg text-left text-xs font-semibold hover:bg-gray-100 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                                    {{ getModifierIcon(tempModCat) }} {{ mod.nome }}
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="flex justify-end space-x-4 mt-6 border-t pt-4">
                    <button @click="cancelMeterComposition" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="addMeterToOrder" :disabled="!isMeterValid"
                            class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 disabled:bg-gray-400 transition duration-200">
                        Aggiungi {{ tempMeterItem.nome }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showPriceEditModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Modifica Prezzo Articolo</h2>
                <p class="mb-4">Articolo: <span class="font-semibold">{{ order[tempPriceEditIndex]?.nome }}</span></p>
                
                <label class="block text-sm font-medium text-gray-700">Nuovo Prezzo (€)</label>
                <input type="number" v-model.number="newPriceValue" step="0.01" class="w-full p-3 border rounded-lg text-3xl font-bold text-center mb-4">
                
                <div class="flex justify-end space-x-4">
                    <button @click="cancelPriceEdit" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Annulla</button>
                    <button @click="saveNewPrice" :disabled="newPriceValue < 0" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 disabled:bg-gray-400">
                        Salva Prezzo
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Stampa Comanda Ordine #{{ selectedOrderForShare.id }}</h2>
                
                <div class="flex justify-center mb-4">
                    <order-print 
                        :order="selectedOrderForShare"
                        :calculateItemTotal="calculateItemTotal"
                        :getModifierCategory="getModifierCategory"
                        :getModifierIcon="getModifierIcon">
                    </order-print>
                </div>
                
                <div class="flex justify-end space-x-4">
                    <button @click="closeShareModal" class="px-4 py-2 bg-gray-300 rounded-lg font-semibold hover:bg-gray-400">Chiudi</button>
                    <button @click="printOrder" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">
                        <i class="fa-solid fa-print"></i> Stampa Comanda
                    </button>
                </div>
            </div>
        </div>
                <div v-else-if="view === 'impostazioni'" class="w-full p-6 bg-gray-50 flex flex-col">
                    <h2 class="text-2xl font-bold mb-6">⚙️ Impostazioni e Configurazione</h2>

                    <div class="grid grid-cols-2 gap-6 flex-grow overflow-y-auto pr-2">
                        
                        <div class="space-y-6">
                            <h3 class="text-xl font-bold border-b pb-2">Gestione Menu e Articoli</h3>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                                <h4 class="font-bold text-lg mb-3">Aggiungi Nuovo Articolo/Pizza</h4>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="block text-sm">Nome</label><input type="text" v-model="newItem.nome" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm">Prezzo (€)</label><input type="number" v-model.number="newItem.prezzo" step="0.01" class="w-full p-2 border rounded-lg"></div>
                                    <div class="col-span-2">
                                        <label class="block text-sm">Categoria</label>
                                        <select v-model="newItem.category" class="w-full p-2 border rounded-lg">
                                            <option v-for="(items, cat) in menu" :key="cat" :value="cat">{{ cat }}</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="addMenuItem" class="mt-3 w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 font-semibold">Aggiungi Articolo</button>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <h4 class="font-bold text-lg mb-3">Lista Articoli/Disponibilità (Tot: {{ allMenuItems.length }})</h4>
                                <div class="max-h-60 overflow-y-auto space-y-2 pr-1">
                                    <div v-for="item in allMenuItems" :key="item.id" class="flex justify-between items-center p-2 border rounded-lg" :class="{'bg-red-100 opacity-70': item.isFinished}">
                                        <div class="text-sm">
                                            <span class="font-semibold">{{ item.nome }}</span> ({{ item.category }}) - €{{ item.prezzo.toFixed(2) }}
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="toggleFinished(item.id, item.category)" 
                                                    :class="{'bg-green-500 hover:bg-green-600': item.isFinished, 'bg-yellow-500 hover:bg-yellow-600': !item.isFinished}"
                                                    class="px-2 py-1 text-xs text-white rounded">
                                                {{ item.isFinished ? 'Disponibile' : 'Esaurito' }}
                                            </button>
                                            <button @click="deleteMenuItem(item.id, item.category)" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">Elimina</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
                                <h4 class="font-bold text-lg mb-3">Aggiungi Nuovo Modificatore</h4>
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="col-span-1">
                                        <label class="block text-sm">Nome Modificatore</label>
                                        <input type="text" v-model="newModifier.nome" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm">Prezzo (€)</label>
                                        <input type="number" v-model.number="newModifier.prezzo" step="0.01" class="w-full p-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm">Categoria Mod.</label>
                                        <select v-model="newModifier.category" class="w-full p-2 border rounded-lg">
                                            <option v-for="(mods, cat) in modifiers" :key="cat" :value="cat">{{ cat }}</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="addModifier" class="mt-3 w-full bg-yellow-600 text-white p-2 rounded-lg hover:bg-yellow-700 font-semibold">Aggiungi Modificatore</button>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <h3 class="text-xl font-bold border-b pb-2">Logistica e Orari</h3>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-green-500">
                                <h4 class="font-bold text-lg mb-3">Gestione Fattorini</h4>
                                <div class="flex space-x-2 mb-2">
                                    <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" class="flex-grow p-2 border rounded-lg">
                                    <button @click="addDriver" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 font-semibold">Aggiungi</button>
                                </div>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <div v-for="driver in drivers" :key="driver" class="flex items-center bg-gray-100 p-2 rounded text-sm">
                                        {{ driver }}
                                        <button @click="removeDriver(driver)" class="ml-2 text-red-500 hover:text-red-700"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-orange-500">
                                <h4 class="font-bold text-lg mb-3">Zone di Consegna e Costi</h4>
                                <div class="max-h-40 overflow-y-auto space-y-2 pr-1 mb-2">
                                    <div v-for="(zone, index) in deliveryZones" :key="index" class="flex space-x-2 items-center">
                                        <input type="text" v-model="zone.name" placeholder="Nome Zona" class="flex-grow p-2 border rounded-lg text-sm">
                                        <input type="number" v-model.number="zone.price" step="0.01" placeholder="Costo" class="w-20 p-2 border rounded-lg text-sm">
                                        <button @click="removeZone(index)" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                                <button @click="addZone" class="w-full bg-orange-500 text-white p-2 rounded-lg hover:bg-orange-600 font-semibold">Aggiungi Zona</button>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-red-500">
                                <h4 class="font-bold text-lg mb-3">Gestione Capacità (Pizze/Intervallo)</h4>
                                <div>
                                    <label class="block text-sm">Pizze Max per Intervallo (Carico Massimo)</label>
                                    <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" class="w-full p-2 border rounded-lg mb-2">
                                </div>
                                <div>
                                    <label class="block text-sm">Durata Intervallo (Minuti)</label>
                                    <input type="number" v-model.number="capacitySettings.intervalMinutes" min="5" step="5" class="w-full p-2 border rounded-lg">
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Es: 30 pizze / 30 minuti.</p>
                            </div>

                            <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-blue-500">
                                <h4 class="font-bold text-lg mb-3">Orari di Apertura e Chiusura</h4>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <div><label class="block text-sm">Ora Apertura</label><input type="time" v-model="businessHours.openTime" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm">Ora Chiusura</label><input type="time" v-model="businessHours.closeTime" class="w-full p-2 border rounded-lg"></div>
                                </div>
                                <label class="block text-sm mb-1">Giorni di Chiusura (Domenica=0, Lunedì=1, ...)</label>
                                <div class="flex flex-wrap gap-2">
                                    <label v-for="(day, index) in ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab']" :key="index" class="flex items-center space-x-1 text-sm">
                                        <input type="checkbox" :value="index" v-model="businessHours.closedDays" class="rounded text-red-600">
                                        <span>{{ day }}</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 mt-6 pt-4 border-t border-gray-300 flex justify-end space-x-4">
                        <button @click="exportArchive" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                            <i class="fa-solid fa-file-export"></i> Esporta Storico
                        </button>
                        <button @click="clearArchive" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">
                            <i class="fa-solid fa-eraser"></i> Cancella Storico (Titolare)
                        </button>
                        <button @click="saveData" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">
                            <i class="fa-solid fa-save"></i> Salva Impostazioni
                        </button>
                    </div>
                </div>

            </div>
        </main>

    </div>
    
    <style>
        /* Stili Tailwind e CSS personalizzati */
        .animate-pulse-driver {
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0%, 100% {
                border-color: #f87171; /* red-400 */
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.7);
            }
            50% {
                border-color: #ef4444; /* red-500 */
                box-shadow: 0 0 0 5px rgba(248, 113, 113, 0);
            }
        }
        
        /* Forza scrollbar per carrello/liste */
        .overflow-y-auto {
            scrollbar-width: thin;
        }

    </style>
</body>
</html>
