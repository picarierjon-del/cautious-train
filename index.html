<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #e31b23; /* Rosso Pizzeria */
            --secondary-color: #ffc107; /* Giallo (Highlight) */
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: #333;
        }
        #app {
            display: flex;
            width: 100%;
        }

        /* Accesso */
        .access-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .access-card {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .access-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
        }
        .access-card input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 1.2rem;
            text-align: center;
            box-sizing: border-box;
        }
        .access-card button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .access-card button:hover {
            background-color: #c0161a;
        }

        /* Layout Principale POS */
        .sidebar {
            width: 80px;
            background-color: #343a40;
            color: white;
            display: flex;
            flex-direction: column;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.75rem;
            text-align: center;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background-color: #495057;
        }
        .sidebar-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .sidebar-item.active {
            border-left: 4px solid var(--secondary-color);
        }
        .sidebar-item.active i {
            color: var(--secondary-color);
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .pos-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Sezione Inserimento Ordine */
        .menu-panel, .cart-panel {
            padding: 15px;
            overflow-y: auto;
            height: 100%;
        }
        .menu-panel {
            flex: 2;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .cart-panel {
            flex: 1;
            background-color: var(--card-background);
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .category-tabs {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            white-space: nowrap;
            flex-shrink: 0;
            border-bottom: 2px solid #ccc;
            margin-bottom: 10px;
        }
        .category-tab {
            padding: 8px 15px;
            margin-right: 5px;
            border: none;
            background-color: #e9ecef;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            transition: background-color 0.2s, border-bottom 0.2s;
            font-weight: bold;
        }
        .category-tab.active {
            background-color: var(--card-background);
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 10px;
        }
        .item-card {
            background-color: var(--card-background);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
            border: 1px solid #eee;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .item-card.highlighted {
            border: 3px solid var(--secondary-color);
        }
        .item-card.special-item {
            background-color: #fff3cd; /* Giallo chiaro per item speciali */
        }
        .item-card.finished {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        .item-card-name {
            font-weight: bold;
            font-size: 0.95rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .item-card-price {
            font-size: 0.9rem;
            color: var(--primary-color);
            margin-top: 5px;
        }

        /* Carrello */
        .cart-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .cart-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .cart-item:hover {
            background-color: #f1f1f1;
        }
        .cart-item.selected {
            background-color: #e3f2fd; /* Azzurro chiaro */
            border-left: 5px solid var(--primary-color);
            padding-left: 5px;
        }
        .cart-item-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
        }
        .cart-item-mods {
            font-size: 0.85rem;
            color: #555;
            padding-left: 10px;
        }
        .cart-item-mods li {
            list-style-type: none;
            margin: 2px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mod-icon {
            font-size: 0.9rem;
            margin-right: 5px;
        }
        .remove-mod-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 5px;
        }
        .cart-total {
            padding: 15px;
            border-top: 2px solid var(--primary-color);
            font-size: 1.4rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .finish-button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .finish-button:hover {
            background-color: #c0161a;
        }
        .remove-item-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
            position: absolute;
            top: 5px;
            right: 5px;
        }

        /* Modificatori */
        .modifier-panel {
            flex: 1;
            padding: 15px;
            background-color: #f1f1f1;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        .modifier-tabs {
            display: flex;
            margin-bottom: 10px;
            flex-shrink: 0;
            border-bottom: 2px solid #ccc;
        }
        .modifier-tab {
            padding: 8px 12px;
            margin-right: 5px;
            border: none;
            background-color: #e9ecef;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-weight: bold;
        }
        .modifier-tab.active {
            background-color: #f1f1f1;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        .modifier-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 10px;
        }
        .modifier-card {
            background-color: var(--card-background);
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.85rem;
            line-height: 1.2;
            height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .modifier-card:hover {
            background-color: #e9ecef;
        }
        .modifier-card.finished {
             opacity: 0.5;
             cursor: not-allowed;
             background-color: #f0f0f0;
        }
        .mod-price {
            font-size: 0.75rem;
            color: #555;
        }

        /* Sezione Ordini */
        .orders-view {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        .order-card {
            background-color: var(--card-background);
            border-left: 5px solid #007bff;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        .order-card.urgent {
            border-left-color: var(--primary-color);
            animation: pulse-red 1s infinite alternate;
        }
        .order-card.near {
            border-left-color: var(--secondary-color);
        }
        @keyframes pulse-red {
            from { box-shadow: 0 0 10px rgba(227, 27, 35, 0.5); }
            to { box-shadow: 0 0 15px rgba(227, 27, 35, 1); }
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .order-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        .order-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            font-size: 0.9rem;
        }
        .status-Ricevuto { background-color: #007bff; }
        .status-In\ Preparazione { background-color: #ffc107; color: #333; }
        .status-Pronto { background-color: #28a745; }
        .status-In\ Consegna { background-color: #6c757d; }
        .status-Archivia { background-color: var(--primary-color); }
        
        .order-details {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        .order-items {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .order-items li {
            padding: 3px 0;
            border-bottom: 1px dotted #ccc;
        }
        .order-items li:last-child {
            border-bottom: none;
        }
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .order-total {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .order-actions button {
            padding: 8px 12px;
            margin-left: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-advance {
            background-color: #28a745;
            color: white;
        }
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        .btn-print {
            background-color: #6c757d;
            color: white;
        }
        .btn-share {
            background-color: #008000;
            color: white;
        }
        
        /* Filtri Ordini */
        .order-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 20px;
            flex-shrink: 0;
        }
        .order-filters input, .order-filters select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex-grow: 1;
        }
        .date-filter-tabs {
            display: flex;
            flex-grow: 1;
        }
        .date-filter-tab {
            padding: 8px 12px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            background-color: #e9ecef;
            border: 1px solid #ccc;
            margin: 0 -1px 0 0;
        }
        .date-filter-tab:first-child { border-radius: 5px 0 0 5px; }
        .date-filter-tab:last-child { border-radius: 0 5px 5px 0; margin-right: 0;}
        .date-filter-tab.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            z-index: 1;
        }
        
        /* Modale */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-content h2 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .modal-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .modal-form label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .modal-form input, .modal-form select, .modal-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .modal-form .full-width {
            grid-column: 1 / -1;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Modalità Selezione */
        .mode-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }
        .mode-btn {
            flex-grow: 1;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .mode-btn.active {
            border-color: var(--primary-color);
            background-color: #fce4e4;
            font-weight: bold;
        }

        /* Capacity Warning */
        .capacity-warning {
            grid-column: 1 / -1;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }
        .capacity-warning.full {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .capacity-warning.high {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .acconto-info {
            font-weight: bold;
            grid-column: 1 / -1;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .resto-info {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .paga-esatto-info {
             background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .customer-suggestions {
            position: absolute;
            z-index: 1001;
            background-color: white;
            border: 1px solid #ccc;
            width: calc(50% - 7.5px);
            max-height: 150px;
            overflow-y: auto;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .suggestion-item:hover {
            background-color: #f1f1f1;
        }

        /* Modale Composizione */
        .meter-modal-content, .half-pizza-modal-content {
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .meter-composition-area, .half-pizza-composition-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section-box {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .section-box h4 {
            margin-top: 0;
            color: #007bff;
        }
        .gusto-selector input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        .gusto-suggestions {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid #eee;
            background-color: white;
            margin-bottom: 10px;
        }
        .gusto-suggestions div {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .gusto-suggestions div:hover {
            background-color: #e9ecef;
        }
        .section-mods-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        .section-mods-list li {
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .modal-modifier-panel {
            grid-column: 1 / -1;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        .modal-modifier-panel h4 {
            margin-bottom: 10px;
        }

        /* Sezione Storico */
        .history-view {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        .history-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-shrink: 0;
        }
        .history-controls input, .history-controls select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .daily-summary {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .archive-card {
            border-left-color: #6f42c1;
        }

        /* Sezione Impostazioni */
        .settings-view {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            gap: 20px;
        }
        .settings-menu {
            width: 250px;
            flex-shrink: 0;
        }
        .settings-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }
        .settings-menu-item:hover {
            background-color: #e9ecef;
        }
        .settings-menu-item.active {
            border-left-color: var(--primary-color);
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .settings-panel {
            flex-grow: 1;
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            max-width: calc(100% - 270px);
        }
        .settings-panel h3 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
            color: #333;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .setting-card {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .setting-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .setting-card button {
            background: none;
            border: none;
            cursor: pointer;
            color: #dc3545;
            font-size: 1rem;
        }
        .setting-item-list {
            max-height: 300px;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .setting-item-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
            font-size: 0.9rem;
        }
        .setting-item-list li:last-child {
            border-bottom: none;
        }
        .setting-item-actions button {
            margin-left: 5px;
            color: #17a2b8;
        }
        .finished-item {
            opacity: 0.5;
            text-decoration: line-through;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }
        .form-row input, .form-row select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .form-row button {
            flex-shrink: 0;
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .form-group {
            flex-grow: 1;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .pin-settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .pin-settings-grid .form-row {
            grid-column: 1 / -1;
        }
        .pin-settings-grid button {
            width: 100%;
        }

        /* Stampa */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area {
                visibility: visible;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: monospace;
                font-size: 12px;
                line-height: 1.4;
            }
            /* Stile per Comanda */
            #print-content-comanda h1, #print-content-comanda h2, #print-content-comanda p, #print-content-comanda ul {
                visibility: visible;
                margin: 5px 0;
            }
            #print-content-comanda .mod-list {
                margin-left: 10px;
                list-style: none;
                padding-left: 0;
            }
            /* Stile per Scontrino (più stretto) */
            #print-content-scontrino {
                width: 80mm;
                max-width: 80mm;
                margin: 0 auto;
            }
            #print-content-scontrino * {
                visibility: visible;
            }
            #print-content-scontrino table {
                width: 100%;
                border-collapse: collapse;
                margin: 5px 0;
            }
            #print-content-scontrino th, #print-content-scontrino td {
                padding: 2px 0;
            }
            #print-content-scontrino .total-row td {
                font-weight: bold;
                border-top: 1px dashed #000;
                padding-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="view === 'accesso'" class="access-screen">
            <div class="access-card">
                <h1>Pizzeria Smart POS</h1>
                <p>Inserisci il tuo codice di accesso:</p>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="PIN Operatore/Proprietario">
                <button @click="grantAccess">Accedi</button>
            </div>
        </div>

        <template v-if="view !== 'accesso'">
            <div class="sidebar">
                <div 
                    class="sidebar-item" 
                    :class="{ active: view === 'inserimento' }" 
                    @click="view = 'inserimento'"
                    title="Nuovo Ordine"
                >
                    <i class="fas fa-cash-register"></i>
                    <span>Cassa</span>
                </div>
                <div 
                    class="sidebar-item" 
                    :class="{ active: view === 'ordini' }" 
                    @click="view = 'ordini'"
                    title="Ordini Attivi"
                >
                    <i class="fas fa-clipboard-list"></i>
                    <span>Ordini</span>
                </div>
                <div 
                    class="sidebar-item" 
                    :class="{ active: view === 'storico' }" 
                    @click="view = 'storico'"
                    title="Storico e Riepilogo"
                    v-if="canAccessRiepilogo"
                >
                    <i class="fas fa-archive"></i>
                    <span>Storico</span>
                </div>
                <div 
                    class="sidebar-item" 
                    :class="{ active: view === 'impostazioni' }" 
                    @click="view = 'impostazioni'"
                    title="Impostazioni"
                    v-if="canAccessImpostazioni"
                >
                    <i class="fas fa-cogs"></i>
                    <span>Settings</span>
                </div>
                <div 
                    class="sidebar-item" 
                    @click="userRole = 'guest'; view = 'accesso'; localStorage.removeItem('pz_user_role');"
                    title="Esci"
                >
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>

            <div class="main-content">
                <div v-if="view === 'inserimento'" class="pos-container">
                    
                    <div class="menu-panel">
                        <input 
                            type="text" 
                            v-model="searchTerm" 
                            placeholder="Cerca prodotto..." 
                            style="padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;"
                        >
                        
                        <div class="category-tabs">
                            <button 
                                v-for="cat in Object.keys(menu)" 
                                :key="cat" 
                                class="category-tab" 
                                :class="{ active: activeCat === cat }"
                                @click="activeCat = cat; searchTerm = ''"
                            >
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="item-grid">
                            <template v-if="searchTerm">
                                <div 
                                    v-for="item in filteredAvailableItems" 
                                    :key="item.nome" 
                                    class="item-card"
                                    :class="{ highlighted: lastSelectedItem && lastSelectedItem.nome === item.nome, 'special-item': item.isHalfPizza || item.isMeter, finished: item.isFinished }"
                                    @click="!item.isFinished && handleItemClick(item)"
                                    :title="item.isFinished ? 'Articolo Finito' : ''"
                                >
                                    <span class="item-card-name">{{ item.nome }}</span>
                                    <span class="item-card-price" v-if="item.prezzo > 0">€{{ item.prezzo.toFixed(2) }}</span>
                                </div>
                            </template>
                            <template v-else>
                                <div 
                                    v-for="(item, index) in filteredAvailableItems" 
                                    :key="index" 
                                    class="item-card"
                                    :class="{ highlighted: lastSelectedItem && lastSelectedItem.nome === item.nome, 'special-item': item.isHalfPizza || item.isMeter, finished: item.isFinished }"
                                    @click="!item.isFinished && handleItemClick(item)"
                                    :title="item.isFinished ? 'Articolo Finito' : ''"
                                >
                                    <span class="item-card-name">{{ item.nome }}</span>
                                    <span class="item-card-price" v-if="item.prezzo > 0">€{{ item.prezzo.toFixed(2) }}</span>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="modifier-panel">
                        <h4>Modificatori <span v-if="selectedItemIndex !== null">per: {{ order[selectedItemIndex].nome }}</span></h4>
                         <input 
                            type="text" 
                            v-model="modifierSearchTerm" 
                            placeholder="Cerca modificatore..." 
                            style="padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px;"
                        >
                        
                        <div class="modifier-tabs">
                            <button 
                                v-for="cat in Object.keys(modifiers)" 
                                :key="cat" 
                                class="modifier-tab" 
                                :class="{ active: activeModCat === cat }"
                                @click="activeModCat = cat; modifierSearchTerm = ''"
                            >
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="modifier-grid">
                            <div 
                                v-for="(mod, index) in filteredModifiersForActiveCat" 
                                :key="index" 
                                class="modifier-card"
                                :class="{ finished: mod.isFinished }"
                                @click="!mod.isFinished && addExtra(mod)"
                                :title="mod.isFinished ? 'Modificatore Finito' : ''"
                            >
                                <span>{{ mod.nome }}</span>
                                <span class="mod-price" v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="cart-panel">
                        <h4>Carrello ({{ order.length }} articoli)</h4>
                        <div class="cart-list">
                            <div 
                                v-for="(item, index) in order" 
                                :key="index" 
                                class="cart-item"
                                :class="{ selected: selectedItemIndex === index }"
                                @click="selectItem(index)"
                            >
                                <div class="cart-item-header">
                                    <span>{{ item.nome }} 
                                        <span v-if="item.isHalfPizza" style="font-size:0.8em; font-weight:normal;">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                                        <span v-if="item.isMeter" style="font-size:0.8em; font-weight:normal;">({{ item.sections.map(s => s.gusto).join(' | ') }})</span>
                                    </span>
                                    <span>€{{ calculateItemTotal(item).toFixed(2) }}</span>
                                </div>
                                
                                <ul v-if="item.modifiers && !item.isHalfPizza && !item.isMeter" class="cart-item-mods">
                                    <li v-for="(mod, modIndex) in item.modifiers" :key="'mod'+modIndex">
                                        <span><span class="mod-icon">{{ getModifierIcon(mod.category) }}</span>{{ mod.nome }} 
                                            <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                        </span>
                                        <button class="remove-mod-btn" @click.stop="item.modifiers.splice(modIndex, 1); saveData()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </li>
                                </ul>

                                <div v-if="item.isHalfPizza">
                                    <ul class="cart-item-mods">
                                        <li style="font-weight: bold; margin-top: 5px;">Metà 1: {{ item.gusto1 }}</li>
                                        <li v-for="(mod, modIndex) in item.modifiers1" :key="'mod1'+modIndex">
                                            <span><span class="mod-icon">{{ getModifierIcon(mod.category) }}</span>{{ mod.nome }} 
                                                <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                            </span>
                                            <button class="remove-mod-btn" @click.stop="removeHalfPizzaModifier(1, modIndex)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </li>
                                    </ul>
                                    <ul class="cart-item-mods">
                                        <li style="font-weight: bold; margin-top: 5px;">Metà 2: {{ item.gusto2 }}</li>
                                        <li v-for="(mod, modIndex) in item.modifiers2" :key="'mod2'+modIndex">
                                            <span><span class="mod-icon">{{ getModifierIcon(mod.category) }}</span>{{ mod.nome }} 
                                                <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                            </span>
                                            <button class="remove-mod-btn" @click.stop="removeHalfPizzaModifier(2, modIndex)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div v-if="item.isMeter">
                                    <div v-for="(section, secIndex) in item.sections" :key="'sec'+secIndex">
                                        <ul class="cart-item-mods">
                                            <li style="font-weight: bold; margin-top: 5px;">{{ section.name }}: {{ section.gusto }}</li>
                                            <li v-for="(mod, modIndex) in section.modifiers" :key="'mod'+secIndex+modIndex">
                                                <span><span class="mod-icon">{{ getModifierIcon(mod.category) }}</span>{{ mod.nome }} 
                                                    <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                                </span>
                                                <button class="remove-mod-btn" @click.stop="removeMeterModifier(secIndex, modIndex)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="item-actions" v-if="selectedItemIndex === index" style="display: flex; justify-content: flex-end; gap: 5px; margin-top: 5px;">
                                    <button class="btn-secondary" @click.stop="openPriceEditModal(index)" style="padding: 3px 8px; font-size: 0.8rem; background-color: #f0ad4e;">Prezzo</button>
                                    <button class="btn-secondary" @click.stop="startHalfPizzaComposition(item, index)" v-if="item.isHalfPizza" style="padding: 3px 8px; font-size: 0.8rem; background-color: #5bc0de;">Modifica Metà</button>
                                    <button class="btn-secondary" @click.stop="startMeterComposition(item, index)" v-if="item.isMeter" style="padding: 3px 8px; font-size: 0.8rem; background-color: #5bc0de;">Modifica Metro</button>
                                    <button class="btn-secondary" @click.stop="removeItem(index)" style="padding: 3px 8px; font-size: 0.8rem; background-color: #dc3545;">Rimuovi</button>
                                </div>
                            </div>
                        </div>

                        <div class="cart-total">
                            <span>TOTALE:</span>
                            <span>€{{ total.toFixed(2) }}</span>
                        </div>
                        
                        <button class="finish-button" @click="openModal">
                            <i class="fas fa-check-circle"></i> {{ editingOrderId !== null ? 'Modifica Ordine #' + editingOrderId : 'Finalizza Ordine' }}
                        </button>
                        <button v-if="editingOrderId !== null" class="finish-button" @click="cancelEdit" style="background-color: #6c757d; margin-top: 5px;">
                            Annulla Modifica
                        </button>
                    </div>
                </div>

                <div v-if="view === 'ordini'" class="main-content">
                    <div class="order-filters">
                        <div class="date-filter-tabs">
                            <div class="date-filter-tab" :class="{ active: activeDateFilter === 'today' }" @click="activeDateFilter = 'today'">Oggi</div>
                            <div class="date-filter-tab" :class="{ active: activeDateFilter === 'tomorrow' }" @click="activeDateFilter = 'tomorrow'">Domani</div>
                            <div class="date-filter-tab" :class="{ active: activeDateFilter === 'future' }" @click="activeDateFilter = 'future'">Futuri</div>
                        </div>
                        <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca Cliente/Indirizzo/Tavolo..." style="max-width: 300px;">
                    </div>
                    
                    <div class="orders-view">
                        <div v-if="filteredActiveOrders.length === 0" class="text-center p-4 text-muted">Nessun ordine attivo per questo filtro.</div>
                        
                        <div 
                            v-for="order in filteredActiveOrders" 
                            :key="order.id" 
                            class="order-card"
                            :class="{ urgent: isUrgent(order), near: isNear(order) }"
                        >
                            <div class="order-header">
                                <h3>#{{ order.id }} - {{ order.customer || order.tableNumber || order.mode }}</h3>
                                <div class="order-status" :class="'status-' + order.status.replace(/ /g, '\\ ')" :title="`Creato il: ${new Date(order.creationTime).toLocaleString()}`">
                                    {{ order.status }}
                                </div>
                            </div>
                            
                            <div class="order-details">
                                <p><strong>Modo:</strong> {{ order.mode.toUpperCase() }} | <strong>Orario:</strong> {{ order.hour }} ({{ formatDate(order.date) }})</p>
                                <p v-if="order.mode === 'consegna'"><strong>Indirizzo:</strong> {{ order.address }} ({{ order.zone }}) | <strong>Tel:</strong> {{ order.phone }}</p>
                                <p v-if="order.mode === 'banco'"><strong>Tavolo/Ref:</strong> {{ order.tableNumber || 'N/D' }}</p>
                                <p v-if="order.notes"><strong>Note:</strong> {{ order.notes }}</p>
                                <p v-if="order.mode === 'consegna'">
                                    <strong>Fattorino:</strong> 
                                    <select :value="order.driver" @change="updateActiveOrderDriver(order.id, $event.target.value)" style="padding: 3px; border-radius: 3px;">
                                        <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                                    </select>
                                </p>
                            </div>
                            
                            <ul class="order-items">
                                <li v-for="(item, index) in order.items" :key="index">
                                    <span>1x {{ item.nome }} 
                                        <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                                        <span v-if="item.isMeter">({{ item.sections.map(s => s.gusto).join(' | ') }})</span>
                                    </span>
                                    <span style="float: right;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                                </li>
                            </ul>
                            
                            <div class="order-footer">
                                <span class="order-total">TOTALE: €{{ order.total.toFixed(2) }}</span>
                                <div class="order-actions">
                                    <button class="btn-print" @click="printOrder(order.id, 'comanda')" title="Stampa Comanda"><i class="fas fa-print"></i> Comanda</button>
                                    <button class="btn-print" @click="printOrder(order.id, 'scontrino')" title="Stampa Scontrino"><i class="fas fa-receipt"></i> Scontrino</button>
                                    <button class="btn-share" @click="showShareMenu(order.id)" v-if="order.phone" title="Condividi su WhatsApp"><i class="fab fa-whatsapp"></i></button>
                                    <button class="btn-edit" @click="editOrder(order.id)" title="Modifica Ordine"><i class="fas fa-edit"></i></button>
                                    <button class="btn-advance" @click="advance(order)" :class="'status-' + getNextStatus(order.status).replace(/ /g, '\\ ')" :title="`Avanza a: ${getNextStatus(order.status)}`">
                                        <i class="fas fa-arrow-right"></i> {{ getNextStatus(order.status) === 'Archivia' ? 'Completa' : getNextStatus(order.status) }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'storico'" class="history-view">
                    <h2>Storico Ordini e Riepilogo Giornaliero</h2>
                    <div class="history-controls">
                        <label for="archiveDateFilter">Seleziona Data:</label>
                        <input type="date" id="archiveDateFilter" v-model="archiveDateFilter" :max="getTodayDateString()">
                        <label for="driverFilter">Filtra Fattorino:</label>
                        <select id="driverFilter" v-model="selectedDriver" @change="calculateDriverStats">
                            <option value="">Tutti i Fattorini</option>
                            <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                    
                    <div class="daily-summary">
                        Riepilogo del {{ archiveDateFilterDisplay }}: 
                        Incasso Totale: **€{{ dailyTotal.toFixed(2) }}** | 
                        Ordini Totali (Consegna) <span v-if="selectedDriver">: {{ selectedDriver }}</span>: **{{ driverStats.totalOrders }}** | 
                        Incasso Cons. <span v-if="selectedDriver">: {{ selectedDriver }}</span>: **€{{ driverStats.totalRevenue.toFixed(2) }}**
                    </div>

                    <div v-if="filteredArchive.length === 0" class="text-center p-4 text-muted">Nessun ordine archiviato per il {{ archiveDateFilterDisplay }} <span v-if="selectedDriver">e per il fattorino {{ selectedDriver }}</span>.</div>
                    
                    <div 
                        v-for="order in filteredArchive" 
                        :key="order.id" 
                        class="order-card archive-card"
                    >
                        <div class="order-header">
                            <h3>#{{ order.id }} - {{ order.customer || order.tableNumber || order.mode }}</h3>
                            <div class="order-status" style="background-color: #6f42c1; color: white;">Archiviato</div>
                        </div>
                        
                        <div class="order-details">
                            <p><strong>Modo:</strong> {{ order.mode.toUpperCase() }} | <strong>Ora Chiusura:</strong> {{ new Date(order.archivedTime).toLocaleTimeString() }}</p>
                            <p v-if="order.mode === 'consegna'"><strong>Indirizzo:</strong> {{ order.address }} ({{ order.zone }})</p>
                            <p v-if="order.mode === 'consegna'">
                                <strong>Fattorino:</strong> 
                                <select :value="order.driver" @change="updateArchiveDriver(order.id, $event.target.value)" style="padding: 3px; border-radius: 3px;">
                                    <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                                </select>
                            </p>
                        </div>
                        
                        <ul class="order-items">
                            <li v-for="(item, index) in order.items" :key="index">
                                <span>1x {{ item.nome }}</span>
                                <span style="float: right;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                            </li>
                        </ul>
                        
                        <div class="order-footer">
                            <span class="order-total">TOTALE: €{{ order.total.toFixed(2) }}</span>
                            <div class="order-actions">
                                <button class="btn-print" @click="printOrder(order.id, 'comanda')" title="Stampa Comanda" style="background-color: #6c757d;"><i class="fas fa-print"></i> Comanda</button>
                                <button class="btn-print" @click="printOrder(order.id, 'scontrino')" title="Stampa Scontrino" style="background-color: #6c757d;"><i class="fas fa-receipt"></i> Scontrino</button>
                                <button class="btn-edit" @click="duplicateOrder(order)" title="Duplica in Nuovo Ordine" style="background-color: #17a2b8;"><i class="fas fa-copy"></i> Duplica</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'impostazioni'" class="settings-view">
                    <div class="settings-menu">
                        <div class="settings-menu-item" :class="{ active: activeSettingsCat === 'Menu' }" @click="activeSettingsCat = 'Menu'">Gestione Menu</div>
                        <div class="settings-menu-item" :class="{ active: activeSettingsCat === 'Modificatori' }" @click="activeSettingsCat = 'Modificatori'">Gestione Modificatori</div>
                        <div class="settings-menu-item" :class="{ active: activeSettingsCat === 'ZoneFattorini' }" @click="activeSettingsCat = 'ZoneFattorini'">Zone & Fattorini</div>
                        <div class="settings-menu-item" :class="{ active: activeSettingsCat === 'Capacita' }" @click="activeSettingsCat = 'Capacita'">Capacità Oraria</div>
                        <div class="settings-menu-item" :class="{ active: activeSettingsCat === 'Account' }" @click="activeSettingsCat = 'Account'">Account & Dati</div>
                    </div>

                    <div class="settings-panel">
                        <div v-if="activeSettingsCat === 'Menu'">
                            <h3>Gestione Menu e Articoli</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nuova Categoria</label>
                                    <input type="text" v-model="newCategoryName" placeholder="Es: Antipasti">
                                </div>
                                <button @click="addCategory"><i class="fas fa-plus"></i> Aggiungi Categoria</button>
                            </div>

                            <div class="category-tabs" style="margin-top: 20px;">
                                <button 
                                    v-for="cat in Object.keys(menu)" 
                                    :key="cat" 
                                    class="category-tab" 
                                    :class="{ active: activeSettingsCat === cat }"
                                    @click="activeSettingsCat = cat"
                                >
                                    {{ cat }}
                                </button>
                            </div>
                            
                            <div v-if="menu[activeSettingsCat] && activeSettingsCat !== 'Menu'" style="margin-top: 20px;">
                                <h4>Articoli in "{{ activeSettingsCat }}" 
                                    <button @click="deleteCategory(activeSettingsCat)" v-if="activeSettingsCat !== 'Pizze'" style="color: #dc3545;"><i class="fas fa-trash"></i> Elimina Categoria</button>
                                </h4>

                                <div class="form-row">
                                    <div class="form-group"><label>Nome Articolo</label><input type="text" v-model="newItemName" placeholder="Es: Focaccia"></div>
                                    <div class="form-group" style="max-width: 100px;"><label>Prezzo (€)</label><input type="number" v-model="newItemPrice" min="0" step="0.5"></div>
                                    <button @click="addItemToCategory" style="margin-top: 5px;"><i class="fas fa-plus"></i> Aggiungi</button>
                                </div>

                                <ul class="setting-item-list">
                                    <li v-for="(item, index) in menu[activeSettingsCat]" :key="index" :class="{ 'finished-item': item.isFinished }">
                                        <span>{{ item.nome }} ({{ item.prezzo.toFixed(2) }}€)</span>
                                        <div class="setting-item-actions">
                                            <button @click="toggleItemFinished(activeSettingsCat, index)" :title="item.isFinished ? 'Marca come Disponibile' : 'Marca come Finito'">
                                                <i :class="item.isFinished ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                            </button>
                                            <button @click="deleteItem(activeSettingsCat, index)" style="color: #dc3545;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div v-if="activeSettingsCat === 'Modificatori'">
                            <h3>Gestione Modificatori</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nuova Categoria Modificatori</label>
                                    <input type="text" v-model="newModifierCategoryName" placeholder="Es: Formaggi Extra">
                                </div>
                                <button @click="addModifierCategory"><i class="fas fa-plus"></i> Aggiungi Categoria</button>
                            </div>
                            
                            <div class="modifier-tabs" style="margin-top: 20px;">
                                <button 
                                    v-for="cat in Object.keys(modifiers)" 
                                    :key="cat" 
                                    class="modifier-tab" 
                                    :class="{ active: activeSettingsModCat === cat }"
                                    @click="activeSettingsModCat = cat"
                                >
                                    {{ cat }}
                                </button>
                            </div>

                            <div v-if="modifiers[activeSettingsModCat]" style="margin-top: 20px;">
                                <h4>Modificatori in "{{ activeSettingsModCat }}" 
                                    <button @click="deleteModifierCategory(activeSettingsModCat)" v-if="!isDefaultModifierCategory(activeSettingsModCat)" style="color: #dc3545;"><i class="fas fa-trash"></i> Elimina Categoria</button>
                                </h4>

                                <div class="form-row">
                                    <div class="form-group"><label>Nome Modificatore</label><input type="text" v-model="newModifierName" placeholder="Es: Peperoni"></div>
                                    <div class="form-group" style="max-width: 100px;"><label>Costo (€)</label><input type="number" v-model="newModifierPrice" min="0" step="0.5"></div>
                                    <button @click="addModifierToCategory" style="margin-top: 5px;"><i class="fas fa-plus"></i> Aggiungi</button>
                                </div>

                                <ul class="setting-item-list">
                                    <li v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" :class="{ 'finished-item': mod.isFinished }">
                                        <span>{{ mod.nome }} (+{{ mod.prezzo.toFixed(2) }}€)</span>
                                        <div class="setting-item-actions">
                                            <button @click="toggleModifierFinished(activeSettingsModCat, index)" :title="mod.isFinished ? 'Marca come Disponibile' : 'Marca come Finito'">
                                                <i :class="mod.isFinished ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i>
                                            </button>
                                            <button @click="deleteModifier(activeSettingsModCat, index)" style="color: #dc3545;"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div v-if="activeSettingsCat === 'ZoneFattorini'">
                            <h3>Gestione Zone di Consegna e Fattorini</h3>
                            
                            <h4>Zone di Consegna</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Nome Zona</label><input type="text" v-model="newZoneName" placeholder="Es: Centro Storico"></div>
                                <div class="form-group" style="max-width: 100px;"><label>Costo Cons. (€)</label><input type="number" v-model="newZonePrice" min="0" step="0.5"></div>
                                <button @click="addZone"><i class="fas fa-plus"></i> Aggiungi Zona</button>
                            </div>
                            <ul class="setting-item-list">
                                <li v-for="(zone, index) in deliveryZones" :key="index">
                                    <span>{{ zone.name }} (Costo: {{ zone.price.toFixed(2) }}€)</span>
                                    <div class="setting-item-actions">
                                        <button @click="deleteZone(index)" style="color: #dc3545;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </li>
                            </ul>

                            <h4 style="margin-top: 20px;">Fattorini</h4>
                            <div class="form-row">
                                <div class="form-group"><label>Nome Fattorino</label><input type="text" v-model="newDriverName" placeholder="Es: Giovanni"></div>
                                <button @click="addDriver"><i class="fas fa-plus"></i> Aggiungi Fattorino</button>
                            </div>
                            <ul class="setting-item-list">
                                <li v-for="(driver, index) in drivers" :key="index">
                                    <span>{{ driver }}</span>
                                    <div class="setting-item-actions">
                                        <button @click="deleteDriver(index)" style="color: #dc3545;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        
                        <div v-if="activeSettingsCat === 'Capacita'">
                            <h3>Gestione Capacità Oraria</h3>
                            <div class="modal-form" style="grid-template-columns: 1fr;">
                                <div class="form-group">
                                    <label>Pizze Massime per Intervallo di Tempo:</label>
                                    <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" step="1">
                                    <small class="text-muted">Il numero massimo di pizze (incluse Metà e Mezzo Metro) che la pizzeria può produrre in un intervallo di tempo.</small>
                                </div>
                                <div class="form-group">
                                    <label>Durata Intervallo (minuti):</label>
                                    <select v-model.number="capacitySettings.intervalMinutes">
                                        <option :value="15">15 minuti</option>
                                        <option :value="20">20 minuti</option>
                                        <option :value="30">30 minuti</option>
                                        <option :value="60">60 minuti</option>
                                    </select>
                                    <small class="text-muted">L'intervallo su cui viene calcolata la capacità.</small>
                                </div>
                            </div>
                            <p class="text-muted" style="margin-top: 15px;">**Nota:** Queste impostazioni influenzano l'avviso di capacità nella modale di finalizzazione ordine.</p>
                        </div>

                        <div v-if="activeSettingsCat === 'Account'">
                            <h3>Gestione Account e Dati</h3>
                            
                            <h4 style="margin-top: 20px;">Modifica PIN</h4>
                            <div class="pin-settings-grid">
                                <div class="form-row">
                                    <div class="form-group"><label>Nuovo PIN Operatore (Attuale: {{ adminPin }})</label><input type="password" v-model="newAdminPin" placeholder="Minimo 4 cifre"></div>
                                    <button @click="saveAdminPin">Salva PIN Operatore</button>
                                </div>
                                <div class="form-row">
                                    <div class="form-group"><label>Nuovo PIN Proprietario (Attuale: {{ ownerPin }})</label><input type="password" v-model="newOwnerPin" placeholder="Minimo 4 cifre"></div>
                                    <button @click="saveOwnerPin">Salva PIN Proprietario</button>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 20px;">Gestione Dati</h4>
                            <div class="form-row" style="gap: 20px; flex-wrap: wrap;">
                                <button @click="exportData" style="background-color: #007bff;"><i class="fas fa-download"></i> Esporta Dati</button>
                                <button @click="importData" style="background-color: #6c757d;"><i class="fas fa-upload"></i> Importa Dati</button>
                                <button @click="clearCache" style="background-color: #dc3545;"><i class="fas fa-trash-alt"></i> Pulisci Cache (Ordini e Storico)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <div v-if="showModal" class="modal-overlay">
            <div class="modal-content">
                <h2>{{ editingOrderId !== null ? 'Modifica Ordine #' + editingOrderId : 'Finalizza Nuovo Ordine' }} (Totale: €{{ calculatedOrderTotal.toFixed(2) }})</h2>
                
                <div class="modal-form">
                    
                    <div class="mode-selection">
                        <div 
                            v-for="m in modes" 
                            :key="m.id" 
                            class="mode-btn" 
                            :class="{ active: mode === m.id }" 
                            @click="selectMode(m.id)"
                        >
                            <i :class="m.icon"></i> {{ m.label }}
                        </div>
                    </div>
                    
                    <div v-if="isCapacityFull" class="capacity-warning full">
                        ATTENZIONE: Capacità oraria massima raggiunta/superata ({{ orderCapacity.total }} pizze). Suggerimento Prossima Ora: {{ orderCapacity.nextInterval }}
                    </div>
                    <div v-else-if="isCapacityWarning" class="capacity-warning high">
                        AVVISO: Capacità oraria in esaurimento ({{ orderCapacity.total }} pizze).
                    </div>

                    <div class="form-group">
                        <label>Data Ritiro/Consegna</label>
                        <input type="date" v-model="date" :min="minDate" @change="updateCapacityWarning">
                    </div>
                    <div class="form-group">
                        <label>Ora Ritiro/Consegna</label>
                        <input type="time" v-model="hour" @change="updateCapacityWarning">
                    </div>

                    <div class="form-group" style="position: relative;" v-if="mode === 'asporto' || mode === 'consegna'">
                        <label>Nome Cliente</label>
                        <input type="text" v-model="customer" placeholder="Nome" @input="filterCustomers">
                        <div v-if="customer.length >= 2 && filteredCustomerSuggestions.length > 0" class="customer-suggestions" :style="{ top: 'calc(100% - 5px)' }">
                            <div v-for="c in filteredCustomerSuggestions" :key="c.phone" class="suggestion-item" @click="loadCustomerData(c)">
                                {{ c.customer }} ({{ c.phone }}) <span v-if="c.address"> - {{ c.address }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" v-if="mode === 'asporto' || mode === 'consegna'">
                        <label>Telefono</label>
                        <input type="text" v-model="phone" placeholder="Telefono (per WhatsApp)">
                    </div>

                    <div class="form-group" v-if="mode === 'banco'">
                        <label>Tavolo / Rif. Ordine (Opzionale)</label>
                        <input type="text" v-model="tableNumber" placeholder="Es: Tavolo 5">
                    </div>
                    
                    <div class="form-group" v-if="mode === 'consegna'">
                        <label>Indirizzo (Via)</label>
                        <input type="text" v-model="address" placeholder="Via">
                    </div>
                    <div class="form-group" v-if="mode === 'consegna'">
                        <label>Numero Civico</label>
                        <input type="text" v-model="streetNumber" placeholder="Civico">
                    </div>
                    <div class="form-group" v-if="mode === 'consegna'">
                        <label>Città/Frazione</label>
                        <input type="text" v-model="town" placeholder="Città">
                    </div>

                    <div class="form-group" v-if="mode === 'consegna'">
                        <label>Zona di Consegna (Costo: €{{ deliveryCost.toFixed(2) }})</label>
                        <select v-model="zoneName" @change="updateDeliveryCost">
                            <option value="">Seleziona Zona</option>
                            <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">{{ zone.name }} (+€{{ zone.price.toFixed(2) }})</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label>Note (Allergie, Specifiche, ecc.)</label>
                        <textarea v-model="notes" rows="2" placeholder="Note per la cucina o il fattorino"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label>Acconto Ricevuto (€)</label>
                        <input type="number" v-model.number="accontoRicevuto" min="0" :placeholder="calculatedOrderTotal.toFixed(2)">
                    </div>
                    
                    <div v-if="accontoRicevuto > 0" class="acconto-info full-width" :class="{ 'resto-info': restoDaDare > 0, 'paga-esatto-info': restoDaDare === 0 }">
                        <span v-if="restoDaDare > 0">RESTO DA DARE: €{{ restoDaDare.toFixed(2) }}</span>
                        <span v-else-if="restoDaDare === 0">Pagamento esatto!</span>
                        <span v-else>ATTENZIONE: Pagamento inferiore al totale!</span>
                    </div>

                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" @click="showModal = false">Annulla</button>
                    <button class="btn-primary" @click="confermaOrdine" :disabled="mode === 'consegna' && !zoneName && deliveryZones.length > 0">
                        <i class="fas fa-save"></i> Salva Ordine (€{{ calculatedOrderTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>
        
        <div v-if="showMeterModal" class="modal-overlay">
            <div class="modal-content meter-modal-content">
                <h2>Componi {{ tempMeterItem.nome }} (Totale Est.: €{{ calculateTempMeterTotal.toFixed(2) }})</h2>

                <div class="meter-composition-area">
                    <div v-for="(section, secIndex) in tempMeterItem.sections" :key="secIndex" class="section-box">
                        <h4>{{ section.name }}</h4>
                        
                        <div class="gusto-selector">
                            <label>Gusto Base:</label>
                            <input 
                                type="text" 
                                v-model="section.gusto" 
                                placeholder="Cerca pizza..." 
                                @focus="gustoSearchTerm = section.gusto" 
                                @input="gustoSearchTerm = section.gusto"
                            >
                            <div v-if="gustoSearchTerm === section.gusto && gustoSearchTerm.length > 0" class="gusto-suggestions">
                                <div 
                                    v-for="pizza in filteredPizzaGusti" 
                                    :key="pizza.nome" 
                                    @click="selectMeterGusto(secIndex, pizza.nome)"
                                >
                                    {{ pizza.nome }}
                                </div>
                            </div>
                        </div>

                        <h5 style="margin-top: 15px;">Modifiche ({{ section.modifiers.length }})</h5>
                        <ul class="section-mods-list">
                            <li v-for="(mod, modIndex) in section.modifiers" :key="'mod'+modIndex">
                                <span>{{ getModifierIcon(mod.category) }} {{ mod.nome }} 
                                    <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                </span>
                                <button class="remove-mod-btn" @click.stop="removeMeterModifier(secIndex, modIndex)" style="font-size: 1rem;"><i class="fas fa-times"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div class="modal-modifier-panel">
                        <h4>Aggiungi Modificatore alla Sezione Selezionata</h4>
                         <div class="modifier-tabs">
                            <button 
                                v-for="cat in Object.keys(modifiers)" 
                                :key="cat" 
                                class="modifier-tab" 
                                :class="{ active: tempModCat === cat }"
                                @click="tempModCat = cat; modifierSearchTerm = ''"
                            >
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="modifier-grid" style="max-height: 200px; overflow-y: auto;">
                            <div 
                                v-for="(mod, index) in filteredTempModifiers" 
                                :key="index" 
                                class="modifier-card"
                                @click="addMeterModifier(activeMeterSectionIndex, mod)"
                            >
                                <span>{{ mod.nome }}</span>
                                <span class="mod-price" v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" @click="cancelMeterComposition">Annulla</button>
                    <button class="btn-primary" @click="addMeterToOrder" :disabled="!isMeterValid">
                        <i class="fas fa-plus"></i> Aggiungi al Carrello (€{{ calculateTempMeterTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>
        
        <div v-if="showHalfPizzaModal" class="modal-overlay">
            <div class="modal-content meter-modal-content">
                <h2>Componi Pizza Metà (Totale Est.: €{{ calculateTempHalfPizzaTotal.toFixed(2) }})</h2>

                <div class="half-pizza-composition-area">
                    <div class="section-box">
                        <h4>Metà 1</h4>
                        
                        <div class="gusto-selector">
                            <label>Gusto Base:</label>
                            <input 
                                type="text" 
                                v-model="tempHalfPizzaItem.gusto1" 
                                placeholder="Cerca pizza..." 
                                @focus="gustoSearchTerm = tempHalfPizzaItem.gusto1" 
                                @input="gustoSearchTerm = tempHalfPizzaItem.gusto1"
                            >
                            <div v-if="gustoSearchTerm === tempHalfPizzaItem.gusto1 && gustoSearchTerm.length > 0" class="gusto-suggestions">
                                <div 
                                    v-for="pizza in filteredPizzaGusti" 
                                    :key="pizza.nome" 
                                    @click="selectHalfPizzaGusto(1, pizza.nome)"
                                >
                                    {{ pizza.nome }}
                                </div>
                            </div>
                        </div>

                        <h5 style="margin-top: 15px;">Modifiche ({{ tempHalfPizzaItem.modifiers1.length }})</h5>
                        <ul class="section-mods-list">
                            <li v-for="(mod, modIndex) in tempHalfPizzaItem.modifiers1" :key="'mod1'+modIndex">
                                <span>{{ getModifierIcon(mod.category) }} {{ mod.nome }} 
                                    <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                </span>
                                <button class="remove-mod-btn" @click.stop="removeHalfPizzaModifier(1, modIndex)" style="font-size: 1rem;"><i class="fas fa-times"></i></button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="section-box">
                        <h4>Metà 2</h4>
                        
                        <div class="gusto-selector">
                            <label>Gusto Base:</label>
                            <input 
                                type="text" 
                                v-model="tempHalfPizzaItem.gusto2" 
                                placeholder="Cerca pizza..." 
                                @focus="gustoSearchTerm = tempHalfPizzaItem.gusto2" 
                                @input="gustoSearchTerm = tempHalfPizzaItem.gusto2"
                            >
                            <div v-if="gustoSearchTerm === tempHalfPizzaItem.gusto2 && gustoSearchTerm.length > 0" class="gusto-suggestions">
                                <div 
                                    v-for="pizza in filteredPizzaGusti" 
                                    :key="pizza.nome" 
                                    @click="selectHalfPizzaGusto(2, pizza.nome)"
                                >
                                    {{ pizza.nome }}
                                </div>
                            </div>
                        </div>

                        <h5 style="margin-top: 15px;">Modifiche ({{ tempHalfPizzaItem.modifiers2.length }})</h5>
                        <ul class="section-mods-list">
                            <li v-for="(mod, modIndex) in tempHalfPizzaItem.modifiers2" :key="'mod2'+modIndex">
                                <span>{{ getModifierIcon(mod.category) }} {{ mod.nome }} 
                                    <span v-if="mod.prezzo > 0"> +€{{ mod.prezzo.toFixed(2) }}</span>
                                </span>
                                <button class="remove-mod-btn" @click.stop="removeHalfPizzaModifier(2, modIndex)" style="font-size: 1rem;"><i class="fas fa-times"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div class="modal-modifier-panel">
                        <h4>Aggiungi Modificatore alla Metà (1 o 2)</h4>
                        <div class="modifier-tabs">
                            <button 
                                v-for="cat in Object.keys(modifiers)" 
                                :key="cat" 
                                class="modifier-tab" 
                                :class="{ active: tempModCat === cat }"
                                @click="tempModCat = cat; modifierSearchTerm = ''"
                            >
                                {{ cat }}
                            </button>
                        </div>
                        
                        <div class="modifier-grid" style="max-height: 200px; overflow-y: auto;">
                            <div 
                                v-for="(mod, index) in filteredTempModifiers" 
                                :key="index" 
                                class="modifier-card"
                            >
                                <span>{{ mod.nome }}</span>
                                <span class="mod-price" v-if="mod.prezzo > 0">+€{{ mod.prezzo.toFixed(2) }}</span>
                                <div style="margin-top: 5px;">
                                    <button class="btn-primary" style="padding: 2px 5px; font-size: 0.8rem;" @click="addHalfPizzaModifier(1, mod)">Metà 1</button>
                                    <button class="btn-primary" style="padding: 2px 5px; font-size: 0.8rem; background-color: #007bff;" @click="addHalfPizzaModifier(2, mod)">Metà 2</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" @click="cancelHalfPizzaComposition">Annulla</button>
                    <button class="btn-primary" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid">
                        <i class="fas fa-plus"></i> Aggiungi al Carrello (€{{ calculateTempHalfPizzaTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showPriceEditModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Modifica Prezzo Articolo</h2>
                <p>Articolo: <strong>{{ order[tempPriceEditIndex]?.nome }}</strong></p>
                <div class="form-group full-width">
                    <label>Nuovo Prezzo (€)</label>
                    <input type="number" v-model.number="newPriceValue" min="0" step="0.01">
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" @click="showPriceEditModal = false; tempPriceEditIndex = null;">Annulla</button>
                    <button class="btn-primary" @click="saveNewPrice">Salva Prezzo</button>
                </div>
            </div>
        </div>
        
        <div v-if="showShareModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Condividi Riepilogo</h2>
                <p>Ordine #{{ selectedOrderForShare?.id }} per {{ selectedOrderForShare?.customer }}</p>
                <div class="modal-actions">
                    <button class="btn-secondary" @click="showShareModal = false">Chiudi</button>
                    <button class="btn-primary" @click="shareViaWhatsapp(selectedOrderForShare)">
                        <i class="fab fa-whatsapp"></i> Invia su WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <div id="print-content-comanda" class="print-area"></div>
        <div id="print-content-scontrino" class="print-area"></div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;

        const app = createApp({
            data() {
                return {
                    // --- Dati di Base e Stato Applicazione ---
                    view: 'accesso', // 'accesso', 'inserimento', 'ordini', 'storico', 'impostazioni'
                    userRole: 'guest', // 'guest', 'admin', 'owner'
                    accessPin: '',

                    // Dati PIN (Caricati da localStorage)
                    adminPin: '0000', 
                    ownerPin: '9999',
                    newAdminPin: '',
                    newOwnerPin: '',

                    // --- Menu e Modificatori (Dati di Default) ---
                    menu: {
                        'Pizze': [
                            { nome: 'Margherita', prezzo: 5.00 },
                            { nome: 'Diavola', prezzo: 7.50 },
                            { nome: 'Prosciutto', prezzo: 7.00 },
                            // Articolo base corretto per pizza metà (prezzo 0 perché il costo è dato dal gusto più caro)
                            { nome: 'Pizza Metà Base', prezzo: 0.00, isHalfPizza: true }, 
                        ],
                        'Mezzo Metro': [
                            // Articolo base corretto per Mezzo Metro
                            { nome: 'Mezzo Metro (2 Gusti)', prezzo: 12.00, isMeter: true, sections: [{name:"Metà A", size:0.5}, {name:"Metà B", size:0.5}] },
                            { nome: 'Schiacciata Grande', prezzo: 8.00, isMeter: true, sections: [{name:"Gusto Unico", size:1}] },
                        ],
                        'Bibite': [
                            { nome: 'Acqua Nat. 0.5L', prezzo: 1.50 },
                            { nome: 'Coca Cola 0.33L', prezzo: 2.50 },
                        ],
                        'Dolci': [
                            { nome: 'Tiramisù', prezzo: 4.00 }
                        ]
                    },
                    modifiers: {
                        'Più': [
                            { nome: 'Mozzarella', prezzo: 0.50 },
                            { nome: 'Prosciutto Cotto', prezzo: 1.00 },
                        ],
                        'Senza': [
                            { nome: 'Aglio', prezzo: 0.00 },
                            { nome: 'Cipolla', prezzo: 0.00 },
                        ],
                        'Poco': [
                            { nome: 'Sale', prezzo: 0.00 },
                        ],
                        'Abbondante': [
                            { nome: 'Olio', prezzo: 0.00 },
                        ]
                    },

                    // --- Gestione Ordine e Carrello ---
                    order: [], // Carrello dell'ordine corrente
                    selectedItemIndex: null,
                    lastSelectedItem: null,
                    
                    // Modifiche
                    activeCat: 'Pizze',
                    searchTerm: '',
                    activeModCat: 'Più',
                    modifierSearchTerm: '',
                    
                    // Modale Composizione Mezzo Metro
                    showMeterModal: false,
                    tempMeterItem: null,
                    gustoSearchTerm: '',
                    tempModCat: 'Più', // Categoria modificatore nella modale
                    activeMeterSectionIndex: 0, // tiene traccia della sezione per l'aggiunta rapida di modificatori

                    // Modale Composizione Pizza a Metà
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,

                    // Modale Finalizzazione
                    showModal: false,
                    editingOrderId: null,
                    modes: [
                        { id: 'banco', label: 'Banco', icon: 'fa-solid fa-person' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck-fast' },
                    ],
                    mode: 'banco',
                    date: this.getTodayDateString(),
                    hour: this.getCurrentHourString(),
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: '',
                    zoneName: '',
                    notes: '',
                    accontoRicevuto: 0,
                    tableNumber: '', // Aggiunto per Banco
                    
                    // Dati Ordini e Archivio
                    orders: [], // Ordini Attivi
                    archive: [], // Storico Ordini
                    
                    // Zone di Consegna e Fattorini
                    deliveryZones: [
                        { name: 'Centro', price: 2.00 },
                        { name: 'Periferia Nord', price: 3.50 },
                    ],
                    drivers: ['Mario', 'Luigi'], // Nomi Fattorini
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', // 'today', 'tomorrow', 'future'

                    // Storico/Archivio
                    archiveDateFilter: this.getTodayDateString(),
                    selectedDriver: '', // Per le statistiche
                    driverStats: { totalOrders: 0, totalRevenue: 0 },

                    // Impostazioni
                    activeSettingsCat: 'Menu', // 'Menu', 'Modificatori', 'ZoneFattorini', 'Capacita', 'Account'
                    newCategoryName: '',
                    newItemName: '',
                    newItemPrice: 0,
                    
                    activeSettingsModCat: 'Più',
                    newModifierCategoryName: '',
                    newModifierName: '',
                    newModifierPrice: 0,

                    newZoneName: '',
                    newZonePrice: 0,
                    newDriverName: '',

                    // Capacità Oraria
                    capacitySettings: {
                        maxPizzas: 40,
                        intervalMinutes: 15, // 15, 20, 30, 60
                    },
                    orderCapacity: { total: 0, nextInterval: '' },

                    // Modale Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0,
                    
                    // Modale Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,

                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: [],
                }
            },
            
            computed: {
                total() {
                    return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                },
                calculatedOrderTotal() {
                    return this.total + this.deliveryCost;
                },
                deliveryCost() {
                    if (this.mode === 'consegna' && this.zoneName) {
                        const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                        return zone ? zone.price : 0.00;
                    }
                    return 0.00;
                },
                restoDaDare() {
                    return Math.max(0, this.accontoRicevuto - this.calculatedOrderTotal);
                },
                minDate() {
                    return this.getTodayDateString();
                },
                isCapacityFull() {
                    return this.orderCapacity.total > this.capacitySettings.maxPizzas;
                },
                isCapacityWarning() {
                    return this.orderCapacity.total >= this.capacitySettings.maxPizzas * 0.75 && this.orderCapacity.total <= this.capacitySettings.maxPizzas;
                },
                
                // Filtri
                filteredAvailableItems() {
                    let items = this.menu[this.activeCat] || [];
                    
                    // Gestione ricerca su tutte le categorie se il termine è presente
                    if (this.searchTerm) {
                        const lowerSearch = this.searchTerm.toLowerCase();
                        let allItems = [];
                        for (const cat in this.menu) {
                            allItems = allItems.concat(this.menu[cat].map(item => ({...item, category: cat})));
                        }
                        
                        // Filtra per nome articolo o nome categoria
                        return allItems.filter(item => 
                            item.nome.toLowerCase().includes(lowerSearch) || 
                            item.category.toLowerCase().includes(lowerSearch)
                        );
                    }

                    return items.filter(item => !item.isFinished);
                },
                filteredModifiersForActiveCat() {
                    let mods = this.modifiers[this.activeModCat] || [];
                    const lowerSearch = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => mod.nome.toLowerCase().includes(lowerSearch) && !mod.isFinished);
                },

                // Filtri per Modali Composte (Mezzo Metro/Pizza Metà)
                filteredPizzaGusti() {
                    const pizze = this.menu['Pizze'] || [];
                    const lowerSearch = this.gustoSearchTerm.toLowerCase();
                    return pizze.filter(p => p.nome.toLowerCase().includes(lowerSearch) && !p.isHalfPizza && !p.isMeter && !p.isFinished);
                },
                filteredTempModifiers() {
                    let mods = this.modifiers[this.tempModCat] || [];
                    const lowerSearch = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => mod.nome.toLowerCase().includes(lowerSearch) && !mod.isFinished);
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    return this.tempMeterItem.sections.every(section => section.gusto && section.gusto.trim() !== '');
                },
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;
                    let basePrice = this.tempMeterItem.prezzo;
                    let modifierTotal = 0;
                    this.tempMeterItem.sections.forEach(section => {
                        if (section.modifiers) {
                            modifierTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }
                    });
                    return basePrice + modifierTotal;
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto2;
                },
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    let basePrice = this.tempHalfPizzaItem.prezzo; // 0.00 per l'articolo base
                    
                    // Calcola il costo del gusto PIÙ CARO
                    const pizzaGusto1 = this.menu['Pizze'].find(p => p.nome === this.tempHalfPizzaItem.gusto1);
                    const pizzaGusto2 = this.menu['Pizze'].find(p => p.nome === this.tempHalfPizzaItem.gusto2);
                    
                    const price1 = pizzaGusto1 ? pizzaGusto1.prezzo : 0;
                    const price2 = pizzaGusto2 ? pizzaGusto2.prezzo : 0;
                    
                    let maxGustoPrice = Math.max(price1, price2);

                    // Aggiungi i costi dei modificatori
                    let modifierTotal = 0;
                    if (this.tempHalfPizzaItem.modifiers1) {
                        modifierTotal += this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }
                    if (this.tempHalfPizzaItem.modifiers2) {
                        modifierTotal += this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }

                    // Totale: Prezzo del Gusto più Caro + Modificatori + Prezzo Base Item (che è 0.00)
                    return maxGustoPrice + modifierTotal + basePrice; 
                },
                
                // Filtri Ordini Attivi
                filteredActiveOrders() {
                    const today = this.getTodayDateString();
                    const tomorrow = this.getTomorrowDateString();
                    const now = new Date();

                    return this.orders.filter(order => {
                        let dateMatch = false;
                        
                        if (this.activeDateFilter === 'today') {
                            dateMatch = order.date === today;
                        } else if (this.activeDateFilter === 'tomorrow') {
                            dateMatch = order.date === tomorrow;
                        } else if (this.activeDateFilter === 'future') {
                            // Filtra gli ordini futuri (dal giorno dopo domani in poi o se data è oggi/domani ma ora futura)
                            const orderDateTime = new Date(`${order.date}T${order.hour}`);
                            // Se la data è oggi o domani ma l'ora è passata, non è futuro.
                            if (order.date === today && orderDateTime < now) {
                                dateMatch = false;
                            } else if (order.date === tomorrow && orderDateTime < now) {
                                dateMatch = false; // Solo per coerenza logica, ma domai è sempre futuro
                            } else {
                                dateMatch = new Date(order.date) >= new Date(tomorrow) || (order.date === today && orderDateTime > now);
                            }
                        }
                        
                        if (!dateMatch) return false;

                        const lowerSearch = this.activeOrderSearchTerm.toLowerCase();
                        if (lowerSearch) {
                            return (
                                order.customer?.toLowerCase().includes(lowerSearch) ||
                                order.address?.toLowerCase().includes(lowerSearch) ||
                                order.tableNumber?.toLowerCase().includes(lowerSearch) ||
                                order.zone?.toLowerCase().includes(lowerSearch)
                            );
                        }
                        return true;
                    }).sort((a, b) => {
                        // Ordina prima per data, poi per ora.
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },

                // Filtro Storico
                filteredArchive() {
                    const date = this.archiveDateFilter;
                    let filtered = this.archive.filter(order => order.date === date);

                    if (this.selectedDriver) {
                        filtered = filtered.filter(order => 
                            order.mode === 'consegna' && order.driver === this.selectedDriver
                        );
                    }
                    
                    return filtered.sort((a, b) => new Date(a.archivedTime) - new Date(b.archivedTime));
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                availableDrivers() {
                    // Ottieni tutti i fattorini dall'archivio per la data selezionata e dalla lista di default
                    const driversFromArchive = new Set(this.archive
                        .filter(o => o.date === this.archiveDateFilter && o.mode === 'consegna')
                        .map(o => o.driver).filter(d => d));
                        
                    this.drivers.forEach(d => driversFromArchive.add(d));
                    
                    return Array.from(driversFromArchive);
                },
                archiveDateFilterDisplay() {
                    return new Date(this.archiveDateFilter).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                },

                // Permessi
                canAccessImpostazioni() {
                    return this.userRole === 'owner';
                },
                canAccessRiepilogo() {
                    return this.userRole === 'owner' || this.userRole === 'admin';
                }
            },
            
            watch: {
                // Sincronizza il carrello con il localStorage ogni volta che cambia
                order: {
                    handler() {
                        this.saveData();
                        this.updateCapacityWarning(); // Aggiorna la capacità quando il carrello cambia
                    },
                    deep: true
                },
                // Salva lo stato dell'app quando cambiano i dati principali
                orders: { handler() { this.saveData(); }, deep: true },
                archive: { handler() { this.saveData(); }, deep: true },
                menu: { handler() { this.saveData(); }, deep: true },
                modifiers: { handler() { this.saveData(); }, deep: true },
                deliveryZones: { handler() { this.saveData(); }, deep: true },
                drivers: { handler() { this.saveData(); }, deep: true },
                capacitySettings: { handler() { this.saveData(); }, deep: true },
                adminPin: { handler() { this.saveData(); }, deep: true },
                ownerPin: { handler() { this.saveData(); }, deep: true },
                customerHistory: { handler() { this.saveData(); }, deep: true },

                // Reimposta il cliente se la modalità cambia
                mode() {
                    if (this.mode === 'banco') {
                        this.customer = '';
                        this.phone = '';
                        this.address = '';
                        this.streetNumber = '';
                        this.town = '';
                        this.zoneName = '';
                        this.tableNumber = this.tableNumber || '';
                    } else if (this.mode === 'asporto') {
                        this.address = '';
                        this.streetNumber = '';
                        this.town = '';
                        this.zoneName = '';
                        this.tableNumber = '';
                    } else { // 'consegna'
                        this.tableNumber = '';
                    }
                    this.updateDeliveryCost();
                    this.updateCapacityWarning();
                },
                date() {
                    this.updateCapacityWarning();
                },
                hour() {
                    this.updateCapacityWarning();
                },

                // Se cambio data nello storico, ricalcolo le statistiche
                archiveDateFilter() {
                    this.calculateDriverStats();
                },
            },
            
            mounted() {
                this.loadData();
                this.checkUserRole();
                this.setInitialDates();
                this.updateCapacityWarning(); // Calcola la capacità all'avvio
                
                // Aggiorna l'orario ogni minuto per la visualizzazione corretta delle avvertenze
                setInterval(() => {
                    if (this.view === 'ordini') {
                        // Forziamo un aggiornamento per triggerare i computed delle classi CSS
                        this.orders = [...this.orders]; 
                    }
                }, 60000);
            },
            
            methods: {
                // --- Funzioni di Utilità e Dati ---
                getTodayDateString() {
                    return new Date().toISOString().split('T')[0];
                },
                getTomorrowDateString() {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                },
                getCurrentHourString() {
                    const now = new Date();
                    // Arrotonda ai 5 minuti più vicini
                    const minutes = Math.round(now.getMinutes() / 5) * 5;
                    const dateWithRoundedMinutes = new Date(now);
                    dateWithRoundedMinutes.setMinutes(minutes);
                    return dateWithRoundedMinutes.toTimeString().slice(0, 5);
                },
                formatDate(dateStr) {
                    const date = new Date(dateStr);
                    const today = this.getTodayDateString();
                    const tomorrow = this.getTomorrowDateString();

                    if (dateStr === today) return 'Oggi';
                    if (dateStr === tomorrow) return 'Domani';
                    
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                },
                
                // --- Gestione Dati e LocalStorage ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeria_smart_data');
                        if (data) {
                            const parsed = JSON.parse(data);
                            
                            // Carica solo le proprietà che sono state salvate
                            if (parsed.menu) this.menu = parsed.menu;
                            if (parsed.modifiers) this.modifiers = parsed.modifiers;
                            if (parsed.orders) this.orders = parsed.orders;
                            if (parsed.archive) this.archive = parsed.archive;
                            if (parsed.deliveryZones) this.deliveryZones = parsed.deliveryZones;
                            if (parsed.drivers) this.drivers = parsed.drivers;
                            if (parsed.capacitySettings) this.capacitySettings = parsed.capacitySettings;
                            if (parsed.adminPin) this.adminPin = parsed.adminPin;
                            if (parsed.ownerPin) this.ownerPin = parsed.ownerPin;
                            if (parsed.customerHistory) this.customerHistory = parsed.customerHistory;

                            // Carica lo stato del carrello corrente (utile per i refresh)
                            if (parsed.currentOrder) this.order = parsed.currentOrder;
                            if (parsed.editingOrderId !== undefined) this.editingOrderId = parsed.editingOrderId;
                            if (parsed.activeSettingsCat) this.activeSettingsCat = parsed.activeSettingsCat;
                            if (parsed.activeSettingsModCat) this.activeSettingsModCat = parsed.activeSettingsModCat;

                        }
                    } catch (e) {
                        console.error("Errore nel caricamento dei dati da localStorage:", e);
                    }
                },
                saveData() {
                    const dataToSave = {
                        menu: this.menu,
                        modifiers: this.modifiers,
                        orders: this.orders,
                        archive: this.archive,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        capacitySettings: this.capacitySettings,
                        adminPin: this.adminPin,
                        ownerPin: this.ownerPin,
                        customerHistory: this.customerHistory,
                        
                        // Stato UI corrente
                        currentOrder: this.order,
                        editingOrderId: this.editingOrderId,
                        activeSettingsCat: this.activeSettingsCat,
                        activeSettingsModCat: this.activeSettingsModCat,
                    };
                    localStorage.setItem('pizzeria_smart_data', JSON.stringify(dataToSave));
                },
                clearCache() {
                    if (confirm("Sei sicuro di voler pulire TUTTI gli ordini attivi e lo storico archiviato? Questa azione non è reversibile.")) {
                        this.orders = [];
                        this.archive = [];
                        this.order = [];
                        this.editingOrderId = null;
                        this.customerHistory = [];
                        alert("Ordini e Storico puliti con successo.");
                        this.saveData();
                        this.calculateDriverStats(); // Aggiorna le statistiche
                    }
                },
                exportData() {
                    const data = localStorage.getItem('pizzeria_smart_data');
                    if (!data) return alert("Nessun dato da esportare.");
                    
                    const filename = `pizzeria_smart_data_${new Date().toISOString().slice(0, 10)}.json`;
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert("Dati esportati con successo!");
                },
                importData() {
                    if (!confirm("Sei sicuro di voler importare dati? Questo SOSTITUIRÀ tutti i dati attuali.")) {
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = event => {
                            try {
                                const importedData = event.target.result;
                                JSON.parse(importedData); // Test per validità JSON
                                localStorage.setItem('pizzeria_smart_data', importedData);
                                this.loadData();
                                alert("Dati importati con successo! Ricarica la pagina per applicare pienamente i cambiamenti.");
                            } catch (error) {
                                alert("Errore durante l'importazione: il file non è un JSON valido.");
                                console.error(error);
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },

                // --- Gestione Accesso e PIN ---
                checkUserRole() {
                    // Controlla se il ruolo è stato salvato nella sessione precedente
                    const role = localStorage.getItem('pz_user_role');
                    if (role === 'admin' || role === 'owner') {
                        this.userRole = role;
                        this.view = 'ordini'; // Vai direttamente agli ordini
                    }
                },
                grantAccess() {
                    const pin = this.accessPin.trim();
                    if (pin === this.adminPin) {
                        this.userRole = 'admin';
                        localStorage.setItem('pz_user_role', 'admin');
                        this.view = 'ordini';
                        this.accessPin = '';
                    } else if (pin === this.ownerPin) {
                        this.userRole = 'owner';
                        localStorage.setItem('pz_user_role', 'owner');
                        this.view = 'ordini';
                        this.accessPin = '';
                    } else {
                        alert("Codice di accesso non valido!");
                        this.accessPin = '';
                    }
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.adminPin = this.newAdminPin;
                        this.newAdminPin = '';
                        alert("Codice Operatore salvato con successo.");
                        this.saveData();
                    } else {
                        alert("Il codice deve avere almeno 4 caratteri/numeri.");
                    }
                },
                saveOwnerPin() {
                     if (this.newOwnerPin.length >= 4) {
                        this.ownerPin = this.newOwnerPin;
                        this.newOwnerPin = '';
                        alert("Codice Proprietario salvato con successo.");
                        this.saveData();
                    } else {
                        alert("Il codice deve avere almeno 4 caratteri/numeri.");
                    }
                },

                // --- Logica Carrello Ordine ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) {
                        return item.manualPrice; // Se il prezzo è stato impostato manualmente
                    }

                    let basePrice = item.prezzo || 0;
                    let modifierTotal = 0;
                    
                    // Gestione modificatori standard
                    if (item.modifiers && !item.isHalfPizza && !item.isMeter) {
                        modifierTotal += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        return basePrice + modifierTotal;
                    }

                    // Gestione Mezzo Metro / Schiacciata Grande
                    if (item.isMeter) {
                        item.sections.forEach(section => {
                            if (section.modifiers) {
                                modifierTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                            }
                        });
                        return basePrice + modifierTotal;
                    }

                    // Gestione Pizza a Metà (Il costo totale è dato dal gusto PIÙ CARO + modificatori + baseItemPrice)
                    if (item.isHalfPizza) {
                        // Trova i prezzi delle pizze base (escludendo modificatori)
                        const pizzaGusto1 = this.menu['Pizze'].find(p => p.nome === item.gusto1);
                        const pizzaGusto2 = this.menu['Pizze'].find(p => p.nome === item.gusto2);
                        
                        const price1 = pizzaGusto1 ? pizzaGusto1.prezzo : 0;
                        const price2 = pizzaGusto2 ? pizzaGusto2.prezzo : 0;
                        
                        let maxGustoPrice = Math.max(price1, price2);
                        
                        // Aggiungi i costi dei modificatori (Metà 1 e Metà 2)
                        if (item.modifiers1) {
                            modifierTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }
                        if (item.modifiers2) {
                            modifierTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }

                        // Ritorna il costo del gusto più caro + i modificatori + prezzo base (0.00)
                        return maxGustoPrice + modifierTotal + basePrice; 
                    }

                    return basePrice; // Dovrebbe essere gestito dal primo IF, ma come fallback.
                },
                
                selectItem(index) {
                    this.selectedItemIndex = this.selectedItemIndex === index ? null : index;
                    // Se l'elemento selezionato è un item composto, apri subito la modale di modifica
                    if (this.selectedItemIndex !== null) {
                         const item = this.order[this.selectedItemIndex];
                         if (item.isHalfPizza) {
                             this.startHalfPizzaComposition(item, this.selectedItemIndex);
                         } else if (item.isMeter) {
                             this.startMeterComposition(item, this.selectedItemIndex);
                         }
                    }
                },
                
                handleItemClick(item) {
                    this.lastSelectedItem = item; // Per evidenziare nel menu
                    
                    // Gestione Articoli Speciali (Mezzo Metro / Pizza Metà)
                    if (item.isMeter) {
                        this.startMeterComposition(item);
                    } else if (item.isHalfPizza) {
                        this.startHalfPizzaComposition(item);
                    } else {
                        // Aggiunta normale
                        this.addItemToOrder(item);
                    }
                },
                addItemToOrder(item) {
                    const newItem = JSON.parse(JSON.stringify(item)); // Copia profonda
                    newItem.modifiers = []; // Inizializza array modificatori
                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; // Seleziona il nuovo elemento
                    this.saveData();
                },
                removeItem(index) {
                    if (confirm(`Sei sicuro di voler rimuovere l'articolo "${this.order[index].nome}"?`)) {
                        this.order.splice(index, 1);
                        this.selectedItemIndex = null;
                        this.saveData();
                    }
                },
                
                // Modificatori (Standard)
                addExtra(modifier) {
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo nel carrello.");
                        return;
                    }
                    
                    const item = this.order[this.selectedItemIndex];

                    // Non aggiungere modificatori standard a item composti (metri o metà pizza)
                    if (item.isMeter || item.isHalfPizza) {
                        alert("Aggiungi i modificatori per questo articolo tramite la modale di composizione (clicca sull'item nel carrello).");
                        return;
                    }

                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.activeModCat; // Aggiunge categoria per visualizzazione
                    
                    if (!item.modifiers) {
                        item.modifiers = [];
                    }
                    
                    // Previene duplicati (solo per 'Senza', gli altri possono essere duplicati per somma costo)
                    if (this.activeModCat === 'Senza' && item.modifiers.some(mod => mod.nome === newMod.nome)) {
                        alert(`Il modificatore "Senza ${newMod.nome}" è già presente.`);
                        return;
                    }
                    
                    item.modifiers.push(newMod);
                    this.saveData();
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch(category) {
                        case 'Più': return '➕';
                        case 'Senza': return '⛔';
                        case 'Poco': return '⬇️';
                        case 'Abbondante': return '⬆️';
                        default: return '➡️';
                    }
                },

                // Modale Modifica Prezzo
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    const item = this.order[index];
                    this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    const index = this.tempPriceEditIndex;
                    if (index !== null && this.newPriceValue >= 0) {
                        this.order[index].manualPrice = this.newPriceValue;
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.saveData();
                        alert(`Prezzo di ${this.order[index].nome} aggiornato a €${this.newPriceValue.toFixed(2)}.`);
                    } else {
                         alert("Inserisci un prezzo valido.");
                    }
                },
                
                // --- Logica Modale Composizione Mezzo Metro/Schiacciata ---
                startMeterComposition(item, index = -1) {
                    if (index !== -1) {
                        // Modifica di un elemento esistente nel carrello
                        this.tempMeterItem = item; // Puntatore all'elemento reale per modifica in tempo reale
                        this.selectedItemIndex = index;
                    } else {
                        // Nuovo elemento
                        this.tempMeterItem = JSON.parse(JSON.stringify(item));
                    }
                    
                    // Assicura che ogni sezione abbia i modificatori inizializzati
                    this.tempMeterItem.sections.forEach(section => {
                        if (!section.modifiers) {
                            section.modifiers = [];
                        }
                        if (!section.gusto) {
                            section.gusto = '';
                        }
                    });

                    this.showMeterModal = true;
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Più';
                    this.modifierSearchTerm = '';
                    this.activeMeterSectionIndex = 0;
                },
                selectMeterGusto(secIndex, gustoName) {
                    this.tempMeterItem.sections[secIndex].gusto = gustoName;
                    this.gustoSearchTerm = '';
                    this.activeMeterSectionIndex = secIndex; // Seleziona questa sezione per i modificatori
                },
                addMeterModifier(secIndex, modifier) {
                    const item = this.tempMeterItem;
                    if (!item) return;
                    
                    const section = item.sections[secIndex];
                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.tempModCat;

                    if (!section.modifiers) section.modifiers = [];
                    section.modifiers.push(newMod);
                    this.modifierSearchTerm = ''; // Nasconde l'autocompletamento
                    this.saveData(); // Salva anche se in modalità modifica diretta
                },
                removeMeterModifier(secIndex, modIndex) {
                    // Questa funzione è usata sia nella modale (modifica tempItem) che nella vista carrello (modifica order[index])
                    this.tempMeterItem.sections[secIndex].modifiers.splice(modIndex, 1);
                    this.saveData(); // Salva dopo la rimozione
                },
                cancelMeterComposition() {
                    // Se eravamo in modalità modifica (puntatore), non dobbiamo chiudere l'indice selezionato
                    if (this.selectedItemIndex !== null && this.order[this.selectedItemIndex] === this.tempMeterItem) {
                        this.tempMeterItem = null; // Stacca il puntatore
                        this.showMeterModal = false;
                        this.selectedItemIndex = null;
                        return;
                    }
                    
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                },
                addMeterToOrder() {
                    if (this.isMeterValid) {
                        if (this.selectedItemIndex !== null && this.order[this.selectedItemIndex] === this.tempMeterItem) {
                            // Era una modifica, l'oggetto è già nel carrello
                            this.order[this.selectedItemIndex].gustiList = this.tempMeterItem.sections.map(s => s.gusto).join(' | ');
                            this.order[this.selectedItemIndex] = { ...this.order[this.selectedItemIndex] }; // Forzare l'aggiornamento
                            this.selectedItemIndex = null;
                            alert(`Ordine Mezzo Metro modificato con successo.`);
                        } else {
                            // Nuovo ordine
                            const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                            finalItem.gustiList = finalItem.sections.map(s => s.gusto).join(' | '); // Riepilogo per la stampa
                            this.order.push(finalItem);
                            this.selectedItemIndex = this.order.length - 1;
                        }
                        
                        this.showMeterModal = false;
                        this.tempMeterItem = null;
                        this.saveData();
                    } else {
                        alert("Assicurati di aver selezionato un gusto per tutte le sezioni.");
                    }
                },
                
                // --- Logica Modale Composizione Pizza a Metà ---
                startHalfPizzaComposition(item, index = -1) {
                    if (index !== -1) {
                        // Modifica di un elemento esistente nel carrello
                        this.tempHalfPizzaItem = item; // Puntatore all'elemento reale per modifica in tempo reale
                        this.selectedItemIndex = index;
                    } else {
                        // Nuovo elemento
                        this.tempHalfPizzaItem = JSON.parse(JSON.stringify(item));
                    }
                    
                    // Inizializza
                    if (!this.tempHalfPizzaItem.gusto1) this.tempHalfPizzaItem.gusto1 = '';
                    if (!this.tempHalfPizzaItem.gusto2) this.tempHalfPizzaItem.gusto2 = '';
                    if (!this.tempHalfPizzaItem.modifiers1) this.tempHalfPizzaItem.modifiers1 = [];
                    if (!this.tempHalfPizzaItem.modifiers2) this.tempHalfPizzaItem.modifiers2 = [];

                    this.showHalfPizzaModal = true;
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Più';
                    this.modifierSearchTerm = '';
                },
                selectHalfPizzaGusto(halfNum, gustoName) {
                    if (halfNum === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                    } else {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                    this.gustoSearchTerm = '';
                },
                addHalfPizzaModifier(halfNum, modifier) {
                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.tempModCat;

                    if (halfNum === 1) {
                        this.tempHalfPizzaItem.modifiers1.push(newMod);
                    } else {
                        this.tempHalfPizzaItem.modifiers2.push(newMod);
                    }
                    this.modifierSearchTerm = '';
                    this.saveData(); // Salva anche in modifica diretta
                },
                removeHalfPizzaModifier(halfNum, modIndex) {
                    // Rimuovi dal tempItem (che può essere un puntatore al carrello)
                    if (halfNum === 1) this.tempHalfPizzaItem.modifiers1.splice(modIndex, 1);
                    else this.tempHalfPizzaItem.modifiers2.splice(modIndex, 1);
                    this.saveData(); // Salva dopo la rimozione
                },
                cancelHalfPizzaComposition() {
                     // Se eravamo in modalità modifica (puntatore), non dobbiamo chiudere l'indice selezionato
                    if (this.selectedItemIndex !== null && this.order[this.selectedItemIndex] === this.tempHalfPizzaItem) {
                        this.tempHalfPizzaItem = null; // Stacca il puntatore
                        this.showHalfPizzaModal = false;
                        this.selectedItemIndex = null;
                        return;
                    }
                    
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                },
                addHalfPizzaToOrder() {
                    if (this.isHalfPizzaValid) {
                        if (this.selectedItemIndex !== null && this.order[this.selectedItemIndex] === this.tempHalfPizzaItem) {
                            // Era una modifica, l'oggetto è già nel carrello
                            this.order[this.selectedItemIndex] = { ...this.order[this.selectedItemIndex] }; // Forzare l'aggiornamento
                            this.selectedItemIndex = null;
                            alert(`Ordine Pizza Metà modificato con successo.`);
                        } else {
                            // Nuovo ordine
                            const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                            this.order.push(finalItem);
                            this.selectedItemIndex = this.order.length - 1;
                        }

                        this.showHalfPizzaModal = false;
                        this.tempHalfPizzaItem = null;
                        this.saveData();
                    } else {
                        alert("Assicurati di aver selezionato un gusto per entrambe le metà.");
                    }
                },

                // --- Logica Modale Finalizza Ordine ---
                setInitialDates() {
                    this.date = this.getTodayDateString();
                    this.hour = this.getCurrentHourString();
                },
                openModal() {
                    if (this.order.length === 0) {
                        alert("Il carrello è vuoto!");
                        return;
                    }
                    
                    // Resetta i dati specifici non collegati al carrello se non siamo in modalità modifica
                    if (this.editingOrderId === null) {
                        this.mode = 'banco';
                        this.setInitialDates();
                        this.customer = '';
                        this.phone = '';
                        this.address = '';
                        this.streetNumber = '';
                        this.town = '';
                        this.zoneName = '';
                        this.notes = '';
                        this.accontoRicevuto = 0;
                        this.tableNumber = '';
                    } else {
                         // Se siamo in modifica, carica i dati dell'ordine
                        const originalOrder = this.orders.find(o => o.id === this.editingOrderId);
                        if (originalOrder) {
                            this.mode = originalOrder.mode;
                            this.date = originalOrder.date;
                            this.hour = originalOrder.hour;
                            this.customer = originalOrder.customer;
                            this.phone = originalOrder.phone;
                            this.address = originalOrder.address;
                            this.streetNumber = originalOrder.streetNumber || '';
                            this.town = originalOrder.town || '';
                            this.zoneName = originalOrder.zone;
                            this.notes = originalOrder.notes;
                            this.accontoRicevuto = originalOrder.accontoRicevuto || 0;
                            this.tableNumber = originalOrder.tableNumber || '';
                        }
                    }
                    
                    this.updateDeliveryCost();
                    this.updateCapacityWarning();
                    this.showModal = true;
                },
                selectMode(m) {
                    this.mode = m;
                },
                updateDeliveryCost() {
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    if (this.mode === 'consegna' && !zone && this.zoneName) {
                        this.zoneName = ''; // Deseleziona se la zona non esiste più
                    }
                    // Triggera l'aggiornamento del computed property 'deliveryCost' e 'calculatedOrderTotal'
                },
                filterCustomers() {
                    const term = this.customer.toLowerCase();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory
                        .filter(c => c.customer.toLowerCase().includes(term) || c.phone.includes(term))
                        .slice(0, 5);
                },
                loadCustomerData(customerData) {
                    this.customer = customerData.customer;
                    this.phone = customerData.phone;
                    this.address = customerData.address;
                    this.streetNumber = customerData.streetNumber || '';
                    this.town = customerData.town || '';
                    this.zoneName = customerData.zoneName || '';
                    this.updateDeliveryCost();
                    this.filteredCustomerSuggestions = [];
                },
                
                // Capacità Oraria
                getPizzasInInterval(targetTime, targetDate) {
                    const intervalMinutes = this.capacitySettings.intervalMinutes;
                    const targetDateTime = new Date(`${targetDate}T${targetTime}:00`);
                    
                    // Calcola l'inizio e la fine dell'intervallo (l'intervallo finisce all'ora dell'ordine)
                    const intervalEnd = targetDateTime;
                    const intervalStart = new Date(targetDateTime);
                    intervalStart.setMinutes(intervalStart.getMinutes() - intervalMinutes);
                    
                    let pizzaCount = 0;
                    
                    this.orders.forEach(order => {
                        const orderTime = new Date(`${order.date}T${order.hour}:00`);
                        
                        // Controlla se l'ordine è all'interno dell'intervallo (esclusa l'ora di inizio, inclusa l'ora di fine)
                        if (orderTime > intervalStart && orderTime <= intervalEnd) {
                            order.items.forEach(item => {
                                // Conta tutte le pizze, incluse Metà e Mezzo Metro
                                if (this.menu['Pizze'].some(p => p.nome === item.nome) && !item.isHalfPizza || 
                                    item.isHalfPizza || item.isMeter) {
                                    pizzaCount++;
                                }
                            });
                        }
                    });
                    
                    return pizzaCount;
                },
                updateCapacityWarning() {
                    if (!this.date || !this.hour) {
                         this.orderCapacity = { total: 0, nextInterval: '' };
                         return;
                    }
                    
                    // Contiamo quante pizze ci sono nel carrello corrente
                    const currentOrderPizzas = this.order.filter(item => 
                        this.menu['Pizze'].some(p => p.nome === item.nome) || 
                        item.isHalfPizza || item.isMeter
                    ).length;

                    // Calcola la capacità già occupata per l'intervallo selezionato
                    let pizzasAlreadyScheduled = this.getPizzasInInterval(this.hour, this.date);

                    if (this.editingOrderId !== null) {
                        const existingOrder = this.orders.find(o => o.id === this.editingOrderId);
                        if (existingOrder && existingOrder.date === this.date && existingOrder.hour === this.hour) {
                            // Sottrai le pizze dell'ordine corrente che stiamo modificando (per evitare doppio conteggio)
                            existingOrder.items.forEach(item => {
                                if (this.menu['Pizze'].some(p => p.nome === item.nome) || item.isHalfPizza || item.isMeter) {
                                    pizzasAlreadyScheduled--;
                                }
                            });
                        }
                    }

                    // Totale pizze previste nell'intervallo
                    const totalPizzas = pizzasAlreadyScheduled + currentOrderPizzas;
                    
                    this.orderCapacity.total = totalPizzas;

                    // Calcola l'orario del prossimo intervallo per il suggerimento (se pieno)
                    const targetTime = new Date(`${this.date}T${this.hour}:00`);
                    const nextTime = new Date(targetTime);
                    nextTime.setMinutes(nextTime.getMinutes() + this.capacitySettings.intervalMinutes);
                    this.orderCapacity.nextInterval = nextTime.toTimeString().slice(0, 5);
                },

                confermaOrdine() {
                    if (this.orderCapacity.total > this.capacitySettings.maxPizzas) {
                        if (!confirm(`Capacità Oraria Superata! Hai ${this.orderCapacity.total} pizze nell'intervallo (${this.capacitySettings.maxPizzas} Max). Vuoi procedere comunque?`)) {
                            return;
                        }
                    }

                    // Costruisci l'oggetto Ordine
                    const newOrder = {
                        id: this.editingOrderId || Date.now(),
                        items: JSON.parse(JSON.stringify(this.order)),
                        mode: this.mode,
                        date: this.date,
                        hour: this.hour,
                        total: this.calculatedOrderTotal,
                        customer: (this.mode === 'asporto' || this.mode === 'consegna') ? this.customer : '',
                        phone: (this.mode === 'asporto' || this.mode === 'consegna') ? this.phone : '',
                        address: (this.mode === 'consegna') ? `${this.address}, ${this.streetNumber}, ${this.town}` : '',
                        streetNumber: (this.mode === 'consegna') ? this.streetNumber : '',
                        town: (this.mode === 'consegna') ? this.town : '',
                        zone: (this.mode === 'consegna') ? this.zoneName : '',
                        tableNumber: (this.mode === 'banco') ? this.tableNumber : '',
                        notes: this.notes,
                        status: 'Ricevuto',
                        driver: (this.mode === 'consegna') ? (this.drivers[0] || '') : '', // Assegna il primo fattorino di default
                        accontoRicevuto: this.accontoRicevuto,
                        restoDaDare: this.restoDaDare,
                        creationTime: Date.now(),
                    };
                    
                    // Salva la storia del cliente
                    if (newOrder.customer && newOrder.phone) {
                         const existingIndex = this.customerHistory.findIndex(c => c.customer === newOrder.customer && c.phone === newOrder.phone);
                         const customerData = {
                             customer: newOrder.customer, 
                             phone: newOrder.phone, 
                             address: newOrder.address, 
                             streetNumber: newOrder.streetNumber,
                             town: newOrder.town,
                             zoneName: newOrder.zone
                         };

                         if (existingIndex !== -1) {
                            // Aggiorna i dati esistenti
                            this.customerHistory[existingIndex] = customerData;
                         } else {
                            this.customerHistory.push(customerData);
                         }
                    }


                    if (this.editingOrderId !== null) {
                        // Modifica Ordine Esistente
                        const index = this.orders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.orders[index] = { ...this.orders[index], ...newOrder }; // Mantiene status e creationTime
                        }
                        alert(`Ordine #${this.editingOrderId} modificato con successo.`);
                        this.editingOrderId = null; // Fine modalità modifica
                    } else {
                        // Nuovo Ordine
                        this.orders.push(newOrder);
                        alert(`Ordine #${newOrder.id} salvato con successo.`);
                    }

                    // Reset
                    this.order = [];
                    this.showModal = false;
                    this.selectedItemIndex = null;
                    this.saveData();
                    this.view = 'ordini';
                    this.updateCapacityWarning(); // Aggiorna la capacità dopo l'aggiunta
                },
                cancelEdit() {
                    if (confirm("Sei sicuro di voler annullare la modifica? Il carrello verrà svuotato e l'ordine originale resterà invariato.")) {
                        this.order = [];
                        this.editingOrderId = null;
                        this.view = 'ordini';
                        this.saveData();
                    }
                },
                
                // --- Logica Ordini Attivi ---
                getNextStatus(currentStatus) {
                    switch (currentStatus) {
                        case 'Ricevuto': return 'In Preparazione';
                        case 'In Preparazione': return 'Pronto';
                        case 'Pronto': return 'In Consegna';
                        case 'In Consegna': return 'Archivia';
                        case 'Archivia': return 'Archivia'; // Lo stato finale rimane 'Archivia'
                        default: return 'Archivia';
                    }
                },
                advance(order) {
                    const nextStatus = this.getNextStatus(order.status);
                    
                    // Se l'ordine è di banco o asporto, lo stato "In Consegna" non ha senso, quindi salta ad "Archivia"
                    if ((order.mode === 'banco' || order.mode === 'asporto') && nextStatus === 'In Consegna') {
                         this.archiveOrder(order);
                         return;
                    }

                    if (nextStatus === 'Archivia') {
                        // L'ordine è completo, spostalo in archivio
                        this.archiveOrder(order);
                    } else {
                        // Avanza di stato
                        order.status = nextStatus;
                        this.saveData();
                    }
                },
                archiveOrder(order) {
                    if (confirm(`Confermi l'archiviazione e la chiusura dell'Ordine #${order.id}?`)) {
                        const archived = { 
                            ...order, 
                            archivedTime: Date.now(),
                            status: 'Archiviato'
                        };
                        this.archive.push(archived);
                        this.orders = this.orders.filter(o => o.id !== order.id);
                        this.saveData();
                        this.calculateDriverStats(); // Aggiorna le statistiche
                    }
                },
                editOrder(id) {
                    const orderToEdit = this.orders.find(o => o.id === id);
                    if (orderToEdit) {
                        // Carica i dati dell'ordine nel carrello
                        this.order = JSON.parse(JSON.stringify(orderToEdit.items));
                        this.editingOrderId = id;
                        this.view = 'inserimento';
                        this.selectedItemIndex = null;
                        this.saveData();
                    }
                },
                duplicateOrder(order) {
                    if (confirm(`Sei sicuro di voler duplicare l'Ordine #${order.id} in un nuovo ordine attivo?`)) {
                        const newOrder = JSON.parse(JSON.stringify(order));
                        newOrder.id = Date.now(); // Nuovo ID
                        newOrder.status = 'Ricevuto'; // Nuovo stato iniziale
                        newOrder.creationTime = Date.now();
                        newOrder.archivedTime = undefined; // Rimuovi il tempo di archiviazione
                        
                        // Per il carrello corrente (non attivo)
                        this.order = newOrder.items;
                        this.editingOrderId = null;
                        this.view = 'inserimento';
                        
                        // Inizializza i dati della modale Finalizza
                        this.mode = newOrder.mode;
                        this.date = newOrder.date;
                        this.hour = newOrder.hour;
                        this.customer = newOrder.customer;
                        this.phone = newOrder.phone;
                        this.address = newOrder.address;
                        this.streetNumber = newOrder.streetNumber || '';
                        this.town = newOrder.town || '';
                        this.zoneName = newOrder.zone;
                        this.notes = newOrder.notes;
                        this.accontoRicevuto = newOrder.accontoRicevuto || 0;
                        this.tableNumber = newOrder.tableNumber || '';
                        
                        this.saveData();
                        
                        // Ti porta alla vista Inserimento con il carrello pronto per la finalizzazione
                        this.openModal(); 
                    }
                },
                updateActiveOrderDriver(id, driverName) {
                    const order = this.orders.find(o => o.id === id);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                    }
                },

                // Avvisi Temporali
                isFutureOrder(order) {
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    return orderTime > now;
                },
                isNear(order) {
                    if (!this.isFutureOrder(order)) return false;
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    const diffMinutes = (orderTime.getTime() - now.getTime()) / 60000;
                    return diffMinutes > 5 && diffMinutes <= 15;
                },
                isUrgent(order) {
                    if (!this.isFutureOrder(order)) return false;
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    const diffMinutes = (orderTime.getTime() - now.getTime()) / 60000;
                    return diffMinutes <= 5;
                },

                // --- Logica Stampa e Condivisione ---
                printOrder(id, type) {
                    const order = this.orders.find(o => o.id === id) || this.archive.find(o => o.id === id);
                    if (!order) return alert("Ordine non trovato.");
                    
                    const printContainer = document.getElementById(`print-content-${type}`);
                    if (!printContainer) return alert("Contenitore di stampa non trovato.");

                    printContainer.innerHTML = type === 'comanda' ? this.generateComanda(order) : this.generateScontrino(order);

                    // Usa l'API standard per la stampa
                    window.print();
                    
                    // Pulizia post-stampa (necessaria per nascondere i container)
                    nextTick(() => {
                        printContainer.innerHTML = '';
                    });
                },
                generateComanda(order) {
                    let html = `
                        <h1 style="font-size: 1.5em; text-align: center;">COMANDA PIZZERIA SMART</h1>
                        <h2 style="font-size: 1.2em; text-align: center; border-bottom: 1px solid #000; padding-bottom: 5px;">Ordine #${order.id} | ${order.mode.toUpperCase()}</h2>
                        <p><strong>Ritiro/Cons. Ora:</strong> ${order.hour} (${this.formatDate(order.date)})</p>
                        <p><strong>Cliente:</strong> ${order.customer || order.tableNumber || 'N/D'}</p>
                    `;
                    if (order.mode === 'consegna') {
                        html += `<p><strong>Indirizzo:</strong> ${order.address} (${order.zone})</p>`;
                        html += `<p><strong>Telefono:</strong> ${order.phone || 'N/D'}</p>`;
                        html += `<p><strong>Fattorino:</strong> ${order.driver || 'N/A'}</p>`;
                    }
                    html += `<p><strong>Note:</strong> ${order.notes || 'Nessuna'}</p>`;
                    html += `<h2 style="font-size: 1.1em;">Dettaglio Articoli:</h2><ul style="list-style: none; padding-left: 0;">`;
                    
                    order.items.forEach(item => {
                        html += `<li style="margin-bottom: 10px; border-bottom: 1px dashed #ccc; padding-bottom: 5px;">`;
                        html += `<span style="font-weight: bold; font-size: 1.1em;">1x ${item.nome}</span>`;
                        
                        // Modificatori Standard
                        if (item.modifiers && item.modifiers.length > 0 && !item.isHalfPizza && !item.isMeter) {
                            html += `<ul style="list-style: none; padding-left: 10px; margin: 3px 0;">`;
                            item.modifiers.forEach(mod => {
                                html += `<li style="font-size: 0.9em;">${this.getModifierIcon(mod.category)} ${mod.nome}</li>`;
                            });
                            html += `</ul>`;
                        }

                        // Pizza a Metà
                        if (item.isHalfPizza) {
                            html += `<ul style="list-style: none; padding-left: 10px; margin: 3px 0;">`;
                            html += `<li style="font-weight: bold;">** Metà 1: ${item.gusto1} **</li>`;
                            item.modifiers1?.forEach(mod => { html += `<li style="font-size: 0.9em;">&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            html += `<li style="font-weight: bold; margin-top: 5px;">** Metà 2: ${item.gusto2} **</li>`;
                            item.modifiers2?.forEach(mod => { html += `<li style="font-size: 0.9em;">&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            html += `</ul>`;
                        }

                        // Mezzo Metro / Schiacciata
                        if (item.isMeter) {
                            html += `<ul style="list-style: none; padding-left: 10px; margin: 3px 0;">`;
                            item.sections.forEach(section => {
                                html += `<li style="font-weight: bold;">** ${section.name}: ${section.gusto} **</li>`;
                                section.modifiers?.forEach(mod => { html += `<li style="font-size: 0.9em;">&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            });
                            html += `</ul>`;
                        }

                        html += `</li>`;
                    });
                    
                    html += `</ul>`;
                    html += `<p style="font-weight: bold; margin-top: 20px; border-top: 1px solid #000; padding-top: 5px;">Totale Incasso: €${order.total.toFixed(2)}</p>`;
                    return html;
                },
                generateScontrino(order) {
                    let html = `
                        <h1 style="font-size: 1.2em; text-align: center;">PIZZERIA SMART</h1>
                        <p style="text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; font-size: 0.9em;">Ordine #${order.id} | ${order.mode.toUpperCase()}</p>
                        <table style="font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th style="text-align: left; border-bottom: 1px dashed #000;">Descrizione</th>
                                    <th style="text-align: right; border-bottom: 1px dashed #000;">Prezzo</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    order.items.forEach(item => {
                        const itemTotal = this.calculateItemTotal(item);
                        
                        // Linea principale dell'articolo
                        html += `<tr><td style="padding-top: 5px;">1x ${item.nome} 
                            <span style="font-size: 0.8rem;">
                                <span v-if="item.isHalfPizza"> (${item.gusto1}/${item.gusto2})</span>
                                <span v-if="item.isMeter"> (${item.sections.length} gusti)</span>
                            </span>
                        </td><td style="text-align: right; padding-top: 5px;">${itemTotal.toFixed(2)}</td></tr>`;
                        
                        // Dettagli gusti/modificatori per pizze composte e costo extra modificatori
                        const allModifiers = [
                            ...(item.modifiers || []),
                            ...(item.modifiers1 || []),
                            ...(item.modifiers2 || []),
                            ...(item.sections ? item.sections.flatMap(s => s.modifiers || []) : [])
                        ];
                        
                        allModifiers.forEach(mod => {
                             // Stampa solo i modificatori con prezzo > 0
                            if(mod.prezzo > 0) {
                                html += `<tr><td style="padding-left: 10px; font-size: 0.9em;">+ ${mod.nome}</td><td style="text-align: right; font-size: 0.9em;">${mod.prezzo.toFixed(2)}</td></tr>`;
                            }
                        });
                        
                        // Stampa i modificatori SENZA costo per la ricevuta (se presenti)
                        const freeMods = allModifiers.filter(mod => mod.prezzo === 0);
                        if (freeMods.length > 0) {
                            html += `<tr><td style="padding-left: 5px; font-size: 0.85em; color: #555;" colspan="2">Modifiche: ${freeMods.map(m => m.nome).join(', ')}</td></tr>`;
                        }
                    });

                    // Costo Consegna (se presente)
                    if (order.mode === 'consegna' && order.zone && order.zone !== 'Nessuna') {
                        const zone = this.deliveryZones.find(z => z.name === order.zone);
                        if (zone && zone.price > 0) {
                            html += `<tr class="total-row"><td style="border-top: 1px dashed #000;">Consegna (${order.zone})</td><td style="text-align: right; border-top: 1px dashed #000;">${zone.price.toFixed(2)}</td></tr>`;
                        }
                    }

                    // Totale
                    html += `
                            </tbody>
                        </table>
                        <table style="margin-top: 10px; font-size: 1em;">
                            <tr class="total-row">
                                <td style="font-weight: bold; border-top: 2px solid #000; padding-top: 5px;">TOTALE ORDINE</td>
                                <td style="text-align: right; font-weight: bold; border-top: 2px solid #000; padding-top: 5px;">€${order.total.toFixed(2)}</td>
                            </tr>
                        </table>
                    `;
                    
                    // Dettagli Ritiro/Consegna
                    html += `
                        <p style="margin-top: 10px; font-size: 0.9em; text-align: center; border-top: 1px dashed #000; padding-top: 5px;">
                            Ora Ritiro/Cons: ${order.hour}
                        </p>
                    `;

                    // Dettagli Resto
                    if (order.accontoRicevuto > 0) {
                        html += `
                            <p style="font-size: 0.9em; text-align: center;">
                                Ricevuto: €${order.accontoRicevuto.toFixed(2)}
                            </p>
                            <p style="font-weight: bold; font-size: 1.1em; color: #e31b23; text-align: center;">
                                RESTO DA DARE: €${order.restoDaDare.toFixed(2)}
                            </p>
                        `;
                    }

                    html += `<p style="text-align: center; margin-top: 20px; font-size: 0.9em;">Grazie per l'ordine!</p>`;
                    return html;
                },
                showShareMenu(id) {
                    this.selectedOrderForShare = this.orders.find(o => o.id === id);
                    if (this.selectedOrderForShare) {
                        this.showShareModal = true;
                    }
                },
                shareViaWhatsapp(order) {
                    const orderSummary = this.generateOrderSummary(order);
                    const whatsappLink = `https://wa.me/${order.phone.replace(/\D/g, '')}?text=${encodeURIComponent(orderSummary)}`;
                    
                    if (order.phone) {
                        window.open(whatsappLink, '_blank');
                    } else {
                        alert("Telefono del cliente non disponibile. Copia il testo e incollalo manualmente.");
                        navigator.clipboard.writeText(orderSummary);
                    }
                    this.showShareModal = false;
                },
                generateOrderSummary(order) {
                    let summary = `*Riepilogo Ordine #${order.id}* - Pizzeria Smart\n\n`;
                    summary += `Modalità: ${order.mode.toUpperCase()}\n`;
                    summary += `Ora Ritiro/Consegna: *${order.hour}* (${this.formatDate(order.date)})\n`;
                    summary += `Cliente: ${order.customer || 'N/D'}\n`;
                    if (order.mode === 'consegna') {
                        summary += `Indirizzo: ${order.address} (${order.zone})\n`;
                    }
                    if (order.notes) {
                        summary += `Note: ${order.notes}\n`;
                    }
                    summary += `\n*Dettaglio Articoli:*\n`;
                    
                    order.items.forEach(item => {
                        const itemTotal = this.calculateItemTotal(item);
                        summary += `\n➡️ 1x ${item.nome} *€${itemTotal.toFixed(2)}*`;
                        
                        // Modificatori (solo quelli con prezzo)
                        const allModifiers = [
                            ...(item.modifiers || []),
                            ...(item.modifiers1 || []),
                            ...(item.modifiers2 || []),
                            ...(item.sections ? item.sections.flatMap(s => s.modifiers || []) : [])
                        ];
                        
                        // Per item composti, aggiungi il riepilogo gusti nella riga principale
                        if (item.isHalfPizza) {
                            summary += ` (${item.gusto1} / ${item.gusto2})`;
                        }
                        if (item.isMeter) {
                            summary += ` (${item.sections.map(s => s.gusto).join(' / ')})`;
                        }
                        
                        const paidMods = allModifiers.filter(mod => mod.prezzo > 0);
                        const freeMods = allModifiers.filter(mod => mod.prezzo === 0);
                        
                        // Nota: il costo è già incluso nel totale item, qui si dettaglia solo
                        if (paidMods.length > 0) {
                            summary += `\n   - Supplementi a pagamento: ${paidMods.map(m => m.nome + ' (+€' + m.prezzo.toFixed(2) + ')').join(', ')}`;
                        }
                        
                        // Modificatori gratuiti/senza costo
                        if (freeMods.length > 0) {
                            summary += `\n   - Modifiche senza costo: ${freeMods.map(m => m.nome).join(', ')}`;
                        }
                    });
                    
                    if (order.mode === 'consegna' && this.deliveryCost > 0) {
                        summary += `\n\nCosto Consegna (${order.zone}): +€${(order.total - order.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0)).toFixed(2)}`;
                    }
                    
                    summary += `\n\n*TOTALE DA PAGARE: €${order.total.toFixed(2)}*`;
                    
                    if (order.restoDaDare > 0) {
                        summary += `\n(Anticipo Versato: €${order.accontoRicevuto.toFixed(2)}. Resto da Dare: *€${order.restoDaDare.toFixed(2)}*)`;
                    }

                    return summary;
                },

                // --- Logica Storico e Statistiche ---
                calculateDriverStats() {
                    const date = this.archiveDateFilter;
                    const driverName = this.selectedDriver;
                    let totalOrders = 0;
                    let totalRevenue = 0;

                    this.archive.forEach(order => {
                        if (order.date === date && order.mode === 'consegna') {
                            if (!driverName || order.driver === driverName) {
                                totalOrders++;
                                totalRevenue += order.total;
                            }
                        }
                    });

                    this.driverStats = { totalOrders, totalRevenue };
                },
                updateArchiveDriver(id, driverName) {
                    const order = this.archive.find(o => o.id === id);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                        this.calculateDriverStats(); // Ricalcola le statistiche
                    }
                },

                // --- Logica Impostazioni (Menu/Modificatori/Zone) ---
                addCategory() {
                    const name = this.newCategoryName.trim();
                    if (name && !this.menu[name]) {
                        this.menu[name] = [];
                        this.activeSettingsCat = name;
                        this.newCategoryName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Categoria già esistente!");
                    }
                },
                deleteCategory(cat) {
                    if (cat === 'Pizze' || cat === 'Mezzo Metro' || cat === 'Bibite' || cat === 'Dolci') {
                        alert("Non è possibile eliminare le categorie di default.");
                        return;
                    }
                    if (this.menu[cat].length > 0) {
                        alert("Svuota prima la categoria per eliminarla.");
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria "${cat}"?`)) {
                        delete this.menu[cat];
                        this.activeSettingsCat = 'Menu'; // Torna al menu principale delle impostazioni
                        this.saveData();
                    }
                },
                addItemToCategory() {
                    const cat = this.activeSettingsCat;
                    const name = this.newItemName.trim();
                    const price = parseFloat(this.newItemPrice);

                    if (name && price >= 0) {
                        const existing = this.menu[cat].some(item => item.nome.toLowerCase() === name.toLowerCase());
                        if (existing) {
                            alert("Articolo già esistente in questa categoria!");
                            return;
                        }
                        
                        let newItem = { nome: name, prezzo: price };
                        
                        // --- LOGICA CORRETTA PER ARTICOLI SPECIALI ---
                        const lowerName = name.toLowerCase();
                        const lowerCat = cat.toLowerCase();
                        
                        if (lowerName.includes("metà") || lowerName.includes("mezzo") || lowerCat.includes("pizza metà") || lowerCat.includes("metà pizza")) {
                            newItem.isHalfPizza = true;
                            // Set prezzo base a 0.00 se è un articolo a metà prezzo
                            if (cat === 'Pizze' && lowerName.includes("pizza metà base")) newItem.prezzo = 0.00;
                            
                        } else if (lowerName.includes("mezzo metro") || lowerName.includes("schiacciata grande") || lowerCat.includes("mezzo metro")) {
                            newItem.isMeter = true;
                            
                            // Definisce sezioni di default
                            if (lowerName.includes("due") || lowerName.includes("2")) {
                                newItem.sections = [{name:"Metà A", size:0.5}, {name:"Metà B", size:0.5}];
                            } else if (lowerName.includes("tre") || lowerName.includes("3")) {
                                newItem.sections = [{name:"Terzo 1", size:0.33}, {name:"Terzo 2", size:0.33}, {name:"Terzo 3", size:0.33}];
                            } else { // "Intero" o altro
                                newItem.sections = [{name:"Gusto Unico", size:1}];
                            }
                        }
                        // --- FINE LOGICA ARTICOLI SPECIALI ---

                        this.menu[cat].push(newItem);
                        this.newItemName = '';
                        this.newItemPrice = 0;
                        this.saveData();
                    }
                },
                deleteItem(cat, index) {
                    if (confirm(`Sei sicuro di voler eliminare l'articolo "${this.menu[cat][index].nome}"?`)) {
                        this.menu[cat].splice(index, 1);
                        this.saveData();
                    }
                },
                toggleItemFinished(cat, index) {
                    const item = this.menu[cat][index];
                    item.isFinished = !item.isFinished;
                    this.saveData();
                    // Assicurarsi che l'item non sia nel carrello se viene marcato come finito.
                    this.order = this.order.filter(o => o.nome !== item.nome);
                    this.selectedItemIndex = null;
                },

                // Modificatori
                isDefaultModifierCategory(cat) {
                    return ['Più', 'Senza', 'Poco', 'Abbondante'].includes(cat);
                },
                addModifierCategory() {
                    const name = this.newModifierCategoryName.trim();
                    if (name && !this.modifiers[name]) {
                        this.modifiers[name] = [];
                        this.activeSettingsModCat = name;
                        this.newModifierCategoryName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Categoria modificatori già esistente!");
                    }
                },
                deleteModifierCategory(cat) {
                    if (this.isDefaultModifierCategory(cat)) {
                        alert("Non è possibile eliminare le categorie modificatori di default.");
                        return;
                    }
                     if (this.modifiers[cat].length > 0) {
                        alert("Svuota prima la categoria per eliminarla.");
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria modificatori "${cat}"?`)) {
                        delete this.modifiers[cat];
                        this.activeSettingsModCat = 'Più';
                        this.saveData();
                    }
                },
                addModifierToCategory() {
                    const cat = this.activeSettingsModCat;
                    const name = this.newModifierName.trim();
                    const price = parseFloat(this.newModifierPrice);

                    if (name && price >= 0) {
                        const existing = this.modifiers[cat].some(mod => mod.nome.toLowerCase() === name.toLowerCase());
                        if (existing) {
                            alert("Modificatore già esistente in questa categoria!");
                            return;
                        }
                        this.modifiers[cat].push({ nome: name, prezzo: price });
                        this.newModifierName = '';
                        this.newModifierPrice = 0;
                        this.saveData();
                    }
                },
                deleteModifier(cat, index) {
                    if (confirm(`Sei sicuro di voler eliminare il modificatore "${this.modifiers[cat][index].nome}"?`)) {
                        this.modifiers[cat].splice(index, 1);
                        this.saveData();
                    }
                },
                toggleModifierFinished(cat, index) {
                    const mod = this.modifiers[cat][index];
                    mod.isFinished = !mod.isFinished;
                    this.saveData();
                    // Non è necessario rimuoverlo dagli ordini attivi, ma non sarà più selezionabile
                },

                // Zone e Fattorini
                addZone() {
                    const name = this.newZoneName.trim();
                    const price = parseFloat(this.newZonePrice);
                    if (name && price >= 0 && !this.deliveryZones.some(z => z.name === name)) {
                        this.deliveryZones.push({ name, price });
                        this.newZoneName = '';
                        this.newZonePrice = 0;
                        this.saveData();
                    } else if (name) {
                        alert("Zona già esistente o dati non validi.");
                    }
                },
                deleteZone(index) {
                    if (confirm(`Sei sicuro di voler eliminare la zona "${this.deliveryZones[index].name}"?`)) {
                        this.deliveryZones.splice(index, 1);
                        this.saveData();
                    }
                },
                addDriver() {
                    const name = this.newDriverName.trim();
                    if (name && !this.drivers.includes(name)) {
                        this.drivers.push(name);
                        this.newDriverName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Fattorino già esistente.");
                    }
                },
                deleteDriver(index) {
                    if (confirm(`Sei sicuro di voler eliminare il fattorino "${this.drivers[index]}"?`)) {
                        this.drivers.splice(index, 1);
                        this.saveData();
                        this.calculateDriverStats(); // Ricalcola le statistiche
                    }
                },
            }
        });
        app.mount('#app');
    </script>
</body>
</html>
