<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Finanza Smart Definitiva 7.0</title>
  <!-- UI & Charts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family:'Inter',sans-serif; background:#f7f9fc; color:#1e293b; }
    .card { box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.06); }
    .tab-active { border-bottom:3px solid #10b981; color:#10b981; }
    .cta-button { transition:all .2s; box-shadow:0 2px 4px rgba(16,185,129,.4); }
    .bar-container { height:20px; border-radius:9999px; overflow:hidden; display:flex; }
    .bar-income{background:#10b981}.bar-expense{background:#ef4444}
    .bar-addebito{background:#fb923c}.bar-credito{background:#3b82f6}
    #quick-actions{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(to top,#fff,#fff8);padding:10px;box-shadow:0 -2px 10px rgba(0,0,0,.1);z-index:40;}
    /* Dark mode */
    body.dark { background:#0f172a; color:#f1f5f9; }
    body.dark .card { background:#111827; color:#e5e7eb; }
    body.dark input, body.dark select, body.dark textarea { background:#111827; color:#e5e7eb; border-color:#374151; }
    body.dark .bg-white { background:#111827 !important; }
    body.dark .text-gray-700 { color:#e5e7eb !important; }
    body.dark .text-gray-800 { color:#f9fafb !important; }
    body.dark .text-gray-500 { color:#9ca3af !important; }
  </style>
  <!-- Manifest PWA creato al volo -->
  <link id="dynamic-manifest" rel="manifest">
</head>
<body class="min-h-screen">
  <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <div class="flex-1 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Finanza Smart 7.0 üöÄ</h1>
        <p class="text-center text-sm text-gray-500">Attivit√† & Personale</p>
      </div>
      <!-- Dark mode toggle -->
      <button id="theme-toggle"
        class="ml-4 px-3 py-2 rounded-lg border text-sm hover:bg-gray-100 dark:hover:bg-gray-800">
        üåô Dark
      </button>
    </header>

    <!-- Nav -->
    <nav id="navbar" class="flex justify-around bg-white p-2 rounded-xl shadow-lg card"></nav>

    <!-- Content -->
    <div id="content-area" class="mt-4"></div>

    <!-- Quick actions -->
    <div id="quick-actions" class="hidden md:hidden">
      <div class="flex space-x-3 max-w-lg mx-auto">
        <button onclick="quickRegister('true')"
          class="flex-1 bg-emerald-500 text-white p-3 rounded-xl font-bold hover:bg-emerald-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
          üí∞ Registra Entrata
        </button>
        <button onclick="quickRegister('false')"
          class="flex-1 bg-red-500 text-white p-3 rounded-xl font-bold hover:bg-red-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
          üí∏ Registra Uscita
        </button>
      </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
      <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Attenzione</h3>
        <p id="modal-message" class="text-gray-700 mb-4">Messaggio di esempio.</p>
        <div class="flex justify-end space-x-3">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Annulla</button>
          <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 cta-button">Conferma</button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 bg-green-500 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-0" role="alert">
      Azione completata con successo!
    </div>
  </div>

  <script>
  /* =========================
     CONFIG & GLOBAL STATE
  ========================== */
  const LOCAL_STORAGE_KEY = 'smartFinApp_v70';
  const IVA_RATES = [0,4,5,10,22];
  const MAX_RECENT_TRANSACTIONS = 10;
  const DEFAULT_CATEGORIES = ['Affitto','Bollette','Spesa','Marketing','Servizi','Stipendi','Carburante','Ristoranti','Abbonamenti','Altro'];

  let appData = {
    invoices: [],
    expenses: [],
    reminders: [],
    contacts: [],
    categories: DEFAULT_CATEGORIES.slice(),
    lastId: 0
  };
  let currentPage = 'report';

  /* =========================
     THEME (DARK MODE)
  ========================== */
  function applySavedTheme(){
    const saved = localStorage.getItem('theme') || 'light';
    document.body.classList.toggle('dark', saved === 'dark');
    const btn = document.getElementById('theme-toggle');
    if (btn) btn.textContent = saved === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
  }
  function toggleTheme(){
    const isDark = document.body.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    applySavedTheme();
  }

  /* =========================
     STORAGE
  ========================== */
  function loadData(){
    try{
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (raw){
        const parsed = JSON.parse(raw);
        appData = { ...appData, ...parsed };
        appData.invoices ||= [];
        appData.expenses ||= [];
        appData.reminders ||= [];
        appData.contacts ||= [];
        appData.categories ||= DEFAULT_CATEGORIES.slice();
        appData.lastId ||= 0;
      }
    }catch(e){ console.error(e); showToast('Errore nel caricamento dati','red'); }
  }
  function saveData(){
    try{ localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData)); }
    catch(e){ console.error(e); showToast('Errore salvataggio dati','red'); }
  }
  function getNextId(){ appData.lastId++; saveData(); return appData.lastId; }

  /* =========================
     UI HELPERS
  ========================== */
  function showModal(title,message,isConfirmation,onConfirm,onCancel=null){
    const modal = document.getElementById('modal');
    const t = document.getElementById('modal-title'); const m = document.getElementById('modal-message');
    const ok = document.getElementById('modal-confirm-btn'); const cancel = document.getElementById('modal-cancel-btn');
    t.textContent = title; m.textContent = message;
    if (isConfirmation){
      ok.textContent = 'Conferma';
      ok.classList.remove('bg-gray-500','hover:bg-gray-600');
      ok.classList.add('bg-red-600','hover:bg-red-700');
      ok.onclick = ()=>{ modal.classList.add('hidden'); onConfirm&&onConfirm(); };
      cancel.classList.remove('hidden'); cancel.onclick = ()=>{ modal.classList.add('hidden'); onCancel&&onCancel(); };
    } else {
      ok.textContent='OK';
      ok.classList.remove('bg-red-600','hover:bg-red-700');
      ok.classList.add('bg-gray-500','hover:bg-gray-600');
      ok.onclick = ()=> modal.classList.add('hidden');
      cancel.classList.add('hidden');
    }
    modal.classList.remove('hidden');
  }
  function showToast(message,type='green'){
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-100 ${type==='red'?'bg-red-500':'bg-green-500'}`;
    setTimeout(()=>toast.classList.add('opacity-0'), 2500);
  }

  /* =========================
     QUICK REGISTER
  ========================== */
  function quickRegister(isIncomeString){
    const isIncome = isIncomeString === 'true';
    document.getElementById('transaction-form-anchor')?.scrollIntoView({behavior:'smooth'});
    const isIncomeSelect = document.getElementById('isIncome');
    if (isIncomeSelect){
      isIncomeSelect.value = isIncomeString;
      isIncomeSelect.dispatchEvent(new Event('change'));
    }
    const form = document.getElementById('transaction-form');
    if (form){
      form.removeAttribute('data-transaction-id'); form.reset();
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn){
        submitBtn.textContent='Registra Movimento';
        submitBtn.classList.remove('bg-blue-500','hover:bg-blue-600');
        submitBtn.classList.add('bg-emerald-500','hover:bg-emerald-600');
      }
    }
    const incomeTypeSelect = document.getElementById('incomeType');
    if (incomeTypeSelect && isIncome){ incomeTypeSelect.value='Fattura (Cliente)'; incomeTypeSelect.dispatchEvent(new Event('change')); }
    showToast(isIncome?'Modulo pronto per Entrata!':'Modulo pronto per Uscita!');
  }

  /* =========================
     PERIOD FILTERS & SUMMARY
  ========================== */
  function filterByPeriod(itemDateStr, filterType, filterValue){
    if (filterType==='all'||!filterValue||filterValue==='all') return true;
    const itemDate = new Date(itemDateStr); if (isNaN(itemDate)) return false;
    const y=itemDate.getFullYear(), m=itemDate.getMonth();
    if (filterType==='year'){ return y===parseInt(filterValue); }
    if (filterType==='month'){ const [fy,fm]=filterValue.split('-').map(Number); return y===fy && m===(fm-1); }
    if (filterType==='quarter'){ const [fy,fm]=filterValue.split('-').map(Number); return y===fy && Math.ceil((m+1)/3)===Math.ceil(fm/3); }
    if (filterType==='day'){ return itemDateStr===filterValue; }
    if (filterType==='week'){
      const d=new Date(filterValue);
      const w=d.getDay();
      const start=new Date(d); start.setDate(d.getDate()-(w===0?6:w-1)); start.setHours(0,0,0,0);
      const end=new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
      return itemDate>=start && itemDate<=end;
    }
    return false;
  }

  function calculateFinancialSummary(type, filterType, filterDateStr){
    let totalIncomes=0,totalExpenses=0, ivaAddebito=0, ivaCredito=0;
    const types = type==='global' ? ['activity','personal'] : [type];
    const all = [
      ...appData.invoices.map(t=>({...t,isIncome:true,key:'inv'})),
      ...appData.expenses.map(t=>({...t,isIncome:false,key:'exp'}))
    ];
    const filtered = all.filter(i=>types.includes(i.type)).filter(i=>filterByPeriod(i.date,filterType,filterDateStr));
    filtered.forEach(i=>{
      if (i.isIncome){ totalIncomes+=i.gross; if (i.type==='activity') ivaAddebito+=i.vatAmount; }
      else { totalExpenses+=i.gross; if (i.type==='activity') ivaCredito+=i.vatAmount; }
    });
    const netBalance=totalIncomes-totalExpenses;
    const ivaBalance=ivaAddebito-ivaCredito;
    return { totalIncomes,totalExpenses,netBalance,ivaAddebito,ivaCredito,ivaBalance, transactions: filtered.sort((a,b)=> new Date(b.date)-new Date(a.date)) };
  }

  /* =========================
     CONTACTS & CATEGORIES
  ========================== */
  function addContact(name, scope, relation){
    const clean=(name||'').trim(); if(!clean) return;
    const exists=appData.contacts.find(c=> c.name.toLowerCase()===clean.toLowerCase() && c.scope===scope );
    if(!exists){ appData.contacts.push({id:getNextId(), name:clean, scope, relation}); saveData(); }
  }
  function deleteContact(id){
    const i=appData.contacts.findIndex(c=>c.id===id);
    if (i>-1){
      showModal('Eliminare contatto?','Le transazioni restano ma senza suggerimenti autocomplete.',true,()=>{
        appData.contacts.splice(i,1); saveData(); showToast('Contatto eliminato.','red'); renderPage('settings');
      });
    }
  }
  function ensureCategory(cat){
    const c=(cat||'').trim(); if(!c) return;
    if (!appData.categories.includes(c)){ appData.categories.push(c); appData.categories.sort((a,b)=>a.localeCompare(b)); saveData(); }
  }

  /* =========================
     TRANSACTIONS CRUD
  ========================== */
  function saveTransaction(isIncome, data){
    const list = isIncome ? appData.invoices : appData.expenses;
    const vatRate = parseFloat(data.vatRate)||0;
    const net = parseFloat(data.net)||0;
    const vatAmount = (net*vatRate/100);
    const gross = net+vatAmount;
    const tags = (data.tags||'').split(',').map(s=>s.trim()).filter(Boolean);

    const updatedItem = {
      id: data.id || getNextId(),
      type: data.dataType, // 'activity' | 'personal'
      date: data.date,
      description: data.description || '',
      category: (data.category||'Altro').trim(),
      tags,
      net:+net.toFixed(2),
      vatRate:+vatRate,
      vatAmount:+vatAmount.toFixed(2),
      gross:+gross.toFixed(2),
      incomeType: data.incomeType || (isIncome && data.dataType==='activity' ? 'Fattura (Cliente)' : null)
    };

    const isFatturaOrPersonal = (isIncome && data.dataType==='activity' && data.incomeType==='Fattura (Cliente)') || data.dataType==='personal';
    if (isFatturaOrPersonal && updatedItem.description?.trim()){
      if (!data.id || (list.find(it=>it.id===data.id)?.description !== data.description)){
        addContact(updatedItem.description, data.dataType, isIncome?'client':'supplier');
      }
    }
    ensureCategory(updatedItem.category);

    if (isIncome && data.dataType==='activity' && data.incomeType==='Incasso/Corrispettivo'){
      updatedItem.description = updatedItem.description || 'Corrispettivi/Incasso Giornaliero';
    }

    if (data.id){
      const idx=list.findIndex(i=>i.id===data.id);
      if (idx>-1){ list[idx]=updatedItem; showToast(`Transazione #${data.id} aggiornata!`); }
    } else { list.push(updatedItem); showToast(`"${updatedItem.description}" registrato!`); }

    saveData(); renderPage(currentPage);
  }

  function handleTransactionSubmit(type){
    const form = document.getElementById('transaction-form');
    const data = new FormData(form);
    const isIncome = data.get('isIncome')==='true';
    const transactionId = form.getAttribute('data-transaction-id');

    const payload = {
      id: transactionId ? parseInt(transactionId) : null,
      dataType: type,
      isIncome,
      date: data.get('date'),
      description: data.get('description'),
      net: data.get('net'),
      vatRate: data.get('vatRate'),
      incomeType: data.get('incomeType'),
      category: data.get('category') || 'Altro',
      tags: data.get('tags') || ''
    };

    const isCorrisp = type==='activity' && isIncome && payload.incomeType==='Incasso/Corrispettivo';
    if (payload.net && payload.date && (isCorrisp || (payload.description && payload.description.trim()))){
      saveTransaction(isIncome, payload);
      form.reset();
      form.removeAttribute('data-transaction-id');
      document.getElementById('description-div')?.classList.remove('hidden');
    } else {
      showToast('Compila tutti i campi richiesti.','red');
    }
  }

  function editTransaction(isIncome,id,scope){
    const list = isIncome ? appData.invoices : appData.expenses;
    const item = list.find(t=>t.id===id);
    if (!item) return showToast('Transazione non trovata.','red');
    renderPage(scope);
    const form = document.getElementById('transaction-form'); if(!form) return;
    form.setAttribute('data-transaction-id', item.id);
    document.getElementById('isIncome').value = isIncome ? 'true':'false';
    document.getElementById('date').value = item.date;
    document.getElementById('description').value = item.description || '';
    document.getElementById('net-amount').value = item.net.toFixed(2);
    document.getElementById('vat-rate').value = item.vatRate;
    document.getElementById('category').value = item.category || 'Altro';
    document.getElementById('tags').value = (item.tags||[]).join(', ');
    if (scope==='activity' && isIncome){ document.getElementById('incomeType').value = item.incomeType || 'Fattura (Cliente)'; }
    setupActivityIncomeTypeListeners(scope);
    setupContactAutocomplete(scope);
    setupCategoryAutocomplete();
    calculateGross();
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = `Salva Modifiche (ID ${item.id})`;
    submitBtn.classList.remove('bg-emerald-500','hover:bg-emerald-600');
    submitBtn.classList.add('bg-blue-500','hover:bg-blue-600');
    showToast(`Modulo in modifica per ID ${item.id}.`);
  }

  function deleteTransaction(isIncome,id){
    const listName = isIncome ? 'invoices':'expenses';
    const idx = appData[listName].findIndex(i=>i.id===id);
    if (idx>-1){
      showModal('Eliminare la transazione?','Operazione irreversibile.',true,()=>{
        appData[listName].splice(idx,1); saveData(); showToast('Transazione eliminata.','red'); renderPage(currentPage);
      });
    }
  }

  /* =========================
     REMINDERS
  ========================== */
  function saveReminder(data){
    appData.reminders ||= [];
    if (data.id){
      const i=appData.reminders.findIndex(r=>r.id===data.id);
      if(i>-1) appData.reminders[i]={...appData.reminders[i],...data};
    } else {
      appData.reminders.push({ id:getNextId(), ...data, paid:false });
    }
    saveData(); showToast('Promemoria salvato!'); renderPage('reminders');
  }
  function handleReminderSubmit(){
    const f=document.getElementById('reminder-form'); const d=new FormData(f);
    const payload={ type:d.get('type'), description:d.get('description'), date:d.get('date'), amount: parseFloat(d.get('amount'))||0 };
    if (payload.description && payload.date && payload.amount>0){ saveReminder(payload); f.reset(); document.getElementById('reminder-date').value = new Date().toISOString().slice(0,10); }
    else showToast('Compila tutti i campi validi.','red');
  }
  function toggleReminderPaid(id){
    const r=(appData.reminders||[]).find(x=>x.id===id);
    if (r){ r.paid=!r.paid; saveData(); showToast(r.paid?'Pagamento registrato!':'Pagamento annullato.'); renderPage('reminders'); }
  }
  function deleteReminder(id){
    const i=(appData.reminders||[]).findIndex(r=>r.id===id);
    if (i>-1){
      showModal('Eliminare promemoria?','Operazione irreversibile.',true,()=>{
        appData.reminders.splice(i,1); saveData(); showToast('Promemoria eliminato.','red'); renderPage('reminders');
      });
    }
  }

  /* =========================
     FORM LOGIC (autocomplete)
  ========================== */
  function setupActivityIncomeTypeListeners(scope){
    if (scope!=='activity') return;
    const incomeTypeSelect = document.getElementById('incomeType');
    const isIncomeSelect = document.getElementById('isIncome');
    const descriptionDiv = document.getElementById('description-div');

    const updateVisibility = ()=>{
      const isIncome = isIncomeSelect.value==='true';
      const incomeType = incomeTypeSelect?.value || 'Fattura (Cliente)';
      if (isIncome && incomeType==='Incasso/Corrispettivo'){
        descriptionDiv.classList.add('hidden');
        const desc = document.getElementById('description');
        desc.removeAttribute('required'); desc.value='Corrispettivi/Incasso Giornaliero';
        document.getElementById('description-label').textContent='Descrizione Incasso (Opzionale)';
      } else {
        descriptionDiv.classList.remove('hidden');
        const desc = document.getElementById('description');
        desc.setAttribute('required','required');
        if (document.getElementById('transaction-form').getAttribute('data-transaction-id')===null){ desc.value=''; }
        document.getElementById('description-label').textContent = isIncome ? 'Cliente / Descrizione' : 'Fornitore / Descrizione';
        setupContactAutocomplete(scope);
      }
    };

    incomeTypeSelect?.addEventListener('change', updateVisibility);
    isIncomeSelect.addEventListener('change', ()=>{
      const isIncome=isIncomeSelect.value==='true';
      const ctl=document.getElementById('income-type-control');
      if (scope==='activity' && ctl){ ctl.classList.toggle('hidden', !isIncome); }
      updateVisibility();
    });
    updateVisibility();
  }

  function setupContactAutocomplete(scope){
    const isIncome = document.getElementById('isIncome').value==='true';
    const incomeType = document.getElementById('incomeType')?.value;
    const input = document.getElementById('description');
    const datalist = document.getElementById('contact-list');
    if (!input || !datalist) return;

    if (scope==='activity' && isIncome && incomeType==='Incasso/Corrispettivo'){ datalist.innerHTML=''; return; }
    const relation = isIncome ? 'client':'supplier';
    const contacts = appData.contacts
      .filter(c=> c.scope===scope && (c.relation===relation || c.relation==='both'))
      .sort((a,b)=> a.name.localeCompare(b.name));
    datalist.innerHTML = contacts.map(c=> `<option value="${c.name}"></option>`).join('');
    input.setAttribute('list','contact-list');
  }

  function setupCategoryAutocomplete(){
    const dl = document.getElementById('category-list');
    if (!dl) return;
    const all = (appData.categories||DEFAULT_CATEGORIES).slice().sort((a,b)=>a.localeCompare(b));
    dl.innerHTML = all.map(c=> `<option value="${c}"></option>`).join('');
  }

  function calculateGross(){
    const netInput=document.getElementById('net-amount');
    const vatSelect=document.getElementById('vat-rate');
    const vatAmountDisplay=document.getElementById('vat-amount-display');
    const grossAmountDisplay=document.getElementById('gross-amount-display');
    const net=parseFloat(netInput.value)||0; const rate=parseFloat(vatSelect.value)||0;
    const vatAmt=net*rate/100; const gross=net+vatAmt;
    vatAmountDisplay.textContent = vatAmt.toFixed(2)+' ‚Ç¨';
    grossAmountDisplay.textContent = gross.toFixed(2)+' ‚Ç¨';
  }
        /* =========================
     EXPORT / IMPORT
  ========================== */
  function exportDataJSON(){
    const blob=new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='backup.json';a.click();
  }
  function exportCSV(){
    const all=[...appData.invoices.map(t=>({...t,isIncome:true})),...appData.expenses.map(t=>({...t,isIncome:false}))];
    const rows=all.map(t=>[t.id,t.date,t.description,t.category,t.net,t.vatRate,t.vatAmount,t.gross,t.isIncome]);
    const csv='ID,Data,Descrizione,Categoria,Netto,IVA%,IVA,Lordo,Entrata\n'+rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);a.download='export.csv';a.click();
  }
  function importCSV(file){
    const reader=new FileReader();
    reader.onload=e=>{
      const lines=e.target.result.split('\n').slice(1);
      lines.forEach(l=>{
        const [id,date,desc,cat,net,vatRate,vatAmount,gross,isIncome]=l.split(',');
        if(date){
          const obj={id:getNextId(),date,description:desc,category:cat,net:parseFloat(net),vatRate:parseFloat(vatRate),vatAmount:parseFloat(vatAmount),gross:parseFloat(gross),isIncome:isIncome==='true'};
          if(obj.isIncome) appData.invoices.push(obj); else appData.expenses.push(obj);
        }
      });
      saveData();showToast('Import CSV completato');renderPage('report');
    };
    reader.readAsText(file);
  }

  /* =========================
     REMINDER NOTIFICATIONS
  ========================== */
  function checkReminders(){
    const today=new Date();
    (appData.reminders||[]).forEach(r=>{
      const diff=(new Date(r.date)-today)/(1000*60*60*24);
      if(!r.paid && diff>=0 && diff<=3){
        if(Notification.permission==='granted'){
          new Notification(`üîî ${r.type}`,{body:`${r.description} - scade il ${new Date(r.date).toLocaleDateString('it-IT')}`});
        }
      }
    });
  }

  /* =========================
     DASHBOARD KPI + CHART
  ========================== */
  function calcSummary(){
    const inc=[...appData.invoices].reduce((a,t)=>a+t.gross,0);
    const exp=[...appData.expenses].reduce((a,t)=>a+t.gross,0);
    const saving=inc>0?((inc-exp)/inc*100):0;
    return{inc,exp,saving};
  }
  function renderTrendChart(){
    const ctx=document.getElementById('trend');if(!ctx)return;
    const grouped={};
    [...appData.invoices.map(t=>({...t,isIncome:true})),...appData.expenses.map(t=>({...t,isIncome:false}))]
    .forEach(t=>{
      const ym=t.date.slice(0,7);
      if(!grouped[ym])grouped[ym]={inc:0,exp:0};
      if(t.isIncome)grouped[ym].inc+=t.gross;else grouped[ym].exp+=t.gross;
    });
    const labels=Object.keys(grouped).sort();
    const dataInc=labels.map(l=>grouped[l].inc);
    const dataExp=labels.map(l=>grouped[l].exp);
    new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Entrate',data:dataInc,borderColor:'green'},{label:'Uscite',data:dataExp,borderColor:'red'}]}});
  }

  /* =========================
     NAVBAR & PAGES
  ========================== */
  function renderNavbar(){
    const nav=[{id:'activity',label:'Attivit√†',icon:'üíº'},{id:'personal',label:'Personale',icon:'üè†'},{id:'report',label:'Riepilogo',icon:'üìä'},{id:'reminders',label:'Scadenze',icon:'üîî'},{id:'settings',label:'Dati',icon:'‚öôÔ∏è'}];
    document.getElementById('navbar').innerHTML=nav.map(n=>`<button onclick="renderPage('${n.id}')" class="${currentPage===n.id?'tab-active':''}">${n.icon} ${n.label}</button>`).join('');
  }

  function renderPage(p){
    currentPage=p;renderNavbar();
    if(p==='report'){
      const s=calcSummary();
      document.getElementById('content-area').innerHTML=`
        <div class="card p-4">
          <h2 class="text-xl font-bold">üìä Dashboard</h2>
          <p>Entrate: ${s.inc.toFixed(2)} ‚Ç¨</p>
          <p>Uscite: ${s.exp.toFixed(2)} ‚Ç¨</p>
          <p>Risparmio: ${s.saving.toFixed(1)}%</p>
          <input id="search" placeholder="üîç Cerca" class="border p-1 mt-2 w-full"/>
          <div id="results"></div>
          <canvas id="trend" class="mt-4"></canvas>
          <div class="mt-4 flex space-x-2">
            <button onclick="exportDataJSON()" class="bg-blue-500 text-white px-3 py-2 rounded">Export JSON</button>
            <button onclick="exportCSV()" class="bg-green-500 text-white px-3 py-2 rounded">Export CSV</button>
            <input type="file" onchange="importCSV(this.files[0])" class="border"/>
          </div>
        </div>`;
      renderTrendChart();
      document.getElementById('search').addEventListener('input',e=>{
        const q=e.target.value.toLowerCase();
        const all=[...appData.invoices.map(t=>({...t,isIncome:true})),...appData.expenses.map(t=>({...t,isIncome:false}))];
        const f=all.filter(t=>(t.description||'').toLowerCase().includes(q)||t.category.toLowerCase().includes(q)||t.gross.toString().includes(q));
        document.getElementById('results').innerHTML=f.map(t=>`<div class="border-b">${t.date} ${t.description} ${t.gross}‚Ç¨</div>`).join('');
      });
    }
    if(p==='settings'){
      document.getElementById('content-area').innerHTML=`
        <div class="card p-4">
          <h2 class="text-xl font-bold">‚öôÔ∏è Impostazioni</h2>
          <button onclick="localStorage.clear();location.reload()" class="mt-2 bg-red-500 text-white px-3 py-2 rounded">Reset Dati</button>
        </div>`;
    }
    if(p==='reminders'){
      document.getElementById('content-area').innerHTML=`
        <div class="card p-4">
          <h2>üîî Promemoria</h2>
          ${(appData.reminders||[]).map(r=>`<div>${r.description} ${r.date}</div>`).join('')}
        </div>`;
    }
    if(p==='activity'||p==='personal'){
      document.getElementById('content-area').innerHTML=`
        <div class="card p-4">
          <h2>${p==='activity'?'üíº Attivit√†':'üè† Personale'}</h2>
          <form onsubmit="event.preventDefault();addTx('${p}')">
            <input id="desc" placeholder="Descrizione" class="border p-2"/>
            <input id="val" type="number" step="0.01" placeholder="Netto" class="border p-2"/>
            <select id="cat">${appData.categories.map(c=>`<option>${c}</option>`).join('')}</select>
            <button class="bg-emerald-500 text-white px-3 py-2">Aggiungi</button>
          </form>
        </div>`;
    }
  }

  function addTx(scope){
    const d=document.getElementById('desc').value;
    const v=parseFloat(document.getElementById('val').value)||0;
    const cat=document.getElementById('cat').value;
    const obj={id:getNextId(),type:scope,date:new Date().toISOString().slice(0,10),description:d,category:cat,net:v,vatRate:22,vatAmount:v*0.22,gross:v*1.22};
    if(scope==='activity')appData.invoices.push(obj);else appData.expenses.push(obj);
    saveData();showToast('Transazione aggiunta!');renderPage(scope);
  }

  /* =========================
     PWA
  ========================== */
  function installManifest(){
    const manifest={name:"Finanza Smart",short_name:"Finanza",start_url:".",display:"standalone",theme_color:"#10b981"};
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    document.getElementById('dynamic-manifest').href=URL.createObjectURL(blob);
  }
  async function installServiceWorker(){
    if(!('serviceWorker'in navigator))return;
    const sw=`self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)))})`;
    const blob=new Blob([sw],{type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob));
  }

  /* =========================
     INIT
  ========================== */
  window.onload=()=>{
    applySavedTheme();
    document.getElementById('theme-toggle').onclick=toggleTheme;
    loadData();
    renderPage('report');
    if(Notification.permission!=='granted')Notification.requestPermission();
    setInterval(checkReminders,3600000);
    installManifest();installServiceWorker();
  }
  </script>
</body>
</html>
