<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Biliora - Demo Finanze (Login + Backup)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --btn:#2563eb; --btnH:#1d4ed8; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; margin: 24px; background: var(--bg); color:#111827; }
  h1 { text-align:center; margin: 0 0 16px; }
  .card { background: var(--card); border:1px solid var(--border); border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); max-width: 980px; margin: 0 auto; padding: 20px; }
  label { display:block; margin-top:10px; font-weight:600; }
  input, select { width: 100%; padding: 10px; margin-top: 6px; border:1px solid var(--border); border-radius:8px; background:#fff; }
  button { background: var(--btn); color:#fff; border:none; padding:10px 14px; margin-top:12px; border-radius:8px; cursor:pointer; }
  button:hover { background: var(--btnH); }
  .muted { color:#6b7280; }
  .row { display:flex; flex-wrap:wrap; gap:12px; margin-top:8px; }
  .row>div { flex:1; min-width: 160px; }
  table { width:100%; border-collapse: collapse; margin-top:16px; }
  th, td { border:1px solid var(--border); padding:8px; text-align:center; }
  th { background:#f3f4f6; }
  .totali { margin-top:12px; text-align:center; font-weight:700; }
  .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .danger { background:#ef4444; } .danger:hover{ background:#dc2626; }
  .ghost { background:#fff; color:#111827; border:1px solid var(--border); }
  .ghost:hover{ background:#f9fafb; }
  .tag { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; }
  .flex-between{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .dropzone { border:2px dashed var(--border); border-radius:10px; padding:12px; text-align:center; }
  .hide { display:none; }
</style>
</head>
<body>

<h1>üí∂ Biliora ‚Äì Gestione Finanze (Demo Locale)</h1>

<!-- ======= LOGIN CARD ======= -->
<div id="loginCard" class="card">
  <h2>Accesso locale</h2>
  <p class="muted">Demo senza backend. Ogni utente √® salvato solo in questo browser.</p>
  <div class="row">
    <div>
      <label>Nome utente</label>
      <input id="loginUser" placeholder="es. mario.rossi" />
    </div>
    <div>
      <label>Password (solo per accesso locale)</label>
      <input id="loginPass" type="password" placeholder="qualsiasi valore" />
    </div>
    <div style="align-self:flex-end;">
      <button onclick="login()">Entra</button>
    </div>
  </div>
  <p class="muted" style="margin-top:8px;">Suggerimento: prova utenti diversi per separare i dati (es. ‚Äútest1‚Äù, ‚Äútest2‚Äù).</p>
</div>

<!-- ======= APP CARD ======= -->
<div id="appCard" class="card hide">

  <div class="flex-between">
    <div>
      <div class="tag">Utente: <span id="userBadge"></span></div>
    </div>
    <div class="toolbar">
      <button class="ghost" onclick="exportJSON()">‚¨áÔ∏è Esporta JSON</button>
      <label class="ghost" style="padding:10px 14px; display:inline-block; cursor:pointer;">
        ‚¨ÜÔ∏è Importa JSON <input id="fileInput" type="file" accept="application/json" class="hide" />
      </label>
      <button class="ghost" onclick="toggleDrop()">üìÇ Trascina JSON</button>
      <button class="ghost" onclick="logout()">Esci</button>
      <button class="danger" onclick="resetta()">üóëÔ∏è Reset dati</button>
    </div>
  </div>

  <div id="dropArea" class="dropzone hide">Trascina qui un file <b>.json</b> di backup per importare i movimenti</div>

  <hr style="margin:16px 0;">

  <div class="row">
    <div>
      <label>Descrizione</label>
      <input id="descrizione" type="text" />
    </div>
    <div>
      <label>Importo (‚Ç¨)</label>
      <input id="importo" type="number" step="0.01" />
    </div>
    <div>
      <label>Tipo</label>
      <select id="tipo">
        <option value="entrata">Entrata</option>
        <option value="uscita">Uscita</option>
      </select>
    </div>
    <div>
      <label>Aliquota IVA (%)</label>
      <select id="aliquota">
        <option value="22">22%</option>
        <option value="10">10%</option>
        <option value="5">5%</option>
        <option value="4">4%</option>
        <option value="0">0%</option>
      </select>
    </div>
    <div style="align-self:flex-end;">
      <button onclick="aggiungiMovimento()">Aggiungi</button>
    </div>
  </div>

  <hr style="margin:16px 0;">

  <div class="row">
    <div>
      <label>Filtra per mese</label>
      <input id="meseFiltro" type="month" onchange="aggiorna()" />
    </div>
    <div>
      <label>Tipo movimento</label>
      <select id="tipoFiltro" onchange="aggiorna()">
        <option value="tutti">Tutti</option>
        <option value="entrata">Entrate</option>
        <option value="uscita">Uscite</option>
      </select>
    </div>
    <div style="align-self:flex-end;" class="toolbar">
      <button class="ghost" onclick="esportaCSV()">üìÑ Esporta CSV</button>
      <button onclick="generaPDF()">üßæ Report IVA PDF</button>
    </div>
  </div>

  <table id="tabella">
    <thead>
      <tr><th>Data</th><th>Descrizione</th><th>Tipo</th><th>Aliquota</th><th>Imponibile</th><th>IVA</th><th>Totale</th><th></th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totali" id="totali"></div>

  <canvas id="grafico" height="120"></canvas>
</div>

<script>
/* ========= UTIL GENERALI ========= */
const $ = (id)=>document.getElementById(id);
const qs = (sel)=>document.querySelector(sel);
let currentUser = null;
let movimenti = []; // dataset dell'utente corrente
let chart; const ctx = $("grafico");

/* ========= STORAGE PER UTENTE ========= */
function storageKey(){ return `movimenti__${currentUser}`; }
function loadForUser(user){
  currentUser = user;
  const raw = localStorage.getItem(storageKey());
  movimenti = raw ? JSON.parse(raw) : [];
}
function saveForUser(){
  localStorage.setItem(storageKey(), JSON.stringify(movimenti));
}

/* ========= LOGIN / LOGOUT ========= */
function login(){
  const u = $("loginUser").value.trim();
  const p = $("loginPass").value; // in demo non verifichiamo
  if(!u) { alert("Inserisci un nome utente."); return; }
  // Nota: la password non √® verificata (demo locale, senza backend)
  loadForUser(u.toLowerCase());
  $("userBadge").textContent = currentUser;
  $("loginCard").classList.add("hide");
  $("appCard").classList.remove("hide");
  bindImport();
  aggiorna();
}
function logout(){
  currentUser = null;
  movimenti = [];
  $("loginUser").value = "";
  $("loginPass").value = "";
  $("appCard").classList.add("hide");
  $("loginCard").classList.remove("hide");
}

/* ========= DROPZONE TOGGLE ========= */
function toggleDrop(){ $("dropArea").classList.toggle("hide"); }

/* ========= IVA ========= */
function scorporaIva(totale, aliquota){
  const imp = totale / (1 + aliquota/100);
  const iva = totale - imp;
  return { imponibile: imp, iva };
}

/* ========= CRUD MOVIMENTI ========= */
function aggiungiMovimento(){
  const descrizione = $("descrizione").value.trim();
  const importo = parseFloat($("importo").value);
  const tipo = $("tipo").value;
  const aliquota = parseFloat($("aliquota").value);
  if(!currentUser){ alert("Effettua l'accesso."); return; }
  if(!descrizione || isNaN(importo)) { alert("Compila descrizione e importo."); return; }
  const { imponibile, iva } = scorporaIva(Math.abs(importo), aliquota);
  movimenti.push({
    id: Date.now(),
    data: new Date().toISOString(),
    descrizione, tipo, aliquota,
    imponibile, iva, totale: importo
  });
  saveForUser(); pulisciForm(); aggiorna();
}
function rimuovi(id){
  movimenti = movimenti.filter(m=>m.id!==id);
  saveForUser(); aggiorna();
}
function resetta(){
  if(!currentUser) return;
  if(confirm("Cancellare tutti i dati dell'utente corrente?")){
    movimenti = [];
    saveForUser(); aggiorna();
  }
}
function pulisciForm(){ $("descrizione").value=""; $("importo").value=""; }

/* ========= FILTRI E RENDER ========= */
function filtraMovimenti(){
  const tipoFiltro = $("tipoFiltro").value;
  const meseFiltro = $("meseFiltro").value; // yyyy-mm
  return movimenti.filter(m=>{
    const mese = new Date(m.data).toISOString().slice(0,7);
    let ok = true;
    if(tipoFiltro!=="tutti") ok = ok && m.tipo===tipoFiltro;
    if(meseFiltro) ok = ok && mese===meseFiltro;
    return ok;
  });
}
function aggiorna(){
  if(!currentUser) return;
  const dati = filtraMovimenti();
  const tbody = qs("#tabella tbody"); tbody.innerHTML="";
  let totEntrate=0, totUscite=0;
  dati.forEach(m=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(m.data).toLocaleDateString()}</td>
      <td>${m.descrizione}</td>
      <td>${m.tipo}</td>
      <td>${m.aliquota}%</td>
      <td>${m.imponibile.toFixed(2)}</td>
      <td>${m.iva.toFixed(2)}</td>
      <td>${m.totale.toFixed(2)}</td>
      <td><button class="ghost" onclick="rimuovi(${m.id})">‚úñ</button></td>`;
    tbody.appendChild(tr);
    if(m.tipo==="entrata") totEntrate += m.totale; else totUscite += m.totale;
  });
  const saldo = totEntrate - totUscite;
  $("totali").innerHTML = `
    Entrate: <span style="color:#059669;">‚Ç¨${totEntrate.toFixed(2)}</span> ‚Äî
    Uscite: <span style="color:#dc2626;">‚Ç¨${totUscite.toFixed(2)}</span><br>
    <hr>Saldo: <b>‚Ç¨${saldo.toFixed(2)}</b>`;
  aggiornaGrafico();
}

/* ========= GRAFICO ========= */
function aggiornaGrafico(){
  const mesi={};
  movimenti.forEach(m=>{
    const d=new Date(m.data);
    const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    if(!mesi[k]) mesi[k]={entrate:0, uscite:0};
    if(m.tipo==="entrata") mesi[k].entrate+=m.totale; else mesi[k].uscite+=m.totale;
  });
  const labels = Object.keys(mesi).sort();
  const entrate = labels.map(k=>mesi[k].entrate);
  const uscite = labels.map(k=>mesi[k].uscite);
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label:'Entrate', data: entrate, backgroundColor:'rgba(34,197,94,0.6)' },
      { label:'Uscite', data: uscite, backgroundColor:'rgba(239,68,68,0.6)' }
    ]},
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });
}

/* ========= EXPORT CSV ========= */
function esportaCSV(){
  const rows=[["Data","Descrizione","Tipo","Aliquota","Imponibile","IVA","Totale"]];
  filtraMovimenti().forEach(m=>{
    rows.push([
      new Date(m.data).toLocaleDateString(),
      m.descrizione, m.tipo, `${m.aliquota}%`,
      m.imponibile.toFixed(2), m.iva.toFixed(2), m.totale.toFixed(2)
    ]);
  });
  const csv = rows.map(r=>r.map(escapeCSV).join(",")).join("\n");
  downloadBlob(new Blob([csv], {type:"text/csv"}), `biliora_${currentUser}.csv`);
}
function escapeCSV(v){
  const s=String(v);
  if(s.includes(",")||s.includes('"')||s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
  return s;
}

/* ========= EXPORT / IMPORT JSON ========= */
function exportJSON(){
  const payload = {
    user: currentUser,
    exportedAt: new Date().toISOString(),
    version: 1,
    movimenti
  };
  downloadBlob(new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"}), `biliora_${currentUser}.json`);
}
function bindImport(){
  $("fileInput").onchange = (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    readJSONFile(file, importPayload);
    e.target.value = "";
  };
  const dz = $("dropArea");
  dz.addEventListener("dragover", e=>{ e.preventDefault(); dz.style.background="#f9fafb"; });
  dz.addEventListener("dragleave", e=>{ dz.style.background=""; });
  dz.addEventListener("drop", e=>{
    e.preventDefault(); dz.style.background="";
    const file = e.dataTransfer.files?.[0]; if(file) readJSONFile(file, importPayload);
  });
}
function readJSONFile(file, cb){
  const fr = new FileReader();
  fr.onload = ()=> {
    try { const json = JSON.parse(fr.result); cb(json); }
    catch(e){ alert("File JSON non valido."); }
  };
  fr.readAsText(file);
}
function importPayload(payload){
  if(!payload || !Array.isArray(payload.movimenti)) { alert("Formato JSON non riconosciuto."); return; }
  if(payload.user && payload.user !== currentUser){
    if(!confirm(`Il backup appartiene all'utente "${payload.user}". Importare comunque nei dati di "${currentUser}"?`)) return;
  }
  // merge semplice: concatena e rimuove duplicati per id
  const map = new Map(movimenti.map(m=>[m.id,m]));
  payload.movimenti.forEach(m=>map.set(m.id,m));
  movimenti = Array.from(map.values()).sort((a,b)=>a.id-b.id);
  saveForUser(); aggiorna();
  alert("Import completato.");
}
function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= PDF IVA ========= */
function generaPDF(){
  if(!currentUser){ alert("Effettua l'accesso."); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const meseFiltro = $("meseFiltro").value || new Date().toISOString().slice(0,7);
  const dati = filtraMovimenti();
  let ivaDebito=0, ivaCredito=0;

  doc.setFontSize(16);
  doc.text(`Report IVA - ${meseFiltro}`, 14, 18);
  doc.setFontSize(11);
  doc.text(`Utente: ${currentUser}`, 14, 26);

  let y = 36;
  doc.setFontSize(10);
  doc.text("Data        Descrizione                     Tipo   Aliq   IVA (‚Ç¨)", 14, y); y+=6;
  doc.line(14, y, 196, y); y+=4;

  dati.forEach(m=>{
    const riga = `${new Date(m.data).toLocaleDateString()}  ${truncate(m.descrizione,28).padEnd(28)}  ${m.tipo.padEnd(6)} ${String(m.aliquota).padStart(3)}%  ${m.iva.toFixed(2).padStart(8)}`;
    doc.text(riga, 14, y);
    if(m.tipo==="entrata") ivaDebito += m.iva; else ivaCredito += m.iva;
    y += 6; if(y>270){ doc.addPage(); y=20; }
  });

  y += 4; doc.line(14, y, 196, y); y+=8;
  const due = Math.max(ivaDebito - ivaCredito, 0);
  doc.setFontSize(12);
  doc.text(`IVA a debito:  ‚Ç¨${ivaDebito.toFixed(2)}`, 14, y); y+=6;
  doc.text(`IVA a credito: ‚Ç¨${ivaCredito.toFixed(2)}`, 14, y); y+=6;
  doc.text(`IVA da versare: ‚Ç¨${due.toFixed(2)}`, 14, y);

  doc.save(`biliora_IVA_${currentUser}_${meseFiltro}.pdf`);
}
function truncate(s, n){ return (s||"").length>n ? s.slice(0,n-1)+"‚Ä¶" : s; }

/* ========= INIT ========= */
</script>
</body>
</html>
