<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart POS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        /* Stili Generali e Layout */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        #app { display: flex; max-width: 1600px; margin: 0 auto; height: 100vh; }
        
        /* Layout Principale (3 Colonne) */
        .col-menu { flex: 3; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; overflow: hidden; }
        .col-order { flex: 2; background-color: #f9f9f9; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .col-actions { flex: 1; background-color: #eee; display: flex; flex-direction: column; }
        
        /* Navigazione */
        .nav-bar { display: flex; background-color: #1f2937; color: white; padding: 10px 0; }
        .nav-bar button { background: none; border: none; color: white; padding: 10px 15px; cursor: pointer; font-size: 1.1rem; transition: background-color 0.2s; }
        .nav-bar button:hover { background-color: #374151; }
        .nav-bar button.active { background-color: #0d47a1; }
        .nav-bar .user-info { margin-left: auto; padding: 10px 15px; font-weight: bold; }
        
        /* Header Contenuto */
        .content-header { padding: 10px; background-color: #e5e7eb; border-bottom: 1px solid #ddd; display: flex; align-items: center; }
        .content-header input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; margin-right: 10px; }

        /* Contenuto Menu/Categorie */
        .menu-container { display: flex; flex-grow: 1; overflow: hidden; }
        .menu-categories { width: 150px; background-color: #f3f4f6; overflow-y: auto; border-right: 1px solid #ddd; }
        .menu-categories button { display: block; width: 100%; padding: 15px 10px; border: none; background: none; text-align: left; cursor: pointer; font-size: 1rem; transition: background-color 0.2s; }
        .menu-categories button:hover { background-color: #e5e7eb; }
        .menu-categories button.active { background-color: #0d47a1; color: white; }

        .menu-items { flex-grow: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .item-card { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; position: relative; }
        .item-card:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-card.selected { border-color: #0d47a1; border-width: 3px; }
        .item-card h4 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .item-card p { margin: 0; color: #555; font-size: 1rem; font-weight: bold; }
        .item-card.finished { background-color: #f7d4d4; color: #888; cursor: not-allowed; border: 1px solid #e99; }
        .item-card.finished::before { content: 'ESAURITO'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center; font-weight: bold; color: #cc0000; font-size: 1.5rem; }

        /* Modificatori */
        .modifiers-container { padding: 15px; border-top: 1px solid #ddd; background-color: #f0f0f0; }
        .mod-categories { display: flex; margin-bottom: 10px; }
        .mod-categories button { padding: 8px 15px; border: none; background-color: #ccc; cursor: pointer; transition: background-color 0.2s; margin-right: 5px; border-radius: 4px; }
        .mod-categories button.active { background-color: #0d47a1; color: white; }
        .mod-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; max-height: 120px; overflow-y: auto; }
        .mod-item-btn { background-color: #e0e0e0; border: 1px solid #ccc; padding: 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.1s; font-size: 0.9rem; text-align: center; }
        .mod-item-btn:hover { background-color: #c0c0c0; }
        .mod-item-btn.finished { background-color: #f7d4d4; cursor: not-allowed; opacity: 0.6; }
        .mod-search { margin-bottom: 8px; }

        /* Carrello Ordine */
        .order-list { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: #fff; }
        .order-item { background-color: #fff; border: 1px solid #eee; border-radius: 4px; margin-bottom: 10px; padding: 10px; display: flex; flex-direction: column; transition: background-color 0.1s; position: relative; }
        .order-item.selected { border-left: 5px solid #0d47a1; background-color: #e6f0ff; }
        .item-main { display: flex; justify-content: space-between; align-items: center; }
        .item-info { flex-grow: 1; cursor: pointer; }
        .item-info h5 { margin: 0; font-size: 1.1rem; }
        .item-info p { margin: 0; font-size: 0.9rem; color: #555; }
        .item-actions { display: flex; align-items: center; }
        .item-actions button { background: none; border: none; color: #cc0000; cursor: pointer; margin-left: 10px; font-size: 1rem; }
        
        .item-modifiers-list { list-style: none; padding: 5px 0 0 10px; margin: 0; font-size: 0.85rem; color: #777; }
        .item-modifiers-list li { margin: 2px 0; }
        .item-modifiers-list .mod-section-title { font-weight: bold; color: #333; margin-top: 5px; }

        /* Totale Ordine */
        .order-total { padding: 15px; background-color: #e5e7eb; border-top: 1px solid #ddd; }
        .order-total h3 { margin: 0; display: flex; justify-content: space-between; font-size: 1.5rem; }

        /* Azioni Principali */
        .main-actions { padding: 15px; background-color: #fff; border-top: 1px solid #ddd; }
        .main-actions button { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.2rem; font-weight: bold; transition: background-color 0.2s; }
        .btn-finish { background-color: #4caf50; color: white; }
        .btn-finish:hover { background-color: #43a047; }
        .btn-cancel { background-color: #f44336; color: white; }
        .btn-cancel:hover { background-color: #d32f2f; }
        .btn-print { background-color: #2196f3; color: white; }
        .btn-print:hover { background-color: #1e88e5; }
        .btn-edit-price { background-color: #ff9800; color: white; margin-left: 5px; padding: 5px 10px !important; font-size: 0.9rem !important; }

        /* Modale Generale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; color: #0d47a1; }
        .modal-body { display: grid; gap: 10px; }
        .modal-body label { font-weight: bold; margin-bottom: 5px; display: block; }
        .modal-body input, .modal-body select, .modal-body textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-body select.delivery-zone { width: auto; margin-left: 10px; }
        .modal-footer { margin-top: 20px; text-align: right; }
        .modal-footer button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .modal-footer .btn-save { background-color: #4caf50; color: white; }
        .modal-footer .btn-close { background-color: #ccc; }
        
        /* Modalità Selezione */
        .mode-selection { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .mode-selection button { flex: 1; padding: 15px; border: 2px solid #ddd; background-color: #f9f9f9; cursor: pointer; margin: 0 5px; border-radius: 8px; transition: all 0.2s; }
        .mode-selection button.active { border-color: #0d47a1; background-color: #e6f0ff; color: #0d47a1; }

        /* Suggerimenti Cliente */
        .customer-input-container { position: relative; }
        .customer-suggestions { position: absolute; top: 100%; left: 0; right: 0; background-color: white; border: 1px solid #ddd; border-top: none; z-index: 10; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .customer-suggestions div { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        .customer-suggestions div:hover { background-color: #f0f0f0; }

        /* Vista Ordini Attivi */
        .orders-view { padding: 15px; overflow-y: auto; flex-grow: 1; }
        .order-card { background-color: #fff; border-left: 5px solid #0d47a1; border-radius: 8px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .order-card h4 { margin: 0 0 10px 0; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .order-details { font-size: 0.9rem; color: #555; }
        .order-details p { margin: 5px 0; }
        .order-items-list { list-style: none; padding: 0; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .order-items-list li { margin-bottom: 3px; font-size: 0.95rem; }
        .order-actions { margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap; }
        .order-actions button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn-status { background-color: #0d47a1; color: white; }
        .btn-edit { background-color: #ff9800; color: white; }
        .btn-print-order { background-color: #2196f3; color: white; }
        .btn-share { background-color: #4caf50; color: white; }
        .order-status { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .status-Preparazione { background-color: #ffeb3b; color: #333; }
        .status-InCottura { background-color: #ff9800; color: white; }
        .status-ProntoInConsegna { background-color: #4caf50; color: white; }
        
        .urgent { background-color: #f44336 !important; color: white !important; animation: blink-bg 1s infinite; }
        .near { background-color: #ffeb3b !important; color: #333 !important; }
        @keyframes blink-bg { 0% { background-color: #f44336; } 50% { background-color: #d32f2f; } 100% { background-color: #f44336; } }

        .order-filters { padding: 10px 15px; background-color: #f3f4f6; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        .order-filters input { flex-grow: 1; }
        .order-filters button { background-color: #ccc; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .order-filters button.active { background-color: #0d47a1; color: white; }
        
        /* Vista Storico */
        .archive-filters { padding: 15px; background-color: #f3f4f6; border-bottom: 1px solid #ddd; display: flex; gap: 10px; align-items: center; }
        .archive-filters input, .archive-filters select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .archive-summary { padding: 15px; background-color: #e5e7eb; border-bottom: 1px solid #ddd; font-weight: bold; }

        /* Vista Impostazioni */
        .settings-view { display: flex; flex-grow: 1; overflow: hidden; }
        .settings-nav { width: 200px; background-color: #f3f4f6; overflow-y: auto; border-right: 1px solid #ddd; }
        .settings-nav button { display: block; width: 100%; padding: 15px 10px; border: none; background: none; text-align: left; cursor: pointer; font-size: 1rem; transition: background-color 0.2s; }
        .settings-nav button:hover { background-color: #e5e7eb; }
        .settings-nav button.active { background-color: #0d47a1; color: white; }
        .settings-content { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: #fff; }
        .settings-section h3 { border-bottom: 2px solid #0d47a1; padding-bottom: 5px; margin-top: 0; }
        .settings-group { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item input[type="text"], .settings-item input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        .settings-actions button { padding: 8px 12px; margin-left: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-delete { background-color: #f44336; color: white; }
        .btn-toggle { background-color: #0d47a1; color: white; }
        .btn-add { background-color: #4caf50; color: white; }
        .btn-save-settings { background-color: #2196f3; color: white; }

        /* Login View */
        .login-view { display: flex; justify-content: center; align-items: center; flex-grow: 1; background-color: #f3f4f6; }
        .login-form { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; max-width: 350px; width: 90%; }
        .login-form h2 { color: #0d47a1; margin-bottom: 20px; }
        .login-form input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 1.2rem; text-align: center; }
        .login-form button { width: 100%; padding: 10px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1rem; }

        /* Composizione Modale (Mezzo Metro / Schiacciata / Metà) */
        .meter-modal-content { max-width: 800px; }
        .meter-selection-step { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .meter-selection-step h4 { margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        .meter-selection-step button { padding: 5px 10px; border: none; background-color: #0d47a1; color: white; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .meter-grid { display: grid; grid-template-columns: 2fr 3fr; gap: 15px; }
        
        .meter-sections { padding-right: 15px; border-right: 1px solid #eee; }
        .meter-section { padding: 10px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; transition: all 0.2s; }
        .meter-section.active { border-color: #0d47a1; background-color: #e6f0ff; }
        .meter-section h5 { margin: 0 0 5px 0; display: flex; justify-content: space-between; align-items: center; }
        
        .gusto-selector-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px 0; }
        .gusto-selector-grid button { padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; border-radius: 4px; cursor: pointer; transition: background-color 0.1s; font-size: 0.9rem; }
        .gusto-selector-grid button.selected { background-color: #4caf50; color: white; font-weight: bold; border-color: #43a047; }
        
        .half-pizza-section { display: flex; justify-content: space-around; gap: 15px; margin-bottom: 15px; }
        .half-pizza-card { flex: 1; padding: 15px; border: 1px solid #ccc; border-radius: 8px; transition: all 0.2s; }
        .half-pizza-card.active { border-color: #0d47a1; background-color: #e6f0ff; }

        /* Elementi Nascosti per la Stampa */
        .print-container { display: none; }

    </style>
</head>
<body>
    <div id="app">

        <div v-if="!isAccessGranted" class="login-view">
            <div class="login-form">
                <h2>Accesso Pizzeria Smart POS</h2>
                <input type="password" v-model="accessPin" placeholder="Inserisci PIN/Password" @keyup.enter="grantAccess">
                <button @click="grantAccess">Accedi</button>
                <p v-if="accessPin.length > 0" style="margin-top: 15px; font-size: 0.9rem; color: #999;">
                    (Operatore: **{{ adminPin }}**, Titolare: **{{ ownerPin }}**)
                </p>
            </div>
        </div>

        <template v-else>
            <div class="col-menu">
                <div class="nav-bar">
                    <button :class="{ active: view === 'inserimento' }" @click="view = 'inserimento'"><i class="fa-solid fa-pizza-slice"></i> Inserimento</button>
                    <button :class="{ active: view === 'ordini' }" @click="view = 'ordini'" :disabled="!isAdmin"><i class="fa-solid fa-list-check"></i> Ordini Attivi</button>
                    <button :class="{ active: view === 'storico' }" @click="view = 'storico'" :disabled="!isAdmin"><i class="fa-solid fa-clock-rotate-left"></i> Storico</button>
                    <button :class="{ active: view === 'impostazioni' }" @click="view = 'impostazioni'" :disabled="!isOwner"><i class="fa-solid fa-gear"></i> Impostazioni</button>
                    <div class="user-info">
                        {{ userRole }} <i class="fa-solid fa-user-tag"></i>
                        <button @click="logout" style="margin-left: 10px; background-color: #cc0000; padding: 5px 10px;">Logout</button>
                    </div>
                </div>

                <div v-if="view === 'inserimento'" class="menu-container">
                    <div class="menu-categories">
                        <button 
                            v-for="(items, category) in menu" 
                            :key="category" 
                            :class="{ active: activeCat === category }" 
                            @click="activeCat = category; searchTerm = ''"
                        >
                            {{ category }}
                        </button>
                    </div>
                    <div class="menu-items">
                        <div class="content-header">
                            <input type="text" v-model="searchTerm" placeholder="Cerca articoli...">
                        </div>
                        <template v-if="activeCat === 'Composizioni'">
                            <div v-for="item in filteredAvailableItems" :key="item.nome" 
                                class="item-card" 
                                :class="{ 'finished': item.isFinished, 'selected': lastSelectedItem && lastSelectedItem.nome === item.nome }"
                                @click="handleItemClick(item)"
                                style="grid-column: span 2;"
                            >
                                <h4>{{ item.nome }}</h4>
                                <p v-if="!item.isHalfPizza && item.prezzo > 0">€{{ item.prezzo.toFixed(2) }}</p>
                                
                                <template v-if="item.isMeter">
                                    <div class="meter-actions" style="margin-top: 10px; display: flex; justify-content: space-around;">
                                        <button class="btn-primary" @click.stop="openMeterCompositionModal(item, 1)">1 Gusto</button>
                                        <button class="btn-primary" @click.stop="openMeterCompositionModal(item, 2)">2 Gusti</button>
                                        <button v-if="item.nome === 'Mezzo Metro'" class="btn-primary" @click.stop="openMeterCompositionModal(item, 3)">3 Gusti</button>
                                        <button v-if="item.nome === 'Mezzo Metro'" class="btn-primary" @click.stop="openMeterCompositionModal(item, 4)">4 Gusti</button>
                                        <button v-if="item.nome === 'Schiacciata Grande'" class="btn-primary" @click.stop="openMeterCompositionModal(item, 3)">3 Gusti</button>
                                    </div>
                                </template>
                                <template v-else-if="item.isHalfPizza">
                                    <p style="font-size: 0.9rem;">(Media dei due gusti)</p>
                                </template>
                            </div>
                        </template>
                        <template v-else>
                            <div v-for="item in filteredAvailableItems" :key="item.nome" 
                                class="item-card" 
                                :class="{ 'finished': item.isFinished, 'selected': lastSelectedItem && lastSelectedItem.nome === item.nome }"
                                @click="handleItemClick(item)"
                            >
                                <h4>{{ item.nome }}</h4>
                                <p>€{{ item.prezzo.toFixed(2) }}</p>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div v-if="view === 'inserimento' && selectedItemIndex !== null && !order[selectedItemIndex].isMeter && !order[selectedItemIndex].isHalfPizza" class="modifiers-container">
                    <div class="mod-search">
                         <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatori...">
                    </div>
                    <div class="mod-categories">
                        <button 
                            v-for="(mods, category) in modifiers" 
                            :key="category" 
                            :class="{ active: activeModCat === category }" 
                            @click="activeModCat = category; modifierSearchTerm = ''"
                        >
                            {{ category }}
                        </button>
                    </div>
                    <div class="mod-items">
                        <button 
                            v-for="mod in filteredModifiersForActiveCat" 
                            :key="mod.nome" 
                            class="mod-item-btn"
                            :class="{ 'finished': mod.isFinished }"
                            @click="addExtra(mod)"
                            :title="mod.prezzo > 0 ? `+€${mod.prezzo.toFixed(2)}` : ''"
                            :disabled="mod.isFinished"
                        >
                            {{ mod.nome }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-order">
                <div class="content-header">
                    <h3>Carrello: {{ editingOrderId ? `Modifica Ordine #${editingOrderId}` : 'Nuovo Ordine' }}</h3>
                </div>
                
                <div class="order-list">
                    <div 
                        v-for="(item, index) in order" 
                        :key="index" 
                        class="order-item" 
                        :class="{ 'selected': selectedItemIndex === index }"
                        @click="selectItem(index)"
                    >
                        <div class="item-main">
                            <div class="item-info">
                                <h5>{{ item.nome }}</h5>
                                
                                <template v-if="item.isHalfPizza">
                                    <p>Metà: {{ item.gusto1 }} / {{ item.gusto2 }}</p>
                                    <p v-if="item.modifiers1.length > 0 || item.modifiers2.length > 0">Aggiunte presenti</p>
                                </template>
                                <template v-else-if="item.isMeter">
                                    <p>{{ item.sections.length }} Gusti: {{ item.sections.map(s => s.gusto || '?').join(', ') }}</p>
                                </template>
                                <ul v-else-if="item.modifiers && item.modifiers.length > 0" class="item-modifiers-list">
                                    <li v-for="(mod, modIndex) in item.modifiers" :key="modIndex">
                                        {{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }} 
                                        <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="item-actions">
                                <span style="font-weight: bold;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                                <button @click.stop="openPriceEditModal(index)" class="btn-edit-price" title="Modifica Prezzo Man."><i class="fa-solid fa-pencil"></i></button>
                                <button @click.stop="removeItem(index)"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <p v-if="order.length === 0" style="text-align: center; color: #888; margin-top: 50px;">Carrello vuoto.</p>
                </div>

                <div class="order-total">
                    <h3>
                        <span>Totale Articoli</span>
                        <span>€{{ calculatedOrderTotal.toFixed(2) }}</span>
                    </h3>
                    <h3 v-if="deliveryCost > 0" style="font-size: 1.2rem; color: #555;">
                        <span>Costo Consegna</span>
                        <span>+ €{{ deliveryCost.toFixed(2) }}</span>
                    </h3>
                    <h3 style="color: #cc0000; margin-top: 5px;">
                        <span>TOTALE ORDINE</span>
                        <span>€{{ total.toFixed(2) }}</span>
                    </h3>
                </div>
            </div>

            <div class="col-actions">
                <div v-if="view === 'inserimento'" class="main-actions">
                    <button class="btn-finish" @click="openModal()" :disabled="order.length === 0">
                        <i class="fa-solid fa-check"></i> Finalizza Ordine
                    </button>
                    <button class="btn-cancel" @click="order = []; selectedItemIndex = null">
                        <i class="fa-solid fa-xmark"></i> Annulla Carrello
                    </button>
                </div>
                
                <div v-else-if="view === 'ordini'" class="orders-view">
                    <div class="order-filters">
                        <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca ordini attivi...">
                        <button :class="{ active: activeDateFilter === 'today' }" @click="activeDateFilter = 'today'">Oggi</button>
                        <button :class="{ active: activeDateFilter === 'tomorrow' }" @click="activeDateFilter = 'tomorrow'">Domani</button>
                        <button :class="{ active: activeDateFilter === 'future' }" @click="activeDateFilter = 'future'">Futuro</button>
                    </div>
                    <p v-if="filteredActiveOrders.length === 0" style="text-align: center; color: #888; padding: 20px;">Nessun ordine attivo per questa fascia.</p>
                    <div v-for="order in filteredActiveOrders" :key="order.id" class="order-card" :class="{ 'urgent': isUrgent(order), 'near': isNear(order) }">
                        <h4>
                            Ordine #{{ order.id }} - {{ order.hour }} 
                            <span class="order-status" :class="`status-${order.status.replace(/[\s/]/g, '')}`">{{ order.status }}</span>
                        </h4>
                        <div class="order-details">
                            <p><strong>Cliente:</strong> {{ order.customer }} {{ order.tableNumber ? `(${order.tableNumber})` : '' }}</p>
                            <p v-if="order.mode === 'consegna'"><strong>Consegna:</strong> {{ order.address }} - {{ order.zone }}</p>
                            <p v-else><strong>Tipo:</strong> {{ order.mode.toUpperCase() }}</p>
                            <p><strong>Totale:</strong> €{{ order.total.toFixed(2) }}</p>
                            <p v-if="order.notes"><strong>Note:</strong> {{ order.notes }}</p>
                            <p v-if="order.mode === 'consegna'">
                                <strong>Fattorino:</strong> 
                                <select @change="updateActiveOrderDriver(order.id, $event.target.value)" :value="order.driver">
                                    <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver || 'Non Assegnato' }}</option>
                                </select>
                            </p>
                        </div>
                        <ul class="order-items-list">
                            <li v-for="(item, index) in order.items" :key="index">1x {{ item.nome }} ({{ calculateItemTotal(item).toFixed(2) }})</li>
                        </ul>
                        <div class="order-actions">
                            <button class="btn-status" @click="advance(order)" :disabled="order.status === 'Archivia Ordine'">
                                {{ getNextStatus(order.status) }}
                            </button>
                            <button class="btn-edit" @click="editOrder(order.id)">Modifica</button>
                            <button class="btn-print-order" @click="printOrder(order.id, 'comanda')">Comanda</button>
                            <button class="btn-print-order" @click="printOrder(order.id, 'scontrino')">Scontrino</button>
                            <button class="btn-share" @click="showShareMenu(order.id)"><i class="fa-brands fa-whatsapp"></i> Condividi</button>
                        </div>
                    </div>
                </div>

                <div v-else-if="view === 'storico'" class="orders-view">
                    <div class="archive-filters">
                        <label for="archive-date-filter">Data: </label>
                        <input type="date" id="archive-date-filter" v-model="archiveDateFilter" @change="calculateDriverStats">
                        <label for="driver-filter">Fattorino: </label>
                        <select id="driver-filter" v-model="selectedDriver" @change="calculateDriverStats">
                            <option value="">Tutti</option>
                            <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <div class="archive-summary">
                        <span>Filtro: **{{ archiveDateFilterDisplay }}** ({{ selectedDriver || 'Tutti i Fattorini' }})</span>
                        <br>
                        <span>Ordini Totali: **{{ driverStats.totalOrders }}** | Incasso Giornaliero: **€{{ dailyTotal.toFixed(2) }}**</span>
                    </div>
                    <p v-if="filteredArchive.length === 0" style="text-align: center; color: #888; padding: 20px;">Nessun ordine archiviato per la data/filtro selezionato.</p>
                    <div v-for="order in filteredArchive" :key="order.id" class="order-card" style="border-left-color: #777;">
                        <h4>
                            Ordine Archiviato #{{ order.id }} - {{ formatDateTime(order.timestamp) }}
                        </h4>
                        <div class="order-details">
                            <p><strong>Cliente:</strong> {{ order.customer }} | <strong>Tipo:</strong> {{ order.mode.toUpperCase() }}</p>
                            <p v-if="order.mode === 'consegna'"><strong>Indirizzo:</strong> {{ order.address }}</p>
                            <p><strong>Totale:</strong> €{{ order.total.toFixed(2) }}</p>
                            <p v-if="order.mode === 'consegna'">
                                <strong>Fattorino:</strong> 
                                <select @change="updateArchiveDriver(order.id, $event.target.value)" :value="order.driver">
                                    <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver || 'Non Assegnato' }}</option>
                                </select>
                            </p>
                        </div>
                        <div class="order-actions">
                            <button class="btn-print-order" @click="printOrder(order.id, 'scontrino')">Stampa Scontrino</button>
                            <button class="btn-edit" @click="duplicateOrder(order)">Duplica Ordine</button>
                        </div>
                    </div>
                </div>

                <div v-else-if="view === 'impostazioni'" class="settings-view">
                    <div class="settings-nav">
                        <button :class="{ active: settingsView === 'menu' }" @click="settingsView = 'menu'">Menu & Prodotti</button>
                        <button :class="{ active: settingsView === 'modifiers' }" @click="settingsView = 'modifiers'">Modificatori & Extra</button>
                        <button :class="{ active: settingsView === 'delivery' }" @click="settingsView = 'delivery'">Consegna & Fattorini</button>
                        <button :class="{ active: settingsView === 'capacity' }" @click="settingsView = 'capacity'">Capacità & Orari</button>
                    </div>

                    <div class="settings-content">
                        <div v-if="settingsView === 'menu'" class="settings-section">
                            <h3>Gestione Menu</h3>
                            <div v-for="(items, category) in menu" :key="category" class="settings-group">
                                <div class="settings-item" style="border-bottom: none;">
                                    <strong>{{ category }} ({{ items.length }})</strong>
                                </div>
                                <div v-for="(item, index) in items" :key="item.nome + index" class="settings-item">
                                    <span>
                                        {{ item.nome }} 
                                        <i v-if="item.isFinished" style="color: red;">(Esaurito)</i>
                                        <i v-if="item.isMeter || item.isHalfPizza" style="color: blue;">(Composizione)</i>
                                    </span>
                                    <div class="settings-actions">
                                        <input type="number" v-model.number="item.prezzo" step="0.01" min="0" :disabled="item.isHalfPizza || item.isMeter">
                                        <button class="btn-toggle" @click="item.isFinished = !item.isFinished">
                                            {{ item.isFinished ? 'Disponibile' : 'Esaurito' }}
                                        </button>
                                        <button class="btn-delete" @click="deleteMenuItem(category, index)">Elimina</button>
                                    </div>
                                </div>
                                <button class="btn-add" @click="addMenuItem(category)">Aggiungi Articolo a {{ category }}</button>
                            </div>
                            <div class="settings-group">
                                <input type="text" v-model="newCategoryName" placeholder="Nuova Categoria...">
                                <button class="btn-add" @click="addNewCategory" :disabled="!newCategoryName">Aggiungi Categoria</button>
                            </div>
                        </div>

                        <div v-else-if="settingsView === 'modifiers'" class="settings-section">
                            <h3>Gestione Modificatori</h3>
                             <div v-for="(mods, category) in modifiers" :key="category" class="settings-group">
                                <div class="settings-item" style="border-bottom: none;">
                                    <strong>{{ category }} ({{ mods.length }})</strong>
                                </div>
                                <div v-for="(mod, index) in mods" :key="mod.nome + index" class="settings-item">
                                    <span>
                                        {{ mod.nome }} 
                                        <i v-if="mod.isFinished" style="color: red;">(Esaurito)</i>
                                    </span>
                                    <div class="settings-actions">
                                        <input type="number" v-model.number="mod.prezzo" step="0.01" min="0">
                                        <button class="btn-toggle" @click="mod.isFinished = !mod.isFinished">
                                            {{ mod.isFinished ? 'Disponibile' : 'Esaurito' }}
                                        </button>
                                        <button class="btn-delete" @click="deleteModifier(category, index)">Elimina</button>
                                    </div>
                                </div>
                                <input type="text" v-model="newModifierName" placeholder="Nome Modificatore">
                                <input type="number" v-model.number="newModifierPrice" placeholder="Prezzo (€)" min="0" step="0.01">
                                <button class="btn-add" @click="addModifier(category)">Aggiungi Modificatore a {{ category }}</button>
                            </div>
                            <div class="settings-group">
                                <input type="text" v-model="newModifierCategoryName" placeholder="Nuova Categoria Modificatori...">
                                <button class="btn-add" @click="addNewModifierCategory" :disabled="!newModifierCategoryName">Aggiungi Categoria</button>
                            </div>
                        </div>
                        
                        <div v-else-if="settingsView === 'delivery'" class="settings-section">
                            <h3>Zone di Consegna</h3>
                            <div class="settings-group">
                                <div v-for="(zone, index) in deliveryZones" :key="zone.name + index" class="settings-item">
                                    <span>{{ zone.name }}</span>
                                    <div class="settings-actions">
                                        <input type="number" v-model.number="zone.price" step="0.01" min="0">
                                        <button class="btn-delete" @click="deleteDeliveryZone(index)">Elimina</button>
                                    </div>
                                </div>
                                <input type="text" v-model="newZoneName" placeholder="Nome Nuova Zona">
                                <input type="number" v-model.number="newZonePrice" placeholder="Costo (€)" min="0" step="0.01">
                                <button class="btn-add" @click="addDeliveryZone">Aggiungi Zona</button>
                            </div>

                            <h3>Fattorini</h3>
                            <div class="settings-group">
                                <div v-for="(driver, index) in drivers" :key="driver + index" class="settings-item">
                                    <span>{{ driver }}</span>
                                    <button class="btn-delete" @click="deleteDriver(index)">Elimina</button>
                                </div>
                                <input type="text" v-model="newDriverName" placeholder="Nome Nuovo Fattorino">
                                <button class="btn-add" @click="addDriver">Aggiungi Fattorino</button>
                            </div>
                        </div>
                        
                        <div v-else-if="settingsView === 'capacity'" class="settings-section">
                             <h3>Gestione Capacità Ordini</h3>
                             <div class="settings-group">
                                <div class="settings-item">
                                    <span>Max Pizze per Intervallo</span>
                                    <input type="number" v-model.number="capacitySettings.maxPizzas" min="10" step="1">
                                </div>
                                <div class="settings-item">
                                    <span>Durata Intervallo (Minuti)</span>
                                    <input type="number" v-model.number="capacitySettings.intervalMinutes" min="5" step="5">
                                </div>
                                <p style="font-size: 0.9rem; color: #555;">Queste impostazioni influenzano l'avviso di "capacità quasi esaurita" nel modale di finalizzazione.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </template>


        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingOrderId ? `Modifica Ordine #${editingOrderId}` : 'Finalizza Ordine' }}</h2>
                    <button @click="showModal = false" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="mode-selection">
                        <button 
                            v-for="m in modes" 
                            :key="m.id" 
                            :class="{ active: mode === m.id }" 
                            @click="selectMode(m.id)"
                        >
                            <i :class="m.icon"></i> {{ m.label }}
                        </button>
                    </div>

                    <div class="customer-input-container">
                        <label for="customer">Cliente/Riferimento</label>
                        <input type="text" id="customer" v-model="customer" @input="filterCustomers" placeholder="Nome, Tavolo, o Riferimento..." required>
                        <div v-if="filteredCustomerSuggestions.length > 0" class="customer-suggestions">
                            <div v-for="(data, index) in filteredCustomerSuggestions" :key="index" @click="loadCustomerData(data)">
                                <strong>{{ data.customer }}</strong> ({{ data.address || data.phone || 'Storico' }})
                            </div>
                        </div>
                    </div>

                    <div v-if="mode === 'consegna'" style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                        <div>
                            <label for="address">Indirizzo</label>
                            <input type="text" id="address" v-model="address" placeholder="Via, Piazza..." required>
                        </div>
                        <div>
                            <label for="streetNumber">Civico</label>
                            <input type="text" id="streetNumber" v-model="streetNumber" placeholder="Civico">
                        </div>
                        <div style="grid-column: span 2; display: flex; align-items: center;">
                            <label for="zoneName">Zona (Costo: €{{ deliveryCost.toFixed(2) }})</label>
                            <select id="zoneName" v-model="zoneName" @change="updateDeliveryCost" class="delivery-zone" required>
                                <option value="">Seleziona Zona</option>
                                <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">{{ zone.name }} (€{{ zone.price.toFixed(2) }})</option>
                            </select>
                        </div>
                    </div>

                    <div v-if="mode === 'banco' || mode === 'asporto'">
                        <label for="tableNumber">{{ mode === 'banco' ? 'Numero Tavolo' : 'Ritiro/Nome Riferimento' }}</label>
                        <input type="text" id="tableNumber" v-model="tableNumber" placeholder="Es. Tavolo 5 o Ritiro Mario">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="date">Data</label>
                            <input type="date" id="date" v-model="date" @change="updateCapacityWarning" :min="minDate" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="hour">Ora</label>
                            <input type="time" id="hour" v-model="hour" @change="updateCapacityWarning" required>
                        </div>
                    </div>

                    <div v-if="isCapacityWarning" style="padding: 10px; background-color: #ffeb3b; border: 1px solid #f9a825; border-radius: 4px;">
                        <i class="fa-solid fa-triangle-exclamation"></i> 
                        <strong>ATTENZIONE:</strong> La fascia oraria **{{ new Date(orderCapacity.interval).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}) }}** è quasi al completo ({{ orderCapacity.total }} / {{ capacitySettings.maxPizzas }} pizze).
                    </div>
                    
                    <div>
                        <label for="accontoRicevuto">Acconto Ricevuto (€{{ total.toFixed(2) }})</label>
                        <input type="number" id="accontoRicevuto" v-model.number="accontoRicevuto" min="0" :max="total.toFixed(2)" step="0.01">
                        <p v-if="restoDaDare > 0" style="margin: 5px 0 0; color: #0d47a1; font-weight: bold;">Resto da dare: €{{ restoDaDare.toFixed(2) }}</p>
                    </div>

                    <div>
                        <label for="notes">Note Ordine</label>
                        <textarea id="notes" v-model="notes" rows="3" placeholder="Istruzioni speciali per l'ordine..."></textarea>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn-close" @click="cancelEdit">Annulla</button>
                    <button class="btn-save" @click="confermaOrdine" :disabled="!customer.trim() || (mode === 'consegna' && (!address.trim() || !zoneName))">
                        {{ editingOrderId ? 'Salva Modifiche' : 'Conferma Ordine' }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showMeterModal" class="modal-overlay" @click.self="cancelMeterComposition">
            <div class="modal-content meter-modal-content">
                <div class="modal-header">
                    <h2>Composizione {{ tempMeterItem.nome }} ({{ tempMeterItem.selectedGustiCount || '?' }} Gusti)</h2>
                    <button @click="cancelMeterComposition" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    
                    <div v-if="!tempMeterItem.selectedGustiCount" class="meter-selection-step">
                        <h4>Seleziona il numero di Gusti:</h4>
                        <div style="display: flex; justify-content: space-around; gap: 10px;">
                            <button @click="setMeterGustiCount(1)" class="btn-save-settings">1 Gusto</button>
                            <button @click="setMeterGustiCount(2)" class="btn-save-settings">2 Gusti</button>
                            <button @click="setMeterGustiCount(3)" class="btn-save-settings" v-if="tempMeterItem.nome === 'Mezzo Metro' || tempMeterItem.nome === 'Schiacciata Grande'">3 Gusti</button>
                            <button @click="setMeterGustiCount(4)" class="btn-save-settings" v-if="tempMeterItem.nome === 'Mezzo Metro'">4 Gusti</button>
                        </div>
                    </div>
                    
                    <div v-else class="meter-grid">
                        
                        <div class="meter-sections">
                            <h4>Gusti Selezionati</h4>
                            <div v-for="(section, index) in tempMeterItem.sections" :key="index" 
                                class="meter-section" 
                                :class="{ 'active': section.activeSection }"
                                @click="section.activeSection = true; tempMeterItem.sections.forEach((s, i) => { if (i !== index) s.activeSection = false; });"
                            >
                                <h5>
                                    {{ section.name }} 
                                    <span v-if="section.gusto" style="color: #4caf50;">{{ section.gusto }}</span>
                                    <span v-else style="color: #f9a825;">Seleziona Gusto</span>
                                </h5>
                                <p v-if="section.modifiers.length > 0">Modificatori: {{ section.modifiers.map(m => m.nome).join(', ') }}</p>
                            </div>
                            
                            <h4 style="margin-top: 15px;">Totale Composizione: €{{ calculateTempMeterTotal.toFixed(2) }}</h4>
                        </div>
                        
                        <div class="meter-mod-selector">
                            <template v-if="activeSectionIndex !== null">
                                
                                <div v-if="!tempMeterItem.sections[activeSectionIndex].gusto || tempMeterItem.sections[activeSectionIndex].editingGusto">
                                    <h4 style="margin-bottom: 10px;">Seleziona Gusto per {{ tempMeterItem.sections[activeSectionIndex].name }}</h4>
                                    <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto...">
                                    <div class="gusto-selector-grid">
                                        <button 
                                            v-for="gusto in filteredPizzaGusti" 
                                            :key="gusto.nome" 
                                            :class="{ 'selected': tempMeterItem.sections[activeSectionIndex].gusto === gusto.nome }"
                                            @click="selectMeterGusto(activeSectionIndex, gusto.nome)"
                                        >
                                            {{ gusto.nome }}
                                        </button>
                                    </div>
                                    <button v-if="tempMeterItem.sections[activeSectionIndex].gusto" @click="tempMeterItem.sections[activeSectionIndex].editingGusto = false" class="btn-close" style="margin-top: 10px;">Fatto</button>
                                </div>
                                
                                <div v-else>
                                    <h4 style="margin-top: 10px;">Modificatori per {{ tempMeterItem.sections[activeSectionIndex].gusto }}</h4>
                                    <button @click="tempMeterItem.sections[activeSectionIndex].editingGusto = true" class="btn-edit">Cambia Gusto</button>
                                    <div class="mod-categories" style="margin-top: 10px;">
                                        <button 
                                            v-for="(mods, category) in modifiers" 
                                            :key="category" 
                                            :class="{ active: tempModCat === category }" 
                                            @click="tempModCat = category; modifierSearchTerm = ''"
                                        >
                                            {{ category }}
                                        </button>
                                    </div>
                                    <div class="mod-items">
                                        <button 
                                            v-for="mod in filteredTempModifiers" 
                                            :key="mod.nome" 
                                            class="mod-item-btn"
                                            :class="{ 'selected': isModifierSelected(activeSectionIndex, mod.nome) }"
                                            @click="addMeterModifier(activeSectionIndex, mod)"
                                            :title="mod.prezzo > 0 ? `+€${mod.prezzo.toFixed(2)}` : ''"
                                        >
                                            {{ mod.nome }}
                                        </button>
                                    </div>
                                </div>
                                
                            </template>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-close" @click="cancelMeterComposition">Annulla</button>
                    <button class="btn-save" @click="addMeterToOrder" :disabled="!isMeterValid">
                        Aggiungi al Carrello ({{ calculateTempMeterTotal.toFixed(2) }}€)
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaModal" class="modal-overlay" @click.self="cancelHalfPizzaComposition">
            <div class="modal-content meter-modal-content">
                <div class="modal-header">
                    <h2>Composizione Pizza a Metà (Totale: €{{ calculateTempHalfPizzaTotal.toFixed(2) }})</h2>
                    <button @click="cancelHalfPizzaComposition" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="half-pizza-section">
                        <div class="half-pizza-card" :class="{ 'active': tempHalfPizzaItem.activeHalf === 1 }" @click="tempHalfPizzaItem.activeHalf = 1">
                            <h5>Metà 1: {{ tempHalfPizzaItem.gusto1 || 'Seleziona Gusto' }}</h5>
                            <p v-if="tempHalfPizzaItem.modifiers1.length > 0">Modificatori: {{ tempHalfPizzaItem.modifiers1.map(m => m.nome).join(', ') }}</p>
                        </div>
                        <div class="half-pizza-card" :class="{ 'active': tempHalfPizzaItem.activeHalf === 2 }" @click="tempHalfPizzaItem.activeHalf = 2">
                            <h5>Metà 2: {{ tempHalfPizzaItem.gusto2 || 'Seleziona Gusto' }}</h5>
                            <p v-if="tempHalfPizzaItem.modifiers2.length > 0">Modificatori: {{ tempHalfPizzaItem.modifiers2.map(m => m.nome).join(', ') }}</p>
                        </div>
                    </div>

                    <div v-if="tempHalfPizzaItem.activeHalf > 0">
                        <div v-if="((tempHalfPizzaItem.activeHalf === 1 && !tempHalfPizzaItem.gusto1) || (tempHalfPizzaItem.activeHalf === 2 && !tempHalfPizzaItem.gusto2)) || tempHalfPizzaItem.editingGusto" style="margin-bottom: 15px;">
                            <h4>Seleziona Gusto per Metà {{ tempHalfPizzaItem.activeHalf }}</h4>
                            <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto...">
                            <div class="gusto-selector-grid">
                                <button 
                                    v-for="gusto in filteredPizzaGusti" 
                                    :key="gusto.nome" 
                                    :class="{ 'selected': (tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.gusto1 : tempHalfPizzaItem.gusto2) === gusto.nome }"
                                    @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)"
                                >
                                    {{ gusto.nome }}
                                </button>
                            </div>
                             <button v-if="!tempHalfPizzaItem.editingGusto" @click="tempHalfPizzaItem.editingGusto = true" class="btn-close" style="margin-top: 10px;">Cambia Gusto</button>
                             <button v-else @click="tempHalfPizzaItem.editingGusto = false" class="btn-close" style="margin-top: 10px;">Fatto</button>
                        </div>
                        
                        <div v-else>
                            <h4>Modificatori per Metà {{ tempHalfPizzaItem.activeHalf }} ({{ tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.gusto1 : tempHalfPizzaItem.gusto2 }})</h4>
                            <button @click="tempHalfPizzaItem.editingGusto = true" class="btn-edit">Cambia Gusto</button>
                            <div class="mod-categories" style="margin-top: 10px;">
                                <button 
                                    v-for="(mods, category) in modifiers" 
                                    :key="category" 
                                    :class="{ active: tempModCat === category }" 
                                    @click="tempModCat = category; modifierSearchTerm = ''"
                                >
                                    {{ category }}
                                </button>
                            </div>
                            <div class="mod-items">
                                <button 
                                    v-for="mod in filteredTempModifiers" 
                                    :key="mod.nome" 
                                    class="mod-item-btn"
                                    :class="{ 'selected': isHalfModifierSelected(tempHalfPizzaItem.activeHalf, mod.nome) }"
                                    @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)"
                                    :title="mod.prezzo > 0 ? `+€${mod.prezzo.toFixed(2)}` : ''"
                                >
                                    {{ mod.nome }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-close" @click="cancelHalfPizzaComposition">Annulla</button>
                    <button class="btn-save" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid">
                        Aggiungi al Carrello ({{ calculateTempHalfPizzaTotal.toFixed(2) }}€)
                    </button>
                </div>
            </div>
        </div>


        <div v-if="showPriceEditModal" class="modal-overlay" @click.self="showPriceEditModal = false">
            <div class="modal-content" style="max-width: 350px;">
                <div class="modal-header">
                    <h2>Modifica Prezzo</h2>
                    <button @click="showPriceEditModal = false" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <label for="newPriceValue">Nuovo Prezzo per {{ order[tempPriceEditIndex]?.nome || 'Articolo' }}</label>
                    <input type="number" id="newPriceValue" v-model.number="newPriceValue" min="0" step="0.01" required>
                </div>
                <div class="modal-footer">
                    <button class="btn-close" @click="showPriceEditModal = false">Annulla</button>
                    <button class="btn-save" @click="saveNewPrice">Salva Prezzo</button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal" class="modal-overlay" @click.self="showShareModal = false">
            <div class="modal-content" style="max-width: 350px;">
                <div class="modal-header">
                    <h2>Condividi Ordine #{{ selectedOrderForShare?.id }}</h2>
                    <button @click="showShareModal = false" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Condividi il riepilogo dell'ordine tramite WhatsApp.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-share" @click="shareViaWhatsapp(selectedOrderForShare)"><i class="fa-brands fa-whatsapp"></i> Invia WhatsApp</button>
                </div>
            </div>
        </div>

        <div class="print-container">
            <div id="print-content-comanda" class="print-comanda"></div>
            <div id="print-content-scontrino" class="print-scontrino"></div>
        </div>

    </div> 
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        Vue.createApp({
            data() {
                return {
                    // --- Accesso e Stato Generale ---
                    adminPin: '1234',
                    ownerPin: '9999',
                    accessPin: '',
                    isAccessGranted: false,
                    userRole: null, // 'Operatore', 'Admin', 'Titolare'
                    view: 'inserimento', // 'inserimento', 'ordini', 'storico', 'impostazioni'

                    // --- Dati Menu e Modificatori ---
                    menu: {
                        'Pizze Classiche': [
                            { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { nome: 'Marinara', prezzo: 5.00, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                        ],
                        'Pizze Speciali': [
                            { nome: 'Capricciosa', prezzo: 8.50, isFinished: false },
                            { nome: 'Quattro Stagioni', prezzo: 8.50, isFinished: false },
                            { nome: 'Bufalina', prezzo: 10.00, isFinished: false },
                        ],
                        'Composizioni': [
                            // Pizza a Metà (Sempre dimensione media, prezzo è la media dei due gusti)
                            { nome: 'Pizza a Metà', prezzo: 0.00, isFinished: false, isHalfPizza: true, baseSize: 'Media' },
                            // Schiacciata Grande (Può avere 1, 2 o 3 gusti)
                            { nome: 'Schiacciata Grande', prezzo: 12.00, isFinished: false, isMeter: true },
                            // Mezzo Metro (Può avere 1, 2, 3 o 4 gusti)
                            { nome: 'Mezzo Metro', prezzo: 18.00, isFinished: false, isMeter: true },
                        ],
                        'Bevande': [
                            { nome: 'Acqua Nat. 1L', prezzo: 2.00, isFinished: false },
                            { nome: 'Coca Cola 1.5L', prezzo: 3.50, isFinished: false },
                            { nome: 'Birra 66cl', prezzo: 3.00, isFinished: false },
                        ],
                    },
                    modifiers: {
                        'Aggiunte': [
                            { nome: 'Mozzarella di Bufala', prezzo: 2.00, isFinished: false },
                            { nome: 'Prosciutto Cotto', prezzo: 1.50, isFinished: false },
                            { nome: 'Patatine Fritte', prezzo: 2.50, isFinished: false },
                        ],
                        'Impasto': [
                            { nome: 'Impasto Integrale', prezzo: 1.00, isFinished: false },
                            { nome: 'Senza Glutine', prezzo: 3.00, isFinished: false },
                        ],
                        'Rimozioni': [
                            { nome: 'Senza Pomodoro', prezzo: 0.00, isFinished: false },
                            { nome: 'Senza Mozzarella', prezzo: 0.00, isFinished: false },
                        ],
                    },
                    
                    // --- Stato Modificatori e Ricerca ---
                    activeCat: 'Pizze Classiche',
                    activeModCat: 'Aggiunte',
                    searchTerm: '',
                    modifierSearchTerm: '',
                    lastSelectedItem: null,

                    // --- Dati Ordine Corrente ---
                    order: [],
                    selectedItemIndex: null,
                    
                    // --- Modale Finalizzazione Ordine ---
                    showModal: false,
                    editingOrderId: null, // ID dell'ordine che stiamo modificando (se != null)
                    modes: [
                        { id: 'banco', label: 'Banco', icon: 'fa-solid fa-store' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck' },
                    ],
                    mode: 'banco',
                    customer: '',
                    address: '',
                    streetNumber: '',
                    zoneName: '',
                    tableNumber: '',
                    date: new Date().toISOString().split('T')[0],
                    hour: this.getCurrentHourPlus15Min(),
                    notes: '',
                    accontoRicevuto: 0.00,
                    deliveryCost: 0.00,
                    
                    // --- Composizioni Complesse Modali ---
                    showMeterModal: false,
                    tempMeterItem: {
                        nome: '',
                        prezzoBase: 0,
                        isMeter: false,
                        sections: [], // { name: 'Section 1', gusto: 'Margherita', modifiers: [], activeSection: true }
                        selectedGustiCount: 0, // Aggiunto per gestire il primo step del modale
                    },
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: {
                        nome: 'Pizza a Metà',
                        prezzoBase: 0,
                        isHalfPizza: true,
                        gusto1: null,
                        gusto2: null,
                        modifiers1: [],
                        modifiers2: [],
                        activeHalf: 1,
                        size: 'Media',
                        editingGusto: false,
                    },
                    gustoSearchTerm: '',
                    tempModCat: 'Aggiunte', // categoria modificatori nel modale composizioni
                    
                    // --- Modale Prezzo Man. ---
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0,
                    
                    // --- Ordini Attivi/Storico ---
                    activeOrders: [
                         { id: 1, timestamp: new Date().toISOString(), mode: 'consegna', customer: 'Mario Rossi', address: 'Via Roma 10, 55', zone: 'Centro', date: new Date().toISOString().split('T')[0], hour: '20:00', items: [{ nome: 'Margherita', prezzo: 6.00, basePrice: 6.00, modifiers: [] }], total: 8.00, deliveryCost: 2.00, notes: 'Citofonare rosso', status: 'In Preparazione', driver: 'Mario Rossi' },
                         { id: 2, timestamp: new Date().toISOString(), mode: 'banco', customer: 'Tavolo 5', address: '', zone: '', tableNumber: '5', date: new Date().toISOString().split('T')[0], hour: '19:45', items: [{ nome: 'Diavola', prezzo: 7.50, basePrice: 7.50, modifiers: [] }], total: 7.50, deliveryCost: 0, notes: '', status: 'In Cottura', driver: '' },
                    ],
                    archiveOrders: [],
                    availableDrivers: ['Non Assegnato', 'Mario Rossi', 'Giulia Bianchi'],
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', // 'today', 'tomorrow', 'future'
                    archiveDateFilter: new Date().toISOString().split('T')[0],
                    selectedDriver: '',
                    
                    // --- Impostazioni ---
                    settingsView: 'menu',
                    newCategoryName: '',
                    newModifierName: '',
                    newModifierPrice: 0.00,
                    newModifierCategoryName: '',
                    newZoneName: '',
                    newZonePrice: 0.00,
                    newDriverName: '',
                    customerHistory: [
                        { customer: 'Mario Rossi', phone: '3331234567', address: 'Via Roma 10, 55', zone: 'Centro', streetNumber: '55' },
                        { customer: 'Giulia Verdi', phone: '3459876543', address: 'Via Milano 55', zone: 'Periferia Ovest', streetNumber: '55' },
                    ],
                    deliveryZones: [
                        { name: 'Centro', price: 2.00 },
                        { name: 'Periferia Est', price: 3.50 },
                        { name: 'Periferia Ovest', price: 3.50 },
                        { name: 'Fuori Zona', price: 5.00 },
                    ],
                    drivers: ['Mario Rossi', 'Giulia Bianchi', 'Luca Neri'], // Lista completa dei fattorini
                    capacitySettings: {
                        maxPizzas: 50,
                        intervalMinutes: 15,
                    },
                    isCapacityWarning: false,
                    orderCapacity: { interval: null, total: 0 },
                    driverStats: { totalOrders: 0, totalCash: 0, totalDelivery: 0 },
                    
                    // --- Condivisione WhatsApp ---
                    showShareModal: false,
                    selectedOrderForShare: null,
                }
            },

                    // ... (Chiusura del data() object)
                }
            },
            
            computed: {
                isAdmin() {
                    return this.userRole === 'Admin' || this.userRole === 'Titolare';
                },
                isOwner() {
                    return this.userRole === 'Titolare';
                },
                
                // --- Computed per il Menu e Modificatori ---
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    return items.filter(item => 
                        item.nome.toLowerCase().includes(term) && !item.isFinished
                    );
                },
                filteredModifiersForActiveCat() {
                    const mods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term) && !mod.isFinished
                    );
                },
                
                // --- Computed per l'Ordine Corrente ---
                calculatedOrderTotal() {
                    return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                },
                total() {
                    return this.calculatedOrderTotal + this.deliveryCost;
                },
                restoDaDare() {
                    return Math.max(0, this.accontoRicevuto - this.total);
                },
                
                // --- Computed per la Finalizzazione Ordine ---
                minDate() {
                    return new Date().toISOString().split('T')[0];
                },
                filteredCustomerSuggestions() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 2) return [];
                    
                    // Filtra la cronologia clienti per nome, indirizzo o telefono
                    return this.customerHistory
                        .filter(c => 
                            c.customer.toLowerCase().includes(term) ||
                            (c.address && c.address.toLowerCase().includes(term)) ||
                            (c.phone && c.phone.includes(term))
                        )
                        // Rimuove i duplicati basati sul nome del cliente
                        .filter((c, index, self) => 
                            index === self.findIndex((t) => (
                                t.customer === c.customer
                            ))
                        );
                },
                
                // --- Computed per Composizioni Complesse ---
                allPizzaGusti() {
                    // Combina tutti gli articoli di 'Pizze Classiche' e 'Pizze Speciali' come gusti
                    return [
                        ...(this.menu['Pizze Classiche'] || []),
                        ...(this.menu['Pizze Speciali'] || []),
                    ].filter(item => !item.isFinished);
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase();
                    return this.allPizzaGusti.filter(gusto => 
                        gusto.nome.toLowerCase().includes(term)
                    );
                },
                
                // Mezzo Metro / Schiacciata Grande
                activeSectionIndex() {
                    const index = this.tempMeterItem.sections.findIndex(s => s.activeSection);
                    return index !== -1 ? index : null;
                },
                calculateTempMeterTotal() {
                    let basePrice = this.tempMeterItem.prezzoBase;
                    let modifiersTotal = 0;
    
                    this.tempMeterItem.sections.forEach(section => {
                        // Calcolo costo modificatori
                        section.modifiers.forEach(mod => {
                            modifiersTotal += mod.prezzo;
                        });
                    });
                    
                    // Il prezzo base (12.00 o 18.00) è fisso, si aggiungono solo i modificatori
                    return basePrice + modifiersTotal; 
                },
                isMeterValid() {
                    return this.tempMeterItem.sections.every(s => s.gusto !== null);
                },
                
                // Pizza a Metà
                calculateTempHalfPizzaTotal() {
                    let total = 0;
                    let gusto1Price = 0;
                    let gusto2Price = 0;
                    let modPrice = 0;
    
                    const g1 = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto1);
                    const g2 = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto2);
                    
                    if (g1) gusto1Price = g1.prezzo;
                    if (g2) gusto2Price = g2.prezzo;
    
                    // Prezzo base: media dei due gusti
                    if (g1 && g2) {
                        total = (gusto1Price + gusto2Price) / 2;
                    } else if (g1 || g2) {
                        // Se manca un gusto, usiamo l'unico selezionato come base
                        total = gusto1Price || gusto2Price; 
                    }
                    
                    // Modificatori
                    this.tempHalfPizzaItem.modifiers1.forEach(m => modPrice += m.prezzo);
                    this.tempHalfPizzaItem.modifiers2.forEach(m => modPrice += m.prezzo);
                    
                    return total + modPrice;
                },
                isHalfPizzaValid() {
                    return this.tempHalfPizzaItem.gusto1 !== null && this.tempHalfPizzaItem.gusto2 !== null;
                },
                
                // Modificatori nei Modali Composizioni
                filteredTempModifiers() {
                    return this.modifiers[this.tempModCat] || [];
                },
                
                // --- Computed per Ordini Attivi/Storico ---
                filteredActiveOrders() {
                    let orders = this.activeOrders;
                    const today = new Date().toISOString().split('T')[0];
                    const tomorrow = this.getTomorrowDate();
                    
                    // Filtro per data
                    if (this.activeDateFilter === 'today') {
                        orders = orders.filter(o => o.date === today);
                    } else if (this.activeDateFilter === 'tomorrow') {
                        orders = orders.filter(o => o.date === tomorrow);
                    } else if (this.activeDateFilter === 'future') {
                        orders = orders.filter(o => o.date > tomorrow);
                    }
    
                    // Filtro per ricerca
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term) {
                        orders = orders.filter(o => 
                            o.customer.toLowerCase().includes(term) ||
                            o.address.toLowerCase().includes(term) ||
                            o.id.toString().includes(term)
                        );
                    }
                    
                    // Ordina per orario
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },
                filteredArchive() {
                    const dateFilter = this.archiveDateFilter;
                    const driverFilter = this.selectedDriver;
                    
                    let orders = this.archiveOrders.filter(o => o.date === dateFilter);
                    
                    if (driverFilter) {
                        orders = orders.filter(o => o.driver === driverFilter);
                    }
                    
                    return orders;
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                archiveDateFilterDisplay() {
                    const date = new Date(this.archiveDateFilter);
                    return date.toLocaleDateString('it-IT', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                },
            },
            
            watch: {
                order: {
                    handler(newOrder) {
                        // Se l'elemento selezionato viene rimosso, deseleziona
                        if (this.selectedItemIndex !== null && newOrder.length <= this.selectedItemIndex) {
                            this.selectedItemIndex = null;
                        }
                    },
                    deep: true
                },
                'order.length'(newLength) {
                     if (newLength === 0) {
                         this.editingOrderId = null; // Resetta se il carrello si svuota
                     }
                }
            },
    
            methods: {
                // --- Gestione Accesso ---
                grantAccess() {
                    if (this.accessPin === this.ownerPin) {
                        this.userRole = 'Titolare';
                        this.isAccessGranted = true;
                        this.accessPin = '';
                    } else if (this.accessPin === this.adminPin) {
                        this.userRole = 'Admin';
                        this.isAccessGranted = true;
                        this.accessPin = '';
                    } else if (this.accessPin.length > 0) {
                        alert('PIN non valido.');
                        this.accessPin = '';
                    }
                },
                logout() {
                    this.isAccessGranted = false;
                    this.userRole = null;
                    this.view = 'inserimento';
                },
                
                // --- Gestione Ordine Corrente ---
                handleItemClick(item) {
                    this.lastSelectedItem = item;
                    this.selectedItemIndex = null; // Deseleziona tutto prima
    
                    if (item.isHalfPizza) {
                        this.openHalfPizzaCompositionModal(item);
                    } else if (item.isMeter) {
                        // Se l'utente clicca sulla card generale, apri per default con 0 gusti, forzando la selezione del count
                        this.openMeterCompositionModal(item, null); 
                    } else {
                        this.addItem(item);
                    }
                },
                addItem(item) {
                    const newItem = {
                        ...item,
                        basePrice: item.prezzo,
                        modifiers: [],
                        manualPrice: null,
                    };
                    this.order.push(newItem);
                    this.selectItem(this.order.length - 1); // Seleziona il nuovo elemento
                },
                removeItem(index) {
                    this.order.splice(index, 1);
                },
                selectItem(index) {
                    this.selectedItemIndex = index;
                },
                
                // --- Modificatori (Articoli Standard) ---
                addExtra(mod) {
                    if (this.selectedItemIndex === null || this.order[this.selectedItemIndex].isMeter || this.order[this.selectedItemIndex].isHalfPizza) return;
                    
                    const item = this.order[this.selectedItemIndex];
                    const existingIndex = item.modifiers.findIndex(m => m.nome === mod.nome);
    
                    if (existingIndex !== -1) {
                        item.modifiers.splice(existingIndex, 1); // Rimuovi se già presente
                    } else {
                        item.modifiers.push(mod); // Aggiungi
                    }
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return 'Aggiunta';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Aggiunte': return '+';
                        case 'Rimozioni': return '-';
                        case 'Impasto': return '⚡';
                        default: return '';
                    }
                },
                
                // --- Calcolo Totale ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== null) {
                        return item.manualPrice;
                    }
                    
                    let total = item.basePrice || item.prezzo; 
    
                    // Composizione Mezzo Metro/Schiacciata
                    if (item.isMeter) {
                        let modifiersTotal = 0;
                        
                        item.sections.forEach(section => {
                             // Calcolo costo modificatori
                             section.modifiers.forEach(mod => {
                                 modifiersTotal += mod.prezzo;
                             });
                        });
                        return (item.basePrice || item.prezzo) + modifiersTotal; // Usa il prezzo base fisso
                    }
                    
                    // Composizione Pizza a Metà
                    if (item.isHalfPizza) {
                        let gusto1Price = 0;
                        let gusto2Price = 0;
                        let modPrice = 0;
                        
                        const g1 = this.allPizzaGusti.find(g => g.nome === item.gusto1);
                        const g2 = this.allPizzaGusti.find(g => g.nome === item.gusto2);
                        
                        if (g1) gusto1Price = g1.prezzo;
                        if (g2) gusto2Price = g2.prezzo;
                        
                        // Prezzo base: media dei due gusti
                        if (g1 && g2) {
                            total = (gusto1Price + gusto2Price) / 2;
                        } else if (g1 || g2) {
                            total = gusto1Price || gusto2Price; 
                        } else {
                            total = 0;
                        }
                        
                        item.modifiers1.forEach(m => modPrice += m.prezzo);
                        item.modifiers2.forEach(m => modPrice += m.prezzo);
                        
                        return total + modPrice;
                    }
                    
                    // Articolo standard
                    if (item.modifiers && item.modifiers.length > 0) {
                        total += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }
                    
                    return total;
                },
                
                // --- Modale Composizione Mezzo Metro / Schiacciata ---
                openMeterCompositionModal(item, initialGustiCount) {
                    this.gustoSearchTerm = '';
                    this.tempMeterItem = {
                        nome: item.nome,
                        prezzoBase: item.prezzo,
                        isMeter: true,
                        sections: [],
                        selectedGustiCount: initialGustiCount || 0, // Inizializza a 0 se chiamato dal click generale
                    };
                    
                    if (initialGustiCount) {
                        this.setMeterGustiCount(initialGustiCount);
                    }
                    
                    this.showMeterModal = true;
                },
                setMeterGustiCount(count) {
                    this.tempMeterItem.selectedGustiCount = count;
                    this.tempMeterItem.sections = Array.from({ length: count }, (_, i) => ({
                        name: `Gusto ${i + 1}`,
                        gusto: null,
                        modifiers: [],
                        activeSection: i === 0,
                        editingGusto: false,
                    }));
                },
                selectMeterGusto(index, gustoName) {
                    const section = this.tempMeterItem.sections[index];
                    section.gusto = gustoName;
                    section.editingGusto = false;
                    
                    // Sposta automaticamente alla prossima sezione se non è l'ultima
                    if (index < this.tempMeterItem.sections.length - 1) {
                        this.tempMeterItem.sections[index].activeSection = false;
                        this.tempMeterItem.sections[index + 1].activeSection = true;
                    }
                },
                isModifierSelected(sectionIndex, modName) {
                    return this.tempMeterItem.sections[sectionIndex].modifiers.some(m => m.nome === modName);
                },
                addMeterModifier(sectionIndex, mod) {
                    const section = this.tempMeterItem.sections[sectionIndex];
                    const existingIndex = section.modifiers.findIndex(m => m.nome === mod.nome);
    
                    if (existingIndex !== -1) {
                        section.modifiers.splice(existingIndex, 1);
                    } else {
                        section.modifiers.push(mod);
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert('Attenzione: Devi selezionare un gusto per tutte le sezioni!');
                        return;
                    }
                    // Crea una copia pulita per l'ordine
                    const newItem = { 
                        ...this.tempMeterItem, 
                        prezzo: this.calculateTempMeterTotal, // Prezzo ricalcolato
                        basePrice: this.tempMeterItem.prezzoBase,
                        manualPrice: null,
                        sections: JSON.parse(JSON.stringify(this.tempMeterItem.sections)) // Deep copy delle sezioni
                    };
                    newItem.sections.forEach(s => delete s.activeSection); // Pulisci la prop temporanea
                    delete newItem.selectedGustiCount;
                    
                    this.order.push(newItem);
                    this.showMeterModal = false;
                    this.selectItem(this.order.length - 1);
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = {};
                },
                
                // --- Modale Composizione Pizza a Metà ---
                openHalfPizzaCompositionModal(item) {
                    this.gustoSearchTerm = '';
                    this.tempHalfPizzaItem = {
                        nome: item.nome,
                        prezzoBase: item.prezzo,
                        isHalfPizza: true,
                        gusto1: null,
                        gusto2: null,
                        modifiers1: [],
                        modifiers2: [],
                        activeHalf: 1,
                        size: 'Media',
                        editingGusto: false, // Aggiunto per il modale
                    };
                    this.showHalfPizzaModal = true;
                },
                selectHalfPizzaGusto(half, gustoName) {
                    if (half === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                        if (!this.tempHalfPizzaItem.gusto2) {
                            this.tempHalfPizzaItem.activeHalf = 2; // Passa automaticamente all'altra metà se vuota
                        }
                    } else {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                    this.tempHalfPizzaItem.editingGusto = false;
                },
                isHalfModifierSelected(half, modName) {
                    const modifiers = half === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    return modifiers.some(m => m.nome === modName);
                },
                addHalfPizzaModifier(half, mod) {
                    const modifiers = half === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    const existingIndex = modifiers.findIndex(m => m.nome === mod.nome);
    
                    if (existingIndex !== -1) {
                        modifiers.splice(existingIndex, 1);
                    } else {
                        modifiers.push(mod);
                    }
                },
                addHalfPizzaToOrder() {
                     if (!this.isHalfPizzaValid) {
                        alert('Attenzione: Devi selezionare un gusto per entrambe le metà!');
                        return;
                    }
                    const newItem = { 
                        ...this.tempHalfPizzaItem, 
                        prezzo: this.calculateTempHalfPizzaTotal, 
                        manualPrice: null,
                        modifiers1: JSON.parse(JSON.stringify(this.tempHalfPizzaItem.modifiers1)),
                        modifiers2: JSON.parse(JSON.stringify(this.tempHalfPizzaItem.modifiers2)),
                    };
                    delete newItem.activeHalf; // Pulisci la prop temporanea
                    delete newItem.editingGusto;
                    
                    this.order.push(newItem);
                    this.showHalfPizzaModal = false;
                    this.selectItem(this.order.length - 1);
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = {};
                },
                
                // --- Modale Prezzo Man. ---
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    this.newPriceValue = this.calculateItemTotal(this.order[index]);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        this.order[this.tempPriceEditIndex].manualPrice = this.newPriceValue;
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0;
                    } else {
                        alert('Inserisci un prezzo valido.');
                    }
                },
    
                // --- Logica Finalizza Ordine (Modal) ---
                openModal(orderId = null) {
                    this.resetOrderModal();
                    if (orderId) {
                        const orderToEdit = this.activeOrders.find(o => o.id === orderId);
                        if (orderToEdit) {
                            this.editingOrderId = orderId;
                            // Deve usare il deep clone per evitare reattività
                            this.order = JSON.parse(JSON.stringify(orderToEdit.items)); 
                            this.mode = orderToEdit.mode;
                            this.customer = orderToEdit.customer;
                            this.address = orderToEdit.address.split(',')[0].trim(); // Prende solo l'indirizzo
                            this.streetNumber = orderToEdit.streetNumber;
                            this.zoneName = orderToEdit.zone;
                            this.tableNumber = orderToEdit.tableNumber;
                            this.date = orderToEdit.date;
                            this.hour = orderToEdit.hour;
                            this.notes = orderToEdit.notes;
                            this.accontoRicevuto = orderToEdit.accontoRicevuto || 0;
                            this.deliveryCost = orderToEdit.deliveryCost || 0;
                            this.updateCapacityWarning();
                        }
                    }
                    this.showModal = true;
                },
                resetOrderModal() {
                    const now = new Date();
                    this.mode = 'banco';
                    this.customer = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.zoneName = '';
                    this.tableNumber = '';
                    this.date = now.toISOString().split('T')[0];
                    this.hour = this.getCurrentHourPlus15Min();
                    this.notes = '';
                    this.accontoRicevuto = 0.00;
                    this.deliveryCost = 0.00;
                    this.editingOrderId = null;
                    this.isCapacityWarning = false;
                },
                selectMode(m) {
                    this.mode = m;
                    if (m !== 'consegna') {
                        this.deliveryCost = 0;
                        this.zoneName = '';
                        this.address = '';
                        this.streetNumber = '';
                    }
                },
                updateDeliveryCost() {
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    this.deliveryCost = zone ? zone.price : 0;
                },
                filterCustomers() {
                    // Il filtraggio è gestito dal computed filteredCustomerSuggestions
                },
                loadCustomerData(data) {
                    this.customer = data.customer;
                    this.address = data.address.split(',')[0].trim() || '';
                    this.zoneName = data.zone || '';
                    this.streetNumber = data.streetNumber || data.address.split(',')[1]?.trim() || '';
                    this.updateDeliveryCost();
                },
                getCurrentHourPlus15Min() {
                    const now = new Date();
                    const ms = now.getTime();
                    const future = new Date(ms + 15 * 60000); // 15 minuti in millisecondi
                    return future.toTimeString().split(' ')[0].substring(0, 5); // Formato HH:MM
                },
                
                // --- Gestione Conflitti di Capacità ---
                updateCapacityWarning() {
                    const requestedDateTime = new Date(`${this.date}T${this.hour}:00`);
                    if (isNaN(requestedDateTime) || this.date !== new Date().toISOString().split('T')[0]) {
                        this.isCapacityWarning = false;
                        this.orderCapacity = { interval: null, total: 0 };
                        return;
                    }
                    
                    const intervalMinutes = this.capacitySettings.intervalMinutes;
                    // Trova l'inizio dell'intervallo
                    const intervalStart = new Date(Math.floor(requestedDateTime.getTime() / (intervalMinutes * 60000)) * (intervalMinutes * 60000));
                    
                    let ordersToCheck = this.activeOrders.filter(o => o.id !== this.editingOrderId);
                    
                    const ordersInInterval = ordersToCheck.filter(order => {
                        const orderTime = new Date(`${order.date}T${order.hour}:00`);
                        return orderTime >= intervalStart && orderTime < new Date(intervalStart.getTime() + intervalMinutes * 60000);
                    });
                    
                    // Calcola quante pizze sono già in quell'intervallo
                    const totalPizzas = ordersInInterval.reduce((sum, order) => sum + order.items.filter(i => i.nome.includes('Pizza') || i.nome.includes('Schiacciata') || i.nome.includes('Mezzo Metro')).length, 0);
                    
                    // Aggiungi le pizze dell'ordine corrente
                    const currentOrderPizzas = this.order.filter(i => i.nome.includes('Pizza') || i.nome.includes('Schiacciata') || i.nome.includes('Mezzo Metro')).length;
                    
                    const totalCapacity = totalPizzas + currentOrderPizzas;
    
                    this.orderCapacity = { interval: intervalStart, total: totalCapacity };
                    this.isCapacityWarning = totalCapacity >= this.capacitySettings.maxPizzas;
                },
                
                // --- Conferma Ordine ---
                confermaOrdine() {
                    if (this.isCapacityWarning) {
                        if (!confirm(`La fascia oraria è quasi piena. Vuoi procedere comunque?`)) {
                            return;
                        }
                    }
                    
                    const fullAddress = this.mode === 'consegna' ? `${this.address}${this.streetNumber ? ', ' + this.streetNumber : ''}` : '';
                    
                    const orderData = {
                        id: this.editingOrderId || this.activeOrders.length + this.archiveOrders.length + 1,
                        timestamp: new Date().toISOString(),
                        mode: this.mode,
                        customer: this.customer,
                        address: fullAddress,
                        streetNumber: this.streetNumber,
                        zone: this.zoneName,
                        tableNumber: this.tableNumber,
                        date: this.date,
                        hour: this.hour,
                        items: JSON.parse(JSON.stringify(this.order)),
                        total: this.total,
                        deliveryCost: this.deliveryCost,
                        notes: this.notes,
                        status: 'In Preparazione', // Nuovo stato iniziale
                        driver: '', // Inizialmente non assegnato
                        accontoRicevuto: this.accontoRicevuto,
                    };
                    
                    if (this.editingOrderId) {
                        const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.activeOrders[index] = orderData; // Sostituisci l'ordine modificato
                        }
                    } else {
                        this.activeOrders.push(orderData);
                    }
                    
                    // Aggiorna Cronologia Clienti
                    if (this.mode === 'consegna') {
                        const existingIndex = this.customerHistory.findIndex(c => c.customer === this.customer);
                        const newCustomerData = { customer: this.customer, address: fullAddress, zone: this.zoneName, streetNumber: this.streetNumber };
                        if (existingIndex !== -1) {
                            this.customerHistory[existingIndex] = newCustomerData;
                        } else {
                            this.customerHistory.push(newCustomerData);
                        }
                    }
                    
                    this.showModal = false;
                    this.order = []; // Svuota carrello
                    this.selectedItemIndex = null;
                    this.editingOrderId = null;
                },
                cancelEdit() {
                    // Se stiamo modificando, l'ordine modificato rimane nel carrello se l'utente non ha cliccato conferma.
                    // Però, se clicca annulla, resetta il carrello.
                    this.order = []; 
                    this.showModal = false;
                    this.editingOrderId = null;
                },
                
                // --- Gestione Ordini Attivi ---
                editOrder(orderId) {
                    this.view = 'inserimento'; // Torna alla vista di inserimento
                    this.openModal(orderId);
                },
                getNextStatus(currentStatus) {
                    const statuses = ['In Preparazione', 'In Cottura', 'Pronto/In Consegna', 'Archivia Ordine'];
                    const currentIndex = statuses.indexOf(currentStatus);
                    return statuses[currentIndex + 1] || 'Archivia Ordine';
                },
                advance(order) {
                    const nextStatus = this.getNextStatus(order.status);
                    if (nextStatus === 'Archivia Ordine') {
                        if (confirm(`Confermi l'archiviazione dell'ordine #${order.id}?`)) {
                            this.archiveOrder(order);
                        }
                    } else {
                        order.status = nextStatus;
                    }
                },
                archiveOrder(order) {
                    order.status = 'Archiviato';
                    this.archiveOrders.push(order);
                    this.activeOrders = this.activeOrders.filter(o => o.id !== order.id);
                    this.calculateDriverStats(); // Ricalcola le statistiche archiviate
                },
                updateActiveOrderDriver(orderId, driverName) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) order.driver = driverName;
                },
                
                // --- Logica Temporale per Ordini Attivi ---
                getTomorrowDate() {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                },
                isUrgent(order) {
                    const now = new Date();
                    const orderTime = new Date(`${order.date}T${order.hour}:00`);
                    // Considera urgente se è in consegna oggi ed è meno di 5 minuti dall'orario di ritiro/consegna
                    return order.date === now.toISOString().split('T')[0] && 
                           order.status === 'Pronto/In Consegna' && 
                           (orderTime.getTime() - now.getTime() < 5 * 60000); // 5 minuti
                },
                isNear(order) {
                    const now = new Date();
                    const orderTime = new Date(`${order.date}T${order.hour}:00`);
                    // Considera vicino se è in preparazione/cottura oggi ed è tra 5 e 20 minuti dall'orario
                    return order.date === now.toISOString().split('T')[0] &&
                           (order.status === 'In Preparazione' || order.status === 'In Cottura') &&
                           (orderTime.getTime() - now.getTime() >= 5 * 60000) &&
                           (orderTime.getTime() - now.getTime() < 20 * 60000); // 20 minuti
                },
                formatDateTime(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + ' del ' + date.toLocaleDateString('it-IT');
                },
                
                // --- Gestione Storico Ordini ---
                updateArchiveDriver(orderId, driverName) {
                     const order = this.archiveOrders.find(o => o.id === orderId);
                    if (order) {
                        order.driver = driverName;
                        this.calculateDriverStats(); // Ricalcola dopo l'aggiornamento
                    }
                },
                calculateDriverStats() {
                    const filtered = this.filteredArchive;
                    this.driverStats = {
                        totalOrders: filtered.length,
                        totalCash: filtered.filter(o => o.mode !== 'consegna').reduce((sum, o) => sum + o.total, 0),
                        totalDelivery: filtered.filter(o => o.mode === 'consegna').reduce((sum, o) => sum + o.total, 0),
                    };
                },
                duplicateOrder(order) {
                    this.view = 'inserimento';
                    this.order = JSON.parse(JSON.stringify(order.items)); // Carica gli articoli nel carrello
                    
                    // Prepara il modale per un nuovo ordine con i dati del cliente
                    this.mode = order.mode;
                    this.customer = order.customer;
                    this.address = order.address.split(',')[0].trim();
                    this.streetNumber = order.streetNumber || order.address.split(',')[1]?.trim() || '';
                    this.zoneName = order.zone;
                    this.tableNumber = order.tableNumber;
                    this.notes = order.notes;
                    this.updateDeliveryCost();
                    this.hour = this.getCurrentHourPlus15Min(); // Imposta l'orario a +15 minuti
                },
                
                // --- Stampa e Condivisione ---
                printOrder(orderId, type) {
                    const order = this.activeOrders.find(o => o.id === orderId) || this.archiveOrders.find(o => o.id === orderId);
                    if (!order) return;
                    
                    const contentDiv = document.getElementById(`print-content-${type}`);
                    contentDiv.innerHTML = this.generatePrintContent(order, type);
                    
                    // Logica di stampa effettiva (simulata)
                    const printWindow = window.open('', '', 'height=600,width=800');
                    printWindow.document.write('<html><head><title>Stampa Ordine</title>');
                    printWindow.document.write('<style>body { font-family: monospace; font-size: 12px; margin: 0; padding: 10px; } h3 { text-align: center; margin: 5px 0; } hr { border: 1px dashed #000; margin: 5px 0; } .item-line { display: flex; justify-content: space-between; margin-bottom: 2px; } .item-mod { margin-left: 10px; font-size: 11px; }</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(contentDiv.innerHTML);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                },
                generatePrintContent(order, type) {
                    let html = `<h3>${type === 'comanda' ? 'COMANDA CUCINA' : 'SCONTRINO CLIENTE'}</h3>`;
                    html += `<h3>Ordine #${order.id} - ${order.hour}</h3>`;
                    html += `<p>Data: ${order.date}</p>`;
                    html += `<p>Tipo: ${order.mode.toUpperCase()}</p>`;
                    html += `<p>Cliente: ${order.customer}</p>`;
                    if (order.mode === 'consegna') {
                        html += `<p>Indirizzo: ${order.address} (${order.zone})</p>`;
                        html += `<p>Fattorino: ${order.driver || 'N.A.'}</p>`;
                    } else if (order.tableNumber) {
                        html += `<p>Rif.: ${order.tableNumber}</p>`;
                    }
                    if (order.notes) html += `<p>Note: ${order.notes}</p>`;
                    html += `<hr>`;
    
                    if (type === 'comanda') {
                        // Logica per Comanda Cucina (solo nomi articoli e modificatori)
                        order.items.forEach(item => {
                            html += `<div class="item-line"><span>1x ${item.nome}</span></div>`;
                            if (item.isHalfPizza) {
                                html += `<div class="item-mod">Metà 1: ${item.gusto1 || '?'} ${item.modifiers1.map(m => `(+${m.nome})`).join(' ')}</div>`;
                                html += `<div class="item-mod">Metà 2: ${item.gusto2 || '?'} ${item.modifiers2.map(m => `(+${m.nome})`).join(' ')}</div>`;
                            } else if (item.isMeter) {
                                item.sections.forEach((section, index) => {
                                    html += `<div class="item-mod">${section.name}: ${section.gusto || '?'} ${section.modifiers.map(m => `(+${m.nome})`).join(' ')}</div>`;
                                });
                            } else if (item.modifiers && item.modifiers.length > 0) {
                                item.modifiers.forEach(mod => {
                                    html += `<div class="item-mod">${mod.nome}</div>`;
                                });
                            }
                        });
                    } else {
                        // Logica per Scontrino Cliente (nomi, modificatori, prezzi)
                        let totalItems = 0;
                        order.items.forEach(item => {
                            const itemTotal = this.calculateItemTotal(item);
                            totalItems += itemTotal;
                            html += `<div class="item-line"><span>1x ${item.nome}</span><span>€${itemTotal.toFixed(2)}</span></div>`;
                            if (item.isHalfPizza) {
                                html += `<div class="item-mod">(${item.gusto1}/${item.gusto2})</div>`;
                                item.modifiers1.concat(item.modifiers2).forEach(mod => {
                                    if(mod.prezzo > 0) html += `<div class="item-mod">Extra: ${mod.nome} (+€${mod.prezzo.toFixed(2)})</div>`;
                                });
                            } else if (item.isMeter) {
                                item.sections.forEach((section) => {
                                    html += `<div class="item-mod">Gusto: ${section.gusto || '?'}</div>`;
                                    section.modifiers.forEach(mod => {
                                        if(mod.prezzo > 0) html += `<div class="item-mod">Extra: ${mod.nome} (+€${mod.prezzo.toFixed(2)})</div>`;
                                    });
                                });
                            } else if (item.modifiers && item.modifiers.length > 0) {
                                 item.modifiers.forEach(mod => {
                                    if (mod.prezzo > 0) {
                                        html += `<div class="item-mod">Extra: ${mod.nome} (+€${mod.prezzo.toFixed(2)})</div>`;
                                    } else {
                                         html += `<div class="item-mod">${mod.nome}</div>`;
                                    }
                                });
                            }
                        });
                        
                        html += `<hr>`;
                        html += `<div class="item-line"><strong>TOTALE ARTICOLI</strong><strong>€${totalItems.toFixed(2)}</strong></div>`;
                        if (order.deliveryCost > 0) {
                            html += `<div class="item-line"><span>Costo Consegna</span><span>+€${order.deliveryCost.toFixed(2)}</span></div>`;
                        }
                        html += `<div class="item-line" style="font-size: 1.2rem; font-weight: bold;"><span>TOTALE ORDINE</span><span>€${order.total.toFixed(2)}</span></div>`;
                        if (order.accontoRicevuto > 0) {
                            const resto = Math.max(0, order.accontoRicevuto - order.total);
                            html += `<div class="item-line"><span>Acconto Ricevuto</span><span>€${order.accontoRicevuto.toFixed(2)}</span></div>`;
                            html += `<div class="item-line"><span>RESTO DA DARE</span><span>€${resto.toFixed(2)}</span></div>`;
                        }
                    }
    
                    html += `<hr>`;
                    html += `<p style="text-align: center;">Grazie per l'ordine!</p>`;
                    return html;
                },
                showShareMenu(orderId) {
                    this.selectedOrderForShare = this.activeOrders.find(o => o.id === orderId);
                    if (this.selectedOrderForShare) {
                        this.showShareModal = true;
                    }
                },
                shareViaWhatsapp(order) {
                    const message = this.generateWhatsappMessage(order);
                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    this.showShareModal = false;
                },
                generateWhatsappMessage(order) {
                    let message = `*Riepilogo Ordine #${order.id}*\n`;
                    message += `*Tipo:* ${order.mode.toUpperCase()}\n`;
                    if (order.mode === 'consegna') {
                        message += `*Indirizzo:* ${order.address}\n`;
                    } else if (order.tableNumber) {
                        message += `*Riferimento:* ${order.tableNumber}\n`;
                    }
                    message += `*Orario:* ${order.hour}\n\n`;
                    
                    message += `*Articoli:*\n`;
                    order.items.forEach((item, index) => {
                        const itemTotal = this.calculateItemTotal(item);
                        message += `  ${index + 1}. 1x ${item.nome} (€${itemTotal.toFixed(2)})\n`;
                        if (item.isHalfPizza) {
                            message += `     Gusti: ${item.gusto1}/${item.gusto2}\n`;
                            if (item.modifiers1.length > 0 || item.modifiers2.length > 0) {
                                message += `     Aggiunte: ${item.modifiers1.concat(item.modifiers2).map(m => m.nome).join(', ')}\n`;
                            }
                        } else if (item.isMeter) {
                            message += `     Gusti: ${item.sections.map(s => s.gusto).join(', ')}\n`;
                        } else if (item.modifiers && item.modifiers.length > 0) {
                            message += `     Aggiunte: ${item.modifiers.map(m => m.nome).join(', ')}\n`;
                        }
                    });
                    
                    message += `\n*TOTALE ORDINE: €${order.total.toFixed(2)}*\n`;
                    if (order.deliveryCost > 0) {
                        message += `(Include €${order.deliveryCost.toFixed(2)} di consegna)\n`;
                    }
                    
                    return message;
                },
                
                // --- Logica Impostazioni (Solo Stubs per le modifiche al DOM) ---
                addMenuItem(category) {
                    this.menu[category].push({ nome: 'Nuovo Articolo', prezzo: 0.00, isFinished: false });
                },
                deleteMenuItem(category, index) {
                    if(confirm(`Sei sicuro di voler eliminare ${this.menu[category][index].nome}?`)) {
                        this.menu[category].splice(index, 1);
                    }
                },
                addNewCategory() {
                    if (this.newCategoryName && !this.menu[this.newCategoryName]) {
                        this.menu[this.newCategoryName] = [];
                        this.newCategoryName = '';
                    }
                },
                
                addModifier(category) {
                    if (this.newModifierName) {
                         this.modifiers[category].push({ nome: this.newModifierName, prezzo: this.newModifierPrice || 0.00, isFinished: false });
                         this.newModifierName = '';
                         this.newModifierPrice = 0.00;
                    }
                },
                deleteModifier(category, index) {
                    if(confirm(`Sei sicuro di voler eliminare il modificatore ${this.modifiers[category][index].nome}?`)) {
                        this.modifiers[category].splice(index, 1);
                    }
                },
                addNewModifierCategory() {
                    if (this.newModifierCategoryName && !this.modifiers[this.newModifierCategoryName]) {
                         this.modifiers[this.newModifierCategoryName] = [];
                         this.newModifierCategoryName = '';
                    }
                },

                addDeliveryZone() {
                    if (this.newZoneName) {
                        this.deliveryZones.push({ name: this.newZoneName, price: this.newZonePrice || 0.00 });
                        this.newZoneName = '';
                        this.newZonePrice = 0.00;
                    }
                },
                deleteDeliveryZone(index) {
                     if(confirm(`Sei sicuro di voler eliminare la zona di consegna ${this.deliveryZones[index].name}?`)) {
                        this.deliveryZones.splice(index, 1);
                    }
                },
                
                addDriver() {
                     if (this.newDriverName && !this.drivers.includes(this.newDriverName)) {
                        this.drivers.push(this.newDriverName);
                        // Aggiungi anche alla lista dei driver disponibili per gli ordini
                        if (!this.availableDrivers.includes(this.newDriverName)) {
                            this.availableDrivers.push(this.newDriverName);
                        }
                        this.newDriverName = '';
                    }
                },
                deleteDriver(index) {
                     if(confirm(`Sei sicuro di voler eliminare il fattorino ${this.drivers[index]}?`)) {
                        const driverName = this.drivers[index];
                        this.drivers.splice(index, 1);
                        this.availableDrivers = this.availableDrivers.filter(d => d !== driverName);
                    }
                },
                
            },
            
            mounted() {
                // Simula il calcolo iniziale delle statistiche
                this.calculateDriverStats(); 
                // Aggiorna l'ora per il modale
                this.hour = this.getCurrentHourPlus15Min();
                this.updateCapacityWarning();
            }
        }).mount('#app');
    </script>
</body>
</html>
