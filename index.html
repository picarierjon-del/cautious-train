<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Gestionale SmartApp ‚Äî Fase 1</title>
<meta name="theme-color" content="#0b1223" />
<style>
  :root{
    --bg:#0b1223; --panel:#0f172a; --bar:#0c1426; --muted:#1f2937;
    --ink:#e5e7eb; --ink-dim:#9aa4bf; --ring:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    display:flex; flex-direction:column;
  }

  /* App shell */
  header, footer{
    position:fixed; left:0; right:0; z-index:20; display:flex; align-items:center; gap:8px;
    background:rgba(12,20,38,.92); backdrop-filter:blur(10px); border-bottom:1px solid var(--ring);
  }
  header{ top:0; padding:calc(env(safe-area-inset-top)+8px) 10px 8px; }
  footer{ bottom:0; padding:8px 10px calc(env(safe-area-inset-bottom)+8px); border-top:1px solid var(--ring); border-bottom:none; }

  .brand{font-weight:700}
  .grow{flex:1}
  .btn{cursor:pointer; border:1px solid var(--ring); padding:8px 12px; border-radius:10px;
       background:linear-gradient(180deg,#1f2937,#0b1223); color:var(--ink); font-weight:600}
  .btn.icon{padding:8px; width:42px; justify-content:center}
  .btn.danger{border-color:rgba(239,68,68,.4)}
  .btn.primary{border-color:rgba(59,130,246,.4)}

  main{
    flex:1; display:grid; grid-template-columns:300px 1fr; gap:0; min-height:0;
    margin-top:calc(env(safe-area-inset-top)+60px);
    margin-bottom:calc(env(safe-area-inset-bottom)+64px);
  }
  @media (max-width: 960px){ main{grid-template-columns:1fr} }

  /* Ticket */
  aside{background:var(--panel); border-right:1px solid var(--ring); padding:10px; overflow:auto}
  .line{display:flex; justify-content:space-between; align-items:baseline; gap:8px; flex-wrap:wrap}
  .ticket-item{border-bottom:1px dashed var(--ring); padding:8px 4px; cursor:pointer}
  .ticket-item.active{outline:2px solid #3b82f6; border-radius:8px}
  .qtybtn{background:var(--muted); border:1px solid var(--ring); border-radius:8px; padding:2px 8px; cursor:pointer}
  .extra{font-size:.9rem; color:var(--ink-dim); display:flex; align-items:center; gap:6px; justify-content:space-between}
  .total{padding-top:8px; margin-top:8px; border-top:1px solid var(--ring); font-weight:700}
  .small{font-size:.85rem; opacity:.85}

  /* Stage (tabs + search + grid) */
  .stage{display:flex; flex-direction:column; min-width:0}
  .tabs{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--ring); background:var(--panel); overflow-x:auto}
  .tab{border:1px solid var(--ring); border-radius:10px; padding:6px 10px; cursor:pointer; white-space:nowrap; background:#0e1427}
  .tab.active{outline:2px solid rgba(255,255,255,.18)}
  .searchbox{padding:6px 12px; background:var(--panel); border-bottom:1px solid var(--ring)}
  .searchbox input{width:90%; padding:8px; border-radius:10px; border:1px solid var(--ring); background:#0b1223; color:var(--ink)}
  .grid{flex:1; overflow:auto; padding:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:10px}
  .gridbtn{border:none; border-radius:12px; padding:16px 10px; color:#fff; font-weight:700; cursor:pointer; text-shadow:0 1px 1px rgba(0,0,0,.3)}
  .gridbtn small{display:block; opacity:.9; font-weight:600}

  /* Footer (gruppi modificatori) */
  .quick{border:1px solid var(--ring); border-radius:10px; padding:10px 12px; background:linear-gradient(180deg,#1f2937,#0b1223); color:#fff; cursor:pointer; font-weight:600}

  /* Colori base (puoi espandere) */
  .c-red{background:#ef4444}.c-orange{background:#f97316}.c-yellow{background:#eab308}
  .c-green{background:#22c55e}.c-blue{background:#3b82f6}.c-purple{background:#8b5cf6}
  .c-pink{background:#ec4899}.c-gray{background:#6b7280}.c-slate{background:#475569}
  /* Stampa */
  @media print{
    header, footer, .tabs, .searchbox, .grid{display:none !important}
    main{grid-template-columns:1fr}
    aside{border:none}
    body{background:#fff; color:#000}
  }
</style>
</head>
<body>
<header>
  <div class="brand">üßæ Gestionale SmartApp</div>
  <div class="tabs" id="topTabs" v-scope="App" @vue:mounted="init()">
    <!-- Tabs categorie -->
    <button
      v-for="(g,i) in topGroups" :key="g.label"
      class="tab" :class="{active: currentBottomGroup==null && currentTopIndex===i}"
      @click="currentBottomGroup=null; currentTopIndex=i; search='';"
    >{{ g.icon }} {{ g.label }}</button>
  </div>
  <div class="grow"></div>
  <div class="toolbar" v-scope="App">
    <button class="btn" @click="printOrder" title="Stampa / PDF">üñ®Ô∏è</button>
    <button class="btn" @click="shareWA" title="WhatsApp">üü¢</button>
    <button class="btn" @click="shareEmail" title="Email">‚úâÔ∏è</button>
    <button class="btn" @click="copyOrder" title="Copia riepilogo">üìã</button>
    <button class="btn danger" @click="clearOrder" title="Svuota ordine">üóëÔ∏è</button>
  </div>
</header>

<main>
  <!-- Ticket -->
  <aside v-scope="App">
    <div class="line" style="margin-bottom:6px">
      <strong>Ordine</strong>
      <span class="small">{{ now }}</span>
    </div>

    <template v-if="cart.length>0">
      <div
        class="ticket-item" :class="{active: activeIndex===i}"
        v-for="(it,i) in cart" :key="i"
        @click="activeIndex=i"
      >
        <div class="line">
          <div>
            <strong contenteditable @input="e=>editName(i,e)">{{ it.name }}</strong>
            <span class="small" v-if="it.isService">(servizio)</span>
          </div>
          <div>
            <button class="qtybtn" @click.stop="decQty(i)">‚àí</button>
            <span contenteditable @input="e=>editQty(i,e)">{{ it.qty }}</span>
            <button class="qtybtn" @click.stop="incQty(i)">+</button>
            &nbsp;√ó&nbsp;‚Ç¨ <span contenteditable @input="e=>editPrice(i,e)">{{ it.price.toFixed(2) }}</span>
            <button class="qtybtn" @click.stop="removeItem(i)" title="Elimina">üóëÔ∏è</button>
          </div>
        </div>

        <div class="extra" v-for="(ex,ei) in it.extras" :key="ei">
          <span>‚Ä¢ <span contenteditable @input="e=>editExText(i,ei,e)">{{ ex.text }}</span></span>
          <span class="small">+ ‚Ç¨ <span contenteditable @input="e=>editExPrice(i,ei,e)">{{ ex.price.toFixed(2) }}</span></span>
          <button class="qtybtn" @click.stop="removeExtra(i,ei)">‚úñ</button>
        </div>

        <div class="line">
          <span class="small">Subtotale</span>
          <strong>{{ money(lineTotal(it)) }}</strong>
        </div>
      </div>
    </template>

    <template v-else>
      <div class="small" style="opacity:.7">Nessun articolo ancora.</div>
    </template>

    <div class="total">Totale: <span>{{ money(grandTotal) }}</span></div>
  </aside>

  <!-- Stage -->
  <section class="stage" v-scope="App">
    <div class="searchbox">
      üîç <input type="text" v-model.trim="search" placeholder="Cerca..." />
    </div>

    <div class="grid">
      <!-- Vista CATEGORIE (top) -->
      <template v-if="currentBottomGroup==null">
        <button
          v-for="it in filteredTopItems" :key="it.label"
          class="gridbtn" :class="it.colorClass" :style="bgStyle(it)"
          @click="addItem(it)"
        >
          {{ it.icon }} {{ it.label }} <small>{{ money(it.price) }}</small>
        </button>
      </template>

      <!-- Vista MODIFICATORI (bottom group selezionato) -->
      <template v-else>
        <button
          v-for="ex in filteredBottomItems" :key="ex.label"
          class="gridbtn" :class="ex.colorClass" :style="bgStyle(ex)"
          @click="applyModifier(ex)"
        >
          {{ ex.icon }} {{ ex.label }} <small>{{ money(ex.price) }}</small>
        </button>
      </template>
    </div>
  </section>
</main>

<footer v-scope="App">
  <div style="display:flex;gap:6px;flex-wrap:wrap;overflow-x:auto;width:100%">
    <button
      v-for="g in bottomGroups" :key="g.label"
      class="quick" :style="bgStyle(g)"
      @click="selectBottomGroup(g)"
    >
      {{ g.icon }} {{ g.label }}
    </button>
  </div>
</footer>

<!-- Petite-Vue -->
<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<script>
const money = n => (isNaN(n)?0:n).toLocaleString('it-IT',{style:'currency',currency:'EUR'});

function App(){
  return {
    /* ======== STATO ======== */
    now: new Date().toLocaleString('it-IT', {dateStyle:'short', timeStyle:'short'}),
    search: '',
    activeIndex: -1,
    currentTopIndex: 0,
    currentBottomGroup: null,

    // Palette semplice (puoi estendere)
    palette: {
      'c-red':'#ef4444','c-orange':'#f97316','c-yellow':'#eab308',
      'c-green':'#22c55e','c-blue':'#3b82f6','c-purple':'#8b5cf6',
      'c-pink':'#ec4899','c-gray':'#6b7280','c-slate':'#475569'
    },

    // ==== CONFIG INIZIALE (modificabile a mano in questa fase) ====
    topGroups: [
      {icon:"üçï", label:"Pizze", colorClass:"c-red", items:[
        {icon:"üçï",label:"Margherita",price:6,colorClass:"c-red"},
        {icon:"üå∂Ô∏è",label:"Diavola",price:7,colorClass:"c-red"},
        {icon:"üçÑ",label:"Funghi",price:7,colorClass:"c-green"},
        {icon:"ü•ì",label:"Capricciosa",price:7.5,colorClass:"c-red"},
        {icon:"üïì",label:"Quattro Stagioni",price:7.5,colorClass:"c-red"},
        {icon:"üêÉ",label:"Bufala",price:8,colorClass:"c-pink"}
      ]},
      {icon:"ü•ü", label:"Calzoni", colorClass:"c-orange", items:[
        {icon:"ü•ü",label:"Classico",price:7,colorClass:"c-orange"},
        {icon:"üßÄ",label:"Ripieno",price:8,colorClass:"c-orange"}
      ]},
      {icon:"ü•™", label:"Panini", colorClass:"c-yellow", items:[
        {icon:"üçî",label:"Hamburger",price:5.5,colorClass:"c-yellow"},
        {icon:"üå≠",label:"Hot Dog",price:4.5,colorClass:"c-yellow"}
      ]},
      {icon:"üçû", label:"Schiacciata grande", colorClass:"c-green", items:[
        {icon:"üçû",label:"Semplice",price:9,colorClass:"c-green"}
      ]},
      {icon:"üìè", label:"Mezzo metro", colorClass:"c-blue", items:[
        {icon:"ü•ì",label:"Salumi",price:14,colorClass:"c-blue"}
      ]},
      {icon:"ü•§", label:"Bibite", colorClass:"c-blue", items:[
        {icon:"ü•§",label:"Cola 33cl",price:2,colorClass:"c-blue"},
        {icon:"üíß",label:"Acqua",price:1,colorClass:"c-blue"},
        {icon:"üç∫",label:"Birra",price:3,colorClass:"c-blue"}
      ]},
      {icon:"üßæ", label:"Ordini", colorClass:"c-slate", items:[]}
    ],
    bottomGroups: [
      {icon:"‚ûï",label:"Pi√π",colorClass:"c-green",items:[
        {icon:"üßÄ",label:"Mozzarella",price:1,colorClass:"c-green"},
        {icon:"üçÑ",label:"Funghi",price:1,colorClass:"c-green"},
        {icon:"ü•ì",label:"Prosciutto",price:1.5,colorClass:"c-green"}
      ]},
      {icon:"‚ûñ",label:"Senza",colorClass:"c-gray",items:[
        {icon:"üçÖ",label:"Pomodoro",price:0,colorClass:"c-gray"},
        {icon:"üßÖ",label:"Cipolla",price:0,colorClass:"c-gray"}
      ]},
      {icon:"ü•Ñ",label:"Poco",colorClass:"c-yellow",items:[
        {icon:"ü´í",label:"Olio",price:0,colorClass:"c-yellow"}
      ]},
      {icon:"üçΩÔ∏è",label:"Abbondante",colorClass:"c-purple",items:[
        {icon:"üßÄ",label:"Formaggio",price:1,colorClass:"c-purple"},
        {icon:"ü´í",label:"Olive",price:0.5,colorClass:"c-purple"}
      ]},
      {icon:"üöö",label:"Consegna a domicilio",colorClass:"c-blue",items:[
        {icon:"üöö",label:"Consegna",price:1.5,colorClass:"c-blue",applyToOrder:true}
      ]},
      {icon:"ü•°",label:"Da asporto",colorClass:"c-orange",items:[]},
      {icon:"ü™ë",label:"Banco",colorClass:"c-gray",items:[]}
    ],

    cart: [], // {name, price, qty, extras:[{text, price}], isService?}

    /* ======== LIFECYCLE ======== */
    init(){
      // Aggiorna orologio
      setInterval(()=>{ this.now=new Date().toLocaleString('it-IT',{dateStyle:'short',timeStyle:'short'}) }, 1000);
      // Carica carrello
      const raw = localStorage.getItem('smartapp_cart_v1');
      if(raw){ try{ this.cart = JSON.parse(raw) || []; }catch{} }
      // Salva carrello on-change (osservatore semplice)
      const save = ()=> localStorage.setItem('smartapp_cart_v1', JSON.stringify(this.cart));
      // Hook rudimentale: sovrascrivo push/splice modifiche (semplice e sufficiente qui)
      const origPush = this.cart.push.bind(this.cart);
      this.cart.push = (...args)=>{ const r=origPush(...args); save(); return r; };
      this.$watch('cart', save, {deep:true});
    },

    /* ======== DERIVATI ======== */
    get topItems(){ return (this.topGroups[this.currentTopIndex]?.items)||[]; },
    get filteredTopItems(){
      const q=this.search.toLowerCase();
      return this.topItems.filter(p=>`${p.icon||''} ${p.label}`.toLowerCase().includes(q));
    },
    get filteredBottomItems(){
      const q=this.search.toLowerCase();
      const list=(this.currentBottomGroup?.items)||[];
      return list.filter(p=>`${p.icon||''} ${p.label}`.toLowerCase().includes(q));
    },
    get grandTotal(){
      return this.cart.reduce((sum,it)=> sum + this.lineTotal(it), 0);
    },

    /* ======== FORMATTING / STYLE ======== */
    money, // global formatter
    colorHex(cls){ return this.palette[cls] || '#6b7280'; },
    bgStyle(obj){ const hex=this.colorHex(obj.colorClass); return {background: hex}; },

    /* ======== AZIONI GRIGLIA ======== */
    selectBottomGroup(g){ this.currentBottomGroup=g; this.search=''; },
    addItem(p){
      this.cart.push({name:p.label, price:+p.price||0, qty:1, extras:[], isService:false});
      this.activeIndex=this.cart.length-1;
    },
    applyModifier(ex){
      // Se √® un servizio d'ordine (applyToOrder), aggiungi riga separata
      if(ex.applyToOrder){
        this.cart.push({name:ex.label, price:+ex.price||0, qty:1, extras:[], isService:true});
        this.activeIndex=this.cart.length-1;
        return;
      }
      if(!this.cart.length){ alert('Aggiungi prima un articolo.'); return; }
      const idx = this.activeIndex>=0 ? this.activeIndex : this.cart.length-1;
      const target = this.cart[idx];
      // Prefisso auto (Pi√π/Senza/Poco/Abbondante) dal nome gruppo
      const gname = this.currentBottomGroup?.label || '';
      const prefixNeeded = /Pi√π|Senza|Poco|Abbondante/i.test(gname) ? (gname+' ') : '';
      target.extras.push({text: prefixNeeded + ex.label, price:+ex.price||0});
      this.activeIndex = idx; // mantieni selezione
    },

    /* ======== TICKET ======== */
    lineTotal(it){
      const extras = (it.extras||[]).reduce((s,e)=> s + (+e.price||0), 0);
      return ((+it.price||0) + extras) * (it.qty||1);
    },
    incQty(i){ this.cart[i].qty = (this.cart[i].qty||1)+1; },
    decQty(i){ this.cart[i].qty = Math.max(1,(this.cart[i].qty||1)-1); },
    removeItem(i){ this.cart.splice(i,1); if(this.activeIndex>=this.cart.length) this.activeIndex=this.cart.length-1; },
    removeExtra(i,ei){ this.cart[i].extras.splice(ei,1); },

    // Edit in-line
    editName(i,e){ this.cart[i].name = e.target.textContent.trim(); },
    editQty(i,e){ const n=parseInt(e.target.textContent)||1; this.cart[i].qty = Math.max(1,n); },
    editPrice(i,e){ const n=parseFloat(e.target.textContent.replace(',','.'))||0; this.cart[i].price = n; },
    editExText(i,ei,e){ this.cart[i].extras[ei].text = e.target.textContent.trim(); },
    editExPrice(i,ei,e){ const n=parseFloat(e.target.textContent.replace(',','.'))||0; this.cart[i].extras[ei].price = n; },

    clearOrder(){ if(confirm('Svuotare l‚Äôordine?')){ this.cart.splice(0); this.activeIndex=-1; } },

    /* ======== CONDIVISIONE ======== */
    orderText(){
      const lines = this.cart.map(it=>{
        const cad = (+it.price||0) + (it.extras||[]).reduce((s,e)=>s+(+e.price||0),0);
        const extras = (it.extras||[]).map(e=>`   ‚Ä¢ ${e.text} ${e.price?`(+${money(e.price)})`:''}`).join('\n');
        return `${it.qty}√ó ${it.name} ‚Äî ${money(cad)} cad.\n${extras}`;
      }).join('\n');
      return `ORDINE\n${lines}\nTotale: ${money(this.grandTotal)}\nOra: ${this.now}`;
    },
    printOrder(){ window.print(); },
    async copyOrder(){
      try{ await navigator.clipboard.writeText(this.orderText()); alert('Riepilogo copiato!'); }
      catch{ alert('Copia non disponibile su questo dispositivo.'); }
    },
    shareWA(){
      const t = encodeURIComponent(this.orderText());
      window.open(`https://wa.me/?text=${t}`,'_blank');
    },
    shareEmail(){
      const s = encodeURIComponent('Nuovo ordine');
      const b = encodeURIComponent(this.orderText());
      location.href = `mailto:?subject=${s}&body=${b}`;
    }
  }
}

PetiteVue.createApp({ App }).mount()
</script>
</body>
</html>
