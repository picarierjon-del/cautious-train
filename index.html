<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKx3n1oK55kMvKtK+zW9L0t5iQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary: #FF7043; /* Arancione Caldo */
            --primary-dark: #E65100;
            --secondary: #4CAF50; /* Verde Successo */
            --background: #F4F6F8;
            --surface: #FFFFFF;
            --text-dark: #212121;
            --text-light: #FAFAFA;
            --gray-light: #E0E0E0;
            --gray-medium: #9E9E9E;
            --danger: #E53935;
            --warning: #FFC107;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-dark);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #app {
            display: flex;
            flex: 1;
            max-width: 1400px; /* Limita la larghezza massima per desktop */
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }

        /* --- Sidebar di Navigazione (Sempre Visibile) --- */
        .sidebar {
            width: 80px;
            background-color: var(--surface);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            z-index: 10;
        }

        .sidebar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70px;
            color: var(--gray-medium);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .sidebar-item:hover {
            background-color: var(--gray-light);
        }

        .sidebar-item.active {
            color: var(--primary-dark);
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background-color: var(--primary);
            border-radius: 0 var(--radius) var(--radius) 0;
        }

        .sidebar-item i {
            font-size: 20px;
        }

        .sidebar-item span {
            font-size: 10px;
            margin-top: 4px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            padding: 15px;
            display: flex;
            overflow: hidden; /* Importante per contenere le sotto-colonne */
        }

        /* --- Viste Principali (Gestione, Ordini, Storico, Impostazioni) --- */
        .view-inserimento {
            display: flex;
            flex: 1;
            gap: 15px;
            overflow: hidden;
        }

        .menu-panel, .cart-panel {
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Pannello Menu (Sinistra) --- */
        .menu-panel {
            flex: 2; /* Pi√π largo per visualizzare gli elementi */
            min-width: 400px;
        }

        .menu-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px; /* Spazio per scrollbar */
        }

        .menu-nav button {
            background: none;
            border: 1px solid var(--gray-light);
            padding: 8px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-size: 14px;
            flex-shrink: 0;
        }

        .menu-nav button.active {
            background-color: var(--primary);
            border-color: var(--primary);
            color: var(--text-light);
        }

        .search-bar {
            margin-bottom: 15px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 10px 10px 35px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            font-size: 16px;
        }

        .search-bar i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-medium);
        }

        .menu-list {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }

        .menu-item {
            background-color: var(--gray-light);
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .menu-item:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .menu-item.finished {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--danger);
            color: var(--text-light);
        }

        .item-price {
            font-weight: bold;
            color: var(--primary-dark);
            margin-top: 5px;
        }

        /* --- Pannello Carrello (Destra) --- */
        .cart-panel {
            flex: 1; /* Larghezza fissa, ma minore */
            min-width: 300px;
            max-width: 400px;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: var(--radius);
            cursor: pointer;
            border: 1px solid var(--gray-light);
        }

        .cart-item.selected {
            border-color: var(--primary);
            background-color: var(--primary) 10;
            border-width: 2px;
        }

        .cart-item-info {
            flex: 1;
            padding-right: 10px;
        }

        .cart-item-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cart-item-modifiers {
            font-size: 12px;
            color: var(--gray-medium);
            margin-top: 2px;
            line-height: 1.3;
        }

        .cart-item-price {
            font-weight: bold;
            white-space: nowrap;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }

        .cart-total {
            padding: 10px 0;
            border-top: 1px solid var(--gray-light);
            margin-bottom: 10px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .total-row.delivery {
            font-size: 14px;
            font-weight: normal;
            color: var(--primary);
        }
        
        .total-row.discount {
            font-size: 14px;
            font-weight: normal;
            color: var(--danger);
        }

        .finalize-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--secondary);
            color: var(--text-light);
            border: none;
            border-radius: var(--radius);
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .finalize-btn:hover {
            background-color: #388E3C;
        }
        
        /* --- Pannello Modificatori (Sub-Carrello) --- */
        .modifier-panel {
            width: 300px;
            margin-left: 15px;
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modifier-panel h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .modifier-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .modifier-list {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .modifier-item {
            background-color: var(--gray-light);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            position: relative;
        }

        .modifier-item:hover {
            background-color: var(--gray-medium);
            color: var(--text-light);
        }
        
        .modifier-item.finished {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--danger);
            color: var(--text-light);
        }

        .mod-price {
            font-size: 12px;
            font-weight: bold;
            color: var(--primary-dark);
            margin-top: 2px;
        }
        
        /* --- Altri Pulsanti nel Carrello --- */
        .cart-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .cart-action-btn {
            background: none;
            border: 1px solid var(--gray-light);
            padding: 8px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: var(--text-dark);
        }

        .cart-action-btn:hover {
            background-color: var(--gray-light);
        }

        /* Pulsante Svuota */
        .cart-action-btn.danger {
            color: var(--danger);
            border-color: var(--danger);
        }
        
        /* --- Modali Generiche (Finalizzazione, Composizioni, Prezzo) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-container {
            background-color: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-container h2 {
            margin-bottom: 20px;
            color: var(--primary-dark);
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 10px;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-medium);
        }
        
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius);
            font-size: 16px;
        }
        
        /* Dati di Ritiro/Consegna */
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-selector button {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--gray-light);
            background-color: var(--background);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-medium);
        }

        .mode-selector button.active {
            border-color: var(--primary);
            background-color: var(--primary) 10;
            color: var(--primary-dark);
        }

        .customer-suggestion-list {
            position: absolute;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            background-color: var(--surface);
            border: 1px solid var(--gray-light);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            z-index: 50;
        }

        .customer-suggestion-list div {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-light);
        }

        .customer-suggestion-list div:hover {
            background-color: var(--primary) 10;
        }

        /* Riepilogo Modal */
        .modal-summary {
            padding: 15px;
            background-color: var(--background);
            border-radius: var(--radius);
            margin-top: 15px;
        }

        .modal-summary .total-row {
            font-size: 24px;
            color: var(--secondary);
        }

        .modal-summary .total-row.resto {
            font-size: 16px;
            font-weight: normal;
            margin-top: 5px;
            color: var(--text-dark);
        }

        /* --- Capacit√† Oraria --- */
        .capacity-bar {
            margin-top: 5px;
            padding: 8px;
            background-color: var(--gray-light);
            border-radius: var(--radius);
            text-align: center;
            font-size: 12px;
            font-weight: bold;
        }

        .capacity-bar.warning {
            background-color: var(--warning);
            color: var(--text-dark);
        }

        .capacity-bar.full {
            background-color: var(--danger);
            color: var(--text-light);
        }

        /* --- Viste Secondarie (Ordini Attivi, Storico, Impostazioni) --- */
        .secondary-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .secondary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
            margin-bottom: 15px;
        }

        .secondary-header h1 {
            font-size: 24px;
        }

        .order-list {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            padding-bottom: 15px;
        }

        .order-card {
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            border-left: 5px solid var(--primary);
            position: relative;
        }

        .order-card.ready {
            border-left-color: var(--secondary);
        }
        
        .order-card h4 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .order-card-detail {
            font-size: 14px;
            color: var(--gray-medium);
            margin-bottom: 10px;
        }
        
        .order-card-items {
            list-style: none;
            padding-left: 10px;
            margin-bottom: 15px;
            max-height: 100px;
            overflow-y: auto;
        }

        .order-card-items li {
            font-size: 12px;
            border-left: 2px solid var(--gray-light);
            padding-left: 5px;
            margin-bottom: 2px;
        }

        .order-card-actions {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--gray-light);
            padding-top: 10px;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .btn-edit {
            background-color: var(--primary);
            color: var(--text-light);
        }
        
        .btn-status {
            background-color: var(--secondary);
            color: var(--text-light);
        }

        .btn-archive {
            background-color: var(--danger);
            color: var(--text-light);
        }

        .btn-share {
            background-color: #008060; /* Colore WhatsApp */
            color: var(--text-light);
        }

        /* --- Storico (Storico) --- */
        .history-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .history-controls input, .history-controls select {
             padding: 8px;
             border: 1px solid var(--gray-light);
             border-radius: var(--radius);
        }
        
        .history-summary {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .history-table th, .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .history-table th {
            background-color: var(--primary) 10;
            color: var(--primary-dark);
            font-weight: bold;
        }

        .history-table tr:hover {
            background-color: var(--gray-light);
        }

        .table-action {
            cursor: pointer;
            color: var(--primary);
            font-weight: bold;
        }
        
        /* --- Impostazioni (Settings) --- */
        .settings-container {
            display: flex;
            flex: 1;
            gap: 15px;
        }

        .settings-nav {
            width: 200px;
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            flex-shrink: 0;
        }

        .settings-nav button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: var(--radius);
            transition: background-color 0.2s;
        }

        .settings-nav button:hover {
            background-color: var(--gray-light);
        }

        .settings-nav button.active {
            background-color: var(--primary);
            color: var(--text-light);
        }

        .settings-content {
            flex: 1;
            background-color: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            overflow-y: auto;
        }

        .settings-section h3 {
            color: var(--primary-dark);
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .settings-item.composition-price {
            display: block;
        }
        
        .settings-item.composition-price p {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item input, .settings-item select {
            padding: 5px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            width: 120px;
            text-align: right;
        }

        .item-status-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-light);
        }

        .status-available {
            background-color: var(--secondary);
        }

        .status-finished {
            background-color: var(--danger);
        }
        
        /* Composizioni */
        .composition-row {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            align-items: center;
        }

        .composition-row input {
            width: 80px;
        }
        
        /* PIN Accesso */
        .pin-input {
            width: 200px !important;
            text-align: center !important;
        }

        /* --- Modale Composizioni (Mezzo Metro) --- */
        .meter-modal-content {
            display: flex;
            gap: 20px;
        }

        .meter-setup {
            flex: 1;
        }

        .meter-visual {
            background-color: var(--gray-light);
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 15px;
        }

        .meter-section-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .meter-section {
            flex: 1;
            background-color: var(--surface);
            border: 2px solid var(--gray-light);
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
        }

        .meter-section.active {
            border-color: var(--primary);
            background-color: var(--primary) 10;
        }

        .section-label {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .gusto-selector {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .gusto-list {
            flex: 1;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .gusto-item {
            padding: 8px;
            background-color: var(--gray-light);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .gusto-item.selected {
             background-color: var(--secondary);
             color: var(--text-light);
        }
        
        .half-pizza-visual {
             display: flex;
             gap: 10px;
             margin-bottom: 20px;
        }
        
        .half-pizza-section {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius);
            text-align: center;
        }
        
        .half-pizza-section.active-selection {
             border-color: var(--primary);
             background-color: var(--primary) 10;
        }
        
        /* Totale Modale */
        .modal-total {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: bold;
        }
        
        /* --- Login Modal --- */
        .login-modal-container {
            max-width: 400px;
            text-align: center;
        }

        /* --- Icone Carrello --- */
        .icon-small {
            font-size: 10px;
            margin-right: 3px;
            color: var(--secondary);
        }
        .icon-small.danger {
            color: var(--danger);
        }
        .icon-small.warning {
            color: var(--warning);
        }
        
        /* Colori Pagamento */
        .status-da-pagare {
            color: var(--danger);
            font-weight: bold;
        }
        .status-pagato {
            color: var(--secondary);
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div id="app">
        
        <div class="sidebar">
            <div 
                class="sidebar-item" 
                :class="{ active: view === 'inserimento' }" 
                @click="view = 'inserimento'; selectedItemIndex = null;">
                <i class="fa-solid fa-cash-register"></i>
                <span>Cassa</span>
            </div>
            <div 
                class="sidebar-item" 
                :class="{ active: view === 'ordini' }" 
                @click="view = 'ordini'; selectedItemIndex = null;">
                <i class="fa-solid fa-clipboard-list"></i>
                <span>Ordini</span>
            </div>
            <div 
                class="sidebar-item" 
                :class="{ active: view === 'storico' }" 
                @click="view = 'storico'; selectedItemIndex = null;">
                <i class="fa-solid fa-chart-line"></i>
                <span>Storico</span>
            </div>
            
            <div style="flex: 1;"></div> 

            <div v-if="isAdmin || isOwner" 
                class="sidebar-item" 
                :class="{ active: view === 'impostazioni' }" 
                @click="view = 'impostazioni'; selectedItemIndex = null;">
                <i class="fa-solid fa-gears"></i>
                <span>Impost.</span>
            </div>
            <div 
                class="sidebar-item" 
                @click="isAccessGranted ? logout() : view = 'login';"
                :class="{ 'active': view === 'login' }">
                <i :class="isAccessGranted ? 'fa-solid fa-lock-open' : 'fa-solid fa-lock'"></i>
                <span>{{ isAccessGranted ? 'Logout' : 'Accesso' }}</span>
            </div>
        </div>

        <div class="main-content">

            <div class="view-inserimento" v-if="view === 'inserimento'">

                <div class="menu-panel">
                    <div class="search-bar">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" v-model="searchTerm" placeholder="Cerca articolo o gusto...">
                    </div>
                    
                    <div class="menu-nav">
                        <button 
                            v-for="(items, category) in menu" 
                            :key="category"
                            :class="{ active: activeCat === category }"
                            @click="activeCat = category; searchTerm = '';">
                            {{ category }}
                        </button>
                    </div>

                    <div class="menu-list">
                        <div 
                            v-for="item in filteredAvailableItems" 
                            :key="item.nome"
                            class="menu-item"
                            :class="{ 'finished': item.isFinished }"
                            @click="handleItemClick(item)">
                            <div>{{ item.nome }}</div>
                            <div class="item-price" v-if="!item.isMeter && !item.isHalfPizza">‚Ç¨{{ item.prezzo.toFixed(2) }}</div>
                            <div class="item-price" v-else>Componi <i class="fa-solid fa-hammer"></i></div>
                        </div>
                    </div>
                </div>

                <div class="cart-panel">
                    <h3>Carrello (Ordine Corrente)</h3>
                    
                    <div class="capacity-bar" v-if="date && hour && isAccessGranted" :class="{ 'warning': isCapacityWarning && !isCapacityFull, 'full': isCapacityFull }">
                        Capacit√† {{ orderCapacity.interval }}: {{ orderCapacity.remaining > 0 ? orderCapacity.remaining : 'ESAURITA' }} / {{ orderCapacity.total }} pizze rimaste 
                    </div>

                    <div class="cart-items">
                        <div 
                            v-for="(item, index) in order" 
                            :key="index"
                            class="cart-item"
                            :class="{ 'selected': selectedItemIndex === index }"
                            @click="selectItem(index)">
                            <div class="cart-item-info">
                                <div class="cart-item-name">{{ item.nome }}</div>
                                <div class="cart-item-modifiers">
                                    <span v-if="item.manualPrice !== undefined" style="color: var(--danger); font-weight: bold;">(Prezzo Manuale)</span>
                                    <span v-else-if="item.isHalfPizza">
                                        <i class="icon-small fa-solid fa-pizza-slice"></i> Met√† 1: {{ item.gusto1 }} (+{{ item.modifiers1.length }} extra)
                                        <br>
                                        <i class="icon-small fa-solid fa-pizza-slice"></i> Met√† 2: {{ item.gusto2 }} (+{{ item.modifiers2.length }} extra)
                                    </span>
                                    <span v-else-if="item.isMeter">
                                        <i class="icon-small fa-solid fa-ruler-horizontal"></i> {{ item.gustoCount }} gusti unici
                                    </span>
                                    <span v-else>
                                        {{ item.modifiers.map(mod => getModifierIcon(getModifierCategory(mod.nome)) + ' ' + mod.nome).join(', ') }}
                                    </span>
                                </div>
                            </div>
                            <div class="cart-item-price">‚Ç¨{{ calculateItemTotal(item).toFixed(2) }}</div>
                            <button class="remove-btn" @click.stop="removeItem(index)"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div v-if="order.length === 0" style="text-align: center; margin-top: 20px; color: var(--gray-medium);">Il carrello √® vuoto.</div>
                    </div>

                    <div class="cart-actions">
                        <button class="cart-action-btn danger" @click="resetOrder"><i class="fa-solid fa-trash-can"></i> Svuota</button>
                        <button 
                            class="cart-action-btn" 
                            :disabled="selectedItemIndex === null || order[selectedItemIndex].isHalfPizza || order[selectedItemIndex].isMeter"
                            @click="openPriceEditModal(selectedItemIndex)">
                            <i class="fa-solid fa-pencil"></i> Modifica Prezzo
                        </button>
                    </div>

                    <div class="cart-total">
                        <div class="total-row" v-if="discount > 0">
                            <span>Sconto ({{ discountPercentage > 0 ? discountPercentage + '%' : 'Fisso' }})</span>
                            <span class="discount">- ‚Ç¨{{ discount.toFixed(2) }}</span>
                        </div>
                        <div class="total-row delivery" v-if="deliveryCost > 0">
                            <span>Costo Consegna</span>
                            <span>+ ‚Ç¨{{ deliveryCost.toFixed(2) }}</span>
                        </div>
                        <div class="total-row">
                            <span>TOTALE PARZIALE</span>
                            <span>‚Ç¨{{ calculatedOrderTotal.toFixed(2) }}</span>
                        </div>
                        <div class="total-row" style="font-size: 24px; color: var(--primary);">
                            <span>TOTALE FINALE</span>
                            <span>‚Ç¨{{ total.toFixed(2) }}</span>
                        </div>
                    </div>

                    <button class="finalize-btn" @click="openFinalizeModal()">
                        <i class="fa-solid fa-check"></i> Finalizza Ordine
                    </button>
                </div>
                
                <div class="modifier-panel" v-if="selectedItemIndex !== null && !order[selectedItemIndex].isMeter && !order[selectedItemIndex].isHalfPizza">
                    <h3>Modifica Articolo Selezionato</h3>
                    
                    <div class="modifier-tabs">
                        <button 
                            v-for="(mods, category) in modifiers" 
                            :key="category"
                            :class="{ active: activeModCat === category }"
                            @click="activeModCat = category; modifierSearchTerm = '';">
                            {{ category }}
                        </button>
                    </div>

                    <div class="search-bar">
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore...">
                    </div>

                    <div class="modifier-list">
                        <div 
                            v-for="mod in filteredModifiersForActiveCat" 
                            :key="mod.nome"
                            class="modifier-item"
                            :class="{ 'finished': mod.isFinished }"
                            @click="addExtra(mod)">
                            <div>{{ mod.nome }}</div>
                            <div class="mod-price" v-if="mod.prezzo > 0">+ ‚Ç¨{{ mod.prezzo.toFixed(2) }}</div>
                            <div class="mod-price" v-else-if="activeModCat === 'Senza'">Rimuovi</div>
                            <div class="mod-price" v-else>Gratis</div>
                        </div>
                    </div>
                </div>
                
                <div class="modifier-panel" v-else-if="selectedItemIndex !== null && (order[selectedItemIndex].isMeter || order[selectedItemIndex].isHalfPizza)">
                    <h3>Composizione complessa</h3>
                    <p style="color: var(--gray-medium); text-align: center; padding: 20px;">
                        L'articolo selezionato ({{ order[selectedItemIndex].nome }}) √® una composizione.<br> 
                        Per modificarla, eliminala e ricreala, oppure usa il pulsante *Modifica Prezzo*.
                    </p>
                </div>
            </div>
            
            <div class="modal-overlay" v-if="view === 'login'">
                <div class="modal-container login-modal-container">
                    <h2>Accesso Pizzeria Smart</h2>
                    <div class="form-group">
                        <label for="pin-input">Inserisci PIN/Password:</label>
                        <input type="password" id="pin-input" v-model="accessPin" @keyup.enter="grantAccess" class="pin-input" maxlength="4">
                    </div>
                    <button class="finalize-btn" @click="grantAccess"><i class="fa-solid fa-key"></i> Accedi</button>
                    <p style="margin-top: 15px; font-size: 12px; color: var(--gray-medium);">
                        PIN Operatore/Admin: ****<br>
                        PIN Titolare: ****
                    </p>
                </div>
            </div>

            <div class="secondary-view" v-else-if="view === 'ordini' && isAdmin">
                <div class="secondary-header">
                    <h1>Ordini Attivi</h1>
                    <div class="history-controls">
                        <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca cliente/tavolo...">
                         <select v-model="activeDateFilter">
                            <option value="today">Oggi</option>
                            <option value="tomorrow">Domani</option>
                            <option value="future">Futuro</option>
                            <option value="all">Tutti</option>
                        </select>
                    </div>
                </div>

                <div class="order-list">
                    <div 
                        v-for="order in filteredActiveOrders" 
                        :key="order.id"
                        class="order-card"
                        :class="{ 'ready': order.status === 'Ready' }">
                        
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4>Ordine #{{ order.id }} - {{ order.mode === 'banco' ? `Tavolo ${order.tableNumber}` : order.customer }}</h4>
                            <span :class="order.paymentStatus === 'Pagato' ? 'status-pagato' : 'status-da-pagare'">{{ order.paymentStatus }}</span>
                        </div>
                        
                        <div class="order-card-detail">
                            <i :class="getModeIcon(order.mode)"></i> {{ getModeName(order.mode) }} | 
                            <i class="fa-regular fa-calendar"></i> {{ formatDate(order.date) }} <i class="fa-regular fa-clock"></i> {{ order.hour }}
                            <span v-if="order.mode === 'consegna'">| {{ order.address }}</span>
                        </div>

                        <ul class="order-card-items">
                            <li v-for="(item, i) in order.items" :key="i">
                                {{ item.nome }}
                            </li>
                        </ul>
                        
                        <div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">Totale: ‚Ç¨{{ order.total.toFixed(2) }}</div>

                        <div class="order-card-actions">
                            <button class="action-btn btn-edit" @click="openEditOrderModal(order.id)"><i class="fa-solid fa-pen-to-square"></i> Modifica</button>
                            <button class="action-btn btn-status" :style="{ backgroundColor: order.status === 'Pending' ? 'var(--primary-dark)' : 'var(--secondary)' }" @click="toggleOrderStatus(order.id)">
                                {{ order.status === 'Pending' ? 'In Preparazione' : 'PRONTO!' }}
                            </button>
                            <button class="action-btn btn-share" @click="openShareModal(order)"><i class="fa-brands fa-whatsapp"></i></button>
                            <button class="action-btn btn-archive" @click="archiveOrder(order.id)"><i class="fa-solid fa-box-archive"></i> Archivia</button>
                        </div>
                    </div>
                    
                    <div v-if="filteredActiveOrders.length === 0" style="grid-column: 1 / -1; text-align: center; padding: 50px; color: var(--gray-medium);">
                         Nessun ordine attivo trovato per i filtri selezionati.
                    </div>
                </div>
            </div>
            
            <div class="secondary-view" v-else-if="view === 'storico' && isAdmin">
                <div class="secondary-header">
                    <h1>Storico Archiviato</h1>
                </div>
                
                <div class="history-controls">
                    <label>Seleziona Giorno:</label>
                    <input type="date" v-model="archiveDateFilter">
                    <label>Fattorino (Filtro):</label>
                    <select v-model="selectedDriver">
                        <option value="">Tutti</option>
                        <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                    </select>
                    
                    <div class="history-summary">
                        Totale del giorno ({{ archiveDateFilterDisplay }}): **‚Ç¨{{ dailyTotal.toFixed(2) }}**
                    </div>
                </div>

                <div v-if="selectedDriver" class="history-summary" style="margin-bottom: 15px;">
                    Statistiche per **{{ selectedDriver }}**: {{ driverStats.totalOrders }} Ordini | Totale ‚Ç¨{{ driverStats.totalRevenue.toFixed(2) }}
                </div>
                
                <div style="flex: 1; overflow-y: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ora</th>
                                <th>Cliente/Tavolo</th>
                                <th>Modalit√†</th>
                                <th>Fattorino</th>
                                <th>Totale</th>
                                <th>Pagato</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in filteredArchive" :key="order.id">
                                <td>#{{ order.id }}</td>
                                <td>{{ order.hour }}</td>
                                <td>{{ order.customer || order.tableNumber || 'N/A' }}</td>
                                <td>{{ getModeName(order.mode) }}</td>
                                <td>{{ order.driver || '-' }}</td>
                                <td>‚Ç¨{{ order.total.toFixed(2) }}</td>
                                <td :class="order.paymentStatus === 'Pagato' ? 'status-pagato' : 'status-da-pagare'">{{ order.paymentStatus }}</td>
                                <td><span class="table-action" @click="showArchiveDetails(order)">Dettagli</span></td>
                            </tr>
                            <tr v-if="filteredArchive.length === 0">
                                <td colspan="8" style="text-align: center; color: var(--gray-medium);">Nessun ordine archiviato per questa data.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="secondary-view" v-else-if="view === 'impostazioni' && isOwner">
                <div class="secondary-header">
                    <h1>Impostazioni di Sistema</h1>
                </div>

                <div class="settings-container">
                    <div class="settings-nav">
                        <button :class="{ active: activeSettingsView === 'menu' }" @click="activeSettingsView = 'menu'">Menu e Prezzi</button>
                        <button :class="{ active: activeSettingsView === 'modifiers' }" @click="activeSettingsView = 'modifiers'">Modificatori</button>
                        <button :class="{ active: activeSettingsView === 'composition' }" @click="activeSettingsView = 'composition'">Composizioni</button>
                        <button :class="{ active: activeSettingsView === 'capacity' }" @click="activeSettingsView = 'capacity'">Capacit√† Oraria</button>
                        <button :class="{ active: activeSettingsView === 'delivery' }" @click="activeSettingsView = 'delivery'">Consegna e Fattorini</button>
                        <button :class="{ active: activeSettingsView === 'security' }" @click="activeSettingsView = 'security'">Sicurezza (PIN)</button>
                    </div>

                    <div class="settings-content">
                        
                        <div v-if="activeSettingsView === 'menu'" class="settings-section">
                            <h3>Gestione Menu Principale</h3>
                            <div class="menu-nav">
                                <button 
                                    v-for="(items, category) in menu" 
                                    :key="category"
                                    :class="{ active: activeSettingsCat === category }"
                                    @click="activeSettingsCat = category">
                                    {{ category }}
                                </button>
                                <button @click="addNewCategory('menu')"><i class="fa-solid fa-plus"></i> Categoria</button>
                            </div>

                            <div v-if="menu[activeSettingsCat]">
                                <div v-for="(item, index) in menu[activeSettingsCat]" :key="index" class="settings-item">
                                    <input type="text" v-model="item.nome" style="flex: 1; margin-right: 10px; text-align: left;">
                                    <input type="number" step="0.01" v-model.number="item.prezzo" :disabled="item.isMeter || item.isHalfPizza">
                                    <button 
                                        :class="['item-status-btn', item.isFinished ? 'status-finished' : 'status-available']"
                                        @click="toggleItemStatus(activeSettingsCat, index)">
                                        {{ item.isFinished ? 'Esaurito' : 'Disponibile' }}
                                    </button>
                                    <button class="item-status-btn status-finished" style="margin-left: 10px;" @click="removeItemFromMenu(activeSettingsCat, index)"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                                <button class="finalize-btn" style="margin-top: 15px;" @click="addNewItemToMenu(activeSettingsCat)"><i class="fa-solid fa-plus"></i> Aggiungi Articolo</button>
                                <button class="finalize-btn danger" style="margin-top: 15px; margin-left: 10px; background-color: var(--danger);" @click="removeItemFromMenu(activeSettingsCat, -1)">Rimuovi Categoria</button>
                            </div>
                        </div>
                        
                        <div v-else-if="activeSettingsView === 'modifiers'" class="settings-section">
                            <h3>Gestione Modificatori</h3>
                            <div class="menu-nav">
                                <button 
                                    v-for="(mods, category) in modifiers" 
                                    :key="category"
                                    :class="{ active: activeSettingsModCat === category }"
                                    @click="activeSettingsModCat = category">
                                    {{ category }}
                                </button>
                                <button @click="addNewCategory('modifiers')"><i class="fa-solid fa-plus"></i> Categoria</button>
                            </div>
                            
                            <div v-if="modifiers[activeSettingsModCat]">
                                <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" class="settings-item">
                                    <input type="text" v-model="mod.nome" style="flex: 1; margin-right: 10px; text-align: left;">
                                    <input type="number" step="0.01" v-model.number="mod.prezzo" :disabled="activeSettingsModCat === 'Senza' || activeSettingsModCat === 'Poco' || activeSettingsModCat === 'Abbondante'">
                                    <button 
                                        :class="['item-status-btn', mod.isFinished ? 'status-finished' : 'status-available']"
                                        @click="toggleModifierStatus(activeSettingsModCat, index)">
                                        {{ mod.isFinished ? 'Esaurito' : 'Disponibile' }}
                                    </button>
                                    <button class="item-status-btn status-finished" style="margin-left: 10px;" @click="removeItemFromModifiers(activeSettingsModCat, index)"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                                <button class="finalize-btn" style="margin-top: 15px;" @click="addNewItemToModifiers(activeSettingsModCat)"><i class="fa-solid fa-plus"></i> Aggiungi Modificatore</button>
                            </div>
                         </div>
                         
                         <div v-else-if="activeSettingsView === 'composition'" class="settings-section">
                             <h3>Gestione Prezzi Composizioni</h3>
                             
                             <div v-for="(prices, compName) in compositionPrices" :key="compName" class="settings-item composition-price">
                                 <p>{{ compName }} (Prezzo Base: Minimo Gusti)</p>
                                 <div v-for="(price, count) in prices" :key="count" class="composition-row">
                                     <span v-if="count !== 'baseSections'">Prezzo per {{ count }} Gusti:</span>
                                     <span v-if="count === 'baseSections'">Sezioni Totali:</span>
                                     <input type="number" step="0.01" v-model.number="compositionPrices[compName][count]" style="width: 100px;">
                                 </div>
                             </div>
                             
                             <p style="margin-top: 20px; color: var(--gray-medium);">
                                 *Nota: La "Pizza a Met√†" usa un calcolo automatico basato sulla media dei prezzi dei due gusti selezionati (arrotondata all'intero superiore).
                             </p>
                         </div>

                        <div v-else-if="activeSettingsView === 'capacity'" class="settings-section">
                            <h3>Gestione Capacit√† Forno</h3>
                            
                            <div class="settings-item">
                                <span>Pizze massime per Intervallo:</span>
                                <input type="number" v-model.number="capacitySettings.maxPizzas">
                            </div>
                            
                            <div class="settings-item">
                                <span>Durata Intervallo (minuti):</span>
                                <input type="number" v-model.number="capacitySettings.intervalMinutes">
                            </div>
                            
                            <p style="margin-top: 20px; color: var(--gray-medium);">
                                La capacit√† √® calcolata per intervallo di tempo. Gli ordini che superano la capacit√† mostreranno un avviso nella cassa.
                            </p>
                        </div>
                        
                        <div v-else-if="activeSettingsView === 'delivery'" class="settings-section">
                            <h3>Gestione Zone di Consegna</h3>
                            
                            <div v-for="(zone, index) in deliveryZones" :key="index" class="settings-item">
                                <input type="text" v-model="zone.name" style="flex: 1; margin-right: 10px; text-align: left;">
                                <span>Costo:</span>
                                <input type="number" step="0.01" v-model.number="zone.price">
                                <button class="item-status-btn status-finished" style="margin-left: 10px;" @click="removeDeliveryZone(index)"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                            <button class="finalize-btn" style="margin-top: 15px;" @click="addDeliveryZone"><i class="fa-solid fa-plus"></i> Aggiungi Zona</button>
                            
                            <h3 style="margin-top: 30px;">Gestione Fattorini</h3>
                            <div v-for="(driver, index) in drivers" :key="index" class="settings-item">
                                <input type="text" v-model="drivers[index]" style="flex: 1; margin-right: 10px; text-align: left;">
                                <button class="item-status-btn status-finished" style="margin-left: 10px;" @click="removeDriver(index)"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                            <button class="finalize-btn" style="margin-top: 15px;" @click="addDriver"><i class="fa-solid fa-plus"></i> Aggiungi Fattorino</button>
                        </div>

                        <div v-else-if="activeSettingsView === 'security'" class="settings-section">
                            <h3>Cambio PIN/Password</h3>

                            <div class="form-group">
                                <label>Nuovo PIN Operatore/Admin (min 4 cifre):</label>
                                <input type="password" v-model="newAdminPin" class="pin-input">
                                <button class="finalize-btn" style="width: auto; margin-left: 10px;" @click="saveAdminPin">Salva Admin</button>
                            </div>

                            <div class="form-group">
                                <label>Nuovo PIN Titolare/Owner (min 4 cifre):</label>
                                <input type="password" v-model="newOwnerPin" class="pin-input">
                                <button class="finalize-btn" style="width: auto; margin-left: 10px;" @click="saveOwnerPin">Salva Titolare</button>
                            </div>
                            
                            <p style="margin-top: 20px; color: var(--danger); font-weight: bold;">
                                ATTENZIONE: Se perdi il PIN Titolare, non potrai pi√π accedere a questa sezione!
                            </p>
                        </div>

                    </div>
                </div>
            </div>

            <div class="secondary-view" v-else>
                 <div class="secondary-header">
                    <h1>Accesso Ristretto</h1>
                </div>
                <div style="text-align: center; padding: 50px; color: var(--danger);">
                    <i class="fa-solid fa-triangle-exclamation" style="font-size: 40px; margin-bottom: 20px;"></i>
                    <p>Non hai i permessi necessari per visualizzare questa sezione.</p>
                    <p>Effettua l'accesso come **Operatore** o **Titolare**.</p>
                </div>
            </div>

        </div> <div class="modal-overlay" v-if="showModal" @click.self="closeFinalizeModal">
            <div class="modal-container">
                <button class="modal-close-btn" @click="closeFinalizeModal"><i class="fa-solid fa-xmark"></i></button>
                <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Dettagli Finalizzazione Ordine' }}</h2>
                
                <div class="mode-selector">
                    <button :class="{ active: mode === 'banco' }" @click="mode = 'banco'"><i class="fa-solid fa-utensils"></i> Tavolo/Banco</button>
                    <button :class="{ active: mode === 'asporto' }" @click="mode = 'asporto'"><i class="fa-solid fa-bag-shopping"></i> Asporto</button>
                    <button :class="{ active: mode === 'consegna' }" @click="mode = 'consegna'"><i class="fa-solid fa-truck"></i> Consegna</button>
                </div>
                
                <div class="form-group" v-if="mode === 'banco'">
                    <label for="tableNumber">Numero Tavolo / Note Banco</label>
                    <input type="text" id="tableNumber" v-model="tableNumber">
                </div>
                
                <template v-else>
                    <div class="form-group" style="position: relative;">
                        <label for="customer">Nome Cliente</label>
                        <input type="text" id="customer" v-model="customer" @input="suggestCustomers">
                        <div class="customer-suggestion-list" v-if="filteredCustomerSuggestions.length > 0">
                            <div v-for="c in filteredCustomerSuggestions" :key="c.phone" @click="selectCustomerSuggestion(c)">
                                <strong>{{ c.name }}</strong> ({{ c.phone }})
                                <span v-if="c.address"> - {{ c.address.split(',')[0] }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="phone">Telefono</label>
                        <input type="tel" id="phone" v-model="phone">
                    </div>
                </template>
                
                <div class="form-group" v-if="mode === 'consegna'">
                    <label for="address">Indirizzo e N¬∞ Civico</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="address" v-model="address" placeholder="Via/Piazza..." style="flex: 3;">
                        <input type="text" id="streetNumber" v-model="streetNumber" placeholder="N¬∞" style="flex: 1;">
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="text" id="town" v-model="town" placeholder="Citt√†/Comune" style="flex: 1;">
                        <select v-model="zoneName" style="flex: 1;">
                            <option value="">Seleziona Zona di Consegna</option>
                            <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">{{ zone.name }} (‚Ç¨{{ zone.price.toFixed(2) }})</option>
                        </select>
                    </div>
                    <div v-if="zoneName" style="margin-top: 5px; font-size: 12px; color: var(--primary-dark);">
                        Costo Consegna: **‚Ç¨{{ deliveryCost.toFixed(2) }}**
                    </div>
                </div>

                <div class="form-group">
                    <label for="datetime">Data e Ora Ritiro/Consegna</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="date" v-model="date" :min="minDate" style="flex: 1;" @change="updateCapacityWarning">
                        <input type="time" id="hour" v-model="hour" style="flex: 1;" @change="updateCapacityWarning">
                    </div>
                     <div class="capacity-bar" v-if="isAccessGranted && date && hour" :class="{ 'warning': isCapacityWarning && !isCapacityFull, 'full': isCapacityFull }">
                        Capacit√† {{ orderCapacity.interval }}: {{ orderCapacity.remaining > 0 ? orderCapacity.remaining : 'ESAURITA' }} / {{ orderCapacity.total }} pizze rimaste 
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Note (es. Senza glutine, Ritardo 5 minuti)</label>
                    <textarea id="notes" v-model="notes" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="discount">Sconto</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" step="0.01" v-model.number="discount" placeholder="Valore Fisso (‚Ç¨)" style="flex: 1;">
                        <input type="number" step="1" v-model.number="discountPercentage" placeholder="Percentuale (%)" style="flex: 1;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paymentStatus">Stato Pagamento</label>
                    <div style="display: flex; gap: 10px;">
                        <select v-model="paymentStatus" style="flex: 1;">
                            <option value="Da Pagare">Da Pagare</option>
                            <option value="Pagato">Pagato</option>
                            <option value="Acconto">Acconto</option>
                        </select>
                        <input v-if="paymentStatus !== 'Pagato' && paymentStatus !== 'Da Pagare'" type="number" step="0.01" v-model.number="accontoRicevuto" placeholder="Acconto Ricevuto (‚Ç¨)" style="flex: 1;">
                    </div>
                </div>


                <div class="modal-summary">
                    <div class="total-row">
                        <span>Totale Ordine:</span>
                        <span>‚Ç¨{{ total.toFixed(2) }}</span>
                    </div>
                    <div class="total-row resto" v-if="accontoRicevuto > 0 && accontoRicevuto >= total">
                        <span>Resto da dare:</span>
                        <span>‚Ç¨{{ restoDaDare.toFixed(2) }}</span>
                    </div>
                </div>

                <button class="finalize-btn" style="margin-top: 20px;" @click="saveOrder">
                    <i class="fa-solid fa-floppy-disk"></i> {{ editingOrderId ? 'Salva Modifiche' : 'Salva e Invia Ordine' }}
                </button>
            </div>
        </div>

        <div class="modal-overlay" v-if="showPriceEditModal" @click.self="showPriceEditModal = false">
            <div class="modal-container" style="max-width: 400px;">
                <button class="modal-close-btn" @click="showPriceEditModal = false"><i class="fa-solid fa-xmark"></i></button>
                <h2>Modifica Prezzo Articolo</h2>
                
                <div class="form-group">
                    <label>Articolo:</label>
                    <p style="font-size: 18px; font-weight: bold;">{{ order[tempPriceEditIndex]?.nome }}</p>
                </div>

                <div class="form-group">
                    <label for="newPrice">Nuovo Prezzo Manuale (‚Ç¨)</label>
                    <input type="number" id="newPrice" step="0.01" v-model.number="newPriceValue">
                </div>
                
                <p style="margin-bottom: 15px;">
                    Prezzo Calcolato Automaticamente: **‚Ç¨{{ calculateItemTotal(order[tempPriceEditIndex]).toFixed(2) }}**
                </p>

                <button class="finalize-btn" @click="saveNewPrice"><i class="fa-solid fa-check"></i> Imposta Prezzo</button>
                <button class="cart-action-btn danger" style="width: 100%; margin-top: 10px;" @click="resetManualPrice"><i class="fa-solid fa-rotate-left"></i> Ripristina Prezzo Automatico</button>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showMeterModal" @click.self="cancelMeterComposition">
            <div class="modal-container" style="max-width: 900px;">
                <button class="modal-close-btn" @click="cancelMeterComposition"><i class="fa-solid fa-xmark"></i></button>
                <h2>Componi: {{ tempMeterItem?.nome }}</h2>

                <div class="meter-modal-content">
                    
                    <div class="meter-setup">
                        <h3>1. Seleziona N¬∞ Gusti</h3>
                        <div class="mode-selector">
                            <button 
                                v-for="(price, count) in compositionPrices[tempMeterItem?.nome]"
                                v-if="count !== 'baseSections'"
                                :key="count"
                                :class="{ active: tempMeterItem.gustoCount === parseInt(count) }"
                                @click="setMeterGustoCount(parseInt(count))">
                                {{ count }} Gusti (‚Ç¨{{ price.toFixed(2) }})
                            </button>
                        </div>
                        
                        <h3 style="margin-top: 15px;">2. Configura Sezioni ({{ tempMeterItem?.sections.length || 0 }} Sezioni)</h3>
                        <div class="meter-visual">
                            <div class="meter-section-container">
                                <div 
                                    v-for="(section, index) in tempMeterItem?.sections" 
                                    :key="index"
                                    class="meter-section"
                                    :class="{ 'active': section.activeSection || section.gusto !== null }"
                                    @click="tempMeterItem.sections.forEach((s, i) => s.activeSection = i === index)">
                                    <div class="section-label">{{ section.name }}</div>
                                    <div style="font-size: 10px; color: var(--primary-dark);">{{ section.gusto || 'GUSTO MANCANTE' }}</div>
                                    <div v-if="section.modifiers.length > 0" style="font-size: 8px; color: var(--gray-medium);">+ {{ section.modifiers.length }} Modificatori</div>
                                </div>
                            </div>
                            <div v-if="tempMeterItem?.gustoCount > 0" style="text-align: center; font-size: 12px; color: var(--primary-dark); font-weight: bold;">
                                Gusti Unici Selezionati: {{ tempMeterGusti.length }} / {{ tempMeterItem.gustoCount }}
                            </div>
                        </div>
                        
                        <h3 style="margin-top: 15px;">3. Aggiungi Modificatori (Sezione: {{ tempMeterItem?.sections.find(s => s.activeSection)?.name || 'N/A' }})</h3>
                        <div class="modifier-tabs">
                             <button 
                                v-for="(mods, category) in modifiers" 
                                :key="category"
                                :class="{ active: tempModCat === category }"
                                @click="tempModCat = category; modifierSearchTerm = '';">
                                {{ category }}
                            </button>
                        </div>
                        <div class="modifier-list" style="max-height: 150px;">
                             <div 
                                v-for="mod in filteredTempModifiers" 
                                :key="mod.nome"
                                class="modifier-item"
                                :class="{ 'finished': mod.isFinished }"
                                @click="addMeterModifier(tempMeterItem?.sections.findIndex(s => s.activeSection), mod)">
                                <div>{{ mod.nome }}</div>
                            </div>
                        </div>

                    </div>
                    
                    <div class="gusto-selector">
                        <h3>4. Seleziona Gusto</h3>
                        
                         <div class="search-bar">
                            <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto...">
                        </div>
                        
                        <div class="gusto-list">
                             <div 
                                v-for="gusto in filteredPizzaGusti" 
                                :key="gusto.nome"
                                class="gusto-item"
                                :class="{ 'selected': tempMeterGusti.includes(gusto.nome) }"
                                @click="selectMeterGusto(tempMeterItem?.sections.findIndex(s => s.activeSection), gusto.nome)">
                                {{ gusto.nome }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-total">
                    <span>Totale Composizione:</span>
                    <span :style="{ color: isMeterValid ? 'var(--secondary)' : 'var(--danger)' }">‚Ç¨{{ calculateTempMeterTotal.toFixed(2) }}</span>
                </div>
                
                <button class="finalize-btn" style="margin-top: 20px;" :disabled="!isMeterValid" @click="addMeterToOrder">
                    <i class="fa-solid fa-plus"></i> Aggiungi al Carrello
                </button>
            </div>
        </div>

        <div class="modal-overlay" v-if="showHalfPizzaModal" @click.self="cancelHalfPizzaComposition">
            <div class="modal-container" style="max-width: 900px;">
                <button class="modal-close-btn" @click="cancelHalfPizzaComposition"><i class="fa-solid fa-xmark"></i></button>
                <h2>Componi: {{ tempHalfPizzaItem?.nome }}</h2>

                <div class="meter-modal-content">
                    
                    <div class="meter-setup">
                        <h3 style="margin-bottom: 15px;">1. Configura Met√†</h3>
                        <div class="half-pizza-visual">
                             <div class="half-pizza-section" :class="{ 'active-selection': tempHalfPizzaItem?.activeHalf === 1 }" @click="tempHalfPizzaItem.activeHalf = 1">
                                 <div class="section-label">Met√† 1</div>
                                 <div style="font-weight: bold; color: var(--secondary);">{{ tempHalfPizzaItem?.gusto1 || 'SELEZIONA GUSTO' }}</div>
                                 <div v-if="tempHalfPizzaItem?.modifiers1.length > 0" style="font-size: 12px; color: var(--gray-medium);">+ {{ tempHalfPizzaItem.modifiers1.length }} Modificatori</div>
                             </div>
                             <div class="half-pizza-section" :class="{ 'active-selection': tempHalfPizzaItem?.activeHalf === 2 }" @click="tempHalfPizzaItem.activeHalf = 2">
                                 <div class="section-label">Met√† 2</div>
                                 <div style="font-weight: bold; color: var(--secondary);">{{ tempHalfPizzaItem?.gusto2 || 'SELEZIONA GUSTO' }}</div>
                                 <div v-if="tempHalfPizzaItem?.modifiers2.length > 0" style="font-size: 12px; color: var(--gray-medium);">+ {{ tempHalfPizzaItem.modifiers2.length }} Modificatori</div>
                             </div>
                        </div>

                        <h3 style="margin-top: 15px;">2. Aggiungi Modificatori (Met√† {{ tempHalfPizzaItem?.activeHalf }})</h3>
                        <div class="modifier-tabs">
                             <button 
                                v-for="(mods, category) in modifiers" 
                                :key="category"
                                :class="{ active: tempModCat === category }"
                                @click="tempModCat = category; modifierSearchTerm = '';">
                                {{ category }}
                            </button>
                        </div>
                        <div class="modifier-list" style="max-height: 150px;">
                             <div 
                                v-for="mod in filteredTempModifiers" 
                                :key="mod.nome"
                                class="modifier-item"
                                :class="{ 'finished': mod.isFinished }"
                                @click="addHalfPizzaModifier(tempHalfPizzaItem?.activeHalf, mod)">
                                <div>{{ mod.nome }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gusto-selector">
                        <h3>3. Seleziona Gusto per Met√† {{ tempHalfPizzaItem?.activeHalf }}</h3>
                        
                         <div class="search-bar">
                            <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto...">
                        </div>
                        
                        <div class="gusto-list">
                             <div 
                                v-for="gusto in filteredPizzaGusti" 
                                :key="gusto.nome"
                                class="gusto-item"
                                @click="selectHalfPizzaGusto(tempHalfPizzaItem?.activeHalf, gusto.nome)">
                                {{ gusto.nome }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-total">
                    <span>Totale Composizione Stimato:</span>
                    <span :style="{ color: isHalfPizzaValid ? 'var(--secondary)' : 'var(--danger)' }">‚Ç¨{{ calculateTempHalfPizzaTotal.toFixed(2) }}</span>
                </div>
                
                <button class="finalize-btn" style="margin-top: 20px;" :disabled="!isHalfPizzaValid" @click="addHalfPizzaToOrder">
                    <i class="fa-solid fa-plus"></i> Aggiungi al Carrello
                </button>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showShareModal" @click.self="showShareModal = false">
            <div class="modal-container" style="max-width: 600px;">
                <button class="modal-close-btn" @click="showShareModal = false"><i class="fa-solid fa-xmark"></i></button>
                <h2>Condividi Riepilogo Ordine #{{ selectedOrderForShare?.id }}</h2>
                
                <div class="form-group">
                    <label for="share-content">Riepilogo Testuale:</label>
                    <textarea id="share-content" :value="generateShareText(selectedOrderForShare)" rows="10" readonly style="font-family: monospace;"></textarea>
                </div>
                
                <button class="finalize-btn" @click="copyShareText"><i class="fa-solid fa-copy"></i> Copia Testo</button>
                
                <a :href="'https://wa.me/?text=' + encodeURIComponent(generateShareText(selectedOrderForShare))" 
                   target="_blank" 
                   class="finalize-btn" 
                   style="background-color: #25D366; margin-top: 10px; display: block; text-align: center; text-decoration: none;">
                   <i class="fa-brands fa-whatsapp"></i> Invia su WhatsApp
                </a>
            </div>
        </div>

    </div> ```

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';

        const app = createApp({
            data() {
                return {
                    // --- Stato UI e Accesso ---
                    view: 'login', // login, inserimento, ordini, storico, impostazioni
                    isAccessGranted: false,
                    isAdmin: false, // Operatore/Admin (pu√≤ vedere ordini e cassa)
                    isOwner: false, // Titolare (pu√≤ vedere impostazioni)
                    accessPin: '',
                    
                    // --- Dati Persistenti (Verranno caricati da localStorage) ---
                    menu: {
                        'Pizza Classica': [
                            { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                            { nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                            // ... altri esempi
                        ],
                        'Pizze Speciali': [
                            { nome: 'Gourmet', prezzo: 12.00, isFinished: false },
                            { nome: 'Pistacchio & Mortadella', prezzo: 10.50, isFinished: false },
                        ],
                        'Al Forno': [
                            { nome: 'Suppl√¨', prezzo: 2.00, isFinished: false },
                            { nome: 'Crocchetta', prezzo: 1.50, isFinished: false },
                        ],
                        'Bevande': [
                             { nome: 'Acqua Naturale 0.5L', prezzo: 1.50, isFinished: false },
                             { nome: 'Coca Cola Lattina', prezzo: 2.50, isFinished: false },
                        ],
                        'Composizioni': [
                            { nome: 'Pizza a Met√†', prezzo: 0.00, isFinished: false, isHalfPizza: true },
                            { nome: 'Pizza a Metro', prezzo: 0.00, isFinished: false, isMeter: true },
                        ]
                    },
                    modifiers: {
                        'Aggiunte': [
                            { nome: 'Bufala', prezzo: 2.50, isFinished: false },
                            { nome: 'Funghi Extra', prezzo: 1.00, isFinished: false },
                        ],
                        'Senza': [
                            { nome: 'Senza Mozzarella', prezzo: 0.00, isFinished: false },
                            { nome: 'Senza Pomodoro', prezzo: 0.00, isFinished: false },
                        ],
                    },
                    compositionPrices: {
                        'Pizza a Metro': {
                            'baseSections': 4,
                            2: 15.00, // Prezzo per 2 gusti
                            3: 18.00, // Prezzo per 3 gusti
                            4: 20.00, // Prezzo per 4 gusti
                        },
                        // Pizza a Met√† (calcolo automatico della media)
                    },
                    deliveryZones: [
                        { name: 'Centro Storico', price: 3.00 },
                        { name: 'Periferia Nord', price: 5.00 },
                    ],
                    drivers: ['Marco', 'Luca', 'Elena'],
                    
                    // PIN di accesso (verranno caricati o inizializzati)
                    pins: {
                        admin: '1234', 
                        owner: '0000' 
                    },

                    // --- Stato Carrello e Ordine Corrente ---
                    activeCat: 'Pizza Classica', 
                    searchTerm: '',
                    
                    order: [], // Il carrello: lista di oggetti { nome, prezzoBase, modifiers: [{ nome, prezzo }] }
                    selectedItemIndex: null, // Indice dell'elemento selezionato nel carrello
                    
                    // Stato Modificatori (Pannello a destra)
                    activeModCat: 'Aggiunte',
                    modifierSearchTerm: '',
                    
                    // --- Dati Finalizzazione Ordine (Modal) ---
                    showModal: false,
                    editingOrderId: null, // Se non null, siamo in modalit√† modifica
                    lastOrderId: 0,
                    
                    mode: 'banco', // banco, asporto, consegna
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: 'Roma',
                    tableNumber: '',
                    date: '',
                    hour: '',
                    notes: '',
                    zoneName: '',
                    deliveryCost: 0.00,
                    discount: 0.00,
                    discountPercentage: 0,
                    paymentStatus: 'Da Pagare',
                    accontoRicevuto: 0.00,
                    
                    // Storico Clienti (per suggerimenti)
                    customerHistory: [],
                    filteredCustomerSuggestions: [],
                    
                    // --- Logica Composizioni Complesse (Modali) ---
                    showMeterModal: false, // Per Pizza a Metro/Schiacciata
                    tempMeterItem: null,
                    gustoSearchTerm: '',
                    tempModCat: 'Aggiunte', // Per i modificatori nelle modali
                    
                    showHalfPizzaModal: false, // Per Pizza a Met√†
                    tempHalfPizzaItem: null,
                    
                    showPriceEditModal: false, // Per modifica prezzo manuale
                    tempPriceEditIndex: null,
                    newPriceValue: 0.00,

                    // --- Logica Ordini Attivi e Archivio ---
                    activeOrders: [],
                    archive: [],
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', // today, tomorrow, future, all
                    selectedDriver: '', // Filtro per ordini attivi o storico
                    
                    // Filtri Storico
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // --- Impostazioni ---
                    activeSettingsView: 'menu',
                    activeSettingsCat: 'Pizza Classica',
                    activeSettingsModCat: 'Aggiunte',
                    newAdminPin: '',
                    newOwnerPin: '',
                    
                    // Capacit√† Oraria
                    capacitySettings: {
                        maxPizzas: 60,
                        intervalMinutes: 30,
                    },
                    orderCapacity: { 
                        interval: 'N/A',
                        total: 0,
                        remaining: 0,
                        warning: false 
                    },
                    
                    // Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,
                };
            },
            
            computed: {
                // --- Accesso e Sicurezza ---
                isOperator() {
                    return this.isAccessGranted && this.isAdmin;
                },

                // --- Carrello e Menu ---
                filteredAvailableItems() {
                    const categoryItems = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase().trim();
                    
                    return categoryItems.filter(item => 
                        !item.isFinished && item.nome.toLowerCase().includes(term)
                    );
                },
                filteredModifiersForActiveCat() {
                    const categoryMods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase().trim();
                    
                    return categoryMods.filter(mod => 
                        !mod.isFinished && mod.nome.toLowerCase().includes(term)
                    );
                },
                
                // Tutti i gusti delle pizze (per composizioni)
                allPizzaGusti() {
                    let gusti = [];
                    // Combina gli elementi di Pizza Classica e Pizze Speciali
                    const pizzaCategories = ['Pizza Classica', 'Pizze Speciali'];
                    pizzaCategories.forEach(cat => {
                        (this.menu[cat] || []).forEach(item => {
                            if (!item.isHalfPizza && !item.isMeter) {
                                gusti.push(item);
                            }
                        });
                    });
                    // Rimuove duplicati basandosi sul nome, se ci fossero
                    return gusti.filter((item, index, self) => 
                        index === self.findIndex((t) => (t.nome === item.nome))
                    );
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase().trim();
                    return this.allPizzaGusti.filter(gusto => 
                        !gusto.isFinished && gusto.nome.toLowerCase().includes(term)
                    );
                },

                // Calcolo Totale Carrello
                calculatedOrderTotal() {
                    return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                },
                total() {
                    // Totale Parziale + Costo Consegna - Sconto
                    const subtotal = this.calculatedOrderTotal;
                    let total = subtotal + this.deliveryCost;
                    
                    // Applica sconto percentuale se maggiore di sconto fisso
                    if (this.discountPercentage > 0) {
                        const discountValue = total * (this.discountPercentage / 100);
                        if (discountValue > this.discount) {
                            total -= discountValue;
                            this.discount = parseFloat(discountValue.toFixed(2)); // Aggiorna campo discount
                        } else {
                            total -= this.discount;
                        }
                    } else {
                        total -= this.discount;
                    }
                    
                    return parseFloat(Math.max(0, total).toFixed(2));
                },
                restoDaDare() {
                    return Math.max(0, this.accontoRicevuto - this.total);
                },
                
                // --- Composizioni Complesse (Validazione e Totali Temporanei) ---
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;

                    let basePrice = this.compositionPrices[this.tempMeterItem.nome][this.tempMeterItem.gustoCount] || 0;
                    let modifiersTotal = 0;
                    
                    this.tempMeterItem.sections.forEach(section => {
                        modifiersTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    });
                    
                    return parseFloat((basePrice + modifiersTotal).toFixed(2));
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    
                    const sectionsWithGusto = this.tempMeterItem.sections.filter(s => s.gusto !== null).length;
                    const gustiUniciSelected = this.tempMeterGusti.length;

                    // Deve aver selezionato tutti i gusti nelle sezioni e rispettare il numero di gusti unici
                    return sectionsWithGusto === this.tempMeterItem.sections.length && 
                           gustiUniciSelected <= this.tempMeterItem.gustoCount &&
                           gustiUniciSelected > 0;
                },
                tempMeterGusti() {
                    if (!this.tempMeterItem) return [];
                    const gusti = this.tempMeterItem.sections.map(s => s.gusto).filter(g => g !== null);
                    // Rimuove duplicati per contare solo i gusti unici
                    return [...new Set(gusti)];
                },
                
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem || !this.tempHalfPizzaItem.gusto1 || !this.tempHalfPizzaItem.gusto2) return 0;
                    
                    // 1. Trova i prezzi base dei due gusti (usando gli elementi del menu)
                    const gusto1Price = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto1)?.prezzo || 0;
                    const gusto2Price = this.allPizzaGusti.find(g => g.nome === this.tempHalfPizzaItem.gusto2)?.prezzo || 0;
                    
                    // 2. Prezzo base = Media dei due gusti arrotondata per eccesso (come da pratica comune in pizzeria)
                    let basePrice = Math.ceil((gusto1Price + gusto2Price) / 2);
                    
                    // 3. Aggiungi i modificatori
                    let modifiersTotal = 0;
                    modifiersTotal += this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    modifiersTotal += this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                    return parseFloat((basePrice + modifiersTotal).toFixed(2));
                },
                isHalfPizzaValid() {
                    return this.tempHalfPizzaItem?.gusto1 && this.tempHalfPizzaItem?.gusto2;
                },
                
                // --- Capacit√† Oraria ---
                orderPizzaCount() {
                    return this.order.reduce((count, item) => {
                        // Logica per contare quante 'pizze' ci sono in un ordine
                        if (item.isHalfPizza) return count + 1; // Una pizza a met√† conta come una pizza
                        if (item.isMeter) return count + 2; // Un metro conta come 2 pizze (circa)
                        
                        // Trova la categoria dell'articolo
                        const category = Object.keys(this.menu).find(cat => 
                            (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                        );
                        
                        // Solo le pizze (classiche/speciali) contano come un'unit√† di capacit√†
                        if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                            return count + 1;
                        }
                        return count;
                    }, 0);
                },
                isCapacityWarning() {
                    return this.orderCapacity.warning;
                },
                isCapacityFull() {
                    return this.orderCapacity.remaining <= 0;
                },

                // --- Ordini Attivi/Storico ---
                filteredActiveOrders() {
                    const today = new Date().toISOString().slice(0, 10);
                    const tomorrow = new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().slice(0, 10);
                    
                    return this.activeOrders.filter(order => {
                        // Filtro data
                        if (this.activeDateFilter === 'today' && order.date !== today) return false;
                        if (this.activeDateFilter === 'tomorrow' && order.date !== tomorrow) return false;
                        if (this.activeDateFilter === 'future' && order.date !== tomorrow && order.date <= today) return false;
                        
                        // Filtro ricerca
                        const term = this.activeOrderSearchTerm.toLowerCase();
                        if (term && !(order.customer?.toLowerCase().includes(term) || order.tableNumber?.includes(term) || order.phone?.includes(term))) {
                            return false;
                        }
                        return true;
                    }).sort((a, b) => {
                        // Ordina per data e ora
                        const timeA = new Date(a.date + 'T' + a.hour).getTime();
                        const timeB = new Date(b.date + 'T' + b.hour).getTime();
                        return timeA - timeB;
                    });
                },
                filteredArchive() {
                    const filtered = this.archive.filter(order => {
                        const isDateMatch = order.date === this.archiveDateFilter;
                        const isDriverMatch = !this.selectedDriver || order.driver === this.selectedDriver;
                        return isDateMatch && isDriverMatch;
                    }).sort((a, b) => b.archivedTimestamp - a.archivedTimestamp); // Ordina dal pi√π recente
                    
                    // Ricalcola le statistiche del fattorino ad ogni aggiornamento del filtro
                    this.calculateDriverStats();
                    
                    return filtered;
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                archiveDateFilterDisplay() {
                    return this.formatDate(this.archiveDateFilter);
                },
                minDate() {
                    // Data minima per l'input date (oggi)
                    return new Date().toISOString().slice(0, 10);
                }
            },

            methods: {
                // --- Funzioni di Accesso e Persistenza ---
                grantAccess() {
                    if (this.accessPin === this.pins.admin) {
                        this.isAccessGranted = true;
                        this.isAdmin = true;
                        this.isOwner = false;
                        this.view = 'inserimento';
                        this.accessPin = '';
                        alert("Accesso come Operatore/Admin effettuato.");
                    } else if (this.accessPin === this.pins.owner) {
                        this.isAccessGranted = true;
                        this.isAdmin = true;
                        this.isOwner = true;
                        this.view = 'inserimento';
                        this.accessPin = '';
                        alert("Accesso come Titolare effettuato.");
                    } else {
                        alert("PIN errato. Riprova.");
                        this.accessPin = '';
                    }
                },
                logout() {
                    this.isAccessGranted = false;
                    this.isAdmin = false;
                    this.isOwner = false;
                    this.view = 'login';
                    alert("Logout effettuato.");
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.pins.admin = this.newAdminPin;
                        this.saveData();
                        this.newAdminPin = '';
                        alert("PIN Admin aggiornato con successo.");
                    } else {
                        alert("Il PIN deve essere di almeno 4 cifre.");
                    }
                },
                 saveOwnerPin() {
                    if (this.newOwnerPin.length >= 4) {
                        this.pins.owner = this.newOwnerPin;
                        this.saveData();
                        this.newOwnerPin = '';
                        alert("PIN Titolare aggiornato con successo.");
                    } else {
                        alert("Il PIN deve essere di almeno 4 cifre.");
                    }
                },
                
                saveData() {
                    const dataToSave = {
                        menu: this.menu,
                        modifiers: this.modifiers,
                        compositionPrices: this.compositionPrices,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        pins: this.pins,
                        lastOrderId: this.lastOrderId,
                        activeOrders: this.activeOrders,
                        archive: this.archive,
                        customerHistory: this.customerHistory,
                        capacitySettings: this.capacitySettings
                    };
                    localStorage.setItem('pizzeriaSmartData', JSON.stringify(dataToSave));
                },
                loadData() {
                    const savedData = localStorage.getItem('pizzeriaSmartData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        // Carica solo le propriet√† persistenti
                        this.menu = data.menu || this.menu;
                        this.modifiers = data.modifiers || this.modifiers;
                        this.compositionPrices = data.compositionPrices || this.compositionPrices;
                        this.deliveryZones = data.deliveryZones || this.deliveryZones;
                        this.drivers = data.drivers || this.drivers;
                        this.pins = data.pins || this.pins;
                        this.lastOrderId = data.lastOrderId || 0;
                        this.activeOrders = data.activeOrders || [];
                        this.archive = data.archive || [];
                        this.customerHistory = data.customerHistory || [];
                        this.capacitySettings = data.capacitySettings || this.capacitySettings;
                        
                        // Assicurati che activeSettingsCat sia una categoria valida
                        if (!this.menu[this.activeSettingsCat]) {
                            this.activeSettingsCat = Object.keys(this.menu)[0] || 'Pizza Classica';
                        }
                    }
                },
                
                // --- Funzioni Data/Ora ---
                setDefaultDateTime() {
                    const now = new Date();
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    this.date = now.toISOString().slice(0, 10);
                    this.hour = `${hours}:${minutes}`;
                },
                
                // --- Gestione Carrello ---
                handleItemClick(item) {
                    this.searchTerm = ''; // Resetta la ricerca
                    
                    if (item.isFinished) {
                        alert("Articolo esaurito. Controlla le impostazioni.");
                        return;
                    }
                    
                    if (item.isHalfPizza) {
                        this.openHalfPizzaComposition(item);
                    } else if (item.isMeter) {
                        this.openMeterComposition(item);
                    } else {
                        // Articolo Standard (aggiunto direttamente)
                        const newItem = {
                            nome: item.nome,
                            prezzoBase: item.prezzo,
                            modifiers: [], // Inizializza un array vuoto per i modificatori
                            isHalfPizza: false,
                            isMeter: false,
                            gusto1: null,
                            gusto2: null,
                        };
                        this.order.push(newItem);
                        this.selectItem(this.order.length - 1);
                        this.updateCapacityWarning();
                    }
                },
                selectItem(index) {
                    this.selectedItemIndex = index;
                },
                removeItem(index) {
                    if (confirm(`Sei sicuro di voler rimuovere "${this.order[index].nome}" dal carrello?`)) {
                        this.order.splice(index, 1);
                        this.selectedItemIndex = null;
                        this.updateCapacityWarning();
                    }
                },
                resetOrder() {
                    if (confirm("Sei sicuro di voler svuotare l'intero carrello?")) {
                        this.order = [];
                        this.selectedItemIndex = null;
                        this.resetModalData(); // Resetta anche i dati di finalizzazione
                        this.updateCapacityWarning();
                    }
                },
                
                // Calcolo totale singolo articolo
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) {
                        return item.manualPrice;
                    }
                    
                    let basePrice = item.prezzoBase || 0;
                    let modifiersTotal = 0;
                    
                    if (item.isHalfPizza) {
                        // Calcola il prezzo della pizza a met√†
                        const gusto1Price = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                        const gusto2Price = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                        basePrice = Math.ceil((gusto1Price + gusto2Price) / 2);
                        
                        modifiersTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        modifiersTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                        
                    } else if (item.isMeter) {
                        // Calcola il prezzo della pizza a metro
                        basePrice = this.compositionPrices[item.nome][item.gustoCount] || 0;
                        item.sections.forEach(section => {
                            modifiersTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        });
                        
                    } else {
                        // Articolo standard
                        modifiersTotal = (item.modifiers || []).reduce((sum, mod) => sum + mod.prezzo, 0);
                    }
                    
                    return parseFloat((basePrice + modifiersTotal).toFixed(2));
                },
                
                // --- Gestione Modificatori (Articoli Standard) ---
                addExtra(modifier) {
                    if (this.selectedItemIndex === null || modifier.isFinished) return;
                    
                    const currentItem = this.order[this.selectedItemIndex];
                    
                    // Rimuovi se gi√† presente (funzione toggle)
                    const existingIndex = currentItem.modifiers.findIndex(m => m.nome === modifier.nome);
                    if (existingIndex !== -1) {
                        currentItem.modifiers.splice(existingIndex, 1);
                        return;
                    }
                    
                    // Se l'extra √® di categoria "Senza", prima rimuovi gli eventuali "Senza" esistenti
                    if (this.activeModCat === 'Senza') {
                         currentItem.modifiers = currentItem.modifiers.filter(m => this.getModifierCategory(m.nome) !== 'Senza');
                    }
                    
                    // Aggiungi
                    currentItem.modifiers.push({
                        nome: modifier.nome,
                        prezzo: modifier.prezzo,
                        category: this.activeModCat // Salva la categoria per futuri controlli
                    });
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return null;
                },
                getModifierIcon(category) {
                    switch(category) {
                        case 'Aggiunte': return 'fa-solid fa-plus';
                        case 'Senza': return 'fa-solid fa-minus';
                        default: return 'fa-solid fa-cookie';
                    }
                },
                
                // --- Modifica Prezzo Manuale ---
                openPriceEditModal(index) {
                    if (index === null || !this.order[index]) return;
                    this.tempPriceEditIndex = index;
                    this.newPriceValue = this.order[index].manualPrice !== undefined 
                                         ? this.order[index].manualPrice 
                                         : this.calculateItemTotal(this.order[index]);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    const item = this.order[this.tempPriceEditIndex];
                    if (this.newPriceValue < 0 || isNaN(this.newPriceValue)) {
                        alert("Inserisci un prezzo valido.");
                        return;
                    }
                    item.manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                    this.showPriceEditModal = false;
                    this.updateCapacityWarning();
                },
                resetManualPrice() {
                    delete this.order[this.tempPriceEditIndex].manualPrice;
                    this.showPriceEditModal = false;
                    this.updateCapacityWarning();
                },

                // --- Logica Modale Composizioni Complesse (Pizza a Metro) ---
                openMeterComposition(item) {
                    this.tempMeterItem = {
                        nome: item.nome,
                        isMeter: true,
                        prezzoBase: 0, 
                        gustoCount: 2, // Default 2 gusti
                        sections: [],
                    };
                    this.createMeterSections();
                    this.showMeterModal = true;
                },
                createMeterSections() {
                    const sectionsCount = this.compositionPrices['Pizza a Metro'].baseSections;
                    this.tempMeterItem.sections = Array.from({ length: sectionsCount }, (_, i) => ({
                        name: `Sezione ${i + 1}`,
                        gusto: null,
                        modifiers: [],
                        activeSection: i === 0
                    }));
                },
                setMeterGustoCount(count) {
                    this.tempMeterItem.gustoCount = count;
                    // Rimuovi i gusti dalle sezioni per forzare la riselzione
                    this.tempMeterItem.sections.forEach(s => {
                         s.gusto = null;
                         s.modifiers = [];
                    });
                },
                selectMeterGusto(sectionIndex, gustoName) {
                    if (sectionIndex === -1 || sectionIndex === undefined) return;
                    
                    const currentSection = this.tempMeterItem.sections[sectionIndex];
                    currentSection.gusto = gustoName;
                    
                    // Sposta l'attivazione alla sezione successiva
                    if (sectionIndex < this.tempMeterItem.sections.length - 1) {
                         currentSection.activeSection = false;
                         this.tempMeterItem.sections[sectionIndex + 1].activeSection = true;
                    }
                },
                addMeterModifier(sectionIndex, modifier) {
                    if (sectionIndex === -1 || sectionIndex === undefined) return;
                    
                    const currentSection = this.tempMeterItem.sections[sectionIndex];
                    if (!currentSection.gusto) {
                        alert("Seleziona prima il gusto per questa sezione.");
                        return;
                    }
                    
                    const existingIndex = currentSection.modifiers.findIndex(m => m.nome === modifier.nome);
                    if (existingIndex !== -1) {
                        currentSection.modifiers.splice(existingIndex, 1);
                    } else {
                        currentSection.modifiers.push({ nome: modifier.nome, prezzo: modifier.prezzo });
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert("Completa la selezione dei gusti e dei modificatori per tutte le sezioni.");
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                    finalItem.prezzoBase = this.calculateTempMeterTotal; // Salva il prezzo finale come base
                    this.order.push(finalItem);
                    this.cancelMeterComposition();
                    this.selectItem(this.order.length - 1);
                    this.updateCapacityWarning();
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                    this.gustoSearchTerm = '';
                },

                // --- Logica Modale Composizioni Complesse (Pizza a Met√†) ---
                openHalfPizzaComposition(item) {
                     this.tempHalfPizzaItem = {
                        nome: item.nome,
                        isHalfPizza: true,
                        prezzoBase: 0, 
                        gusto1: null,
                        modifiers1: [],
                        gusto2: null,
                        modifiers2: [],
                        activeHalf: 1,
                    };
                    this.showHalfPizzaModal = true;
                },
                selectHalfPizzaGusto(halfNumber, gustoName) {
                    if (halfNumber === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                        this.tempHalfPizzaItem.activeHalf = 2; // Sposta l'attivazione
                    } else if (halfNumber === 2) {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                },
                addHalfPizzaModifier(halfNumber, modifier) {
                    const targetModifiers = halfNumber === 1 ? 'modifiers1' : 'modifiers2';
                    const targetGusto = halfNumber === 1 ? 'gusto1' : 'gusto2';

                    if (!this.tempHalfPizzaItem[targetGusto]) {
                        alert(`Seleziona prima il gusto per la Met√† ${halfNumber}.`);
                        return;
                    }
                    
                    const existingIndex = this.tempHalfPizzaItem[targetModifiers].findIndex(m => m.nome === modifier.nome);
                    if (existingIndex !== -1) {
                        this.tempHalfPizzaItem[targetModifiers].splice(existingIndex, 1);
                    } else {
                        this.tempHalfPizzaItem[targetModifiers].push({ nome: modifier.nome, prezzo: modifier.prezzo });
                    }
                },
                addHalfPizzaToOrder() {
                     if (!this.isHalfPizzaValid) {
                        alert("Devi selezionare un gusto per entrambe le met√†.");
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                    finalItem.prezzoBase = this.calculateTempHalfPizzaTotal; // Salva il prezzo finale come base
                    this.order.push(finalItem);
                    this.cancelHalfPizzaComposition();
                    this.selectItem(this.order.length - 1);
                    this.updateCapacityWarning();
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                    this.gustoSearchTerm = '';
                },
                
                // --- Logica Finalizzazione (Modal) ---
                updateDeliveryCost() {
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    this.deliveryCost = zone ? zone.price : 0.00;
                },
                
                // ... CONTINUA NELLA PARTE III ... 
                // Le funzioni openFinalizeModal, closeFinalizeModal, saveOrder e tutte le logiche di gestione ordini/impostazioni verranno nella PARTE III.
                
            },
            
            // ... mounted() Verr√† nella PARTE III ...
            
        });
        
        // ... app.config.globalProperties.$filters e app.mount('#app') Verranno nella PARTE III ...
    </script>
                // --- Logica Finalizzazione (Modal) - CONTINUAZIONE ---
                
                resetModalData() {
                    // Resetta tutti i campi della modale
                    this.mode = 'banco';
                    this.customer = '';
                    this.phone = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.town = 'Roma';
                    this.tableNumber = '';
                    this.notes = '';
                    this.zoneName = '';
                    this.deliveryCost = 0.00;
                    this.discount = 0.00;
                    this.discountPercentage = 0;
                    this.paymentStatus = 'Da Pagare';
                    this.accontoRicevuto = 0.00;
                    this.editingOrderId = null;
                    this.setDefaultDateTime();
                },
                
                openFinalizeModal(orderToEdit = null) {
                    if (this.order.length === 0 && !orderToEdit) {
                        alert("Aggiungi articoli al carrello prima di finalizzare l'ordine.");
                        return;
                    }
                    
                    if (orderToEdit) {
                        // Modalit√† Modifica Ordine Esistente
                        this.editingOrderId = orderToEdit.id;
                        this.mode = orderToEdit.mode;
                        this.customer = orderToEdit.customer || '';
                        this.phone = orderToEdit.phone || '';
                        this.address = orderToEdit.address || '';
                        this.streetNumber = orderToEdit.streetNumber || '';
                        this.town = orderToEdit.town || 'Roma';
                        this.tableNumber = orderToEdit.tableNumber || '';
                        this.date = orderToEdit.date;
                        this.hour = orderToEdit.hour;
                        this.notes = orderToEdit.notes || '';
                        this.zoneName = orderToEdit.zoneName || '';
                        this.discount = orderToEdit.discount || 0.00;
                        this.discountPercentage = orderToEdit.discountPercentage || 0;
                        this.paymentStatus = orderToEdit.paymentStatus;
                        this.accontoRicevuto = orderToEdit.accontoRicevuto || 0.00;
                        
                        // Sostituisci il carrello corrente con gli elementi dell'ordine da modificare (temporaneamente)
                        this.order = JSON.parse(JSON.stringify(orderToEdit.items));
                    } else {
                        // Nuovo Ordine
                        this.resetModalData();
                    }
                    
                    this.updateDeliveryCost();
                    this.updateCapacityWarning();
                    this.showModal = true;
                },
                
                closeFinalizeModal() {
                    if (this.editingOrderId) {
                        // Se stavi modificando, ripristina il carrello originale (o mantieni le modifiche se l'hai salvato)
                        // Per semplicit√†, in questa logica, il carrello *corrente* √® l'ordine che stai modificando.
                        this.view = 'ordini';
                    }
                    this.showModal = false;
                    this.resetModalData(); 
                },
                
                saveOrder() {
                    if (this.order.length === 0) {
                        alert("L'ordine non pu√≤ essere vuoto.");
                        return;
                    }
                    if (this.isCapacityFull) {
                        alert("Attenzione: La capacit√† oraria per l'orario selezionato √® esaurita!");
                        // Continuare a salvare solo se l'utente accetta
                        if (!confirm("Sei sicuro di voler salvare l'ordine nonostante la capacit√† esaurita?")) {
                            return;
                        }
                    }
                    if (!this.date || !this.hour) {
                        alert("Seleziona data e ora di ritiro/consegna.");
                        return;
                    }
                    if (this.mode === 'consegna' && !this.zoneName) {
                        alert("Seleziona la zona di consegna.");
                        return;
                    }

                    const orderData = {
                        id: this.editingOrderId || ++this.lastOrderId,
                        timestamp: Date.now(),
                        mode: this.mode,
                        customer: this.mode !== 'banco' ? this.customer : '',
                        phone: this.mode !== 'banco' ? this.phone : '',
                        address: this.mode === 'consegna' ? `${this.address}, ${this.streetNumber}` : '',
                        town: this.mode === 'consegna' ? this.town : '',
                        zoneName: this.mode === 'consegna' ? this.zoneName : '',
                        tableNumber: this.mode === 'banco' ? this.tableNumber : '',
                        date: this.date,
                        hour: this.hour,
                        notes: this.notes,
                        items: JSON.parse(JSON.stringify(this.order)), // Copia profonda degli articoli
                        subtotal: this.calculatedOrderTotal,
                        deliveryCost: this.deliveryCost,
                        discount: this.discount,
                        discountPercentage: this.discountPercentage,
                        total: this.total,
                        paymentStatus: this.paymentStatus,
                        accontoRicevuto: this.accontoRicevuto,
                        status: 'Pending', // Pending, Ready
                    };

                    if (this.editingOrderId) {
                        // Modifica Ordine Esistente
                        const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.activeOrders.splice(index, 1, orderData);
                        }
                        this.view = 'ordini';
                    } else {
                        // Nuovo Ordine
                        this.activeOrders.push(orderData);
                        this.view = 'ordini';
                        this.order = []; // Svuota il carrello dopo aver salvato il nuovo ordine
                        this.selectedItemIndex = null;
                        this.updateCapacityWarning(); // Aggiorna la capacit√† basata sul prossimo intervallo
                    }
                    
                    // Aggiorna storico clienti
                    if (this.mode !== 'banco' && this.customer && this.phone) {
                        this.updateCustomerHistory(orderData);
                    }
                    
                    this.closeFinalizeModal();
                    this.saveData();
                    alert(`Ordine #${orderData.id} salvato/modificato con successo.`);
                },
                
                // --- Capacit√† Oraria ---
                updateCapacityWarning() {
                    if (!this.date || !this.hour) {
                        this.orderCapacity = { interval: 'N/A', total: 0, remaining: 0, warning: false };
                        return;
                    }
                    
                    const intervalMinutes = this.capacitySettings.intervalMinutes;
                    const maxPizzas = this.capacitySettings.maxPizzas;
                    
                    // Calcola l'intervallo di tempo (es. 19:30 - 20:00)
                    const [h, m] = this.hour.split(':').map(Number);
                    const totalMinutes = h * 60 + m;
                    const startMinutes = Math.floor(totalMinutes / intervalMinutes) * intervalMinutes;
                    
                    const startH = String(Math.floor(startMinutes / 60)).padStart(2, '0');
                    const startM = String(startMinutes % 60).padStart(2, '0');
                    
                    const endMinutes = startMinutes + intervalMinutes;
                    const endH = String(Math.floor(endMinutes / 60)).padStart(2, '0');
                    const endM = String(endMinutes % 60).padStart(2, '0');
                    
                    const interval = `${startH}:${startM} - ${endH}:${endM}`;
                    
                    // Calcola le pizze gi√† prenotate per quell'intervallo
                    const currentOrdersPizzas = this.activeOrders.reduce((sum, order) => {
                        if (order.date === this.date) {
                            const [orderH, orderM] = order.hour.split(':').map(Number);
                            const orderTotalMinutes = orderH * 60 + orderM;
                            const orderStartMinutes = Math.floor(orderTotalMinutes / intervalMinutes) * intervalMinutes;
                            
                            if (orderStartMinutes === startMinutes) {
                                // Se stiamo modificando l'ordine corrente, non contarlo due volte
                                if (this.editingOrderId && order.id === this.editingOrderId) {
                                    return sum;
                                }
                                // Conta il numero di pizze nell'ordine
                                return sum + order.items.reduce((count, item) => {
                                    if (item.isHalfPizza) return count + 1;
                                    if (item.isMeter) return count + 2;
                                    const category = Object.keys(this.menu).find(cat => 
                                        (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                                    );
                                    if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                                        return count + 1;
                                    }
                                    return count;
                                }, 0);
                            }
                        }
                        return sum;
                    }, 0);
                    
                    // Aggiungi le pizze dell'ordine corrente che stiamo inserendo/modificando
                    const totalPizzas = currentOrdersPizzas + this.orderPizzaCount;
                    const remaining = maxPizzas - totalPizzas;
                    
                    this.orderCapacity = {
                        interval: interval,
                        total: maxPizzas,
                        remaining: remaining,
                        warning: remaining <= (maxPizzas * 0.2) && remaining > 0 // Avviso se siamo al 20%
                    };
                },
                
                // --- Gestione Ordini Attivi (Vista 'ordini') ---
                getModeIcon(mode) {
                    switch(mode) {
                        case 'banco': return 'fa-solid fa-utensils';
                        case 'asporto': return 'fa-solid fa-bag-shopping';
                        case 'consegna': return 'fa-solid fa-truck';
                        default: return 'fa-solid fa-question';
                    }
                },
                getModeName(mode) {
                    switch(mode) {
                        case 'banco': return 'Banco/Tavolo';
                        case 'asporto': return 'Asporto';
                        case 'consegna': return 'Consegna';
                        default: return 'Sconosciuto';
                    }
                },
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    const date = new Date(dateStr);
                    const today = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(today.getDate() + 1);
                    
                    if (dateStr === today.toISOString().slice(0, 10)) return 'Oggi';
                    if (dateStr === tomorrow.toISOString().slice(0, 10)) return 'Domani';
                    
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                },
                
                toggleOrderStatus(orderId) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) {
                        order.status = order.status === 'Pending' ? 'Ready' : 'Pending';
                        this.saveData();
                    }
                },
                
                archiveOrder(orderId) {
                    if (!confirm("Sei sicuro di voler archiviare l'ordine? Questa azione √® permanente nello storico.")) return;
                    
                    const index = this.activeOrders.findIndex(o => o.id === orderId);
                    if (index !== -1) {
                        const [orderToArchive] = this.activeOrders.splice(index, 1);
                        
                        // Chiedi il nome del fattorino se era una consegna
                        if (orderToArchive.mode === 'consegna' && !orderToArchive.driver) {
                            const driver = prompt("Inserisci il nome del fattorino per questo ordine:", this.drivers[0] || "");
                            if (driver) {
                                orderToArchive.driver = driver;
                            }
                        }
                        
                        orderToArchive.archivedTimestamp = Date.now();
                        this.archive.push(orderToArchive);
                        this.saveData();
                        this.updateCapacityWarning(); // Aggiorna la capacit√†
                    }
                },
                
                openEditOrderModal(orderId) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) {
                        this.openFinalizeModal(order);
                    }
                },
                
                // --- Storico e Statistiche ---
                calculateDriverStats() {
                    const stats = { totalOrders: 0, totalRevenue: 0 };
                    
                    this.archive.forEach(order => {
                        if (order.driver === this.selectedDriver && order.date === this.archiveDateFilter) {
                            stats.totalOrders++;
                            stats.totalRevenue += order.total;
                        }
                    });
                    
                    this.driverStats = stats;
                },
                showArchiveDetails(order) {
                    let details = `Dettagli Ordine #${order.id}\n`;
                    details += `Cliente/Tavolo: ${order.customer || order.tableNumber || 'N/A'}\n`;
                    details += `Modalit√†: ${this.getModeName(order.mode)}\n`;
                    if (order.driver) details += `Fattorino: ${order.driver}\n`;
                    details += `Data/Ora: ${this.formatDate(order.date)} ${order.hour}\n`;
                    details += `Stato Pagamento: ${order.paymentStatus}\n\n`;
                    
                    details += 'Articoli:\n';
                    order.items.forEach(item => {
                        details += `- ${item.nome} (‚Ç¨${this.calculateItemTotal(item).toFixed(2)})\n`;
                        if (item.modifiers && item.modifiers.length > 0) {
                             details += `  (${item.modifiers.map(m => m.nome).join(', ')})\n`;
                        }
                    });
                    
                    details += '\n--- Totali ---\n';
                    details += `Subtotale: ‚Ç¨${order.subtotal.toFixed(2)}\n`;
                    if (order.deliveryCost > 0) details += `Consegna: +‚Ç¨${order.deliveryCost.toFixed(2)}\n`;
                    if (order.discount > 0) details += `Sconto: -‚Ç¨${order.discount.toFixed(2)}\n`;
                    details += `Totale Finale: ‚Ç¨${order.total.toFixed(2)}\n`;
                    if (order.notes) details += `Note: ${order.notes}`;
                    
                    alert(details);
                },
                
                // --- Condivisione Ordine (WhatsApp) ---
                openShareModal(order) {
                    this.selectedOrderForShare = order;
                    this.showShareModal = true;
                },
                generateShareText(order) {
                    if (!order) return "";
                    
                    let text = `üçï *Riepilogo Ordine Pizzeria Smart* üçï\n`;
                    text += `\n*Ordine ID:* #${order.id}\n`;
                    text += `*Modalit√†:* ${this.getModeName(order.mode)}\n`;
                    
                    if (order.mode === 'banco') {
                        text += `*Tavolo/Note:* ${order.tableNumber || 'N/A'}\n`;
                    } else {
                        text += `*Cliente:* ${order.customer || 'N/A'}\n`;
                        text += `*Telefono:* ${order.phone || 'N/A'}\n`;
                    }

                    if (order.mode === 'consegna') {
                        text += `*Indirizzo:* ${order.address} ${order.town}\n`;
                    }
                    
                    text += `\n*Ritira/Consegna:* ${this.formatDate(order.date)} alle ${order.hour}\n`;
                    text += `\n*Articoli:*\n`;
                    
                    order.items.forEach(item => {
                        let itemText = `\n- ${item.nome} (‚Ç¨${this.calculateItemTotal(item).toFixed(2)})`;
                        
                        if (item.isHalfPizza) {
                            itemText += `\n  (Met√† 1: ${item.gusto1} / Met√† 2: ${item.gusto2})`;
                            if (item.modifiers1.length > 0) itemText += ` (+${item.modifiers1.map(m => m.nome).join(', ')})`;
                            if (item.modifiers2.length > 0) itemText += ` (+${item.modifiers2.map(m => m.nome).join(', ')})`;
                        } else if (item.isMeter) {
                            itemText += `\n  (Gusti: ${item.sections.map(s => s.gusto).filter((g, i, self) => self.indexOf(g) === i).join(', ')})`;
                        } else if (item.modifiers && item.modifiers.length > 0) {
                            itemText += ` (+${item.modifiers.map(m => m.nome).join(', ')})`;
                        }
                        text += itemText;
                    });
                    
                    text += `\n\n*TOTALE DA PAGARE:* ‚Ç¨${order.total.toFixed(2)}\n`;
                    text += `*Stato:* ${order.paymentStatus}\n`;
                    
                    if (order.notes) {
                        text += `\n*Note per l'Ordine:* ${order.notes}\n`;
                    }
                    
                    text += `\nGrazie per aver scelto Pizzeria Smart!`;
                    
                    return text;
                },
                copyShareText() {
                    const textToCopy = this.generateShareText(this.selectedOrderForShare);
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        alert("Riepilogo copiato negli appunti!");
                    }).catch(err => {
                        console.error('Errore nella copia del testo: ', err);
                        alert("Impossibile copiare il testo.");
                    });
                },
                
                // --- Gestione Storico Clienti ---
                updateCustomerHistory(order) {
                    if (order.mode === 'banco') return;
                    
                    const existingIndex = this.customerHistory.findIndex(c => c.phone === order.phone);
                    
                    const customerData = {
                        name: order.customer,
                        phone: order.phone,
                        address: order.address,
                        town: order.town
                    };
                    
                    if (existingIndex !== -1) {
                        // Aggiorna i dati
                        this.customerHistory[existingIndex] = customerData;
                    } else {
                        // Nuovo cliente
                        this.customerHistory.push(customerData);
                    }
                    this.saveData();
                },
                suggestCustomers() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 3) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    
                    this.filteredCustomerSuggestions = this.customerHistory.filter(c => 
                        c.name.toLowerCase().includes(term) || c.phone.includes(term)
                    ).slice(0, 5); // Mostra max 5 suggerimenti
                },
                selectCustomerSuggestion(customer) {
                    this.customer = customer.name;
                    this.phone = customer.phone;
                    if (this.mode === 'consegna') {
                        this.address = customer.address.split(',')[0].trim() || '';
                        this.streetNumber = customer.address.split(',')[1]?.trim() || '';
                        this.town = customer.town || this.town;
                    }
                    this.filteredCustomerSuggestions = [];
                },
                
                // --- Gestione Impostazioni (CRUD) ---
                addNewCategory(target) {
                    const newCat = prompt(`Inserisci il nome della nuova categoria (${target}):`);
                    if (newCat && newCat.trim()) {
                        if (target === 'menu') {
                            this.menu[newCat.trim()] = [];
                            this.activeSettingsCat = newCat.trim();
                        } else if (target === 'modifiers') {
                            this.modifiers[newCat.trim()] = [];
                            this.activeSettingsModCat = newCat.trim();
                        }
                        this.saveData();
                    }
                },
                removeItemFromMenu(category, index) {
                    if (index >= 0) {
                        this.menu[category].splice(index, 1);
                    } else {
                        // Rimuovi la categoria
                        if (confirm(`Sei sicuro di voler eliminare la categoria "${category}" e tutti i suoi articoli?`)) {
                            delete this.menu[category];
                            this.activeSettingsCat = Object.keys(this.menu)[0] || 'Pizza Classica';
                        }
                    }
                    this.saveData();
                },
                addNewItemToMenu(category) {
                    this.menu[category].push({ nome: 'Nuovo Articolo', prezzo: 0.00, isFinished: false });
                    this.saveData();
                },
                toggleItemStatus(category, index) {
                    this.menu[category][index].isFinished = !this.menu[category][index].isFinished;
                    this.saveData();
                },
                
                removeItemFromModifiers(category, index) {
                    this.modifiers[category].splice(index, 1);
                    this.saveData();
                },
                addNewItemToModifiers(category) {
                    this.modifiers[category].push({ nome: 'Nuovo Modificatore', prezzo: 0.00, isFinished: false });
                    this.saveData();
                },
                toggleModifierStatus(category, index) {
                    this.modifiers[category][index].isFinished = !this.modifiers[category][index].isFinished;
                    this.saveData();
                },

                addDeliveryZone() {
                    this.deliveryZones.push({ name: 'Nuova Zona', price: 0.00 });
                    this.saveData();
                },
                removeDeliveryZone(index) {
                    this.deliveryZones.splice(index, 1);
                    this.saveData();
                },
                
                addDriver() {
                    this.drivers.push('Nuovo Fattorino');
                    this.saveData();
                },
                removeDriver(index) {
                    this.drivers.splice(index, 1);
                    this.saveData();
                }

            },
            
            watch: {
                // Ogni volta che i dati critici cambiano, salvali in localStorage
                menu: { handler() { this.saveData(); }, deep: true },
                modifiers: { handler() { this.saveData(); }, deep: true },
                compositionPrices: { handler() { this.saveData(); }, deep: true },
                deliveryZones: { handler() { this.saveData(); }, deep: true },
                drivers: { handler() { this.saveData(); }, deep: true },
                pins: { handler() { this.saveData(); }, deep: true },
                capacitySettings: { handler() { this.saveData(); }, deep: true },
                
                zoneName(newVal) {
                    this.updateDeliveryCost();
                },
                // Re-valuta capacit√† se cambiano data, ora, o se un ordine viene salvato
                date() { this.updateCapacityWarning(); },
                hour() { this.updateCapacityWarning(); },
                activeOrders() { this.updateCapacityWarning(); },
                archiveDateFilter() { this.calculateDriverStats(); } // Ricalcola stats quando cambia la data
            },

            mounted() {
                // 1. Carica i dati salvati all'avvio
                this.loadData();
                
                // 2. Imposta data e ora di default per il modulo di finalizzazione
                this.setDefaultDateTime();
                
                // 3. Reindirizza alla vista iniziale (login)
                this.view = 'login';
                
                // 4. Aggiorna la capacit√† oraria iniziale
                this.updateCapacityWarning();
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
