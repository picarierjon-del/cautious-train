<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart – Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        
        /* Modificatori */
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; } /* Più */
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; } /* Senza */
        .mod-btn.yellow { border-color: #facc15; color: #facc15; } /* Poco */
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; } /* Abbondante */
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .search-mod-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }


        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item.active-menu-selection { border: 3px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);} 
        .item.disabled { background: #f0f0f0; color: #999; cursor: not-allowed; opacity: 0.7; }
        .item.disabled:hover { background: #f0f0f0; }

        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }
        
        /* Stili Ordini Attivi e Avvisi Temporali */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative;}
        /* NUOVO: Ordini Futuri */
        .order-card.future-order { border-left: 5px solid #3b82f6; } 
        .order-card.future-order:before { content: "PRENOTAZIONE"; position: absolute; top: -10px; right: 10px; background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        
        .order-card h4 { margin: 0 0 6px; color: #e31b23; display: flex; justify-content: space-between;}
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        .order-actions button.duplicate { background: #facc15; color: #333;}
        
        /* Filtro Ordini Attivi */
        .filter-row-top { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-btn-status { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .filter-btn-status.active { background: #e31b23; color: #fff; border-color: #e31b23; }

        /* Avvisi Temporali (Mantenuti) */
        .order-card.warning-near { border-left: 5px solid #facc15; } /* Giallo (15 min) */
        .order-card.warning-urgent { border-left: 5px solid #b91c1c; } /* Rosso (5 min) */
        .order-card.warning-near:before { content: "ATTENZIONE: Vicino!"; position: absolute; top: -10px; right: 10px; background: #facc15; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .order-card.warning-urgent:before { content: "URGENTE: Imminente!"; position: absolute; top: -10px; right: 10px; background: #b91c1c; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Stili per la stampa (nasconde elementi non necessari) */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 11pt; }

            /* Stili specifici per la comanda */
            .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; }
            .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; }
            .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; }
            .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
            .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; }
            .print-comanda .item-name { font-weight: bold; font-size: 13pt; }
            .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; }
            .print-comanda .mod-list li { border: none; }
            .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; }

            /* Stili specifici per lo scontrino */
            .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; }
            .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; }
            .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
            .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; }
            .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; }
        }

        /* Stili per le Impostazioni (aggiunti/integrati) */
        .settings h3 { color: #444; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .settings form { display: flex; gap: 5px; margin-bottom: 15px; }
        .settings form input, .settings form select, .settings form button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .settings form input[type="text"], .settings form input[type="number"], .settings form select { flex-grow: 1; }
        .settings form button { background: #10b981; color: #fff; border: none; cursor: pointer; }
        
        .settings-list { margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
        .settings-item span { flex-grow: 1; }
        .settings-item .remove { background: #b91c1c; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        .item-status button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .item-status .available { background: #22c55e; color: #fff; }
        .item-status .finished { background: #b91c1c; color: #fff; }

        /* NUOVI STILI ACCESS E NOTIFICHE */
        .access-container { text-align: center; padding: 50px 20px; background: #fff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 50px; }
        .access-container input { max-width: 250px; margin: 10px auto; display: block; padding: 10px; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 1.2rem;}
        .access-container button { padding: 10px 20px; background: #e31b23; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; margin-top: 10px;}

        .time-capacity { padding: 10px; border: 1px solid #facc15; background-color: #fffbeb; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; }
        .time-capacity.full { border-color: #b91c1c; background-color: #ffecec; color: #b91c1c; font-weight: 700;}
        .time-capacity.warning { border-color: #facc15; background-color: #fffbeb; }

        .settings-item .actions { display: flex; gap: 5px; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <header v-if="userRole !== 'guest'">Pizzeria Smart – Gestionale</header>
        <header v-else>Accesso Gestionale</header>

        <main>
            <div v-if="userRole === 'guest'" class="access-container">
                <h2>Accesso Richiesto</h2>
                <p>Inserisci il codice Operatore o Proprietario:</p>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Codice Segreto" maxlength="4">
                <button @click="grantAccess">Accedi</button>
                <p style="margin-top: 20px; font-size: 0.8rem; color: #999;">Codici di default: Operatore 0000, Proprietario 9999</p>
            </div>
            
            <div v-if="userRole !== 'guest' && view === 'inserimento'">
                <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Nuovo Ordine' }}</h2>
                <button @click="openModal" class="final-btn" :disabled="order.length === 0">
                    <i class="fa-solid fa-file-invoice"></i> Finalizza Ordine ({{ order.length }} Articoli)
                </button>
                <button v-if="editingOrderId" @click="cancelEdit" class="final-btn cancel-edit-btn">
                    <i class="fa-solid fa-xmark"></i> Annulla Modifica
                </button>
                <br><br>

                <div class="order-box">
                    <h3>Carrello</h3>
                    <ul v-if="order.length > 0">
                        <li v-for="(item, index) in order" :key="index" :class="['order-item', { 'selected': selectedItemIndex === index }]" @click="selectItem(index)">
                            <div>
                                <strong style="color: #e31b23;">{{ item.nome }}</strong> 
                                <span v-if="item.isHalfPizza">({{ item.gusto1 }} / {{ item.gusto2 }})</span>
                                <span v-if="item.isMeter">({{ item.sections.length }} Gusti)</span>
                                <span v-if="item.manualPrice !== undefined" style="color:#3b82f6; font-size: 0.8rem;"> (Manuale)</span>
                                
                                <ul v-if="selectedItemIndex === index && !item.isMeter && !item.isHalfPizza && item.modifiers && item.modifiers.length > 0" class="modifiers-list">
                                    <li v-for="(mod, modIndex) in item.modifiers" :key="'mod'+modIndex">
                                        <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                        <span style="font-weight: normal;">{{ mod.prezzo > 0 ? '+€' + mod.prezzo.toFixed(2) : '' }} </span>
                                        <button @click.stop="item.modifiers.splice(modIndex, 1)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                                    </li>
                                </ul>

                                <ul v-if="selectedItemIndex === index && item.isHalfPizza" class="modifiers-list">
                                    <li style="font-weight: bold; color: #444;">Metà 1: {{ item.gusto1 }}</li>
                                    <li v-for="(mod, modIndex) in item.modifiers1" :key="'mod1'+modIndex">
                                        <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                        <span style="font-weight: normal;">{{ mod.prezzo > 0 ? '+€' + mod.prezzo.toFixed(2) : '' }} </span>
                                        <button @click.stop="removeHalfPizzaModifier(1, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                                    </li>
                                    <li style="font-weight: bold; color: #444;">Metà 2: {{ item.gusto2 }}</li>
                                    <li v-for="(mod, modIndex) in item.modifiers2" :key="'mod2'+modIndex">
                                        <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                        <span style="font-weight: normal;">{{ mod.prezzo > 0 ? '+€' + mod.prezzo.toFixed(2) : '' }} </span>
                                        <button @click.stop="removeHalfPizzaModifier(2, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                                    </li>
                                </ul>

                                <ul v-if="selectedItemIndex === index && item.isMeter" class="modifiers-list">
                                    <template v-for="(section, secIndex) in item.sections" :key="'sec'+secIndex">
                                        <li style="font-weight: bold; color: #444;">{{ section.name }}: {{ section.gusto }}</li>
                                        <li v-for="(mod, modIndex) in section.modifiers" :key="'mod'+secIndex+modIndex">
                                            <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                            <span style="font-weight: normal;">{{ mod.prezzo > 0 ? '+€' + mod.prezzo.toFixed(2) : '' }} </span>
                                            <button @click.stop="removeMeterModifier(secIndex, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                            <div style="text-align: right;">
                                <strong>€{{ calculateItemTotal(item).toFixed(2) }}</strong>
                                <div style="display: flex; gap: 5px; margin-top: 5px;">
                                    <button @click.stop="openPriceEditModal(index)" style="border:none;background:#3b82f6;color:#fff; font-size: 0.7rem; border-radius: 4px; padding: 2px 5px;">€</button>
                                    <button @click.stop="removeItem(index)" style="border:none;background:#b91c1c;color:#fff; font-size: 0.7rem; border-radius: 4px; padding: 2px 5px;"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <p v-else style="color: #777;">Aggiungi articoli dal menu.</p>
                    <div class="total">Totale Articoli: €{{ calculatedOrderTotal.toFixed(2) }}</div>
                </div>

                <h3 style="margin-top: 30px;">Modificatori (Seleziona Articolo)</h3>
                <div class="mod-row">
                    <button v-for="(mods, cat) in modifiers" :key="cat" @click="activeModCat = cat; modifierSearchTerm = '';" :class="['mod-btn', { 'active': activeModCat === cat }]">
                        {{ cat }}
                    </button>
                </div>

                <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                
                <div class="grid">
                    <button v-for="(mod, index) in filteredModifiersForActiveCat" :key="index" @click="addExtra(mod)" 
                        :disabled="selectedItemIndex === null || order[selectedItemIndex]?.isMeter || order[selectedItemIndex]?.isHalfPizza || mod.isFinished"
                        :class="['mod-btn', { 
                            'green': activeModCat === 'Più', 
                            'gray': activeModCat === 'Senza', 
                            'yellow': activeModCat === 'Poco', 
                            'blue': activeModCat === 'Abbondante',
                            'disabled': mod.isFinished
                        }]">
                        {{ mod.nome }} {{ mod.prezzo > 0 ? '(+€' + mod.prezzo.toFixed(2) + ')' : '' }}
                    </button>
                </div>


                <h3 style="margin-top: 30px;">Menu</h3>
                <div class="cat-row">
                    <button v-for="(items, cat) in menu" :key="cat" @click="activeCat = cat; searchTerm = '';" :class="['cat-btn', { 'active': activeCat === cat }]">
                        {{ cat }}
                    </button>
                </div>
                
                <input type="text" v-model="searchTerm" placeholder="Cerca articolo o categoria..." class="search-input">

                <div class="grid">
                    <div v-for="(item, index) in filteredAvailableItems" :key="index" @click="handleItemClick(item)" :class="['item', {'active-menu-selection': lastSelectedItem === item}, {'disabled': item.isFinished}]">
                        <strong>{{ item.nome }}</strong>
                        <p>€{{ item.prezzo.toFixed(2) }}</p>
                    </div>
                </div>
            </div>

            <div v-if="userRole !== 'guest' && view === 'ordini'">
                <h2>Ordini Attivi ({{ filteredActiveOrders.length }})</h2>

                <div class="filter-row-top">
                    <button @click="activeDateFilter = 'today'" :class="['filter-btn-status', { 'active': activeDateFilter === 'today' }]">Oggi</button>
                    <button @click="activeDateFilter = 'tomorrow'" :class="['filter-btn-status', { 'active': activeDateFilter === 'tomorrow' }]">Domani</button>
                    <button @click="activeDateFilter = 'future'" :class="['filter-btn-status', { 'active': activeDateFilter === 'future' }]">Futuri</button>
                </div>

                <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca cliente, indirizzo, tavolo..." class="search-input">

                <div v-if="filteredActiveOrders.length === 0" style="text-align: center; color: #777; margin-top: 20px;">
                    Nessun ordine attivo trovato per i filtri selezionati.
                </div>

                <div v-for="order in filteredActiveOrders" :key="order.id" :class="['order-card', 
                    {'future-order': isFutureOrder(order)},
                    {'warning-near': isNear(order)}, 
                    {'warning-urgent': isUrgent(order)}]">
                    
                    <h4>
                        Ordine #{{ order.id }} - {{ order.mode.toUpperCase() }} 
                        <span style="font-size: 0.9rem; color: #3b82f6;">{{ order.status }}</span>
                    </h4>
                    <p>
                        <strong>Cliente:</strong> {{ order.customer || 'N/D' }}
                        <span v-if="order.mode === 'banco' || order.mode === 'asporto'"> (Tavolo: {{ order.tableNumber || '-' }})</span>
                    </p>
                    <p v-if="order.mode === 'consegna'">
                        <strong>Indirizzo:</strong> {{ order.address }} ({{ order.zone }})
                    </p>
                    <p>
                        <strong>Ora:</strong> {{ order.hour }} ({{ formatDate(order.date) }}) | <strong>Totale:</strong> €{{ order.total.toFixed(2) }}
                    </p>
                    <p v-if="order.driver && order.mode === 'consegna'">
                        <strong>Fattorino:</strong> {{ order.driver }}
                    </p>
                    <ul class="order-items">
                        <li v-for="(item, index) in order.items" :key="index">
                            1x {{ item.nome }} <span style="color:#777; font-size:0.8rem;">
                                <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                                <span v-if="item.isMeter">({{ item.sections.length }} Gusti)</span>
                                <span v-if="item.modifiers && item.modifiers.length > 0 && !item.isMeter && !item.isHalfPizza"> (+{{ item.modifiers.length }} mod.)</span>
                            </span>
                        </li>
                    </ul>
                    <div class="order-actions">
                        <button @click="advance(order)">{{ getNextStatus(order.status) }}</button>
                        <button @click="editOrder(order.id)" class="edit"><i class="fa-solid fa-pen"></i> Modifica</button>
                        <button @click="duplicateOrder(order)" class="duplicate"><i class="fa-solid fa-copy"></i></button>
                        <button @click="printOrder(order.id, 'comanda')"><i class="fa-solid fa-print"></i> Comanda</button>
                        <button @click="printOrder(order.id, 'scontrino')"><i class="fa-solid fa-receipt"></i> Scontrino</button>
                        <button @click="showShareMenu(order.id)" class="share"><i class="fa-solid fa-share-nodes"></i></button>
                    </div>
                    <div v-if="order.mode === 'consegna' && order.status !== 'Archivia'">
                        <select :value="order.driver" @change="updateActiveOrderDriver(order.id, $event.target.value)" style="margin-top: 8px; padding: 5px; border-radius: 4px;">
                            <option value="">Assegna Fattorino</option>
                            <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div v-if="userRole !== 'guest' && view === 'storico'">
                <h2>Riepilogo Giornaliero</h2>
                <div v-if="!canAccessRiepilogo" style="color:#b91c1c;">
                    Accesso negato. Solo Operatori o Proprietari possono vedere lo storico.
                </div>
                <div v-else>
                    <div class="form-row">
                        <label>Seleziona Data</label>
                        <input type="date" v-model="archiveDateFilter" @change="calculateDriverStats">
                    </div>
                    <p style="font-weight: bold; font-size: 1.1rem; border-bottom: 2px solid #e31b23; padding-bottom: 5px;">
                        Totale Incasso del {{ archiveDateFilterDisplay }}: €{{ dailyTotal.toFixed(2) }} ({{ filteredArchive.length }} Ordini)
                    </p>

                    <h3 style="margin-top: 20px;">Statistiche Fattorini</h3>
                    <div class="form-row" style="display: flex; gap: 10px; align-items: center;">
                        <label style="flex-shrink: 0;">Fattorino:</label>
                        <select v-model="selectedDriver" @change="calculateDriverStats" style="flex-grow: 1;">
                            <option value="">Tutte le Consegne</option>
                            <option v-for="driver in availableDrivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <p>Ordini (Consegna/{{ selectedDriver || 'Tutti' }}): **{{ driverStats.totalOrders }}**</p>
                    <p>Totale (Consegna/{{ selectedDriver || 'Tutti' }}): **€{{ driverStats.totalRevenue.toFixed(2) }}**</p>

                    <h3 style="margin-top: 20px;">Ordini Chiusi ({{ filteredArchive.length }})</h3>
                    <div v-if="filteredArchive.length === 0" style="text-align: center; color: #777; margin-top: 10px;">
                        Nessun ordine archiviato per questa data.
                    </div>
                    <div v-for="order in filteredArchive" :key="order.id" class="order-card">
                        <h4>
                            ARCHIVIATO #{{ order.id }} - {{ order.mode.toUpperCase() }}
                        </h4>
                        <p>
                            <strong>Cliente:</strong> {{ order.customer || 'N/D' }} 
                            <span v-if="order.mode === 'consegna'"> (Zona: {{ order.zone }})</span>
                            <span v-if="order.mode === 'consegna' || selectedDriver"> | **Fattorino:** {{ order.driver || 'N/A' }}</span>
                        </p>
                        <p>
                            **Data/Ora Chiusura:** {{ new Date(order.archivedTime).toLocaleTimeString('it-IT') }} | 
                            **Incasso:** €{{ order.total.toFixed(2) }}
                        </p>
                        <div class="order-actions">
                            <button @click="printOrder(order.id, 'scontrino')" class="edit"><i class="fa-solid fa-receipt"></i> Scontrino</button>
                            <button @click="duplicateOrder(order)" class="duplicate"><i class="fa-solid fa-copy"></i> Duplica</button>
                            <button @click="printOrder(order.id, 'comanda')"><i class="fa-solid fa-print"></i> Comanda</button>
                            <select v-if="order.mode === 'consegna'" :value="order.driver" @change="updateArchiveDriver(order.id, $event.target.value)" style="margin-top: 8px; padding: 5px; border-radius: 4px;">
                                <option value="">Assegna Fattorino</option>
                                <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="userRole !== 'guest' && view === 'impostazioni'" class="settings">
                <h2>Impostazioni Gestionale</h2>
                <div v-if="!canAccessImpostazioni" style="color:#b91c1c;">
                    Accesso negato. Solo il Proprietario può modificare le impostazioni.
                </div>
                <div v-else>
                    
                    <h3>Codici di Accesso</h3>
                    <div style="background:#fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Nuovo Codice Operatore (Attuale: {{ adminPin }})</label>
                            <form @submit.prevent="saveAdminPin">
                                <input type="password" v-model="newAdminPin" placeholder="Minimo 4 caratteri/numeri" maxlength="4">
                                <button type="submit">Salva Operatore</button>
                            </form>
                        </div>
                        <div class="form-row">
                             <label>Nuovo Codice Proprietario (Attuale: {{ ownerPin }})</label>
                            <form @submit.prevent="saveOwnerPin">
                                <input type="password" v-model="newOwnerPin" placeholder="Minimo 4 caratteri/numeri" maxlength="4">
                                <button type="submit" style="background: #e31b23;">Salva Proprietario</button>
                            </form>
                        </div>
                    </div>

                    <h3>Capacità Oraria (Pizze)</h3>
                    <div style="background:#fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <div class="form-row">
                            <label>Pizze Massime per Intervallo:</label>
                            <input type="number" v-model.number="capacitySettings.maxPizzas" @change="saveData" min="10">
                        </div>
                         <div class="form-row">
                            <label>Durata Intervallo (Minuti):</label>
                            <select v-model.number="capacitySettings.intervalMinutes" @change="saveData">
                                <option value="15">15 minuti</option>
                                <option value="20">20 minuti</option>
                                <option value="30">30 minuti</option>
                                <option value="60">60 minuti</option>
                            </select>
                        </div>
                        <p style="font-size: 0.8rem; color: #777; margin-top: 10px;">
                            *Limite attuale: {{ capacitySettings.maxPizzas }} pizze ogni {{ capacitySettings.intervalMinutes }} minuti.
                        </p>
                    </div>

                    <h3>Gestione Menu e Articoli</h3>
                    <div class="cat-row" style="margin-bottom: 15px;">
                        <button v-for="(items, cat) in menu" :key="cat" @click="activeSettingsCat = cat" :class="['cat-btn', { 'active': activeSettingsCat === cat }]">
                            {{ cat }}
                        </button>
                    </div>
                    <form @submit.prevent="addCategory">
                        <input type="text" v-model="newCategoryName" placeholder="Nuova Categoria Menu" required>
                        <button type="submit">Aggiungi Categoria</button>
                    </form>

                    <h4 style="color: #6b7280; margin-top: 10px;">Articoli in {{ activeSettingsCat }} ({{ menu[activeSettingsCat]?.length || 0 }})</h4>
                    <form @submit.prevent="addItemToCategory">
                        <input type="text" v-model="newItemName" placeholder="Nome Articolo" required>
                        <input type="number" v-model.number="newItemPrice" placeholder="Prezzo" step="0.50" required>
                        <button type="submit">Aggiungi Articolo</button>
                    </form>
                    <div class="settings-list">
                        <div v-for="(item, index) in menu[activeSettingsCat]" :key="index" class="settings-item">
                            <span>{{ item.nome }} - €{{ item.prezzo.toFixed(2) }} 
                                <span v-if="item.isFinished" style="color:#b91c1c; font-weight: bold;">(FINITO)</span>
                            </span>
                            <div class="actions">
                                <button @click="toggleItemFinished(activeSettingsCat, index)" :class="[item.isFinished ? 'available' : 'finished']">
                                    {{ item.isFinished ? 'Disponibile' : 'Finito' }}
                                </button>
                                <button @click="deleteItem(activeSettingsCat, index)" class="remove"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p v-if="menu[activeSettingsCat]?.length === 0">Nessun articolo in questa categoria.</p>
                        <button v-if="activeSettingsCat !== 'Pizze' && menu[activeSettingsCat]?.length === 0" @click="deleteCategory(activeSettingsCat)" class="remove" style="width: 100%; margin-top: 10px;">Elimina Categoria {{ activeSettingsCat }}</button>
                    </div>

                    <h3>Gestione Modificatori</h3>
                    <div class="mod-row" style="margin-bottom: 15px;">
                        <button v-for="(mods, cat) in modifiers" :key="cat" @click="activeSettingsModCat = cat" :class="['mod-btn', { 'active': activeSettingsModCat === cat }]">
                            {{ cat }}
                        </button>
                    </div>
                    <form @submit.prevent="addModifierCategory">
                        <input type="text" v-model="newModifierCategoryName" placeholder="Nuova Categoria Modificatori" required>
                        <button type="submit">Aggiungi Categoria</button>
                    </form>

                    <h4 style="color: #6b7280; margin-top: 10px;">Modificatori in {{ activeSettingsModCat }} ({{ modifiers[activeSettingsModCat]?.length || 0 }})</h4>
                    <form @submit.prevent="addModifierToCategory">
                        <input type="text" v-model="newModifierName" placeholder="Nome Modificatore" required>
                        <input type="number" v-model.number="newModifierPrice" placeholder="Costo" step="0.50" required>
                        <button type="submit">Aggiungi Modificatore</button>
                    </form>
                    <div class="settings-list">
                        <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" class="settings-item">
                            <span>{{ mod.nome }} - €{{ mod.prezzo.toFixed(2) }}
                                <span v-if="mod.isFinished" style="color:#b91c1c; font-weight: bold;">(FINITO)</span>
                            </span>
                            <div class="actions">
                                <button @click="toggleModifierFinished(activeSettingsModCat, index)" :class="[mod.isFinished ? 'available' : 'finished']">
                                    {{ mod.isFinished ? 'Disponibile' : 'Finito' }}
                                </button>
                                <button @click="deleteModifier(activeSettingsModCat, index)" class="remove"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <p v-if="modifiers[activeSettingsModCat]?.length === 0">Nessun modificatore in questa categoria.</p>
                        <button v-if="!isDefaultModifierCategory(activeSettingsModCat) && modifiers[activeSettingsModCat]?.length === 0" @click="deleteModifierCategory(activeSettingsModCat)" class="remove" style="width: 100%; margin-top: 10px;">Elimina Categoria {{ activeSettingsModCat }}</button>
                    </div>

                    <h3>Zone di Consegna e Fattorini</h3>
                    <h4 style="color: #6b7280; margin-top: 10px;">Zone ({{ deliveryZones.length }})</h4>
                    <form @submit.prevent="addZone">
                        <input type="text" v-model="newZoneName" placeholder="Nome Zona" required>
                        <input type="number" v-model.number="newZonePrice" placeholder="Costo" step="0.50" required>
                        <button type="submit">Aggiungi Zona</button>
                    </form>
                    <div class="settings-list">
                        <div v-for="(zone, index) in deliveryZones" :key="index" class="settings-item">
                            <span>{{ zone.name }} - €{{ zone.price.toFixed(2) }}</span>
                            <button @click="deleteZone(index)" class="remove"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>

                    <h4 style="color: #6b7280; margin-top: 10px;">Fattorini ({{ drivers.length }})</h4>
                    <form @submit.prevent="addDriver">
                        <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" required>
                        <button type="submit">Aggiungi Fattorino</button>
                    </form>
                    <div class="settings-list">
                        <div v-for="(driver, index) in drivers" :key="index" class="settings-item">
                            <span>{{ driver }}</span>
                            <button @click="deleteDriver(index)" class="remove"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                    
                    <h3>Gestione Dati</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button @click="exportData" class="final-btn" style="background: #3b82f6;"><i class="fa-solid fa-download"></i> Esporta Dati (JSON)</button>
                        <button @click="importData" class="final-btn" style="background: #facc15; color: #333;"><i class="fa-solid fa-upload"></i> Importa Dati (JSON)</button>
                        <button @click="clearCache" class="final-btn" style="background: #b91c1c;"><i class="fa-solid fa-broom"></i> Pulisci Ordini/Storico</button>
                    </div>
                </div>
            </div>


            <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
                <div class="modal-content">
                    <h3>Finalizza Ordine - Totale: €{{ total.toFixed(2) }}</h3>

                    <div v-if="orderCapacity.total > 0" :class="['time-capacity', { 'full': isCapacityFull, 'warning': isCapacityWarning && !isCapacityFull }]">
                        <i :class="['fa-solid', isCapacityFull ? 'fa-triangle-exclamation' : 'fa-circle-exclamation']"></i> 
                        {{ isCapacityFull ? 'ATTENZIONE: Capacità oraria esaurita' : 'Avviso: Capacità quasi piena' }} 
                        per l'intervallo scelto.
                        (Pizze: {{ orderCapacity.total }}/{{ capacitySettings.maxPizzas }})
                    </div>


                    <div class="form-row">
                        <label>Modalità</label>
                        <div style="display: flex; gap: 10px;">
                            <div v-for="m in modes" :key="m.id" :class="['mode-card', { 'active': mode === m.id }]" @click="selectMode(m.id)" style="flex: 1;">
                                <i :class="[m.icon]" style="margin-right: 5px;"></i> {{ m.label }}
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Data Ritiro/Consegna</label>
                        <input type="date" v-model="date" :min="minDate" @change="updateCapacityWarning">
                    </div>
                    <div class="form-row">
                        <label>Ora Ritiro/Consegna</label>
                        <input type="time" v-model="hour" @change="updateCapacityWarning">
                    </div>

                    <div v-if="mode === 'banco'">
                        <div class="form-row">
                            <label>Nome / Tavolo</label>
                            <input type="text" v-model="tableNumber" placeholder="Nome o Numero Tavolo">
                        </div>
                    </div>

                    <div v-if="mode === 'asporto' || mode === 'consegna'">
                        <div class="form-row">
                            <label>Nome Cliente</label>
                            <input type="text" v-model="customer" placeholder="Nome e Cognome" @input="filterCustomers">
                            <ul v-if="filteredCustomerSuggestions.length > 0" style="list-style: none; padding: 0; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
                                <li v-for="c in filteredCustomerSuggestions" :key="c.customer" @click="loadCustomerData(c)" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    {{ c.customer }} ({{ c.phone }})
                                </li>
                            </ul>
                        </div>
                        <div class="form-row">
                            <label>Telefono</label>
                            <input type="tel" v-model="phone" placeholder="Numero di telefono">
                        </div>
                    </div>

                    <div v-if="mode === 'consegna'">
                        <div class="form-row">
                            <label>Via</label>
                            <input type="text" v-model="address" placeholder="Via">
                        </div>
                        <div class="form-row" style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label>N. Civico</label>
                                <input type="text" v-model="streetNumber" placeholder="N. Civico">
                            </div>
                            <div style="flex: 1;">
                                <label>Città</label>
                                <input type="text" v-model="town" placeholder="Città">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Zona di Consegna (Costo: €{{ deliveryCost.toFixed(2) }})</label>
                            <select v-model="zoneName" @change="updateDeliveryCost">
                                <option value="">Seleziona Zona</option>
                                <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">
                                    {{ zone.name }} (€{{ zone.price.toFixed(2) }})
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Note / Istruzioni Speciali</label>
                        <textarea v-model="notes" rows="2" placeholder="Es: Condomini, citofono, allergie..."></textarea>
                    </div>

                    <div class="form-row">
                        <label>Acconto Ricevuto (per calcolo resto)</label>
                        <input type="number" v-model.number="accontoRicevuto" min="0" :placeholder="'Totale €' + total.toFixed(2)">
                        <p v-if="restoDaDare > 0" style="color: #10b981; font-weight: bold; margin-top: 5px;">Resto da dare: €{{ restoDaDare.toFixed(2) }}</p>
                    </div>


                    <div class="modal-actions">
                        <button @click="showModal = false" class="btn-cancel">Annulla</button>
                        <button @click="confermaOrdine" class="btn-confirm" :disabled="!mode || !date || !hour">
                            <i class="fa-solid fa-check"></i> Salva Ordine
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="showMeterModal && tempMeterItem" class="modal-overlay" @click.self="cancelMeterComposition">
                <div class="modal-content" style="max-width: 90%; width: 600px;">
                    <h3>Componi {{ tempMeterItem.nome }} - Totale: €{{ calculateTempMeterTotal.toFixed(2) }}</h3>

                    <p>Seleziona i gusti e i modificatori per ogni sezione.</p>

                    <div v-for="(section, secIndex) in tempMeterItem.sections" :key="secIndex" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px; color: #3b82f6;">{{ section.name }} ({{ (section.size * 100).toFixed(0) }}%)</h4>
                        
                        <div class="form-row">
                             <label>Gusto Sezione</label>
                             <input type="text" :value="section.gusto" @focus="section.activeSection = true" @input="gustoSearchTerm = $event.target.value; section.gusto = $event.target.value" placeholder="Cerca pizza..." @blur="setTimeout(() => section.activeSection = false, 200)">
                             
                             <div v-if="section.activeSection && filteredPizzaGusti.length > 0" style="position: absolute; background: #fff; border: 1px solid #ccc; z-index: 10; width: 100%; max-height: 150px; overflow-y: auto;">
                                <div v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @mousedown.prevent="selectMeterGusto(secIndex, pizza.nome)" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    {{ pizza.nome }} (€{{ pizza.prezzo.toFixed(2) }})
                                </div>
                             </div>
                        </div>

                        <label style="margin-top: 10px;">Modificatori Aggiuntivi per {{ section.name }}</label>
                        <div class="mod-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat; modifierSearchTerm = '';" :class="['mod-btn', { 'active': tempModCat === cat }]">
                                {{ cat }}
                            </button>
                        </div>
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">

                        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                            <button v-for="(mod, modIndex) in filteredTempModifiers" :key="modIndex" @click="addMeterModifier(secIndex, mod)" 
                                :disabled="mod.isFinished"
                                :class="['mod-btn', { 
                                    'green': tempModCat === 'Più', 
                                    'gray': tempModCat === 'Senza', 
                                    'yellow': tempModCat === 'Poco', 
                                    'blue': tempModCat === 'Abbondante',
                                    'disabled': mod.isFinished
                                }]">
                                {{ mod.nome }} {{ mod.prezzo > 0 ? '(+€' + mod.prezzo.toFixed(2) + ')' : '' }}
                            </button>
                        </div>

                        <ul v-if="section.modifiers && section.modifiers.length > 0" class="modifiers-list" style="padding-left: 0; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                            <li v-for="(mod, modIndex) in section.modifiers" :key="'secmod'+modIndex" style="justify-content: space-between; display: flex;">
                                <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                <button @click.stop="removeMeterModifier(secIndex, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div class="modal-actions">
                        <button @click="cancelMeterComposition" class="btn-cancel">Annulla</button>
                        <button @click="addMeterToOrder" class="btn-confirm" :disabled="!isMeterValid">
                            <i class="fa-solid fa-plus"></i> Aggiungi al Carrello
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="showHalfPizzaModal && tempHalfPizzaItem" class="modal-overlay" @click.self="cancelHalfPizzaComposition">
                <div class="modal-content" style="max-width: 90%; width: 600px;">
                    <h3>Componi Pizza Metà - Totale: €{{ calculateTempHalfPizzaTotal.toFixed(2) }}</h3>

                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px; color: #e31b23;">METÀ 1</h4>
                        <div class="form-row">
                             <label>Gusto Metà 1</label>
                             <input type="text" :value="tempHalfPizzaItem.gusto1" @focus="tempHalfPizzaItem.activeHalf = 1" @input="gustoSearchTerm = $event.target.value; tempHalfPizzaItem.gusto1 = $event.target.value" placeholder="Cerca pizza..." @blur="setTimeout(() => tempHalfPizzaItem.activeHalf = 0, 200)">
                             
                             <div v-if="tempHalfPizzaItem.activeHalf === 1 && filteredPizzaGusti.length > 0" style="position: absolute; background: #fff; border: 1px solid #ccc; z-index: 10; width: 100%; max-height: 150px; overflow-y: auto;">
                                <div v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @mousedown.prevent="selectHalfPizzaGusto(1, pizza.nome)" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    {{ pizza.nome }} (€{{ pizza.prezzo.toFixed(2) }})
                                </div>
                             </div>
                        </div>

                        <label style="margin-top: 10px;">Modificatori Aggiuntivi Metà 1</label>
                        <div class="mod-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat; modifierSearchTerm = '';" :class="['mod-btn', { 'active': tempModCat === cat }]">
                                {{ cat }}
                            </button>
                        </div>
                         <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">

                        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                            <button v-for="(mod, modIndex) in filteredTempModifiers" :key="modIndex" @click="addHalfPizzaModifier(1, mod)" 
                                :disabled="mod.isFinished"
                                :class="['mod-btn', { 
                                    'green': tempModCat === 'Più', 
                                    'gray': tempModCat === 'Senza', 
                                    'yellow': tempModCat === 'Poco', 
                                    'blue': tempModCat === 'Abbondante',
                                    'disabled': mod.isFinished
                                }]">
                                {{ mod.nome }} {{ mod.prezzo > 0 ? '(+€' + mod.prezzo.toFixed(2) + ')' : '' }}
                            </button>
                        </div>
                         <ul v-if="tempHalfPizzaItem.modifiers1 && tempHalfPizzaItem.modifiers1.length > 0" class="modifiers-list" style="padding-left: 0; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                            <li v-for="(mod, modIndex) in tempHalfPizzaItem.modifiers1" :key="'mod1list'+modIndex" style="justify-content: space-between; display: flex;">
                                <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                <button @click.stop="removeHalfPizzaModifier(1, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div style="border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px; color: #e31b23;">METÀ 2</h4>
                        <div class="form-row">
                             <label>Gusto Metà 2</label>
                             <input type="text" :value="tempHalfPizzaItem.gusto2" @focus="tempHalfPizzaItem.activeHalf = 2" @input="gustoSearchTerm = $event.target.value; tempHalfPizzaItem.gusto2 = $event.target.value" placeholder="Cerca pizza..." @blur="setTimeout(() => tempHalfPizzaItem.activeHalf = 0, 200)">
                             
                             <div v-if="tempHalfPizzaItem.activeHalf === 2 && filteredPizzaGusti.length > 0" style="position: absolute; background: #fff; border: 1px solid #ccc; z-index: 10; width: 100%; max-height: 150px; overflow-y: auto;">
                                <div v-for="pizza in filteredPizzaGusti" :key="pizza.nome" @mousedown.prevent="selectHalfPizzaGusto(2, pizza.nome)" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    {{ pizza.nome }} (€{{ pizza.prezzo.toFixed(2) }})
                                </div>
                             </div>
                        </div>

                        <label style="margin-top: 10px;">Modificatori Aggiuntivi Metà 2</label>
                        <div class="mod-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" @click="tempModCat = cat; modifierSearchTerm = '';" :class="['mod-btn', { 'active': tempModCat === cat }]">
                                {{ cat }}
                            </button>
                        </div>
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">

                        <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                            <button v-for="(mod, modIndex) in filteredTempModifiers" :key="modIndex" @click="addHalfPizzaModifier(2, mod)" 
                                :disabled="mod.isFinished"
                                :class="['mod-btn', { 
                                    'green': tempModCat === 'Più', 
                                    'gray': tempModCat === 'Senza', 
                                    'yellow': tempModCat === 'Poco', 
                                    'blue': tempModCat === 'Abbondante',
                                    'disabled': mod.isFinished
                                }]">
                                {{ mod.nome }} {{ mod.prezzo > 0 ? '(+€' + mod.prezzo.toFixed(2) + ')' : '' }}
                            </button>
                        </div>
                         <ul v-if="tempHalfPizzaItem.modifiers2 && tempHalfPizzaItem.modifiers2.length > 0" class="modifiers-list" style="padding-left: 0; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px;">
                            <li v-for="(mod, modIndex) in tempHalfPizzaItem.modifiers2" :key="'mod2list'+modIndex" style="justify-content: space-between; display: flex;">
                                <span>{{ getModifierIcon(getModifierCategory(mod.nome)) }} {{ mod.nome }}</span>
                                <button @click.stop="removeHalfPizzaModifier(2, modIndex)" class="mod-remove-btn"><i class="fa-solid fa-trash-can"></i></button>
                            </li>
                        </ul>
                    </div>

                    <div class="modal-actions">
                        <button @click="cancelHalfPizzaComposition" class="btn-cancel">Annulla</button>
                        <button @click="addHalfPizzaToOrder" class="btn-confirm" :disabled="!isHalfPizzaValid">
                            <i class="fa-solid fa-plus"></i> Aggiungi al Carrello
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="showPriceEditModal" class="modal-overlay" @click.self="showPriceEditModal = false">
                <div class="modal-content">
                    <h3>Modifica Prezzo Manuale</h3>
                    <p>Articolo: **{{ order[tempPriceEditIndex]?.nome }}**</p>
                    <div class="form-row">
                        <label>Nuovo Prezzo (€)</label>
                        <input type="number" v-model.number="newPriceValue" step="0.01" min="0">
                    </div>
                    <div class="modal-actions">
                        <button @click="showPriceEditModal = false" class="btn-cancel">Annulla</button>
                        <button @click="saveNewPrice" class="btn-confirm">
                            <i class="fa-solid fa-floppy-disk"></i> Salva Prezzo
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="showShareModal && selectedOrderForShare" class="modal-overlay" @click.self="showShareModal = false">
                <div class="modal-content">
                    <h3>Condividi Ordine #{{ selectedOrderForShare.id }}</h3>
                    <p>Scegli come inviare il riepilogo dell'ordine:</p>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button @click="shareViaWhatsapp(selectedOrderForShare)" class="final-btn" style="background: #25D366; color: #fff;"><i class="fa-brands fa-whatsapp"></i> Invia su WhatsApp</button>
                        <button @click="printOrder(selectedOrderForShare.id, 'scontrino')" class="final-btn" style="background: #3b82f6;"><i class="fa-solid fa-receipt"></i> Stampa Scontrino</button>
                    </div>
                </div>
            </div>

             <div id="print-content-comanda" class="print-container print-comanda" style="display: none;"></div>
            <div id="print-content-scontrino" class="print-container print-scontrino" style="display: none;"></div>


        </main>

        <nav v-if="userRole !== 'guest'">
            <button @click="view = 'inserimento'" :class="{ 'active': view === 'inserimento' }">
                <i class="fa-solid fa-pizza-slice"></i>
                <span>Nuovo Ordine</span>
            </button>
            <button @click="view = 'ordini'" :class="{ 'active': view === 'ordini' }">
                <i class="fa-solid fa-list-check"></i>
                <span>Attivi ({{ orders.filter(o => activeDateFilter === 'all' || o.date === getTodayDateString()).length }})</span>
            </button>
            <button @click="view = 'storico'; calculateDriverStats();" :class="{ 'active': view === 'storico' }" :disabled="!canAccessRiepilogo">
                <i class="fa-solid fa-chart-line"></i>
                <span>Riepilogo</span>
            </button>
            <button @click="view = 'impostazioni'" :class="{ 'active': view === 'impostazioni' }" :disabled="!canAccessImpostazioni">
                <i class="fa-solid fa-gear"></i>
                <span>Impostazioni</span>
            </button>
            <button @click="userRole = 'guest'; localStorage.removeItem('pz_user_role'); view = 'accesso';" style="color: #b91c1c;">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Esci</span>
            </button>
        </nav>
        
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;

        const app = createApp({
            data() {
                return {
                    // --- Dati di Base e Stato Applicazione ---
                    view: 'accesso', // 'accesso', 'inserimento', 'ordini', 'storico', 'impostazioni'
                    userRole: 'guest', // 'guest', 'admin', 'owner'
                    accessPin: '',

                    // Dati PIN (Caricati da localStorage)
                    adminPin: '0000', 
                    ownerPin: '9999',
                    newAdminPin: '',
                    newOwnerPin: '',

                    // --- Menu e Modificatori (Dati di Default) ---
                    menu: {
                        'Pizze': [
                            { nome: 'Margherita', prezzo: 5.00 },
                            { nome: 'Diavola', prezzo: 7.50 },
                            { nome: 'Prosciutto', prezzo: 7.00 },
                            { nome: 'Pizza Metà Base', prezzo: 0.00, isHalfPizza: true }, // Articolo base per pizza metà
                        ],
                        'Mezzo Metro': [
                            { nome: 'Mezzo Metro (2 Gusti)', prezzo: 12.00, isMeter: true, sections: [{name:"Metà A", size:0.5}, {name:"Metà B", size:0.5}] },
                            { nome: 'Schiacciata Grande', prezzo: 8.00, isMeter: true, sections: [{name:"Gusto Unico", size:1}] },
                        ],
                        'Bibite': [
                            { nome: 'Acqua Nat. 0.5L', prezzo: 1.50 },
                            { nome: 'Coca Cola 0.33L', prezzo: 2.50 },
                        ],
                        'Dolci': [
                            { nome: 'Tiramisù', prezzo: 4.00 }
                        ]
                    },
                    modifiers: {
                        'Più': [
                            { nome: 'Mozzarella', prezzo: 0.50 },
                            { nome: 'Prosciutto Cotto', prezzo: 1.00 },
                        ],
                        'Senza': [
                            { nome: 'Aglio', prezzo: 0.00 },
                            { nome: 'Cipolla', prezzo: 0.00 },
                        ],
                        'Poco': [
                            { nome: 'Sale', prezzo: 0.00 },
                        ],
                        'Abbondante': [
                            { nome: 'Olio', prezzo: 0.00 },
                        ]
                    },

                    // --- Gestione Ordine e Carrello ---
                    order: [], // Carrello dell'ordine corrente
                    selectedItemIndex: null,
                    lastSelectedItem: null,
                    
                    // Modifiche
                    activeCat: 'Pizze',
                    searchTerm: '',
                    activeModCat: 'Più',
                    modifierSearchTerm: '',
                    
                    // Modale Composizione Mezzo Metro
                    showMeterModal: false,
                    tempMeterItem: null,
                    gustoSearchTerm: '',
                    tempModCat: 'Più', // Categoria modificatore nella modale

                    // Modale Composizione Pizza a Metà
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,

                    // Modale Finalizzazione
                    showModal: false,
                    editingOrderId: null,
                    modes: [
                        { id: 'banco', label: 'Banco', icon: 'fa-solid fa-person' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck-fast' },
                    ],
                    mode: 'banco',
                    date: this.getTodayDateString(),
                    hour: this.getCurrentHourString(),
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: '',
                    zoneName: '',
                    notes: '',
                    accontoRicevuto: 0,
                    
                    // Dati Ordini e Archivio
                    orders: [], // Ordini Attivi
                    archive: [], // Storico Ordini
                    
                    // Zone di Consegna e Fattorini
                    deliveryZones: [
                        { name: 'Centro', price: 2.00 },
                        { name: 'Periferia Nord', price: 3.50 },
                    ],
                    drivers: ['Mario', 'Luigi'], // Nomi Fattorini
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', // 'today', 'tomorrow', 'future'

                    // Storico/Archivio
                    archiveDateFilter: this.getTodayDateString(),
                    selectedDriver: '', // Per le statistiche
                    driverStats: { totalOrders: 0, totalRevenue: 0 },

                    // Impostazioni
                    activeSettingsCat: 'Pizze',
                    newCategoryName: '',
                    newItemName: '',
                    newItemPrice: 0,
                    
                    activeSettingsModCat: 'Più',
                    newModifierCategoryName: '',
                    newModifierName: '',
                    newModifierPrice: 0,

                    newZoneName: '',
                    newZonePrice: 0,
                    newDriverName: '',

                    // Capacità Oraria
                    capacitySettings: {
                        maxPizzas: 40,
                        intervalMinutes: 15, // 15, 20, 30, 60
                    },
                    orderCapacity: { total: 0, nextInterval: '' },

                    // Modale Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0,
                    
                    // Modale Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,

                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: [],
                }
            },
            
            computed: {
                total() {
                    return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                },
                calculatedOrderTotal() {
                    return this.total + this.deliveryCost;
                },
                deliveryCost() {
                    if (this.mode === 'consegna' && this.zoneName) {
                        const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                        return zone ? zone.price : 0.00;
                    }
                    return 0.00;
                },
                restoDaDare() {
                    return Math.max(0, this.accontoRicevuto - this.calculatedOrderTotal);
                },
                minDate() {
                    return this.getTodayDateString();
                },
                isCapacityFull() {
                    return this.orderCapacity.total >= this.capacitySettings.maxPizzas;
                },
                isCapacityWarning() {
                    return this.orderCapacity.total >= this.capacitySettings.maxPizzas * 0.75;
                },
                
                // Filtri
                filteredAvailableItems() {
                    let items = this.menu[this.activeCat] || [];
                    
                    // Gestione ricerca su tutte le categorie se il termine è presente
                    if (this.searchTerm) {
                        const lowerSearch = this.searchTerm.toLowerCase();
                        let allItems = [];
                        for (const cat in this.menu) {
                            allItems = allItems.concat(this.menu[cat].map(item => ({...item, category: cat})));
                        }
                        
                        // Filtra per nome articolo o nome categoria
                        return allItems.filter(item => 
                            item.nome.toLowerCase().includes(lowerSearch) || 
                            item.category.toLowerCase().includes(lowerSearch)
                        );
                    }

                    return items.filter(item => !item.isFinished);
                },
                filteredModifiersForActiveCat() {
                    let mods = this.modifiers[this.activeModCat] || [];
                    const lowerSearch = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => mod.nome.toLowerCase().includes(lowerSearch));
                },

                // Filtri per Modali Composte (Mezzo Metro/Pizza Metà)
                filteredPizzaGusti() {
                    const pizze = this.menu['Pizze'] || [];
                    const lowerSearch = this.gustoSearchTerm.toLowerCase();
                    return pizze.filter(p => p.nome.toLowerCase().includes(lowerSearch) && !p.isHalfPizza && !p.isFinished);
                },
                filteredTempModifiers() {
                    let mods = this.modifiers[this.tempModCat] || [];
                    const lowerSearch = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => mod.nome.toLowerCase().includes(lowerSearch));
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    return this.tempMeterItem.sections.every(section => section.gusto && section.gusto.trim() !== '');
                },
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;
                    let basePrice = this.tempMeterItem.prezzo;
                    let modifierTotal = 0;
                    this.tempMeterItem.sections.forEach(section => {
                        if (section.modifiers) {
                            modifierTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }
                    });
                    return basePrice + modifierTotal;
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto2;
                },
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    let basePrice = this.tempHalfPizzaItem.prezzo; // Base price is usually 0.00 for the 'Half Pizza Base' item
                    
                    // Calcola il costo del gusto PIÙ CARO
                    const pizzaGusto1 = this.menu['Pizze'].find(p => p.nome === this.tempHalfPizzaItem.gusto1);
                    const pizzaGusto2 = this.menu['Pizze'].find(p => p.nome === this.tempHalfPizzaItem.gusto2);
                    
                    const price1 = pizzaGusto1 ? pizzaGusto1.prezzo : 0;
                    const price2 = pizzaGusto2 ? pizzaGusto2.prezzo : 0;
                    
                    let maxGustoPrice = Math.max(price1, price2);

                    // Aggiungi i costi dei modificatori
                    let modifierTotal = 0;
                    if (this.tempHalfPizzaItem.modifiers1) {
                        modifierTotal += this.tempHalfPizzaItem.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }
                    if (this.tempHalfPizzaItem.modifiers2) {
                        modifierTotal += this.tempHalfPizzaItem.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }

                    // Aggiungi un costo fisso per il servizio/lavoro della pizza a metà (qui uso l'item.prezzo base)
                    // Nel caso di 'Pizza Metà Base' (prezzo 0.00), l'unico costo è il gusto più caro + modificatori.
                    // Se vuoi un costo fisso per la divisione, aggiungilo qui. Per ora, il costo è solo dato dal gusto più caro.
                    return maxGustoPrice + modifierTotal + basePrice; 
                },
                
                // Filtri Ordini Attivi
                filteredActiveOrders() {
                    const today = this.getTodayDateString();
                    const tomorrow = this.getTomorrowDateString();
                    const now = new Date();

                    return this.orders.filter(order => {
                        let dateMatch = false;
                        
                        if (this.activeDateFilter === 'today') {
                            dateMatch = order.date === today;
                        } else if (this.activeDateFilter === 'tomorrow') {
                            dateMatch = order.date === tomorrow;
                        } else if (this.activeDateFilter === 'future') {
                            // Filtra gli ordini futuri (dal giorno dopo domani in poi)
                            dateMatch = order.date !== today && order.date !== tomorrow && new Date(order.date) > now;
                        }
                        
                        if (!dateMatch) return false;

                        const lowerSearch = this.activeOrderSearchTerm.toLowerCase();
                        if (lowerSearch) {
                            return (
                                order.customer?.toLowerCase().includes(lowerSearch) ||
                                order.address?.toLowerCase().includes(lowerSearch) ||
                                order.tableNumber?.toLowerCase().includes(lowerSearch) ||
                                order.zone?.toLowerCase().includes(lowerSearch)
                            );
                        }
                        return true;
                    }).sort((a, b) => {
                        // Ordina prima per data, poi per ora.
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },

                // Filtro Storico
                filteredArchive() {
                    const date = this.archiveDateFilter;
                    let filtered = this.archive.filter(order => order.date === date);

                    if (this.selectedDriver) {
                        filtered = filtered.filter(order => 
                            order.mode === 'consegna' && order.driver === this.selectedDriver
                        );
                    }
                    
                    return filtered.sort((a, b) => new Date(a.archivedTime) - new Date(b.archivedTime));
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                availableDrivers() {
                    const drivers = new Set(this.archive
                        .filter(o => o.date === this.archiveDateFilter && o.mode === 'consegna')
                        .map(o => o.driver).filter(d => d));
                    return Array.from(drivers);
                },
                archiveDateFilterDisplay() {
                    return new Date(this.archiveDateFilter).toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                },

                // Permessi
                canAccessImpostazioni() {
                    return this.userRole === 'owner';
                },
                canAccessRiepilogo() {
                    return this.userRole === 'owner' || this.userRole === 'admin';
                }
            },
            
            watch: {
                // Sincronizza il carrello con il localStorage ogni volta che cambia
                order: {
                    handler() {
                        this.saveData();
                    },
                    deep: true
                },
                // Salva lo stato dell'app quando cambiano i dati principali
                orders: { handler() { this.saveData(); }, deep: true },
                archive: { handler() { this.saveData(); }, deep: true },
                menu: { handler() { this.saveData(); }, deep: true },
                modifiers: { handler() { this.saveData(); }, deep: true },
                deliveryZones: { handler() { this.saveData(); }, deep: true },
                drivers: { handler() { this.saveData(); }, deep: true },
                capacitySettings: { handler() { this.saveData(); }, deep: true },
                adminPin: { handler() { this.saveData(); }, deep: true },
                ownerPin: { handler() { this.saveData(); }, deep: true },
                customerHistory: { handler() { this.saveData(); }, deep: true },

                // Reimposta il cliente se la modalità cambia
                mode() {
                    if (this.mode === 'banco') {
                        this.customer = '';
                        this.phone = '';
                        this.address = '';
                        this.streetNumber = '';
                        this.town = '';
                        this.zoneName = '';
                    } else if (this.mode === 'asporto') {
                        this.address = '';
                        this.streetNumber = '';
                        this.town = '';
                        this.zoneName = '';
                    } else { // 'consegna'
                        this.tableNumber = '';
                    }
                    this.updateDeliveryCost();
                    this.updateCapacityWarning();
                },
                date() {
                    this.updateCapacityWarning();
                },
                hour() {
                    this.updateCapacityWarning();
                },

                // Se cambio data nello storico, ricalcolo le statistiche
                archiveDateFilter() {
                    this.calculateDriverStats();
                },
            },
            
            mounted() {
                this.loadData();
                this.checkUserRole();
                this.setInitialDates();
                this.updateCapacityWarning(); // Calcola la capacità all'avvio
                
                // Aggiorna l'orario ogni minuto per la visualizzazione corretta delle avvertenze
                setInterval(() => {
                    if (this.view === 'ordini') {
                        // Forziamo un aggiornamento per triggerare i computed delle classi CSS
                        this.orders = [...this.orders]; 
                    }
                }, 60000);
            },
            
            methods: {
                // --- Funzioni di Utilità e Dati ---
                getTodayDateString() {
                    return new Date().toISOString().split('T')[0];
                },
                getTomorrowDateString() {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                },
                getCurrentHourString() {
                    const now = new Date();
                    // Arrotonda ai 5 minuti più vicini
                    const minutes = Math.round(now.getMinutes() / 5) * 5;
                    now.setMinutes(minutes);
                    return now.toTimeString().slice(0, 5);
                },
                formatDate(dateStr) {
                    const date = new Date(dateStr);
                    const today = this.getTodayDateString();
                    const tomorrow = this.getTomorrowDateString();

                    if (dateStr === today) return 'Oggi';
                    if (dateStr === tomorrow) return 'Domani';
                    
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                },
                
                // --- Gestione Dati e LocalStorage ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeria_smart_data');
                        if (data) {
                            const parsed = JSON.parse(data);
                            
                            // Carica solo le proprietà che sono state salvate
                            if (parsed.menu) this.menu = parsed.menu;
                            if (parsed.modifiers) this.modifiers = parsed.modifiers;
                            if (parsed.orders) this.orders = parsed.orders;
                            if (parsed.archive) this.archive = parsed.archive;
                            if (parsed.deliveryZones) this.deliveryZones = parsed.deliveryZones;
                            if (parsed.drivers) this.drivers = parsed.drivers;
                            if (parsed.capacitySettings) this.capacitySettings = parsed.capacitySettings;
                            if (parsed.adminPin) this.adminPin = parsed.adminPin;
                            if (parsed.ownerPin) this.ownerPin = parsed.ownerPin;
                            if (parsed.customerHistory) this.customerHistory = parsed.customerHistory;

                            // Carica lo stato del carrello corrente (utile per i refresh)
                            if (parsed.currentOrder) this.order = parsed.currentOrder;
                            if (parsed.editingOrderId !== undefined) this.editingOrderId = parsed.editingOrderId;
                            if (parsed.activeSettingsCat) this.activeSettingsCat = parsed.activeSettingsCat;
                            if (parsed.activeSettingsModCat) this.activeSettingsModCat = parsed.activeSettingsModCat;

                        }
                    } catch (e) {
                        console.error("Errore nel caricamento dei dati da localStorage:", e);
                    }
                },
                saveData() {
                    const dataToSave = {
                        menu: this.menu,
                        modifiers: this.modifiers,
                        orders: this.orders,
                        archive: this.archive,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        capacitySettings: this.capacitySettings,
                        adminPin: this.adminPin,
                        ownerPin: this.ownerPin,
                        customerHistory: this.customerHistory,
                        
                        // Stato UI corrente
                        currentOrder: this.order,
                        editingOrderId: this.editingOrderId,
                        activeSettingsCat: this.activeSettingsCat,
                        activeSettingsModCat: this.activeSettingsModCat,
                    };
                    localStorage.setItem('pizzeria_smart_data', JSON.stringify(dataToSave));
                },
                clearCache() {
                    if (confirm("Sei sicuro di voler pulire TUTTI gli ordini attivi e lo storico archiviato? Questa azione non è reversibile.")) {
                        this.orders = [];
                        this.archive = [];
                        this.order = [];
                        this.editingOrderId = null;
                        this.customerHistory = [];
                        alert("Ordini e Storico puliti con successo.");
                        this.saveData();
                        this.calculateDriverStats(); // Aggiorna le statistiche
                    }
                },
                exportData() {
                    const data = localStorage.getItem('pizzeria_smart_data');
                    if (!data) return alert("Nessun dato da esportare.");
                    
                    const filename = `pizzeria_smart_data_${new Date().toISOString().slice(0, 10)}.json`;
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert("Dati esportati con successo!");
                },
                importData() {
                    if (!confirm("Sei sicuro di voler importare dati? Questo SOSTITUIRÀ tutti i dati attuali.")) {
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = event => {
                            try {
                                const importedData = event.target.result;
                                JSON.parse(importedData); // Test per validità JSON
                                localStorage.setItem('pizzeria_smart_data', importedData);
                                this.loadData();
                                alert("Dati importati con successo! Ricarica la pagina per applicare pienamente i cambiamenti.");
                            } catch (error) {
                                alert("Errore durante l'importazione: il file non è un JSON valido.");
                                console.error(error);
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },

                // --- Gestione Accesso e PIN ---
                checkUserRole() {
                    // Controlla se il ruolo è stato salvato nella sessione precedente
                    const role = localStorage.getItem('pz_user_role');
                    if (role === 'admin' || role === 'owner') {
                        this.userRole = role;
                        this.view = 'ordini'; // Vai direttamente agli ordini
                    }
                },
                grantAccess() {
                    const pin = this.accessPin.trim();
                    if (pin === this.adminPin) {
                        this.userRole = 'admin';
                        localStorage.setItem('pz_user_role', 'admin');
                        this.view = 'ordini';
                        this.accessPin = '';
                    } else if (pin === this.ownerPin) {
                        this.userRole = 'owner';
                        localStorage.setItem('pz_user_role', 'owner');
                        this.view = 'ordini';
                        this.accessPin = '';
                    } else {
                        alert("Codice di accesso non valido!");
                        this.accessPin = '';
                    }
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.adminPin = this.newAdminPin;
                        this.newAdminPin = '';
                        alert("Codice Operatore salvato con successo.");
                        this.saveData();
                    } else {
                        alert("Il codice deve avere almeno 4 caratteri/numeri.");
                    }
                },
                saveOwnerPin() {
                     if (this.newOwnerPin.length >= 4) {
                        this.ownerPin = this.newOwnerPin;
                        this.newOwnerPin = '';
                        alert("Codice Proprietario salvato con successo.");
                        this.saveData();
                    } else {
                        alert("Il codice deve avere almeno 4 caratteri/numeri.");
                    }
                },

                // --- Logica Carrello Ordine ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) {
                        return item.manualPrice; // Se il prezzo è stato impostato manualmente
                    }

                    let basePrice = item.prezzo || 0;
                    let modifierTotal = 0;
                    
                    // Gestione modificatori standard
                    if (item.modifiers && !item.isHalfPizza && !item.isMeter) {
                        modifierTotal += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }

                    // Gestione Mezzo Metro / Schiacciata Grande (i modificatori vengono conteggiati come extra sul prezzo base dell'articolo)
                    if (item.isMeter) {
                        item.sections.forEach(section => {
                            if (section.modifiers) {
                                modifierTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                            }
                        });
                        return basePrice + modifierTotal;
                    }

                    // Gestione Pizza a Metà (Il costo totale è dato dal gusto PIÙ CARO + modificatori + baseItemPrice)
                    if (item.isHalfPizza) {
                        const pizzaGusto1 = this.menu['Pizze'].find(p => p.nome === item.gusto1);
                        const pizzaGusto2 = this.menu['Pizze'].find(p => p.nome === item.gusto2);
                        
                        const price1 = pizzaGusto1 ? pizzaGusto1.prezzo : 0;
                        const price2 = pizzaGusto2 ? pizzaGusto2.prezzo : 0;
                        
                        let maxGustoPrice = Math.max(price1, price2);
                        
                        // Aggiungi i costi dei modificatori (Metà 1 e Metà 2)
                        if (item.modifiers1) {
                            modifierTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }
                        if (item.modifiers2) {
                            modifierTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                        }

                        // Il prezzo base dell'item è 0.00, quindi ritorna il costo del gusto più caro + i modificatori.
                        return maxGustoPrice + modifierTotal + basePrice; 
                    }

                    return basePrice + modifierTotal;
                },
                
                selectItem(index) {
                    this.selectedItemIndex = this.selectedItemIndex === index ? null : index;
                },
                
                handleItemClick(item) {
                    this.lastSelectedItem = item; // Per evidenziare nel menu
                    
                    // Gestione Articoli Speciali (Mezzo Metro / Pizza Metà)
                    if (item.isMeter) {
                        this.startMeterComposition(item);
                    } else if (item.isHalfPizza) {
                        this.startHalfPizzaComposition(item);
                    } else {
                        // Aggiunta normale
                        this.addItemToOrder(item);
                    }
                },
                addItemToOrder(item) {
                    const newItem = JSON.parse(JSON.stringify(item)); // Copia profonda
                    newItem.modifiers = []; // Inizializza array modificatori
                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; // Seleziona il nuovo elemento
                    this.saveData();
                },
                removeItem(index) {
                    if (confirm(`Sei sicuro di voler rimuovere l'articolo "${this.order[index].nome}"?`)) {
                        this.order.splice(index, 1);
                        this.selectedItemIndex = null;
                        this.saveData();
                    }
                },
                
                // Modificatori (Standard)
                addExtra(modifier) {
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo nel carrello.");
                        return;
                    }
                    
                    const item = this.order[this.selectedItemIndex];

                    // Non aggiungere modificatori standard a item composti (metri o metà pizza)
                    if (item.isMeter || item.isHalfPizza) {
                        alert("Aggiungi i modificatori per questo articolo tramite la modale di composizione o rimuovendo il modificatore nel carrello (clicca sull'item nel carrello).");
                        return;
                    }

                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.activeModCat; // Aggiunge categoria per visualizzazione
                    
                    if (!item.modifiers) {
                        item.modifiers = [];
                    }
                    
                    // Previene duplicati (solo per 'Senza', gli altri possono essere duplicati per somma costo)
                    if (this.activeModCat === 'Senza' && item.modifiers.some(mod => mod.nome === newMod.nome)) {
                        alert(`Il modificatore "Senza ${newMod.nome}" è già presente.`);
                        return;
                    }
                    
                    item.modifiers.push(newMod);
                    this.saveData();
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch(category) {
                        case 'Più': return '➕';
                        case 'Senza': return '⛔';
                        case 'Poco': return '⬇️';
                        case 'Abbondante': return '⬆️';
                        default: return '➡️';
                    }
                },

                // Modale Modifica Prezzo
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    const item = this.order[index];
                    this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    const index = this.tempPriceEditIndex;
                    if (index !== null && this.newPriceValue >= 0) {
                        this.order[index].manualPrice = this.newPriceValue;
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.saveData();
                        alert(`Prezzo di ${this.order[index].nome} aggiornato a €${this.newPriceValue.toFixed(2)}.`);
                    } else {
                         alert("Inserisci un prezzo valido.");
                    }
                },
                
                // --- Logica Modale Composizione Mezzo Metro/Schiacciata ---
                startMeterComposition(item) {
                    this.tempMeterItem = JSON.parse(JSON.stringify(item));
                    
                    // Assicura che ogni sezione abbia i modificatori inizializzati
                    this.tempMeterItem.sections.forEach(section => {
                        if (!section.modifiers) {
                            section.modifiers = [];
                        }
                        if (!section.gusto) {
                            section.gusto = '';
                        }
                    });

                    this.showMeterModal = true;
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Più';
                    this.modifierSearchTerm = '';
                },
                selectMeterGusto(secIndex, gustoName) {
                    this.tempMeterItem.sections[secIndex].gusto = gustoName;
                    this.gustoSearchTerm = '';
                },
                addMeterModifier(secIndex, modifier) {
                    const section = this.tempMeterItem.sections[secIndex];
                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.tempModCat;

                    if (!section.modifiers) section.modifiers = [];
                    section.modifiers.push(newMod);
                    this.modifierSearchTerm = ''; // Nasconde l'autocompletamento
                },
                removeMeterModifier(secIndex, modIndex) {
                    // Questa funzione è usata sia nella modale che nella vista carrello
                    if (this.showMeterModal) {
                        this.tempMeterItem.sections[secIndex].modifiers.splice(modIndex, 1);
                    } else {
                        // Rimuovi dal carrello attivo
                        this.order[this.selectedItemIndex].sections[secIndex].modifiers.splice(modIndex, 1);
                        this.saveData();
                    }
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                },
                addMeterToOrder() {
                    if (this.isMeterValid) {
                        const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                        finalItem.gustiList = finalItem.sections.map(s => s.gusto).join(' | '); // Riepilogo per la stampa
                        this.order.push(finalItem);
                        this.showMeterModal = false;
                        this.tempMeterItem = null;
                        this.selectedItemIndex = this.order.length - 1;
                        this.saveData();
                    } else {
                        alert("Assicurati di aver selezionato un gusto per tutte le sezioni.");
                    }
                },
                
                // --- Logica Modale Composizione Pizza a Metà ---
                startHalfPizzaComposition(item) {
                    this.tempHalfPizzaItem = JSON.parse(JSON.stringify(item));
                    
                    if (!this.tempHalfPizzaItem.gusto1) this.tempHalfPizzaItem.gusto1 = '';
                    if (!this.tempHalfPizzaItem.gusto2) this.tempHalfPizzaItem.gusto2 = '';
                    if (!this.tempHalfPizzaItem.modifiers1) this.tempHalfPizzaItem.modifiers1 = [];
                    if (!this.tempHalfPizzaItem.modifiers2) this.tempHalfPizzaItem.modifiers2 = [];

                    this.showHalfPizzaModal = true;
                    this.gustoSearchTerm = '';
                    this.tempModCat = 'Più';
                    this.modifierSearchTerm = '';
                },
                selectHalfPizzaGusto(halfNum, gustoName) {
                    if (halfNum === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                    } else {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                    }
                    this.gustoSearchTerm = '';
                },
                addHalfPizzaModifier(halfNum, modifier) {
                    const newMod = JSON.parse(JSON.stringify(modifier));
                    newMod.category = this.tempModCat;

                    if (halfNum === 1) {
                        this.tempHalfPizzaItem.modifiers1.push(newMod);
                    } else {
                        this.tempHalfPizzaItem.modifiers2.push(newMod);
                    }
                    this.modifierSearchTerm = '';
                },
                removeHalfPizzaModifier(halfNum, modIndex) {
                    // Questa funzione è usata sia nella modale che nella vista carrello
                    if (this.showHalfPizzaModal) {
                        if (halfNum === 1) this.tempHalfPizzaItem.modifiers1.splice(modIndex, 1);
                        else this.tempHalfPizzaItem.modifiers2.splice(modIndex, 1);
                    } else {
                        // Rimuovi dal carrello attivo
                        if (halfNum === 1) this.order[this.selectedItemIndex].modifiers1.splice(modIndex, 1);
                        else this.order[this.selectedItemIndex].modifiers2.splice(modIndex, 1);
                        this.saveData();
                    }
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                },
                addHalfPizzaToOrder() {
                    if (this.isHalfPizzaValid) {
                        const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                        this.order.push(finalItem);
                        this.showHalfPizzaModal = false;
                        this.tempHalfPizzaItem = null;
                        this.selectedItemIndex = this.order.length - 1;
                        this.saveData();
                    } else {
                        alert("Assicurati di aver selezionato un gusto per entrambe le metà.");
                    }
                },

                // --- Logica Modale Finalizza Ordine ---
                setInitialDates() {
                    this.date = this.getTodayDateString();
                    this.hour = this.getCurrentHourString();
                },
                openModal() {
                    if (this.order.length === 0) {
                        alert("Il carrello è vuoto!");
                        return;
                    }
                    // Resetta i dati specifici non collegati al carrello
                    this.mode = 'banco';
                    this.setInitialDates();
                    this.customer = '';
                    this.phone = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.town = '';
                    this.zoneName = '';
                    this.notes = '';
                    this.accontoRicevuto = 0;
                    
                    // Se siamo in modifica, carica i dati dell'ordine
                    if (this.editingOrderId !== null) {
                        const originalOrder = this.orders.find(o => o.id === this.editingOrderId);
                        if (originalOrder) {
                            this.mode = originalOrder.mode;
                            this.date = originalOrder.date;
                            this.hour = originalOrder.hour;
                            this.customer = originalOrder.customer;
                            this.phone = originalOrder.phone;
                            this.address = originalOrder.address;
                            this.streetNumber = originalOrder.streetNumber || '';
                            this.town = originalOrder.town || '';
                            this.zoneName = originalOrder.zone;
                            this.notes = originalOrder.notes;
                            this.accontoRicevuto = originalOrder.accontoRicevuto || 0;
                        }
                    }
                    
                    this.updateDeliveryCost();
                    this.updateCapacityWarning();
                    this.showModal = true;
                },
                selectMode(m) {
                    this.mode = m;
                },
                updateDeliveryCost() {
                    // Triggera l'aggiornamento del computed property 'deliveryCost'
                    // L'aggiornamento avviene tramite watch, ma questa funzione può essere chiamata manualmente
                    // per assicurare l'immediato calcolo del totale.
                    const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                    if (this.mode === 'consegna' && !zone) {
                        this.zoneName = ''; // Deseleziona se la zona non esiste più
                    }
                },
                filterCustomers() {
                    const term = this.customer.toLowerCase();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory
                        .filter(c => c.customer.toLowerCase().includes(term) || c.phone.includes(term))
                        .slice(0, 5);
                },
                loadCustomerData(customerData) {
                    this.customer = customerData.customer;
                    this.phone = customerData.phone;
                    this.address = customerData.address;
                    this.streetNumber = customerData.streetNumber || '';
                    this.town = customerData.town || '';
                    this.zoneName = customerData.zoneName || '';
                    this.updateDeliveryCost();
                    this.filteredCustomerSuggestions = [];
                },
                
                // Capacità Oraria
                getPizzasInInterval(targetTime, targetDate) {
                    const intervalMinutes = this.capacitySettings.intervalMinutes;
                    const startTime = new Date(`${targetDate}T${targetTime}:00`);
                    
                    // Calcola l'inizio e la fine dell'intervallo
                    const intervalStart = new Date(startTime);
                    intervalStart.setMinutes(intervalStart.getMinutes() - intervalMinutes);
                    const intervalEnd = startTime;
                    
                    let pizzaCount = 0;
                    
                    this.orders.forEach(order => {
                        const orderTime = new Date(`${order.date}T${order.hour}:00`);
                        
                        // Controlla se l'ordine è all'interno dell'intervallo (esclusa l'ora di inizio)
                        if (orderTime > intervalStart && orderTime <= intervalEnd) {
                            order.items.forEach(item => {
                                // Conta tutte le pizze, incluse Metà e Mezzo Metro
                                if (this.menu['Pizze'].some(p => p.nome === item.nome) || 
                                    item.isHalfPizza || item.isMeter) {
                                    pizzaCount++;
                                }
                            });
                        }
                    });
                    
                    return pizzaCount;
                },
                updateCapacityWarning() {
                    if (!this.date || !this.hour) return;
                    
                    // Contiamo quante pizze ci sono nel carrello corrente
                    const currentOrderPizzas = this.order.filter(item => 
                        this.menu['Pizze'].some(p => p.nome === item.nome) || 
                        item.isHalfPizza || item.isMeter
                    ).length;

                    // Calcola la capacità già occupata per l'intervallo selezionato, 
                    // ESCLUDENDO l'ordine che stiamo editando
                    let pizzasAlreadyScheduled = this.getPizzasInInterval(this.hour, this.date);

                    if (this.editingOrderId !== null) {
                        const existingOrder = this.orders.find(o => o.id === this.editingOrderId);
                        if (existingOrder && existingOrder.date === this.date && existingOrder.hour === this.hour) {
                            // Sottrai le pizze dell'ordine corrente se era già in quell'intervallo
                            existingOrder.items.forEach(item => {
                                if (this.menu['Pizze'].some(p => p.nome === item.nome) || item.isHalfPizza || item.isMeter) {
                                    pizzasAlreadyScheduled--;
                                }
                            });
                        }
                    }

                    // Totale pizze previste nell'intervallo
                    const totalPizzas = pizzasAlreadyScheduled + currentOrderPizzas;
                    
                    this.orderCapacity.total = totalPizzas;

                    // Calcola l'orario del prossimo intervallo per il suggerimento (se pieno)
                    const targetTime = new Date(`${this.date}T${this.hour}:00`);
                    const nextTime = new Date(targetTime);
                    nextTime.setMinutes(nextTime.getMinutes() + this.capacitySettings.intervalMinutes);
                    this.orderCapacity.nextInterval = nextTime.toTimeString().slice(0, 5);
                },

                confermaOrdine() {
                    if (this.orderCapacity.total > this.capacitySettings.maxPizzas) {
                        if (!confirm(`Capacità Oraria Superata! Hai ${this.orderCapacity.total} pizze nell'intervallo. Vuoi procedere comunque?`)) {
                            return;
                        }
                    }

                    // Costruisci l'oggetto Ordine
                    const newOrder = {
                        id: this.editingOrderId || Date.now(),
                        items: JSON.parse(JSON.stringify(this.order)),
                        mode: this.mode,
                        date: this.date,
                        hour: this.hour,
                        total: this.calculatedOrderTotal,
                        customer: (this.mode === 'asporto' || this.mode === 'consegna') ? this.customer : '',
                        phone: (this.mode === 'asporto' || this.mode === 'consegna') ? this.phone : '',
                        address: (this.mode === 'consegna') ? `${this.address}, ${this.streetNumber}, ${this.town}` : '',
                        streetNumber: (this.mode === 'consegna') ? this.streetNumber : '',
                        town: (this.mode === 'consegna') ? this.town : '',
                        zone: (this.mode === 'consegna') ? this.zoneName : '',
                        tableNumber: (this.mode === 'banco') ? this.tableNumber : '',
                        notes: this.notes,
                        status: 'Ricevuto',
                        driver: (this.mode === 'consegna') ? (this.drivers[0] || '') : '', // Assegna il primo fattorino di default
                        accontoRicevuto: this.accontoRicevuto,
                        restoDaDare: this.restoDaDare,
                        creationTime: Date.now(),
                    };
                    
                    // Salva la storia del cliente
                    if (newOrder.customer && newOrder.phone) {
                         const existingIndex = this.customerHistory.findIndex(c => c.customer === newOrder.customer && c.phone === newOrder.phone);
                         const customerData = {
                             customer: newOrder.customer, 
                             phone: newOrder.phone, 
                             address: newOrder.address, 
                             streetNumber: newOrder.streetNumber,
                             town: newOrder.town,
                             zoneName: newOrder.zone
                         };

                         if (existingIndex !== -1) {
                            // Aggiorna i dati esistenti
                            this.customerHistory[existingIndex] = customerData;
                         } else {
                            this.customerHistory.push(customerData);
                         }
                    }


                    if (this.editingOrderId !== null) {
                        // Modifica Ordine Esistente
                        const index = this.orders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.orders[index] = { ...this.orders[index], ...newOrder }; // Mantiene status e creationTime
                        }
                        alert(`Ordine #${this.editingOrderId} modificato con successo.`);
                        this.editingOrderId = null; // Fine modalità modifica
                    } else {
                        // Nuovo Ordine
                        this.orders.push(newOrder);
                        alert(`Ordine #${newOrder.id} salvato con successo.`);
                    }

                    // Reset
                    this.order = [];
                    this.showModal = false;
                    this.selectedItemIndex = null;
                    this.saveData();
                    this.view = 'ordini';
                    this.updateCapacityWarning(); // Aggiorna la capacità dopo l'aggiunta
                },
                cancelEdit() {
                    if (confirm("Sei sicuro di voler annullare la modifica? Il carrello verrà svuotato e l'ordine originale resterà invariato.")) {
                        this.order = [];
                        this.editingOrderId = null;
                        this.view = 'ordini';
                        this.saveData();
                    }
                },
                
                // --- Logica Ordini Attivi ---
                getNextStatus(currentStatus) {
                    switch (currentStatus) {
                        case 'Ricevuto': return 'In Preparazione';
                        case 'In Preparazione': return 'Pronto';
                        case 'Pronto': return 'In Consegna';
                        case 'In Consegna': return 'Archivia';
                        case 'Archivia': return 'Archivia'; // Lo stato finale rimane 'Archivia'
                        default: return 'Archivia';
                    }
                },
                advance(order) {
                    const nextStatus = this.getNextStatus(order.status);
                    
                    if (nextStatus === 'Archivia') {
                        // L'ordine è completo, spostalo in archivio
                        this.archiveOrder(order);
                    } else {
                        // Avanza di stato
                        order.status = nextStatus;
                        this.saveData();
                    }
                },
                archiveOrder(order) {
                    if (confirm(`Confermi l'archiviazione e la chiusura dell'Ordine #${order.id}?`)) {
                        const archived = { 
                            ...order, 
                            archivedTime: Date.now(),
                            status: 'Archiviato'
                        };
                        this.archive.push(archived);
                        this.orders = this.orders.filter(o => o.id !== order.id);
                        this.saveData();
                        this.calculateDriverStats(); // Aggiorna le statistiche
                    }
                },
                editOrder(id) {
                    const orderToEdit = this.orders.find(o => o.id === id);
                    if (orderToEdit) {
                        // Carica i dati dell'ordine nel carrello
                        this.order = JSON.parse(JSON.stringify(orderToEdit.items));
                        this.editingOrderId = id;
                        this.view = 'inserimento';
                        this.selectedItemIndex = null;
                        this.saveData();
                    }
                },
                duplicateOrder(order) {
                    if (confirm(`Sei sicuro di voler duplicare l'Ordine #${order.id} in un nuovo ordine attivo?`)) {
                        const newOrder = JSON.parse(JSON.stringify(order));
                        newOrder.id = Date.now(); // Nuovo ID
                        newOrder.status = 'Ricevuto'; // Nuovo stato iniziale
                        newOrder.creationTime = Date.now();
                        newOrder.archivedTime = undefined; // Rimuovi il tempo di archiviazione
                        
                        // Per il carrello corrente (non attivo)
                        this.order = newOrder.items;
                        this.editingOrderId = null;
                        this.view = 'inserimento';
                        
                        // Inizializza i dati della modale Finalizza
                        this.mode = newOrder.mode;
                        this.date = newOrder.date;
                        this.hour = newOrder.hour;
                        this.customer = newOrder.customer;
                        this.phone = newOrder.phone;
                        this.address = newOrder.address;
                        this.streetNumber = newOrder.streetNumber || '';
                        this.town = newOrder.town || '';
                        this.zoneName = newOrder.zone;
                        this.notes = newOrder.notes;
                        this.accontoRicevuto = newOrder.accontoRicevuto || 0;
                        
                        this.saveData();
                        
                        // Ti porta alla vista Inserimento con il carrello pronto per la finalizzazione
                        this.openModal(); 
                    }
                },
                updateActiveOrderDriver(id, driverName) {
                    const order = this.orders.find(o => o.id === id);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                    }
                },

                // Avvisi Temporali
                isFutureOrder(order) {
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    return orderTime > now;
                },
                isNear(order) {
                    if (!this.isFutureOrder(order)) return false;
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    const diffMinutes = (orderTime.getTime() - now.getTime()) / 60000;
                    return diffMinutes > 5 && diffMinutes <= 15;
                },
                isUrgent(order) {
                    if (!this.isFutureOrder(order)) return false;
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    const diffMinutes = (orderTime.getTime() - now.getTime()) / 60000;
                    return diffMinutes <= 5;
                },

                // --- Logica Stampa e Condivisione ---
                printOrder(id, type) {
                    const order = this.orders.find(o => o.id === id) || this.archive.find(o => o.id === id);
                    if (!order) return alert("Ordine non trovato.");
                    
                    const printContainer = document.getElementById(`print-content-${type}`);
                    if (!printContainer) return alert("Contenitore di stampa non trovato.");

                    printContainer.innerHTML = type === 'comanda' ? this.generateComanda(order) : this.generateScontrino(order);

                    // Usa l'API standard per la stampa
                    window.print();
                    
                    // Pulizia post-stampa (necessaria per nascondere i container)
                    nextTick(() => {
                        printContainer.innerHTML = '';
                    });
                },
                generateComanda(order) {
                    let html = `
                        <h1>COMANDA PIZZERIA SMART</h1>
                        <h2>Ordine #${order.id} | ${order.mode.toUpperCase()}</h2>
                        <p><strong>Ritiro/Cons. Ora:</strong> ${order.hour} (${this.formatDate(order.date)})</p>
                        <p><strong>Cliente:</strong> ${order.customer || order.tableNumber || 'N/D'}</p>
                    `;
                    if (order.mode === 'consegna') {
                        html += `<p><strong>Indirizzo:</strong> ${order.address} (${order.zone})</p>`;
                        html += `<p><strong>Telefono:</strong> ${order.phone || 'N/D'}</p>`;
                        html += `<p><strong>Fattorino:</strong> ${order.driver || 'N/A'}</p>`;
                    }
                    html += `<p><strong>Note:</strong> ${order.notes || 'Nessuna'}</p>`;
                    html += `<h2>Dettaglio Articoli:</h2><ul>`;
                    
                    order.items.forEach(item => {
                        html += `<li>`;
                        html += `<span class="item-name">1x ${item.nome}</span>`;
                        
                        // Modificatori Standard
                        if (item.modifiers && item.modifiers.length > 0 && !item.isHalfPizza && !item.isMeter) {
                            html += `<ul class="mod-list">`;
                            item.modifiers.forEach(mod => {
                                html += `<li>${this.getModifierIcon(mod.category)} ${mod.nome}</li>`;
                            });
                            html += `</ul>`;
                        }

                        // Pizza a Metà
                        if (item.isHalfPizza) {
                            html += `<ul class="mod-list">`;
                            html += `<li>** Metà 1: ${item.gusto1} **</li>`;
                            item.modifiers1?.forEach(mod => { html += `<li>&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            html += `<li>** Metà 2: ${item.gusto2} **</li>`;
                            item.modifiers2?.forEach(mod => { html += `<li>&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            html += `</ul>`;
                        }

                        // Mezzo Metro / Schiacciata
                        if (item.isMeter) {
                            html += `<ul class="mod-list">`;
                            item.sections.forEach(section => {
                                html += `<li>** ${section.name}: ${section.gusto} **</li>`;
                                section.modifiers?.forEach(mod => { html += `<li>&nbsp;&nbsp;&nbsp;&nbsp;${this.getModifierIcon(mod.category)} ${mod.nome}</li>`; });
                            });
                            html += `</ul>`;
                        }

                        html += `</li>`;
                    });
                    
                    html += `</ul>`;
                    html += `<p class="note" style="margin-top: 20px;">Totale Incasso: €${order.total.toFixed(2)}</p>`;
                    return html;
                },
                generateScontrino(order) {
                    let html = `
                        <h1>PIZZERIA SMART</h1>
                        <p style="text-align: center; margin-bottom: 10px;">Ordine #${order.id} | ${order.mode.toUpperCase()}</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Descrizione</th>
                                    <th style="text-align: right;">Prezzo</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    order.items.forEach(item => {
                        const itemTotal = this.calculateItemTotal(item);
                        
                        // Linea principale dell'articolo
                        html += `<tr><td>1x ${item.nome} 
                            <span style="font-size: 0.8rem;">
                                <span v-if="item.isHalfPizza">(${item.gusto1}/${item.gusto2})</span>
                                <span v-if="item.isMeter">(${item.sections.length} gusti)</span>
                            </span>
                        </td><td style="text-align: right;">${itemTotal.toFixed(2)}</td></tr>`;
                        
                        // Dettagli gusti/modificatori per pizze composte e costo extra modificatori
                        if (item.isHalfPizza) {
                            // Non stampa i gusti a meno che non si vogliano i dettagli completi, stampa solo i modificatori a pagamento
                            let totalModPrice = 0;
                            
                            // Modificatori Metà 1
                            item.modifiers1?.forEach(mod => {
                                if(mod.prezzo > 0) {
                                    html += `<tr><td style="padding-left: 10px; font-size: 0.9em;">+ ${mod.nome}</td><td style="text-align: right; font-size: 0.9em;">${mod.prezzo.toFixed(2)}</td></tr>`;
                                    totalModPrice += mod.prezzo;
                                }
                            });
                            // Modificatori Metà 2
                            item.modifiers2?.forEach(mod => {
                                if(mod.prezzo > 0) {
                                    html += `<tr><td style="padding-left: 10px; font-size: 0.9em;">+ ${mod.nome}</td><td style="text-align: right; font-size: 0.9em;">${mod.prezzo.toFixed(2)}</td></tr>`;
                                    totalModPrice += mod.prezzo;
                                }
                            });
                            
                        } else if (item.isMeter) {
                            let totalModPrice = 0;
                            item.sections.forEach(section => {
                                // Opzionale: stampa i gusti
                                html += `<tr><td style="padding-left: 5px; font-size: 0.9em;">Gusto: ${section.gusto}</td><td></td></tr>`;

                                section.modifiers?.forEach(mod => {
                                    if(mod.prezzo > 0) {
                                        html += `<tr><td style="padding-left: 10px; font-size: 0.9em;">+ ${mod.nome}</td><td style="text-align: right; font-size: 0.9em;">${mod.prezzo.toFixed(2)}</td></tr>`;
                                        totalModPrice += mod.prezzo;
                                    }
                                });
                            });
                            
                        } else if (item.modifiers) {
                            // Modificatori standard
                             item.modifiers.forEach(mod => {
                                if(mod.prezzo > 0) {
                                    html += `<tr><td style="padding-left: 10px; font-size: 0.9em;">+ ${mod.nome}</td><td style="text-align: right; font-size: 0.9em;">${mod.prezzo.toFixed(2)}</td></tr>`;
                                }
                            });
                        }
                    });

                    // Costo Consegna (se presente)
                    if (order.mode === 'consegna' && order.zone && order.zone !== 'Nessuna') {
                        const zone = this.deliveryZones.find(z => z.name === order.zone);
                        if (zone && zone.price > 0) {
                            html += `<tr class="total-row"><td>Consegna (${order.zone})</td><td style="text-align: right;">${zone.price.toFixed(2)}</td></tr>`;
                        }
                    }

                    // Totale
                    html += `
                            </tbody>
                        </table>
                        <table style="margin-top: 10px;">
                            <tr class="total-row">
                                <td>TOTALE ORDINE</td>
                                <td style="text-align: right;">€${order.total.toFixed(2)}</td>
                            </tr>
                        </table>
                    `;
                    
                    // Dettagli Ritiro/Consegna
                    html += `
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            <strong>Ora Ritiro/Cons:</strong> ${order.hour}
                        </p>
                    `;

                    // Dettagli Resto
                    if (order.accontoRicevuto > 0) {
                        html += `
                            <p style="font-size: 0.9em;">
                                <strong>Ricevuto:</strong> €${order.accontoRicevuto.toFixed(2)}
                            </p>
                            <p style="font-weight: bold; font-size: 1.1em; color: #e31b23;">
                                RESTO DA DARE: €${order.restoDaDare.toFixed(2)}
                            </p>
                        `;
                    }

                    html += `<p style="text-align: center; margin-top: 20px; font-size: 0.9em;">Grazie per l'ordine!</p>`;
                    return html;
                },
                showShareMenu(id) {
                    this.selectedOrderForShare = this.orders.find(o => o.id === id);
                    if (this.selectedOrderForShare) {
                        this.showShareModal = true;
                    }
                },
                shareViaWhatsapp(order) {
                    const orderSummary = this.generateOrderSummary(order);
                    const whatsappLink = `https://wa.me/${order.phone}?text=${encodeURIComponent(orderSummary)}`;
                    
                    if (order.phone) {
                        window.open(whatsappLink, '_blank');
                    } else {
                        alert("Telefono del cliente non disponibile. Copia il testo e incollalo manualmente.");
                        navigator.clipboard.writeText(orderSummary);
                    }
                    this.showShareModal = false;
                },
                generateOrderSummary(order) {
                    let summary = `*Riepilogo Ordine #${order.id}* - Pizzeria Smart\n\n`;
                    summary += `Modalità: ${order.mode.toUpperCase()}\n`;
                    summary += `Ora Ritiro/Consegna: *${order.hour}* (${this.formatDate(order.date)})\n`;
                    summary += `Cliente: ${order.customer || 'N/D'}\n`;
                    if (order.mode === 'consegna') {
                        summary += `Indirizzo: ${order.address} (${order.zone})\n`;
                    }
                    if (order.notes) {
                        summary += `Note: ${order.notes}\n`;
                    }
                    summary += `\n*Dettaglio Articoli:*\n`;
                    
                    order.items.forEach(item => {
                        summary += `\n➡️ 1x ${item.nome} *€${this.calculateItemTotal(item).toFixed(2)}*`;
                        
                        // Metà/Metro
                        if (item.isHalfPizza) {
                            summary += ` (${item.gusto1} / ${item.gusto2})`;
                        }
                        if (item.isMeter) {
                            summary += ` (${item.sections.map(s => s.gusto).join(' / ')})`;
                        }

                        // Modificatori (solo quelli con prezzo)
                        const allModifiers = [
                            ...(item.modifiers || []),
                            ...(item.modifiers1 || []),
                            ...(item.modifiers2 || []),
                            ...(item.sections ? item.sections.flatMap(s => s.modifiers || []) : [])
                        ];

                        const paidMods = allModifiers.filter(mod => mod.prezzo > 0);
                        const freeMods = allModifiers.filter(mod => mod.prezzo === 0);
                        
                        if (paidMods.length > 0) {
                            summary += ` (+€${paidMods.reduce((sum, mod) => sum + mod.prezzo, 0).toFixed(2)})`;
                        }
                        
                        // Modificatori gratuiti/senza costo
                        if (freeMods.length > 0) {
                            summary += `\n   - Modifiche: ${freeMods.map(m => m.nome).join(', ')}`;
                        }
                    });
                    
                    summary += `\n\n*TOTALE DA PAGARE: €${order.total.toFixed(2)}*`;
                    
                    if (order.restoDaDare > 0) {
                        summary += `\n(Anticipo Versato: €${order.accontoRicevuto.toFixed(2)}. Resto da Dare: *€${order.restoDaDare.toFixed(2)}*)`;
                    }

                    return summary;
                },

                // --- Logica Storico e Statistiche ---
                calculateDriverStats() {
                    const date = this.archiveDateFilter;
                    const driverName = this.selectedDriver;
                    let totalOrders = 0;
                    let totalRevenue = 0;

                    this.archive.forEach(order => {
                        if (order.date === date && order.mode === 'consegna') {
                            if (!driverName || order.driver === driverName) {
                                totalOrders++;
                                totalRevenue += order.total;
                            }
                        }
                    });

                    this.driverStats = { totalOrders, totalRevenue };
                },
                updateArchiveDriver(id, driverName) {
                    const order = this.archive.find(o => o.id === id);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                        this.calculateDriverStats(); // Ricalcola le statistiche
                    }
                },

                // --- Logica Impostazioni (Menu/Modificatori/Zone) ---
                addCategory() {
                    const name = this.newCategoryName.trim();
                    if (name && !this.menu[name]) {
                        this.menu[name] = [];
                        this.activeSettingsCat = name;
                        this.newCategoryName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Categoria già esistente!");
                    }
                },
                deleteCategory(cat) {
                    if (cat === 'Pizze') {
                        alert("Non è possibile eliminare la categoria 'Pizze'.");
                        return;
                    }
                    if (this.menu[cat].length > 0) {
                        alert("Svuota prima la categoria per eliminarla.");
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria "${cat}"?`)) {
                        delete this.menu[cat];
                        this.activeSettingsCat = 'Pizze';
                        this.saveData();
                    }
                },
                addItemToCategory() {
                    const cat = this.activeSettingsCat;
                    const name = this.newItemName.trim();
                    const price = parseFloat(this.newItemPrice);

                    if (name && price >= 0) {
                        const existing = this.menu[cat].some(item => item.nome.toLowerCase() === name.toLowerCase());
                        if (existing) {
                            alert("Articolo già esistente in questa categoria!");
                            return;
                        }
                        
                        let newItem = { nome: name, prezzo: price };
                        
                        // --- LOGICA CORRETTA PER ARTICOLI SPECIALI ---
                        const lowerCat = cat.toLowerCase();
                        if (lowerCat.includes("pizza metà") || lowerCat.includes("metà pizza")) {
                            newItem.isHalfPizza = true;
                        } 
                        else if (lowerCat.includes("mezzo metro") || lowerCat.includes("schiacciata grande")) {
                            newItem.isMeter = true;
                            // Definisce sezioni di default
                            if (name.toLowerCase().includes("due") || lowerCat.includes("due")) {
                                newItem.sections = [{name:"Metà A", size:0.5}, {name:"Metà B", size:0.5}];
                            } else if (name.toLowerCase().includes("tre") || lowerCat.includes("tre")) {
                                newItem.sections = [{name:"Terzo 1", size:0.33}, {name:"Terzo 2", size:0.33}, {name:"Terzo 3", size:0.33}];
                            } else { // "Intero" o altro
                                newItem.sections = [{name:"Gusto Unico", size:1}];
                            }
                        }
                        // --- FINE LOGICA ARTICOLI SPECIALI ---

                        this.menu[cat].push(newItem);
                        this.newItemName = '';
                        this.newItemPrice = 0;
                        this.saveData();
                    }
                },
                deleteItem(cat, index) {
                    if (confirm(`Sei sicuro di voler eliminare l'articolo "${this.menu[cat][index].nome}"?`)) {
                        this.menu[cat].splice(index, 1);
                        this.saveData();
                    }
                },
                toggleItemFinished(cat, index) {
                    const item = this.menu[cat][index];
                    item.isFinished = !item.isFinished;
                    this.saveData();
                    // Assicurarsi che l'item non sia nel carrello se viene marcato come finito.
                    this.order = this.order.filter(o => o.nome !== item.nome);
                    this.selectedItemIndex = null;
                },

                // Modificatori
                isDefaultModifierCategory(cat) {
                    return ['Più', 'Senza', 'Poco', 'Abbondante'].includes(cat);
                },
                addModifierCategory() {
                    const name = this.newModifierCategoryName.trim();
                    if (name && !this.modifiers[name]) {
                        this.modifiers[name] = [];
                        this.activeSettingsModCat = name;
                        this.newModifierCategoryName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Categoria modificatori già esistente!");
                    }
                },
                deleteModifierCategory(cat) {
                    if (this.isDefaultModifierCategory(cat)) {
                        alert("Non è possibile eliminare le categorie modificatori di default.");
                        return;
                    }
                     if (this.modifiers[cat].length > 0) {
                        alert("Svuota prima la categoria per eliminarla.");
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria modificatori "${cat}"?`)) {
                        delete this.modifiers[cat];
                        this.activeSettingsModCat = 'Più';
                        this.saveData();
                    }
                },
                addModifierToCategory() {
                    const cat = this.activeSettingsModCat;
                    const name = this.newModifierName.trim();
                    const price = parseFloat(this.newModifierPrice);

                    if (name && price >= 0) {
                        const existing = this.modifiers[cat].some(mod => mod.nome.toLowerCase() === name.toLowerCase());
                        if (existing) {
                            alert("Modificatore già esistente in questa categoria!");
                            return;
                        }
                        this.modifiers[cat].push({ nome: name, prezzo: price });
                        this.newModifierName = '';
                        this.newModifierPrice = 0;
                        this.saveData();
                    }
                },
                deleteModifier(cat, index) {
                    if (confirm(`Sei sicuro di voler eliminare il modificatore "${this.modifiers[cat][index].nome}"?`)) {
                        this.modifiers[cat].splice(index, 1);
                        this.saveData();
                    }
                },
                toggleModifierFinished(cat, index) {
                    const mod = this.modifiers[cat][index];
                    mod.isFinished = !mod.isFinished;
                    this.saveData();
                    // Non è necessario rimuoverlo dagli ordini attivi, ma non sarà più selezionabile
                },

                // Zone e Fattorini
                addZone() {
                    const name = this.newZoneName.trim();
                    const price = parseFloat(this.newZonePrice);
                    if (name && price >= 0 && !this.deliveryZones.some(z => z.name === name)) {
                        this.deliveryZones.push({ name, price });
                        this.newZoneName = '';
                        this.newZonePrice = 0;
                        this.saveData();
                    } else if (name) {
                        alert("Zona già esistente o dati non validi.");
                    }
                },
                deleteZone(index) {
                    if (confirm(`Sei sicuro di voler eliminare la zona "${this.deliveryZones[index].name}"?`)) {
                        this.deliveryZones.splice(index, 1);
                        this.saveData();
                    }
                },
                addDriver() {
                    const name = this.newDriverName.trim();
                    if (name && !this.drivers.includes(name)) {
                        this.drivers.push(name);
                        this.newDriverName = '';
                        this.saveData();
                    } else if (name) {
                        alert("Fattorino già esistente.");
                    }
                },
                deleteDriver(index) {
                    if (confirm(`Sei sicuro di voler eliminare il fattorino "${this.drivers[index]}"?`)) {
                        this.drivers.splice(index, 1);
                        this.saveData();
                        this.calculateDriverStats(); // Ricalcola le statistiche
                    }
                },
            }
        });
        app.mount('#app');
    </script>
</body>
</html>
