<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart – Gestionale</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
            color: #333;
        }

        #app {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1 {
            color: #007bff;
            text-align: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h2 {
            color: #555;
            margin-top: 30px;
            border-left: 5px solid #007bff;
            padding-left: 10px;
            margin-bottom: 15px;
        }

        h3 {
            color: #007bff;
            margin-top: 20px;
        }

        h4 {
            color: #6c757d;
            margin-top: 15px;
        }

        /* Nav Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            padding: 0;
            list-style: none;
        }

        .tab-item {
            cursor: pointer;
            padding: 10px 20px;
            margin: 0 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: all 0.3s;
            background-color: #f8f9fa;
        }

        .tab-item.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }

        /* Input and Forms */
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Buttons */
        button {
            padding: 10px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #1e7e34;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #bd2130;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #117a8b;
        }

        /* Flex Utilities */
        .flex-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .flex-half {
            flex: 1;
        }

        .menu-list, .order-list, .inventory-list, .driver-list, .category-list, .product-list, .modifier-category-list, .modifier-list, .zone-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }

        .menu-item, .order-item, .inventory-item, .driver-item, .category-item, .product-item, .modifier-category-item, .modifier-item, .zone-item {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inventory-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .inventory-item-details {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .inventory-item-actions {
            width: 100%;
            display: flex;
            gap: 10px;
            align-items: center;
            padding-top: 10px;
            border-top: 1px dotted #ccc;
        }

        .order-details ul, .order-details li {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .order-details li {
            margin-bottom: 5px;
        }

        .pizza-types-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pizza-type-box {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pizza-type-box.active {
            background-color: #ffeeba; /* Light yellow for selection */
            border-color: #ffc107;
            font-weight: bold;
        }

        .product-card {
            background-color: #e9ecef;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .product-card.finished {
            background-color: #f8d7da; /* Light red for finished items */
            opacity: 0.6;
            cursor: not-allowed;
        }

        .product-card:not(.finished):hover {
            background-color: #d1d8df;
        }

        .current-order-list li {
            background-color: #e9f7ef;
            border: 1px solid #c3e6cb;
            margin-bottom: 5px;
            padding: 10px;
            border-radius: 5px;
            position: relative;
        }

        .current-order-list li.selected-item {
            border: 2px solid #007bff;
            background-color: #e0f7ff;
        }

        .item-modifiers li {
            margin-left: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }

        .item-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .order-status-in-prep {
            color: #ffc107; /* Warning yellow */
            font-weight: bold;
        }

        .order-status-ready {
            color: #28a745; /* Success green */
            font-weight: bold;
        }

        .order-status-delivered {
            color: #17a2b8; /* Info blue */
            font-weight: bold;
        }
        .order-status-archived {
            color: #6c757d; /* Secondary gray */
            font-weight: bold;
        }
        .finished-badge {
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 10px;
        }
    </style>
</head>
<body>

    <div id="app">
        <h1>Pizzeria Smart – Gestionale</h1>

        <ul class="tabs">
            <li class="tab-item" :class="{ active: activeTab === 'inserimento' }" @click="activeTab = 'inserimento'">Inserimento Ordini</li>
            <li class="tab-item" :class="{ active: activeTab === 'ordini' }" @click="activeTab = 'ordini'">Ordini Attivi</li>
            <li class="tab-item" :class="{ active: activeTab === 'storico' }" @click="activeTab = 'storico'">Storico/Statistiche</li>
            <li class="tab-item" :class="{ active: activeTab === 'magazzino' }" @click="activeTab = 'magazzino'">Magazzino</li>
            <li class="tab-item" :class="{ active: activeTab === 'impostazioni' }" @click="activeTab = 'impostazioni'">Impostazioni</li>
        </ul>

        <div v-if="activeTab === 'inserimento'" class="flex-container">
            <div class="flex-half">
                <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Crea Nuovo Ordine' }}</h2>

                <div v-if="selectedProduct && (selectedProduct.isMeter || selectedProduct.isHalfPizza)">
                    <button class="btn-warning" @click="openComposer(selectedProduct)">Componi {{ selectedProduct.nome }}</button>
                    <button class="btn-secondary" @click="resetCurrentProduct">Annulla Selezione</button>
                </div>

                <div v-else>
                    <ul class="menu-list">
                        <li v-for="cat in menuData.categories" :key="cat" class="category-item">
                            <h3>{{ cat.toUpperCase() }}</h3>
                            <div class="product-list">
                                <div v-for="p in getProductsByCategory(cat)" :key="p.nome" class="product-card"
                                    :class="{ 'finished': p.isFinished }"
                                    @click="!p.isFinished && selectProduct(p)">
                                    <div style="display: flex; align-items: center;">
                                        <strong>{{p.nome}}</strong>
                                        <span v-if="p.isFinished" class="finished-badge">FINITO</span>
                                    </div>
                                    <span>€{{(p.isMeter || p.isHalfPizza ? 'COMPOSTO' : p.prezzo.toFixed(2))}}</span>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div v-if="selectedProduct && !selectedProduct.isMeter && !selectedProduct.isHalfPizza && selectedItemIndex === null">
                    <h3>Modificatori per {{ selectedProduct.nome }}</h3>
                    <div v-for="cat in menuData.modifierCategories" :key="'modcat-' + cat" style="margin-bottom: 10px;">
                        <h4>{{ cat }}</h4>
                        <div class="product-list">
                            <div v-for="m in getModifiersByCategory(cat)" :key="m.nome" class="product-card" @click="addModifierToTempItem(m)">
                                <strong>{{m.nome}}</strong>
                                <span>+€{{m.prezzo.toFixed(2)}}</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn-success" @click="addItemToOrder">Aggiungi {{ selectedProduct.nome }} all'Ordine</button>
                    <button class="btn-secondary" @click="resetCurrentProduct">Annulla</button>
                </div>
            </div>

            <div class="flex-half">
                <h3>Ordine Corrente</h3>

                <ul class="current-order-list">
                    <li v-for="(i, index) in order" :key="index"
                        :class="{'selected-item': selectedItemIndex === index}"
                        @click="selectItemForEditing(index)">
                        <span v-if="!i.isHalfPizza && !i.isMeter">
                            {{ i.nome }}
                        </span>

                        <span v-else-if="i.isHalfPizza">
                            🍕 {{i.nome}} ({{i.gusto1}} / {{i.gusto2}})
                        </span>

                        <span v-else-if="i.isMeter">
                            🍕 {{i.nome}} ({{i.sections.length}} Gusti)
                        </span>

                        <div style="float: right;">
                            €{{calculateItemTotal(i).toFixed(2)}}
                            <button class="btn-danger" style="margin-left: 10px; padding: 5px 10px;" @click.stop="removeItemFromOrder(index)">✖️</button>
                        </div>

                        <ul class="item-modifiers">
                            <li v-for="mod in i.modifiers" :key="mod.nome">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})
                            </li>
                            <template v-if="i.isHalfPizza">
                                <li>
                                    <strong>Metà 1 ({{ i.gusto1 }})</strong>
                                    <ul class="item-modifiers">
                                        <li v-for="mod in i.modifiers1" :key="'mod1-' + mod.nome">
                                            {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                            {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <strong>Metà 2 ({{ i.gusto2 }})</strong>
                                    <ul class="item-modifiers">
                                        <li v-for="mod in i.modifiers2" :key="'mod2-' + mod.nome">
                                            {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                            {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})
                                        </li>
                                    </ul>
                                </li>
                            </template>
                            <template v-if="i.isMeter">
                                <li v-for="(section, secIdx) in i.sections" :key="'sec-' + secIdx">
                                    <strong>{{ section.name }}</strong>: {{ section.gusto }}
                                    <span v-if="section.modifiers.length > 0">
                                        ({{ section.modifiers.length }} Modifiche)
                                    </span>
                                </li>
                            </template>
                        </ul>
                    </li>
                </ul>

                <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee;">
                    **Totale Ordine:** €{{calculatedOrderTotal.toFixed(2)}} <br>
                    <span v-if="deliveryCost > 0">
                        **Costo Consegna:** +€{{deliveryCost.toFixed(2)}} ({{zoneName}})
                        <br>
                    </span>
                    **TOTALE COMPLESSIVO:** €{{total.toFixed(2)}}
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn-success" @click="openFinalizeOrderModal" :disabled="order.length === 0">
                        {{ editingOrderId ? 'Aggiorna Ordine #' + editingOrderId : 'Finalizza Ordine' }}
                    </button>
                    <button v-if="editingOrderId" class="btn-secondary" @click="cancelOrderEdit">Annulla Modifica</button>
                </div>
            </div>
        </div>

        <div v-else-if="activeTab === 'ordini'">
            <h2>Ordini Attivi</h2>

            <div style="margin-bottom: 20px;">
                <button :class="{ 'btn-primary': activeOrderFilter === 'Tutti', 'btn-secondary': activeOrderFilter !== 'Tutti' }" @click="activeOrderFilter = 'Tutti'">Tutti</button>
                <button :class="{ 'btn-primary': activeOrderFilter === 'In Prep.', 'btn-secondary': activeOrderFilter !== 'In Prep.' }" @click="activeOrderFilter = 'In Prep.'">In Prep.</button>
                <button :class="{ 'btn-primary': activeOrderFilter === 'Pronto', 'btn-secondary': activeOrderFilter !== 'Pronto' }" @click="activeOrderFilter = 'Pronto'">Pronto</button>
                <button :class="{ 'btn-primary': activeOrderFilter === 'Archiviati', 'btn-secondary': activeOrderFilter !== 'Archiviati' }" @click="activeOrderFilter = 'Archiviati'">Archiviati</button>
            </div>

            <ul class="order-list">
                <li v-if="filteredOrders.length === 0">Nessun ordine attivo con il filtro selezionato.</li>

                <li v-for="o in filteredOrders" :key="o.id" class="order-item" style="display: block;">
                    <h4>
                        #{{o.id}} – {{o.mode.toUpperCase()}}
                        <span :class="'order-status-' + o.status.toLowerCase().replace(' ', '-')">{{o.status}}</span>
                    </h4>
                    <p v-if="o.tableNumber">Tavolo/Ritiro: **{{o.tableNumber}}**</p>

                    <p>
                        **Cliente: {{o.customer}}**<br>
                        Data: **{{ formatDate(o.date) }}** | Ritiro/Consegna: **{{o.hour}}**<br>
                        <span v-if="o.driver">Fattorino Assegnato: **{{o.driver}}**</span>
                    </p>

                    <p v-if="o.phone">📞 {{o.phone}}</p>
                    <p v-if="o.address">
                        📍 {{o.address}} {{o.streetNumber}}, **{{o.zone}}** ({{o.town}})<br>
                        <span v-if="o.deliveryCost > 0">Costo Consegna: €{{o.deliveryCost.toFixed(2)}}</span>
                    </p>

                    <p v-if="o.notes">**Note:** {{o.notes}}</p>

                    <ul style="padding-left: 20px;">
                        <li v-for="it in o.items" :key="it.id">
                            <span v-if="it.isHalfPizza">🍕 {{it.nome}} ({{it.gusto1}} / {{it.gusto2}})</span>
                            <span v-else-if="it.isMeter">🍕 {{it.nome}}</span>
                            <span v-else>{{ it.nome }}</span>
                            – €{{ calculateItemTotal(it).toFixed(2) }}
                            <ul class="item-modifiers">
                                <template v-if="it.isHalfPizza">
                                    <li>**Metà 1: {{ it.gusto1 }}**
                                        <ul v-if="it.modifiers1.length > 0">
                                            <li v-for="mod in it.modifiers1" :key="'mod1-' + mod.nome">{{ getModifierIcon(getModifierCategory(mod.nome)) }} * {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})</li>
                                        </ul>
                                    </li>
                                    <li>**Metà 2: {{ it.gusto2 }}**
                                        <ul v-if="it.modifiers2.length > 0">
                                            <li v-for="mod in it.modifiers2" :key="'mod2-' + mod.nome">{{ getModifierIcon(getModifierCategory(mod.nome)) }} * {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})</li>
                                        </ul>
                                    </li>
                                </template>
                                <template v-if="it.isMeter">
                                    <li v-for="sec in it.sections" :key="'sec-disp-' + sec.name">
                                        **{{ sec.name }}:** {{ sec.gusto }}
                                        <ul v-if="sec.modifiers.length > 0">
                                            <li v-for="mod in sec.modifiers" :key="'mod-sec-' + mod.nome">{{ getModifierIcon(getModifierCategory(mod.nome)) }} * {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})</li>
                                        </ul>
                                    </li>
                                </template>
                                <li v-for="mod in it.modifiers" :key="mod.nome">{{ getModifierIcon(getModifierCategory(mod.nome)) }} * {{mod.nome}} (+€{{mod.prezzo.toFixed(2)}})</li>
                            </ul>
                        </li>
                    </ul>

                    **Totale: €{{o.total.toFixed(2)}}**

                    <div class="item-actions">
                        <button class="btn-info" @click="editOrder(o.id)">Modifica</button>
                        <button class="btn-warning" @click="advanceOrderStatus(o.id)" v-if="o.status !== 'Archiviato'">Avanza Stato</button>
                        <button class="btn-secondary" @click="duplicateOrder(o)">Duplica</button>
                        <button class="btn-info" @click="openShareModal(o.id)">Azioni</button>
                        <button class="btn-danger" @click="deleteOrder(o.id)" v-if="o.status !== 'Archiviato'">Elimina</button>
                        <button class="btn-danger" @click="deleteArchivedOrder(o.id)" v-if="o.status === 'Archiviato'">Elimina</button>
                    </div>
                </li>
            </ul>
        </div>

        <div v-else-if="activeTab === 'storico'">
            <h2>Storico e Statistiche</h2>

            <h3>Incasso Totale di Oggi ({{ todayDate }})</h3>
            <p style="font-size: 2em; color: #28a745;">€{{ dailyTotal.toFixed(2) }}</p>

            <h3>Consegne Giornaliere</h3>
            <label>Filtra per Fattorino:</label>
            <select v-model="selectedDriverFilter">
                <option value="">Tutti i Fattorini</option>
                <option v-for="driver in menuData.drivers" :key="driver">{{ driver }}</option>
            </select>

            <p style="font-weight: bold; margin-top: 10px;">
                {{ selectedDriverFilter ? 'Statistiche di ' + selectedDriverFilter : 'Totale Consegne Oggi' }}:
            </p>
            <p>
                Consegne: **{{ driverStats.totalOrders }}** | Totale Incasso: **€{{ driverStats.totalRevenue.toFixed(2) }}**
            </p>

            <h3>Ordini Completati</h3>
            <ul class="order-list">
                <li v-if="completedOrdersToday.length === 0">Nessun ordine completato oggi.</li>
                <li v-for="o in completedOrdersToday" :key="o.id" class="order-item" style="display: block;">
                    <h5>#{{o.id}} – {{new Date(o.archivedDate).toLocaleTimeString()}} | Cliente: {{o.customer}}</h5>
                    <p>**Totale: €{{o.total.toFixed(2)}}** ({{o.mode}})</p>
                    <p>Tavolo/Ritiro: {{o.tableNumber}}</p>
                    <p>Fattorino: {{o.driver}}</p>

                    <div class="item-actions">
                        <button class="btn-info" @click="openDriverChangeModal(o.id)">Modifica Fattorino</button>
                        <button class="btn-secondary" @click="duplicateOrder(o)">Duplica</button>
                    </div>
                </li>
            </ul>
        </div>

        <div v-else-if="activeTab === 'magazzino'">
            <h2>Gestione Magazzino / Inventario</h2>

            <h3>Aggiungi Materia Prima</h3>
            <div class="flex-container">
                <div class="flex-half">
                    <label for="rawMaterialName">Nome Materia Prima *</label>
                    <input type="text" id="rawMaterialName" v-model="rawMaterialName" placeholder="Es. Farina Tipo 00" required>
                </div>
                <div class="flex-half" style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label for="rawMaterialQuantity">Quantità Iniziale *</label>
                        <input type="number" id="rawMaterialQuantity" v-model.number="rawMaterialQuantity" min="0.01" step="0.01" required>
                    </div>
                    <div style="width: 100px;">
                        <label for="rawMaterialUnit">Unità *</label>
                        <select id="rawMaterialUnit" v-model="rawMaterialUnit">
                            <option>Kg</option>
                            <option>Litri</option>
                            <option>Pezzi</option>
                            <option>Grammi</option>
                            <option>ml</option>
                        </select>
                    </div>
                </div>
            </div>
            <button class="btn-success" @click="addRawMaterial" :disabled="!rawMaterialName || rawMaterialQuantity <= 0">Aggiungi</button>

            <h3>Inventario Attuale</h3>
            <ul class="inventory-list">
                <li v-if="inventory.length === 0">Nessuna materia prima aggiunta.</li>
                <li v-for="(item, index) in inventory" :key="index" class="inventory-item">
                    <div class="inventory-item-details">
                        <p style="font-weight: bold;">{{ item.nome }}</p>
                        <p>**Quantità:** <span style="font-size: 1.2em; color: #007bff;">{{ item.quantity.toFixed(2) }} {{ item.unit }}</span></p>
                    </div>

                    <div class="inventory-item-actions">
                        <input type="number" v-model.number="item.reductionInput" min="0.01" :max="item.quantity" step="0.01" style="width: 100px; margin-bottom: 0;">
                        <button class="btn-warning" @click="reduceStock(index)" :disabled="item.reductionInput <= 0 || item.reductionInput > item.quantity">Scarico</button>
                        <button class="btn-danger" @click="deleteRawMaterial(index)">❌</button>
                    </div>
                </li>
            </ul>
        </div>

        <div v-else-if="activeTab === 'impostazioni'">
            <div class="flex-container">
                <div class="flex-half">
                    <h2>Gestione Fattorini</h2>
                    <ul class="driver-list">
                        <li v-for="driver in menuData.drivers" :key="driver" class="driver-item">
                            <span>{{driver}}</span>
                            <button class="btn-danger" @click="deleteDriver(driver)">Elimina</button>
                        </li>
                    </ul>
                    <input type="text" v-model="newDriverName" placeholder="Nome Fattorino">
                    <button class="btn-success" @click="addDriver" :disabled="!newDriverName">Aggiungi Fattorino</button>

                    <hr style="margin-top: 20px;">

                    <h2>Impostazioni Modificatori</h2>
                    <h3>Gestione Categorie Modificatori</h3>
                    <ul class="modifier-category-list">
                        <li v-for="cat in menuData.modifierCategories" :key="cat" class="category-item">
                            <span>{{cat}}</span>
                            <button class="btn-danger" @click="deleteModifierCategory(cat)">Elimina</button>
                        </li>
                    </ul>
                    <input type="text" v-model="newModifierCategoryName" placeholder="Es. Extra">
                    <button class="btn-success" @click="addModifierCategory" :disabled="!newModifierCategoryName">Aggiungi Categoria</button>

                    <h3>Aggiungi/Rimuovi Modificatori</h3>
                    <div class="flex-container" style="gap: 5px;">
                        <div class="flex-half">
                            <label>Categoria</label>
                            <select v-model="selectedModCategory">
                                <option v-for="cat in menuData.modifierCategories" :key="cat">{{ cat }}</option>
                            </select>
                        </div>
                        <div class="flex-half">
                            <label>Nome Modificatore</label>
                            <input type="text" v-model="newModifierName">
                        </div>
                        <div style="width: 100px;">
                            <label>Prezzo</label>
                            <input type="number" v-model.number="newModifierPrice" min="0" step="0.01">
                        </div>
                    </div>
                    <button class="btn-success" @click="addModifier" :disabled="!selectedModCategory || !newModifierName">Aggiungi</button>

                    <div v-for="cat in menuData.modifierCategories" :key="'mod-list-' + cat">
                        <h4>{{cat}}</h4>
                        <ul class="modifier-list">
                            <li v-for="m in getModifiersByCategory(cat)" :key="m.nome" class="modifier-item">
                                <span>{{m.nome}} (+€{{m.prezzo.toFixed(2)}})</span>
                                <button class="btn-danger" @click="deleteModifier(m.nome)">❌</button>
                            </li>
                        </ul>
                    </div>

                </div>

                <div class="flex-half">
                    <h2>Impostazioni Menu</h2>
                    <h3>Gestione Categorie Menu</h3>
                    <ul class="category-list">
                        <li v-for="cat in menuData.categories" :key="cat" class="category-item">
                            <span>{{cat}}</span>
                            <button class="btn-danger" @click="deleteCategory(cat)">Elimina</button>
                        </li>
                    </ul>
                    <input type="text" v-model="newCategoryName" placeholder="Es. Pizze Classiche">
                    <button class="btn-success" @click="addCategory" :disabled="!newCategoryName">Aggiungi Categoria</button>

                    <h3>Gestione Prodotti</h3>
                    <div v-for="cat in menuData.categories" :key="'prod-list-' + cat">
                        <h4>{{cat}}</h4>
                        <ul class="product-list">
                            <li v-for="p in getProductsByCategory(cat)" :key="p.nome" class="product-item">
                                <span>
                                    {{p.nome}} – €{{p.prezzo.toFixed(2)}}
                                    <span v-if="p.isMeter || p.isHalfPizza">(Composto)</span>
                                    <span v-if="p.isFinished" class="finished-badge">FINITO</span>
                                </span>
                                <div class="item-actions">
                                    <button class="btn-info" @click="toggleFinished(p.nome)">{{ p.isFinished ? 'Rendi Disponibile' : 'Segna Finito' }}</button>
                                    <button class="btn-danger" @click="deleteProduct(p.nome)">❌</button>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <h3>Aggiungi Prodotto (N.B. Le sezioni con composizione complessa sono gestite dal sistema)</h3>
                    <label>Seleziona una categoria</label>
                    <select v-model="newProductCategory">
                        <option v-for="cat in menuData.categories" :key="cat">{{ cat }}</option>
                    </select>

                    <label>Tipo di Prodotto *</label>
                    <select v-model="newProductType">
                        <option value="standard">Standard (Es. Bibita)</option>
                        <option value="halfPizza">Mezza Pizza (gestisce due gusti)</option>
                        <option value="meterPizza">Pizza al Metro/Sezione (gestisce più sezioni/gusti)</option>
                    </select>

                    <label>Nome Prodotto *</label>
                    <input type="text" v-model="newProductName" placeholder="Nome Prodotto">

                    <label v-if="newProductType === 'standard'">Prezzo *</label>
                    <input v-if="newProductType === 'standard'" type="number" v-model.number="newProductPrice" min="0" step="0.01">

                    <button class="btn-success" @click="addProduct" :disabled="!newProductCategory || !newProductName || (newProductType === 'standard' && newProductPrice <= 0)">Aggiungi</button>

                    <hr style="margin-top: 20px;">

                    <h2>Gestione Zone di Consegna</h2>
                    <h3>Zone Attive</h3>
                    <ul class="zone-list">
                        <li v-for="zone in menuData.deliveryZones" :key="zone.name" class="zone-item">
                            <span>{{zone.name}} – Costo: €{{zone.price.toFixed(2)}}</span>
                            <button class="btn-danger" @click="deleteZone(zone.name)">❌</button>
                        </li>
                    </ul>
                    <h3>Aggiungi Nuova Zona</h3>
                    <label>Nome Zona *</label>
                    <input type="text" v-model="newZoneName" placeholder="Es. Centro">
                    <label>Costo Consegna *</label>
                    <input type="number" v-model.number="newZonePrice" min="0" step="0.01">
                    <button class="btn-success" @click="addZone" :disabled="!newZoneName || newZonePrice < 0">Aggiungi Zona</button>
                </div>
            </div>
        </div>


        <div v-if="showMeterComposer" class="modal-overlay">
            <div class="modal-content">
                <h3>Componi {{ tempMeterItem.nome }} ({{ tempMeterItem.sections.length }} Gusti)</h3>
                <div v-for="(section, secIdx) in tempMeterItem.sections" :key="secIdx" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                    <h4>Sezione {{ secIdx + 1 }}: {{ section.name }}</h4>

                    <label>Gusto Base *</label>
                    <select v-model="section.gusto" @change="section.basePrice = getProductPriceByName(section.gusto)">
                        <option value="">Seleziona una pizza o schiacciata</option>
                        <option v-for="pizza in standardPizzas" :key="'sec'+secIdx+'gusto'+pizza.nome">{{ pizza.nome }}</option>
                        <option v-for="sch in schiacciate" :key="'sec'+secIdx+'gusto'+sch.nome">{{ sch.nome }}</option>
                    </select>

                    <div style="margin-top: 10px;">
                        <p style="font-weight: bold;">Modificatori Aggiunti:</p>
                        <ul class="item-modifiers">
                            <li v-for="(mod, modIdx) in section.modifiers" :key="'sec'+secIdx+'mod'+modIdx">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                {{ mod.nome }} (+€{{ mod.prezzo.toFixed(2) }})
                                <button class="btn-danger" style="padding: 2px 5px; margin-left: 10px;" @click="section.modifiers.splice(modIdx, 1)">❌</button>
                            </li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 10px;">
                        <button class="btn-info" @click="openModifierSelector(section)">Aggiungi Modificatore</button>

                        <div v-if="activeModifierSection === section" style="background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <label>Categoria</label>
                            <select v-model="activeModCat">
                                <option v-for="cat in menuData.modifierCategories" :key="cat">{{ cat }}</option>
                            </select>
                            <div class="product-list" v-if="activeModCat">
                                <div v-for="m in getModifiersByCategory(activeModCat)" :key="m.nome" class="product-card" @click="addModifierToSection(section, m)">
                                    <strong>{{ m.nome }}</strong>
                                    <span>€{{ m.prezzo.toFixed(2)}}</span>
                                </div>
                            </div>
                            <p v-else style="color: #6c757d;">Seleziona una categoria per visualizzare i modificatori.</p>
                        </div>
                    </div>
                </div>

                <p style="font-weight: bold; margin-top: 20px;">Costo stimato: **€{{ calculateItemTotal(tempMeterItem).toFixed(2) }}**</p>

                <div class="item-actions">
                    <button class="btn-secondary" @click="cancelComposer">Annulla</button>
                    <button class="btn-success" @click="addItemToOrderFromComposer(tempMeterItem)">Aggiungi All'Ordine</button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaComposer" class="modal-overlay">
            <div class="modal-content">
                <h3>Componi Pizza Metà</h3>

                <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                    <h4>Metà 1: {{ tempHalfPizzaItem.gusto1 || 'Seleziona Gusto' }}</h4>
                    <label>Gusto Metà 1 *</label>
                    <select v-model="tempHalfPizzaItem.gusto1" @change="tempHalfPizzaItem.basePrice1 = getProductPriceByName(tempHalfPizzaItem.gusto1)">
                        <option value="">Seleziona un gusto</option>
                        <option v-for="pizza in standardPizzas" :key="'half1-pizza'+pizza.nome">{{ pizza.nome }} ({{pizza.prezzo.toFixed(2)}}€)</option>
                        <option v-for="sch in schiacciate" :key="'half1-sch'+sch.nome">{{ sch.nome }} ({{sch.prezzo.toFixed(2)}}€)</option>
                    </select>

                    <div style="margin-top: 10px;">
                        <p style="font-weight: bold;">Modificatori Metà 1:</p>
                        <ul class="item-modifiers">
                            <li v-for="(mod, modIdx) in tempHalfPizzaItem.modifiers1" :key="'half1mod'+modIdx">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                {{ mod.nome }} (+€{{ mod.prezzo.toFixed(2) }})
                                <button class="btn-danger" style="padding: 2px 5px; margin-left: 10px;" @click="tempHalfPizzaItem.modifiers1.splice(modIdx, 1)">❌</button>
                            </li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 10px;">
                        <button class="btn-info" @click="openModifierSelector(1)">Aggiungi Modificatore a Metà 1</button>

                        <div v-if="activeModifierSection === 1" style="background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <label>Categoria</label>
                            <select v-model="activeModCat">
                                <option v-for="cat in menuData.modifierCategories" :key="cat">{{ cat }}</option>
                            </select>
                            <div class="product-list" v-if="activeModCat">
                                <div v-for="m in getModifiersByCategory(activeModCat)" :key="m.nome" class="product-card" @click="addModifierToHalf(1, m)">
                                    <strong>{{ m.nome }}</strong>
                                    <span>€{{ m.prezzo.toFixed(2)}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
                    <h4>Metà 2: {{ tempHalfPizzaItem.gusto2 || 'Seleziona Gusto' }}</h4>
                    <label>Gusto Metà 2 *</label>
                    <select v-model="tempHalfPizzaItem.gusto2" @change="tempHalfPizzaItem.basePrice2 = getProductPriceByName(tempHalfPizzaItem.gusto2)">
                        <option value="">Seleziona un gusto</option>
                        <option v-for="pizza in standardPizzas" :key="'half2-pizza'+pizza.nome">{{ pizza.nome }} ({{pizza.prezzo.toFixed(2)}}€)</option>
                        <option v-for="sch in schiacciate" :key="'half2-sch'+sch.nome">{{ sch.nome }} ({{sch.prezzo.toFixed(2)}}€)</option>
                    </select>

                    <div style="margin-top: 10px;">
                        <p style="font-weight: bold;">Modificatori Metà 2:</p>
                        <ul class="item-modifiers">
                            <li v-for="(mod, modIdx) in tempHalfPizzaItem.modifiers2" :key="'half2mod'+modIdx">
                                {{ getModifierIcon(getModifierCategory(mod.nome)) }}
                                {{ mod.nome }} (+€{{ mod.prezzo.toFixed(2) }})
                                <button class="btn-danger" style="padding: 2px 5px; margin-left: 10px;" @click="tempHalfPizzaItem.modifiers2.splice(modIdx, 1)">❌</button>
                            </li>
                        </ul>
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 10px;">
                        <button class="btn-info" @click="openModifierSelector(2)">Aggiungi Modificatore a Metà 2</button>

                        <div v-if="activeModifierSection === 2" style="background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 10px;">
                            <label>Categoria</label>
                            <select v-model="activeModCat">
                                <option v-for="cat in menuData.modifierCategories" :key="cat">{{ cat }}</option>
                            </select>
                            <div class="product-list" v-if="activeModCat">
                                <div v-for="m in getModifiersByCategory(activeModCat)" :key="m.nome" class="product-card" @click="addModifierToHalf(2, m)">
                                    <strong>{{ m.nome }}</strong>
                                    <span>€{{ m.prezzo.toFixed(2)}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p style="font-weight: bold; margin-top: 20px;">Costo Calcolato (Base Media + Modificatori): **€{{ calculateItemTotal(tempHalfPizzaItem).toFixed(2) }}**</p>

                <div class="item-actions">
                    <button class="btn-secondary" @click="cancelComposer">Annulla</button>
                    <button class="btn-success" @click="addItemToOrderFromComposer(tempHalfPizzaItem)" :disabled="!tempHalfPizzaItem.gusto1 || !tempHalfPizzaItem.gusto2">Aggiungi All'Ordine</button>
                </div>
            </div>
        </div>

        <div v-if="showFinalizeModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Finalizza Ordine - Totale: €{{total.toFixed(2)}}</h3>

                <label>Modalità di Ritiro/Consegna *</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div v-for="m in [{mode: 'tavolo', label: 'Tavolo/Ritiro'}, {mode: 'consegna', label: 'Consegna'}]" :key="m.mode"
                        class="pizza-type-box"
                        :class="{'active': finalizeOrder.mode === m.mode}"
                        @click="setOrderMode(m.mode)">
                        {{m.label}}
                        <span v-if="finalizeOrder.mode === m.mode">✔️</span>
                    </div>
                </div>

                <div class="flex-container">
                    <div class="flex-half">
                        <label>Cognome Cliente *</label>
                        <input type="text" v-model="finalizeOrder.customer">
                    </div>
                    <div class="flex-half">
                        <label>{{ finalizeOrder.mode === 'tavolo' ? 'Numero Tavolo' : 'Numero per Ritiro' }} *</label>
                        <input type="text" v-model="finalizeOrder.tableNumber">
                    </div>
                </div>

                <div class="flex-container">
                    <div class="flex-half">
                        <label>Telefono *</label>
                        <input type="text" v-model="finalizeOrder.phone">
                    </div>
                    <div class="flex-half">
                        <label>Assegna Fattorino (opzionale)</label>
                        <select v-model="finalizeOrder.driver">
                            <option value="">Nessun Fattorino Assegnato</option>
                            <option v-for="d in menuData.drivers" :key="d">{{ d }}</option>
                        </select>
                    </div>
                </div>

                <div v-if="finalizeOrder.mode === 'consegna'">
                    <div class="flex-container">
                        <div class="flex-half">
                            <label>Indirizzo (Via/Piazza) *</label>
                            <input type="text" v-model="finalizeOrder.address">
                        </div>
                        <div style="width: 150px;">
                            <label>Civico *</label>
                            <input type="text" v-model="finalizeOrder.streetNumber">
                        </div>
                    </div>
                    <div class="flex-container">
                        <div class="flex-half">
                            <label>Zona *</label>
                            <select v-model="finalizeOrder.zone" @change="updateDeliveryCost">
                                <option value="">Seleziona una zona</option>
                                <option v-for="z in menuData.deliveryZones" :key="z.name" :value="z.name">{{ z.name }} ({{z.price.toFixed(2)}}€)</option>
                            </select>
                        </div>
                        <div class="flex-half">
                            <label>Paese *</label>
                            <input type="text" v-model="finalizeOrder.town">
                        </div>
                    </div>
                </div>

                <label>Note/Istruzioni (es. citofono, piano, allergie)</label>
                <textarea v-model="finalizeOrder.notes"></textarea>

                <div class="flex-container">
                    <div class="flex-half">
                        <label>Data Ordine *</label>
                        <input type="date" v-model="finalizeOrder.date">
                    </div>
                    <div class="flex-half">
                        <label>Ora di Ritiro/Consegna *</label>
                        <input type="time" v-model="finalizeOrder.hour">
                    </div>
                </div>


                <div class="item-actions">
                    <button class="btn-secondary" @click="closeFinalizeOrderModal">Annulla</button>
                    <button class="btn-success" @click="saveOrder" :disabled="!isFinalizeFormValid">
                        {{ editingOrderId ? 'Aggiorna Ordine' : 'Conferma e Salva Ordine' }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Azioni Ordine #{{selectedOrderIdForShare}}</h3>
                <div class="item-actions" style="flex-direction: column; gap: 10px;">
                    <button class="btn-info" @click="printOrder(selectedOrderIdForShare)">Stampa Comanda</button>
                    <button class="btn-info" @click="shareOrderDetails(selectedOrderIdForShare)">Condividi / Copia Dettagli</button>
                    <button class="btn-secondary" @click="showShareModal = false">Chiudi</button>
                </div>
            </div>
        </div>

        <div v-if="showDriverChangeModal" class="modal-overlay">
            <div class="modal-content">
                <h3>Modifica Fattorino per Ordine #{{selectedOrderIdForDriverChange}}</h3>
                <label>Modifica Fattorino:</label>
                <select v-model="newDriverForArchivedOrder">
                    <option value="">Nessuno</option>
                    <option v-for="driver in menuData.drivers" :key="driver">{{ driver }}</option>
                </select>
                <div class="item-actions">
                    <button class="btn-success" @click="updateArchivedDriver">Salva</button>
                    <button class="btn-secondary" @click="showDriverChangeModal = false">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = new Vue({
            el: '#app',
            data() {
                return {
                    // --- TAB & VIEW CONTROL ---
                    activeTab: 'inserimento',
                    activeOrderFilter: 'Tutti', // 'Tutti', 'In Prep.', 'Pronto', 'Archiviati'
                    editingOrderId: null,
                    
                    // --- MENU DATA & PERSISTENCE ---
                    menuData: JSON.parse(localStorage.getItem('menuData')) || {
                        categories: ['Pizze Classiche', 'Pizze Speciali', 'Bibite'],
                        products: [
                            { nome: 'Margherita', prezzo: 6.00, category: 'Pizze Classiche', isHalfPizza: false, isMeter: false, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, category: 'Pizze Classiche', isHalfPizza: false, isMeter: false, isFinished: false },
                            { nome: 'Pizza al Metro 1m', prezzo: 0.00, category: 'Pizze Speciali', isHalfPizza: false, isMeter: true, isFinished: false },
                            { nome: 'Coca Cola 33cl', prezzo: 2.50, category: 'Bibite', isHalfPizza: false, isMeter: false, isFinished: false }
                        ],
                        modifierCategories: ['Salsa', 'Aggiunte'],
                        modifiers: [
                            { nome: 'Doppia Mozzarella', prezzo: 1.00, category: 'Aggiunte' },
                            { nome: 'Salsa Piccante', prezzo: 0.50, category: 'Salsa' }
                        ],
                        deliveryZones: [
                            { name: 'Centro', price: 2.00 },
                            { name: 'Periferia Nord', price: 3.50 }
                        ],
                        drivers: ['Mario', 'Luigi']
                    },
                    
                    // --- ORDER CREATION DATA ---
                    orders: JSON.parse(localStorage.getItem('orders')) || [],
                    archivedOrders: JSON.parse(localStorage.getItem('archivedOrders')) || [],
                    orderCounter: parseInt(localStorage.getItem('orderCounter')) || 1,

                    order: [], // Current order items
                    selectedProduct: null,
                    tempItem: { modifiers: [] },
                    selectedItemIndex: null,

                    // --- COMPOSER DATA ---
                    showMeterComposer: false,
                    showHalfPizzaComposer: false,
                    tempMeterItem: null,
                    tempHalfPizzaItem: null,
                    activeModifierSection: null, // Used to control modifier selector visibility (1, 2, or section object)
                    activeModCat: null, // Selected modifier category in composer

                    // --- FINALIZATION DATA ---
                    showFinalizeModal: false,
                    finalizeOrder: this.resetFinalizeOrder(),
                    
                    // --- MODALS & UTILITIES ---
                    showShareModal: false,
                    selectedOrderIdForShare: null,
                    
                    showDriverChangeModal: false,
                    selectedOrderIdForDriverChange: null,
                    newDriverForArchivedOrder: '',

                    // --- SETTINGS INPUTS ---
                    newCategoryName: '',
                    newProductName: '',
                    newProductCategory: '',
                    newProductPrice: 0.00,
                    newProductType: 'standard', // 'standard', 'halfPizza', 'meterPizza'
                    newModifierCategoryName: '',
                    selectedModCategory: '',
                    newModifierName: '',
                    newModifierPrice: 0.00,
                    newZoneName: '',
                    newZonePrice: 0.00,
                    newDriverName: '',

                    // --- INVENTORY DATA & PERSISTENCE (FIXED V4.0) ---
                    inventory: this.loadInventory(), // Load and prepare inventory
                    rawMaterialName: '',
                    rawMaterialQuantity: 1,
                    rawMaterialUnit: 'Kg',
                }
            },
            computed: {
                standardPizzas() {
                    return this.menuData.products.filter(p => p.category.toLowerCase().includes('pizze') && !p.isHalfPizza && !p.isMeter && !p.isFinished);
                },
                schiacciate() {
                    return this.menuData.products.filter(p => p.category.toLowerCase().includes('schiacciate') && !p.isHalfPizza && !p.isMeter && !p.isFinished);
                },
                calculatedOrderTotal() {
                    return this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
                },
                deliveryCost() {
                    if (this.finalizeOrder.mode !== 'consegna' || !this.finalizeOrder.zone) {
                        return 0;
                    }
                    const zone = this.menuData.deliveryZones.find(z => z.name === this.finalizeOrder.zone);
                    return zone ? zone.price : 0;
                },
                total() {
                    return this.calculatedOrderTotal + this.deliveryCost;
                },
                isFinalizeFormValid() {
                    const f = this.finalizeOrder;
                    const baseValid = f.customer && f.tableNumber && f.phone && f.date && f.hour && this.order.length > 0;
                    if (f.mode === 'consegna') {
                        return baseValid && f.address && f.streetNumber && f.zone && f.town;
                    }
                    return baseValid;
                },
                zoneName() {
                    const zone = this.menuData.deliveryZones.find(z => z.name === this.finalizeOrder.zone);
                    return zone ? zone.name : 'Nessuna Zona';
                },
                filteredOrders() {
                    if (this.activeOrderFilter === 'Tutti') {
                        return this.orders.slice().reverse();
                    } else if (this.activeOrderFilter === 'Archiviati') {
                         return this.archivedOrders.slice().reverse();
                    } else {
                        return this.orders.filter(o => o.status === this.activeOrderFilter).reverse();
                    }
                },
                todayDate() {
                    return new Date().toLocaleDateString('it-IT');
                },
                dailyTotal() {
                    const today = new Date().toLocaleDateString();
                    return this.archivedOrders
                        .filter(o => new Date(o.archivedDate).toLocaleDateString() === today)
                        .reduce((sum, o) => sum + o.total, 0);
                },
                completedOrdersToday() {
                    const today = new Date().toLocaleDateString();
                    return this.archivedOrders
                        .filter(o => new Date(o.archivedDate).toLocaleDateString() === today)
                        .reverse();
                },
                driverStats() {
                    const today = new Date().toLocaleDateString();
                    const filtered = this.archivedOrders.filter(o => new Date(o.archivedDate).toLocaleDateString() === today);

                    if (!this.selectedDriverFilter) {
                        return {
                            totalOrders: filtered.length,
                            totalRevenue: filtered.reduce((sum, o) => sum + o.total, 0)
                        };
                    } else {
                        const driverOrders = filtered.filter(o => o.driver === this.selectedDriverFilter);
                        return {
                            totalOrders: driverOrders.length,
                            totalRevenue: driverOrders.reduce((sum, o) => sum + o.total, 0)
                        };
                    }
                }
            },
            created() {
                // Initialize data if localStorage is empty
                if (this.orders.length === 0) {
                    this.saveOrders();
                }
                if (this.menuData.products.length === 0) {
                    this.saveMenuData();
                }
                if (this.inventory.length === 0) {
                    this.saveInventory();
                }
                if (!localStorage.getItem('orderCounter')) {
                    localStorage.setItem('orderCounter', this.orderCounter);
                }
                // Pre-fill date and time for faster order entry
                this.finalizeOrder.date = new Date().toISOString().substring(0, 10);
                this.finalizeOrder.hour = new Date().toTimeString().substring(0, 5);
            },
            methods: {
                // --- PERSISTENCE METHODS ---
                saveMenuData() {
                    localStorage.setItem('menuData', JSON.stringify(this.menuData));
                },
                saveOrders() {
                    localStorage.setItem('orders', JSON.stringify(this.orders));
                },
                saveArchivedOrders() {
                    localStorage.setItem('archivedOrders', JSON.stringify(this.archivedOrders));
                },
                saveOrderCounter() {
                    localStorage.setItem('orderCounter', this.orderCounter);
                },

                // --- INVENTORY PERSISTENCE & LOADING (V4.0 FIX) ---
                loadInventory() {
                    const loadedInventory = JSON.parse(localStorage.getItem('inventory')) || [];
                    // Ensure every item has a reduction input property for local binding
                    return loadedInventory.map(item => ({
                        ...item,
                        reductionInput: item.reductionInput !== undefined ? item.reductionInput : 1
                    }));
                },
                saveInventory() {
                    // When saving, we can strip the non-persistent `reductionInput` if preferred, but it doesn't hurt to keep it.
                    // For simplicity and to maintain state, we save the full objects.
                    localStorage.setItem('inventory', JSON.stringify(this.inventory));
                },

                // --- UTILITY METHODS ---
                getProductsByCategory(category) {
                    return this.menuData.products.filter(p => p.category === category);
                },
                getModifiersByCategory(category) {
                    return this.menuData.modifiers.filter(m => m.category === category);
                },
                getModifierCategory(modifierName) {
                    const mod = this.menuData.modifiers.find(m => m.nome === modifierName);
                    return mod ? mod.category : '';
                },
                getProductPriceByName(productName) {
                    const product = this.menuData.products.find(p => p.nome === productName);
                    return product ? product.prezzo : 0;
                },
                getModifierIcon(category) {
                    switch (category.toLowerCase()) {
                        case 'salsa':
                            return '🌶️';
                        case 'aggiunte':
                            return '✨';
                        default:
                            return '➕';
                    }
                },
                formatDate(dateString) {
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    return new Date(dateString).toLocaleDateString('it-IT', options);
                },
                
                // --- CALCULATION METHOD ---
                calculateItemTotal(item) {
                    let total = 0;

                    if (item.isHalfPizza) {
                        // Base price for half pizzas is the average of the two selected pizza base prices
                        const price1 = this.getProductPriceByName(item.gusto1);
                        const price2 = this.getProductPriceByName(item.gusto2);
                        total += ((price1 || 0) + (price2 || 0)) / 2;
                        // Modifiers are full price
                        total += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        total += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    } else if (item.isMeter) {
                        // Total price is the sum of the base price (if any) + all section modifiers
                        total += item.prezzo; // Base price of the meter pizza (if non-zero)
                        total += item.sections.reduce((sectionSum, section) => {
                            // Section base price (if used, e.g. for different kinds of dough/topping) is already factored into item.prezzo or should be 0 here
                            return sectionSum + section.modifiers.reduce((modSum, mod) => modSum + mod.prezzo, 0);
                        }, 0);
                    } else {
                        // Standard item: base price + all modifiers
                        total += item.prezzo;
                        total += item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    }
                    return total;
                },

                // --- ORDER CREATION FLOW ---
                resetCurrentProduct() {
                    this.selectedProduct = null;
                    this.tempItem = { modifiers: [] };
                    this.selectedItemIndex = null;
                },
                selectProduct(product) {
                    this.resetCurrentProduct(); // Reset previous selection/editing
                    this.selectedProduct = product;
                    this.tempItem = {
                        ...product,
                        modifiers: []
                    };
                },
                addModifierToTempItem(modifier) {
                    // Check if modifier category allows multiple additions (optional logic, assumed yes for simplicity)
                    this.tempItem.modifiers.push(modifier);
                },
                addItemToOrder() {
                    if (this.selectedItemIndex !== null) {
                        // Editing existing item (only modifiers are managed here for simplicity)
                        this.order.splice(this.selectedItemIndex, 1, this.tempItem);
                    } else {
                        // New item
                        this.order.push({
                            ...this.tempItem,
                            id: Date.now() // Unique ID for keying/tracking
                        });
                    }
                    this.resetCurrentProduct();
                },
                removeItemFromOrder(index) {
                    this.order.splice(index, 1);
                    this.resetCurrentProduct();
                },
                selectItemForEditing(index) {
                    this.resetCurrentProduct();
                    this.selectedItemIndex = index;
                    // Create a deep copy for editing
                    this.tempItem = JSON.parse(JSON.stringify(this.order[index]));
                    this.selectedProduct = this.tempItem; // Keep selectedProduct filled for context

                    // Re-open composer if it's a composed item
                    if (this.tempItem.isMeter) {
                        this.tempMeterItem = this.tempItem;
                        this.showMeterComposer = true;
                    } else if (this.tempItem.isHalfPizza) {
                        this.tempHalfPizzaItem = this.tempItem;
                        this.showHalfPizzaComposer = true;
                    }
                },
                
                // --- COMPOSER METHODS ---
                openComposer(product) {
                    this.resetCurrentProduct(); // Ensure no standard product is accidentally being edited
                    const baseItem = {
                        ...product,
                        id: Date.now(),
                    };

                    if (product.isMeter) {
                        baseItem.sections = [
                            { name: 'Sezione 1', gusto: '', basePrice: 0.00, modifiers: [] },
                            { name: 'Sezione 2', gusto: '', basePrice: 0.00, modifiers: [] },
                        ]; // Start with 2 sections
                        this.tempMeterItem = baseItem;
                        this.showMeterComposer = true;
                    } else if (product.isHalfPizza) {
                        baseItem.gusto1 = '';
                        baseItem.gusto2 = '';
                        baseItem.basePrice1 = 0.00;
                        baseItem.basePrice2 = 0.00;
                        baseItem.modifiers1 = [];
                        baseItem.modifiers2 = [];
                        this.tempHalfPizzaItem = baseItem;
                        this.showHalfPizzaComposer = true;
                    }
                },
                cancelComposer() {
                    this.showMeterComposer = false;
                    this.showHalfPizzaComposer = false;
                    this.tempMeterItem = null;
                    this.tempHalfPizzaItem = null;
                    this.activeModifierSection = null;
                    this.activeModCat = null;
                    this.resetCurrentProduct(); // Clear any temp item state
                },
                openModifierSelector(sectionOrHalf) {
                    this.activeModifierSection = sectionOrHalf;
                    this.activeModCat = null;
                },
                addModifierToSection(section, modifier) {
                    section.modifiers.push(modifier);
                    this.activeModifierSection = null;
                    this.activeModCat = null;
                },
                addModifierToHalf(halfNumber, modifier) {
                    if (halfNumber === 1) {
                        this.tempHalfPizzaItem.modifiers1.push(modifier);
                    } else if (halfNumber === 2) {
                        this.tempHalfPizzaItem.modifiers2.push(modifier);
                    }
                    this.activeModifierSection = null;
                    this.activeModCat = null;
                },
                addItemToOrderFromComposer(item) {
                    if (this.editingOrderId && this.selectedItemIndex !== null) {
                         // Editing scenario (already in order)
                        this.order.splice(this.selectedItemIndex, 1, item);
                    } else {
                        // New item
                        this.order.push(item);
                    }
                    this.cancelComposer(); // This also calls resetCurrentProduct()
                },

                // --- ORDER FINALIZATION ---
                resetFinalizeOrder() {
                    return {
                        mode: 'tavolo', // 'tavolo' or 'consegna'
                        customer: '',
                        tableNumber: '', // Used for table number (tavolo) or pickup number (banco)
                        phone: '',
                        driver: '',
                        address: '',
                        streetNumber: '',
                        zone: '',
                        town: 'Città Base',
                        notes: '',
                        date: new Date().toISOString().substring(0, 10),
                        hour: new Date().toTimeString().substring(0, 5)
                    };
                },
                setOrderMode(mode) {
                    this.finalizeOrder.mode = mode;
                    this.updateDeliveryCost();
                },
                updateDeliveryCost() {
                    if (this.finalizeOrder.mode === 'consegna') {
                        // Computed property `deliveryCost` handles the logic
                    } else {
                        // Clear zone if not delivery
                        this.finalizeOrder.zone = '';
                    }
                },
                openFinalizeOrderModal() {
                    if(this.editingOrderId) {
                        // If editing, merge the current order details into finalizeOrder state
                        const orderToEdit = this.orders.find(o => o.id === this.editingOrderId);
                        this.finalizeOrder = {
                             // Preserve date/time for simplicity, but allow re-selection
                            date: orderToEdit.date,
                            hour: orderToEdit.hour,
                            // All other fields
                            mode: orderToEdit.mode,
                            customer: orderToEdit.customer,
                            tableNumber: orderToEdit.tableNumber,
                            phone: orderToEdit.phone,
                            driver: orderToEdit.driver,
                            address: orderToEdit.address,
                            streetNumber: orderToEdit.streetNumber,
                            zone: orderToEdit.zone,
                            town: orderToEdit.town,
                            notes: orderToEdit.notes,
                        };
                    } else {
                        // New order
                        this.finalizeOrder = this.resetFinalizeOrder();
                    }
                    this.showFinalizeModal = true;
                },
                closeFinalizeOrderModal() {
                    this.showFinalizeModal = false;
                    // Keep current order items/state
                },
                saveOrder() {
                    if (!this.isFinalizeFormValid) {
                        alert("Per favore, compila tutti i campi obbligatori.");
                        return;
                    }

                    const newOrder = {
                        id: this.editingOrderId || this.orderCounter,
                        status: this.editingOrderId ? this.orders.find(o => o.id === this.editingOrderId).status : 'In Prep.',
                        date: this.finalizeOrder.date,
                        hour: this.finalizeOrder.hour,
                        items: JSON.parse(JSON.stringify(this.order)), // Deep copy of items
                        mode: this.finalizeOrder.mode,
                        customer: this.finalizeOrder.customer,
                        tableNumber: this.finalizeOrder.tableNumber,
                        phone: this.finalizeOrder.phone,
                        driver: this.finalizeOrder.driver,
                        address: this.finalizeOrder.address,
                        streetNumber: this.finalizeOrder.streetNumber,
                        zone: this.finalizeOrder.zone,
                        town: this.finalizeOrder.town,
                        notes: this.finalizeOrder.notes,
                        deliveryCost: this.deliveryCost,
                        total: this.total,
                        archivedDate: null,
                    };

                    if (this.editingOrderId) {
                        // Update existing order
                        const index = this.orders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.orders.splice(index, 1, newOrder);
                        }
                        this.editingOrderId = null; // Exit edit mode
                    } else {
                        // New order
                        this.orders.push(newOrder);
                        this.orderCounter++;
                        this.saveOrderCounter();
                    }

                    // Reset state
                    this.order = [];
                    this.finalizeOrder = this.resetFinalizeOrder();
                    this.showFinalizeModal = false;
                    this.saveOrders();
                    this.activeTab = 'ordini'; // Switch to active orders view
                },

                // --- ACTIVE ORDERS MANAGEMENT ---
                editOrder(id) {
                    const orderToEdit = this.orders.find(o => o.id === id);
                    if (!orderToEdit) return;

                    // 1. Set edit mode
                    this.editingOrderId = id;
                    // 2. Load order items into the creation view
                    this.order = JSON.parse(JSON.stringify(orderToEdit.items));
                    // 3. Switch view
                    this.activeTab = 'inserimento';
                    this.resetCurrentProduct(); // Clear temp item state
                },
                cancelOrderEdit() {
                    this.editingOrderId = null;
                    this.order = [];
                    this.activeTab = 'ordini';
                    this.resetCurrentProduct();
                },
                advanceOrderStatus(id) {
                    const index = this.orders.findIndex(o => o.id === id);
                    if (index === -1) return;

                    const order = this.orders[index];
                    let nextStatus = '';

                    switch (order.status) {
                        case 'In Prep.':
                            nextStatus = 'Pronto';
                            break;
                        case 'Pronto':
                            nextStatus = 'Archiviato';
                            order.archivedDate = new Date().toISOString(); // Mark archive time
                            this.archivedOrders.push(order);
                            this.orders.splice(index, 1);
                            this.saveArchivedOrders();
                            this.saveOrders();
                            return;
                        case 'Archiviato':
                        default:
                            return;
                    }
                    order.status = nextStatus;
                    this.saveOrders();
                },
                deleteOrder(id) {
                    if (confirm('Sei sicuro di voler eliminare questo ordine attivo?')) {
                        const index = this.orders.findIndex(o => o.id === id);
                        if (index !== -1) {
                            this.orders.splice(index, 1);
                            this.saveOrders();
                        }
                    }
                },
                deleteArchivedOrder(id) {
                    if (confirm('Sei sicuro di voler eliminare questo ordine dallo storico?')) {
                        const index = this.archivedOrders.findIndex(o => o.id === id);
                        if (index !== -1) {
                            this.archivedOrders.splice(index, 1);
                            this.saveArchivedOrders();
                        }
                    }
                },
                duplicateOrder(order) {
                    // Create a new order structure based on the old one
                    const duplicatedOrder = {
                        id: this.orderCounter, // Assign new ID
                        status: 'In Prep.', // Reset status
                        date: new Date().toISOString().substring(0, 10), // Set today's date
                        hour: new Date().toTimeString().substring(0, 5), // Set current time
                        items: JSON.parse(JSON.stringify(order.items)), // Deep copy of items
                        // Copy details from old order
                        mode: order.mode,
                        customer: order.customer,
                        tableNumber: order.tableNumber,
                        phone: order.phone,
                        driver: order.driver,
                        address: order.address,
                        streetNumber: order.streetNumber,
                        zone: order.zone,
                        town: order.town,
                        notes: order.notes,
                        deliveryCost: order.deliveryCost,
                        total: order.total,
                        archivedDate: null,
                    };

                    this.orders.push(duplicatedOrder);
                    this.orderCounter++;
                    this.saveOrderCounter();
                    this.saveOrders();
                    this.activeTab = 'ordini';
                },
                openShareModal(id) {
                    this.selectedOrderIdForShare = id;
                    this.showShareModal = true;
                },
                printOrder(id) {
                    const order = this.orders.find(o => o.id === id) || this.archivedOrders.find(o => o.id === id);
                    if (!order) return;
                    
                    // Simple text generation for printing/sharing
                    const details = this.generateOrderDetails(order);

                    // For printing, a browser print dialog is usually triggered
                    const printWindow = window.open('', '', 'height=600,width=800');
                    printWindow.document.write('<html><head><title>Comanda Ordine #' + order.id + '</title>');
                    printWindow.document.write('<style>body{font-family: monospace; white-space: pre-wrap;}</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write('<h1>Comanda Ordine #' + order.id + '</h1>');
                    printWindow.document.write('<pre>' + details + '</pre>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.print();
                },
                shareOrderDetails(id) {
                    const order = this.orders.find(o => o.id === id) || this.archivedOrders.find(o => o.id === id);
                    if (!order) return;

                    const details = this.generateOrderDetails(order);

                    // Use the Clipboard API to copy the text
                    navigator.clipboard.writeText(details)
                        .then(() => {
                            alert("Dettagli ordine #" + id + " copiati negli appunti!");
                            this.showShareModal = false;
                        })
                        .catch(err => {
                            console.error('Errore nella copia: ', err);
                            alert("Impossibile copiare. Dettagli: \n\n" + details);
                        });
                },
                generateOrderDetails(order) {
                    let details = `*** Dettagli Ordine #${order.id} ***\n`;
                    details += `Cliente: ${order.customer}\n`;
                    details += `Modalità: ${order.mode.toUpperCase()}${order.tableNumber ? ' (' + order.tableNumber + ')' : ''}\n`;
                    details += `Orario: ${order.hour} (${this.formatDate(order.date)})\n`;
                    details += `Fattorino: ${order.driver || 'Non Assegnato'}\n`;

                    if (order.mode === 'consegna') {
                        details += `Indirizzo: ${order.address} ${order.streetNumber}, ${order.zone} (${order.town})\n`;
                    }
                    details += `Telefono: ${order.phone}\n`;
                    if (order.notes) {
                        details += `Note: ${order.notes}\n`;
                    }
                    details += '\n--- Articoli ---\n';

                    order.items.forEach(item => {
                        let itemLine = `🍕 ${item.nome}`;
                        if (item.isHalfPizza) {
                            itemLine += ` (M1: ${item.gusto1} / M2: ${item.gusto2})`;
                        } else if (item.isMeter) {
                            itemLine += ` (${item.sections.length} Gusti)`;
                        }
                        itemLine += ` - €${this.calculateItemTotal(item).toFixed(2)}\n`;

                        // Add Half Pizza sections details
                        if (item.isHalfPizza) {
                            itemLine += `  > Metà 1: ${item.gusto1}\n`;
                            item.modifiers1.forEach(mod => itemLine += `    + ${mod.nome} (+€${mod.prezzo.toFixed(2)})\n`);
                            itemLine += `  > Metà 2: ${item.gusto2}\n`;
                            item.modifiers2.forEach(mod => itemLine += `    + ${mod.nome} (+€${mod.prezzo.toFixed(2)})\n`);
                        }

                        // Add Meter Pizza sections details
                        if (item.isMeter) {
                            item.sections.forEach(sec => {
                                itemLine += `  > ${sec.name}: ${sec.gusto}\n`;
                                sec.modifiers.forEach(mod => itemLine += `    + ${mod.nome} (+€${mod.prezzo.toFixed(2)})\n`);
                            });
                        }

                        // Add Standard Modifiers (for standard items or general meter/half modifiers if applicable)
                        item.modifiers.forEach(mod => itemLine += `  + ${mod.nome} (+€${mod.prezzo.toFixed(2)})\n`);

                        details += itemLine;
                    });

                    details += '\n--- Totale ---\n';
                    details += `Totale Articoli: €${order.total.toFixed(2)}\n`;
                    if (order.deliveryCost > 0) {
                        details += `Costo Consegna: +€${order.deliveryCost.toFixed(2)}\n`;
                        details += `TOTALE COMPLESSIVO: €${(order.total).toFixed(2)}\n`;
                    } else {
                        details += `TOTALE: €${order.total.toFixed(2)}\n`;
                    }

                    return details;
                },

                // --- STORICO/ARCHIVE MANAGEMENT ---
                openDriverChangeModal(orderId) {
                    this.selectedOrderIdForDriverChange = orderId;
                    const order = this.archivedOrders.find(o => o.id === orderId);
                    this.newDriverForArchivedOrder = order ? order.driver : '';
                    this.showDriverChangeModal = true;
                },
                updateArchivedDriver() {
                    const index = this.archivedOrders.findIndex(o => o.id === this.selectedOrderIdForDriverChange);
                    if (index !== -1) {
                        this.archivedOrders[index].driver = this.newDriverForArchivedOrder;
                        this.saveArchivedOrders();
                        this.showDriverChangeModal = false;
                        alert(`Fattorino per ordine #${this.selectedOrderIdForDriverChange} aggiornato a ${this.newDriverForArchivedOrder || 'Nessuno'}.`);
                    }
                },

                // --- INVENTORY METHODS (V4.0 FIX) ---
                addRawMaterial() {
                    const parsedQuantity = parseFloat(this.rawMaterialQuantity);
                    if (!this.rawMaterialName || parsedQuantity <= 0 || isNaN(parsedQuantity)) {
                        alert("Nome e quantità iniziale sono obbligatori e la quantità deve essere positiva.");
                        return;
                    }

                    // Check if material already exists
                    if (this.inventory.some(item => item.nome.toLowerCase() === this.rawMaterialName.toLowerCase())) {
                        alert(`La materia prima '${this.rawMaterialName}' esiste già.`);
                        return;
                    }

                    this.inventory.push({
                        nome: this.rawMaterialName,
                        quantity: parsedQuantity,
                        unit: this.rawMaterialUnit,
                        reductionInput: 1 // Initialize the new property
                    });

                    this.rawMaterialName = '';
                    this.rawMaterialQuantity = 1;

                    this.saveInventory();
                },

                reduceStock(itemIndex) {
                    const item = this.inventory[itemIndex];
                    const amount = item.reductionInput; // Reads from the item's local property

                    if (amount <= 0 || amount > item.quantity) {
                        alert("Inserisci una quantità valida per lo scarico, non superiore alla quantità attuale.");
                        return;
                    }
                    if (confirm(`Scarico di ${amount.toFixed(2)} ${item.unit} di ${item.nome}. Sei sicuro?`)) {
                        item.quantity -= amount;
                        item.reductionInput = 1; // Reset reduction input after use
                        this.saveInventory();
                    }
                },

                deleteRawMaterial(itemIndex) {
                    if (confirm(`Sei sicuro di voler eliminare ${this.inventory[itemIndex].nome} dall'inventario?`)) {
                        this.inventory.splice(itemIndex, 1);
                        this.saveInventory();
                    }
                },

                // --- SETTINGS METHODS: Menu Categories ---
                addCategory() {
                    if (this.newCategoryName && !this.menuData.categories.includes(this.newCategoryName)) {
                        this.menuData.categories.push(this.newCategoryName);
                        this.newCategoryName = '';
                        this.saveMenuData();
                    }
                },
                deleteCategory(category) {
                    if (confirm(`Sei sicuro di voler eliminare la categoria '${category}'? Tutti i prodotti associati non saranno più visualizzati!`)) {
                        this.menuData.categories = this.menuData.categories.filter(c => c !== category);
                        // The products remain in the list but will not be displayed by category
                        this.saveMenuData();
                    }
                },

                // --- SETTINGS METHODS: Products ---
                addProduct() {
                    if (this.newProductName && this.newProductCategory) {
                        if (this.menuData.products.some(p => p.nome.toLowerCase() === this.newProductName.toLowerCase())) {
                            alert("Un prodotto con questo nome esiste già.");
                            return;
                        }

                        const newProduct = {
                            nome: this.newProductName,
                            prezzo: this.newProductPrice,
                            category: this.newProductCategory,
                            isHalfPizza: this.newProductType === 'halfPizza',
                            isMeter: this.newProductType === 'meterPizza',
                            isFinished: false,
                        };

                        // Set price to 0 if it's a composed item (Half/Meter) as price is calculated in the composer
                        if (newProduct.isHalfPizza || newProduct.isMeter) {
                            newProduct.prezzo = 0.00;
                        }

                        this.menuData.products.push(newProduct);
                        this.newProductName = '';
                        this.newProductPrice = 0.00;
                        this.newProductType = 'standard';
                        this.saveMenuData();
                    }
                },
                deleteProduct(name) {
                    if (confirm(`Sei sicuro di voler eliminare il prodotto '${name}'?`)) {
                        this.menuData.products = this.menuData.products.filter(p => p.nome !== name);
                        this.saveMenuData();
                    }
                },
                toggleFinished(name) {
                    const product = this.menuData.products.find(p => p.nome === name);
                    if (product) {
                        product.isFinished = !product.isFinished;
                        this.saveMenuData();
                    }
                },

                // --- SETTINGS METHODS: Modifiers ---
                addModifierCategory() {
                    if (this.newModifierCategoryName && !this.menuData.modifierCategories.includes(this.newModifierCategoryName)) {
                        this.menuData.modifierCategories.push(this.newModifierCategoryName);
                        this.newModifierCategoryName = '';
                        this.saveMenuData();
                    }
                },
                deleteModifierCategory(category) {
                    if (confirm(`Sei sicuro di voler eliminare la categoria di modificatori '${category}'? Tutti i modificatori associati saranno eliminati!`)) {
                        this.menuData.modifierCategories = this.menuData.modifierCategories.filter(c => c !== category);
                        this.menuData.modifiers = this.menuData.modifiers.filter(m => m.category !== category);
                        this.saveMenuData();
                    }
                },
                addModifier() {
                    if (this.newModifierName && this.selectedModCategory) {
                        if (this.menuData.modifiers.some(m => m.nome.toLowerCase() === this.newModifierName.toLowerCase())) {
                            alert("Un modificatore con questo nome esiste già.");
                            return;
                        }
                        this.menuData.modifiers.push({
                            nome: this.newModifierName,
                            prezzo: this.newModifierPrice,
                            category: this.selectedModCategory
                        });
                        this.newModifierName = '';
                        this.newModifierPrice = 0.00;
                        this.saveMenuData();
                    }
                },
                deleteModifier(name) {
                    if (confirm(`Sei sicuro di voler eliminare il modificatore '${name}'?`)) {
                        this.menuData.modifiers = this.menuData.modifiers.filter(m => m.nome !== name);
                        this.saveMenuData();
                    }
                },

                // --- SETTINGS METHODS: Zones ---
                addZone() {
                    if (this.newZoneName && this.newZonePrice >= 0) {
                        if (this.menuData.deliveryZones.some(z => z.name.toLowerCase() === this.newZoneName.toLowerCase())) {
                            alert("Una zona con questo nome esiste già.");
                            return;
                        }
                        this.menuData.deliveryZones.push({
                            name: this.newZoneName,
                            price: this.newZonePrice
                        });
                        this.newZoneName = '';
                        this.newZonePrice = 0.00;
                        this.saveMenuData();
                    }
                },
                deleteZone(name) {
                    if (confirm(`Sei sicuro di voler eliminare la zona di consegna '${name}'?`)) {
                        this.menuData.deliveryZones = this.menuData.deliveryZones.filter(z => z.name !== name);
                        this.saveMenuData();
                    }
                },

                // --- SETTINGS METHODS: Drivers ---
                addDriver() {
                    if (this.newDriverName && !this.menuData.drivers.includes(this.newDriverName)) {
                        this.menuData.drivers.push(this.newDriverName);
                        this.newDriverName = '';
                        this.saveMenuData();
                    }
                },
                deleteDriver(name) {
                    if (confirm(`Sei sicuro di voler eliminare il fattorino '${name}'?`)) {
                        this.menuData.drivers = this.menuData.drivers.filter(d => d !== name);
                        this.saveMenuData();
                    }
                }
            }
        });
    </script>
</body>
</html>
