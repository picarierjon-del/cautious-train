<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart - Gestione Ordini</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Stili Generali */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; height: 100vh; overflow: hidden; }
        #app { display: flex; width: 100%; height: 100%; }
        button { cursor: pointer; border: none; padding: 10px 15px; border-radius: 5px; transition: background-color 0.2s; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Layout Principale */
        .sidebar { width: 60px; background-color: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; padding-top: 20px; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
        .sidebar-item { padding: 15px 0; width: 100%; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        .sidebar-item:hover, .sidebar-item.active { background-color: #34495e; }
        .sidebar-item i { font-size: 20px; }
        .content { flex-grow: 1; display: flex; overflow: hidden; }

        /* Viste Principali */
        .view-container { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .view-header { border-bottom: 2px solid #ccc; padding-bottom: 15px; margin-bottom: 20px; }
        
        /* ------------------------------------- */
        /* VISTA INSERIMENTO (La Cassa) */
        /* ------------------------------------- */
        .inserimento-layout { display: flex; height: 100%; }
        .menu-panel { flex: 2; display: flex; flex-direction: column; padding-right: 20px; border-right: 1px solid #eee; }
        .cart-panel { flex: 1; display: flex; flex-direction: column; background-color: #ffffff; border-left: 1px solid #ddd; padding-left: 20px; }
        
        /* Menu */
        .menu-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .menu-categories button { background-color: #ecf0f1; color: #2c3e50; padding: 8px 12px; font-size: 0.9em; }
        .menu-categories button.active { background-color: #3498db; color: white; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; overflow-y: auto; padding-top: 10px; flex-grow: 1; }
        .menu-item { background-color: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); transition: transform 0.1s, box-shadow 0.1s; position: relative; }
        .menu-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .menu-item.selected { border: 3px solid #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
        .menu-item.finished { opacity: 0.5; cursor: not-allowed; background-color: #fdd; }
        .item-price { font-size: 1.1em; font-weight: bold; color: #27ae60; margin-top: 5px; }
        .item-name { font-size: 0.9em; height: 3em; overflow: hidden; margin-bottom: 5px;}
        .finished-badge { position: absolute; top: 0; left: 0; background-color: #e74c3c; color: white; padding: 2px 5px; border-radius: 5px 0 5px 0; font-size: 0.7em; }

        /* Modificatori */
        .modifiers-panel { margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px; }
        .modifier-categories button { background-color: #f1c40f; color: #2c3e50; margin-right: 5px; padding: 5px 10px; font-size: 0.8em; }
        .modifier-categories button.active { background-color: #f39c12; color: white; }
        .modifier-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; max-height: 150px; overflow-y: auto; padding-right: 5px; }
        .modifier-item { background-color: #ecf0f1; padding: 8px; border-radius: 5px; font-size: 0.8em; }
        .modifier-item:hover { background-color: #bdc3c7; }
        
        /* Carrello */
        .cart-list { flex-grow: 1; overflow-y: auto; margin-top: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px dotted #ddd; cursor: pointer; }
        .cart-item.selected { background-color: #fef0f0; border-left: 3px solid #e74c3c; padding-left: 7px; }
        .cart-item-info { flex-grow: 1; margin-right: 10px; }
        .cart-item-name { font-weight: bold; font-size: 1em; }
        .cart-item-modifiers { font-size: 0.8em; color: #7f8c8d; }
        .cart-item-price { font-weight: bold; color: #e74c3c; flex-shrink: 0; display: flex; align-items: center; }
        .remove-item-btn { background: none; color: #e74c3c; padding: 0 5px; font-size: 1.2em; margin-left: 10px; }
        
        .cart-total { border-top: 2px solid #2c3e50; padding-top: 15px; margin-top: 10px; font-size: 1.5em; font-weight: bold; text-align: right; }
        .finalize-btn { background-color: #27ae60; color: white; width: 100%; margin-top: 10px; padding: 15px; }
        .finalize-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Icone Modificatori */
        .mod-icon { margin-right: 3px; font-size: 0.9em; }

        /* ------------------------------------- */
        /* VISTA ORDINI ATTIVI */
        /* ------------------------------------- */
        .orders-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; }
        .order-filter-buttons button { background-color: #bdc3c7; color: #2c3e50; }
        .order-filter-buttons button.active { background-color: #3498db; color: white; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; overflow-y: auto; padding-bottom: 20px; }
        .order-card { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); padding: 15px; display: flex; flex-direction: column; }
        .order-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .order-info { font-size: 0.9em; color: #7f8c8d; }
        .order-details { list-style: none; padding: 0; margin: 5px 0 10px 0; max-height: 100px; overflow-y: auto; }
        .order-details li { font-size: 0.9em; padding: 2px 0; }
        .order-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #eee; }
        .order-status { text-align: center; font-weight: bold; padding: 5px; border-radius: 5px; margin-bottom: 10px; }
        .status-Preparazione { background-color: #f1c40f; color: #2c3e50; }
        .status-In_Cottura { background-color: #e67e22; color: white; }
        .status-Pronto_In_Consegna { background-color: #2ecc71; color: white; }
        .status-Archivia_Ordine { background-color: #c0392b; color: white; }
        .advance-btn { width: 100%; padding: 12px; background-color: #3498db; color: white; margin-top: 5px; }
        .order-total { font-size: 1.2em; font-weight: bold; text-align: right; margin-top: 5px; }
        .future-order { border: 2px dashed #95a5a6; }
        .near-order { border: 2px solid #e67e22; }
        .urgent-order { border: 3px solid #e74c3c; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        
        /* ------------------------------------- */
        /* VISTA STORICO */
        /* ------------------------------------- */
        .archive-controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; }
        .archive-list { max-height: calc(100vh - 200px); overflow-y: auto; }
        .archive-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background-color: #fff; margin-bottom: 5px; border-radius: 5px; }
        .archive-info { flex: 2; }
        .archive-info h4 { margin: 0 0 5px 0; font-size: 1.1em; }
        .archive-info p { margin: 0; font-size: 0.9em; color: #7f8c8d; }
        .archive-actions { flex: 1; text-align: right; }
        .archive-total { font-weight: bold; font-size: 1.2em; color: #27ae60; margin-right: 15px; }
        .stats-panel { background-color: #ecf0f1; padding: 15px; border-radius: 8px; margin-top: 15px; display: flex; justify-content: space-around; }
        .stat-item { text-align: center; }
        .stat-item p { margin: 0; font-size: 1.5em; font-weight: bold; color: #3498db; }
        .stat-item span { font-size: 0.9em; color: #7f8c8d; }

        /* ------------------------------------- */
        /* VISTA IMPOSTAZIONI */
        /* ------------------------------------- */
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
        .settings-section { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .settings-section h3 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .settings-list { max-height: 200px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .settings-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #eee; }
        .settings-list-item:last-child { border-bottom: none; }
        .item-status-btn { padding: 5px 10px; font-size: 0.8em; }
        .status-available { background-color: #2ecc71; color: white; }
        .status-finished { background-color: #e74c3c; color: white; }
        .delete-btn { background-color: #e74c3c; color: white; margin-left: 10px; }
        
        /* ------------------------------------- */
        /* MODAL */
        /* ------------------------------------- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-container { background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .modal-content { display: flex; gap: 30px; }
        .modal-form { flex: 2; }
        .modal-summary { flex: 1; background-color: #f9f9f9; padding: 15px; border-radius: 8px; }
        .modal-actions { margin-top: 20px; text-align: right; }
        
        .mode-selection { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; background-color: #ecf0f1; color: #2c3e50; padding: 15px; }
        .mode-btn.active { background-color: #2980b9; color: white; }
        
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-row > * { flex: 1; }
        .full-width { width: 100%; }
        
        .capacity-bar { height: 10px; background-color: #ccc; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .capacity-fill { height: 100%; background-color: #2ecc71; transition: width 0.3s; }
        .capacity-warning .capacity-fill { background-color: #f39c12; }
        .capacity-full .capacity-fill { background-color: #e74c3c; }
        .capacity-info { margin-top: 5px; font-size: 0.9em; }

        .summary-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9em; }
        .summary-total { font-size: 1.5em; font-weight: bold; border-top: 2px solid #2c3e50; padding-top: 10px; margin-top: 10px; }

        /* Composizione Modals (Mezzo Metro/Pizza a Metà) */
        .composition-modal-container { max-width: 1000px; }
        .composition-content { display: flex; gap: 20px; }
        .composition-sections { flex: 1; }
        .composition-selection { flex: 2; }

        .composition-card { background-color: #f4f4f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent; }
        .composition-card.active-section { border-color: #3498db; background-color: #eaf6ff; }
        .composition-card h4 { margin: 0 0 5px 0; display: flex; justify-content: space-between; align-items: center; }
        .composition-card .gusto-info { font-weight: normal; color: #27ae60; font-size: 0.9em; }
        .composition-card .mod-info { font-size: 0.8em; color: #7f8c8d; margin-top: 5px; }
        .composition-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .mod-remove-btn { color: #e74c3c; background: none; padding: 0; font-size: 0.8em; margin-left: 5px; }
        
        .pizza-half-selection { display: flex; gap: 15px; margin-bottom: 15px; }
        .pizza-half-btn { flex: 1; padding: 15px; background-color: #f1c40f; color: #2c3e50; }
        .pizza-half-btn.active { background-color: #f39c12; color: white; }

        .price-edit-modal-container { max-width: 400px; }
        
        /* Modale di Accesso */
        .login-container { display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100%; width: 100%; background-color: #fff; }
        .login-box { padding: 40px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); text-align: center; }
        .login-box input { margin: 10px 0; width: 100%; }
        .login-box button { width: 100%; background-color: #3498db; color: white; }

        /* Utilità per la Stampa */
        #print-content-comanda, #print-content-scontrino { display: none; } /* Nascosti nell'HTML normale */
    </style>
</head>
<body>

<div id="app">

    <div class="sidebar">
        <div class="sidebar-item" :class="{ active: view === 'inserimento' }" @click="view = 'inserimento'" title="Cassa">
            <i class="fa-solid fa-cash-register"></i>
        </div>
        <div class="sidebar-item" :class="{ active: view === 'ordini' }" @click="view = 'ordini'" title="Ordini Attivi">
            <i class="fa-solid fa-list-check"></i>
        </div>
        <div class="sidebar-item" :class="{ active: view === 'storico' }" @click="view = 'storico'" title="Storico">
            <i class="fa-solid fa-clock-rotate-left"></i>
        </div>
        <div class="sidebar-item" :class="{ active: view === 'impostazioni' }" @click="view = 'impostazioni'" title="Impostazioni">
            <i class="fa-solid fa-gears"></i>
        </div>
        <div class="sidebar-item" @click="logout" title="Logout" style="margin-top: auto; margin-bottom: 20px;">
            <i class="fa-solid fa-right-from-bracket"></i>
        </div>
    </div>

    <div class="content">

        <div class="login-container" v-if="!isAccessGranted && (view === 'ordini' || view === 'storico' || view === 'impostazioni')">
            <div class="login-box">
                <h2>Accesso Richiesto</h2>
                <p>Inserisci il PIN/Password per accedere a questa sezione.</p>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="PIN/Password" maxlength="4">
                <button @click="grantAccess"><i class="fa-solid fa-unlock"></i> Accedi</button>
                <p v-if="view === 'impostazioni'" style="font-size: 0.9em; margin-top: 15px;">Solo l'Accesso Titolare permette la modifica delle Impostazioni.</p>
            </div>
        </div>

        <div class="inserimento-layout" v-show="view === 'inserimento' && isAccessGranted">
            
            <div class="menu-panel">
                <div class="menu-header">
                    <input type="text" v-model="searchTerm" placeholder="Cerca articolo..." class="full-width">
                </div>
                
                <div class="menu-categories" style="overflow-x: auto; white-space: nowrap; padding-bottom: 5px;">
                    <button v-for="(items, category) in menu" :key="category" @click="activeCat = category; searchTerm = ''" :class="{ active: activeCat === category }">
                        {{ category }}
                    </button>
                </div>

                <div class="menu-grid">
                    <div v-for="(item, index) in filteredAvailableItems" :key="index" 
                        class="menu-item" 
                        :class="{ selected: lastSelectedItem === item, finished: item.isFinished }" 
                        @click="handleItemClick(item)">
                        <span v-if="item.isFinished" class="finished-badge">Esaurito</span>
                        <div class="item-name">{{ item.nome }}</div>
                        <div class="item-price" v-if="!item.isHalfPizza">€{{ item.prezzo.toFixed(2) }}</div>
                        <div class="item-price" v-else>Componi</div>
                    </div>
                </div>

                <div class="modifiers-panel" v-if="selectedItemIndex !== null && !order[selectedItemIndex].isMeter && !order[selectedItemIndex].isHalfPizza">
                    <h4>Modificatori Articolo Selezionato</h4>
                    
                    <div class="modifier-categories">
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." style="width: 100%; margin-bottom: 10px;">
                        <button v-for="(mods, category) in modifiers" :key="category" @click="activeModCat = category; modifierSearchTerm = ''" :class="{ active: activeModCat === category }">
                            {{ category }}
                        </button>
                    </div>

                    <div class="modifier-grid">
                        <button v-for="(mod, index) in filteredModifiersForActiveCat" :key="index" 
                            class="modifier-item" 
                            :class="{ finished: mod.isFinished }" 
                            :disabled="mod.isFinished" 
                            @click="addExtra(mod)">
                            {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="cart-panel">
                <h3>Carrello ({{ order.length }} articoli)</h3>
                
                <div class="cart-list">
                    <div v-for="(item, index) in order" :key="index" 
                        class="cart-item" 
                        :class="{ selected: selectedItemIndex === index }"
                        @click="selectItem(index)">
                        
                        <div class="cart-item-info">
                            <div class="cart-item-name">{{ item.nome }} 
                                <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                                <span v-else-if="item.isMeter">({{ item.sections.length }} sezioni)</span>
                            </div>
                            
                            <div class="cart-item-modifiers">
                                <span v-if="!item.isMeter && !item.isHalfPizza && item.modifiers && item.modifiers.length > 0">
                                    {{ item.modifiers.map(mod => getModifierIcon(getModifierCategory(mod.nome)) + mod.nome).join(', ') }}
                                </span>
                                <span v-else-if="item.isHalfPizza">
                                    Metà 1: {{ item.modifiers1.map(mod => getModifierIcon(getModifierCategory(mod.nome)) + mod.nome).join(', ') }}
                                    <br> Metà 2: {{ item.modifiers2.map(mod => getModifierIcon(getModifierCategory(mod.nome)) + mod.nome).join(', ') }}
                                </span>
                                <span v-else-if="item.isMeter">
                                    <span v-for="(section, sIndex) in item.sections" :key="sIndex">
                                        {{ section.gusto }} ({{ section.modifiers.map(mod => getModifierIcon(getModifierCategory(mod.nome)) + mod.nome).join(', ') }})<br>
                                    </span>
                                </span>
                            </div>
                        </div>

                        <div class="cart-item-price">
                            <span @click.stop="openPriceEditModal(index)">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                            <button class="remove-item-btn" @click.stop="removeItem(index)"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>

                <div class="cart-total">
                    TOTALE: €{{ calculatedOrderTotal.toFixed(2) }}
                </div>
                <button class="finalize-btn" @click="openModal()" :disabled="order.length === 0">
                    <i class="fa-solid fa-circle-check"></i> Finalizza Ordine
                </button>
            </div>
        </div>
        
        <div class="view-container" v-show="view === 'ordini' && isAdmin">
            <h1 class="view-header">Ordini Attivi ({{ filteredActiveOrders.length }})</h1>
            
            <div class="orders-controls">
                <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Tavolo, Indirizzo..." style="flex: 1;">
                <div class="order-filter-buttons">
                    <button :class="{ active: activeDateFilter === 'today' }" @click="activeDateFilter = 'today'">Oggi</button>
                    <button :class="{ active: activeDateFilter === 'tomorrow' }" @click="activeDateFilter = 'tomorrow'">Domani</button>
                    <button :class="{ active: activeDateFilter === 'future' }" @click="activeDateFilter = 'future'">Futuri</button>
                </div>
            </div>

            <div class="orders-grid">
                <div v-for="order in filteredActiveOrders" :key="order.id" 
                    class="order-card"
                    :class="{ 'future-order': isFutureOrder(order), 'near-order': isNear(order), 'urgent-order': isUrgent(order) }">
                    
                    <div class="order-header">
                        <span style="font-size: 1.2em; font-weight: bold;">#{{ order.id }} - {{ order.customer }}</span>
                        <div class="order-info">
                            <span v-if="order.mode === 'banco'">Tavolo: {{ order.tableNumber || 'N/A' }}</span>
                            <span v-else-if="order.mode === 'asporto'">Asporto ({{ order.hour }})</span>
                            <span v-else-if="order.mode === 'consegna'">Consegna ({{ order.hour }})</span>
                        </div>
                    </div>
                    
                    <ul class="order-details">
                        <li v-for="(item, index) in order.items" :key="index" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            1x {{ item.nome }} 
                            <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                            <span v-if="item.isMeter">({{ item.sections.length }} sezioni)</span>
                        </li>
                    </ul>

                    <div class="order-footer">
                        <div :class="['order-status', 'status-' + order.status.replace(/ /g, '_').replace(/\//g, '_')]">{{ order.status }}</div>
                        
                        <div class="form-row" v-if="order.mode === 'consegna'">
                            <select :value="order.driver" @change="updateActiveOrderDriver(order.id, $event.target.value)">
                                <option value="">Assegna Fattorino</option>
                                <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                            </select>
                            <button class="mode-btn" @click="showShareMenu(order.id)" title="Condividi Ordine"><i class="fa-brands fa-whatsapp"></i></button>
                        </div>
                        
                        <div class="form-row" style="gap: 5px;">
                            <button style="flex: 1; background-color: #f1c40f;" @click="editOrder(order.id)" title="Modifica"><i class="fa-solid fa-pen"></i></button>
                            <button style="flex: 1; background-color: #95a5a6;" @click="duplicateOrder(order)" title="Duplica"><i class="fa-solid fa-copy"></i></button>
                            <button style="flex: 1; background-color: #e67e22;" @click="printOrder(order.id, 'comanda')" title="Stampa Comanda"><i class="fa-solid fa-print"></i></button>
                            <button style="flex: 1; background-color: #c0392b;" @click="printOrder(order.id, 'scontrino')" title="Stampa Scontrino"><i class="fa-solid fa-receipt"></i></button>
                        </div>
                        
                        <button class="advance-btn" @click="advance(order)">
                            {{ getNextStatus(order.status) }} <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        
                        <div class="order-total">Totale: €{{ order.total.toFixed(2) }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-container" v-show="view === 'storico' && isAdmin">
            <h1 class="view-header">Storico Ordini Archiviati</h1>
            
            <div class="archive-controls">
                <label for="archive-date-filter">Seleziona Data:</label>
                <input type="date" id="archive-date-filter" v-model="archiveDateFilter" @change="calculateDriverStats">
                
                <label for="driver-filter">Fattorino:</label>
                <select id="driver-filter" v-model="selectedDriver" @change="calculateDriverStats">
                    <option value="">Tutti</option>
                    <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                </select>
            </div>
            
            <div class="stats-panel">
                <div class="stat-item">
                    <span>Totale Incasso Giornaliero</span>
                    <p>€{{ dailyTotal.toFixed(2) }}</p>
                </div>
                <div class="stat-item">
                    <span>Ordini ({{ selectedDriver || 'Tutti' }})</span>
                    <p>{{ driverStats.totalOrders }}</p>
                </div>
                <div class="stat-item">
                    <span>Incasso Fattorino</span>
                    <p>€{{ driverStats.totalRevenue.toFixed(2) }}</p>
                </div>
            </div>

            <div class="archive-list">
                <div v-for="order in filteredArchive" :key="order.id" class="archive-item">
                    <div class="archive-info">
                        <h4>#{{ order.id }} | {{ order.customer }} ({{ order.mode.toUpperCase() }})</h4>
                        <p>Orario: {{ order.hour }} | Totale: €{{ order.total.toFixed(2) }}</p>
                        <p v-if="order.mode === 'consegna'">Consegna: {{ order.address }} | Zona: {{ order.zone }}</p>
                        <p v-if="order.driver">Fattorino: {{ order.driver }}</p>
                    </div>
                    
                    <div class="archive-actions">
                        <select :value="order.driver" @change="updateArchiveDriver(order.id, $event.target.value)">
                            <option value="">Assegna Fattorino</option>
                            <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                        <button class="mode-btn" @click="printOrder(order.id, 'scontrino')" style="background-color: #2c3e50; color: white;"><i class="fa-solid fa-receipt"></i> Stampa</button>
                    </div>
                </div>
                <p v-if="filteredArchive.length === 0" style="text-align: center; margin-top: 20px;">Nessun ordine archiviato per questa data.</p>
            </div>
        </div>

        <div class="view-container" v-show="view === 'impostazioni' && isOwner">
            <h1 class="view-header">Impostazioni e Gestione Dati</h1>
            
            <div class="settings-grid">
                
                <div class="settings-section">
                    <h3>Gestione Menu Articoli</h3>
                    
                    <div class="form-group">
                        <label for="menu-cat-select">Categoria Attiva:</label>
                        <select id="menu-cat-select" v-model="activeSettingsCat" class="full-width">
                            <option v-for="(items, category) in menu" :key="category" :value="category">{{ category }}</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-row">
                        <input type="text" v-model="newItemName" placeholder="Nome Articolo" style="flex: 2;">
                        <input type="number" v-model.number="newItemPrice" placeholder="Prezzo" style="flex: 1;" min="0" step="0.01">
                        <button @click="addItemToCategory" style="background-color: #3498db; color: white;"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    
                    <div class="settings-list">
                        <div v-for="(item, index) in menu[activeSettingsCat]" :key="index" class="settings-list-item">
                            <span>{{ item.nome }} (€{{ item.prezzo.toFixed(2) }})</span>
                            <div>
                                <button class="item-status-btn" :class="item.isFinished ? 'status-finished' : 'status-available'" @click="toggleItemFinished(activeSettingsCat, index)">
                                    {{ item.isFinished ? 'ESAURITO' : 'DISPONIBILE' }}
                                </button>
                                <button class="delete-btn" @click="deleteItem(activeSettingsCat, index)"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group form-row" style="margin-top: 15px;">
                        <input type="text" v-model="newCategoryName" placeholder="Nuova Categoria" style="flex: 2;">
                        <button @click="addCategory" style="background-color: #27ae60; color: white;"><i class="fa-solid fa-folder-plus"></i></button>
                        <button @click="deleteCategory(activeSettingsCat)" class="delete-btn" :disabled="Object.keys(menu).length <= 1"><i class="fa-solid fa-trash-can"></i> Cat</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Gestione Modificatori</h3>
                    
                    <div class="form-group">
                        <label for="mod-cat-select">Categoria Attiva:</label>
                        <select id="mod-cat-select" v-model="activeSettingsModCat" class="full-width">
                            <option v-for="(mods, category) in modifiers" :key="category" :value="category">{{ category }}</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-row">
                        <input type="text" v-model="newModifierName" placeholder="Nome Modificatore" style="flex: 2;">
                        <input type="number" v-model.number="newModifierPrice" placeholder="Prezzo" style="flex: 1;" min="0" step="0.01">
                        <button @click="addModifierToCategory" style="background-color: #3498db; color: white;"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    
                    <div class="settings-list">
                        <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" class="settings-list-item">
                            <span>{{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span></span>
                            <div>
                                <button class="item-status-btn" :class="mod.isFinished ? 'status-finished' : 'status-available'" @click="toggleModifierFinished(activeSettingsModCat, index)">
                                    {{ mod.isFinished ? 'ESAURITO' : 'DISPONIBILE' }}
                                </button>
                                <button class="delete-btn" @click="deleteModifier(activeSettingsModCat, index)"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group form-row" style="margin-top: 15px;">
                        <input type="text" v-model="newModifierCategoryName" placeholder="Nuova Categoria Mod." style="flex: 2;">
                        <button @click="addModifierCategory" style="background-color: #27ae60; color: white;"><i class="fa-solid fa-folder-plus"></i></button>
                        <button @click="deleteModifierCategory(activeSettingsModCat)" class="delete-btn" :disabled="isDefaultModifierCategory(activeSettingsModCat)"><i class="fa-solid fa-trash-can"></i> Cat</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Consegna e Logistica</h3>
                    
                    <h4>Fattorini</h4>
                    <div class="form-group form-row">
                        <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" class="full-width">
                        <button @click="addDriver" style="background-color: #3498db; color: white;"><i class="fa-solid fa-user-plus"></i></button>
                    </div>
                    <div class="settings-list" style="max-height: 100px;">
                        <div v-for="(driver, index) in drivers" :key="index" class="settings-list-item">
                            <span>{{ driver }}</span>
                            <button class="delete-btn" @click="deleteDriver(index)"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 15px;">Zone di Consegna</h4>
                    <div class="form-group form-row">
                        <input type="text" v-model="newZoneName" placeholder="Nome Zona" style="flex: 2;">
                        <input type="number" v-model.number="newZonePrice" placeholder="Costo" style="flex: 1;" min="0" step="0.01">
                        <button @click="addZone" style="background-color: #27ae60; color: white;"><i class="fa-solid fa-map-location-dot"></i></button>
                    </div>
                    <div class="settings-list" style="max-height: 100px;">
                        <div v-for="(zone, index) in deliveryZones" :key="index" class="settings-list-item">
                            <span>{{ zone.name }} (€{{ zone.price.toFixed(2) }})</span>
                            <button class="delete-btn" @click="deleteZone(index)"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>Sistema e Sicurezza</h3>

                    <h4 style="margin-top: 0;">PIN/Password</h4>
                    <div class="form-group">
                        <label>Nuovo PIN Operatore (Attuale: {{ adminPin }})</label>
                        <div class="form-row">
                            <input type="password" v-model="newAdminPin" placeholder="Nuovo PIN (min. 4 cifre)" maxlength="4">
                            <button @click="saveAdminPin" style="background-color: #f39c12; color: white;"><i class="fa-solid fa-save"></i> Salva</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nuovo PIN Titolare (Attuale: {{ ownerPin }})</label>
                        <div class="form-row">
                            <input type="password" v-model="newOwnerPin" placeholder="Nuovo PIN (min. 4 cifre)" maxlength="4">
                            <button @click="saveOwnerPin" style="background-color: #e67e22; color: white;"><i class="fa-solid fa-save"></i> Salva</button>
                        </div>
                    </div>

                    <h4 style="margin-top: 15px;">Capacità Forno</h4>
                    <div class="form-group form-row">
                        <div style="flex: 1;">
                            <label>Pizze Max per Slot:</label>
                            <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" step="1">
                        </div>
                        <div style="flex: 1;">
                            <label>Durata Slot (min.):</label>
                            <input type="number" v-model.number="capacitySettings.intervalMinutes" min="5" step="5">
                        </div>
                    </div>
                    <p style="font-size: 0.9em; color: #7f8c8d;">Imposta la capacità produttiva massima della pizzeria.</p>
                    
                    <h4 style="margin-top: 15px;">Backup e Dati</h4>
                    <div class="form-row">
                        <button @click="exportData" style="background-color: #2980b9; color: white;"><i class="fa-solid fa-file-export"></i> Esporta Dati</button>
                        <button @click="importData" style="background-color: #9b59b6; color: white;"><i class="fa-solid fa-file-import"></i> Importa Dati</button>
                    </div>
                    <button @click="clearCache" class="delete-btn full-width" style="margin-top: 10px; background-color: #c0392b;">
                        <i class="fa-solid fa-broom"></i> Pulisci Ordini/Storico (Conserva Menu e PIN)
                    </button>
                </div>

            </div>
        </div>

    </div>
    
    <div class="modal-overlay" v-if="showModal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Finalizza Nuovo Ordine' }}</h2>
                <button class="delete-btn" @click="cancelEdit"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-content">
                <div class="modal-form">
                    
                    <h4>Modalità</h4>
                    <div class="mode-selection">
                        <button v-for="m in modes" :key="m.id" :class="{ 'mode-btn': true, active: mode === m.id }" @click="selectMode(m.id)">
                            <i :class="m.icon"></i> {{ m.label }}
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="customer">Cliente / Riferimento *</label>
                        <input type="text" id="customer" v-model="customer" @input="filterCustomers" placeholder="Nome Cliente o Riferimento" class="full-width">
                        <div v-if="filteredCustomerSuggestions.length > 0" style="border: 1px solid #ddd; border-top: none; max-height: 150px; overflow-y: auto; background-color: white;">
                            <div v-for="(data, index) in filteredCustomerSuggestions" :key="index" @click="loadCustomerData(data)" style="padding: 8px; border-bottom: 1px dotted #eee; cursor: pointer; font-size: 0.9em;">
                                <strong>{{ data.customer }}</strong> ({{ data.phone || data.address }})
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date">Data Ritiro/Consegna</label>
                            <input type="date" id="date" v-model="date" :min="minDate" @change="updateCapacityWarning">
                        </div>
                        <div class="form-group">
                            <label for="hour">Ora Ritiro/Consegna</label>
                            <input type="time" id="hour" v-model="hour" @change="updateCapacityWarning">
                        </div>
                    </div>

                    <div class="form-group" v-if="date && hour">
                        <label for="capacity-info">Stato Forno per {{ hour }}</label>
                        <div :class="['capacity-bar', { 'capacity-warning': isCapacityWarning, 'capacity-full': isCapacityFull }]">
                            <div class="capacity-fill" :style="{ width: (orderCapacity.total / capacitySettings.maxPizzas * 100) + '%' }"></div>
                        </div>
                        <p class="capacity-info" :style="{ color: isCapacityFull ? '#e74c3c' : (isCapacityWarning ? '#f39c12' : '#2ecc71') }">
                            Pizze nello slot: {{ orderCapacity.total }} / {{ capacitySettings.maxPizzas }} (Rimanenti: {{ orderCapacity.remaining }})
                        </p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone">Telefono</label>
                            <input type="text" id="phone" v-model="phone" placeholder="Numero di Telefono">
                        </div>
                        <div class="form-group" v-if="mode === 'banco' || mode === 'asporto'">
                            <label for="tableNumber">{{ mode === 'banco' ? 'Numero Tavolo' : 'Rif. Ritiro' }}</label>
                            <input type="text" id="tableNumber" v-model="tableNumber" :placeholder="mode === 'banco' ? 'Es. 12' : 'Es. Rossi'">
                        </div>
                    </div>

                    <div v-if="mode === 'consegna'">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="address">Via *</label>
                                <input type="text" id="address" v-model="address" placeholder="Via/Piazza">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="streetNumber">Civico</label>
                                <input type="text" id="streetNumber" v-model="streetNumber" placeholder="N°">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="zoneName">Zona * (Costo: €{{ deliveryCost.toFixed(2) }})</label>
                                <select id="zoneName" v-model="zoneName" @change="updateDeliveryCost">
                                    <option value="">Seleziona Zona</option>
                                    <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">{{ zone.name }} (€{{ zone.price.toFixed(2) }})</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="town">Città</label>
                                <input type="text" id="town" v-model="town" placeholder="Città" disabled>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Note Ordine (es. intolleranze, richieste speciali)</label>
                        <textarea id="notes" v-model="notes" rows="3" class="full-width" placeholder="Note..."></textarea>
                    </div>

                </div>

                <div class="modal-summary">
                    <h4>Riepilogo</h4>
                    <div class="summary-list">
                        <div v-for="(item, index) in order" :key="index" class="summary-item">
                            <span>1x {{ item.nome }}</span>
                            <span>€{{ calculateItemTotal(item).toFixed(2) }}</span>
                        </div>
                    </div>
                    
                    <div v-if="deliveryCost > 0" class="summary-item" style="margin-top: 10px;">
                        <span>Costo Consegna ({{ zoneName }})</span>
                        <span>+ €{{ deliveryCost.toFixed(2) }}</span>
                    </div>

                    <div class="summary-total">
                        TOTALE: €{{ total.toFixed(2) }}
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="accontoRicevuto">Acconto Ricevuto</label>
                        <input type="number" id="accontoRicevuto" v-model.number="accontoRicevuto" min="0" step="0.01" placeholder="Importo ricevuto">
                    </div>
                    <div v-if="restoDaDare > 0" class="summary-item" style="color: #e74c3c; font-weight: bold;">
                        <span>RESTO DA DARE</span>
                        <span>€{{ restoDaDare.toFixed(2) }}</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button @click="cancelEdit" style="background-color: #95a5a6; color: white; margin-right: 10px;"><i class="fa-solid fa-xmark"></i> Annulla</button>
                <button @click="confermaOrdine" style="background-color: #27ae60; color: white;" :disabled="order.length === 0 || !customer.trim()">
                    <i class="fa-solid fa-save"></i> {{ editingOrderId ? 'Salva Modifiche' : 'Conferma Ordine' }}
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showMeterModal">
        <div class="modal-container composition-modal-container">
            <div class="modal-header">
                <h2>Componi {{ tempMeterItem?.nome }}</h2>
                <button class="delete-btn" @click="cancelMeterComposition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="composition-content">
                <div class="composition-sections">
                    <div v-for="(section, sIndex) in tempMeterItem.sections" :key="sIndex"
                        class="composition-card"
                        :class="{ 'active-section': section.activeSection }"
                        @click="section.activeSection = true; tempMeterItem.sections.forEach((s, i) => { if (i !== sIndex) s.activeSection = false; })">
                        
                        <h4>{{ section.name }}
                            <span class="gusto-info" v-if="section.gusto">{{ section.gusto }}</span>
                            <span class="gusto-info" v-else>SELEZIONA GUSTO</span>
                        </h4>
                        
                        <div v-if="section.modifiers.length > 0" class="mod-info">
                            Modificatori: 
                            <span v-for="(mod, mIndex) in section.modifiers" :key="mIndex">
                                {{ mod.nome }} 
                                <button class="mod-remove-btn" @click.stop="section.modifiers.splice(mIndex, 1)"><i class="fa-solid fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    
                    <div class="summary-total" style="font-size: 1.2em;">
                        Totale: €{{ calculateTempMeterTotal.toFixed(2) }}
                    </div>
                </div>
                
                <div class="composition-selection">
                    
                    <div v-for="(section, sIndex) in tempMeterItem.sections" :key="sIndex">
                        <div v-if="section.activeSection">
                            <h4>Seleziona Gusto per {{ section.name }}</h4>
                            <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto pizza..." class="full-width" style="margin-bottom: 10px;">
                            <div class="menu-grid" style="max-height: 250px;">
                                <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                    class="menu-item" 
                                    @click="selectMeterGusto(sIndex, gusto.nome)">
                                    <div class="item-name">{{ gusto.nome }}</div>
                                    <div class="item-price">€{{ gusto.prezzo.toFixed(2) }}</div>
                                </div>
                            </div>

                            <h4 style="margin-top: 15px;">Aggiungi Modificatore</h4>
                            <div class="modifier-categories">
                                <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." style="width: 100%; margin-bottom: 10px;">
                                <button v-for="(mods, category) in modifiers" :key="category" @click="tempModCat = category; modifierSearchTerm = ''" :class="{ active: tempModCat === category }">
                                    {{ category }}
                                </button>
                            </div>
                            <div class="modifier-grid" style="max-height: 150px;">
                                <button v-for="(mod, index) in filteredTempModifiers" :key="index" 
                                    class="modifier-item" 
                                    :class="{ finished: mod.isFinished }" 
                                    :disabled="mod.isFinished" 
                                    @click="addMeterModifier(sIndex, mod)">
                                    {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-actions composition-actions">
                <button @click="cancelMeterComposition" style="background-color: #95a5a6; color: white;"><i class="fa-solid fa-xmark"></i> Annulla</button>
                <button @click="addMeterToOrder" style="background-color: #27ae60; color: white;" :disabled="!isMeterValid">
                    <i class="fa-solid fa-save"></i> Salva Composizione
                </button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showHalfPizzaModal">
        <div class="modal-container composition-modal-container">
            <div class="modal-header">
                <h2>Componi Pizza a Metà</h2>
                <button class="delete-btn" @click="cancelHalfPizzaComposition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="composition-content">
                <div class="composition-sections">
                    <div class="composition-card" :class="{ 'active-section': tempHalfPizzaItem.activeHalf === 1 }" @click="tempHalfPizzaItem.activeHalf = 1">
                        <h4>Metà 1: {{ tempHalfPizzaItem.gusto1 || 'SELEZIONA GUSTO' }}</h4>
                        <div v-if="tempHalfPizzaItem.modifiers1.length > 0" class="mod-info">
                            Modificatori: 
                            <span v-for="(mod, mIndex) in tempHalfPizzaItem.modifiers1" :key="mIndex">
                                {{ mod.nome }} 
                                <button class="mod-remove-btn" @click.stop="tempHalfPizzaItem.modifiers1.splice(mIndex, 1)"><i class="fa-solid fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    
                    <div class="composition-card" :class="{ 'active-section': tempHalfPizzaItem.activeHalf === 2 }" @click="tempHalfPizzaItem.activeHalf = 2">
                        <h4>Metà 2: {{ tempHalfPizzaItem.gusto2 || 'SELEZIONA GUSTO' }}</h4>
                        <div v-if="tempHalfPizzaItem.modifiers2.length > 0" class="mod-info">
                            Modificatori: 
                            <span v-for="(mod, mIndex) in tempHalfPizzaItem.modifiers2" :key="mIndex">
                                {{ mod.nome }} 
                                <button class="mod-remove-btn" @click.stop="tempHalfPizzaItem.modifiers2.splice(mIndex, 1)"><i class="fa-solid fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                    
                    <div class="summary-total" style="font-size: 1.2em;">
                        Totale Stimato: €{{ calculateTempHalfPizzaTotal.toFixed(2) }}
                    </div>
                </div>

                <div class="composition-selection">
                    
                    <div v-if="tempHalfPizzaItem.activeHalf === 1 || tempHalfPizzaItem.activeHalf === 2">
                        <h4>Seleziona Gusto per Metà {{ tempHalfPizzaItem.activeHalf }}</h4>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca gusto pizza..." class="full-width" style="margin-bottom: 10px;">
                        <div class="menu-grid" style="max-height: 250px;">
                            <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                class="menu-item" 
                                @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)">
                                <div class="item-name">{{ gusto.nome }}</div>
                                <div class="item-price">€{{ gusto.prezzo.toFixed(2) }}</div>
                            </div>
                        </div>
                    </div>

                    <div v-if="tempHalfPizzaItem.gusto1 && tempHalfPizzaItem.gusto2 && (tempHalfPizzaItem.activeHalf === 1 || tempHalfPizzaItem.activeHalf === 2)">
                        <h4 style="margin-top: 15px;">Aggiungi Modificatore a Metà {{ tempHalfPizzaItem.activeHalf }}</h4>
                        <div class="modifier-categories">
                            <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." style="width: 100%; margin-bottom: 10px;">
                            <button v-for="(mods, category) in modifiers" :key="category" @click="tempModCat = category; modifierSearchTerm = ''" :class="{ active: tempModCat === category }">
                                {{ category }}
                            </button>
                        </div>
                        <div class="modifier-grid" style="max-height: 150px;">
                            <button v-for="(mod, index) in filteredTempModifiers" :key="index" 
                                class="modifier-item" 
                                :class="{ finished: mod.isFinished }" 
                                :disabled="mod.isFinished" 
                                @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)">
                                {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-actions composition-actions">
                <button @click="cancelHalfPizzaComposition" style="background-color: #95a5a6; color: white;"><i class="fa-solid fa-xmark"></i> Annulla</button>
                <button @click="addHalfPizzaToOrder" style="background-color: #27ae60; color: white;" :disabled="!isHalfPizzaValid">
                    <i class="fa-solid fa-save"></i> Salva Composizione
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" v-if="showPriceEditModal">
        <div class="modal-container price-edit-modal-container">
            <div class="modal-header">
                <h2>Modifica Prezzo</h2>
            </div>
            <p>Prezzo Attuale: €{{ calculateItemTotal(order[tempPriceEditIndex]).toFixed(2) }}</p>
            <div class="form-group">
                <label for="newPriceValue">Nuovo Prezzo (€)</label>
                <input type="number" id="newPriceValue" v-model.number="newPriceValue" min="0" step="0.01" class="full-width">
            </div>
            <div class="modal-actions">
                <button @click="showPriceEditModal = false; tempPriceEditIndex = null" style="background-color: #95a5a6; color: white; margin-right: 10px;"><i class="fa-solid fa-xmark"></i> Annulla</button>
                <button @click="saveNewPrice" style="background-color: #e74c3c; color: white;"><i class="fa-solid fa-save"></i> Salva</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" v-if="showShareModal">
        <div class="modal-container price-edit-modal-container">
            <div class="modal-header">
                <h2>Condividi Ordine #{{ selectedOrderForShare.id }}</h2>
            </div>
            <p>Invia il riepilogo dell'ordine al cliente o al fattorino.</p>
            <div class="modal-actions">
                <button @click="showShareModal = false; selectedOrderForShare = null" style="background-color: #95a5a6; color: white; margin-right: 10px;"><i class="fa-solid fa-xmark"></i> Annulla</button>
                <button @click="shareViaWhatsapp(selectedOrderForShare)" style="background-color: #25d366; color: white;"><i class="fa-brands fa-whatsapp"></i> Invia su WhatsApp</button>
            </div>
        </div>
    </div>
    
    <div id="print-content-comanda" class="print-comanda"></div>
    <div id="print-content-scontrino" class="print-scontrino"></div>

</div>

<script>
        const app = Vue.createApp({
            data() {
                return {
                    // Dati Base
                    view: 'inserimento', // 'inserimento', 'ordini', 'storico', 'impostazioni'
                    
                    // Accesso e Sicurezza
                    adminPin: '1234',
                    ownerPin: '0000',
                    accessPin: '',
                    isAccessGranted: false, // Indica se l'accesso è stato concesso (Operatore o Titolare)
                    userRole: '', // 'Operatore' o 'Titolare'
                    newAdminPin: '',
                    newOwnerPin: '',

                    // Dati Menu
                    menu: {
                        'Pizza Classica': [
                            { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                            { nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                            { nome: '4 Stagioni', prezzo: 8.00, isFinished: false },
                            { nome: 'Fornarina', prezzo: 5.00, isFinished: false },
                        ],
                        'Pizze Speciali': [
                            { nome: 'Pistacchio & Mortazza', prezzo: 12.00, isFinished: false },
                            { nome: 'Gourmet', prezzo: 14.00, isFinished: false },
                        ],
                        'Bevande': [
                            { nome: 'Acqua Nat', prezzo: 2.00, isFinished: false },
                            { nome: 'Coca Cola Latta', prezzo: 3.00, isFinished: false },
                        ],
                        'Dolci': [
                            { nome: 'Tiramisù', prezzo: 4.50, isFinished: false },
                        ],
                        'Composizioni': [
                            { nome: 'Mezzo Metro', prezzo: 16.00, isMeter: true, isFinished: false, sections: [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}] },
                            { nome: 'Schiacciata Grande', prezzo: 12.00, isMeter: true, isFinished: false, sections: [{name: 'Metà 1', gusto: null, modifiers: []}, {name: 'Metà 2', gusto: null, modifiers: []}]},
                            { nome: 'Pizza a Metà', prezzo: 0.00, isHalfPizza: true, isFinished: false, gusto1: null, gusto2: null, modifiers1: [], modifiers2: []}
                        ]
                    },
                    
                    // Dati Modificatori
                    modifiers: {
                        'Più': [
                            { nome: 'Mozzarella', prezzo: 0.50, isFinished: false },
                            { nome: 'Wurstel', prezzo: 1.00, isFinished: false },
                            { nome: 'Prosciutto', prezzo: 1.50, isFinished: false },
                        ],
                        'Senza': [
                            { nome: 'Aglio', prezzo: 0.00, isFinished: false },
                            { nome: 'Origano', prezzo: 0.00, isFinished: false },
                        ],
                        'Poco': [
                            { nome: 'Sale', prezzo: 0.00, isFinished: false },
                        ],
                        'Abbondante': [
                            { nome: 'Olio', prezzo: 0.00, isFinished: false },
                        ],
                    },

                    // Dati Ordine Corrente
                    order: [],
                    selectedItemIndex: null,
                    lastSelectedItem: null, // Traccia l'ultimo item selezionato nel menu
                    searchTerm: '', // Ricerca articoli
                    modifierSearchTerm: '', // Ricerca modificatori
                    activeCat: 'Pizza Classica',
                    activeModCat: 'Più',
                    
                    // Modalità di Finalizzazione Ordine
                    modes: [
                        { id: 'banco', label: 'Tavolo/Banco', icon: 'fa-solid fa-utensils' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck' }
                    ],
                    showModal: false,
                    
                    // Dati Modale
                    editingOrderId: null, // ID dell'ordine in modifica
                    mode: 'banco',
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: 'Roma',
                    tableNumber: '', // Usato per Tavolo/Ritiro
                    date: '',
                    hour: '',
                    notes: '',
                    zoneName: '',
                    deliveryCost: 0.00,
                    accontoRicevuto: 0.00,
                    
                    // Dati di Sistema
                    lastOrderId: 0,
                    activeOrders: [],
                    archive: [],
                    deliveryZones: [
                        { name: 'Zona A', price: 3.00 },
                        { name: 'Zona B', price: 4.00 },
                    ],
                    drivers: ['Mario', 'Luigi', 'Yoshi'], // Fattorini
                    
                    // Storico e Statistiche
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    selectedDriver: '',
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', // 'today', 'tomorrow', 'future'

                    // Capacità Oraria
                    capacitySettings: {
                        maxPizzas: 20,
                        intervalMinutes: 30
                    },
                    orderCapacity: {
                        interval: null,
                        total: 0,
                        remaining: 0,
                        warning: false // Flag per avviso
                    },
                    
                    // Composizioni (Metri/Mezze Pizze)
                    showMeterModal: false,
                    tempMeterItem: null,
                    editingMeterIndex: null, // Indice dell'articolo in modifica nel carrello
                    gustoSearchTerm: '',
                    tempModCat: 'Più',
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,
                    editingHalfPizzaIndex: null, // Indice dell'articolo in modifica nel carrello

                    // Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0.00,

                    // Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,
                    
                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: [],
                    
                    // Impostazioni Menu (Per mantenere la selezione)
                    activeSettingsCatName: 'Pizza Classica',
                    newItemName: '',
                    newItemPrice: 0.00,
                    newCategoryName: '',
                    activeSettingsModCatName: 'Più',
                    newModifierName: '',
                    newModifierPrice: 0.00,
                    newModifierCategoryName: '',
                    newZoneName: '',
                    newZonePrice: 0.00,
                    newDriverName: '',
                };
            },
            
            computed: {
                isOwner() {
                    return this.userRole === 'Titolare';
                },
                isAdmin() {
                    // L'accesso è concesso se il ruolo è Titolare O Operatore
                    return this.isAccessGranted;
                },
                
                // --- Calcoli Ordine Corrente ---
                calculatedOrderTotal() {
                    return this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
                },
                total() {
                    return this.calculatedOrderTotal + this.deliveryCost;
                },
                restoDaDare() {
                    const totalToPay = this.total;
                    return Math.max(0, this.accontoRicevuto - totalToPay);
                },

                // --- Filtri e Disponibilità ---
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    return items.filter(item => 
                        item.nome.toLowerCase().includes(term)
                    );
                },
                filteredModifiersForActiveCat() {
                    const mods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term)
                    );
                },

                // --- Capacità Oraria Computed ---
                isCapacityWarning() {
                    return this.orderCapacity.warning;
                },
                isCapacityFull() {
                    return this.orderCapacity.remaining <= 0;
                },
                minDate() {
                    return new Date().toISOString().slice(0, 10);
                },

                // --- Composizioni Computed ---
                allPizzaGusti() {
                    // Unisce Classiche e Speciali per i gusti delle composizioni
                    return this.menu['Pizza Classica'].concat(this.menu['Pizze Speciali']);
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase();
                    return this.allPizzaGusti.filter(item => 
                        item.nome.toLowerCase().includes(term) && !item.isFinished // Filtra solo i disponibili
                    );
                },
                filteredTempModifiers() {
                    const mods = this.modifiers[this.tempModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term) && !mod.isFinished // Filtra solo i disponibili
                    );
                },
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;
                    
                    // Recupera il prezzo base della composizione dal menu originale
                    let basePrice = this.menu['Composizioni'].find(i => i.nome === this.tempMeterItem.nome)?.prezzo || 0;
                    let modTotal = 0;

                    this.tempMeterItem.sections.forEach(section => {
                        modTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    });

                    return basePrice + modTotal;
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    // Verifica che ogni sezione abbia almeno un gusto selezionato
                    return this.tempMeterItem.sections.every(section => section.gusto !== null);
                },
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    
                    // LOGICA MIGLIORATA: Trova il prezzo base dei gusti
                    const item = this.tempHalfPizzaItem;
                    const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                    const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                    
                    const avgBasePrice = (price1 + price2) / 2;
                    
                    let modTotal = 0;
                    modTotal += item.modifiers1 ? item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    modTotal += item.modifiers2 ? item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    
                    return avgBasePrice + modTotal;
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 !== null && this.tempHalfPizzaItem.gusto2 !== null;
                },

                // --- Ordini Attivi ---
                filteredActiveOrders() {
                    let orders = this.activeOrders.filter(o => {
                        const orderDate = new Date(o.date);
                        const today = new Date();
                        const tomorrow = new Date();
                        tomorrow.setDate(today.getDate() + 1);

                        // Reset time for comparison
                        today.setHours(0, 0, 0, 0);
                        tomorrow.setHours(0, 0, 0, 0);
                        orderDate.setHours(0, 0, 0, 0);

                        if (this.activeDateFilter === 'today') {
                            return orderDate.getTime() === today.getTime();
                        } else if (this.activeDateFilter === 'tomorrow') {
                            return orderDate.getTime() === tomorrow.getTime();
                        } else if (this.activeDateFilter === 'future') {
                            // Ordini dal giorno dopo domani in poi
                            const dayAfterTomorrow = new Date();
                            dayAfterTomorrow.setDate(today.getDate() + 2);
                            dayAfterTomorrow.setHours(0, 0, 0, 0);
                            return orderDate.getTime() >= dayAfterTomorrow.getTime();
                        }
                        return true;
                    });
                    
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term) {
                        orders = orders.filter(o => 
                            o.customer.toLowerCase().includes(term) ||
                            (o.tableNumber && o.tableNumber.toLowerCase().includes(term)) ||
                            (o.address && o.address.toLowerCase().includes(term))
                        );
                    }

                    // Ordina per data e ora
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },
                
                // --- Storico ---
                filteredArchive() {
                    let orders = this.archive.filter(o => o.date === this.archiveDateFilter);
                    if (this.selectedDriver) {
                        orders = orders.filter(o => o.driver === this.selectedDriver);
                    }
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeB - timeA; // Dal più recente al meno recente
                    });
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, o) => sum + o.total, 0);
                },
                archiveDateFilterDisplay() {
                    const date = new Date(this.archiveDateFilter);
                    return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' });
                },

                // --- Impostazioni ---
                activeSettingsCat: {
                    get() {
                        if (!this.menu[this.activeSettingsCatName]) {
                            this.activeSettingsCatName = Object.keys(this.menu)[0];
                        }
                        return this.activeSettingsCatName;
                    },
                    set(val) {
                        this.activeSettingsCatName = val;
                    }
                },
                activeSettingsModCat: {
                    get() {
                        if (!this.modifiers[this.activeSettingsModCatName]) {
                            this.activeSettingsModCatName = Object.keys(this.modifiers)[0];
                        }
                        return this.activeSettingsModCatName;
                    },
                    set(val) {
                        this.activeSettingsModCatName = val;
                    }
                },
                availableDrivers() {
                    return ['', ...this.drivers];
                }
            },
            
            watch: {
                view(newView) {
                    if (newView !== 'inserimento') {
                        this.selectedItemIndex = null;
                    }
                    if (newView === 'ordini' || newView === 'storico') {
                        // Se si tenta di accedere a Ordini o Storico senza permesso
                        if (!this.isAdmin) {
                            // Non fa nulla, viene mostrato il form di accesso
                        } else if (newView === 'storico') {
                            this.calculateDriverStats();
                        }
                    } else if (newView === 'impostazioni' && !this.isOwner) {
                        // Se si tenta di accedere a Impostazioni senza essere Owner
                        // Non fa nulla, viene mostrato il form di accesso
                    }
                    this.saveData(); // Salva i dati quando si cambia vista (assicura persistenza)
                },
                order: {
                    handler() {
                        // Quando l'ordine cambia, ricalcola subito la capacità
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                activeOrders: {
                    handler() {
                        // Aggiorna la capacità ogni volta che gli ordini attivi cambiano
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                }
            },
            
            methods: {
                // --- Funzioni di Accesso e Logout ---
                grantAccess() {
                    if (this.accessPin === this.ownerPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Titolare';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Titolare Concesso.');
                    } else if (this.accessPin === this.adminPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Operatore';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Operatore Concesso.');
                    } else if (this.accessPin) {
                        alert('PIN/Password errato.');
                        this.accessPin = '';
                    }
                },
                logout() {
                    this.isAccessGranted = false;
                    this.userRole = '';
                    this.view = 'inserimento';
                    alert('Disconnessione effettuata.');
                    this.saveData();
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.adminPin = this.newAdminPin;
                        this.newAdminPin = '';
                        this.saveData();
                        alert('PIN/Password Operatore aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },
                saveOwnerPin() {
                    if (this.newOwnerPin.length >= 4) {
                        this.ownerPin = this.newOwnerPin;
                        this.newOwnerPin = '';
                        this.saveData();
                        alert('PIN/Password Titolare aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },

                // --- Persistenza Dati (LocalStorage) ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeriaSmartData');
                        if (data) {
                            const parsedData = JSON.parse(data);
                            Object.assign(this, parsedData);

                            // Inizializza i valori predefiniti per le nuove proprietà se non esistono
                            this.adminPin = parsedData.adminPin || '1234';
                            this.ownerPin = parsedData.ownerPin || '0000';
                            this.capacitySettings = parsedData.capacitySettings || { maxPizzas: 20, intervalMinutes: 30 };
                            this.drivers = parsedData.drivers || ['Mario', 'Luigi', 'Yoshi'];
                            this.deliveryZones = parsedData.deliveryZones || [
                                { name: 'Zona A', price: 3.00 },
                                { name: 'Zona B', price: 4.00 },
                            ];
                            this.customerHistory = parsedData.customerHistory || [];
                            
                            // Assicura che la data di archivio sia sempre odierna al caricamento
                            this.archiveDateFilter = new Date().toISOString().slice(0, 10);
                            
                            // Assicura che tutti gli elementi del menu e modificatori abbiano isFinished
                            this.ensureItemStatus();

                            // Controlla se l'accesso è ancora valido, altrimenti resetta
                            if (this.isAccessGranted && this.userRole) {
                                if (this.userRole === 'Operatore' && parsedData.adminPin !== this.adminPin) {
                                    this.logout();
                                }
                                if (this.userRole === 'Titolare' && parsedData.ownerPin !== this.ownerPin) {
                                    this.logout();
                                }
                            }

                        }
                    } catch (e) {
                        console.error("Errore caricamento dati:", e);
                    }
                },
                saveData() {
                    const dataToSave = {
                        adminPin: this.adminPin,
                        ownerPin: this.ownerPin,
                        isAccessGranted: this.isAccessGranted,
                        userRole: this.userRole,
                        menu: this.menu,
                        modifiers: this.modifiers,
                        lastOrderId: this.lastOrderId,
                        activeOrders: this.activeOrders,
                        archive: this.archive,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        capacitySettings: this.capacitySettings,
                        customerHistory: this.customerHistory
                    };
                    localStorage.setItem('pizzeriaSmartData', JSON.stringify(dataToSave));
                },
                ensureItemStatus() {
                    // Aggiunge la proprietà isFinished se manca
                    for (const cat in this.menu) {
                        this.menu[cat].forEach(item => {
                            if (item.isFinished === undefined) item.isFinished = false;
                            // Aggiunge proprietà di composizione se mancanti
                            if (item.isMeter && !item.sections) {
                                item.sections = item.nome === 'Mezzo Metro' ? 
                                    [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}] :
                                    [{name: 'Metà 1', gusto: null, modifiers: []}, {name: 'Metà 2', gusto: null, modifiers: []}];
                            }
                            if (item.isHalfPizza && !item.gusto1) {
                                Object.assign(item, { gusto1: null, gusto2: null, modifiers1: [], modifiers2: [] });
                            }
                        });
                    }
                    for (const cat in this.modifiers) {
                        this.modifiers[cat].forEach(mod => {
                            if (mod.isFinished === undefined) mod.isFinished = false;
                        });
                    }
                },

                // --- Funzioni Ordine Corrente ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) return item.manualPrice;
                    
                    let basePrice = item.prezzo || 0;
                    let modTotal = 0;
                    
                    if (item.isHalfPizza) {
                        const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                        const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                        basePrice = (price1 + price2) / 2; // Media dei gusti come prezzo base

                        modTotal += item.modifiers1 ? item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                        modTotal += item.modifiers2 ? item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;

                    } else if (item.isMeter) {
                        // Recupera il prezzo base della composizione dal menu originale
                        basePrice = this.menu['Composizioni'].find(i => i.nome === item.nome)?.prezzo || 0;
                        
                        item.sections.forEach(section => {
                            modTotal += section.modifiers ? section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                        });

                    } else {
                        // Articoli Standard
                        modTotal = item.modifiers ? item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    }
                    
                    return basePrice + modTotal;
                },
                
                handleItemClick(item) {
                    if (item.isFinished) return;
                    
                    this.selectedItemIndex = null; // Deseleziona un articolo modificabile
                    this.lastSelectedItem = item; // Traccia per l'evidenziazione

                    if (item.isMeter) {
                        this.addItem(item, 'meter');
                    } else if (item.isHalfPizza) {
                        this.addItem(item, 'halfpizza');
                    } else {
                        this.addItem(item, 'standard');
                    }
                },
                addItem(item, type) {
                    if (item.isFinished) return;
                    const newItem = JSON.parse(JSON.stringify(item));
                    
                    // Cleanup e setup in base al tipo
                    if (type === 'standard') {
                        delete newItem.isMeter;
                        delete newItem.sections;
                        delete newItem.isHalfPizza;
                        delete newItem.gusto1;
                        delete newItem.gusto2;
                        delete newItem.modifiers1;
                        delete newItem.modifiers2;
                        newItem.modifiers = []; // Inizializza array modificatori per articolo standard
                    } else if (type === 'meter') {
                        // Assicura che le sezioni siano fresche se non è una modifica
                        newItem.sections = newItem.sections.map(s => ({...s, gusto: null, modifiers: []}));
                        this.order.push(newItem);
                        this.openMeterCompositionModal(this.order.length - 1);
                        return;
                    } else if (type === 'halfpizza') {
                        // Assicura che i gusti e mod siano freschi se non è una modifica
                        Object.assign(newItem, { gusto1: null, gusto2: null, modifiers1: [], modifiers2: [] });
                        this.order.push(newItem);
                        this.openHalfPizzaCompositionModal(this.order.length - 1);
                        return;
                    }

                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; // Seleziona l'ultimo elemento aggiunto
                },
                removeItem(index) {
                    this.order.splice(index, 1);
                    if (this.selectedItemIndex === index) {
                        this.selectedItemIndex = null;
                    } else if (this.selectedItemIndex > index) {
                        this.selectedItemIndex--;
                    }
                },
                selectItem(index) {
                    this.selectedItemIndex = index;
                    const item = this.order[index];
                    
                    // Se l'articolo selezionato è una composizione, riapre la modale di modifica
                    if (item.isMeter) {
                        this.openMeterCompositionModal(index);
                    } else if (item.isHalfPizza) {
                        this.openHalfPizzaCompositionModal(index);
                    }
                },
                
                // --- Gestione Modificatori Articolo Standard ---
                addExtra(mod) {
                    if (mod.isFinished) return;
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo nel carrello a cui aggiungere il modificatore.");
                        return;
                    }
                    const selectedItem = this.order[this.selectedItemIndex];
                    
                    if (selectedItem.isMeter || selectedItem.isHalfPizza) {
                        alert("Non è possibile aggiungere modificatori a questo tipo di composizione da qui. Modifica tramite modale.");
                        return;
                    }
                    
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    // Gestione "Senza": se è "Senza", rimuovi l'eventuale "Più" o "Abbondante" dello stesso tipo
                    if (this.activeModCat === 'Senza') {
                        selectedItem.modifiers = selectedItem.modifiers.filter(m => 
                            m.nome !== mod.nome
                        );
                    }
                    
                    // Se non è un modificatore "Senza", aggiungilo
                    if (this.activeModCat !== 'Senza') {
                        // Aggiungi solo se non è già presente un modificatore di categoria opposta (es. Più vs Poco)
                        // Per semplicità, li lasciamo aggiungere tutti
                        selectedItem.modifiers.push(newMod);
                    }
                    // Rimosso l'aggiornamento di selectedItemIndex non necessario
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Più': return '➕';
                        case 'Senza': return '➖';
                        case 'Poco': return '🤏';
                        case 'Abbondante': return '🧅'; // Icona generica per abbondante
                        default: return '•';
                    }
                },

                // --- Composizioni (Mezzo Metro/Schiacciata) ---
                openMeterCompositionModal(index = null) {
                    if (index !== null) {
                        // Modalità Modifica
                        this.editingMeterIndex = index;
                        this.tempMeterItem = JSON.parse(JSON.stringify(this.order[index]));
                        
                        // Assicura che una sezione sia attiva (solo per UI)
                        const activeSectionExists = this.tempMeterItem.sections.some(s => s.activeSection);
                        if (!activeSectionExists) {
                            this.tempMeterItem.sections.forEach(s => delete s.activeSection); // Pulisce
                            this.tempMeterItem.sections[0].activeSection = true; 
                        }
                    } else {
                        // Modalità Nuovo Inserimento
                        this.editingMeterIndex = null;
                        // Questa funzione non dovrebbe essere chiamata direttamente, usa handleItemClick
                        return; 
                    }
                    this.showMeterModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                    this.editingMeterIndex = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                    this.selectedItemIndex = null; // Deseleziona al termine
                },
                selectMeterGusto(sectionIndex, gustoName) {
                    this.tempMeterItem.sections[sectionIndex].gusto = gustoName;
                    this.tempMeterItem.sections[sectionIndex].activeSection = false;
                    // Passa alla sezione successiva, se esiste
                    if (this.tempMeterItem.sections[sectionIndex + 1]) {
                        this.tempMeterItem.sections.forEach(s => delete s.activeSection); // Pulisce gli altri
                        this.tempMeterItem.sections[sectionIndex + 1].activeSection = true;
                    }
                    this.gustoSearchTerm = '';
                },
                addMeterModifier(sectionIndex, mod) {
                    if (mod.isFinished) return;
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    const sections = this.tempMeterItem.sections;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        sections[sectionIndex].modifiers = sections[sectionIndex].modifiers.filter(m => 
                            m.nome !== mod.nome
                        );
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        sections[sectionIndex].modifiers.push(newMod);
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert('Devi selezionare un gusto per ogni sezione.');
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                    // Aggiorna il prezzo con il totale calcolato al momento della conferma
                    finalItem.prezzo = this.calculateTempMeterTotal; 
                    
                    // Rimuovi proprietà temporanee e non necessarie
                    finalItem.sections.forEach(s => delete s.activeSection);
                    delete finalItem.modifiers; 
                    delete finalItem.activeSection;

                    // Sostituisce l'articolo se è una modifica
                    if (this.editingMeterIndex !== null) {
                        this.order.splice(this.editingMeterIndex, 1, finalItem);
                        this.selectedItemIndex = this.editingMeterIndex;
                    } else {
                        this.order.push(finalItem);
                        this.selectedItemIndex = this.order.length - 1; 
                    }
                    
                    this.cancelMeterComposition();
                },

                // --- Composizioni (Pizza a Metà) ---
                openHalfPizzaCompositionModal(index = null) {
                    if (index !== null) {
                        // Modalità Modifica
                        this.editingHalfPizzaIndex = index;
                        this.tempHalfPizzaItem = JSON.parse(JSON.stringify(this.order[index]));
                        this.tempHalfPizzaItem.activeHalf = 1; // Inizializza lo stato attivo per la UI
                    } else {
                        // Modalità Nuovo Inserimento
                        this.editingHalfPizzaIndex = null;
                        // Questa funzione non dovrebbe essere chiamata direttamente, usa handleItemClick
                        return; 
                    }
                    
                    this.showHalfPizzaModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                    this.editingHalfPizzaIndex = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                    this.selectedItemIndex = null; // Deseleziona al termine
                },
                selectHalfPizzaGusto(halfNumber, gustoName) {
                    if (halfNumber === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                        if (!this.tempHalfPizzaItem.gusto2) {
                            this.tempHalfPizzaItem.activeHalf = 2; // Passa alla seconda metà solo se non è già selezionata
                        } else {
                             this.tempHalfPizzaItem.activeHalf = 0; // Chiudi selezione gusto se entrambi sono pieni
                        }
                    } else if (halfNumber === 2) {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                        if (!this.tempHalfPizzaItem.gusto1) {
                            this.tempHalfPizzaItem.activeHalf = 1; // Passa alla prima metà solo se non è già selezionata
                        } else {
                            this.tempHalfPizzaItem.activeHalf = 0; // Chiudi selezione gusto se entrambi sono pieni
                        }
                    }
                    this.gustoSearchTerm = '';
                },
                addHalfPizzaModifier(halfNumber, mod) {
                    if (mod.isFinished) return;
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    const modifiersArray = halfNumber === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        modifiersArray.push(newMod);
                    }
                },
                addHalfPizzaToOrder() {
                    if (!this.isHalfPizzaValid) {
                        alert('Devi selezionare entrambi i gusti per la pizza a metà.');
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                    finalItem.prezzo = this.calculateTempHalfPizzaTotal; // Il prezzo finale è dato dalla media + mod.
                    delete finalItem.activeHalf; // Rimuovi proprietà temporanea
                    
                    // Sostituisce l'articolo se è una modifica
                    if (this.editingHalfPizzaIndex !== null) {
                        this.order.splice(this.editingHalfPizzaIndex, 1, finalItem);
                        this.selectedItemIndex = this.editingHalfPizzaIndex;
                    } else {
                        this.order.push(finalItem);
                        this.selectedItemIndex = this.order.length - 1; 
                    }
                    
                    this.cancelHalfPizzaComposition();
                },
                
                // --- Modifica Prezzo Man. ---
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    const item = this.order[index];
                    
                    // Impedisce la modifica manuale del prezzo per le composizioni
                    if (item.isMeter || item.isHalfPizza) {
                        alert("Non è possibile impostare un prezzo manuale per le composizioni. Modifica i gusti o i modificatori tramite la selezione dell'articolo.");
                        this.tempPriceEditIndex = null;
                        return;
                    }
                    
                    this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        this.order[this.tempPriceEditIndex].manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0.00;
                    }
                },

                // --- Funzioni Modal e Finalizzazione Ordine ---
                openModal(orderData = null) {
                    // Inizializza i campi con i valori predefiniti o con i dati dell'ordine in modifica
                    const now = new Date();
                    const formattedDate = now.toISOString().slice(0, 10);
                    const formattedHour = now.toTimeString().slice(0, 5);
                    
                    if (orderData) {
                        this.editingOrderId = orderData.id;
                        this.mode = orderData.mode;
                        this.customer = orderData.customer;
                        this.phone = orderData.phone || '';
                        this.address = orderData.address || '';
                        this.streetNumber = orderData.streetNumber || '';
                        this.town = orderData.town || 'Roma';
                        this.tableNumber = orderData.tableNumber || '';
                        this.date = orderData.date;
                        this.hour = orderData.hour;
                        this.notes = orderData.notes || '';
                        this.zoneName = orderData.zone || '';
                        this.accontoRicevuto = orderData.accontoRicevuto || 0.00;
                        
                        // Il costo di consegna deve essere ricalcolato in base alla zona attuale
                        this.updateDeliveryCost();
                        
                    } else {
                        // Nuovo ordine
                        this.editingOrderId = null;
                        this.mode = 'banco';
                        this.customer = '';
                        this.phone = '';
                        this.address = '';
                        this.streetNumber = '';
                        this.town = 'Roma';
                        this.tableNumber = '';
                        this.date = formattedDate;
                        this.hour = formattedHour;
                        this.notes = '';
                        this.zoneName = '';
                        this.deliveryCost = 0.00;
                        this.accontoRicevuto = 0.00;
                    }
                    
                    this.updateCapacityWarning(); // Aggiorna la capacità in base a data/ora predefinite
                    this.showModal = true;
                },
                selectMode(newMode) {
                    this.mode = newMode;
                    this.updateDeliveryCost();
                },
                updateDeliveryCost() {
                    if (this.mode === 'consegna' && this.zoneName) {
                        const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                        this.deliveryCost = zone ? zone.price : 0.00;
                    } else {
                        this.deliveryCost = 0.00;
                    }
                },
                confermaOrdine() {
                    if (this.order.length === 0) {
                        alert("L'ordine non contiene articoli!");
                        return;
                    }
                    if (!this.customer.trim()) {
                        alert("Inserisci il nome del Cliente/Riferimento.");
                        return;
                    }
                    if (this.mode === 'consegna' && (!this.address.trim() || !this.zoneName)) {
                        alert("Per la consegna sono necessari Indirizzo e Zona.");
                        return;
                    }
                    if (this.isCapacityFull) {
                        if (!confirm("ATTENZIONE: La fascia oraria è al completo. Vuoi comunque confermare l'ordine?")) {
                            return;
                        }
                    }

                    const newOrder = {
                        id: this.editingOrderId || ++this.lastOrderId,
                        date: this.date,
                        hour: this.hour,
                        mode: this.mode,
                        customer: this.customer.trim(),
                        phone: this.phone.trim() || '',
                        address: this.address.trim() || '',
                        streetNumber: this.streetNumber.trim() || '',
                        town: this.town.trim() || 'Roma',
                        tableNumber: this.tableNumber.trim() || '',
                        zone: this.zoneName,
                        deliveryCost: this.deliveryCost,
                        notes: this.notes,
                        accontoRicevuto: this.accontoRicevuto,
                        total: this.total,
                        items: JSON.parse(JSON.stringify(this.order)), // Copia profonda degli articoli
                        status: 'Preparazione', // Stato iniziale
                        driver: '',
                        timestamp: new Date().toISOString() // Per tracciare la creazione/modifica
                    };

                    this.addOrUpdateOrder(newOrder);
                    this.saveCustomerHistory(newOrder);

                    // Reset
                    this.order = [];
                    this.selectedItemIndex = null;
                    this.showModal = false;
                    this.editingOrderId = null;
                    this.updateCapacityWarning();
                    this.saveData(); // Salva dopo la conferma
                },
                
                addOrUpdateOrder(newOrder) {
                    if (this.editingOrderId) {
                        // Modifica ordine esistente
                        const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            // Mantieni lo stato e il driver attuali
                            newOrder.status = this.activeOrders[index].status;
                            newOrder.driver = this.activeOrders[index].driver;
                            this.activeOrders.splice(index, 1, newOrder);
                            alert(`Ordine #${newOrder.id} modificato con successo!`);
                        }
                    } else {
                        // Nuovo ordine
                        this.activeOrders.push(newOrder);
                        alert(`Ordine #${newOrder.id} inserito con successo!`);
                    }
                },

                // --- Gestione Cliente ---
                saveCustomerHistory(order) {
                    const data = {
                        customer: order.customer,
                        phone: order.phone,
                        address: order.address,
                        streetNumber: order.streetNumber,
                        town: order.town,
                        zone: order.zone,
                        timestamp: new Date().getTime()
                    };

                    // Rimuovi vecchi dati se esistono (aggiorna l'elemento con il timestamp più recente)
                    this.customerHistory = this.customerHistory.filter(h => 
                        !(h.customer === data.customer && h.address === data.address)
                    );

                    this.customerHistory.push(data);
                    // Mantieni solo gli ultimi 50 clienti, ordinati per data
                    this.customerHistory.sort((a, b) => b.timestamp - a.timestamp);
                    this.customerHistory = this.customerHistory.slice(0, 50);
                },
                filterCustomers() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory.filter(data => 
                        data.customer.toLowerCase().includes(term) ||
                        data.address.toLowerCase().includes(term) ||
                        data.phone.includes(term)
                    ).slice(0, 5);
                },
                loadCustomerData(data) {
                    this.customer = data.customer;
                    this.phone = data.phone;
                    this.address = data.address;
                    this.streetNumber = data.streetNumber;
                    this.town = data.town;
                    this.zoneName = data.zone;
                    this.filteredCustomerSuggestions = [];
                    this.updateDeliveryCost();
                },

                // --- Funzioni Ordini Attivi ---
                getNextStatus(currentStatus) {
                    switch (currentStatus) {
                        case 'Preparazione': return 'In Cottura';
                        case 'In Cottura': return 'Pronto/In Consegna';
                        case 'Pronto/In Consegna': return 'Archivia Ordine';
                        default: return 'Archivia Ordine';
                    }
                },
                advance(order) {
                    let nextStatus;
                    switch (order.status) {
                        case 'Preparazione':
                            nextStatus = 'In Cottura';
                            break;
                        case 'In Cottura':
                            nextStatus = 'Pronto/In Consegna';
                            break;
                        case 'Pronto/In Consegna':
                            this.archiveOrder(order);
                            return; // Esce dalla funzione dopo l'archiviazione
                        default:
                            this.archiveOrder(order);
                            return;
                    }
                    
                    order.status = nextStatus;
                    this.saveData();
                },
                archiveOrder(order) {
                    const index = this.activeOrders.findIndex(o => o.id === order.id);
                    if (index !== -1) {
                        // Rimuove dagli ordini attivi
                        this.activeOrders.splice(index, 1);
                        
                        // Aggiunge allo storico
                        const archivedOrder = JSON.parse(JSON.stringify(order));
                        archivedOrder.archiveDate = new Date().toISOString(); // Data archiviazione effettiva
                        this.archive.push(archivedOrder);
                        
                        this.saveData();
                        alert(`Ordine #${order.id} archiviato con successo.`);
                        this.updateCapacityWarning(); // Ricalcola la capacità dopo l'archiviazione
                    }
                },
                editOrder(orderId) {
                    const orderToEdit = this.activeOrders.find(o => o.id === orderId);
                    if (orderToEdit) {
                        this.order = JSON.parse(JSON.stringify(orderToEdit.items)); // Carica gli articoli
                        this.view = 'inserimento';
                        this.openModal(orderToEdit); // Apre la modale di finalizzazione
                    }
                },
                cancelEdit() {
                    this.order = [];
                    this.selectedItemIndex = null;
                    this.editingOrderId = null;
                    this.showModal = false;
                    this.updateCapacityWarning();
                    alert("Modifica annullata. Carrello resettato.");
                },
                updateActiveOrderDriver(orderId, driverName) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                        alert(`Fattorino per Ordine #${orderId} assegnato a ${driverName || 'Nessuno'}.`);
                    }
                },
                duplicateOrder(order) {
                    const duplicatedOrder = JSON.parse(JSON.stringify(order));
                    
                    // Prepara per un nuovo inserimento
                    duplicatedOrder.id = ++this.lastOrderId;
                    duplicatedOrder.status = 'Preparazione';
                    duplicatedOrder.timestamp = new Date().toISOString();
                    duplicatedOrder.driver = '';
                    
                    // Carica l'ordine duplicato nel carrello e apre la modale per la conferma
                    this.order = duplicatedOrder.items;
                    this.selectedItemIndex = null;
                    this.view = 'inserimento';
                    
                    // Prepara i dati della modale, forzando data/ora attuali
                    const now = new Date();
                    const formattedDate = now.toISOString().slice(0, 10);
                    const formattedHour = now.toTimeString().slice(0, 5);
                    duplicatedOrder.date = formattedDate;
                    duplicatedOrder.hour = formattedHour;
                    
                    this.openModal(duplicatedOrder);
                    alert(`Ordine #${order.id} duplicato nel carrello. Conferma l'inserimento.`);
                },

                // --- Avvisi Temporali e Capacità ---
                isFutureOrder(order) {
                    const orderTime = new Date(`${order.date}T${order.hour}`);
                    const now = new Date();
                    return orderTime.getTime() > now.getTime() + (60 * 60 * 1000); // Più di 1 ora nel futuro
                },
                isNear(order) {
                    // Ordine in pronto/consegna e mancano meno di 15 minuti all'ora
                    if (order.status === 'Pronto/In Consegna') {
                        const orderTime = new Date(`${order.date}T${order.hour}`);
                        const now = new Date();
                        const diffMinutes = (orderTime.getTime() - now.getTime()) / (60 * 1000);
                        return diffMinutes > 5 && diffMinutes <= 15;
                    }
                    return false;
                },
                isUrgent(order) {
                    // Ordine in pronto/consegna e mancano meno di 5 minuti all'ora
                    if (order.status === 'Pronto/In Consegna') {
                        const orderTime = new Date(`${order.date}T${order.hour}`);
                        const now = new Date();
                        const diffMinutes = (orderTime.getTime() - now.getTime()) / (60 * 1000);
                        return diffMinutes <= 5 && diffMinutes > 0;
                    }
                    return false;
                },
                
                calculateCapacity(targetDateTime) {
                    const slotMinutes = this.capacitySettings.intervalMinutes;
                    const maxPizzas = this.capacitySettings.maxPizzas;

                    // Calcola l'inizio del blocco temporale (es. 19:15 diventa 19:00, se slot è 30, 19:40 diventa 19:30)
                    const tempDate = new Date(targetDateTime);
                    const minutes = tempDate.getMinutes();
                    const startMinutes = Math.floor(minutes / slotMinutes) * slotMinutes;
                    tempDate.setMinutes(startMinutes, 0, 0);
                    const intervalStart = tempDate.getTime();
                    const intervalEnd = intervalStart + (slotMinutes * 60 * 1000);

                    // Articoli nell'ordine corrente che contano per la capacità
                    const currentOrderPizzas = this.order.reduce((count, item) => {
                        // Ignora l'articolo se è una composizione in modifica (verrà conteggiato come "attivo" se era già nell'ordine, altrimenti viene contato solo quando confermato nella modale)
                        if (this.editingMeterIndex !== null && this.order[this.editingMeterIndex] === item) return count;
                        if (this.editingHalfPizzaIndex !== null && this.order[this.editingHalfPizzaIndex] === item) return count;

                        // Contano solo Pizze Classiche, Pizze Speciali e Mezzo Metro/Pizza a Metà (come 4/2)
                        const isPizzaCategory = (item.nome) => {
                             for (const cat of ['Pizza Classica', 'Pizze Speciali']) {
                                 if (this.menu[cat] && this.menu[cat].some(menuItem => menuItem.nome === item.nome)) {
                                     return true;
                                 }
                             }
                             return false;
                        };
                        
                        if (isPizzaCategory(item.nome)) {
                            count += 1;
                        } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                            count += 4; // Contiamo il mezzo metro come 4 pizze standard
                        } else if (item.isHalfPizza) {
                            count += 1; // La pizza a metà è 1 pizza standard
                        } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                            count += 2; // La schiacciata è 2 pizze standard
                        }
                        return count;
                    }, 0);

                    // Ordini attivi che cadono in questo slot
                    let totalPizzasInSlot = 0;
                    this.activeOrders.forEach(o => {
                        // Ignora l'ordine in modifica
                        if (o.id === this.editingOrderId) return; 

                        const orderTime = new Date(`${o.date}T${o.hour}`).getTime();
                        
                        if (orderTime >= intervalStart && orderTime < intervalEnd) {
                            o.items.forEach(item => {
                                const isPizzaCategory = (item.nome) => {
                                     for (const cat of ['Pizza Classica', 'Pizze Speciali']) {
                                         if (this.menu[cat] && this.menu[cat].some(menuItem => menuItem.nome === item.nome)) {
                                             return true;
                                         }
                                     }
                                     return false;
                                };

                                if (isPizzaCategory(item.nome)) {
                                    totalPizzasInSlot += 1;
                                } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                                    totalPizzasInSlot += 4;
                                } else if (item.isHalfPizza) {
                                    totalPizzasInSlot += 1;
                                } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                                    totalPizzasInSlot += 2;
                                }
                            });
                        }
                    });

                    totalPizzasInSlot += currentOrderPizzas;

                    this.orderCapacity.interval = intervalStart;
                    this.orderCapacity.total = totalPizzasInSlot;
                    this.orderCapacity.remaining = maxPizzas - totalPizzasInSlot;
                    this.orderCapacity.warning = totalPizzasInSlot >= maxPizzas * 0.75; // Avviso al 75%
                },

                updateCapacityWarning() {
                    const targetDate = this.date || new Date().toISOString().slice(0, 10);
                    const targetHour = this.hour || new Date().toTimeString().slice(0, 5);
                    
                    if (targetDate && targetHour) {
                        const targetDateTime = new Date(`${targetDate}T${targetHour}`);
                        this.calculateCapacity(targetDateTime);
                    } else {
                        // Reset se mancano data o ora
                        this.orderCapacity = { interval: null, total: 0, remaining: this.capacitySettings.maxPizzas, warning: false };
                    }
                },

                // --- Stampa e Condivisione ---
                printOrder(orderId, type) {
                    const order = this.activeOrders.find(o => o.id === orderId) || this.archive.find(o => o.id === orderId);
                    if (!order) return;

                    const printComanda = document.getElementById('print-content-comanda');
                    const printScontrino = document.getElementById('print-content-scontrino');
                    
                    printComanda.innerHTML = '';
                    printScontrino.innerHTML = '';

                    if (type === 'comanda') {
                        printComanda.innerHTML = this.generateComandaHTML(order);
                        this.printContent('comanda');
                    } else if (type === 'scontrino') {
                        printScontrino.innerHTML = this.generateScontrinoHTML(order);
                        this.printContent('scontrino');
                    }
                },
                generateComandaHTML(order) {
                    let itemsHtml = order.items.map(item => {
                        let modsHtml = '';
                        
                        if (item.isHalfPizza) {
                            // Prezzo corretto è già in item.prezzo
                            modsHtml = `
                                <ul class="mod-list">
                                    <li>Metà 1: <strong>${item.gusto1}</strong> ${item.modifiers1.map(m => m.nome).join(', ')}</li>
                                    <li>Metà 2: <strong>${item.gusto2}</strong> ${item.modifiers2.map(m => m.nome).join(', ')}</li>
                                </ul>
                            `;
                        } else if (item.isMeter) {
                            // Prezzo corretto è già in item.prezzo
                            modsHtml = `
                                <ul class="mod-list">
                                    ${item.sections.map(s => `<li>${s.name}: <strong>${s.gusto}</strong> ${s.modifiers.map(m => m.nome).join(', ')}</li>`).join('')}
                                </ul>
                            `;
                        } else if (item.modifiers && item.modifiers.length > 0) {
                            modsHtml = `<ul class="mod-list">${item.modifiers.map(mod => `<li>${this.getModifierIcon(this.getModifierCategory(mod.nome))} ${mod.nome}</li>`).join('')}</ul>`;
                        }
                        
                        return `<li><span class="item-name">1x ${item.nome}</span>${modsHtml}</li>`;
                    }).join('');
                    
                    let addressHtml = '';
                    if (order.mode === 'consegna') {
                        addressHtml = `
                            <p style="margin: 5px 0 0;"><strong>Indirizzo:</strong> ${order.address} ${order.streetNumber}, ${order.zone}</p>
                            <p style="margin: 0;"><strong>Tel:</strong> ${order.phone}</p>
                        `;
                    }
                    
                    let noteHtml = order.notes ? `<p class="note">NOTE: ${order.notes}</p>` : '';
                    let driverHtml = order.driver ? `<p style="margin-top: 5px;"><strong>Fattorino:</strong> ${order.driver}</p>` : '';

                    return `
                        <div style="text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 5px;">
                            <h1>COMANDA PIZZERIA SMART</h1>
                            <p style="margin: 0; font-size: 10pt;"><strong>N°:</strong> ${order.id} | <strong>Tipo:</strong> ${order.mode.toUpperCase()}</p>
                            <p style="margin: 0; font-size: 10pt;"><strong>Orario:</strong> ${order.hour} | <strong>Data:</strong> ${this.formatDate(order.date)}</p>
                            <p style="margin: 0; font-size: 10pt;"><strong>Cliente:</strong> ${order.customer} ${order.tableNumber ? `(${order.tableNumber})` : ''}</p>
                            ${addressHtml}
                        </div>
                        <h2>ARTICOLI</h2>
                        <ul style="list-style: none; padding: 0;">${itemsHtml}</ul>
                        ${noteHtml}
                        ${driverHtml}
                        <p style="margin-top: 15px; font-weight: bold; text-align: center;">TOTALE: €${order.total.toFixed(2)}</p>
                    `;
                },
                generateScontrinoHTML(order) {
                    let itemsHtml = order.items.map(item => {
                        // Prezzo visualizzato
                        const displayPrice = this.calculateItemTotal(item);
                        
                        let itemName = `1x ${item.nome}`;
                        if (item.isHalfPizza) {
                            itemName += ` (${item.gusto1}/${item.gusto2})`;
                        }
                        
                        let modsList = '';
                        if (item.isHalfPizza) {
                            // Mostriamo i mod che hanno un prezzo
                             const mods = [...item.modifiers1, ...item.modifiers2];
                             modsList = mods.filter(m => m.prezzo > 0)
                                .map(m => `<br>   +${m.nome} (+€${m.prezzo.toFixed(2)})`)
                                .join('');
                        } else if (item.isMeter) {
                             // Mostriamo i mod che hanno un prezzo
                             let mods = [];
                             item.sections.forEach(s => mods.push(...s.modifiers));
                             modsList = mods.filter(m => m.prezzo > 0)
                                .map(m => `<br>   +${m.nome} (+€${m.prezzo.toFixed(2)})`)
                                .join('');
                        } else if (item.modifiers && item.modifiers.length > 0) {
                            modsList = item.modifiers.filter(m => m.prezzo > 0)
                                .map(m => `<br>   +${m.nome} (+€${m.prezzo.toFixed(2)})`)
                                .join('');
                        }

                        return `
                            <tr>
                                <td>${itemName}${modsList}</td>
                                <td style="text-align: right;">€${displayPrice.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');

                    let addressHtml = order.mode === 'consegna' ? 
                        `<tr><td colspan="2">Consegna: ${order.address} ${order.streetNumber}</td></tr>` : 
                        `<tr><td colspan="2">Modalità: ${order.mode.toUpperCase()} ${order.tableNumber ? `(${order.tableNumber})` : ''}</td></tr>`;
                    
                    let accontoHtml = '';
                    if (order.accontoRicevuto > 0) {
                        accontoHtml = `
                            <tr class="total-row"><td>ACCONTO RICEVUTO</td><td style="text-align: right;">-€${order.accontoRicevuto.toFixed(2)}</td></tr>
                            <tr class="total-row"><td>DA SALDARE</td><td style="text-align: right;">€${(order.total - order.accontoRicevuto).toFixed(2)}</td></tr>
                        `;
                        if (order.accontoRicevuto > order.total) {
                            accontoHtml += `<tr class="total-row"><td>RESTO DA DARE</td><td style="text-align: right;">€${(order.accontoRicevuto - order.total).toFixed(2)}</td></tr>`;
                        }
                    }

                    return `
                        <div style="text-align: center; border-bottom: 1px dashed #000; margin-bottom: 5px; padding-bottom: 5px;">
                            <h1>PIZZERIA SMART</h1>
                            <p style="margin: 0; font-size: 8pt;">Indirizzo Pizzeria - P.IVA XXXXXX</p>
                        </div>
                        <table>
                            <tr><td colspan="2">N. Ordine: ${order.id} | ${this.formatDateTime(order.timestamp)}</td></tr>
                            <tr><td colspan="2">Cliente: ${order.customer}</td></tr>
                            ${addressHtml}
                            ${order.mode === 'consegna' ? `<tr><td colspan="2">Costo Consegna: €${order.deliveryCost.toFixed(2)} (${order.zone})</td></tr>` : ''}
                        </table>
                        <table style="margin-top: 5px; border-top: 1px dashed #000; padding-top: 5px;">
                            ${itemsHtml}
                        </table>
                        <table>
                            <tr class="total-row">
                                <td>TOTALE ORDINE</td>
                                <td style="text-align: right;">€${order.total.toFixed(2)}</td>
                            </tr>
                            ${accontoHtml}
                        </table>
                        <p style="text-align: center; margin-top: 10px; font-size: 8pt;">Grazie e Arrivederci!</p>
                    `;
                },
                printContent(contentId) {
                    const printContents = document.getElementById(`print-content-${contentId}`).outerHTML;
                    const originalContents = document.body.innerHTML;
                    
                    const printWindow = window.open('', '_blank', 'height=600,width=400');
                    printWindow.document.write('<html><head><title>Stampa</title>');
                    printWindow.document.write('<style>@media print { body > *:not(.print-container) { display: none; } .print-container { display: block; max-width: 100%; font-size: 11pt; } .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; } .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; } .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; } .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; } .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; } .print-comanda .item-name { font-weight: bold; font-size: 13pt; } .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; } .print-comanda .mod-list li { border: none; } .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; } .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; } .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; } .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; } .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; } .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; } </style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(`<div class="print-container print-${contentId}">${printContents}</div>`);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    
                    // Aggiunto un piccolo ritardo per consentire al browser di caricare lo stile prima di stampare
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                },
                showShareMenu(orderId) {
                    this.selectedOrderForShare = this.activeOrders.find(o => o.id === orderId);
                    if (this.selectedOrderForShare) {
                        this.showShareModal = true;
                    }
                },
                shareViaWhatsapp(order) {
                    let message = `*Riepilogo Ordine Pizzeria Smart*\n\n`;
                    message += `*#${order.id}* - ${order.mode.toUpperCase()}\n`;
                    message += `*Cliente:* ${order.customer}\n`;
                    message += `*Orario Ritiro/Consegna:* ${this.formatDateTime(order.date + 'T' + order.hour)}\n`;

                    if (order.mode === 'consegna') {
                        message += `*Indirizzo:* ${order.address} ${order.streetNumber}, ${order.zone}\n`;
                    } else if (order.tableNumber) {
                        message += `*Riferimento:* ${order.tableNumber}\n`;
                    }
                    if (order.phone) {
                        message += `*Tel:* ${order.phone}\n`;
                    }
                    if (order.notes) {
                        message += `*Note:* ${order.notes}\n`;
                    }

                    message += `\n*Articoli:*\n`;
                    order.items.forEach(item => {
                        let itemLine = `1x ${item.nome}`;
                        if (item.isHalfPizza) {
                            itemLine += ` (Gusti: ${item.gusto1}/${item.gusto2})`;
                        } else if (item.isMeter) {
                            itemLine += ` (Gusti: ${item.sections.map(s => s.gusto).join(' / ')})`;
                        }
                        
                        let mods = [];
                        if (item.isHalfPizza) {
                             mods = [...item.modifiers1, ...item.modifiers2];
                        } else if (item.isMeter) {
                             item.sections.forEach(s => mods.push(...s.modifiers));
                        } else if (item.modifiers) {
                            mods = item.modifiers;
                        }

                        if (mods.length > 0) {
                            const modNames = mods.map(m => {
                                const cat = this.getModifierCategory(m.nome);
                                return `${this.getModifierIcon(cat)}${m.nome}`;
                            }).join(', ');
                            itemLine += ` [${modNames}]`;
                        }
                        message += `- ${itemLine}\n`;
                    });

                    message += `\n*TOTALE: €${order.total.toFixed(2)}*`;

                    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    this.showShareModal = false;
                },

                // --- Funzioni Storico/Archivio ---
                calculateDriverStats() {
                    const filteredOrders = this.archive.filter(o => o.date === this.archiveDateFilter);
                    
                    this.driverStats.totalOrders = 0;
                    this.driverStats.totalRevenue = 0;

                    const ordersToCount = this.selectedDriver 
                        ? filteredOrders.filter(o => o.driver === this.selectedDriver) 
                        : filteredOrders; // Se Nessuno è selezionato, mostriamo tutti gli ordini archiviati

                    ordersToCount.forEach(o => {
                        this.driverStats.totalOrders++;
                        this.driverStats.totalRevenue += o.total;
                    });
                },
                updateArchiveDriver(orderId, driverName) {
                    const order = this.archive.find(o => o.id === orderId);
                    if (order) {
                        order.driver = driverName;
                        this.saveData();
                        this.calculateDriverStats(); // Aggiorna le statistiche
                        alert(`Fattorino per Ordine Archiviato #${orderId} assegnato a ${driverName || 'Nessuno'}.`);
                    }
                },

                // --- Funzioni Impostazioni/Gestione Dati ---
                addItemToCategory() {
                    if (this.newItemName && this.activeSettingsCat) {
                        const newItem = {
                            nome: this.newItemName,
                            prezzo: parseFloat(this.newItemPrice || 0),
                            isFinished: false
                        };
                        
                        // Logica speciale per le composizioni
                        if (this.activeSettingsCat === 'Composizioni') {
                            if (this.newItemName.toLowerCase().includes('metro')) {
                                newItem.isMeter = true;
                                newItem.sections = [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}];
                            } else if (this.newItemName.toLowerCase().includes('metà')) {
                                newItem.isHalfPizza = true;
                                Object.assign(newItem, { gusto1: null, gusto2: null, modifiers1: [], modifiers2: [] });
                                newItem.prezzo = 0.00; // La pizza a metà ha prezzo 0, calcolato dalla media
                            } else if (this.newItemName.toLowerCase().includes('schiacciata')) {
                                newItem.isMeter = true;
                                newItem.sections = [{name: 'Metà 1', gusto: null, modifiers: []}, {name: 'Metà 2', gusto: null, modifiers: []}];
                            }
                        }

                        this.menu[this.activeSettingsCat].push(newItem);
                        this.newItemName = '';
                        this.newItemPrice = 0;
                        this.saveData();
                        alert(`Articolo "${newItem.nome}" aggiunto a ${this.activeSettingsCat}.`);
                    }
                },
                deleteItem(category, index) {
                    if (confirm(`Sei sicuro di voler eliminare "${this.menu[category][index].nome}" da ${category}?`)) {
                        this.menu[category].splice(index, 1);
                        this.saveData();
                        alert('Articolo eliminato.');
                    }
                },
                toggleItemFinished(category, index) {
                    const item = this.menu[category][index];
                    item.isFinished = !item.isFinished;
                    this.saveData();
                    alert(`${item.nome} è ora ${item.isFinished ? 'ESAURITO' : 'DISPONIBILE'}.`);
                },
                addCategory() {
                    if (this.newCategoryName && !this.menu[this.newCategoryName]) {
                        this.menu[this.newCategoryName] = [];
                        this.activeSettingsCat = this.newCategoryName;
                        this.newCategoryName = '';
                        this.saveData();
                        alert(`Categoria "${this.activeSettingsCat}" aggiunta.`);
                    } else if (this.newCategoryName) {
                        alert('Categoria già esistente.');
                    }
                },
                deleteCategory(category) {
                    if (Object.keys(this.menu).length <= 1) {
                        alert('Non puoi eliminare l\'unica categoria rimasta.');
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria "${category}" e tutti i suoi articoli?`)) {
                        delete this.menu[category];
                        this.activeSettingsCat = Object.keys(this.menu)[0]; // Seleziona la prima categoria rimanente
                        this.saveData();
                        alert('Categoria eliminata.');
                    }
                },
                
                // Modificatori
                addModifierToCategory() {
                    if (this.newModifierName && this.activeSettingsModCat) {
                        const newMod = {
                            nome: this.newModifierName,
                            prezzo: parseFloat(this.newModifierPrice || 0),
                            isFinished: false
                        };
                        this.modifiers[this.activeSettingsModCat].push(newMod);
                        this.newModifierName = '';
                        this.newModifierPrice = 0;
                        this.saveData();
                        alert(`Modificatore "${newMod.nome}" aggiunto a ${this.activeSettingsModCat}.`);
                    }
                },
                deleteModifier(category, index) {
                    if (confirm(`Sei sicuro di voler eliminare il modificatore "${this.modifiers[category][index].nome}"?`)) {
                        this.modifiers[category].splice(index, 1);
                        this.saveData();
                        alert('Modificatore eliminato.');
                    }
                },
                toggleModifierFinished(category, index) {
                    const mod = this.modifiers[category][index];
                    mod.isFinished = !mod.isFinished;
                    this.saveData();
                    alert(`Modificatore ${mod.nome} è ora ${mod.isFinished ? 'ESAURITO' : 'DISPONIBILE'}.`);
                },
                addModifierCategory() {
                    if (this.newModifierCategoryName && !this.modifiers[this.newModifierCategoryName]) {
                        this.modifiers[this.newModifierCategoryName] = [];
                        this.activeSettingsModCat = this.newModifierCategoryName;
                        this.newModifierCategoryName = '';
                        this.saveData();
                        alert(`Categoria modificatori "${this.activeSettingsModCat}" aggiunta.`);
                    } else if (this.newModifierCategoryName) {
                        alert('Categoria modificatori già esistente.');
                    }
                },
                deleteModifierCategory(category) {
                    if (this.isDefaultModifierCategory(category)) {
                        alert('Non è possibile eliminare le categorie modificatori predefinite (Più, Senza, Poco, Abbondante).');
                        return;
                    }
                    if (Object.keys(this.modifiers).length <= 4) {
                        alert('Non puoi eliminare la categoria. Devi mantenere almeno le categorie predefinite.');
                        return;
                    }
                    if (confirm(`Sei sicuro di voler eliminare la categoria modificatori "${category}" e tutti i suoi elementi?`)) {
                        delete this.modifiers[category];
                        this.activeSettingsModCat = Object.keys(this.modifiers).find(c => !this.isDefaultModifierCategory(c)) || 'Più';
                        this.saveData();
                        alert('Categoria modificatori eliminata.');
                    }
                },
                isDefaultModifierCategory(category) {
                    return ['Più', 'Senza', 'Poco', 'Abbondante'].includes(category);
                },

                // Zone di Consegna
                addZone() {
                    if (this.newZoneName) {
                        const existing = this.deliveryZones.find(z => z.name.toLowerCase() === this.newZoneName.toLowerCase());
                        if (existing) {
                            alert('Zona già esistente.');
                            return;
                        }
                        this.deliveryZones.push({
                            name: this.newZoneName,
                            price: parseFloat(this.newZonePrice || 0)
                        });
                        this.newZoneName = '';
                        this.newZonePrice = 0;
                        this.saveData();
                        alert('Zona di consegna aggiunta.');
                    }
                },
                deleteZone(index) {
                    if (confirm(`Sei sicuro di voler eliminare la zona di consegna "${this.deliveryZones[index].name}"?`)) {
                        this.deliveryZones.splice(index, 1);
                        this.saveData();
                        alert('Zona di consegna eliminata.');
                    }
                },

                // Fattorini
                addDriver() {
                    if (this.newDriverName && !this.drivers.includes(this.newDriverName)) {
                        this.drivers.push(this.newDriverName);
                        this.newDriverName = '';
                        this.saveData();
                        alert('Fattorino aggiunto.');
                    } else if (this.newDriverName) {
                        alert('Fattorino già presente.');
                    }
                },
                deleteDriver(index) {
                    if (confirm(`Sei sicuro di voler eliminare il fattorino "${this.drivers[index]}"?`)) {
                        this.drivers.splice(index, 1);
                        this.saveData();
                        alert('Fattorino eliminato.');
                    }
                },

                // Import/Export
                exportData() {
                    const data = localStorage.getItem('pizzeriaSmartData');
                    if (!data) {
                        alert('Nessun dato da esportare.');
                        return;
                    }
                    const blob = new Blob([data], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pizzeria_smart_data_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('Dati esportati con successo!');
                },
                importData() {
                    if (!confirm('ATTENZIONE: L\'importazione sovrascriverà tutti i dati correnti (Menu, Ordini, Storico, PIN). Continuare?')) {
                        return;
                    }

                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const importedData = JSON.parse(event.target.result);
                                
                                // Reset completo dello stato
                                // Ci affidiamo al ricaricamento completo con Object.assign.
                                
                                // Carica i dati importati
                                Object.assign(this, importedData);
                                
                                // Assicura che la data di archivio sia sempre odierna al caricamento
                                this.archiveDateFilter = new Date().toISOString().slice(0, 10);
                                this.ensureItemStatus(); // Assicura la presenza di tutte le proprietà
                                this.isAccessGranted = false; // Forza un nuovo login
                                this.userRole = '';

                                localStorage.setItem('pizzeriaSmartData', event.target.result);
                                alert('Dati importati e sovrascritti con successo! Effettua nuovamente l\'accesso.');
                            } catch (error) {
                                console.error('Errore durante l\'importazione del file:', error);
                                alert('Errore: Il file non è un JSON valido o non è compatibile.');
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },
                clearCache() {
                    if (confirm('Sei sicuro di voler eliminare tutti gli Ordini Attivi e lo Storico? Menu, Clienti e PIN saranno conservati.')) {
                        this.activeOrders = [];
                        this.archive = [];
                        this.lastOrderId = this.activeOrders.length + this.archive.length; // Resetta l'ID al minimo
                        this.saveData();
                        alert('Cache ordini e storico pulita.');
                    }
                },

                // --- Utilità ---
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                },
                formatDateTime(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                }
            },

            mounted() {
                this.loadData();
                this.updateCapacityWarning(); // Calcola la capacità iniziale
                
                // Aggiorna la capacità ogni 5 minuti (per gli ordini in tempo reale)
                setInterval(() => {
                    if (this.view === 'ordini' || this.showModal) {
                        this.updateCapacityWarning(); 
                    }
                }, 5 * 60 * 1000); // 5 minuti
            }
        });

        app.mount('#app');
</script>

</body>
</html>
