<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Finanziaria Unificata Smart 5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            color: #1e293b;
            transition: background 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #0f172a;
            color: #f1f5f9;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .tab-active {
            border-bottom: 3px solid #10b981;
            color: #10b981;
        }
        .cta-button {
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.4);
        }
        .bar-container {
            height: 20px;
            border-radius: 9999px;
            overflow: hidden;
            display: flex;
        }
        .bar-income { background-color: #10b981; }
        .bar-expense { background-color: #ef4444; }
        .bar-addebito { background-color: #fb923c; }
        .bar-credito { background-color: #3b82f6; }
        #quick-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.8));
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 40;
        }
        .dark #quick-actions {
            background: linear-gradient(to top, rgba(30, 41, 59, 1), rgba(30, 41, 59, 0.9));
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold text-center md:text-left">Finanza Smart 5.0 üöÄ</h1>
                <p class="text-center md:text-left text-sm text-gray-500">Attivit√† & Personale</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-3 justify-center">
                <button id="dark-mode-toggle" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-sm font-semibold">
                    üåô Modalit√† Scura
                </button>
                <button onclick="exportCSV()" class="px-4 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold">
                    ‚¨áÔ∏è Export CSV
                </button>
            </div>
        </header>

        <nav id="navbar" class="flex justify-around bg-white dark:bg-gray-800 p-2 rounded-xl shadow-lg mb-6">
            <!-- Nav generata via JS -->
        </nav>

        <div id="content-area"><!-- Pagine dinamiche qui --></div>

        <div id="quick-actions" class="hidden md:hidden">
            <div class="flex space-x-3 max-w-lg mx-auto">
                <button id="btn-quick-income" onclick="quickRegister('true')"
                        class="flex-1 bg-emerald-500 text-white p-3 rounded-xl font-bold hover:bg-emerald-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
                    üí∞ Entrata
                </button>
                <button id="btn-quick-expense" onclick="quickRegister('false')"
                        class="flex-1 bg-red-500 text-white p-3 rounded-xl font-bold hover:bg-red-600 shadow-xl transition transform hover:scale-[1.02] text-lg">
                    üí∏ Uscita
                </button>
            </div>
        </div>

        <div id="modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-sm card">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600 dark:text-red-400">Attenzione</h3>
                <p id="modal-message" class="mb-4">Messaggio di esempio.</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg">Annulla</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg">Conferma</button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 bg-green-500 text-white rounded-xl shadow-lg transition-opacity duration-300 opacity-0" role="alert">
            Azione completata con successo!
        </div>
    </div>

    <script>
        const LOCAL_STORAGE_KEY = 'smartFinApp_v5'; 
        const IVA_RATES = [0, 4, 5, 10, 22]; 
        const MAX_RECENT_TRANSACTIONS = 10; 
        let appData = {
            invoices: [],
            expenses: [],
            reminders: [],
            contacts: [],
            categories: ["Generale","Cibo","Bollette","Trasporti","Marketing","Altro"],
            budgets: {}, // { "2025-10": {limit:500, spent:200} }
            lastId: 0
        };
        let currentPage = 'activity'; 
        let darkMode = false;

        // --- Gestione Tema ---
        function initDarkMode() {
            darkMode = localStorage.getItem("darkMode") === "true";
            document.documentElement.classList.toggle("dark", darkMode);
        }
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.documentElement.classList.toggle("dark", darkMode);
            localStorage.setItem("darkMode", darkMode);
        }

        // --- Load/Save ---
        function loadData() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    appData = { ...appData, ...parsedData };
                    appData.invoices = appData.invoices || [];
                    appData.expenses = appData.expenses || [];
                    appData.reminders = appData.reminders || [];
                    appData.contacts = appData.contacts || []; 
                    appData.categories = appData.categories || ["Generale"];
                    appData.budgets = appData.budgets || {};
                }
            } catch (error) {
                console.error("Errore caricamento:", error);
            }
        }
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appData));
        }
        function getNextId() {
            appData.lastId++;
            saveData();
            return appData.lastId;
        }

        // --- Toast/Modal ---
        function showToast(message, type = 'green') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 p-3 text-white rounded-xl shadow-lg opacity-100`;
            toast.classList.add(type === 'red' ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => { toast.classList.add('opacity-0'); }, 2500);
        }
        function showModal(title, message, isConfirmation, onConfirm) {
            const modal = document.getElementById('modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            confirmBtn.onclick = () => { modal.classList.add('hidden'); if(onConfirm) onConfirm(); };
            cancelBtn.onclick = () => modal.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        // --- Export CSV ---
        function exportCSV() {
            const rows = [["ID","Tipo","Data","Descrizione","Categoria","Netto","IVA %","IVA ‚Ç¨","Lordo","Entrata"]];
            const all = [...appData.invoices.map(t=>({...t,isIncome:true})),...appData.expenses.map(t=>({...t,isIncome:false}))];
            all.forEach(t=>{
                rows.push([t.id,t.type,t.date,t.description,t.category||"Generale",t.net,t.vatRate,t.vatAmount,t.gross,t.isIncome?"Entrata":"Uscita"]);
            });
            let csv = rows.map(r=>r.join(";")).join("\n");
            const blob = new Blob([csv],{type:"text/csv"});
            const a = document.createElement("a");
            a.href=URL.createObjectURL(blob);
            a.download="finanza_export.csv";
            a.click();
        }
                // --- Quick Register ---
        function quickRegister(isIncomeString) {
            const isIncome = isIncomeString === 'true';
            renderPage(currentPage);
            document.getElementById('isIncome').value = isIncomeString;
            showToast(isIncome ? "Modulo pronto per Entrata" : "Modulo pronto per Uscita");
        }

        // --- Calcolo riepiloghi ---
        function calculateFinancialSummary(type, filterType, filterDateStr) {
            let totalIncomes = 0, totalExpenses = 0;
            let ivaAddebito = 0, ivaCredito = 0;
            const typesToFilter = type === 'global' ? ['activity', 'personal'] : [type];
            const allTransactions = [
                ...appData.invoices.map(t => ({...t, isIncome: true})), 
                ...appData.expenses.map(t => ({...t, isIncome: false}))
            ];
            const filtered = allTransactions.filter(item => typesToFilter.includes(item.type));
            filtered.forEach(item=>{
                if(item.isIncome){ totalIncomes+=item.gross; if(item.type==="activity") ivaAddebito+=item.vatAmount; }
                else { totalExpenses+=item.gross; if(item.type==="activity") ivaCredito+=item.vatAmount; }
            });
            return {
                totalIncomes,totalExpenses,
                netBalance: totalIncomes-totalExpenses,
                ivaAddebito,ivaCredito,ivaBalance: ivaAddebito-ivaCredito,
                transactions: filtered.sort((a,b)=>new Date(b.date)-new Date(a.date))
            };
        }

        // --- Salva transazione ---
        function saveTransaction(isIncome,data){
            const list = isIncome ? appData.invoices : appData.expenses;
            const vatRate=parseFloat(data.vatRate); const net=parseFloat(data.net);
            const vatAmount=(net*vatRate/100); const gross=net+vatAmount;
            const updated={ id:data.id||getNextId(), type:data.dataType, date:data.date, description:data.description,
                category:data.category||"Generale", net, vatRate, vatAmount:parseFloat(vatAmount.toFixed(2)), gross:parseFloat(gross.toFixed(2))
            };
            if(data.id){ const idx=list.findIndex(i=>i.id===data.id); if(idx>-1) list[idx]=updated; }
            else { list.push(updated); }
            saveData(); renderPage(currentPage);
        }
        function handleTransactionSubmit(type){
            const form=document.getElementById('transaction-form');
            const d=new FormData(form);
            const isIncome=d.get('isIncome')==="true";
            const id=form.getAttribute('data-transaction-id')?parseInt(form.getAttribute('data-transaction-id')):null;
            const tx={id,dataType:type,isIncome,date:d.get('date'),description:d.get('description'),net:d.get('net'),vatRate:d.get('vatRate'),category:d.get('category')};
            if(tx.net && tx.date){ saveTransaction(isIncome,tx); form.reset(); form.removeAttribute('data-transaction-id'); }
            else showToast("Compila tutti i campi","red");
        }

        // --- Pagine ---
        function renderActivityOrPersonalPage(type){
            const isActivity=type==="activity";
            const summary=calculateFinancialSummary(type,"all","all");
            const txs=summary.transactions.slice(0,MAX_RECENT_TRANSACTIONS);
            return `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold">${isActivity?"Attivit√†":"Personale"}</h2>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
                    <h3 class="text-xl font-medium mb-4">Nuovo Movimento</h3>
                    <form id="transaction-form" onsubmit="event.preventDefault();handleTransactionSubmit('${type}');" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm">Tipo</label>
                                <select id="isIncome" name="isIncome" class="w-full p-2 border rounded-lg">
                                    <option value="true">Entrata</option>
                                    <option value="false">Uscita</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm">Categoria</label>
                                <select id="category" name="category" class="w-full p-2 border rounded-lg">
                                    ${appData.categories.map(c=>`<option value="${c}">${c}</option>`).join("")}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm">Data</label>
                            <input type="date" id="date" name="date" value="${new Date().toISOString().slice(0,10)}" class="w-full p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm">Descrizione</label>
                            <input type="text" id="description" name="description" class="w-full p-2 border rounded-lg">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm">Importo Netto</label>
                                <input type="number" id="net" name="net" step="0.01" class="w-full p-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm">IVA %</label>
                                <select id="vatRate" name="vatRate" class="w-full p-2 border rounded-lg">
                                    ${IVA_RATES.map(r=>`<option value="${r}">${r}%</option>`).join("")}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="cta-button w-full bg-emerald-500 text-white p-3 rounded-lg font-bold">Registra</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
                    <h3 class="text-xl mb-3">Ultimi Movimenti</h3>
                    ${txs.map(t=>`
                        <div class="flex justify-between border-b py-2 ${t.isIncome?"text-emerald-600":"text-red-600"}">
                            <span>${t.date} - ${t.description} [${t.category}]</span>
                            <span>${t.gross.toFixed(2)} ‚Ç¨</span>
                        </div>`).join("") || "<p>Nessuna transazione</p>"}
                </div>
            </div>`;
        }

        function renderReportPage(){
            const summary=calculateFinancialSummary("global","all","all");
            const currentMonth=new Date().toISOString().slice(0,7);
            const budget=appData.budgets[currentMonth]?.limit||0;
            const spent=summary.totalExpenses;
            const percent=budget>0?(spent/budget*100):0;
            return `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold">Riepilogo</h2>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
                        <p>Entrate</p><p class="text-xl text-emerald-600 font-bold">${summary.totalIncomes.toFixed(2)} ‚Ç¨</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
                        <p>Uscite</p><p class="text-xl text-red-600 font-bold">${summary.totalExpenses.toFixed(2)} ‚Ç¨</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card text-center">
                        <p>Saldo</p><p class="text-xl font-bold">${summary.netBalance.toFixed(2)} ‚Ç¨</p>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card">
                    <h3 class="text-lg mb-2">Budget Mensile</h3>
                    <p>Limite: ${budget} ‚Ç¨ | Speso: ${spent.toFixed(2)} ‚Ç¨</p>
                    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                        <div class="bg-emerald-500 h-4 rounded-full" style="width:${Math.min(percent,100)}%"></div>
                    </div>
                </div>
            </div>`;
        }

        function renderSettingsPage(){
            return `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold">Impostazioni</h2>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-3">
                    <h3 class="text-lg font-bold">Categorie</h3>
                    ${appData.categories.map(c=>`<div class="flex justify-between"><span>${c}</span></div>`).join("")}
                    <input type="text" id="new-cat" placeholder="Nuova categoria" class="w-full p-2 border rounded-lg">
                    <button onclick="addCategory()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg">Aggiungi</button>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl card space-y-3">
                    <h3 class="text-lg font-bold">Budget Mensile</h3>
                    <input type="number" id="budget-limit" placeholder="Limite ‚Ç¨" class="w-full p-2 border rounded-lg">
                    <button onclick="saveBudget()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg">Salva</button>
                </div>
            </div>`;
        }
        function addCategory(){
            const val=document.getElementById("new-cat").value.trim();
            if(val && !appData.categories.includes(val)){ appData.categories.push(val); saveData(); renderPage("settings"); }
        }
        function saveBudget(){
            const val=parseFloat(document.getElementById("budget-limit").value);
            if(val>0){ const ym=new Date().toISOString().slice(0,7); appData.budgets[ym]={limit:val}; saveData(); renderPage("report"); }
        }

        // --- Navbar ---
        function renderNavbar(){
            const navbar=document.getElementById('navbar');
            const items=[{id:"activity",label:"Attivit√†",icon:"üíº"},{id:"personal",label:"Personale",icon:"üè†"},{id:"report",label:"Riepilogo",icon:"üìä"},{id:"settings",label:"Impostazioni",icon:"‚öôÔ∏è"}];
            navbar.innerHTML=items.map(i=>`<button onclick="renderPage('${i.id}')" class="p-2 ${currentPage===i.id?"tab-active":""}">${i.icon} <span class="hidden sm:inline">${i.label}</span></button>`).join("");
        }
        function renderPage(pageId){
            currentPage=pageId; renderNavbar();
            const content=document.getElementById('content-area');
            switch(pageId){
                case "activity": content.innerHTML=renderActivityOrPersonalPage("activity");break;
                case "personal": content.innerHTML=renderActivityOrPersonalPage("personal");break;
                case "report": content.innerHTML=renderReportPage();break;
                case "settings": content.innerHTML=renderSettingsPage();break;
            }
        }

        // --- Init ---
        window.onload=()=>{
            loadData(); initDarkMode();
            document.getElementById("dark-mode-toggle").onclick=toggleDarkMode;
            renderPage("activity");
        };
    </script>
</body>
</html>
