<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart – Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        
        /* Modificatori */
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; } /* Più */
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; } /* Senza */
        .mod-btn.yellow { border-color: #facc15; color: #facc15; } /* Poco */
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; } /* Abbondante */
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .search-mod-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }


        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item.active-menu-selection { border: 3px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);} 
        .item.disabled { background: #f0f0f0; color: #999; cursor: not-allowed; opacity: 0.7; }
        .item.disabled:hover { background: #f0f0f0; }

        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }
        
        /* Stili Ordini Attivi e Avvisi Temporali */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative;}
        /* NUOVO: Ordini Futuri */
        .order-card.future-order { border-left: 5px solid #3b82f6; } 
        .order-card.future-order:before { content: "PRENOTAZIONE"; position: absolute; top: -10px; right: 10px; background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        
        .order-card h4 { margin: 0 0 6px; color: #e31b23; display: flex; justify-content: space-between;}
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        .order-actions button.duplicate { background: #facc15; color: #333;}
        
        /* Filtro Ordini Attivi */
        .filter-row-top { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-btn-status { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .filter-btn-status.active { background: #e31b23; color: #fff; border-color: #e31b23; }

        /* Avvisi Temporali (Mantenuti) */
        .order-card.warning-near { border-left: 5px solid #facc15; } /* Giallo (15 min) */
        .order-card.warning-urgent { border-left: 5px solid #b91c1c; } /* Rosso (5 min) */
        .order-card.warning-near:before { content: "ATTENZIONE: Vicino!"; position: absolute; top: -10px; right: 10px; background: #facc15; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .order-card.warning-urgent:before { content: "URGENTE: Imminente!"; position: absolute; top: -10px; right: 10px; background: #b91c1c; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Stili per la stampa (nasconde elementi non necessari) */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 11pt; }

            /* Stili specifici per la comanda */
            .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; }
            .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; }
            .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; }
            .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
            .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; }
            .print-comanda .item-name { font-weight: bold; font-size: 13pt; }
            .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; }
            .print-comanda .mod-list li { border: none; }
            .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; }

            /* Stili specifici per lo scontrino */
            .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; }
            .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; }
            .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
            .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; }
            .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; }
        }

        /* Stili per le Impostazioni (aggiunti/integrati) */
        .settings h3 { color: #444; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .settings form { display: flex; gap: 5px; margin-bottom: 15px; }
        .settings form input, .settings form select, .settings form button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .settings form input[type="text"], .settings form input[type="number"], .settings form select { flex-grow: 1; }
        .settings form button { background: #10b981; color: #fff; border: none; cursor: pointer; }
        
        .settings-list { margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
        .settings-item span { flex-grow: 1; }
        .settings-item .remove { background: #b91c1c; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        .item-status button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .item-status .available { background: #22c55e; color: #fff; }
        .item-status .finished { background: #b91c1c; color: #fff; }

        /* Stili Accesso e Notifiche */
        .access-container { text-align: center; padding: 50px 20px; }
        .access-container input { max-width: 250px; margin: 10px auto; display: block; }
        
        /* NUOVI STILI PER I RUOLI */
        .role-indicator { font-size: 0.8rem; margin-top: 5px; padding: 3px 6px; border-radius: 4px; font-weight: 700; }
        .role-indicator.owner { background: #e31b23; color: #fff; } /* Titolare: Rosso Pizzeria */
        .role-indicator.admin { background: #facc15; color: #333; } /* Admin/Operatore: Giallo */
        /* FINE NUOVI STILI */

        .time-capacity { padding: 10px; border: 1px solid #facc15; background-color: #fffbeb; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; }
        .time-capacity.full { border-color: #b91c1c; background-color: #ffecec; color: #b91c1c; font-weight: 700;}
        .time-capacity.warning { border-color: #facc15; background-color: #fffbeb; }

        .settings-item .actions { display: flex; gap: 5px; }

    </style>
</head>
<body>
</div>
<script src="https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.iife.js"></script>
<script>
    // ⭐ FUNZIONI HELPER PER GESTIRE LE DATE LOCALI ⭐
    function getTodayLocalString() {
        const today = new Date();
        return `${today.getFullYear()}-${
            String(today.getMonth() + 1).padStart(2, '0')
        }-${
            String(today.getDate()).padStart(2, '0')
        }`;
    }

    function getTomorrowLocalString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return `${tomorrow.getFullYear()}-${
            String(tomorrow.getMonth() + 1).padStart(2, '0')
        }-${
            String(tomorrow.getDate()).padStart(2, '0')
        }`;
    }

    function getTodayDateString() {
        return getTodayLocalString();
    }

    function getDefaultHour() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // Arrotonda per eccesso al mezzo euro più vicino (0.00 o 0.50)
    function roundUpToHalf(num) {
        return Math.ceil(num * 2) / 2;
    }
    // ⭐ /FUNZIONI HELPER ⭐

    PetiteVue.createApp({
        view:'inserimento',
        showModal: false, 
        showShareModal: false,
        showMeterModal: false, 
        showHalfPizzaModal: false, 
        showPriceEditModal: false,
        selectedOrderIdForShare: null,
        editingOrderId: null, 
        
        // Accesso e Ruoli (AGGIORNATO)
        adminPin: localStorage.getItem('pz_admin_pin') || '0000', // PIN Admin/Operatore
        ownerPin: localStorage.getItem('pz_owner_pin') || '9999', // PIN Titolare
        newAdminPin: '',
        newOwnerPin: '',
        accessPin: '',
        isAccessGranted: localStorage.getItem('pz_is_access_granted') === 'true' || false, // Mantenere l'accesso per la sessione
        userRole: localStorage.getItem('pz_user_role') || 'Operatore', // 'Operatore', 'Titolare', o '' se non loggato

        // Capacità Oraria
        capacitySettings: JSON.parse(localStorage.getItem('pz_capacity_settings') || '{"maxPizzas": 50, "intervalMinutes": 30}'),
        orderCapacity: { total: 0, remaining: 0, interval: '' },

        // --- DATI INIZIALI ---
        menu: JSON.parse(localStorage.getItem('pz_menu')||'{"Pizze":[{"nome":"Margherita","prezzo":5},{"nome":"Diavola","prezzo":7.5},{"nome":"Quattro Formaggi","prezzo":9},{"nome":"Gorgonzola e Speck","prezzo":10.5}],"Bibite":[{"nome":"Acqua Naturale 1L","prezzo":1.5},{"nome":"Coca Cola 33cl","prezzo":2.5},{"nome":"Birra Artigianale","prezzo":5.5}],"Pizza Metà":[{"nome":"Pizza Divisa a Metà","prezzo":5,"isHalfPizza":true}],"Mezzo Metro":[{"nome":"Intero (1 Gusto)","prezzo":15,"isMeter":true,"sections":[{"name":"Gusto Unico","size":1}]},{"nome":"Diviso in Due (2 Gusti)","prezzo":16,"isMeter":true,"sections":[{"name":"Metà A","size":0.5},{"name":"Metà B","size":0.5}]},{"nome":"Diviso in Tre (3 Gusti)","prezzo":17,"isMeter":true,"sections":[{"name":"Terzo 1","size":0.33},{"name":"Terzo 2","size:0.33},{"name":"Terzo 3","size:0.33}]}],"Schiacciata Grande":[{"nome":"Intera (1 Gusto)","prezzo":12,"isMeter":true,"sections":[{"name":"Gusto Unico","size":1}]},{"nome":"Diviso in Due (2 Gusti)","prezzo":15,"isMeter":true,"sections":[{"name":"Metà A","size":0.5},{"name":"Metà B","size":0.5}]}]}'), // Schiacciata aggiornata a 12€ e 15€
        modifiers: JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[{"nome":"Extra mozzarella","prezzo":1.5},{"nome":"Doppia salsiccia","prezzo":2},{"nome":"Aggiunta Pomodoro","prezzo":0.5}],"Senza":[{"nome":"Senza olive","prezzo":0},{"nome":"Senza sale","prezzo":0}],"Poco":[{"nome":"Poco cotta","prezzo":0}],"Abbondante":[{"nome":"Basilico abbondante","prezzo":0}]}'),
        deliveryZones: JSON.parse(localStorage.getItem('pz_zones')||'[{"name":"Centro","price":2.5},{"name":"Periferia","price":4}]'),
        orders: JSON.parse(localStorage.getItem('pz_orders')||'[]'),
        archive: JSON.parse(localStorage.getItem('pz_archive')||'[]'), 
        drivers: JSON.parse(localStorage.getItem('pz_drivers')||'[]'),
        customerData: JSON.parse(localStorage.getItem('pz_customerData')||'[]'), 

        // Stato Ordine Corrente
        activeCat:'Pizze',
        activeModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più',
        order:[],
        calculatedOrderTotal: 0, 
        total:0, 
        selectedItemIndex: null,
        lastSelectedItem: null, 
        searchTerm: '',
        modifierSearchTerm: '', 
        gustoSearchTerm: '', 

        // Stato Modifica Prezzo
        tempPriceEditIndex: null,
        newPriceValue: 0,

        // Stato Composizione
        tempMeterItem: null, 
        tempHalfPizzaItem: null, 
        tempModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più', 
        
        // Dati per il Modale/Finalizzazione
        modes:[
            {id:"consegna",label:"Consegna a domicilio",icon:"fa-solid fa-truck"},
            {id:"asporto",label:"Asporto",icon:"fa-solid fa-bag-shopping"},
            {id:"banco",label:"Banco",icon:"fa-solid fa-chair"}
        ],
        mode:'',
        customer:'',
        phone:'',
        address:'',
        streetNumber:'',
        zoneName:'', 
        deliveryCost: 0, 
        town:'',
        notes: '',
        tableNumber: '', 
        date: getTodayDateString(), 
        hour: getDefaultHour(),
        driver: '', 
        minDate: getTodayDateString(), 
        accontoRicevuto: null, 

        // Filtri Ordini Attivi
        activeDateFilter: 'today', 
        activeOrderSearchTerm: '', 
        filteredCustomerSuggestions: [],

        // Dati per Storico/Statistiche
        selectedDriver: '', 
        driverStats: { totalOrders: 0, totalRevenue: 0 }, 
        archiveDateFilter: getTodayDateString(),

        // Stati Ordine semplificati
        orderStatuses: ["In preparazione", "Pronto"],

        // Dati per Impostazioni
        activeSettingsCat: 'Pizze', 
        activeSettingsModCat: Object.keys(JSON.parse(localStorage.getItem('pz_modifiers')||'{"Più":[]}'))[0] || 'Più',
        newCategoryName: '',
        newItemName: '',
        newItemPrice: 0,
        newModifierCategoryName: '',
        newModifierName: '',
        newModifierPrice: 0,
        newZoneName: '',
        newZonePrice: 0,
        newDriverName: '',

        get calculatedOrderTotal(){
            if (this.order.length === 0) return 0;
            return this.order.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
        },
        get total(){
            return this.calculatedOrderTotal + this.deliveryCost;
        },
        get restoDaDare(){
            if (this.accontoRicevuto > this.total) {
                return this.accontoRicevuto - this.total;
            }
            return 0;
        },
        get archiveDateFilterDisplay(){
             const date = new Date(this.archiveDateFilter.replace(/-/g, '/'));
             return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
        },
        get availableDrivers(){
            return ["Banco"].concat(this.drivers);
        },
        get selectedOrderForShare() {
            return this.orders.find(o => o.id === this.selectedOrderIdForShare);
        },
        // Stato Ruolo per l'interfaccia (AGGIUNTO)
        get isOwner() {
            return this.isAccessGranted && this.userRole === 'Titolare';
        },
        get isAdmin() {
            return this.isAccessGranted && (this.userRole === 'Titolare' || this.userRole === 'Operatore');
        },


        // LOGICA MENU E MODIFICATORI
        get allItems() {
            return Object.values(this.menu).flat();
        },
        get filteredAvailableItems() {
            let items = this.menu[this.activeCat] || [];
            const term = this.searchTerm.toLowerCase().trim();

            if (term) {
                // Ricerca in tutte le categorie se viene digitato qualcosa
                items = this.allItems.filter(p => p.nome.toLowerCase().includes(term));
            }
            return items;
        },
        get filteredModifiersForActiveCat() {
            let mods = this.modifiers[this.activeModCat] || [];
            const term = this.modifierSearchTerm.toLowerCase().trim();
            if (term) {
                mods = mods.filter(m => m.nome.toLowerCase().includes(term));
            }
            return mods;
        },
        get filteredPizzaGusti() {
            // Filtra solo le pizze base, escludendo composizioni (Metà, Metro)
            let items = this.menu['Pizze'] || [];
            const term = this.gustoSearchTerm.toLowerCase().trim();
            
            if (term) {
                items = items.filter(p => p.nome.toLowerCase().includes(term));
            }
            return items.filter(p => !p.isFinished);
        },
        get canComposeMeter(){
            return this.menu["Pizze"] && this.menu["Pizze"].length > 0;
        },
        get canComposeHalfPizza(){
            return this.menu["Pizze"] && this.menu["Pizze"].length > 0;
        },
        get filteredTempModifiers() {
            let mods = this.modifiers[this.tempModCat] || [];
            const term = this.modifierSearchTerm.toLowerCase().trim(); // Usa il search globale per i modificatori
            if (term) {
                mods = mods.filter(m => m.nome.toLowerCase().includes(term));
            }
            return mods;
        },
        get isMeterValid() {
            // Il Mezzo Metro è valido se tutte le sezioni hanno un gusto selezionato
            if (!this.tempMeterItem || !this.tempMeterItem.sections) return false;
            return this.tempMeterItem.sections.every(s => s.gusto && s.gusto.trim().length > 0);
        },
        get isHalfPizzaValid() {
            // La Pizza a Metà è valida se entrambi i gusti sono stati selezionati
            if (!this.tempHalfPizzaItem) return false;
            return this.tempHalfPizzaItem.gusto1 && this.tempHalfPizzaItem.gusto1.trim().length > 0 && 
                   this.tempHalfPizzaItem.gusto2 && this.tempHalfPizzaItem.gusto2.trim().length > 0;
        },
        // Logica Capacità
        get isCapacityFull() {
            return this.orderCapacity.remaining <= 0;
        },
        get isCapacityWarning() {
            return this.orderCapacity.remaining <= (this.capacitySettings.maxPizzas * 0.2); // Avviso al 20%
        },
        // --- FINE LOGICA MENU ---

        // LOGICA ORDINE ATTIVO E FILTRI
        get filteredActiveOrders() {
            let filtered = [...this.orders].sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.hour}`);
                const dateTimeB = new Date(`${b.date}T${b.hour}`);
                return dateTimeA - dateTimeB;
            });

            const todayStr = getTodayDateString();
            const tomorrowStr = getTomorrowLocalString();

            // 1. Filtro per data (activeDateFilter)
            if (this.activeDateFilter === 'today') {
                filtered = filtered.filter(o => o.date === todayStr);
            } else if (this.activeDateFilter === 'tomorrow') {
                filtered = filtered.filter(o => o.date === tomorrowStr);
            } else if (this.activeDateFilter === 'future') {
                filtered = filtered.filter(o => {
                    const orderDate = new Date(o.date.replace(/-/g, '/'));
                    const tomorrowDate = new Date(tomorrowStr.replace(/-/g, '/'));
                    return orderDate.getTime() > tomorrowDate.getTime();
                });
            }

            // 2. Filtro per termine di ricerca
            if (this.activeOrderSearchTerm.trim()) {
                const term = this.activeOrderSearchTerm.toLowerCase().trim();
                filtered = filtered.filter(o =>
                    o.customer.toLowerCase().includes(term) ||
                    o.tableNumber.toLowerCase().includes(term) ||
                    o.address.toLowerCase().includes(term) ||
                    o.notes.toLowerCase().includes(term)
                );
            }

            return filtered;
        },
        // --- FINE LOGICA ORDINE ATTIVO ---

        // LOGICA STORICO
        get filteredArchive() {
            const dateStr = this.archiveDateFilter;
            return this.archive.filter(o => o.archivedDate.startsWith(dateStr));
        },
        get dailyTotal() {
            return this.filteredArchive.reduce((sum, o) => sum + o.total, 0);
        },
        // --- FINE LOGICA STORICO ---

        // METODI PRINCIPALI

        saveData(){
            localStorage.setItem('pz_menu',JSON.stringify(this.menu));
            localStorage.setItem('pz_orders',JSON.stringify(this.orders));
            localStorage.setItem('pz_modifiers',JSON.stringify(this.modifiers));
            localStorage.setItem('pz_zones',JSON.stringify(this.deliveryZones));
            localStorage.setItem('pz_archive',JSON.stringify(this.archive)); 
            localStorage.setItem('pz_drivers',JSON.stringify(this.drivers)); 
            localStorage.setItem('pz_customerData',JSON.stringify(this.customerData)); 
            localStorage.setItem('pz_capacity_settings', JSON.stringify(this.capacitySettings));
            localStorage.setItem('pz_is_access_granted', this.isAccessGranted);
            localStorage.setItem('pz_user_role', this.userRole);
        },

        calculateItemTotal(item) {
            // Se il prezzo è stato modificato manualmente, restituisce quello
            if (item.manualPrice !== undefined) {
                return item.manualPrice;
            }

            let total = item.prezzo || 0; // Prezzo base dell'articolo (es. 5€ per Metà, 15€ per Mezzo Metro)
            
            // Calcolo modificatori standard
            if (item.modifiers && !item.isMeter && !item.isHalfPizza) {
                total += item.modifiers.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
            }

            // Calcolo modificatori Mezzo Metro / Schiacciata Grande (Prezzo fisso + Modificatori)
            if (item.isMeter && item.sections) {
                // Il prezzo base (item.prezzo) è già il prezzo fisso. Aggiungiamo solo i modificatori.
                total += item.sections.reduce((sectionSum, section) => {
                    if (section.modifiers) {
                        return sectionSum + section.modifiers.reduce((modSum, mod) => modSum + (mod.prezzo || 0), 0);
                    }
                    return sectionSum;
                }, 0);
            }

            // Calcolo Pizza a Metà (AGGIORNATO)
            if (item.isHalfPizza) {
                let gustiPriceSum = 0;
                
                // Cerca il prezzo del gusto 1
                const gusto1Item = this.menu['Pizze']?.find(p => p.nome === item.gusto1);
                if (gusto1Item) gustiPriceSum += gusto1Item.prezzo;
                
                // Cerca il prezzo del gusto 2
                const gusto2Item = this.menu['Pizze']?.find(p => p.nome === item.gusto2);
                if (gusto2Item) gustiPriceSum += gusto2Item.prezzo;

                // Calcolo prezzo medio e arrotondamento (richiesto)
                const gustiPriceAverage = gustiPriceSum / 2;
                
                // Sub-totale: Prezzo base Metà Pizza (es. 5€) + Media Prezzi Gusti Arrotondata
                let subTotal = total + gustiPriceAverage;
                subTotal = roundUpToHalf(subTotal); // Arrotonda per eccesso al mezzo euro

                let modifiersPrice = 0;
                if (item.modifiers1) {
                    modifiersPrice += item.modifiers1.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
                }
                if (item.modifiers2) {
                    modifiersPrice += item.modifiers2.reduce((sum, mod) => sum + (mod.prezzo || 0), 0);
                }

                total = subTotal + modifiersPrice;
            }
            
            return total;
        },
        
        // Logica per l'aggiunta di un prodotto base o composizione
        handleItemClick(item) {
            if (item.isFinished) return; // Non cliccabile se finito
            
            this.lastSelectedItem = item; 
            
            if (item.isMeter) {
                if (!this.canComposeMeter) {
                    alert("Non puoi comporre un Mezzo Metro se non hai pizze base nel Menu!");
                    return;
                }
                this.tempMeterItem = JSON.parse(JSON.stringify(item));
                this.tempMeterItem.sections.forEach(s => {
                    s.gusto = s.gusto || ''; // Mantiene il gusto se già impostato (per i template predefiniti)
                    s.modifiers = s.modifiers || [];
                    s.activeSection = false; 
                });
                this.tempModCat = Object.keys(this.modifiers)[0] || 'Più';
                this.modifierSearchTerm = '';
                this.gustoSearchTerm = '';
                this.showMeterModal = true;
            } else if (item.isHalfPizza) {
                if (!this.canComposeHalfPizza) {
                     alert("Non puoi comporre una Pizza a Metà se non hai pizze base nel Menu!");
                    return;
                }
                this.tempHalfPizzaItem = JSON.parse(JSON.stringify(item));
                // Inizializza i campi per la composizione (AGGIORNATO)
                this.tempHalfPizzaItem.gusto1 = this.tempHalfPizzaItem.gusto1 || '';
                this.tempHalfPizzaItem.gusto2 = this.tempHalfPizzaItem.gusto2 || '';
                this.tempHalfPizzaItem.modifiers1 = this.tempHalfPizzaItem.modifiers1 || [];
                this.tempHalfPizzaItem.modifiers2 = this.tempHalfPizzaItem.modifiers2 || [];
                this.tempHalfPizzaItem.activeHalf = 0; 
                this.tempModCat = Object.keys(this.modifiers)[0] || 'Più';
                this.modifierSearchTerm = '';
                this.gustoSearchTerm = '';
                this.showHalfPizzaModal = true;
            } else {
                this.addItem(item);
            }
        },

        addItem(item) {
             const newItem = JSON.parse(JSON.stringify(item)); 
             if (!newItem.isMeter && !newItem.isHalfPizza) {
                newItem.modifiers = []; 
             }
             this.order.push(newItem);
             this.selectedItemIndex = this.order.length - 1; 
             this.activeModCat = Object.keys(this.modifiers)[0] || 'Più';
             this.modifierSearchTerm = ''; 
             this.updateCapacityWarning();
        },

        addExtra(modifier) {
            if (this.selectedItemIndex === null) {
                alert("Seleziona prima un articolo nel carrello!");
                return;
            }
            if (modifier.isFinished) return; // Modificatore non aggiungibile se finito
            
            const item = this.order[this.selectedItemIndex];
            if (item.isMeter || item.isHalfPizza) return; 
            
            const newMod = JSON.parse(JSON.stringify(modifier));
            if (!item.modifiers) item.modifiers = [];
            
            item.modifiers.push(newMod);
            // Rimuove l'eventuale prezzo manuale per ricalcolare il totale
            if (item.manualPrice !== undefined) delete item.manualPrice;
        },

        removeItem(index) {
            this.order.splice(index, 1);
            if (this.selectedItemIndex === index) {
                this.selectedItemIndex = null;
            } else if (this.selectedItemIndex > index) {
                this.selectedItemIndex--;
            }
            this.updateCapacityWarning();
        },

        // Logica Modifica Prezzo Manuale
        openPriceEditModal(index) {
            this.tempPriceEditIndex = index;
            // Utilizza il prezzo calcolato come punto di partenza
            const currentPrice = this.calculateItemTotal(this.order[index]);
            this.newPriceValue = parseFloat(currentPrice.toFixed(2)); 
            this.showPriceEditModal = true;
        },
        saveNewPrice() {
            if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                const item = this.order[this.tempPriceEditIndex];
                item.manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                alert(`Prezzo di ${item.nome} aggiornato manualmente a €${this.newPriceValue.toFixed(2)}.`);
                
                // Disattiva la selezione per evitare modificatori indesiderati
                this.selectedItemIndex = null; 
            }
            this.showPriceEditModal = false;
            this.tempPriceEditIndex = null;
        },

        // Logica Autocomplete/Clienti (nessuna modifica necessaria)
        filterCustomers() {
            const term = this.customer.toLowerCase().trim();
            if (term.length < 2) {
                this.filteredCustomerSuggestions = [];
                return;
            }
            const uniqueCustomers = [];
            const namesAdded = new Set();
            for (const data of this.customerData) {
                if (data.customer.toLowerCase().includes(term) && !namesAdded.has(data.customer)) {
                    uniqueCustomers.push(data);
                    namesAdded.add(data.customer);
                }
                if (uniqueCustomers.length >= 5) break; 
            }
            this.filteredCustomerSuggestions = uniqueCustomers;
        },
        
        loadCustomerData(data) {
            this.customer = data.customer;
            this.phone = data.phone || '';
            this.address = data.address || '';
            this.streetNumber = data.streetNumber || '';
            this.zoneName = data.zone || '';
            this.town = data.town || '';
            this.deliveryCost = data.deliveryCost || 0; 
            this.updateDeliveryCost();
            this.filteredCustomerSuggestions = [];
        },
        
        saveCustomerData() {
            if (!this.customer.trim()) return;

            const existingIndex = this.customerData.findIndex(c => c.customer === this.customer.trim());

            const newCustomerEntry = {
                customer: this.customer.trim(),
                phone: this.phone.trim(),
                address: this.address.trim(),
                streetNumber: this.streetNumber.trim(),
                zone: this.zoneName,
                town: this.town.trim(),
                deliveryCost: this.deliveryCost,
                lastOrder: Date.now() 
            };
            
            if (existingIndex !== -1) {
                this.customerData.splice(existingIndex, 1); 
            }
            this.customerData.unshift(newCustomerEntry);
            this.customerData = this.customerData.slice(0, 50); 
            this.saveData();
        },

        confermaOrdine(){
            if (this.mode === 'consegna' && !this.zoneName) {
                alert("Seleziona una zona di consegna!");
                return;
            }
            if (!this.date || !this.hour) {
                 alert("Inserisci Data e Ora di ritiro/consegna!");
                 return;
            }
            if (this.isCapacityFull && !confirm("ATTENZIONE: La capacità oraria è piena. Vuoi procedere lo stesso?")) {
                return;
            }

            let ord = {
                id: this.editingOrderId || Date.now(), 
                items: [...this.order],
                total: this.total, 
                mode: this.mode,
                customer: this.customer.trim(),
                phone: this.phone.trim(),
                address: this.address.trim(),
                streetNumber: this.streetNumber.trim(),
                zone: this.zoneName, 
                deliveryCost: this.deliveryCost, 
                town: this.town.trim(),
                notes: this.notes.trim(),
                tableNumber: this.tableNumber.trim(), 
                date: this.date, 
                hour: this.hour,
                driver: this.mode === 'consegna' ? (this.editingOrderId ? (this.orders.find(o => o.id === this.editingOrderId)?.driver || '') : '') : '',
                status: this.editingOrderId ? (this.orders.find(o => o.id === this.editingOrderId)?.status || 'In preparazione') : 'In preparazione', 
                acconto: this.accontoRicevuto || 0 
            };
            
            if (this.editingOrderId) {
                const index = this.orders.findIndex(o => o.id === this.editingOrderId);
                if (index !== -1) {
                    this.orders[index] = ord;
                    alert("Ordine #" + ord.id + " aggiornato!");
                }
            } else {
                this.orders.push(ord);
                alert("Ordine #" + ord.id + " salvato!");
            }
            
            if (this.mode === 'consegna' || (this.mode === 'asporto' && this.customer.trim() && this.phone.trim())) {
                this.saveCustomerData();
            }

            this.saveData();
            this.resetCurrentOrderState();
            this.showModal = false;
            this.view = 'ordini';
        },

        // Logica Stampa Selettiva (Nessuna modifica, mantengo originale)
        printOrder(orderId, type) {
            const order = this.orders.find(o => o.id === orderId) || this.archive.find(o => o.id === orderId);
            if (!order) return;

            const printContainer = document.getElementById('print-content-comanda');
            const scontrinoContainer = document.getElementById('print-content-scontrino');
            
            printContainer.style.display = 'none';
            scontrinoContainer.style.display = 'none';

            let htmlContent = '';
            
            if (type === 'comanda') {
                htmlContent = this.generateComandaHTML(order);
                printContainer.innerHTML = htmlContent;
                printContainer.style.display = 'block';
            } else if (type === 'scontrino') {
                htmlContent = this.generateScontrinoHTML(order);
                scontrinoContainer.innerHTML = htmlContent;
                scontrinoContainer.style.display = 'block';
            }
            
            setTimeout(() => {
                window.print();
                printContainer.style.display = 'none';
                scontrinoContainer.style.display = 'none';
            }, 50);
        },

        generateComandaHTML(order) {
            const now = new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
            let html = `
                <h1>COMANDA CUCINA</h1>
                <p style="text-align: center; margin-bottom: 10px; font-size: 10pt;">Stampa: ${now} | Ordine # ${order.id}</p>
                
                <h2>Dettagli Cliente</h2>
                <p><strong>Modalità:</strong> ${order.mode.toUpperCase()}</p>
                <p><strong>Cliente:</strong> ${order.customer}</p>
                <p><strong>Ora Prevista:</strong> ${order.hour} (${this.formatDate(order.date)})</p>
            `;
            
            if (order.mode === 'banco' || order.mode === 'asporto') {
                html += `<p><strong>Tavolo/Ritiro:</strong> ${order.tableNumber}</p>`;
            }
            if (order.mode === 'consegna') {
                html += `<p><strong>Indirizzo:</strong> ${order.address} ${order.streetNumber}, ${order.zone} (${order.town})</p>
                         <p><strong>Telefono:</strong> ${order.phone}</p>`;
                if (order.driver) {
                    html += `<p><strong>Fattorino:</strong> ${order.driver}</p>`;
                }
            }
            if (order.notes) {
                html += `<p class="note"><strong>NOTE:</strong> ${order.notes}</p>`;
            }

            html += `<h2>Articoli (Totale €${order.total.toFixed(2)})</h2><ul>`;

            order.items.forEach(item => {
                html += `<li><span class="item-name">1x ${item.nome}</span>`;
                
                if (item.manualPrice !== undefined) {
                     html += ` <span style="color:#e31b23; font-size: 0.8rem;">(PREZZO MANUALE: €${item.manualPrice.toFixed(2)})</span>`;
                }

                if (item.modifiers && item.modifiers.length > 0 && !item.isMeter && !item.isHalfPizza) {
                    html += `<ul class="mod-list">`;
                    item.modifiers.forEach(mod => {
                        html += `<li>- ${mod.nome} ${mod.prezzo > 0 ? `(+€${mod.prezzo.toFixed(2)})` : ''}</li>`;
                    });
                    html += `</ul>`;
                }
                
                if (item.isHalfPizza) {
                    html += `<ul class="mod-list" style="margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">
                                <li><strong>METÀ 1: ${item.gusto1}</strong></li>`;
                    if (item.modifiers1 && item.modifiers1.length > 0) {
                         item.modifiers1.forEach(mod => {
                            html += `<li style="padding-left: 10px;">* ${mod.nome}</li>`;
                        });
                    }
                    html += `   <li><strong>METÀ 2: ${item.gusto2}</strong></li>`;
                    if (item.modifiers2 && item.modifiers2.length > 0) {
                         item.modifiers2.forEach(mod => {
                            html += `<li style="padding-left: 10px;">* ${mod.nome}</li>`;
                        });
                    }
                    html += `</ul>`;
                }

                if (item.isMeter) {
                     html += `<ul class="mod-list" style="margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">`;
                     item.sections.forEach(section => {
                         html += `<li><strong>${section.name}: ${section.gusto}</strong></li>`;
                         if (section.modifiers && section.modifiers.length > 0) {
                              section.modifiers.forEach(mod => {
                                 html += `<li style="padding-left: 10px;">* ${mod.nome}</li>`;
                             });
                         }
                     });
                     html += `</ul>`;
                }

                html += `</li>`;
            });

            html += `</ul>`;
            
            return html;
        },

        generateScontrinoHTML(order) {
            const now = new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
            let html = `
                <h1>RIEPILOGO ORDINE</h1>
                <p style="text-align: center; margin-bottom: 10px; font-size: 8pt;">${this.formatDate(order.date)} ${now} | Ordine # ${order.id}</p>
                
                <table>
                    <tr><td colspan="2"><strong>Modalità:</strong> ${order.mode.toUpperCase()}</td></tr>
                    <tr><td colspan="2"><strong>Cliente:</strong> ${order.customer}</td></tr>
                    <tr><td colspan="2"><strong>Ora:</strong> ${order.hour}</td></tr>
            `;

            if (order.mode === 'banco' || order.mode === 'asporto') {
                html += `<tr><td colspan="2"><strong>Tavolo/Ritiro:</strong> ${order.tableNumber}</td></tr>`;
            } else if (order.mode === 'consegna') {
                html += `<tr><td colspan="2"><strong>Indirizzo:</strong> ${order.address} ${order.streetNumber}, ${order.zone}</td></tr>`;
            }

            html += `</table>
                     <hr style="border: 1px dashed #000; margin: 5px 0;">
                     <table>
                        <tr><th>ARTICOLO</th><th style="text-align: right;">TOTALE</th></tr>
            `;

            order.items.forEach(item => {
                const total = this.calculateItemTotal(item).toFixed(2);
                let itemName = item.nome;
                if (item.isHalfPizza) {
                    itemName = `Metà (${item.gusto1}/${item.gusto2})`;
                } else if (item.isMeter) {
                    itemName = `${item.nome}`; // Mantiene il nome base (es. Schiacciata Grande)
                }

                html += `<tr><td>1x ${itemName}</td><td style="text-align: right;">€${total}</td></tr>`;
                
                const allMods = [];
                if (item.modifiers) allMods.push(...item.modifiers);
                if (item.modifiers1) allMods.push(...item.modifiers1);
                if (item.modifiers2) allMods.push(...item.modifiers2);
                item.isMeter && item.sections.forEach(s => s.modifiers && allMods.push(...s.modifiers));
                
                const paidMods = allMods.filter(m => m.prezzo > 0);
                paidMods.forEach(mod => {
                     html += `<tr><td style="font-size: 9pt; padding-left: 10px;">${mod.nome}</td><td style="text-align: right; font-size: 9pt;">+€${mod.prezzo.toFixed(2)}</td></tr>`;
                });
            });

            if (order.deliveryCost > 0) {
                html += `<tr><td>Costo Consegna (${order.zone})</td><td style="text-align: right;">+€${order.deliveryCost.toFixed(2)}</td></tr>`;
            }

            html += `
                        <tr class="total-row"><td style="padding-top: 5px;">TOTALE COMPLESSIVO</td><td style="text-align: right; padding-top: 5px;">€${order.total.toFixed(2)}</td></tr>
                    </table>
                    <hr style="border: 1px dashed #000; margin: 5px 0;">
            `;

            if (order.acconto > 0) {
                const resto = order.acconto - order.total;
                html += `<p style="text-align: right;">Contanti Ricevuti: €${order.acconto.toFixed(2)}</p>`;
                if (resto > 0) {
                    html += `<p style="text-align: right;"><strong>RESTO DA DARE: €${resto.toFixed(2)}</strong></p>`;
                }
            }

            html += `<p style="text-align: center; margin-top: 10px; font-size: 8pt;">Grazie e Arrivederci!</p>`;

            return html;
        },

        // --- FUNZIONI DI IMPOSTAZIONI ---
        isDefaultModifierCategory(cat) {
            const defaultCats = ["Più", "Senza", "Poco", "Abbondante"];
            return defaultCats.includes(cat);
        },

        // Gestione Categorie (nessuna modifica necessaria)
        addCategory() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            const name = this.newCategoryName.trim();
            if (name && !this.menu[name]) {
                this.menu[name] = [];
                this.newCategoryName = '';
                this.activeSettingsCat = name;
                this.saveData();
            } else if (this.menu[name]) {
                alert("Categoria già esistente!");
            }
        },
        deleteCategory(cat) {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            if (confirm(`Sei sicuro di voler eliminare la categoria "${cat}"? Verranno eliminati anche tutti gli articoli al suo interno.`)) {
                delete this.menu[cat];
                this.activeSettingsCat = Object.keys(this.menu)[0] || null;
                this.saveData();
            }
        },

        // Gestione Articoli (nessuna modifica necessaria)
        addItemToCategory() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            const cat = this.activeSettingsCat;
            const name = this.newItemName.trim();
            const price = parseFloat(this.newItemPrice);

            if (name && price >= 0) {
                const existing = this.menu[cat].some(item => item.nome.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Articolo già esistente in questa categoria!");
                    return;
                }
                
                let newItem = { nome: name, prezzo: price };
                // Forza proprietà per categorie speciali (se il nome della categoria le suggerisce)
                if (cat.includes("Metà")) {
                    newItem.isHalfPizza = true;
                } else if (cat.includes("Metro") || cat.includes("Grande")) {
                    newItem.isMeter = true;
                    // Definisce sezioni di default
                    if (cat.includes("Due")) newItem.sections = [{name:"Metà A", size:0.5}, {name:"Metà B", size:0.5}];
                    else if (cat.includes("Tre")) newItem.sections = [{name:"Terzo 1", size:0.33}, {name:"Terzo 2", size:0.33}, {name:"Terzo 3", size:0.33}];
                    else newItem.sections = [{name:"Gusto Unico", size:1}];
                }

                this.menu[cat].push(newItem);
                this.newItemName = '';
                this.newItemPrice = 0;
                this.saveData();
            }
        },
        deleteItem(cat, index) {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            if (confirm(`Sei sicuro di voler eliminare l'articolo "${this.menu[cat][index].nome}"?`)) {
                this.menu[cat].splice(index, 1);
                this.saveData();
            }
        },
        toggleItemFinished(cat, index) {
            if (!this.isAdmin) return alert("Accesso negato. Solo Amministratori e Titolari possono modificare la disponibilità.");
            const item = this.menu[cat][index];
            item.isFinished = !item.isFinished;
            this.saveData();
        },

        // Gestione Modificatori (nessuna modifica necessaria)
        addModifierCategory() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            const name = this.newModifierCategoryName.trim();
            if (name && !this.modifiers[name]) {
                this.modifiers[name] = [];
                this.newModifierCategoryName = '';
                this.activeSettingsModCat = name;
                this.saveData();
            } else if (this.modifiers[name]) {
                alert("Categoria modificatori già esistente!");
            }
        },
        deleteModifierCategory(cat) {
             if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
             if (this.isDefaultModifierCategory(cat)) {
                alert("Non puoi eliminare le categorie predefinite (Più, Senza, Poco, Abbondante).");
                return;
            }
            if (confirm(`Sei sicuro di voler eliminare la categoria di modificatori "${cat}"? Verranno eliminati anche tutti i modificatori al suo interno.`)) {
                delete this.modifiers[cat];
                this.activeSettingsModCat = Object.keys(this.modifiers)[0] || null;
                this.saveData();
            }
        },
        addModifierToCategory() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            const cat = this.activeSettingsModCat;
            const name = this.newModifierName.trim();
            const price = parseFloat(this.newModifierPrice);

            if (name && price >= 0) {
                const existing = this.modifiers[cat].some(mod => mod.nome.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Modificatore già esistente in questa categoria!");
                    return;
                }
                this.modifiers[cat].push({ nome: name, prezzo: price });
                this.newModifierName = '';
                this.newModifierPrice = 0;
                this.saveData();
            }
        },
        deleteModifier(cat, index) {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            if (confirm(`Sei sicuro di voler eliminare il modificatore "${this.modifiers[cat][index].nome}"?`)) {
                this.modifiers[cat].splice(index, 1);
                this.saveData();
            }
        },
        toggleModifierFinished(cat, index) {
            if (!this.isAdmin) return alert("Accesso negato. Solo Amministratori e Titolari possono modificare la disponibilità.");
            const mod = this.modifiers[cat][index];
            mod.isFinished = !mod.isFinished;
            this.saveData();
        },

        // Gestione Zone (nessuna modifica necessaria)
        addZone() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            const name = this.newZoneName.trim();
            const price = parseFloat(this.newZonePrice);

            if (name && price >= 0) {
                const existing = this.deliveryZones.some(z => z.name.toLowerCase() === name.toLowerCase());
                if (existing) {
                    alert("Zona già esistente!");
                    return;
                }
                this.deliveryZones.push({ name: name, price: price });
                this.newZoneName = '';
                this.newZonePrice = 0;
                this.saveData();
            }
        },
        deleteZone(index) {
             if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
             if (confirm(`Sei sicuro di voler eliminare la zona "${this.deliveryZones[index].name}"?`)) {
                this.deliveryZones.splice(index, 1);
                this.saveData();
            }
        },

        // Gestione Fattorini (nessuna modifica necessaria)
        addDriver() {
             if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
             const name = this.newDriverName.trim();
             if (name && !this.drivers.includes(name)) {
                 this.drivers.push(name);
                 this.newDriverName = '';
                 this.saveData();
             } else if (this.drivers.includes(name)) {
                 alert("Fattorino già esistente!");
             }
        },
        deleteDriver(index) {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare le impostazioni.");
            if (confirm(`Sei sicuro di voler eliminare il fattorino "${this.drivers[index]}"?`)) {
                this.drivers.splice(index, 1);
                this.saveData();
            }
        },

        // Gestione Accesso (AGGIORNATO per i Ruoli)
        saveAdminPin() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare i PIN.");
            const newPin = this.newAdminPin.trim();
            if (newPin.length >= 4) {
                this.adminPin = newPin;
                localStorage.setItem('pz_admin_pin', newPin);
                alert("PIN/Password Operatore aggiornato!");
                this.newAdminPin = '';
            } else {
                alert("Il PIN deve essere di almeno 4 caratteri/numeri.");
            }
        },
        saveOwnerPin() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può modificare i PIN.");
            const newPin = this.newOwnerPin.trim();
            if (newPin.length >= 4) {
                this.ownerPin = newPin;
                localStorage.setItem('pz_owner_pin', newPin);
                alert("PIN/Password Titolare aggiornato!");
                this.newOwnerPin = '';
            } else {
                alert("Il PIN deve essere di almeno 4 caratteri/numeri.");
            }
        },
        grantAccess() {
            if (this.accessPin === this.ownerPin) {
                this.isAccessGranted = true;
                this.userRole = 'Titolare';
                this.accessPin = '';
                this.saveData(); // Salva il ruolo e l'accesso
                alert("Accesso consentito come Titolare!");
            } else if (this.accessPin === this.adminPin) {
                this.isAccessGranted = true;
                this.userRole = 'Operatore';
                this.accessPin = '';
                this.saveData(); // Salva il ruolo e l'accesso
                alert("Accesso consentito come Operatore!");
            } else {
                alert("PIN/Password errato.");
                this.accessPin = '';
                this.isAccessGranted = false;
                this.userRole = '';
                this.saveData();
            }
        },
        logout() {
             this.isAccessGranted = false;
             this.userRole = '';
             this.saveData();
             alert("Disconnessione effettuata.");
             this.view = 'ordini';
        },

        // Import/Export/Cache
        exportData() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può esportare i dati.");
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('pz_')) {
                    data[key] = localStorage.getItem(key);
                }
            }
            
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pz_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert("Dati esportati correttamente come pz_export.json");
        },
        importData() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può importare i dati.");
            if (!confirm("ATTENZIONE: Sei sicuro di voler importare i dati? Questo sovrascriverà TUTTI i dati attuali (menu, ordini, storico, impostazioni).")) return;
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        for (const key in importedData) {
                            if (key.startsWith('pz_')) {
                                localStorage.setItem(key, importedData[key]);
                            }
                        }
                        alert("Dati importati con successo! Ricarica l'applicazione per applicare le modifiche.");
                        // ricarica la pagina per applicare i cambiamenti
                        window.location.reload(); 
                    } catch (error) {
                        alert("Errore durante l'importazione del file: " + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        },
        // Logica clearCache (AGGIORNATA per mantenere le impostazioni)
        clearCache() {
            if (!this.isOwner) return alert("Accesso negato. Solo il Titolare può pulire la cache.");
            if (!confirm("ATTENZIONE: Sei sicuro di voler PULIRE la gestione? Questo eliminerà solo gli ORDINI ATTIVI e lo STORICO. TUTTE le impostazioni (menu, prezzi, pin, clienti) saranno MANTENUTE.")) return;
            
            // Chiavi da eliminare (ordini e storico)
            const keysToRemove = ['pz_orders', 'pz_archive'];
            
            keysToRemove.forEach(key => {
                 localStorage.removeItem(key);
            });
            
            alert("Ordini attivi e storico puliti. Ricarica l'applicazione.");
            window.location.reload(); 
        },
        // --- FINE FUNZIONI DI IMPOSTAZIONI ---


        // Altre funzioni di utilità (AGGIORNATE)
        getModifierCategory(modName) {
            for (const cat in this.modifiers) {
                if (this.modifiers[cat].some(m => m.nome === modName)) {
                    return cat;
                }
            }
            return 'Più'; 
        },
        getModifierIcon(cat) {
            const catLower = cat.toLowerCase();
            if (catLower.includes('più')) return '+';
            if (catLower.includes('senza')) return '-';
            if (catLower.includes('poco')) return '↓';
            if (catLower.includes('abbondante')) return '↑';
            return '•';
        },
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr.replace(/-/g, '/')); 
            return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
        },
        isFutureOrder(o) {
            return o.date !== getTodayDateString();
        },
        isNear(o) {
            const now = new Date();
            const orderTime = new Date(`${o.date}T${o.hour}`);
            const diffMinutes = (orderTime - now) / 60000;
            return diffMinutes > 5 && diffMinutes <= 15 && o.date === getTodayDateString() && (o.status === 'In preparazione' || o.status === 'Pronto');
        },
        isUrgent(o) {
            const now = new Date();
            const orderTime = new Date(`${o.date}T${o.hour}`);
            const diffMinutes = (orderTime - now) / 60000;
            return diffMinutes <= 5 && diffMinutes >= 0 && o.date === getTodayDateString() && (o.status === 'In preparazione' || o.status === 'Pronto');
        },
        selectMode(m) {
            this.mode = m;
            this.updateDeliveryCost();
        },
        updateDeliveryCost() {
            if (this.mode === 'consegna' && this.zoneName) {
                const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                this.deliveryCost = zone ? zone.price : 0;
            } else {
                this.deliveryCost = 0;
            }
        },
        resetCurrentOrderState() {
            this.order = [];
            this.editingOrderId = null;
            this.mode = '';
            this.customer = '';
            this.phone = '';
            this.address = '';
            this.streetNumber = '';
            this.zoneName = '';
            this.deliveryCost = 0;
            this.town = '';
            this.notes = '';
            this.tableNumber = '';
            this.date = getTodayDateString();
            this.hour = getDefaultHour();
            this.accontoRicevuto = null;
            this.selectedItemIndex = null;
            this.lastSelectedItem = null;
            this.orderCapacity = { total: 0, remaining: 0, interval: '' };
        },
        editOrder(id) {
            const orderToEdit = this.orders.find(o => o.id === id);
            if (!orderToEdit) return;

            this.editingOrderId = id;
            this.order = JSON.parse(JSON.stringify(orderToEdit.items)); 
            this.mode = orderToEdit.mode;
            this.customer = orderToEdit.customer;
            this.phone = orderToEdit.phone;
            this.address = orderToEdit.address;
            this.streetNumber = orderToEdit.streetNumber;
            this.zoneName = orderToEdit.zone;
            this.town = orderToEdit.town;
            this.notes = orderToEdit.notes;
            this.tableNumber = orderToEdit.tableNumber;
            this.date = orderToEdit.date;
            this.hour = orderToEdit.hour;
            this.accontoRicevuto = orderToEdit.acconto;
            this.updateDeliveryCost();
            this.updateCapacityWarning(); 
            this.view = 'inserimento';
            this.selectedItemIndex = null;
            this.lastSelectedItem = null; 
        },
        cancelEdit() {
            this.resetCurrentOrderState();
            this.view = 'ordini';
        },
        getNextStatus(currentStatus) {
            const index = this.orderStatuses.indexOf(currentStatus);
            if (index === -1 || index === this.orderStatuses.length - 1) {
                return "Archivia"; 
            }
            return this.orderStatuses[index + 1];
        },
        advance(order) {
            const nextStatus = this.getNextStatus(order.status);
            if (nextStatus === "Archivia") {
                this.closeOrderAndArchive(order);
            } else {
                order.status = nextStatus;
                this.saveData();
                alert(`Ordine #${order.id} avanzato a: ${nextStatus}`);
            }
        },
        closeOrderAndArchive(order) {
            if (confirm(`Sei sicuro di voler CHIUDERE e ARCHIVIARE l'ordine #${order.id}?`)) {
                order.archivedDate = new Date().toISOString().substring(0, 10); 
                order.archivedTime = new Date().getTime(); 
                this.archive.push(order);
                this.orders = this.orders.filter(o => o.id !== order.id);
                this.saveData();
                this.calculateDriverStats(); 
                alert(`Ordine #${order.id} archiviato!`);
            }
        },
        updateActiveOrderDriver(id, driver) {
            const order = this.orders.find(o => o.id === id);
            if (order) {
                order.driver = driver;
                this.saveData();
            }
        },
        updateArchiveDriver(id, driver) {
             const order = this.archive.find(o => o.id === id);
             if (order) {
                 order.driver = driver;
                 this.saveData();
                 this.calculateDriverStats(); 
             }
         },
        calculateDriverStats() {
            const dateStr = this.archiveDateFilter;
            const filtered = this.archive.filter(o => o.archivedDate.startsWith(dateStr));

            this.driverStats.totalOrders = 0;
            this.driverStats.totalRevenue = 0;

            let stats = filtered;
            
            if (this.selectedDriver) {
                stats = filtered.filter(o => o.driver === this.selectedDriver);
            } else {
                // Se nessun fattorino selezionato, mostra solo le consegne non assegnate a 'Banco'
                stats = filtered.filter(o => o.mode === 'consegna' && o.driver && o.driver !== 'Banco'); 
            }
            
            this.driverStats.totalOrders = stats.length;
            this.driverStats.totalRevenue = stats.reduce((sum, o) => sum + o.total, 0);
        },
        duplicateOrder(order) {
            if (confirm(`Sei sicuro di voler DUPLICARE l'ordine #${order.id}?`)) {
                this.resetCurrentOrderState(); 
                
                this.order = JSON.parse(JSON.stringify(order.items)); 
                this.mode = order.mode;
                this.customer = order.customer;
                this.phone = order.phone;
                this.address = order.address;
                this.streetNumber = order.streetNumber;
                this.zoneName = order.zone;
                this.town = order.town;
                this.notes = order.notes;
                this.tableNumber = order.tableNumber;
                this.accontoRicevuto = order.acconto; 

                this.date = getTodayDateString(); 
                this.hour = getDefaultHour(); 

                this.updateDeliveryCost();
                this.updateCapacityWarning(); 
                this.view = 'inserimento';
                this.showModal = true; 
            }
        },
        showShareMenu(orderId) {
            this.selectedOrderIdForShare = orderId;
            this.showShareModal = true;
        },
        shareViaWhatsapp(order) {
            let message = `*Nuovo Ordine Pizzeria Smart* - #${order.id}\n`;
            message += `\n*Modalità:* ${order.mode.toUpperCase()}`;
            message += `\n*Cliente:* ${order.customer}`;
            message += `\n*Ora:* ${order.hour} (${this.formatDate(order.date)})`;
            
            if (order.mode === 'consegna') {
                message += `\n*Indirizzo:* ${order.address} ${order.streetNumber}, ${order.town} (${order.zone})`;
                message += `\n*Telefono:* ${order.phone}`;
            } else if (order.mode === 'asporto') {
                message += `\n*Telefono:* ${order.phone}`;
            }
            if (order.tableNumber) {
                 message += `\n*Tavolo/Ritiro:* ${order.tableNumber}`;
            }
            if (order.notes) {
                message += `\n*Note:* ${order.notes}`;
            }
            if (order.driver) {
                message += `\n*Fattorino:* ${order.driver}`;
            }
            
            message += `\n\n*Ordine:*`;
            order.items.forEach(item => {
                let itemLine = `\n- 1x ${item.nome}`;
                if (item.manualPrice !== undefined) {
                    itemLine += ` (Prezzo Man.: €${item.manualPrice.toFixed(2)})`;
                }

                if (item.isHalfPizza) {
                    itemLine += ` (${item.gusto1} / ${item.gusto2})`;
                    
                    const mods1 = item.modifiers1?.map(m => m.nome).join(', ');
                    const mods2 = item.modifiers2?.map(m => m.nome).join(', ');
                    if (mods1) itemLine += `\n  - Metà 1: ${mods1}`;
                    if (mods2) itemLine += `\n  - Metà 2: ${mods2}`;

                } else if (item.isMeter) {
                    item.sections.forEach(section => {
                         itemLine += `\n  - ${section.name}: ${section.gusto}`;
                         if (section.modifiers?.length) {
                             itemLine += ` (${section.modifiers.map(m => m.nome).join(', ')})`;
                         }
                    });
                } else if (item.modifiers?.length) {
                    itemLine += ` (${item.modifiers.map(m => m.nome).join(', ')})`;
                }
                message += itemLine;
            });

            message += `\n\n*TOTALE: €${order.total.toFixed(2)}*`;

            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            this.showShareModal = false;
        },
        
        // Logica composizione Mezzo Metro / Schiacciata Grande (AGGIORNATO)
        selectMeterGusto(secIdx, gustoName) {
            this.tempMeterItem.sections[secIdx].gusto = gustoName;
            this.tempMeterItem.sections[secIdx].activeSection = false; 
            this.gustoSearchTerm = '';
        },
        addMeterModifier(secIdx, modifier) {
             if (modifier.isFinished) return;
             
             const newMod = JSON.parse(JSON.stringify(modifier));
             if (!this.tempMeterItem.sections[secIdx].modifiers) {
                 this.tempMeterItem.sections[secIdx].modifiers = [];
             }
             this.tempMeterItem.sections[secIdx].modifiers.push(newMod);
             
             // Rimuove eventuale prezzo manuale 
             if (this.tempMeterItem.manualPrice !== undefined) delete this.tempMeterItem.manualPrice;
        },
        removeMeterModifier(secIdx, modIdx) {
            this.tempMeterItem.sections[secIdx].modifiers.splice(modIdx, 1);
            if (this.tempMeterItem.manualPrice !== undefined) delete this.tempMeterItem.manualPrice;
        },
        cancelMeterComposition() {
            this.tempMeterItem = null;
            this.showMeterModal = false;
            this.lastSelectedItem = null; 
        },
        addMeterToOrder() {
            if (!this.isMeterValid) return;
            const itemToAdd = JSON.parse(JSON.stringify(this.tempMeterItem));
            this.order.push(itemToAdd);
            this.selectedItemIndex = this.order.length - 1;
            this.tempMeterItem = null;
            this.showMeterModal = false;
            this.updateCapacityWarning();
        },
        get calculateTempMeterTotal() {
            return this.tempMeterItem ? this.calculateItemTotal(this.tempMeterItem) : 0;
        },

        // Logica composizione Pizza a Metà (AGGIORNATO)
        selectHalfPizzaGusto(half, gustoName) {
            if (half === 1) {
                this.tempHalfPizzaItem.gusto1 = gustoName;
            } else {
                this.tempHalfPizzaItem.gusto2 = gustoName;
            }
            this.tempHalfPizzaItem.activeHalf = 0;
            this.gustoSearchTerm = '';
        },
        addHalfPizzaModifier(half, modifier) {
            if (modifier.isFinished) return;

            const newMod = JSON.parse(JSON.stringify(modifier));
            if (half === 1) {
                if (!this.tempHalfPizzaItem.modifiers1) this.tempHalfPizzaItem.modifiers1 = [];
                this.tempHalfPizzaItem.modifiers1.push(newMod);
            } else {
                if (!this.tempHalfPizzaItem.modifiers2) this.tempHalfPizzaItem.modifiers2 = [];
                this.tempHalfPizzaItem.modifiers2.push(newMod);
            }
            // Rimuove eventuale prezzo manuale
            if (this.tempHalfPizzaItem.manualPrice !== undefined) delete this.tempHalfPizzaItem.manualPrice;
        },
        removeHalfPizzaModifier(half, modIdx) {
            if (half === 1) {
                this.tempHalfPizzaItem.modifiers1.splice(modIdx, 1);
            } else {
                this.tempHalfPizzaItem.modifiers2.splice(modIdx, 1);
            }
             if (this.tempHalfPizzaItem.manualPrice !== undefined) delete this.tempHalfPizzaItem.manualPrice;
        },
        cancelHalfPizzaComposition() {
            this.tempHalfPizzaItem = null;
            this.showHalfPizzaModal = false;
            this.lastSelectedItem = null; 
        },
        addHalfPizzaToOrder() {
            if (!this.isHalfPizzaValid) return;
            const itemToAdd = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
            this.order.push(itemToAdd);
            this.selectedItemIndex = this.order.length - 1;
            this.tempHalfPizzaItem = null;
            this.showHalfPizzaModal = false;
            this.updateCapacityWarning();
        },
        get calculateTempHalfPizzaTotal() {
            return this.tempHalfPizzaItem ? this.calculateItemTotal(this.tempHalfPizzaItem) : 0;
        },
        selectItem(index) {
            this.selectedItemIndex = this.selectedItemIndex === index ? null : index;
        },

        // Logica Capacità Oraria (nessuna modifica necessaria)
        getIntervalStart(dateStr, hourStr) {
            const date = new Date(`${dateStr}T${hourStr}`);
            const intervalMinutes = this.capacitySettings.intervalMinutes;
            const minutes = date.getMinutes();
            const startMinutes = Math.floor(minutes / intervalMinutes) * intervalMinutes;
            
            date.setMinutes(startMinutes);
            date.setSeconds(0);
            date.setMilliseconds(0);
            
            return date.toISOString();
        },
        getPizzasInOrder(order) {
            return order.items.filter(i => 
                (this.menu['Pizze'] && this.menu['Pizze'].some(p => p.nome === i.nome)) ||
                i.isHalfPizza || i.isMeter
            ).length;
        },
        updateCapacityWarning() {
            if (!this.date || !this.hour) return;

            const targetInterval = this.getIntervalStart(this.date, this.hour);
            let pizzasCount = 0;

            this.orders.forEach(o => {
                if (o.date === this.date) {
                    const orderInterval = this.getIntervalStart(o.date, o.hour);
                    if (orderInterval === targetInterval) {
                        // Esclude l'ordine in modifica dal conteggio per evitare duplicati
                        if (o.id !== this.editingOrderId) { 
                             pizzasCount += this.getPizzasInOrder(o);
                        }
                    }
                }
            });

            // Aggiunge le pizze dell'ordine corrente che si sta creando/modificando
            pizzasCount += this.order.filter(i => 
                (this.menu['Pizze'] && this.menu['Pizze'].some(p => p.nome === i.nome)) ||
                i.isHalfPizza || i.isMeter
            ).length;
            
            this.orderCapacity.total = pizzasCount;
            this.orderCapacity.remaining = this.capacitySettings.maxPizzas - pizzasCount;
            this.orderCapacity.interval = targetInterval;
        },
        openModal() {
            this.zoneName = this.deliveryZones[0]?.name || ''; 
            this.updateDeliveryCost(); 
            this.updateCapacityWarning();
            this.showModal = true;
        },

        // Inizializzazione (nessuna modifica necessaria)
        mounted() {
            if (this.drivers.length === 0) {
                this.drivers = ["Mario Rossi", "Luca Bianchi"];
                this.saveData();
            }
            this.calculateDriverStats();
        }
    }).mount()
</script>
</body>
</html>
