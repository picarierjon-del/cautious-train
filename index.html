<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzeria Smart - Gestione Ordini</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #d32f2f; /* Rosso pizzeria */
            --secondary-color: #ffc107; /* Giallo/Arancio */
            --background-light: #f5f5f5;
            --background-dark: #333;
            --text-light: #fff;
            --text-dark: #212121;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #app {
            display: flex;
            flex-grow: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .nav-bar {
            display: flex;
            gap: 10px;
        }

        .nav-button {
            background-color: var(--secondary-color);
            color: var(--text-dark);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }

        .nav-button:hover:not(.active) {
            background-color: #ffd740;
        }

        .nav-button.active {
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        .main-content {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
        }

        /* VISTA INSERIMENTO */
        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            flex: 1;
            background-color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            padding: 15px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 100px);
        }

        .menu-selection, .modifier-selection {
            background-color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }

        .menu-tabs, .modifier-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-button {
            flex-shrink: 0;
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: var(--background-light);
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        .item-list, .modifier-list {
            display: grid;
            gap: 10px;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 5px;
        }
        
        .item-list {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .item-card {
            background-color: var(--background-light);
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
        }

        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .item-card.finished {
            background-color: #e0e0e0;
            color: #757575;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .item-card .price {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .modifier-list {
             grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        
        .modifier-button {
            padding: 10px 5px;
            border-radius: 5px;
            border: 1px solid var(--secondary-color);
            background-color: #fffde7;
            cursor: pointer;
            transition: background-color 0.1s;
            font-size: 0.9em;
            text-align: center;
        }

        .modifier-button:hover {
            background-color: var(--secondary-color);
        }
        
        .modifier-button.finished {
            background-color: #e0e0e0;
            color: #757575;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* CARRELLO ORDINE */
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .order-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px dashed #ddd;
            cursor: pointer;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }

        .order-item.selected {
            background-color: #ffebee;
            border-left: 5px solid var(--primary-color);
            padding-left: 3px;
        }
        
        .item-details {
            flex-grow: 1;
        }

        .item-details small {
            display: block;
            color: #757575;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .remove-btn, .edit-price-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
        }
        
        .edit-price-btn {
            color: var(--warning-color);
        }

        .summary {
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 1em;
        }

        .summary-row strong {
            font-size: 1.2em;
            color: var(--primary-color);
        }

        .finalize-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--success-color);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Modale */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-container {
            background-color: var(--text-light);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
        }
        
        .modal-large {
            max-width: 900px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #757575;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .mode-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-button {
            flex-grow: 1;
            padding: 15px;
            border: 2px solid #ddd;
            background-color: var(--background-light);
            cursor: pointer;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
        }

        .mode-button.active {
            border-color: var(--primary-color);
            background-color: #ffebee;
            font-weight: bold;
        }
        
        .mode-button i {
            font-size: 1.5em;
            margin-bottom: 5px;
            display: block;
        }

        /* VISTA ORDINI ATTIVI */
        .orders-view {
            width: 100%;
            padding: 20px;
        }

        .orders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .order-card {
            background-color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-top: 5px solid var(--primary-color);
        }
        
        .order-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px dashed #ddd;
        }
        
        .order-card-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .order-card ul {
            list-style: none;
            padding: 0;
            margin: 0 0 10px 0;
            overflow-y: auto;
            max-height: 150px; 
            font-size: 0.9em;
        }
        
        .order-card ul li {
            padding: 2px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .order-card .info-details {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .card-actions button {
            flex-grow: 1;
            padding: 10px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .btn-ready {
            background-color: var(--secondary-color);
            color: var(--text-dark);
        }
        
        .btn-ready:hover {
            background-color: #ffd740;
        }

        .btn-archive {
            background-color: var(--success-color);
            color: var(--text-light);
        }
        
        .btn-archive:hover {
            background-color: #43a047;
        }
        
        .btn-edit {
            background-color: #e0e0e0;
            color: var(--text-dark);
        }

        /* VISTA STORICO */
        .history-view {
            width: 100%;
            padding: 20px;
        }

        .history-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .history-stats {
            background-color: var(--text-light);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            font-weight: bold;
            font-size: 1.1em;
            border-left: 5px solid var(--primary-color);
        }

        .history-table-container {
            overflow-x: auto;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--text-light);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .history-table th {
            background-color: var(--primary-color);
            color: var(--text-light);
            text-transform: uppercase;
            font-size: 0.9em;
        }
        
        .history-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8em;
            color: var(--text-light);
        }

        .badge.ready { background-color: var(--secondary-color); color: var(--text-dark); }
        .badge.delivered { background-color: var(--success-color); }
        .badge.topay { background-color: var(--danger-color); }
        .badge.paid { background-color: var(--primary-color); }

        /* VISTA IMPOSTAZIONI */
        .settings-view {
            display: flex;
            width: 100%;
            gap: 20px;
            padding: 20px;
        }
        
        .settings-sidebar {
            flex: 1;
            min-width: 200px;
        }
        
        .settings-content {
            flex: 3;
            background-color: var(--text-light);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .settings-sidebar button {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background-color: var(--background-light);
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .settings-sidebar button.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }
        
        .settings-section h3 {
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .settings-item-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .settings-item-card {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            width: 180px;
            position: relative;
        }

        .settings-item-card input[type="text"], 
        .settings-item-card input[type="number"] {
            width: 100%;
            padding: 5px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        .status-toggle {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .status-toggle.finished {
            color: var(--danger-color);
        }
        
        .status-toggle.available {
            color: var(--success-color);
        }

        /* MODALE COMPOSIZIONE MEZZO METRO */
        .meter-modal-content {
            display: flex;
            gap: 20px;
        }

        .meter-sections {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .meter-section-card {
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .meter-section-card.active {
            border-color: var(--primary-color);
            background-color: #ffebee;
        }

        .meter-section-card .modifiers-list-small {
            font-size: 0.8em;
            color: #757575;
        }

        .meter-gusto-picker {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .meter-modifiers-picker {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .composition-gusto-list {
            overflow-y: auto;
            max-height: 250px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 5px;
        }
        
        .meter-controls {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        
        .meter-controls button {
            padding: 8px 15px;
            border: 1px solid var(--secondary-color);
            background-color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .meter-controls button.active {
             background-color: var(--secondary-color);
             font-weight: bold;
        }
        
        /* Utilità */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-10 { margin-top: 10px; }
        .mb-10 { margin-bottom: 10px; }
        .flex-row { display: flex; align-items: center; gap: 10px; }
        .flex-grow { flex-grow: 1; }

        /* Login */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .login-box {
            background-color: var(--text-light);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 300px;
        }

        .login-box h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .login-box input {
            padding: 10px;
            margin-bottom: 15px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Stato Ordine */
        .status-badge {
            font-size: 0.9em;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .status-badge.pending { background-color: #ff9800; color: var(--text-light); } /* Giallo/Arancio */
        .status-badge.ready { background-color: var(--secondary-color); color: var(--text-dark); } /* Giallo */
        .status-badge.delivered { background-color: var(--success-color); color: var(--text-light); } /* Verde */
        
        .payment-status-badge {
            font-size: 0.8em;
            font-weight: bold;
            padding: 3px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        .payment-status-badge.DaPagare { background-color: var(--danger-color); color: var(--text-light); }
        .payment-status-badge.Pagato { background-color: var(--success-color); color: var(--text-light); }
        
        /* Capacità */
        .capacity-bar {
            background-color: #ddd;
            border-radius: 5px;
            height: 15px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .capacity-level {
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.3s;
        }

        .capacity-level.warning { background-color: var(--warning-color); }
        .capacity-level.full { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div id="app">
        
        <div class="login-overlay" v-if="!isAccessGranted">
            <div class="login-box">
                <h2>Accesso Pizzeria Smart</h2>
                <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password">
                <button @click="grantAccess">ACCEDI</button>
            </div>
        </div>

        <header class="header">
            <h1>Pizzeria Smart</h1>
            <div class="nav-bar">
                <button class="nav-button" :class="{ active: view === 'inserimento' }" @click="view = 'inserimento'">
                    <i class="fas fa-pizza-slice"></i> Inserimento Ordine
                </button>
                <button class="nav-button" :class="{ active: view === 'ordini' }" @click="view = 'ordini'">
                    <i class="fas fa-clipboard-list"></i> Ordini Attivi
                </button>
                <button class="nav-button" :class="{ active: view === 'storico' }" @click="view = 'storico'">
                    <i class="fas fa-history"></i> Storico/Cassa
                </button>
                <button class="nav-button" :class="{ active: view === 'impostazioni' }" @click="view = 'impostazioni'" :disabled="!isOwner">
                    <i class="fas fa-cog"></i> Impostazioni <span v-if="!isOwner" style="color:#d32f2f;">(Titolare)</span>
                </button>
                <button class="nav-button" @click="logout" v-if="isAccessGranted">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <main class="main-content" v-if="isAccessGranted">
            
            <div class="left-panel" v-if="view === 'inserimento'">
                <div class="menu-selection">
                    <div class="flex-row mb-10">
                         <div class="menu-tabs">
                            <button v-for="(items, category) in menu" :key="category" class="tab-button" 
                                :class="{ active: activeCat === category }" @click="activeCat = category">
                                {{ category }}
                            </button>
                        </div>
                        <input type="text" v-model="searchTerm" placeholder="Cerca pizza..." class="flex-grow">
                    </div>

                    <div class="item-list">
                        <div v-for="item in filteredAvailableItems" :key="item.nome" 
                             class="item-card" :class="{ 'finished': item.isFinished }" 
                             @click="handleItemClick(item)">
                            <span>{{ item.nome }}</span>
                            <span class="price">€{{ item.prezzo.toFixed(2) }}</span>
                            <i v-if="item.isFinished" class="fas fa-ban" style="position: absolute; top: 5px; left: 5px; color: var(--danger-color);"></i>
                        </div>
                    </div>
                </div>
                
                <div class="modifier-selection">
                    <div class="flex-row mb-10">
                        <div class="modifier-tabs">
                            <button v-for="(mods, category) in modifiers" :key="category" class="tab-button" 
                                :class="{ active: activeModCat === category }" @click="activeModCat = category">
                                {{ category }}
                            </button>
                        </div>
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="flex-grow">
                    </div>
                    
                    <div class="modifier-list">
                        <button v-for="mod in filteredModifiersForActiveCat" :key="mod.nome" 
                                class="modifier-button" :class="{ 'finished': mod.isFinished }" 
                                @click="addExtra(mod)" :disabled="selectedItemIndex === null || mod.isFinished">
                            {{ mod.nome }} 
                            <span v-if="mod.prezzo > 0" class="price">(+€{{ mod.prezzo.toFixed(2) }})</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="right-panel" v-if="view === 'inserimento'">
                <div class="cart-header">
                    <h2>Carrello ({{ order.length }})</h2>
                    <button class="nav-button" @click="resetOrder" v-if="order.length > 0">Svuota</button>
                </div>
                
                <div class="order-list">
                    <div v-if="order.length === 0" class="text-center" style="color: #757575;">
                        Aggiungi pizze o composizioni dal menu a sinistra.
                    </div>
                    
                    <div v-for="(item, index) in order" :key="index" 
                         class="order-item" :class="{ selected: selectedItemIndex === index }" 
                         @click="selectItem(index)">
                        
                        <div class="item-details">
                            <strong>{{ item.nome }}</strong>
                            <small v-if="item.isHalfPizza">
                                Metà 1: {{ item.gusto1 }} 
                                ({{ item.modifiers1.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})
                            </small>
                            <small v-if="item.isHalfPizza">
                                Metà 2: {{ item.gusto2 }} 
                                ({{ item.modifiers2.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }})
                            </small>
                            <small v-else-if="item.isMeter">
                                Suddivisione: {{ item.gustoCount }} Gusti
                            </small>
                            <small v-else-if="item.modifiers && item.modifiers.length > 0">
                                {{ item.modifiers.map(m => getModifierIcon(getModifierCategory(m.nome)) + m.nome).join(', ') }}
                            </small>
                        </div>
                        
                        <div class="text-right">
                            <span style="font-weight: bold;">€{{ calculateItemTotal(item).toFixed(2) }}</span>
                        </div>
                        
                        <div class="item-actions">
                             <button @click.stop="openPriceEditModal(index)" class="edit-price-btn" title="Modifica Prezzo Manualmente">
                                <i class="fas fa-tag"></i>
                            </button>
                            <button @click.stop="removeItem(index)" class="remove-btn" title="Rimuovi Articolo">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="summary">
                    <div class="summary-row" @click="showModal = true" style="cursor: pointer;">
                        <span><i class="fas fa-money-bill-wave"></i> Stato Pagamento</span>
                        <span :class="['payment-status-badge', paymentStatus]">{{ paymentStatus }}</span>
                    </div>
                     <div class="summary-row" @click="showModal = true" style="cursor: pointer;">
                        <span><i class="fas fa-percent"></i> Sconto ({{ discountPercentage }}%)</span>
                        <span style="color: var(--danger-color);">-€{{ discount.toFixed(2) }}</span>
                    </div>

                    <div class="summary-row">
                        <span>Subtotale</span>
                        <span>€{{ calculatedOrderTotal.toFixed(2) }}</span>
                    </div>
                    
                    <div class="summary-row" v-if="mode === 'consegna'">
                        <span>Costo Consegna</span>
                        <span>+€{{ deliveryCost.toFixed(2) }}</span>
                    </div>
                    
                    <div class="summary-row">
                        <strong>Totale Finale</strong>
                        <strong>€{{ total.toFixed(2) }}</strong>
                    </div>

                    <button class="finalize-btn" @click="openFinalizeModal" :disabled="order.length === 0">
                        FINALIZZA ORDINE
                    </button>
                    
                     <div class="mt-10">
                        <small>Capacità attuale ({{ orderCapacity.interval }}): {{ orderCapacity.remaining }}/{{ orderCapacity.total }}</small>
                        <div class="capacity-bar">
                            <div class="capacity-level" :class="{ 'warning': isCapacityWarning, 'full': isCapacityFull }" 
                                 :style="{ width: capacityPercentage + '%' }">
                            </div>
                        </div>
                        <small v-if="isCapacityWarning" style="color: var(--danger-color); font-weight: bold;">Attenzione: Capacità limitata o piena!</small>
                    </div>
                </div>
            </div>

            <div class="orders-view" v-if="view === 'ordini'">
                <div class="history-filters">
                    <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente/Tavolo/Indirizzo...">
                    <select v-model="activeDateFilter">
                        <option value="today">Oggi</option>
                        <option value="tomorrow">Domani</option>
                        <option value="future">Futuro (Dopo Domani)</option>
                        <option value="all">Tutti</option>
                    </select>
                </div>

                <div class="orders-grid">
                    <div v-for="order in filteredActiveOrders" :key="order.id" class="order-card">
                        <div class="order-card-header">
                            <h3>Ordine #{{ order.id }}</h3>
                            <span :class="['status-badge', order.status.toLowerCase()]">{{ order.status }}</span>
                        </div>
                        
                        <div class="info-details">
                             <p style="margin: 0; font-weight: bold;">
                                <i class="fas fa-clock"></i> Ritiro: {{ order.hour }} ({{ order.date | formatDate }})
                            </p>
                            <p style="margin: 5px 0;">
                                <i :class="getModeIcon(order.mode)"></i> 
                                {{ order.mode === 'banco' ? `Tavolo: ${order.tableNumber}` : order.customer }}
                            </p>
                            <p v-if="order.mode === 'consegna'" style="margin: 5px 0;">
                                <i class="fas fa-map-marker-alt"></i> {{ order.address }}
                                <span v-if="order.driver"> (Consegna: {{ order.driver }})</span>
                            </p>
                            <span :class="['payment-status-badge', order.paymentStatus]">{{ order.paymentStatus }}</span>
                            <span v-if="order.accontoRicevuto > 0" class="payment-status-badge" style="background-color: blue;">Acconto: €{{ order.accontoRicevuto.toFixed(2) }}</span>
                        </div>
                        
                        <ul class="mb-10">
                            <li v-for="(item, i) in order.items" :key="i">
                                <span>{{ item.nome }}</span>
                                <span>€{{ calculateItemTotal(item).toFixed(2) }}</span>
                            </li>
                        </ul>
                        
                        <div class="text-right" style="font-size: 1.2em; font-weight: bold; color: var(--primary-color);">
                            TOTALE: €{{ order.total.toFixed(2) }}
                        </div>

                        <div class="card-actions">
                            <button @click="openEditOrderModal(order.id)" class="btn-edit" title="Modifica Ordine">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button @click="toggleOrderStatus(order.id)" class="btn-ready">
                                <i class="fas fa-bell"></i> {{ order.status === 'Pending' ? 'PRONTO' : 'PENDING' }}
                            </button>
                            <button @click="archiveOrder(order.id)" class="btn-archive">
                                <i class="fas fa-check"></i> ARCHIVIA
                            </button>
                            <button @click="openShareModal(order)" class="btn-edit" title="Condividi">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="filteredActiveOrders.length === 0" class="text-center" style="grid-column: 1 / -1; color: #757575;">
                        Nessun ordine attivo trovato per il filtro selezionato.
                    </div>
                </div>
            </div>

            <div class="history-view" v-if="view === 'storico'">
                <h2>Storico Giornaliero e Cassa</h2>
                
                <div class="history-filters">
                    <label for="date-filter">Seleziona Data:</label>
                    <input type="date" id="date-filter" v-model="archiveDateFilter" :max="minDate">
                    
                    <label for="driver-filter">Filtra per Fattorino:</label>
                    <select id="driver-filter" v-model="selectedDriver" @change="calculateDriverStats">
                        <option value="">Tutti</option>
                        <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                    </select>
                </div>
                
                <div class="history-stats">
                    <span>Data: {{ archiveDateFilterDisplay }}</span>
                    <span>Totale Ordini: {{ filteredArchive.length }}</span>
                    <span>Incasso Totale: **€{{ dailyTotal.toFixed(2) }}**</span>
                    <span v-if="selectedDriver">Ordini Fattorino ({{ selectedDriver }}): {{ driverStats.totalOrders }}</span>
                    <span v-if="selectedDriver">Incasso Fattorino: €{{ driverStats.totalRevenue.toFixed(2) }}</span>
                </div>
                
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ora</th>
                                <th>Tipo</th>
                                <th>Cliente/Tavolo</th>
                                <th>Fattorino</th>
                                <th>Stato Pag.</th>
                                <th>Totale</th>
                                <th>Dettagli</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in filteredArchive" :key="order.id">
                                <td>#{{ order.id }}</td>
                                <td>{{ order.hour }}</td>
                                <td>{{ getModeName(order.mode) }}</td>
                                <td>{{ order.mode === 'banco' ? `Tavolo ${order.tableNumber}` : order.customer }}</td>
                                <td>{{ order.driver || '-' }}</td>
                                <td><span :class="['payment-status-badge', order.paymentStatus]">{{ order.paymentStatus }}</span></td>
                                <td style="font-weight: bold;">€{{ order.total.toFixed(2) }}</td>
                                <td>
                                    <span style="cursor: pointer; color: var(--primary-color);" @click="showArchiveDetails(order)">Dettagli</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                     <div v-if="filteredArchive.length === 0" class="text-center" style="padding: 20px; color: #757575;">
                        Nessun ordine archiviato per questa data/filtro.
                    </div>
                </div>
            </div>

            <div class="settings-view" v-if="view === 'impostazioni'">
                <div class="settings-sidebar">
                    <button @click="activeSettingsView = 'menu'" :class="{ active: activeSettingsView === 'menu' }">
                        <i class="fas fa-pizza-slice"></i> Menu Articoli
                    </button>
                    <button @click="activeSettingsView = 'modifiers'" :class="{ active: activeSettingsView === 'modifiers' }">
                         <i class="fas fa-plus"></i> Modificatori
                    </button>
                    <button @click="activeSettingsView = 'delivery'" :class="{ active: activeSettingsView === 'delivery' }">
                         <i class="fas fa-truck"></i> Consegna/Fattorini
                    </button>
                    <button @click="activeSettingsView = 'capacity'" :class="{ active: activeSettingsView === 'capacity' }">
                         <i class="fas fa-thermometer-three-quarters"></i> Capacità Forno
                    </button>
                    <button @click="activeSettingsView = 'prices'" :class="{ active: activeSettingsView === 'prices' }">
                        <i class="fas fa-euro-sign"></i> Prezzi Composizioni
                    </button>
                    <button @click="activeSettingsView = 'security'" :class="{ active: activeSettingsView === 'security' }">
                        <i class="fas fa-lock"></i> Sicurezza (PIN)
                    </button>
                </div>
                
                <div class="settings-content">
                    <div v-if="activeSettingsView === 'menu'" class="settings-section">
                        <h3>Gestione Menu Articoli</h3>
                        
                        <div class="menu-tabs">
                            <button v-for="(items, category) in menu" :key="category" class="tab-button" 
                                :class="{ active: activeSettingsCat === category }" @click="activeSettingsCat = category">
                                {{ category }}
                            </button>
                            <button class="tab-button" @click="addNewCategory('menu')">
                                <i class="fas fa-folder-plus"></i> Nuova Categoria
                            </button>
                        </div>

                        <div class="settings-item-list">
                            <div v-for="(item, index) in menu[activeSettingsCat]" :key="index" class="settings-item-card">
                                <div class="status-toggle" :class="{ 'finished': item.isFinished, 'available': !item.isFinished }" @click="toggleItemStatus(activeSettingsCat, index)">
                                    <i :class="item.isFinished ? 'fas fa-ban' : 'fas fa-check-circle'"></i>
                                </div>
                                <label>Nome</label>
                                <input type="text" v-model="item.nome" placeholder="Nome Articolo">
                                <label>Prezzo</label>
                                <input type="number" v-model.number="item.prezzo" step="0.50" min="0">
                                <button @click="removeItemFromMenu(activeSettingsCat, index)" class="remove-btn" style="color: var(--danger-color); margin-top: 10px;">Rimuovi</button>
                            </div>
                            
                            <button class="item-card" @click="addNewItemToMenu(activeSettingsCat)" style="border: 2px dashed #ccc; background: #fafafa; height: 100px;">
                                <i class="fas fa-plus-circle"></i> Aggiungi Articolo
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="activeSettingsView === 'modifiers'" class="settings-section">
                        <h3>Gestione Modificatori</h3>
                        
                        <div class="modifier-tabs">
                            <button v-for="(mods, category) in modifiers" :key="category" class="tab-button" 
                                :class="{ active: activeSettingsModCat === category }" @click="activeSettingsModCat = category">
                                {{ category }}
                            </button>
                            <button class="tab-button" @click="addNewCategory('modifiers')">
                                <i class="fas fa-folder-plus"></i> Nuova Categoria
                            </button>
                        </div>
                        
                        <div class="settings-item-list">
                            <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="index" class="settings-item-card">
                                <div class="status-toggle" :class="{ 'finished': mod.isFinished, 'available': !mod.isFinished }" @click="toggleModifierStatus(activeSettingsModCat, index)">
                                    <i :class="mod.isFinished ? 'fas fa-ban' : 'fas fa-check-circle'"></i>
                                </div>
                                <label>Nome</label>
                                <input type="text" v-model="mod.nome" placeholder="Nome Modificatore">
                                <label>Prezzo (+)</label>
                                <input type="number" v-model.number="mod.prezzo" step="0.10" min="0">
                                <button @click="removeItemFromModifiers(activeSettingsModCat, index)" class="remove-btn" style="color: var(--danger-color); margin-top: 10px;">Rimuovi</button>
                            </div>

                            <button class="item-card" @click="addNewItemToModifiers(activeSettingsModCat)" style="border: 2px dashed #ccc; background: #fafafa; height: 100px;">
                                <i class="fas fa-plus-circle"></i> Aggiungi Modificatore
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="activeSettingsView === 'delivery'" class="settings-section">
                        <h3>Zone di Consegna e Fattorini</h3>
                        
                        <h4>Zone di Consegna (Costo Fisso)</h4>
                        <div class="settings-item-list">
                             <div v-for="(zone, index) in deliveryZones" :key="index" class="settings-item-card">
                                <label>Nome Zona</label>
                                <input type="text" v-model="zone.name" placeholder="Esempio: Zona Centrale">
                                <label>Costo Consegna</label>
                                <input type="number" v-model.number="zone.price" step="0.50" min="0">
                                <button @click="removeDeliveryZone(index)" class="remove-btn" style="color: var(--danger-color); margin-top: 10px;">Rimuovi</button>
                            </div>
                            <button class="item-card" @click="addDeliveryZone" style="border: 2px dashed #ccc; background: #fafafa; height: 100px;">
                                <i class="fas fa-plus-circle"></i> Aggiungi Zona
                            </button>
                        </div>
                        
                        <h4 class="mt-10">Fattorini</h4>
                         <div class="settings-item-list">
                            <div v-for="(driver, index) in drivers" :key="index" class="settings-item-card" style="width: 120px;">
                                <input type="text" v-model="drivers[index]" placeholder="Nome Fattorino">
                                <button @click="removeDriver(index)" class="remove-btn" style="color: var(--danger-color); margin-top: 5px;">Rimuovi</button>
                            </div>
                             <button class="item-card" @click="addDriver" style="border: 2px dashed #ccc; background: #fafafa; height: 100px; width: 120px;">
                                <i class="fas fa-plus-circle"></i> Aggiungi Fattorino
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="activeSettingsView === 'capacity'" class="settings-section">
                        <h3>Gestione Capacità Oraria</h3>
                        <div class="form-group">
                            <label>Pizze Massime per Intervallo:</label>
                            <input type="number" v-model.number="capacitySettings.maxPizzas" min="1">
                            <small>Numero massimo di pizze (incluse composizioni) che possono essere prodotte in un intervallo.</small>
                        </div>
                        <div class="form-group">
                            <label>Intervallo di Tempo (minuti):</label>
                            <input type="number" v-model.number="capacitySettings.intervalMinutes" min="10" step="5">
                            <small>Definisce la durata dell'intervallo di capacità (es. 30 minuti).</small>
                        </div>
                         <button @click="saveData" class="finalize-btn" style="background-color: var(--primary-color);">Salva Impostazioni Capacità</button>
                    </div>

                    <div v-if="activeSettingsView === 'prices'" class="settings-section">
                        <h3>Prezzi Fissi Composizioni</h3>
                        
                        <p>Imposta i prezzi fissi base (oltre le aggiunte) per le composizioni che hanno una suddivisione dei gusti predefinita.</p>

                        <h4>Mezzo Metro ({{ compositionPrices['Mezzo Metro'].baseSections }} Sezioni)</h4>
                        <div class="flex-row">
                            <div class="form-group flex-grow">
                                <label>1 Gusto</label>
                                <input type="number" v-model.number="compositionPrices['Mezzo Metro']['1']" step="0.50" min="0">
                            </div>
                            <div class="form-group flex-grow">
                                <label>2 Gusti</label>
                                <input type="number" v-model.number="compositionPrices['Mezzo Metro']['2']" step="0.50" min="0">
                            </div>
                            <div class="form-group flex-grow">
                                <label>3 Gusti</label>
                                <input type="number" v-model.number="compositionPrices['Mezzo Metro']['3']" step="0.50" min="0">
                            </div>
                        </div>

                        <h4>Schiacciata Grande ({{ compositionPrices['Schiacciata Grande'].baseSections }} Metà)</h4>
                        <div class="flex-row">
                            <div class="form-group flex-grow">
                                <label>1 Gusto</label>
                                <input type="number" v-model.number="compositionPrices['Schiacciata Grande']['1']" step="0.50" min="0">
                            </div>
                            <div class="form-group flex-grow">
                                <label>2 Gusti</label>
                                <input type="number" v-model.number="compositionPrices['Schiacciata Grande']['2']" step="0.50" min="0">
                            </div>
                        </div>

                        <button @click="saveData" class="finalize-btn" style="background-color: var(--primary-color);">Salva Prezzi Composizioni</button>
                    </div>

                    <div v-if="activeSettingsView === 'security'" class="settings-section">
                        <h3>Gestione PIN/Password</h3>
                        <p>I PIN vengono salvati in modo non leggibile per maggiore sicurezza (simulazione crittografia).</p>
                        
                        <h4>PIN/Password Operatore (Accesso Standard)</h4>
                        <div class="flex-row">
                            <input type="password" v-model="newAdminPin" placeholder="Nuovo PIN (min. 4 cifre)" class="flex-grow">
                            <button @click="saveAdminPin" class="finalize-btn" style="background-color: var(--success-color); width: 150px;">
                                <i class="fas fa-key"></i> Aggiorna
                            </button>
                        </div>
                        
                        <h4 class="mt-10">PIN/Password Titolare (Accesso Impostazioni)</h4>
                        <div class="flex-row">
                            <input type="password" v-model="newOwnerPin" placeholder="Nuovo PIN (min. 4 cifre)" class="flex-grow">
                             <button @click="saveOwnerPin" class="finalize-btn" style="background-color: var(--primary-color); width: 150px;">
                                <i class="fas fa-key"></i> Aggiorna
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <div class="modal-overlay" v-if="showModal">
            <div class="modal-container">
                <button @click="closeFinalizeModal" class="modal-close">&times;</button>
                <h2>{{ editingOrderId ? 'Modifica Ordine #' + editingOrderId : 'Finalizza Ordine' }}</h2>
                
                <div class="mode-selection">
                    <button v-for="m in modes" :key="m.id" class="mode-button" :class="{ active: mode === m.id }" @click="mode = m.id">
                        <i :class="m.icon"></i> {{ m.label }}
                    </button>
                </div>
                
                <div v-if="mode === 'banco'">
                    <div class="form-group">
                        <label>Numero Tavolo/Banco:</label>
                        <input type="text" v-model="tableNumber" placeholder="Es. T3 o Banco">
                    </div>
                </div>
                
                <div v-if="mode !== 'banco'">
                    <div class="form-group">
                        <label>Nome Cliente:</label>
                        <input type="text" v-model="customer" @input="suggestCustomers" placeholder="Nome Cliente">
                        <ul v-if="filteredCustomerSuggestions.length" style="list-style: none; padding: 0; border: 1px solid #ccc; border-top: none; max-height: 150px; overflow-y: auto;">
                            <li v-for="c in filteredCustomerSuggestions" :key="c.name + c.phone" 
                                @click="selectCustomerSuggestion(c)" 
                                style="padding: 8px; cursor: pointer; border-bottom: 1px dashed #eee; background: #fff;">
                                <strong>{{ c.name }}</strong> (Tel: {{ c.phone }}) <span v-if="c.address"> | {{ c.address }}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="form-group">
                        <label>Telefono:</label>
                        <input type="tel" v-model="phone" placeholder="Numero di Telefono">
                    </div>
                </div>
                
                <div v-if="mode === 'consegna'">
                    <div class="form-group">
                        <label>Indirizzo (Via e Numero):</label>
                        <input type="text" v-model="address" placeholder="Via, Piazza, Viale...">
                        <input type="text" v-model="streetNumber" placeholder="Numero Civico" style="width: 30%; margin-top: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Città/Comune:</label>
                        <input type="text" v-model="town" placeholder="Città">
                    </div>
                    <div class="form-group">
                        <label>Zona di Consegna (Costo):</label>
                        <select v-model="zoneName" @change="updateDeliveryCost">
                            <option value="" :key="-1">Seleziona Zona</option>
                            <option v-for="zone in deliveryZones" :key="zone.name" :value="zone.name">
                                {{ zone.name }} (+€{{ zone.price.toFixed(2) }})
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fattorino:</label>
                        <select v-model="selectedDriver">
                            <option value="" :key="-1">Nessun Fattorino Assegnato</option>
                            <option v-for="driver in drivers" :key="driver" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex-row">
                     <div class="form-group flex-grow">
                        <label>Data di Ritiro/Consegna:</label>
                        <input type="date" v-model="date" :min="minDate">
                    </div>
                     <div class="form-group flex-grow">
                        <label>Ora di Ritiro/Consegna:</label>
                        <input type="time" v-model="hour">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Note per la Cucina/Fattorino:</label>
                    <textarea v-model="notes"></textarea>
                </div>
                
                <div class="flex-row" style="border-top: 1px solid #ddd; padding-top: 10px; margin-top: 10px;">
                    <div class="form-group flex-grow">
                        <label>Sconto %:</label>
                        <input type="number" v-model.number="discountPercentage" min="0" max="100">
                    </div>
                    <div class="form-group flex-grow">
                        <label>Sconto Fisso (€):</label>
                        <input type="number" v-model.number="discount" min="0" :max="total">
                    </div>
                </div>

                <div class="flex-row">
                    <div class="form-group flex-grow">
                        <label>Stato Pagamento:</label>
                        <select v-model="paymentStatus">
                            <option>Da Pagare</option>
                            <option>Pagato</option>
                        </select>
                    </div>
                    <div class="form-group flex-grow" v-if="paymentStatus === 'Pagato'">
                        <label>Acconto Ricevuto (€):</label>
                        <input type="number" v-model.number="accontoRicevuto" min="0">
                        <small v-if="restoDaDare > 0" style="color: var(--success-color);">Resto da dare: €{{ restoDaDare.toFixed(2) }}</small>
                    </div>
                </div>
                
                <div class="text-center" style="font-size: 1.5em; font-weight: bold; color: var(--primary-color);">
                    TOTALE: €{{ total.toFixed(2) }}
                </div>
                
                <button class="finalize-btn" @click="saveOrder">
                    {{ editingOrderId ? 'SALVA MODIFICHE' : 'INVIA ORDINE' }}
                </button>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showMeterModal">
            <div class="modal-container modal-large">
                <button @click="cancelMeterComposition" class="modal-close">&times;</button>
                <h2>Configura {{ tempMeterItem.nome }}</h2>
                
                <div class="meter-controls">
                    <span style="font-weight: bold; margin-right: 20px;">Scegli Suddivisione Gusti:</span>
                    <button v-for="count in Object.keys(compositionPrices[tempMeterItem.nome]).filter(k => !isNaN(parseInt(k)))" 
                            :key="count" @click="setMeterGustoCount(parseInt(count))"
                            :class="{ active: tempMeterItem.gustoCount === parseInt(count) }">
                        {{ count }} Gusti (Base: €{{ compositionPrices[tempMeterItem.nome][count].toFixed(2) }})
                    </button>
                </div>

                <div class="meter-modal-content" v-if="tempMeterItem.gustoCount > 0">
                    <div class="meter-sections">
                         <h4>Sezioni / Metà (Totale: €{{ calculateTempMeterTotal.toFixed(2) }})</h4>
                        <div v-for="(section, index) in tempMeterItem.sections" :key="index" 
                             class="meter-section-card" :class="{ 'active': section.activeSection }" 
                             @click="section.activeSection = true">
                            
                            <div class="flex-row">
                                <span class="flex-grow">
                                    **{{ section.name }}**
                                    <br>
                                    <strong style="color: var(--success-color);">Gusto: {{ section.gusto || 'Seleziona Gusto' }}</strong>
                                </span>
                                <button v-if="section.gusto" @click.stop="section.gusto = null" class="remove-btn" style="color: #666;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="modifiers-list-small">
                                Modificatori: 
                                {{ section.modifiers.map(m => m.nome).join(', ') || 'Nessuno' }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="meter-gusto-picker">
                        <h4>Scegli Gusto (per Sezione Attiva)</h4>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca Gusto Pizza..." class="mb-10">
                        <div class="composition-gusto-list">
                            <button v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                    class="item-card" @click="selectMeterGusto(tempMeterItem.sections.findIndex(s => s.activeSection), gusto.nome)"
                                    :disabled="tempMeterItem.sections.findIndex(s => s.activeSection) === -1">
                                <span>{{ gusto.nome }}</span>
                                <span class="price">€{{ gusto.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>

                    <div class="meter-modifiers-picker">
                        <h4>Modificatori (per Sezione Attiva)</h4>
                         <div class="modifier-tabs">
                            <button v-for="(mods, category) in modifiers" :key="category" class="tab-button" 
                                :class="{ active: tempModCat === category }" @click="tempModCat = category">
                                {{ category }}
                            </button>
                        </div>
                        <div class="composition-gusto-list">
                            <button v-for="mod in filteredTempModifiers" :key="mod.nome" 
                                    class="modifier-button" 
                                    @click="addMeterModifier(tempMeterItem.sections.findIndex(s => s.activeSection), mod)"
                                    :disabled="tempMeterItem.sections.findIndex(s => s.activeSection) === -1 || mod.isFinished">
                                {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button class="finalize-btn" @click="addMeterToOrder" :disabled="!isMeterValid" style="margin-top: 20px;">
                    AGGIUNGI A ORDINE (€{{ calculateTempMeterTotal.toFixed(2) }})
                </button>
                 <small v-if="!isMeterValid && tempMeterItem.gustoCount > 0" style="color: var(--danger-color); display: block; text-align: center;">
                    ATTENZIONE: Devi selezionare un gusto per ogni sezione e non superare {{ tempMeterItem.gustoCount }} gusti unici.
                </small>
            </div>
        </div>

        <div class="modal-overlay" v-if="showHalfPizzaModal">
            <div class="modal-container modal-large">
                <button @click="cancelHalfPizzaComposition" class="modal-close">&times;</button>
                <h2>Configura Pizza a Metà (Totale: €{{ calculateTempHalfPizzaTotal.toFixed(2) }})</h2>
                
                <div class="flex-row">
                    <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                        <h4>Metà 1: {{ tempHalfPizzaItem.gusto1 || 'Seleziona Gusto' }}</h4>
                        
                        <div class="form-group">
                            <button class="tab-button" :class="{ active: tempHalfPizzaItem.activeHalf === 1 }" @click="tempHalfPizzaItem.activeHalf = 1">
                                <i class="fas fa-pencil-alt"></i> Scegli Gusto 1
                            </button>
                            <button v-if="tempHalfPizzaItem.gusto1" @click="tempHalfPizzaItem.gusto1 = null" class="remove-btn">
                                Rimuovi Gusto
                            </button>
                        </div>
                        
                        <div class="modifiers-list-small">
                            Modificatori: {{ tempHalfPizzaItem.modifiers1.map(m => m.nome).join(', ') || 'Nessuno' }}
                        </div>
                    </div>
                    
                    <div style="flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                        <h4>Metà 2: {{ tempHalfPizzaItem.gusto2 || 'Seleziona Gusto' }}</h4>
                         <div class="form-group">
                            <button class="tab-button" :class="{ active: tempHalfPizzaItem.activeHalf === 2 }" @click="tempHalfPizzaItem.activeHalf = 2">
                                <i class="fas fa-pencil-alt"></i> Scegli Gusto 2
                            </button>
                            <button v-if="tempHalfPizzaItem.gusto2" @click="tempHalfPizzaItem.gusto2 = null" class="remove-btn">
                                Rimuovi Gusto
                            </button>
                        </div>
                        <div class="modifiers-list-small">
                             Modificatori: {{ tempHalfPizzaItem.modifiers2.map(m => m.nome).join(', ') || 'Nessuno' }}
                        </div>
                    </div>
                </div>
                
                <div class="meter-modal-content" style="margin-top: 20px;">
                    <div class="meter-gusto-picker" style="flex: 1;">
                        <h4>Scegli Gusto Pizza</h4>
                        <input type="text" v-model="gustoSearchTerm" placeholder="Cerca Gusto Pizza..." class="mb-10">
                        <div class="composition-gusto-list">
                            <button v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                    class="item-card" @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0">
                                <span>{{ gusto.nome }}</span>
                                <span class="price">€{{ gusto.prezzo.toFixed(2) }}</span>
                            </button>
                        </div>
                    </div>

                    <div class="meter-modifiers-picker" style="flex: 1;">
                        <h4>Modificatori (per Metà Attiva)</h4>
                         <div class="modifier-tabs">
                            <button v-for="(mods, category) in modifiers" :key="category" class="tab-button" 
                                :class="{ active: tempModCat === category }" @click="tempModCat = category">
                                {{ category }}
                            </button>
                        </div>
                        <div class="composition-gusto-list">
                            <button v-for="mod in filteredTempModifiers" :key="mod.nome" 
                                    class="modifier-button" 
                                    @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)"
                                    :disabled="tempHalfPizzaItem.activeHalf === 0 || mod.isFinished">
                                {{ mod.nome }} <span v-if="mod.prezzo > 0">(+€{{ mod.prezzo.toFixed(2) }})</span>
                            </button>
                        </div>
                    </div>
                </div>

                <button class="finalize-btn" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid" style="margin-top: 20px;">
                    AGGIUNGI A ORDINE (€{{ calculateTempHalfPizzaTotal.toFixed(2) }})
                </button>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showPriceEditModal">
            <div class="modal-container" style="max-width: 400px;">
                <button @click="showPriceEditModal = false" class="modal-close">&times;</button>
                <h2>Modifica Prezzo Articolo</h2>
                <p>Articolo: <strong>{{ order[tempPriceEditIndex]?.nome }}</strong></p>
                <div class="form-group">
                    <label>Nuovo Prezzo Manuale (€):</label>
                    <input type="number" v-model.number="newPriceValue" step="0.10" min="0">
                </div>
                 <button class="finalize-btn" @click="saveNewPrice">SALVA NUOVO PREZZO</button>
                 <button class="nav-button" @click="resetManualPrice">Ripristina Prezzo Automatico</button>
            </div>
        </div>
        
        <div class="modal-overlay" v-if="showShareModal">
             <div class="modal-container" style="max-width: 400px;">
                <button @click="showShareModal = false" class="modal-close">&times;</button>
                <h2>Condividi Ordine #{{ selectedOrderForShare?.id }}</h2>
                 <p>Copia il riepilogo dell'ordine per inviarlo tramite WhatsApp o altro.</p>
                 <textarea id="share-content" readonly style="width: 100%; height: 200px; margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; font-size: 0.9em;">
                    {{ generateShareText(selectedOrderForShare) }}
                 </textarea>
                 <button class="finalize-btn" @click="copyShareText">
                    <i class="fas fa-copy"></i> Copia Testo
                 </button>
             </div>
        </div>

    </div>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // Dati Base
                    view: 'inserimento', // 'inserimento', 'ordini', 'storico', 'impostazioni'
                    
                    // Accesso e Sicurezza
                    // I PIN non sono salvati in chiaro. La logica usa l'inversione come base per la "crittografia" simulata.
                    adminPin: '4321', // Salvato '1234' invertito (questo verrà caricato da localStorage)
                    ownerPin: '0000', // Salvato '0000' invertito
                    accessPin: '',
                    isAccessGranted: false, 
                    userRole: '', 
                    newAdminPin: '',
                    newOwnerPin: '',

                    // Dati Menu
                    menu: {
                        'Pizza Classica': [
                            { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                            { nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                            { nome: '4 Stagioni', prezzo: 8.00, isFinished: false },
                            { nome: 'Fornarina', prezzo: 5.00, isFinished: false },
                        ],
                        'Pizze Speciali': [
                            { nome: 'Pistacchio & Mortazza', prezzo: 12.00, isFinished: false },
                            { nome: 'Gourmet', prezzo: 14.00, isFinished: false },
                        ],
                        'Bevande': [
                            { nome: 'Acqua Nat', prezzo: 2.00, isFinished: false },
                            { nome: 'Coca Cola Latta', prezzo: 3.00, isFinished: false },
                        ],
                        'Dolci': [
                            { nome: 'Tiramisù', prezzo: 4.50, isFinished: false },
                        ],
                        'Composizioni': [
                            // UPDATED: Aggiunta gustoCount per prezzo fisso
                            { nome: 'Mezzo Metro', prezzo: 16.00, isMeter: true, isFinished: false, gustoCount: 0, sections: [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}] },
                            { nome: 'Schiacciata Grande', prezzo: 12.00, isMeter: true, isFinished: false, gustoCount: 0, sections: [{name: 'Metà 1', gusto: null, modifiers: []}, {name: 'Metà 2', gusto: null, modifiers: []}]},
                            { nome: 'Pizza a Metà', prezzo: 0.00, isHalfPizza: true, isFinished: false, gusto1: null, gusto2: null, modifiers1: [], modifiers2: []}
                        ]
                    },
                    
                    // Prezzi fissi per composizioni (Configurabili nelle Impostazioni)
                    compositionPrices: {
                        'Mezzo Metro': { 1: 17.00, 2: 19.00, 3: 23.00, baseSections: 4 },
                        'Schiacciata Grande': { 1: 12.00, 2: 14.00, baseSections: 2 }
                    },

                    // Dati Modificatori
                    modifiers: {
                        'Più': [
                            { nome: 'Mozzarella', prezzo: 0.50, isFinished: false },
                            { nome: 'Wurstel', prezzo: 1.00, isFinished: false },
                            { nome: 'Prosciutto', prezzo: 1.50, isFinished: false },
                        ],
                        'Senza': [
                            { nome: 'Aglio', prezzo: 0.00, isFinished: false },
                            { nome: 'Origano', prezzo: 0.00, isFinished: false },
                        ],
                        'Poco': [
                            { nome: 'Sale', prezzo: 0.00, isFinished: false },
                        ],
                        'Abbondante': [
                            { nome: 'Olio', prezzo: 0.00, isFinished: false },
                        ],
                    },

                    // Dati Ordine Corrente
                    order: [],
                    selectedItemIndex: null,
                    lastSelectedItem: null, 
                    searchTerm: '', 
                    modifierSearchTerm: '', 
                    activeCat: 'Pizza Classica',
                    activeModCat: 'Più',
                    
                    // Dati Aggiunti (Sconto e Stato Pagamento)
                    discount: 0.00, // Sconto in valore assoluto
                    discountPercentage: 0, // Sconto in percentuale
                    paymentStatus: 'Da Pagare', // 'Da Pagare', 'Pagato'
                    accontoRicevuto: 0.00, // Acconto ricevuto

                    // Modalità di Finalizzazione Ordine
                    modes: [
                        { id: 'banco', label: 'Tavolo/Banco', icon: 'fa-solid fa-utensils' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck' }
                    ],
                    showModal: false,
                    
                    // Dati Modale Ordine
                    editingOrderId: null, // ID dell'ordine che si sta modificando
                    mode: 'banco',
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: 'Roma',
                    tableNumber: '', 
                    date: '',
                    hour: '',
                    notes: '',
                    zoneName: '',
                    deliveryCost: 0.00,
                    
                    // Dati di Sistema
                    lastOrderId: 0,
                    activeOrders: [],
                    archive: [],
                    deliveryZones: [
                        { name: 'Zona A', price: 3.00 },
                        { name: 'Zona B', price: 4.00 },
                    ],
                    drivers: ['Mario', 'Luigi', 'Yoshi'], 
                    
                    // Storico e Statistiche
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    selectedDriver: '',
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', 
                    
                    // Impostazioni
                    activeSettingsView: 'menu',
                    activeSettingsCat: 'Pizza Classica',
                    activeSettingsModCat: 'Più',

                    // Capacità Oraria
                    capacitySettings: {
                        maxPizzas: 20,
                        intervalMinutes: 30
                    },
                    orderCapacity: {
                        interval: null,
                        total: 0,
                        remaining: 0,
                        warning: false 
                    },
                    
                    // Composizioni (Metri/Mezze Pizze)
                    showMeterModal: false,
                    tempMeterItem: null,
                    gustoSearchTerm: '',
                    tempModCat: 'Più',
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,
                    tempMeterGusti: [], 

                    // Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0.00,

                    // Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,
                    
                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: []
                };
            },
            
            computed: {
                isOwner() {
                    return this.userRole === 'Titolare';
                },
                isAdmin() {
                    return this.isAccessGranted;
                },
                
                // --- Calcoli Ordine Corrente ---
                calculatedOrderTotal() {
                    let subtotal = this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
                    
                    // Gestione del prezzo manuale dell'intero ordine se impostato (non implementato nel carrello, ma qui per completezza)

                    // Applicazione Sconto Percentuale o Fisso
                    let actualDiscount = 0.00;
                    if (this.discountPercentage > 0) {
                        actualDiscount = subtotal * (this.discountPercentage / 100);
                        // Aggiorna il valore di sconto fisso reattivamente
                        this.discount = parseFloat(actualDiscount.toFixed(2));
                    } else if (this.discount > 0) {
                        actualDiscount = this.discount;
                        // Assicura che la percentuale sia 0 se si usa lo sconto fisso
                        if (this.discountPercentage !== 0) this.discountPercentage = 0;
                    }
                    
                    subtotal -= actualDiscount;

                    // Arrotonda il subtotal a due decimali
                    return parseFloat(Math.max(0, subtotal).toFixed(2));
                },
                total() {
                    return parseFloat((this.calculatedOrderTotal + this.deliveryCost).toFixed(2));
                },
                restoDaDare() {
                    const totalToPay = this.total;
                    return parseFloat(Math.max(0, this.accontoRicevuto - totalToPay).toFixed(2));
                },

                // --- Filtri e Disponibilità Menu ---
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    return items.filter(item => 
                        item.nome.toLowerCase().includes(term)
                    );
                },
                filteredModifiersForActiveCat() {
                    const mods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term)
                    );
                },

                // --- Capacità Oraria Computed ---
                // Calcola il numero totale di "pizze" nell'ordine corrente
                orderPizzaCount() {
                    return this.order.reduce((count, item) => {
                        if (item.isHalfPizza) return count + 1; // 1 Pizza a Metà = 1 Pizza
                        if (item.isMeter) return count + 2; // Mezzo Metro/Schiacciata = 2 Pizze
                        
                        // Conta solo pizze classiche e speciali come 1 (assumendo le altre categorie non contano)
                        const category = Object.keys(this.menu).find(cat => 
                            (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                        );
                        if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                            return count + 1;
                        }
                        return count;
                    }, 0);
                },
                capacityPercentage() {
                    if (this.orderCapacity.total === 0) return 0;
                    const used = this.orderCapacity.total - this.orderCapacity.remaining;
                    return Math.min(100, (used / this.orderCapacity.total) * 100);
                },
                isCapacityWarning() {
                    return this.orderCapacity.warning;
                },
                isCapacityFull() {
                    return this.orderCapacity.remaining <= 0;
                },
                minDate() {
                    return new Date().toISOString().slice(0, 10);
                },

                // --- Composizioni Computed (Riprese dalla parte 1, ma complete) ---
                allPizzaGusti() {
                    return (this.menu['Pizza Classica'] || []).concat(this.menu['Pizze Speciali'] || []);
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase();
                    return this.allPizzaGusti.filter(item => 
                        item.nome.toLowerCase().includes(term)
                    ).filter(item => !item.isFinished); // Solo gusti disponibili
                },
                filteredTempModifiers() {
                    const mods = this.modifiers[this.tempModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term)
                    );
                },
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem || this.tempMeterItem.gustoCount === 0) return 0;
                    
                    const itemType = this.tempMeterItem.nome;
                    const gustiCount = this.tempMeterItem.gustoCount;
                    const prices = this.compositionPrices[itemType];

                    if (!prices || !prices[gustiCount]) {
                        return 0; // Prezzo base non trovato
                    }

                    let basePrice = prices[gustiCount];
                    let modTotal = 0;

                    this.tempMeterItem.sections.forEach(section => {
                        modTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    });

                    return parseFloat((basePrice + modTotal).toFixed(2));
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    if (this.tempMeterItem.gustoCount === 0) return false;
                    
                    const sectionsInUse = this.tempMeterItem.sections;
                    const selectedGusti = sectionsInUse.map(s => s.gusto).filter(g => g !== null);
                    const uniqueGusti = [...new Set(selectedGusti)];

                    // Tutte le sezioni devono essere riempite
                    if (selectedGusti.length !== sectionsInUse.length) return false;

                    // I gusti unici selezionati non devono superare il gustoCount
                    return uniqueGusti.length <= this.tempMeterItem.gustoCount;
                },
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    
                    const item = this.tempHalfPizzaItem;
                    const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                    const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                    
                    // Prezzo Base: Media dei due gusti arrotondata per eccesso all'intero
                    let avgBasePrice = Math.ceil((price1 + price2) / 2);
                    
                    let modTotal = 0;
                    modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                    return parseFloat((avgBasePrice + modTotal).toFixed(2));
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 !== null && this.tempHalfPizzaItem.gusto2 !== null;
                },
                
                // --- Ordini Attivi Filtrati ---
                filteredActiveOrders() {
                    const now = new Date();
                    const todayString = now.toISOString().slice(0, 10);
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    const tomorrowString = tomorrow.toISOString().slice(0, 10);
                    
                    let filtered = this.activeOrders.slice();

                    // Filtro per Data
                    if (this.activeDateFilter === 'today') {
                        filtered = filtered.filter(order => order.date === todayString);
                    } else if (this.activeDateFilter === 'tomorrow') {
                        filtered = filtered.filter(order => order.date === tomorrowString);
                    } else if (this.activeDateFilter === 'future') {
                         filtered = filtered.filter(order => order.date > tomorrowString);
                    }
                    
                    // Filtro per Termine di Ricerca
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term) {
                        filtered = filtered.filter(order => 
                            order.customer.toLowerCase().includes(term) ||
                            order.address.toLowerCase().includes(term) ||
                            (order.tableNumber && order.tableNumber.toLowerCase().includes(term))
                        );
                    }

                    // Ordina per data e ora di ritiro
                    return filtered.sort((a, b) => {
                        const dateA = new Date(a.date + 'T' + a.hour);
                        const dateB = new Date(b.date + 'T' + b.hour);
                        return dateA - dateB;
                    });
                },
                
                // --- Storico Filtrato ---
                filteredArchive() {
                    let filtered = this.archive.filter(order => 
                        order.date === this.archiveDateFilter
                    );

                    if (this.selectedDriver) {
                        filtered = filtered.filter(order => order.driver === this.selectedDriver);
                    }

                    return filtered.sort((a, b) => {
                        const dateA = new Date(a.date + 'T' + a.hour);
                        const dateB = new Date(b.date + 'T' + b.hour);
                        return dateB - dateA;
                    });
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, order) => sum + order.total, 0);
                },
                archiveDateFilterDisplay() { 
                    const date = new Date(this.archiveDateFilter);
                    return date.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
            },
            
            watch: {
                view(newView) {
                    if (newView !== 'inserimento') {
                        this.selectedItemIndex = null;
                    }
                    this.saveData(); 
                },
                order: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                activeOrders: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                discountPercentage(newVal) {
                    if (newVal > 0) this.discount = 0.00;
                    this.calculatedOrderTotal; 
                },
                discount(newVal) {
                    if (newVal > 0) this.discountPercentage = 0;
                    this.calculatedOrderTotal; 
                },
                mode(newMode) {
                    // Resetta i dati specifici non pertinenti al nuovo mode
                    if (newMode !== 'consegna') {
                        this.address = '';
                        this.streetNumber = '';
                        this.zoneName = '';
                        this.deliveryCost = 0.00;
                        this.selectedDriver = '';
                    } else if (newMode !== 'banco') {
                        this.tableNumber = '';
                    }
                    
                    if (this.editingOrderId === null) {
                         this.setDefaultDateTime();
                    }
                    this.updateDeliveryCost();
                },
                zoneName() {
                    this.updateDeliveryCost();
                },
                archiveDateFilter() {
                    this.calculateDriverStats();
                },
                selectedDriver() {
                    this.calculateDriverStats();
                }
            },
            
            methods: {
                // --- Utilità PIN e Accesso ---
                _cryptPin(pin) {
                    return pin ? pin.split('').reverse().join('') : '';
                },
                _decryptPin(cryptedPin) {
                    return cryptedPin ? cryptedPin.split('').reverse().join('') : '';
                },
                grantAccess() {
                    const decryptedAdminPin = this._decryptPin(this.adminPin);
                    const decryptedOwnerPin = this._decryptPin(this.ownerPin);
                    
                    if (this.accessPin === decryptedOwnerPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Titolare';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Titolare Concesso.');
                    } else if (this.accessPin === decryptedAdminPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Operatore';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Operatore Concesso.');
                    } else if (this.accessPin) {
                        alert('PIN/Password errato.');
                        this.accessPin = '';
                    }
                },
                logout() {
                    this.isAccessGranted = false;
                    this.userRole = '';
                    this.view = 'inserimento';
                    alert('Disconnessione effettuata.');
                    this.saveData();
                },
                saveAdminPin() {
                    if (this.newAdminPin.length >= 4) {
                        this.adminPin = this._cryptPin(this.newAdminPin);
                        this.newAdminPin = '';
                        this.saveData();
                        alert('PIN/Password Operatore aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },
                saveOwnerPin() {
                    if (this.newOwnerPin.length >= 4) {
                        this.ownerPin = this._cryptPin(this.newOwnerPin);
                        this.newOwnerPin = '';
                        this.saveData();
                        alert('PIN/Password Titolare aggiornato!');
                    } else {
                        alert('Il PIN deve contenere almeno 4 caratteri.');
                    }
                },

                // --- Persistenza Dati (LocalStorage) ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeriaSmartData');
                        if (data) {
                            const parsedData = JSON.parse(data);
                            Object.assign(this, parsedData);

                            // Assicura che i PIN siano gestiti correttamente
                            this.adminPin = parsedData.adminPin || this._cryptPin('1234');
                            this.ownerPin = parsedData.ownerPin || this._cryptPin('0000');
                            
                            // Assicura l'esistenza di proprietà essenziali
                            this.capacitySettings = parsedData.capacitySettings || { maxPizzas: 20, intervalMinutes: 30 };
                            this.drivers = parsedData.drivers || ['Mario', 'Luigi', 'Yoshi'];
                            this.deliveryZones = parsedData.deliveryZones || [
                                { name: 'Zona A', price: 3.00 },
                                { name: 'Zona B', price: 4.00 },
                            ];
                            this.compositionPrices = parsedData.compositionPrices || {
                                'Mezzo Metro': { 1: 17.00, 2: 19.00, 3: 23.00, baseSections: 4 },
                                'Schiacciata Grande': { 1: 12.00, 2: 14.00, baseSections: 2 }
                            };
                            this.customerHistory = parsedData.customerHistory || [];
                            
                            this.archiveDateFilter = new Date().toISOString().slice(0, 10);
                            this.ensureItemStatus(); // Assicura che tutti gli item abbiano 'isFinished'
                        }
                    } catch (e) {
                        console.error("Errore caricamento dati:", e);
                    }
                },
                saveData() {
                    const dataToSave = {
                        adminPin: this.adminPin,
                        ownerPin: this.ownerPin,
                        isAccessGranted: this.isAccessGranted,
                        userRole: this.userRole,
                        menu: this.menu,
                        modifiers: this.modifiers,
                        lastOrderId: this.lastOrderId,
                        activeOrders: this.activeOrders,
                        archive: this.archive,
                        deliveryZones: this.deliveryZones,
                        drivers: this.drivers,
                        capacitySettings: this.capacitySettings,
                        customerHistory: this.customerHistory,
                        compositionPrices: this.compositionPrices
                    };
                    localStorage.setItem('pizzeriaSmartData', JSON.stringify(dataToSave));
                },
                ensureItemStatus() {
                    // Questa funzione verifica e aggiunge proprietà mancanti (come isFinished, se non esiste)
                    const checkProps = (list) => {
                        for (const cat in list) {
                            list[cat].forEach(item => {
                                if (item.isFinished === undefined) item.isFinished = false;
                                
                                // Inizializzazione proprietà specifiche per le composizioni
                                if (item.isMeter && !item.sections) {
                                    item.sections = item.nome === 'Mezzo Metro' ? 
                                        [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}] :
                                        [{name: 'Metà 1', gusto: null, modifiers: []}, {name: 'Metà 2', gusto: null, modifiers: []}];
                                    if (item.gustoCount === undefined) item.gustoCount = 0; 
                                }
                                if (item.isHalfPizza && !item.gusto1) {
                                    Object.assign(item, { gusto1: null, gusto2: null, modifiers1: [], modifiers2: [] });
                                }
                            });
                        }
                    };
                    checkProps(this.menu);
                    checkProps(this.modifiers);
                },

                // --- Funzioni Ordine Corrente (Carrello) ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) return item.manualPrice;
                    
                    let basePrice = item.prezzo || 0;
                    let modTotal = 0;
                    
                    if (item.isHalfPizza) {
                        const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                        const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                        
                        // Prezzo Base: Media dei due gusti arrotondata per eccesso all'intero
                        basePrice = Math.ceil((price1 + price2) / 2); 

                        modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);

                    } else if (item.isMeter) {
                        // Prezzo base è quello fisso basato sul gustoCount
                        const itemType = item.nome;
                        const gustiCount = item.gustoCount;
                        const prices = this.compositionPrices[itemType];
                        
                        basePrice = (prices && prices[gustiCount]) ? prices[gustiCount] : 0;
                        
                        item.sections.forEach(section => {
                            modTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        });

                    } else {
                        // Articoli Standard
                        modTotal = item.modifiers ? item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    }
                    
                    return parseFloat((basePrice + modTotal).toFixed(2));
                },
                
                handleItemClick(item) {
                    if (item.isFinished) return;
                    
                    this.selectedItemIndex = null; 
                    this.lastSelectedItem = item; 

                    if (item.isMeter || item.isHalfPizza) {
                        // Per le composizioni, apri la modale di configurazione
                        if (item.isMeter) {
                            this.openMeterCompositionModal(item);
                        } else if (item.isHalfPizza) {
                            this.openHalfPizzaCompositionModal(item);
                        }
                    } else {
                        // Per gli articoli standard, aggiungi direttamente al carrello
                        this.addItem(item);
                    }
                },
                addItem(item) {
                    if (item.isFinished) return;
                    const newItem = JSON.parse(JSON.stringify(item));
                    
                    // Rimuove le proprietà di composizione per gli item standard
                    delete newItem.isMeter;
                    delete newItem.sections;
                    delete newItem.gustoCount;
                    delete newItem.isHalfPizza;
                    delete newItem.gusto1;
                    delete newItem.gusto2;
                    delete newItem.modifiers1;
                    delete newItem.modifiers2;
                    
                    newItem.modifiers = []; // Assicura che ci sia l'array modificatori
                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; 
                },
                removeItem(index) {
                    this.order.splice(index, 1);
                    if (this.selectedItemIndex === index) {
                        this.selectedItemIndex = null;
                    } else if (this.selectedItemIndex > index) {
                        this.selectedItemIndex--;
                    }
                },
                selectItem(index) {
                    this.selectedItemIndex = index;
                },
                resetOrder() {
                    if (confirm("Sei sicuro di voler svuotare l'ordine corrente?")) {
                        this.order = [];
                        this.selectedItemIndex = null;
                        this.resetModalData();
                    }
                },
                
                // --- Gestione Modificatori Articolo Standard ---
                addExtra(mod) {
                    if (mod.isFinished) return;
                    if (this.selectedItemIndex === null) {
                        alert("Seleziona prima un articolo standard nel carrello.");
                        return;
                    }
                    const selectedItem = this.order[this.selectedItemIndex];
                    
                    if (selectedItem.isMeter || selectedItem.isHalfPizza) {
                        alert("Le composizioni non possono essere modificate da qui. Usa la modale di modifica prezzo per rimuoverle e rifarle.");
                        return;
                    }
                    
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    if (this.activeModCat === 'Senza') {
                        // Logica "Senza": rimuove se già presente
                        const index = selectedItem.modifiers.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) {
                            selectedItem.modifiers.splice(index, 1);
                        }
                    } else {
                        // Logica "Più/Poco/Abbondante": aggiunge
                        selectedItem.modifiers.push(newMod);
                    }
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Più': return '➕';
                        case 'Senza': return '➖';
                        case 'Poco': return '🤏';
                        case 'Abbondante': return '🧅'; 
                        default: return '•';
                    }
                },
                
                // --- Composizioni (Mezzo Metro/Schiacciata) ---
                openMeterCompositionModal(item) {
                    // Crea una copia profonda dell'articolo selezionato (dal menu o dal carrello se si sta modificando)
                    this.tempMeterItem = JSON.parse(JSON.stringify(item));
                    
                    // Inizializza le sezioni se l'oggetto è nuovo
                    if (this.tempMeterItem.gustoCount === 0) {
                        this.tempMeterItem.sections.forEach(s => s.gusto = null);
                    }

                    this.tempMeterItem.sections.forEach(s => s.activeSection = false); 
                    if (this.tempMeterItem.gustoCount > 0) {
                        // Attiva la prima sezione per iniziare
                        this.tempMeterItem.sections[0].activeSection = true;
                    } else if (this.compositionPrices[item.nome]) {
                        // Imposta il gustoCount al minimo disponibile se non è impostato
                        this.tempMeterItem.gustoCount = parseInt(Object.keys(this.compositionPrices[item.nome])[0]);
                         this.tempMeterItem.sections[0].activeSection = true;
                    }


                    this.tempMeterGusti = [...new Set(this.tempMeterItem.sections.map(s => s.gusto).filter(g => g !== null))];
                    this.showMeterModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelMeterComposition() {
                    this.showMeterModal = false;
                    this.tempMeterItem = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                    this.tempMeterGusti = [];
                },
                selectMeterGusto(sectionIndex, gustoName) {
                    if (sectionIndex === -1) return; // Nessuna sezione attiva
                    
                    const sections = this.tempMeterItem.sections;
                    
                    // Aggiorna la sezione
                    sections[sectionIndex].gusto = gustoName;
                    sections[sectionIndex].activeSection = false;
                    
                    // Ricalcola i gusti unici selezionati
                    const selectedGusti = sections.map(s => s.gusto).filter(g => g !== null);
                    this.tempMeterGusti = [...new Set(selectedGusti)];

                    // Passa alla sezione successiva, se esiste
                    const nextSection = sections[sectionIndex + 1];
                    if (nextSection && sectionIndex < sections.length - 1) {
                        nextSection.activeSection = true;
                    } else {
                        // Riavvia dalla prima sezione se sono tutte piene
                         sections[0].activeSection = true;
                    }
                    
                    this.gustoSearchTerm = '';
                },
                setMeterGustoCount(count) {
                    this.tempMeterItem.gustoCount = count;
                    
                    // Reset della selezione per ricominciare a selezionare i gusti con il nuovo conteggio
                    this.tempMeterItem.sections.forEach(s => s.gusto = null);
                    this.tempMeterItem.sections.forEach(s => s.activeSection = false);
                    this.tempMeterGusti = [];

                    if (count > 0 && this.tempMeterItem.sections.length > 0) {
                         this.tempMeterItem.sections[0].activeSection = true;
                    }
                },
                addMeterModifier(sectionIndex, mod) {
                    if (mod.isFinished || sectionIndex === -1) return;
                    const newMod = JSON.parse(JSON.stringify(mod));
                    
                    const sections = this.tempMeterItem.sections;
                    const modifiersArray = sections[sectionIndex].modifiers;
                    
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    } else {
                        modifiersArray.push(newMod);
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert(`Per ${this.tempMeterItem.nome} devi selezionare tutti i gusti e non superare i ${this.tempMeterItem.gustoCount} gusti diversi.`);
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempMeterItem));
                    finalItem.prezzo = this.calculateTempMeterTotal; 
                    
                    // Pulisci le proprietà temporanee prima di aggiungere all'ordine
                    finalItem.sections.forEach(s => delete s.activeSection);
                    delete finalItem.modifiers; 
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelMeterComposition();
                },

                // --- Composizioni (Pizza a Metà) ---
                openHalfPizzaCompositionModal(item) {
                    this.tempHalfPizzaItem = {
                        nome: item.nome, 
                        prezzo: 0.00, 
                        isHalfPizza: true,
                        gusto1: item.gusto1 || null,
                        gusto2: item.gusto2 || null,
                        modifiers1: item.modifiers1 || [],
                        modifiers2: item.modifiers2 || [],
                        activeHalf: item.gusto1 ? 2 : 1 // Inizializza sulla metà mancante
                    };
                    this.showHalfPizzaModal = true;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                cancelHalfPizzaComposition() {
                    this.showHalfPizzaModal = false;
                    this.tempHalfPizzaItem = null;
                    this.gustoSearchTerm = '';
                    this.modifierSearchTerm = '';
                },
                selectHalfPizzaGusto(halfNumber, gustoName) {
                    if (halfNumber === 1) {
                        this.tempHalfPizzaItem.gusto1 = gustoName;
                        this.tempHalfPizzaItem.activeHalf = 2; // Passa all'altra metà
                    } else if (halfNumber === 2) {
                        this.tempHalfPizzaItem.gusto2 = gustoName;
                        this.tempHalfPizzaItem.activeHalf = 0; // Disattiva la selezione gusto
                    }
                    this.gustoSearchTerm = '';
                },
                addHalfPizzaModifier(halfNumber, mod) {
                    if (mod.isFinished) return;
                    
                    const newMod = JSON.parse(JSON.stringify(mod));
                    const modifiersArray = halfNumber === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    } else {
                        modifiersArray.push(newMod);
                    }
                },
                addHalfPizzaToOrder() {
                    if (!this.isHalfPizzaValid) {
                        alert('Devi selezionare entrambi i gusti per la pizza a metà.');
                        return;
                    }
                    
                    const finalItem = JSON.parse(JSON.stringify(this.tempHalfPizzaItem));
                    finalItem.prezzo = this.calculateTempHalfPizzaTotal; 
                    delete finalItem.activeHalf; 
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelHalfPizzaComposition();
                },
                
                // --- Modifica Prezzo Man. ---
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    const item = this.order[index];
                    this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item);
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        this.order[this.tempPriceEditIndex].manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0.00;
                    }
                },
                resetManualPrice() {
                    if (this.tempPriceEditIndex !== null) {
                        delete this.order[this.tempPriceEditIndex].manualPrice;
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0.00;
                    }
                },
                
                // --- Logica Ordini Attivi/Finalizzazione ---
                setDefaultDateTime() {
                    const now = new Date();
                    const currentHour = now.getHours().toString().padStart(2, '0');
                    const currentMinute = now.getMinutes().toString().padStart(2, '0');
                    
                    // Data di oggi
                    this.date = now.toISOString().slice(0, 10);

                    // Imposta l'ora di ritiro/consegna aggiungendo l'intervallo standard (30 minuti)
                    const future = new Date(now.getTime() + 30 * 60000); 
                    this.hour = future.toTimeString().slice(0, 5); 
                },
                updateDeliveryCost() {
                    if (this.mode === 'consegna' && this.zoneName) {
                        const zone = this.deliveryZones.find(z => z.name === this.zoneName);
                        this.deliveryCost = zone ? zone.price : 0.00;
                    } else {
                        this.deliveryCost = 0.00;
                    }
                },
                
                // ... CONTINUA NELLA PARTE III ...
                // --- Logica Ordini Attivi/Finalizzazione (Continuazione) ---
                openFinalizeModal(orderToEdit = null) {
                    this.resetModalData(); // Resetta i campi prima di popolare
                    
                    if (orderToEdit) {
                        // Modalità Modifica Ordine
                        const order = this.activeOrders.find(o => o.id === orderToEdit.id);
                        if (!order) return;

                        this.editingOrderId = order.id;
                        this.mode = order.mode;
                        this.customer = order.customer || '';
                        this.phone = order.phone || '';
                        this.address = order.address || '';
                        this.streetNumber = order.streetNumber || '';
                        this.town = order.town || '';
                        this.tableNumber = order.tableNumber || '';
                        this.date = order.date;
                        this.hour = order.hour;
                        this.notes = order.notes;
                        this.zoneName = order.zoneName || '';
                        this.deliveryCost = order.deliveryCost || 0.00;
                        this.discount = order.discount || 0.00;
                        this.discountPercentage = order.discountPercentage || 0;
                        this.paymentStatus = order.paymentStatus || 'Da Pagare';
                        this.accontoRicevuto = order.accontoRicevuto || 0.00;

                        // Carica il carrello dall'ordine da modificare
                        this.order = JSON.parse(JSON.stringify(order.items)); 
                        this.updateDeliveryCost();

                    } else {
                        // Modalità Nuovo Ordine
                        this.setDefaultDateTime(); 
                    }
                    
                    this.showModal = true;
                },
                closeFinalizeModal() {
                    if (this.editingOrderId) {
                        // Se si annulla la modifica, ricarica l'ordine originale e svuota il carrello temporaneo
                        this.resetOrderState(); // Ripristina lo stato iniziale
                    } else {
                        // Se si annulla un nuovo ordine, semplicemente chiudi
                        this.resetModalData();
                    }
                    this.showModal = false;
                },
                resetModalData() {
                    this.editingOrderId = null;
                    this.mode = 'banco';
                    this.customer = '';
                    this.phone = '';
                    this.address = '';
                    this.streetNumber = '';
                    this.town = 'Roma';
                    this.tableNumber = '';
                    this.notes = '';
                    this.zoneName = '';
                    this.deliveryCost = 0.00;
                    this.discount = 0.00;
                    this.discountPercentage = 0;
                    this.paymentStatus = 'Da Pagare';
                    this.accontoRicevuto = 0.00;
                    this.setDefaultDateTime();
                },
                resetOrderState() {
                    // Resetta il carrello e la modale. Utile quando si annulla una modifica.
                    this.order = [];
                    this.selectedItemIndex = null;
                    this.resetModalData();
                },
                saveOrder() {
                    if (this.order.length === 0) {
                        alert("Il carrello è vuoto!");
                        return;
                    }

                    if (this.mode !== 'banco' && (!this.customer || !this.phone)) {
                        alert("Inserisci Nome Cliente e Telefono.");
                        return;
                    }
                    
                    if (this.mode === 'consegna' && (!this.address || !this.zoneName)) {
                         alert("Per la Consegna devi specificare Indirizzo e Zona.");
                        return;
                    }
                    
                    const now = new Date();
                    
                    // Creazione/Aggiornamento oggetto ordine
                    const orderData = {
                        id: this.editingOrderId || this.lastOrderId + 1,
                        date: this.date,
                        hour: this.hour,
                        mode: this.mode,
                        customer: this.customer,
                        phone: this.phone,
                        address: this.address + (this.streetNumber ? `, ${this.streetNumber}` : ''),
                        town: this.town,
                        tableNumber: this.tableNumber,
                        zoneName: this.zoneName,
                        driver: this.selectedDriver || '',
                        deliveryCost: this.deliveryCost,
                        notes: this.notes,
                        items: JSON.parse(JSON.stringify(this.order)), // Copia profonda del carrello
                        total: this.total,
                        discount: this.discount,
                        discountPercentage: this.discountPercentage,
                        paymentStatus: this.paymentStatus,
                        accontoRicevuto: this.accontoRicevuto,
                        status: 'Pending', // Pending, Ready
                        timestamp: now.getTime()
                    };

                    if (this.editingOrderId) {
                        // Modifica Ordine Esistente
                        const index = this.activeOrders.findIndex(o => o.id === this.editingOrderId);
                        if (index !== -1) {
                            this.activeOrders[index] = orderData;
                            alert(`Ordine #${this.editingOrderId} modificato con successo.`);
                        }
                    } else {
                        // Nuovo Ordine
                        this.lastOrderId++;
                        orderData.id = this.lastOrderId; 
                        this.activeOrders.push(orderData);
                        alert(`Ordine #${orderData.id} inviato con successo!`);
                    }
                    
                    // Aggiorna Cronologia Cliente e Resetta
                    this.updateCustomerHistory(orderData);
                    this.resetOrderState(); // Resetta i campi della modale e il carrello
                    this.saveData(); 
                },
                
                // Funzioni di ricerca e suggerimento cliente
                updateCustomerHistory(order) {
                    if (order.mode === 'banco' || !order.customer || !order.phone) return;

                    const existingIndex = this.customerHistory.findIndex(c => c.phone === order.phone);
                    
                    const customerData = {
                        name: order.customer,
                        phone: order.phone,
                        address: order.address,
                        town: order.town,
                        lastOrder: order.date
                    };

                    if (existingIndex !== -1) {
                        // Aggiorna cronologia
                        Object.assign(this.customerHistory[existingIndex], customerData);
                    } else {
                        // Aggiungi nuovo cliente
                        this.customerHistory.push(customerData);
                    }
                },
                suggestCustomers() {
                    const term = this.customer.toLowerCase();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    
                    this.filteredCustomerSuggestions = this.customerHistory.filter(c => 
                        c.name.toLowerCase().includes(term) || c.phone.includes(term)
                    ).slice(0, 5);
                },
                selectCustomerSuggestion(customer) {
                    this.customer = customer.name;
                    this.phone = customer.phone;
                    this.address = customer.address || '';
                    this.town = customer.town || this.town;
                    this.filteredCustomerSuggestions = [];
                },

                openEditOrderModal(orderId) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) {
                        this.openFinalizeModal(order);
                        this.view = 'inserimento'; // Torna alla vista inserimento per la modifica
                    }
                },
                toggleOrderStatus(orderId) {
                    const order = this.activeOrders.find(o => o.id === orderId);
                    if (order) {
                        order.status = order.status === 'Pending' ? 'Ready' : 'Pending';
                        this.saveData();
                        alert(`Stato Ordine #${orderId} impostato su: ${order.status}`);
                    }
                },
                archiveOrder(orderId) {
                    if (!confirm(`Sei sicuro di voler archiviare l'Ordine #${orderId}? Assicurati che sia stato pagato.`)) {
                        return;
                    }
                    const index = this.activeOrders.findIndex(o => o.id === orderId);
                    if (index !== -1) {
                        const archivedOrder = this.activeOrders.splice(index, 1)[0];
                        archivedOrder.status = 'Delivered'; // Imposta lo stato finale
                        archivedOrder.archivedTimestamp = new Date().getTime();
                        this.archive.push(archivedOrder);
                        this.saveData();
                        alert(`Ordine #${orderId} archiviato.`);
                    }
                },

                // --- Capacità Oraria ---
                getCapacityData(targetTime, targetDate) {
                    const dateString = targetDate || new Date().toISOString().slice(0, 10);
                    const timeString = targetTime || new Date().toTimeString().slice(0, 5);
                    const now = new Date(dateString + 'T' + timeString);
                    const intervalMs = this.capacitySettings.intervalMinutes * 60000;
                    
                    // Calcola l'inizio dell'intervallo corrente
                    const startInterval = new Date(Math.floor(now.getTime() / intervalMs) * intervalMs);
                    const endInterval = new Date(startInterval.getTime() + intervalMs);
                    
                    const intervalString = `${startInterval.toTimeString().slice(0, 5)} - ${endInterval.toTimeString().slice(0, 5)}`;
                    
                    // Conta le pizze già nell'intervallo
                    let pizzasBooked = 0;
                    this.activeOrders.forEach(order => {
                        const orderTime = new Date(order.date + 'T' + order.hour).getTime();
                        if (orderTime >= startInterval.getTime() && orderTime < endInterval.getTime()) {
                             pizzasBooked += order.items.reduce((count, item) => {
                                // Logica conteggio pizze come in orderPizzaCount computed
                                if (item.isHalfPizza) return count + 1; 
                                if (item.isMeter) return count + 2; 
                                const category = Object.keys(this.menu).find(cat => 
                                    (this.menu[cat] || []).some(menuItem => menuItem.nome === item.nome)
                                );
                                if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                                    return count + 1;
                                }
                                return count;
                            }, 0);
                        }
                    });

                    const totalCapacity = this.capacitySettings.maxPizzas;
                    const remainingCapacity = totalCapacity - pizzasBooked;
                    
                    // Controlla se l'ordine corrente (se in inserimento) eccede la capacità
                    const potentialRemaining = remainingCapacity - this.orderPizzaCount;
                    const isWarning = potentialRemaining <= (totalCapacity * 0.2) && potentialRemaining > 0;
                    const isFull = potentialRemaining <= 0;
                    
                    this.orderCapacity = {
                        interval: intervalString,
                        total: totalCapacity,
                        remaining: remainingCapacity,
                        warning: isWarning || isFull
                    };
                },
                updateCapacityWarning() {
                    // Aggiorna lo stato di capacità per l'orario e la data selezionati nella modale/default
                    if (this.view === 'inserimento' && this.isAccessGranted) {
                         this.getCapacityData(this.hour, this.date);
                    }
                },

                // --- Storico e Statistiche ---
                calculateDriverStats() {
                    const orders = this.filteredArchive; // Già filtrato per data
                    const driver = this.selectedDriver;

                    if (!driver) {
                        this.driverStats = { totalOrders: 0, totalRevenue: 0 };
                        return;
                    }

                    const driverOrders = orders.filter(o => o.driver === driver);
                    
                    const totalRevenue = driverOrders.reduce((sum, o) => {
                        // Calcola l'incasso effettivo (totale - costo consegna, se presente e non pagato dal cliente)
                        // Per semplicità, consideriamo l'incasso totale dell'ordine
                        return sum + o.total;
                    }, 0);

                    this.driverStats = {
                        totalOrders: driverOrders.length,
                        totalRevenue: parseFloat(totalRevenue.toFixed(2))
                    };
                },
                showArchiveDetails(order) {
                    alert(`Dettagli Ordine #${order.id}\n\nCliente: ${order.customer || order.tableNumber}\nModalità: ${this.getModeName(order.mode)}\n\nArticoli:\n${order.items.map(item => `  - ${item.nome} (€${this.calculateItemTotal(item).toFixed(2)})`).join('\n')}\n\nTotale: €${order.total.toFixed(2)}\nPagamento: ${order.paymentStatus}\nNote: ${order.notes || 'Nessuna'}`);
                },
                getModeIcon(mode) {
                    const m = this.modes.find(m => m.id === mode);
                    return m ? m.icon : 'fas fa-question';
                },
                getModeName(mode) {
                    const m = this.modes.find(m => m.id === mode);
                    return m ? m.label : 'Sconosciuto';
                },

                // --- Impostazioni ---
                toggleItemStatus(category, index) {
                    const item = this.menu[category][index];
                    item.isFinished = !item.isFinished;
                    this.saveData();
                },
                addNewItemToMenu(category) {
                    if (!this.menu[category]) return;
                    this.menu[category].push({ nome: 'Nuovo Articolo', prezzo: 0.00, isFinished: false });
                    this.saveData();
                },
                removeItemFromMenu(category, index) {
                    if (confirm(`Rimuovere ${this.menu[category][index].nome}?`)) {
                        this.menu[category].splice(index, 1);
                        this.saveData();
                    }
                },
                toggleModifierStatus(category, index) {
                    const mod = this.modifiers[category][index];
                    mod.isFinished = !mod.isFinished;
                    this.saveData();
                },
                addNewItemToModifiers(category) {
                    if (!this.modifiers[category]) return;
                    this.modifiers[category].push({ nome: 'Nuovo Extra', prezzo: 0.00, isFinished: false });
                    this.saveData();
                },
                removeItemFromModifiers(category, index) {
                    if (confirm(`Rimuovere ${this.modifiers[category][index].nome}?`)) {
                        this.modifiers[category].splice(index, 1);
                        this.saveData();
                    }
                },
                addNewCategory(type) {
                    const newCat = prompt("Inserisci il nome della nuova categoria:");
                    if (newCat && newCat.trim() !== '') {
                        if (type === 'menu') {
                            this.menu[newCat] = [];
                            this.activeSettingsCat = newCat;
                        } else if (type === 'modifiers') {
                            this.modifiers[newCat] = [];
                            this.activeSettingsModCat = newCat;
                        }
                        this.saveData();
                    }
                },
                addDeliveryZone() {
                    this.deliveryZones.push({ name: 'Nuova Zona', price: 0.00 });
                    this.saveData();
                },
                removeDeliveryZone(index) {
                     if (confirm(`Rimuovere Zona ${this.deliveryZones[index].name}?`)) {
                        this.deliveryZones.splice(index, 1);
                        this.saveData();
                     }
                },
                addDriver() {
                    this.drivers.push('Nuovo Fattorino');
                    this.saveData();
                },
                removeDriver(index) {
                     if (confirm(`Rimuovere Fattorino ${this.drivers[index]}?`)) {
                        this.drivers.splice(index, 1);
                        this.saveData();
                     }
                },

                // --- Condivisione (Whatsapp / Testo) ---
                generateShareText(order) {
                    if (!order) return "";
                    
                    let text = `🍕 Ordine Pizzeria Smart #${order.id}\n`;
                    text += `------------------------------------\n`;
                    
                    // Dettagli Cliente/Ritiro
                    text += `Tipo: ${this.getModeName(order.mode)}\n`;
                    text += `Data/Ora Ritiro: ${this.formatDate(order.date)} @ ${order.hour}\n`;
                    if (order.mode === 'banco') {
                        text += `Tavolo: ${order.tableNumber}\n`;
                    } else {
                        text += `Cliente: ${order.customer} (Tel: ${order.phone})\n`;
                        if (order.mode === 'consegna') {
                             text += `Indirizzo: ${order.address} (${order.town})\n`;
                             text += `Fattorino: ${order.driver || 'Da Assegnare'}\n`;
                        }
                    }
                     text += `Stato Pagamento: ${order.paymentStatus}\n`;
                     if (order.accontoRicevuto > 0) {
                         text += `Acconto Ricevuto: €${order.accontoRicevuto.toFixed(2)}\n`;
                     }
                    
                    text += `\nArticoli:\n`;
                    order.items.forEach(item => {
                        let itemText = `-> ${item.nome} (€${this.calculateItemTotal(item).toFixed(2)})\n`;
                        
                        // Dettagli composizione
                        if (item.isHalfPizza) {
                            itemText += `   - Metà 1: ${item.gusto1} (${item.modifiers1.map(m => m.nome).join(', ')})\n`;
                            itemText += `   - Metà 2: ${item.gusto2} (${item.modifiers2.map(m => m.nome).join(', ')})\n`;
                        } else if (item.isMeter) {
                            itemText += `   - Gusti Unici: ${item.gustoCount}\n`;
                            item.sections.forEach((s, i) => {
                                itemText += `   - ${s.name}: ${s.gusto} (${s.modifiers.map(m => m.nome).join(', ')})\n`;
                            });
                        } else if (item.modifiers && item.modifiers.length > 0) {
                            itemText += `   - Modificatori: ${item.modifiers.map(m => m.nome).join(', ')}\n`;
                        }
                        text += itemText;
                    });
                    
                    text += `\n------------------------------------\n`;
                    text += `Totale Sconto: €${order.discount.toFixed(2)}\n`;
                    text += `Totale Ordine: *€${order.total.toFixed(2)}*\n`;
                    text += `------------------------------------\n`;
                    if (order.notes) {
                        text += `Note: ${order.notes}\n`;
                    }
                    
                    return text.trim();
                },
                openShareModal(order) {
                    this.selectedOrderForShare = order;
                    this.showShareModal = true;
                },
                copyShareText() {
                    const textarea = document.getElementById('share-content');
                    if (textarea) {
                         textarea.select();
                         document.execCommand('copy');
                         alert('Testo riepilogo copiato negli appunti!');
                    }
                    this.showShareModal = false;
                },

                // --- Funzioni di Formattazione (Filtri Vue 2) ---
                formatDate(isoDate) {
                    if (!isoDate) return '';
                    const parts = isoDate.split('-'); // [YYYY, MM, DD]
                    if (parts.length === 3) {
                         return `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY
                    }
                    return isoDate;
                }
            },
            
            mounted() {
                this.loadData();
                this.setDefaultDateTime();
                
                // Inizializza il controllo della capacità (ogni 60 secondi)
                this.updateCapacityWarning(); 
                setInterval(this.updateCapacityWarning, 60000); 
            }
        });
        
        // Definisci i filtri per compatibilità con l'HTML (anche se Vue 3 non li usa)
        app.config.globalProperties.$filters = {
            formatDate(isoDate) {
                if (!isoDate) return '';
                const parts = isoDate.split('-');
                if (parts.length === 3) {
                     return `${parts[2]}/${parts.slice(1).join('/')}`; // DD/MM
                }
                return isoDate;
            }
        };

        app.mount('#app');
    </script>
</body>
</html>
