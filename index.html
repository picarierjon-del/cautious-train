<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pizzeria Smart ‚Äì Gestionale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* Stili Generali */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, sans-serif; background: #f7f7fa; color: #333; padding-bottom: 90px; }
        header { background: #e31b23; color: #fff; padding: 14px; text-align: center; font-weight: 700; font-size: 1.2rem; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; border-top: 1px solid #ddd; background: #fff; z-index: 50; }
        nav button { flex: 1; border: none; background: none; padding: 6px 0; color: #777; font-size: .8rem; display: flex; flex-direction: column; align-items: center; }
        nav button i { font-size: 1.3rem; margin-bottom: 2px; }
        nav button.active { color: #e31b23; }
        main { padding: 12px; max-width: 480px; margin: auto; }
        h2 { color: #e31b23; margin: 8px 0; }
        
        /* Stili Inserimento Ordine */
        .cat-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .cat-btn { flex: 1 1 30%; padding: 8px; border: none; border-radius: 6px; background: #444; color: #fff; font-weight: 600; cursor: pointer; }
        .cat-btn.active { background: #e31b23; }
        
        /* Modificatori */
        .mod-row { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 6px; margin-bottom: 12px; }
        .mod-btn { flex: 1; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-weight: 700; cursor: pointer; background: #fff; }
        .mod-btn.green { border-color: #22c55e; color: #22c55e; } /* Pi√π */
        .mod-btn.gray { border-color: #6b7280; color: #6b7280; } /* Senza */
        .mod-btn.yellow { border-color: #facc15; color: #facc15; } /* Poco */
        .mod-btn.blue { border-color: #3b82f6; color: #3b82f6; } /* Abbondante */
        .mod-btn.active { border-color: #e31b23; background-color: #ffecec; box-shadow: 0 0 0 3px #e31b23; }
        .mod-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; }
        .search-mod-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }


        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .item { background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: center; padding: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0, 0, 0, .08); }
        .item:hover { background: #ffecec; }
        .item.active-menu-selection { border: 3px solid #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);} 
        .item.disabled { background: #f0f0f0; color: #999; cursor: not-allowed; opacity: 0.7; }
        .item.disabled:hover { background: #f0f0f0; }

        /* Stili Ordine Corrente */
        .order-box { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 20px; }
        .order-box ul { list-style: none; padding: 0; margin: 0; }
        .order-box .order-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dotted #ddd; font-size: .9rem; cursor: pointer; }
        .order-box .order-item.selected { background-color: #fff3f4; border: 2px solid #e31b23; padding: 6px 0; border-radius: 4px;}
        .order-box .modifiers-list { list-style: none; padding-left: 15px; font-size: 0.8rem; margin-top: 2px; margin-bottom: 4px;}
        .order-box .modifiers-list li { display: flex; justify-content: space-between; align-items: center;}
        .mod-remove-btn { border:none;background:none;color:#b91c1c; font-weight: 700; cursor: pointer; padding: 0; margin-left: 5px;}
        .total { font-weight: 700; margin-top: 8px; text-align: right; }
        .final-btn { width: 100%; margin-top: 12px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 12px; font-size: 1rem; font-weight: 700; }
        .final-btn:disabled { background: #ccc; cursor: not-allowed; }
        .cancel-edit-btn { background: #6b7280; margin-top: 5px; } 
        
        /* Stili Modale */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; color: #e31b23; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .mode-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .mode-card.active { border-color: #e31b23; box-shadow: 0 0 0 2px #e31b23 inset; }
        .form-row { margin-bottom: 10px; }
        .form-row label { display: block; font-size: 0.9rem; margin-bottom: 4px; font-weight: 600; }
        .form-row input, .form-row select, .form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 15px; }
        .modal-actions button { padding: 10px 15px; border-radius: 6px; font-weight: 700; }
        .modal-actions .btn-cancel { background: #6b7280; color: #fff; border: none; }
        .modal-actions .btn-confirm { background: #e31b23; color: #fff; border: none; flex-grow: 1; margin-left: 10px; }

        /* Stili Ordini Attivi e Avvisi Temporali */
        .order-card { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 10px; position: relative;}
        /* NUOVO: Ordini Futuri */
        .order-card.future-order { border-left: 5px solid #3b82f6; } 
        .order-card.future-order:before { content: "PRENOTAZIONE"; position: absolute; top: -10px; right: 10px; background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        
        .order-card h4 { margin: 0 0 6px; color: #e31b23; display: flex; justify-content: space-between;}
        .order-items { margin: 0; padding-left: 16px; font-size: .9rem; }
        .order-actions button { margin-top: 6px; margin-right: 6px; background: #e31b23; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }
        .order-actions button.delete { background: #b91c1c; }
        .order-actions button.edit { background: #3b82f6; } 
        .order-actions button.share { background: #10b981; } 
        .order-actions button.duplicate { background: #facc15; color: #333;}
        
        /* Filtro Ordini Attivi */
        .filter-row-top { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .filter-btn-status { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.9rem; }
        .filter-btn-status.active { background: #e31b23; color: #fff; border-color: #e31b23; }

        /* Avvisi Temporali (Mantenuti) */
        .order-card.warning-near { border-left: 5px solid #facc15; } /* Giallo (15 min) */
        .order-card.warning-urgent { border-left: 5px solid #b91c1c; } /* Rosso (5 min) */
        .order-card.warning-near:before { content: "ATTENZIONE: Vicino!"; position: absolute; top: -10px; right: 10px; background: #facc15; color: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .order-card.warning-urgent:before { content: "URGENTE: Imminente!"; position: absolute; top: -10px; right: 10px; background: #b91c1c; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }

        /* Stili per la stampa (nasconde elementi non necessari) - Mantenuti per completezza */
        @media print {
            body > *:not(.print-container) { display: none; }
            body, html { margin: 0; padding: 0; }
            .print-container { display: block; max-width: 100%; font-size: 11pt; }

            /* Stili specifici per la comanda */
            .print-comanda { font-family: monospace; font-size: 12pt; line-height: 1.4; padding: 10px; }
            .print-comanda h1 { font-size: 16pt; text-align: center; margin: 0 0 10px 0; }
            .print-comanda h2 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin: 10px 0; }
            .print-comanda ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
            .print-comanda ul li { border-bottom: 1px dotted #888; padding: 4px 0; }
            .print-comanda .item-name { font-weight: bold; font-size: 13pt; }
            .print-comanda .mod-list { font-size: 11pt; margin-top: 2px; padding-left: 10px; }
            .print-comanda .mod-list li { border: none; }
            .print-comanda .note { color: #b91c1c; margin-top: 8px; font-weight: bold; }

            /* Stili specifici per lo scontrino */
            .print-scontrino { font-family: monospace; font-size: 10pt; line-height: 1.3; width: 80mm; margin: 0 auto; }
            .print-scontrino h1 { font-size: 12pt; text-align: center; margin: 0 0 5px 0; }
            .print-scontrino table { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
            .print-scontrino th, .print-scontrino td { text-align: left; padding: 2px 0; }
            .print-scontrino .total-row { font-size: 11pt; font-weight: bold; border-top: 1px dashed #000; padding-top: 5px; }
        }

        /* Stili per le Impostazioni (aggiunti/integrati) */
        .settings h3 { color: #444; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .settings form { display: flex; gap: 5px; margin-bottom: 15px; }
        .settings form input, .settings form select, .settings form button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .settings form input[type="text"], .settings form input[type="number"], .settings form select { flex-grow: 1; }
        .settings form button { background: #10b981; color: #fff; border: none; cursor: pointer; }
        
        .settings-list { margin-bottom: 20px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 5px; }
        .settings-item span { flex-grow: 1; }
        .settings-item .remove { background: #b91c1c; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px; }
        .item-status button { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .item-status .available { background: #22c55e; color: #fff; }
        .item-status .finished { background: #b91c1c; color: #fff; }

        /* Stili Accesso e Notifiche */
        .access-container { text-align: center; padding: 50px 20px; }
        .access-container input { max-width: 250px; margin: 10px auto; display: block; }
        
        /* NUOVI STILI PER I RUOLI */
        .role-indicator { font-size: 0.8rem; margin-top: 5px; padding: 3px 6px; border-radius: 4px; font-weight: 700; }
        .role-indicator.owner { background: #e31b23; color: #fff; } /* Titolare: Rosso Pizzeria */
        .role-indicator.admin { background: #facc15; color: #333; } /* Admin/Operatore: Giallo */
        /* FINE NUOVI STILI */

        .time-capacity { padding: 10px; border: 1px solid #facc15; background-color: #fffbeb; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; }
        .time-capacity.full { border-color: #b91c1c; background-color: #ffecec; color: #b91c1c; font-weight: 700;}
        .time-capacity.warning { border-color: #facc15; background-color: #fffbeb; }

        .settings-item .actions { display: flex; gap: 5px; }

    </style>
</head>
<body>
    <div id="app" v-cloak>
        <header>
            Pizzeria Smart
        </header>

        <main>
            <section v-if="view === 'inserimento'" class="inserimento">
                <div class="order-box">
                    <h2>Ordine Corrente üçï</h2>
                    <p v-if="order.length === 0" style="text-align: center; color: #777;">Aggiungi articoli al carrello.</p>
                    <ul v-else>
                        <li v-for="(item, index) in order" :key="index" @click="selectItem(index)" :class="{'order-item': true, 'selected': selectedItemIndex === index}">
                            <div style="flex-grow: 1;">
                                <span style="font-weight: 700;">1x {{ item.nome }}</span> 
                                <span v-if="item.manualPrice !== undefined" style="color:#e31b23; font-weight: 700; font-size: 0.8rem;"> (PREZZO MANUALE)</span>
                                
                                <template v-if="item.isHalfPizza">
                                    <p style="font-size: 0.85rem; margin: 2px 0 0 0; color: #3b82f6;">Met√†: {{ item.gusto1 }} / {{ item.gusto2 }}</p>
                                    <ul class="modifiers-list" v-if="(item.modifiers1 && item.modifiers1.length) || (item.modifiers2 && item.modifiers2.length)">
                                        <li v-if="item.modifiers1 && item.modifiers1.length">
                                            <span>M1: {{ item.modifiers1.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                                            <button @click.stop="item.modifiers1.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                        <li v-if="item.modifiers2 && item.modifiers2.length">
                                            <span>M2: {{ item.modifiers2.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                                            <button @click.stop="item.modifiers2.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                    </ul>
                                </template>

                                <template v-else-if="item.isMeter">
                                    <p style="font-size: 0.85rem; margin: 2px 0 0 0; color: #10b981;">
                                        <span v-for="(section, sIdx) in item.sections" :key="sIdx">
                                            <span v-if="section.gusto"> - {{ section.gusto }} </span>
                                        </span>
                                    </p>
                                    <ul class="modifiers-list" v-for="(section, sIdx) in item.sections" :key="'sec_mod_' + sIdx" v-if="section.modifiers && section.modifiers.length > 0">
                                        <li>
                                            <span>{{ section.name }}: {{ section.modifiers.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                                            <button @click.stop="section.modifiers.pop(); selectedItemIndex = index; updateCapacityWarning();" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                        </li>
                                    </ul>
                                </template>
                                
                                <ul class="modifiers-list" v-else-if="item.modifiers && item.modifiers.length > 0">
                                    <li v-for="(mod, modIndex) in item.modifiers" :key="modIndex">
                                        <span>{{ mod.icon }} {{ mod.nome }} <span v-if="mod.prezzo > 0">(+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span></span>
                                        <button @click.stop="item.modifiers.splice(modIndex, 1); selectedItemIndex = index;" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                                    </li>
                                </ul>
                            </div>
                            <div style="text-align: right; display: flex; align-items: center; gap: 8px;">
                                <span style="font-weight: 700;">‚Ç¨{{ calculateItemTotal(item).toFixed(2) }}</span>
                                <button @click.stop="openPriceEditModal(index)" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0;"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button @click.stop="removeItem(index)" style="background: none; border: none; color: #b91c1c; cursor: pointer; padding: 0;"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </li>
                    </ul>
                    <p class="total">Totale Articoli: ‚Ç¨{{ calculatedOrderTotal.toFixed(2) }}</p>
                    <button class="final-btn" :disabled="order.length === 0" @click="openModal">Finalizza Ordine ({{ order.length }})</button>
                    <button v-if="editingOrderId" class="final-btn cancel-edit-btn" @click="cancelEdit">Annulla Modifica</button>
                </div>

                <h2>Aggiungi Articolo</h2>
                <div class="cat-row">
                    <button v-for="(items, cat) in menu" :key="cat" :class="{'cat-btn': true, 'active': activeCat === cat}" @click="activeCat = cat; searchTerm = ''">
                        {{ cat }}
                    </button>
                </div>
                
                <input type="text" v-model="searchTerm" placeholder="Cerca articolo..." class="search-input">
                
                <div class="grid">
                    <div v-for="item in filteredAvailableItems" :key="item.nome" 
                        :class="{'item': true, 'disabled': item.isFinished, 'active-menu-selection': lastSelectedItem === item}"
                        @click="handleItemClick(item)">
                        {{ item.nome }} <br> 
                        <span style="font-weight: 700; font-size: .9rem;">‚Ç¨{{ item.prezzo.toFixed(2) }}</span>
                        <span v-if="item.isFinished" style="display: block; color: #b91c1c; font-size: 0.7rem; margin-top: 5px;">ESAURITO</span>
                    </div>
                </div>

                <template v-if="selectedItemIndex !== null && !order[selectedItemIndex]?.isMeter && !order[selectedItemIndex]?.isHalfPizza">
                    <h2>Aggiungi Modificatore a: {{ order[selectedItemIndex].nome }}</h2>
                    <div class="cat-row">
                        <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': activeModCat === cat}" @click="activeModCat = cat; modifierSearchTerm = ''">
                            {{ cat }}
                        </button>
                    </div>
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                    <div class="mod-row">
                        <button v-for="mod in filteredModifiersForActiveCat" :key="mod.nome"
                            :class="{'mod-btn': true, 'green': activeModCat === 'Pi√π', 'gray': activeModCat === 'Senza', 'yellow': activeModCat === 'Poco', 'blue': activeModCat === 'Abbondante', 'disabled': mod.isFinished}"
                            :disabled="mod.isFinished"
                            @click="addExtra(mod)">
                            {{ mod.nome }} <span v-if="mod.prezzo > 0">(+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span>
                            <span v-if="mod.isFinished" style="display: block; color: #b91c1c; font-size: 0.7rem;">ESAURITO</span>
                        </button>
                    </div>
                </template>
            </section>

            <section v-if="view === 'ordini'" class="ordini">
                <div v-if="!isAdmin" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Inserisci il PIN/Password Operatore o Titolare per accedere agli ordini e alle impostazioni.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>Ordini Attivi <i class="fa-solid fa-bell"></i></h2>
                        <span :class="{'role-indicator': true, 'owner': userRole === 'Titolare', 'admin': userRole === 'Operatore'}" v-if="isAccessGranted">{{ userRole }}</span>
                    </div>

                    <div class="filter-row-top">
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'today'}" @click="activeDateFilter = 'today'">Oggi</button>
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'tomorrow'}" @click="activeDateFilter = 'tomorrow'">Domani</button>
                        <button :class="{'filter-btn-status': true, 'active': activeDateFilter === 'future'}" @click="activeDateFilter = 'future'">Futuri</button>
                    </div>
                    <input type="text" v-model="activeOrderSearchTerm" placeholder="Cerca per Cliente, Tavolo o Indirizzo..." class="search-input">

                    <p v-if="filteredActiveOrders.length === 0" style="text-align: center; color: #777;">Nessun ordine attivo trovato per il filtro selezionato.</p>
                    <div v-for="o in filteredActiveOrders" :key="o.id" 
                         :class="{'order-card': true, 'warning-near': isNear(o), 'warning-urgent': isUrgent(o), 'future-order': isFutureOrder(o)}">
                        <h4>
                            Ordine #{{ o.id }} 
                            <span style="font-size: 0.8rem; font-weight: 500;">
                                {{ o.hour }} ({{ formatDate(o.date) }})
                            </span>
                        </h4>
                        <p style="margin: 0 0 6px; font-weight: 700; color: #333;">{{ o.customer }} <span v-if="o.tableNumber">| Tavolo/Ritiro: {{ o.tableNumber }}</span></p>
                        <p v-if="o.mode === 'consegna'" style="margin: 0 0 6px; font-size: 0.9rem;">{{ o.address }} {{ o.streetNumber }}, {{ o.zone }}</p>
                        <ul class="order-items">
                            <li v-for="(item, index) in o.items" :key="index">
                                1x {{ item.nome }} <span v-if="item.isHalfPizza">({{ item.gusto1 }}/{{ item.gusto2 }})</span>
                            </li>
                        </ul>
                        <p style="margin: 8px 0 0; text-align: right; font-size: 1.1rem; font-weight: 700;">Totale: ‚Ç¨{{ o.total.toFixed(2) }}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px; border-top: 1px dashed #eee; padding-top: 8px;">
                            <div style="font-size: 0.9rem;">
                                Stato: <span style="font-weight: 700;">{{ o.status }}</span> 
                            </div>
                            <div>
                                <select :value="o.driver" @change="updateActiveOrderDriver(o.id, $event.target.value)" v-if="o.mode === 'consegna'">
                                    <option value="">ASSEGNA FATTORE</option>
                                    <option v-for="driver in availableDrivers.slice(1)" :value="driver">{{ driver }}</option>
                                </select>
                            </div>
                        </div>
                        <div class="order-actions">
                            <button @click="advance(o)">{{ getNextStatus(o.status) }}</button>
                            <button class="edit" @click="editOrder(o.id)">Modifica</button>
                            <button @click="printOrder(o.id, 'comanda')"><i class="fa-solid fa-receipt"></i> Comanda</button>
                            <button class="share" @click="showShareMenu(o.id)"><i class="fa-solid fa-share-nodes"></i> Condividi</button>
                            <button class="duplicate" @click="duplicateOrder(o)"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="view === 'storico'" class="storico">
                <div v-if="!isAdmin" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Solo Operatori e Titolari possono accedere allo storico.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <h2>Storico/Riepilogo Giornaliero</h2>
                    <div class="form-row">
                        <label for="archive-date">Seleziona Giorno:</label>
                        <input type="date" id="archive-date" v-model="archiveDateFilter" @change="calculateDriverStats">
                    </div>

                    <p style="font-size: 1.2rem; font-weight: 700; margin-top: 15px; border-bottom: 2px solid #e31b23;">
                        Totale Incasso Archivio {{ archiveDateFilterDisplay }}: ‚Ç¨{{ dailyTotal.toFixed(2) }}
                    </p>

                    <h3 style="margin-top: 20px;">Statistiche Fattorini</h3>
                    <div class="form-row">
                        <select v-model="selectedDriver" @change="calculateDriverStats">
                            <option value="">Tutti (Solo Consegne Assegnate)</option>
                            <option v-for="driver in availableDrivers.slice(1)" :value="driver">{{ driver }}</option>
                        </select>
                    </div>
                    <div class="order-box">
                        <p>Ordini (Consegna/Asporto) Assegnati: <strong>{{ driverStats.totalOrders }}</strong></p>
                        <p>Totale Incasso (Ordini Assegnati): <strong>‚Ç¨{{ driverStats.totalRevenue.toFixed(2) }}</strong></p>
                    </div>

                    <h3 style="margin-top: 20px;">Ordini Archiviati ({{ filteredArchive.length }})</h3>
                    <p v-if="filteredArchive.length === 0" style="text-align: center; color: #777;">Nessun ordine archiviato per questa data.</p>
                    <div v-for="o in filteredArchive" :key="o.id" class="order-card">
                        <h4>Ordine #{{ o.id }} - {{ o.customer }} ({{ o.mode }})</h4>
                        <p style="margin: 0 0 6px; font-weight: 700;">Totale: ‚Ç¨{{ o.total.toFixed(2) }}</p>
                        <p v-if="o.driver" style="margin: 0 0 6px; font-size: 0.9rem;">Fattorino Assegnato: <strong>{{ o.driver }}</strong></p>
                        <p v-else style="margin: 0 0 6px; font-size: 0.9rem; color: #b91c1c;">Nessun Fattorino Assegnato</p>
                        
                        <select :value="o.driver" @change="updateArchiveDriver(o.id, $event.target.value)" style="margin-bottom: 10px;">
                            <option value="">ASSEGNA FATTORE</option>
                            <option v-for="driver in availableDrivers.slice(1)" :value="driver">{{ driver }}</option>
                        </select>
                        
                        <div class="order-actions">
                            <button @click="printOrder(o.id, 'scontrino')" style="background: #6b7280;"><i class="fa-solid fa-print"></i> Scontrino</button>
                            <button @click="printOrder(o.id, 'comanda')"><i class="fa-solid fa-receipt"></i> Comanda</button>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="view === 'impostazioni'" class="settings">
                <div v-if="!isOwner" class="access-container">
                    <h2 style="color: #6b7280;">Accesso Negato</h2>
                    <p>Solo il Titolare pu√≤ accedere alle impostazioni critiche.</p>
                    <input type="password" v-model="accessPin" @keyup.enter="grantAccess" placeholder="Inserisci PIN/Password Titolare">
                    <button @click="grantAccess" class="final-btn" style="max-width: 250px;">Accedi</button>
                </div>
                <div v-else>
                    <h2>Impostazioni <i class="fa-solid fa-gear"></i></h2>
                    
                    <div class="order-box">
                        <h3>Configurazione Accesso</h3>
                        <div class="form-row">
                            <label>PIN/Password Operatore (Attuale: {{ adminPin }})</label>
                            <form @submit.prevent="saveAdminPin">
                                <input type="text" v-model="newAdminPin" placeholder="Nuovo PIN/Password (min 4)">
                                <button type="submit">Salva</button>
                            </form>
                        </div>
                         <div class="form-row">
                            <label>PIN/Password Titolare (Attuale: {{ ownerPin }})</label>
                            <form @submit.prevent="saveOwnerPin">
                                <input type="text" v-model="newOwnerPin" placeholder="Nuovo PIN/Password (min 4)">
                                <button type="submit">Salva</button>
                            </form>
                        </div>
                        <button @click="logout" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Disconnetti</button>
                    </div>

                    <div class="order-box">
                        <h3>Capacit√† Oraria (Produzione)</h3>
                        <div class="form-row" style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label>Max Articoli per Slot</label>
                                <input type="number" v-model.number="capacitySettings.maxPizzas" min="1" @change="saveData">
                            </div>
                            <div style="flex: 1;">
                                <label>Durata Slot (Minuti)</label>
                                <input type="number" v-model.number="capacitySettings.intervalMinutes" min="10" step="5" @change="saveData">
                            </div>
                        </div>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">Gli ordini sono calcolati in base agli articoli in categorie 'Pizza' o composizioni (Mezzo Metro conta come 4).</p>
                    </div>

                    <div class="order-box">
                        <h3>Gestione Menu e Prezzi</h3>
                        <div class="cat-row">
                            <button v-for="(items, cat) in menu" :key="cat" :class="{'cat-btn': true, 'active': activeSettingsCat === cat}" @click="activeSettingsCat = cat">
                                {{ cat }}
                            </button>
                        </div>
                        
                        <form @submit.prevent="addItemToCategory">
                            <input type="text" v-model="newItemName" placeholder="Nome Articolo" required>
                            <input type="number" v-model.number="newItemPrice" step="0.50" min="0" placeholder="Prezzo" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>

                        <div class="settings-list">
                            <div v-for="(item, index) in menu[activeSettingsCat]" :key="item.nome" class="settings-item">
                                <span>{{ item.nome }} - ‚Ç¨{{ item.prezzo.toFixed(2) }}</span>
                                <div class="actions">
                                    <div class="item-status">
                                        <button :class="{available: !item.isFinished, finished: item.isFinished}" @click="toggleItemFinished(activeSettingsCat, index)">
                                            {{ item.isFinished ? 'Esaurito' : 'Disponibile' }}
                                        </button>
                                    </div>
                                    <button class="remove" @click="deleteItem(activeSettingsCat, index)">X</button>
                                </div>
                            </div>
                        </div>
                        
                        <form @submit.prevent="addCategory" style="margin-top: 10px;">
                            <input type="text" v-model="newCategoryName" placeholder="Nuova Categoria" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i> Cat</button>
                        </form>
                        <button v-if="activeSettingsCat" @click="deleteCategory(activeSettingsCat)" class="final-btn delete" style="background: #b91c1c; margin-top: 10px;">
                            Elimina Categoria ({{ activeSettingsCat }})
                        </button>
                    </div>

                    <div class="order-box">
                        <h3>Gestione Modificatori</h3>
                        <div class="cat-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': activeSettingsModCat === cat}" @click="activeSettingsModCat = cat">
                                {{ cat }}
                            </button>
                        </div>

                        <form @submit.prevent="addModifierToCategory">
                            <input type="text" v-model="newModifierName" placeholder="Nome Modificatore" required>
                            <input type="number" v-model.number="newModifierPrice" step="0.50" min="0" placeholder="Prezzo (0 se gratuito)" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>

                        <div class="settings-list">
                            <div v-for="(mod, index) in modifiers[activeSettingsModCat]" :key="mod.nome" class="settings-item">
                                <span>{{ mod.nome }} <span v-if="mod.prezzo > 0"> - ‚Ç¨{{ mod.prezzo.toFixed(2) }}</span></span>
                                <div class="actions">
                                    <div class="item-status">
                                        <button :class="{available: !mod.isFinished, finished: mod.isFinished}" @click="toggleModifierFinished(activeSettingsModCat, index)">
                                            {{ mod.isFinished ? 'Esaurito' : 'Disponibile' }}
                                        </button>
                                    </div>
                                    <button class="remove" @click="deleteModifier(activeSettingsModCat, index)">X</button>
                                </div>
                            </div>
                        </div>

                        <form @submit.prevent="addModifierCategory" style="margin-top: 10px;">
                            <input type="text" v-model="newModifierCategoryName" placeholder="Nuova Categoria Modificatori" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i> Cat</button>
                        </form>
                        <button v-if="activeSettingsModCat && !isDefaultModifierCategory(activeSettingsModCat)" @click="deleteModifierCategory(activeSettingsModCat)" class="final-btn delete" style="background: #b91c1c; margin-top: 10px;">
                            Elimina Categoria ({{ activeSettingsModCat }})
                        </button>
                    </div>

                    <div class="order-box">
                        <h3>Zone di Consegna e Costi</h3>
                        <form @submit.prevent="addZone">
                            <input type="text" v-model="newZoneName" placeholder="Nome Zona" required>
                            <input type="number" v-model.number="newZonePrice" step="0.50" min="0" placeholder="Costo Consegna" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <div class="settings-list">
                            <div v-for="(zone, index) in deliveryZones" :key="zone.name" class="settings-item">
                                <span>{{ zone.name }} - ‚Ç¨{{ zone.price.toFixed(2) }}</span>
                                <button class="remove" @click="deleteZone(index)">X</button>
                            </div>
                        </div>
                    </div>

                    <div class="order-box">
                        <h3>Fattorini/Driver</h3>
                        <form @submit.prevent="addDriver">
                            <input type="text" v-model="newDriverName" placeholder="Nome Fattorino" required>
                            <button type="submit"><i class="fa-solid fa-plus"></i></button>
                        </form>
                        <div class="settings-list">
                            <div v-for="(driver, index) in drivers" :key="driver" class="settings-item">
                                <span>{{ driver }}</span>
                                <button class="remove" @click="deleteDriver(index)">X</button>
                            </div>
                        </div>
                    </div>

                    <div class="order-box">
                        <h3>Dati e Cache</h3>
                        <button @click="exportData" class="final-btn" style="background: #007bff; margin-bottom: 10px;">Esporta Dati (JSON)</button>
                        <button @click="importData" class="final-btn" style="background: #ffc107; color: #333; margin-bottom: 10px;">Importa Dati (JSON)</button>
                        <button @click="clearCache" class="final-btn" style="background: #b91c1c;">Pulisci Cache (Solo Ordini e Storico)</button>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">**Pulisci Cache** rimuove SOLO ordini attivi e storico. Mantiene Menu, Prezzi, Clienti e PIN.</p>
                    </div>
                </div>
            </section>
        </main>

        <nav>
            <button @click="view = 'inserimento'" :class="{'active': view === 'inserimento'}">
                <i class="fa-solid fa-square-plus"></i> Inserimento
            </button>
            <button @click="view = 'ordini'" :class="{'active': view === 'ordini'}">
                <i class="fa-solid fa-list-check"></i> Ordini
            </button>
            <button @click="view = 'storico'" :class="{'active': view === 'storico'}" :disabled="!isAdmin">
                <i class="fa-solid fa-book"></i> Riepilogo
            </button>
            <button @click="view = 'impostazioni'" :class="{'active': view === 'impostazioni'}" :disabled="!isOwner">
                <i class="fa-solid fa-gear"></i> Impostazioni
            </button>
        </nav>
        
        <div v-if="showModal" class="modal-overlay" @click.self="showModal = false">
            <div class="modal-content">
                <h3>Finalizza Ordine - Totale: ‚Ç¨{{ total.toFixed(2) }}</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div v-for="m in modes" :key="m.id" :class="{'mode-card': true, 'active': mode === m.id}" @click="selectMode(m.id)">
                        <i :class="m.icon" style="font-size: 1.5rem; margin-right: 10px;"></i>
                        <span>{{ m.label }}</span>
                        <i class="fa-solid fa-circle-check" v-if="mode === m.id" style="color: #e31b23;"></i>
                    </div>
                </div>

                <div class="time-capacity" :class="{'full': isCapacityFull, 'warning': isCapacityWarning && !isCapacityFull}">
                    <div style="font-weight: 700;">Capacit√† ({{ capacitySettings.intervalMinutes }} min)</div>
                    <p style="margin: 3px 0; font-size: 0.85rem;">Slot: {{ orderCapacity.interval ? new Date(orderCapacity.interval).toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}) : '...' }}</p>
                    <p style="margin: 3px 0; font-size: 0.85rem;">Carico: {{ orderCapacity.total.toFixed(2) }}/{{ capacitySettings.maxPizzas }} (Rimanenti: {{ orderCapacity.remaining.toFixed(2) }})</p>
                </div>
                
                <div class="form-row" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="date-input">Data</label>
                        <input type="date" id="date-input" v-model="date" :min="minDate" @change="updateCapacityWarning">
                    </div>
                    <div style="flex: 1;">
                        <label for="hour-input">Ora</label>
                        <input type="time" id="hour-input" v-model="hour" @change="updateCapacityWarning">
                    </div>
                </div>

                <div class="form-row">
                    <label for="customer-input">Cliente/Riferimento</label>
                    <input type="text" id="customer-input" v-model="customer" @input="debouncedFilterCustomers" placeholder="Nome o Tavolo" required>
                    <div class="customer-suggestions" v-if="filteredCustomerSuggestions.length && customer.length > 1">
                        <div v-for="data in filteredCustomerSuggestions" :key="data.phone + data.address" 
                             @click="loadCustomerData(data)" 
                             style="padding: 8px; border-bottom: 1px dashed #ddd; cursor: pointer; background: #fff; font-size: 0.9rem;">
                            {{ data.customer }} ({{ data.address }} - {{ data.phone }})
                        </div>
                    </div>
                </div>

                <template v-if="mode === 'banco' || mode === 'asporto'">
                    <div class="form-row">
                        <label for="table-input">Tavolo / Ritiro</label>
                        <input type="text" id="table-input" v-model="tableNumber" placeholder="Es. Tavolo 5 o Ritiro B">
                    </div>
                    <div v-if="mode === 'asporto'" class="form-row">
                        <label for="phone-input">Telefono</label>
                        <input type="text" id="phone-input" v-model="phone" placeholder="Numero di telefono">
                    </div>
                </template>

                <template v-if="mode === 'consegna'">
                    <div class="form-row">
                        <label for="address-input">Indirizzo</label>
                        <input type="text" id="address-input" v-model="address" placeholder="Via/Piazza" required>
                    </div>
                    <div class="form-row" style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label for="number-input">Civico</label>
                            <input type="text" id="number-input" v-model="streetNumber" placeholder="N¬∞">
                        </div>
                        <div style="flex: 1;">
                            <label for="town-input">Citt√†</label>
                            <input type="text" id="town-input" v-model="town" placeholder="Citt√†">
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="zone-select">Zona di Consegna (Costo: ‚Ç¨{{ deliveryCost.toFixed(2) }})</label>
                        <select id="zone-select" v-model="zoneName" @change="updateDeliveryCost" required>
                            <option value="" disabled>Seleziona Zona</option>
                            <option v-for="zone in deliveryZones" :value="zone.name" :key="zone.name">
                                {{ zone.name }} (‚Ç¨{{ zone.price.toFixed(2) }})
                            </option>
                        </select>
                    </div>
                </template>
                
                <div class="form-row">
                    <label for="notes-input">Note Aggiuntive</label>
                    <textarea id="notes-input" v-model="notes" rows="2" placeholder="Note per la cucina o il fattorino"></textarea>
                </div>
                
                <div class="form-row">
                    <label for="acconto-input">Acconto Ricevuto (Opzionale)</label>
                    <input type="number" id="acconto-input" v-model.number="accontoRicevuto" step="0.50" min="0" placeholder="‚Ç¨0.00">
                    <p v-if="restoDaDare > 0" style="color: #10b981; font-weight: 700; margin-top: 5px;">Resto da dare: ‚Ç¨{{ restoDaDare.toFixed(2) }}</p>
                </div>

                <div class="modal-actions">
                    <button class="btn-cancel" @click="showModal = false">Annulla</button>
                    <button class="btn-confirm" @click="confermaOrdine" :disabled="!isOrderFinalizable">
                        Conferma Ordine - ‚Ç¨{{ total.toFixed(2) }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showMeterModal && tempMeterItem" class="modal-overlay" @click.self="cancelMeterComposition">
            <div class="modal-content">
                <h3>Componi: {{ tempMeterItem.nome }}</h3>
                <p style="font-size: 0.9rem; color: #666;">Seleziona i gusti e aggiungi i modificatori per ogni sezione.</p>
                
                <div class="order-box" style="margin-bottom: 15px;">
                    <div v-for="(section, sIdx) in tempMeterItem.sections" :key="sIdx" style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
                        <span style="font-weight: 700;">{{ section.name }}:</span> 
                        <span v-if="section.gusto">{{ section.gusto }}</span>
                        <button v-else @click="section.activeSection = true" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                        
                        <div v-if="section.modifiers && section.modifiers.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ section.modifiers.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                            <button @click="section.modifiers.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                        <button v-if="section.gusto" @click="section.activeSection = true" class="final-btn" style="padding: 5px 10px; max-width: 100px; background: #6b7280; margin: 0 5px;">Modifica</button>
                    </div>
                    <p class="total">Totale stimato: ‚Ç¨{{ calculateTempMeterTotal.toFixed(2) }}</p>
                </div>

                <div v-for="(section, sIdx) in tempMeterItem.sections" :key="'mod_form_' + sIdx">
                    <div v-if="section.activeSection">
                        <h4 style="color: #3b82f6; margin-top: 5px;">Componi: {{ section.name }}</h4>
                        
                        <div class="form-row">
                            <label>Seleziona Gusto</label>
                            <input type="text" v-model="gustoSearchTerm" @input="debouncedGustoSearch" placeholder="Cerca Pizza Base" class="search-mod-input">
                            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                                <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                    :class="{'item': true, 'active-menu-selection': section.gusto === gusto.nome}"
                                    @click="selectMeterGusto(sIdx, gusto.nome)">
                                    {{ gusto.nome }}
                                </div>
                            </div>
                        </div>

                        <label>Aggiungi Modificatori</label>
                        <div class="cat-row">
                            <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': tempModCat === cat}" @click="tempModCat = cat; modifierSearchTerm = ''">
                                {{ cat }}
                            </button>
                        </div>
                        <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                        <div class="mod-row">
                            <button v-for="mod in filteredTempModifiers" :key="mod.nome"
                                :class="{'mod-btn': true, 'green': tempModCat === 'Pi√π', 'gray': tempModCat === 'Senza', 'yellow': tempModCat === 'Poco', 'blue': tempModCat === 'Abbondante'}"
                                @click="addMeterModifier(sIdx, mod)">
                                {{ mod.nome }} <span v-if="mod.prezzo > 0">(+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span>
                            </button>
                        </div>
                        <button @click="section.activeSection = false; gustoSearchTerm = ''" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Chiudi Sezione</button>
                        <hr style="margin: 15px 0;">
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="btn-cancel" @click="cancelMeterComposition">Annulla</button>
                    <button class="btn-confirm" @click="addMeterToOrder" :disabled="!isMeterValid">
                        Aggiungi a Ordine (‚Ç¨{{ calculateTempMeterTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showHalfPizzaModal && tempHalfPizzaItem" class="modal-overlay" @click.self="cancelHalfPizzaComposition">
            <div class="modal-content">
                <h3>Componi: {{ tempHalfPizzaItem.nome }}</h3>
                <p style="font-size: 0.9rem; color: #666;">Seleziona i due gusti e aggiungi i modificatori specifici.</p>
                
                <div class="order-box" style="margin-bottom: 15px;">
                    <div style="padding: 5px 0; border-bottom: 1px dotted #ddd;">
                        <span style="font-weight: 700;">Gusto 1:</span> 
                        <span v-if="tempHalfPizzaItem.gusto1">{{ tempHalfPizzaItem.gusto1 }}</span>
                        <button @click="tempHalfPizzaItem.activeHalf = 1" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                        <div v-if="tempHalfPizzaItem.modifiers1 && tempHalfPizzaItem.modifiers1.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ tempHalfPizzaItem.modifiers1.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                            <button @click="tempHalfPizzaItem.modifiers1.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <div style="padding: 5px 0;">
                        <span style="font-weight: 700;">Gusto 2:</span> 
                        <span v-if="tempHalfPizzaItem.gusto2">{{ tempHalfPizzaItem.gusto2 }}</span>
                        <button @click="tempHalfPizzaItem.activeHalf = 2" class="final-btn" style="padding: 5px 10px; max-width: 150px; background: #3b82f6; margin: 0 5px;">Scegli Gusto</button>
                         <div v-if="tempHalfPizzaItem.modifiers2 && tempHalfPizzaItem.modifiers2.length > 0" style="font-size: 0.8rem; margin-top: 3px; padding-left: 10px;">
                            <span style="font-style: italic;">Mod: {{ tempHalfPizzaItem.modifiers2.map(m => m.icon + ' ' + m.nome).join(', ') }}</span>
                            <button @click="tempHalfPizzaItem.modifiers2.pop()" class="mod-remove-btn"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <p class="total">Totale stimato: ‚Ç¨{{ calculateTempHalfPizzaTotal.toFixed(2) }}</p>
                </div>

                <template v-if="tempHalfPizzaItem.activeHalf > 0">
                    <h4 style="color: #3b82f6; margin-top: 5px;">Componi: Met√† {{ tempHalfPizzaItem.activeHalf }}</h4>
                    
                    <div class="form-row">
                        <label>Seleziona Gusto</label>
                        <input type="text" v-model="gustoSearchTerm" @input="debouncedGustoSearch" placeholder="Cerca Pizza Base" class="search-mod-input">
                        <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                            <div v-for="gusto in filteredPizzaGusti" :key="gusto.nome" 
                                :class="{'item': true, 'active-menu-selection': (tempHalfPizzaItem.activeHalf === 1 ? tempHalfPizzaItem.gusto1 : tempHalfPizzaItem.gusto2) === gusto.nome}"
                                @click="selectHalfPizzaGusto(tempHalfPizzaItem.activeHalf, gusto.nome)">
                                {{ gusto.nome }}
                            </div>
                        </div>
                    </div>

                    <label>Aggiungi Modificatori</label>
                    <div class="cat-row">
                        <button v-for="(mods, cat) in modifiers" :key="cat" :class="{'cat-btn': true, 'active': tempModCat === cat}" @click="tempModCat = cat; modifierSearchTerm = ''">
                            {{ cat }}
                        </button>
                    </div>
                    <input type="text" v-model="modifierSearchTerm" placeholder="Cerca modificatore..." class="search-mod-input">
                    <div class="mod-row">
                        <button v-for="mod in filteredTempModifiers" :key="mod.nome"
                            :class="{'mod-btn': true, 'green': tempModCat === 'Pi√π', 'gray': tempModCat === 'Senza', 'yellow': tempModCat === 'Poco', 'blue': tempModCat === 'Abbondante'}"
                            @click="addHalfPizzaModifier(tempHalfPizzaItem.activeHalf, mod)">
                            {{ mod.nome }} <span v-if="mod.prezzo > 0">(+‚Ç¨{{ mod.prezzo.toFixed(2) }})</span>
                        </button>
                    </div>
                    <button @click="tempHalfPizzaItem.activeHalf = 0; gustoSearchTerm = ''" class="final-btn cancel-edit-btn" style="margin-top: 5px;">Chiudi Sezione</button>
                    <hr style="margin: 15px 0;">
                </template>
                
                <div class="modal-actions">
                    <button class="btn-cancel" @click="cancelHalfPizzaComposition">Annulla</button>
                    <button class="btn-confirm" @click="addHalfPizzaToOrder" :disabled="!isHalfPizzaValid">
                        Aggiungi a Ordine (‚Ç¨{{ calculateTempHalfPizzaTotal.toFixed(2) }})
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showPriceEditModal" class="modal-overlay" @click.self="showPriceEditModal = false">
            <div class="modal-content">
                <h3>Modifica Prezzo Articolo</h3>
                <p>Articolo: <span style="font-weight: 700;">{{ order[tempPriceEditIndex]?.nome }}</span></p>
                <div class="form-row">
                    <label for="new-price-input">Nuovo Prezzo (Manuale)</label>
                    <input type="number" id="new-price-input" v-model.number="newPriceValue" step="0.01" min="0" required>
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" @click="showPriceEditModal = false">Annulla</button>
                    <button class="btn-confirm" @click="saveNewPrice">Salva Prezzo Man. (‚Ç¨{{ newPriceValue.toFixed(2) }})</button>
                </div>
            </div>
        </div>

        <div v-if="showShareModal && selectedOrderForShare" class="modal-overlay" @click.self="showShareModal = false">
            <div class="modal-content">
                <h3>Condividi Ordine #{{ selectedOrderForShare.id }}</h3>
                <p>Scegli come condividere il riepilogo dell'ordine.</p>
                
                <div class="modal-actions">
                    <button class="btn-cancel" @click="showShareModal = false">Chiudi</button>
                    <button class="btn-confirm" style="background: #25d366;" @click="shareViaWhatsapp(selectedOrderForShare)">
                        <i class="fa-brands fa-whatsapp"></i> WhatsApp
                    </button>
                </div>
            </div>
        </div>

        <div class="print-container">
            <div id="print-content-comanda" class="print-comanda"></div>
            <div id="print-content-scontrino" class="print-scontrino"></div>
        </div>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const app = Vue.createApp({
            data() {
                return {
                    // Dati Base
                    view: 'inserimento', // 'inserimento', 'ordini', 'storico', 'impostazioni'
                    
                    // Accesso e Sicurezza
                    adminPin: '1234',
                    ownerPin: '0000',
                    accessPin: '',
                    isAccessGranted: false, 
                    userRole: '', 
                    newAdminPin: '',
                    newOwnerPin: '',
                    
                    // Dati Menu
                    menu: {
                        'Pizza Classica': [
                            { nome: 'Margherita', prezzo: 6.00, isFinished: false },
                            { nome: 'Diavola', prezzo: 7.50, isFinished: false },
                            { nome: 'Capricciosa', prezzo: 8.00, isFinished: false },
                            { nome: '4 Stagioni', prezzo: 8.00, isFinished: false },
                            { nome: 'Fornarina', prezzo: 5.00, isFinished: false },
                        ],
                        'Pizze Speciali': [
                            { nome: 'Pistacchio & Mortazza', prezzo: 12.00, isFinished: false },
                            { nome: 'Gourmet', prezzo: 14.00, isFinished: false },
                        ],
                        'Bevande': [
                            { nome: 'Acqua Nat', prezzo: 2.00, isFinished: false },
                            { nome: 'Coca Cola Latta', prezzo: 3.00, isFinished: false },
                        ],
                        'Dolci': [
                            { nome: 'Tiramis√π', prezzo: 4.50, isFinished: false },
                        ],
                        'Composizioni': [
                            { nome: 'Mezzo Metro', prezzo: 16.00, isMeter: true, isFinished: false, sections: [{name: 'Sezione 1', gusto: null, modifiers: []}, {name: 'Sezione 2', gusto: null, modifiers: []}, {name: 'Sezione 3', gusto: null, modifiers: []}, {name: 'Sezione 4', gusto: null, modifiers: []}] },
                            { nome: 'Schiacciata Grande', prezzo: 12.00, isMeter: true, isFinished: false, sections: [{name: 'Met√† 1', gusto: null, modifiers: []}, {name: 'Met√† 2', gusto: null, modifiers: []}]},
                            { nome: 'Pizza a Met√†', prezzo: 0.00, isHalfPizza: true, isFinished: false, gusto1: null, gusto2: null, modifiers1: [], modifiers2: []}
                        ]
                    },
                    
                    // Dati Modificatori
                    modifiers: {
                        'Pi√π': [
                            { nome: 'Mozzarella', prezzo: 0.50, isFinished: false },
                            { nome: 'Wurstel', prezzo: 1.00, isFinished: false },
                            { nome: 'Prosciutto', prezzo: 1.50, isFinished: false },
                        ],
                        'Senza': [
                            { nome: 'Aglio', prezzo: 0.00, isFinished: false },
                            { nome: 'Origano', prezzo: 0.00, isFinished: false },
                        ],
                        'Poco': [
                            { nome: 'Sale', prezzo: 0.00, isFinished: false },
                        ],
                        'Abbondante': [
                            { nome: 'Olio', prezzo: 0.00, isFinished: false },
                        ],
                    },

                    // Dati Ordine Corrente
                    order: [],
                    selectedItemIndex: null,
                    lastSelectedItem: null, 
                    searchTerm: '', 
                    modifierSearchTerm: '', 
                    activeCat: 'Pizza Classica',
                    activeModCat: 'Pi√π',
                    
                    // Modalit√† di Finalizzazione Ordine
                    modes: [
                        { id: 'banco', label: 'Tavolo/Banco', icon: 'fa-solid fa-utensils' },
                        { id: 'asporto', label: 'Asporto', icon: 'fa-solid fa-bag-shopping' },
                        { id: 'consegna', label: 'Consegna', icon: 'fa-solid fa-truck' }
                    ],
                    showModal: false,
                    
                    // Dati Modale
                    editingOrderId: null, 
                    mode: 'banco',
                    customer: '',
                    phone: '',
                    address: '',
                    streetNumber: '',
                    town: 'Roma',
                    tableNumber: '', 
                    date: '',
                    hour: '',
                    notes: '',
                    zoneName: '',
                    deliveryCost: 0.00,
                    accontoRicevuto: 0.00,
                    
                    // Dati di Sistema
                    lastOrderId: 0,
                    activeOrders: [],
                    archive: [],
                    deliveryZones: [
                        { name: 'Zona A', price: 3.00 },
                        { name: 'Zona B', price: 4.00 },
                    ],
                    drivers: ['Mario', 'Luigi', 'Yoshi'],
                    
                    // Storico e Statistiche
                    archiveDateFilter: new Date().toISOString().slice(0, 10),
                    selectedDriver: '',
                    driverStats: { totalOrders: 0, totalRevenue: 0 },
                    
                    // Filtri Ordini Attivi
                    activeOrderSearchTerm: '',
                    activeDateFilter: 'today', 

                    // Impostazioni/Menu
                    activeSettingsCatName: 'Pizza Classica',
                    newItemName: '',
                    newItemPrice: 0.00,
                    newCategoryName: '',

                    // Impostazioni Modificatori
                    activeSettingsModCatName: 'Pi√π',
                    newModifierName: '',
                    newModifierPrice: 0.00,
                    newModifierCategoryName: '',

                    // Impostazioni Zone
                    newZoneName: '',
                    newZonePrice: 0.00,
                    
                    // Impostazioni Fattorini
                    newDriverName: '',

                    // Capacit√† Oraria
                    capacitySettings: {
                        maxPizzas: 20,
                        intervalMinutes: 30
                    },
                    orderCapacity: {
                        interval: null,
                        total: 0,
                        remaining: 20,
                        warning: false 
                    },
                    
                    // Composizioni (Metri/Mezze Pizze)
                    showMeterModal: false,
                    tempMeterItem: null,
                    gustoSearchTerm: '',
                    tempModCat: 'Pi√π',
                    showHalfPizzaModal: false,
                    tempHalfPizzaItem: null,

                    // Modifica Prezzo
                    showPriceEditModal: false,
                    tempPriceEditIndex: null,
                    newPriceValue: 0.00,

                    // Condivisione
                    showShareModal: false,
                    selectedOrderForShare: null,
                    
                    // Suggerimenti Cliente
                    customerHistory: [],
                    filteredCustomerSuggestions: []
                };
            },
            
            computed: {
                isOwner() {
                    return this.userRole === 'Titolare';
                },
                isAdmin() {
                    return this.isAccessGranted;
                },
                
                // --- Calcoli Ordine Corrente ---
                calculatedOrderTotal() {
                    return this.order.reduce((total, item) => total + this.calculateItemTotal(item), 0);
                },
                total() {
                    return this.calculatedOrderTotal + this.deliveryCost;
                },
                restoDaDare() {
                    const totalToPay = this.total;
                    return Math.max(0, this.accontoRicevuto - totalToPay);
                },

                // Controlla se l'ordine √® finalizzabile
                isOrderFinalizable() {
                    if (this.order.length === 0 || !this.customer) return false;
                    if (this.mode === 'consegna' && (!this.address || !this.zoneName)) return false;
                    return true;
                },

                // --- Filtri e Disponibilit√† ---
                filteredAvailableItems() {
                    const items = this.menu[this.activeCat] || [];
                    const term = this.searchTerm.toLowerCase();
                    return items.filter(item => 
                        item.nome.toLowerCase().includes(term)
                    );
                },
                filteredModifiersForActiveCat() {
                    const mods = this.modifiers[this.activeModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term)
                    );
                },

                // --- Capacit√† Oraria Computed ---
                isCapacityWarning() {
                    return this.orderCapacity.warning;
                },
                isCapacityFull() {
                    // Controlla il totale (float) vs Max (int)
                    return this.orderCapacity.remaining <= 0.01; 
                },
                minDate() {
                    return new Date().toISOString().slice(0, 10);
                },

                // --- Composizioni Computed ---
                allPizzaGusti() {
                    return (this.menu['Pizza Classica'] || []).concat(this.menu['Pizze Speciali'] || []).filter(item => !item.isFinished);
                },
                filteredPizzaGusti() {
                    const term = this.gustoSearchTerm.toLowerCase();
                    return this.allPizzaGusti.filter(item => 
                        item.nome.toLowerCase().includes(term)
                    );
                },
                filteredTempModifiers() {
                    const mods = this.modifiers[this.tempModCat] || [];
                    const term = this.modifierSearchTerm.toLowerCase();
                    return mods.filter(mod => 
                        mod.nome.toLowerCase().includes(term) && !mod.isFinished
                    );
                },
                calculateTempMeterTotal() {
                    if (!this.tempMeterItem) return 0;
                    
                    let basePrice = this.tempMeterItem.prezzo;
                    let modTotal = 0;

                    this.tempMeterItem.sections.forEach(section => {
                        modTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                    });

                    return basePrice + modTotal;
                },
                isMeterValid() {
                    if (!this.tempMeterItem) return false;
                    return this.tempMeterItem.sections.every(section => section.gusto !== null);
                },
                calculateTempHalfPizzaTotal() {
                    if (!this.tempHalfPizzaItem) return 0;
                    
                    const item = this.tempHalfPizzaItem;
                    const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                    const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                    
                    // Se manca un gusto, il prezzo √® 0 per evitare calcoli errati
                    if (!item.gusto1 || !item.gusto2) return 0; 

                    const avgBasePrice = (price1 + price2) / 2;
                    
                    let modTotal = 0;
                    modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                    modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);
                    
                    return avgBasePrice + modTotal;
                },
                isHalfPizzaValid() {
                    if (!this.tempHalfPizzaItem) return false;
                    return this.tempHalfPizzaItem.gusto1 !== null && this.tempHalfPizzaItem.gusto2 !== null;
                },

                // --- Ordini Attivi ---
                filteredActiveOrders() {
                    let orders = this.activeOrders.filter(o => {
                        const orderDate = new Date(o.date);
                        const today = new Date();
                        const tomorrow = new Date();
                        tomorrow.setDate(today.getDate() + 1);

                        // Reset time for comparison
                        today.setHours(0, 0, 0, 0);
                        tomorrow.setHours(0, 0, 0, 0);
                        orderDate.setHours(0, 0, 0, 0);

                        if (this.activeDateFilter === 'today') {
                            return orderDate.getTime() === today.getTime();
                        } else if (this.activeDateFilter === 'tomorrow') {
                            return orderDate.getTime() === tomorrow.getTime();
                        } else if (this.activeDateFilter === 'future') {
                            const dayAfterTomorrow = new Date();
                            dayAfterTomorrow.setDate(today.getDate() + 2);
                            dayAfterTomorrow.setHours(0, 0, 0, 0);
                            return orderDate.getTime() >= dayAfterTomorrow.getTime();
                        }
                        return true;
                    });
                    
                    const term = this.activeOrderSearchTerm.toLowerCase();
                    if (term) {
                        orders = orders.filter(o => 
                            o.customer.toLowerCase().includes(term) ||
                            (o.tableNumber && o.tableNumber.toLowerCase().includes(term)) ||
                            (o.address && o.address.toLowerCase().includes(term))
                        );
                    }

                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeA - timeB;
                    });
                },
                
                // --- Storico ---
                filteredArchive() {
                    let orders = this.archive.filter(o => o.date === this.archiveDateFilter);
                    if (this.selectedDriver) {
                        orders = orders.filter(o => o.driver === this.selectedDriver);
                    }
                    return orders.sort((a, b) => {
                        const timeA = new Date(`${a.date}T${a.hour}`);
                        const timeB = new Date(`${b.date}T${b.hour}`);
                        return timeB - timeA; 
                    });
                },
                dailyTotal() {
                    return this.filteredArchive.reduce((sum, o) => sum + o.total, 0);
                },
                archiveDateFilterDisplay() {
                    const date = new Date(this.archiveDateFilter);
                    return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' });
                },

                // --- Impostazioni ---
                activeSettingsCat: {
                    get() {
                        if (!this.menu[this.activeSettingsCatName]) {
                            this.activeSettingsCatName = Object.keys(this.menu)[0];
                        }
                        return this.activeSettingsCatName;
                    },
                    set(val) {
                        this.activeSettingsCatName = val;
                    }
                },
                activeSettingsModCat: {
                    get() {
                        if (!this.modifiers[this.activeSettingsModCatName]) {
                            this.activeSettingsModCatName = Object.keys(this.modifiers)[0];
                        }
                        return this.activeSettingsModCatName;
                    },
                    set(val) {
                        this.activeSettingsModCatName = val;
                    }
                },
                availableDrivers() {
                    return ['', ...this.drivers];
                }
            },
            
            watch: {
                view(newView) {
                    if (newView !== 'inserimento') {
                        this.selectedItemIndex = null;
                    }
                    if (newView === 'storico' && this.isAdmin) {
                        this.calculateDriverStats();
                    }
                    this.saveData(); 
                },
                order: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                },
                activeOrders: {
                    handler() {
                        this.updateCapacityWarning(); 
                    },
                    deep: true
                }
            },
            
            methods: {
                // --- Utilit√† ---
                debounce(func, delay) {
                    let timeout;
                    return function(...args) {
                        const context = this;
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(context, args), delay);
                    };
                },
                // --- Funzioni di Accesso e Logout ---
                grantAccess() {
                    if (this.accessPin === this.ownerPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Titolare';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Titolare Concesso.');
                    } else if (this.accessPin === this.adminPin) {
                        this.isAccessGranted = true;
                        this.userRole = 'Operatore';
                        this.accessPin = '';
                        this.saveData();
                        alert('Accesso Operatore Concesso.');
                    } else if (this.accessPin) {
                        alert('PIN/Password errato.');
                        this.accessPin = '';
                    }
                },
                // ... (Altri metodi di accesso e PIN restano invariati) ...
                
                // --- Persistenza Dati (LocalStorage) ---
                loadData() {
                    try {
                        const data = localStorage.getItem('pizzeriaSmartData');
                        if (data) {
                            const parsedData = JSON.parse(data);
                            Object.assign(this, parsedData);

                            // Inizializza i valori predefiniti per le nuove propriet√† se non esistono
                            // ... (logica di fallback per le propriet√† mancanti) ...
                            
                            this.archiveDateFilter = new Date().toISOString().slice(0, 10);
                            this.ensureItemStatus();

                            if (this.isAccessGranted && this.userRole) {
                                if (this.userRole === 'Operatore' && parsedData.adminPin !== this.adminPin) {
                                    this.logout();
                                }
                                if (this.userRole === 'Titolare' && parsedData.ownerPin !== this.ownerPin) {
                                    this.logout();
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Errore caricamento dati:", e);
                    }
                },
                // ... (saveData, ensureItemStatus restano invariati) ...

                // --- Funzioni Ordine Corrente ---
                calculateItemTotal(item) {
                    if (item.manualPrice !== undefined) return item.manualPrice;
                    
                    let basePrice = item.prezzo || 0;
                    let modTotal = 0;
                    
                    if (item.isHalfPizza) {
                        // ... (logica di calcolo Pizza a Met√†) ...
                        if (!item.gusto1 || !item.gusto2) return 0; // Prezzo 0 se incompleta
                        
                        const price1 = this.allPizzaGusti.find(g => g.nome === item.gusto1)?.prezzo || 0;
                        const price2 = this.allPizzaGusti.find(g => g.nome === item.gusto2)?.prezzo || 0;
                        basePrice = (price1 + price2) / 2; 

                        modTotal += item.modifiers1.reduce((sum, mod) => sum + mod.prezzo, 0);
                        modTotal += item.modifiers2.reduce((sum, mod) => sum + mod.prezzo, 0);

                    } else if (item.isMeter) {
                        // ... (logica di calcolo Mezzo Metro) ...
                        item.sections.forEach(section => {
                            modTotal += section.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0);
                        });

                    } else {
                        // Articoli Standard
                        modTotal = item.modifiers ? item.modifiers.reduce((sum, mod) => sum + mod.prezzo, 0) : 0;
                    }
                    
                    return basePrice + modTotal;
                },
                
                handleItemClick(item) {
                    if (item.isFinished) return;
                    
                    this.selectedItemIndex = null; 
                    this.lastSelectedItem = item; 

                    // Clona l'oggetto menu base (solo il primo livello)
                    const newItemBase = Object.assign({}, item); 
                    
                    if (item.isMeter) {
                        this.openMeterCompositionModal(newItemBase);
                    } else if (item.isHalfPizza) {
                        this.openHalfPizzaCompositionModal(newItemBase);
                    } else {
                        this.addItem(newItemBase);
                    }
                },
                addItem(item) {
                    if (item.isFinished) return;
                    // Uso Object.assign per copiare le propriet√† senza riferimenti profondi non voluti
                    const newItem = Object.assign({}, item);
                    
                    delete newItem.isMeter;
                    delete newItem.sections;
                    delete newItem.isHalfPizza;
                    delete newItem.gusto1;
                    delete newItem.gusto2;
                    delete newItem.modifiers1;
                    delete newItem.modifiers2;
                    
                    // Inizializza array modificatori per articolo standard
                    newItem.modifiers = []; 
                    this.order.push(newItem);
                    this.selectedItemIndex = this.order.length - 1; 
                },
                // ... (removeItem e selectItem restano invariati) ...
                
                // --- Gestione Modificatori Articolo Standard ---
                addExtra(mod) {
                    if (mod.isFinished || this.selectedItemIndex === null || this.order[this.selectedItemIndex]?.isMeter || this.order[this.selectedItemIndex]?.isHalfPizza) {
                        alert("Seleziona prima un articolo standard nel carrello.");
                        return;
                    }
                    
                    const selectedItem = this.order[this.selectedItemIndex];
                    const newMod = Object.assign({}, mod); // Clona il modificatore
                    
                    // Aggiunge propriet√† per la visualizzazione efficiente nel carrello (MIGLIORAMENTO)
                    newMod.category = this.activeModCat;
                    newMod.icon = this.getModifierIcon(this.activeModCat);
                    
                    // Gestione "Senza"
                    if (this.activeModCat === 'Senza') {
                        selectedItem.modifiers = selectedItem.modifiers.filter(m => 
                            m.nome !== mod.nome
                        );
                    }
                    
                    if (this.activeModCat !== 'Senza') {
                        selectedItem.modifiers.push(newMod);
                    }
                    // Forzo aggiornamento per reattivit√†
                    this.order[this.selectedItemIndex] = Object.assign({}, selectedItem); 
                    this.selectedItemIndex = this.order.length - 1; 
                },
                getModifierCategory(modName) {
                    for (const cat in this.modifiers) {
                        if (this.modifiers[cat].some(mod => mod.nome === modName)) {
                            return cat;
                        }
                    }
                    return '';
                },
                getModifierIcon(category) {
                    switch (category) {
                        case 'Pi√π': return '‚ûï';
                        case 'Senza': return '‚ûñ';
                        case 'Poco': return 'ü§è';
                        case 'Abbondante': return 'üßÖ'; 
                        default: return '‚Ä¢';
                    }
                },

                // --- Composizioni (Mezzo Metro/Schiacciata) ---
                // ... (openMeterCompositionModal, cancelMeterComposition, selectMeterGusto restano simili) ...
                addMeterModifier(sectionIndex, mod) {
                    if (mod.isFinished) return;
                    const newMod = Object.assign({}, mod);
                    newMod.category = this.tempModCat;
                    newMod.icon = this.getModifierIcon(this.tempModCat); // Aggiunge icona e categoria
                    
                    const sections = this.tempMeterItem.sections;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        sections[sectionIndex].modifiers = sections[sectionIndex].modifiers.filter(m => 
                            m.nome !== mod.nome
                        );
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        sections[sectionIndex].modifiers.push(newMod);
                    }
                },
                addMeterToOrder() {
                    if (!this.isMeterValid) {
                        alert('Devi selezionare un gusto per ogni sezione.');
                        return;
                    }
                    
                    const finalItem = Object.assign({}, this.tempMeterItem);
                    finalItem.prezzo = this.calculateTempMeterTotal; 
                    
                    finalItem.sections.forEach(s => delete s.activeSection);
                    delete finalItem.activeSection; 
                    delete finalItem.modifiers; 
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelMeterComposition();
                },

                // --- Composizioni (Pizza a Met√†) ---
                // ... (openHalfPizzaCompositionModal, cancelHalfPizzaComposition, selectHalfPizzaGusto restano simili) ...
                addHalfPizzaModifier(halfNumber, mod) {
                    if (mod.isFinished) return;
                    const newMod = Object.assign({}, mod);
                    newMod.category = this.tempModCat;
                    newMod.icon = this.getModifierIcon(this.tempModCat); // Aggiunge icona e categoria
                    
                    const modifiersArray = halfNumber === 1 ? this.tempHalfPizzaItem.modifiers1 : this.tempHalfPizzaItem.modifiers2;
                    
                    // Gestione "Senza"
                    if (this.tempModCat === 'Senza') {
                        const index = modifiersArray.findIndex(m => m.nome === mod.nome);
                        if (index !== -1) modifiersArray.splice(index, 1);
                    }
                    
                    if (this.tempModCat !== 'Senza') {
                        modifiersArray.push(newMod);
                    }
                },
                addHalfPizzaToOrder() {
                    if (!this.isHalfPizzaValid) {
                        alert('Devi selezionare entrambi i gusti per la pizza a met√†.');
                        return;
                    }
                    
                    const finalItem = Object.assign({}, this.tempHalfPizzaItem);
                    finalItem.prezzo = this.calculateTempHalfPizzaTotal; 
                    delete finalItem.activeHalf; 
                    
                    this.order.push(finalItem);
                    this.selectedItemIndex = this.order.length - 1; 
                    this.cancelHalfPizzaComposition();
                },
                
                // --- Modifica Prezzo Man. ---
                openPriceEditModal(index) {
                    this.tempPriceEditIndex = index;
                    const item = this.order[index];
                    // Se non ha un prezzo manuale, usa il prezzo di vendita calcolato come punto di partenza
                    this.newPriceValue = item.manualPrice !== undefined ? item.manualPrice : this.calculateItemTotal(item); 
                    this.showPriceEditModal = true;
                },
                saveNewPrice() {
                    if (this.tempPriceEditIndex !== null && this.newPriceValue >= 0) {
                        this.order[this.tempPriceEditIndex].manualPrice = parseFloat(this.newPriceValue.toFixed(2));
                        this.showPriceEditModal = false;
                        this.tempPriceEditIndex = null;
                        this.newPriceValue = 0.00;
                        this.saveData(); // Salva dopo la modifica
                    }
                },

                // --- Funzioni Modal e Finalizzazione Ordine ---
                // ... (openModal, selectMode, updateDeliveryCost restano invariati) ...
                confermaOrdine() {
                    if (!this.isOrderFinalizable) {
                        alert("Per finalizzare l'ordine devi inserire Cliente e Articoli. Controlla anche Indirizzo e Zona se in modalit√† Consegna.");
                        return;
                    }
                    // ... (logica di avviso capacit√† e conferma) ...
                    if (this.isCapacityFull) {
                        if (!confirm("ATTENZIONE: La fascia oraria √® al completo. Vuoi comunque confermare l'ordine?")) {
                            return;
                        }
                    }

                    const newOrder = {
                        id: this.editingOrderId || ++this.lastOrderId,
                        date: this.date,
                        hour: this.hour,
                        mode: this.mode,
                        customer: this.customer.trim(),
                        phone: this.phone.trim() || '',
                        address: this.address.trim() || '',
                        streetNumber: this.streetNumber.trim() || '',
                        town: this.town.trim() || 'Roma',
                        tableNumber: this.tableNumber.trim() || '',
                        zone: this.zoneName,
                        deliveryCost: this.deliveryCost,
                        notes: this.notes,
                        accontoRicevuto: this.accontoRicevuto,
                        total: this.total,
                        items: JSON.parse(JSON.stringify(this.order)), 
                        status: 'Preparazione', 
                        driver: '',
                        timestamp: new Date().toISOString() 
                    };

                    this.addOrUpdateOrder(newOrder);
                    this.saveCustomerHistory(newOrder);

                    // Reset
                    this.order = [];
                    this.selectedItemIndex = null;
                    this.showModal = false;
                    this.editingOrderId = null;
                    this.updateCapacityWarning();
                    this.saveData(); 
                },
                
                // ... (addOrUpdateOrder, saveCustomerHistory, loadCustomerData restano invariati) ...
                
                // --- Gestione Cliente (MIGLIORAMENTO DEBOUNCE) ---
                debouncedFilterCustomers: null, // Sar√† inizializzato in mounted
                filterCustomers() {
                    const term = this.customer.toLowerCase().trim();
                    if (term.length < 2) {
                        this.filteredCustomerSuggestions = [];
                        return;
                    }
                    this.filteredCustomerSuggestions = this.customerHistory.filter(data => 
                        data.customer.toLowerCase().includes(term) ||
                        data.address.toLowerCase().includes(term) ||
                        data.phone.includes(term)
                    ).slice(0, 5);
                },

                // --- Funzioni Ordini Attivi ---
                // ... (getNextStatus, advance, archiveOrder, editOrder, cancelEdit, updateActiveOrderDriver, duplicateOrder restano invariati) ...

                // --- Avvisi Temporali e Capacit√† (MIGLIORAMENTO LOGICA PONDERATA) ---
                // ... (isFutureOrder, isNear, isUrgent restano invariati) ...
                
                calculateOrderWeightedPizzas(items) {
                    let totalPizzas = 0;
                    items.forEach(item => {
                        let itemPizzaCount = 0;
                        let modCount = 0;
                        
                        const itemBase = this.findMenuItemBase(item.nome);
                        const category = itemBase ? itemBase.category : '';

                        if (category === 'Pizza Classica' || category === 'Pizze Speciali') {
                            itemPizzaCount += 1;
                        } else if (item.isMeter && item.nome === 'Mezzo Metro') {
                            itemPizzaCount += 4; // 4 porzioni
                        } else if (item.isHalfPizza) {
                            itemPizzaCount += 1; // 1 pizza
                        } else if (item.isMeter && item.nome === 'Schiacciata Grande') {
                            itemPizzaCount += 2; // 2 porzioni
                        }

                        // Calcola modificatori a pagamento (ponderazione extra)
                        if (item.modifiers) {
                            modCount += item.modifiers.filter(m => m.prezzo > 0).length;
                        } 
                        if (item.isHalfPizza) {
                            modCount += item.modifiers1.filter(m => m.prezzo > 0).length;
                            modCount += item.modifiers2.filter(m => m.prezzo > 0).length;
                        }
                        if (item.isMeter) {
                            item.sections.forEach(s => modCount += s.modifiers.filter(m => m.prezzo > 0).length);
                        }

                        // Aggiunge la ponderazione: 0.25 unit√† di carico per ogni modificatore a pagamento
                        totalPizzas += itemPizzaCount + (modCount * 0.25);
                    });
                    return totalPizzas;
                },
                
                findMenuItemBase(itemName) {
                    for (const cat in this.menu) {
                        const item = this.menu[cat].find(menuItem => menuItem.nome === itemName);
                        if (item) return { ...item, category: cat };
                    }
                    return null;
                },

                calculateCapacity(targetDateTime) {
                    const slotMinutes = this.capacitySettings.intervalMinutes;
                    const maxPizzas = this.capacitySettings.maxPizzas;

                    // Calcola l'inizio del blocco temporale
                    const tempDate = new Date(targetDateTime);
                    const minutes = tempDate.getMinutes();
                    const startMinutes = Math.floor(minutes / slotMinutes) * slotMinutes;
                    tempDate.setMinutes(startMinutes, 0, 0);
                    const intervalStart = tempDate.getTime();
                    const intervalEnd = intervalStart + (slotMinutes * 60 * 1000);

                    // Calcolo pizze ponderate per l'ordine corrente
                    const currentOrderWeightedPizzas = this.calculateOrderWeightedPizzas(this.order);

                    // Ordini attivi che cadono in questo slot
                    let totalWeightedPizzasInSlot = 0;
                    this.activeOrders.forEach(o => {
                        if (o.id === this.editingOrderId) return; 

                        const orderTime = new Date(`${o.date}T${o.hour}`).getTime();
                        
                        if (orderTime >= intervalStart && orderTime < intervalEnd) {
                            totalWeightedPizzasInSlot += this.calculateOrderWeightedPizzas(o.items);
                        }
                    });

                    totalWeightedPizzasInSlot += currentOrderWeightedPizzas;

                    this.orderCapacity.interval = intervalStart;
                    this.orderCapacity.total = totalWeightedPizzasInSlot;
                    this.orderCapacity.remaining = maxPizzas - totalWeightedPizzasInSlot;
                    // Avviso all'80% di capacit√†
                    this.orderCapacity.warning = totalWeightedPizzasInSlot >= maxPizzas * 0.8; 
                },

                updateCapacityWarning() {
                    const targetDate = this.date || new Date().toISOString().slice(0, 10);
                    const targetHour = this.hour || new Date().toTimeString().slice(0, 5);
                    
                    if (targetDate && targetHour) {
                        const targetDateTime = new Date(`${targetDate}T${targetHour}`);
                        this.calculateCapacity(targetDateTime);
                    } else {
                        this.orderCapacity = { interval: null, total: 0, remaining: this.capacitySettings.maxPizzas, warning: false };
                    }
                },

                // --- Stampa e Condivisione ---
                // ... (printOrder, generateComandaHTML, generateScontrinoHTML, printContent restano simili) ...
                
                // --- Funzioni Storico/Archivio ---
                // ... (calculateDriverStats, updateArchiveDriver restano invariati) ...

                // --- Funzioni Impostazioni/Gestione Dati ---
                // ... (Tutte le funzioni di gestione Menu, Modificatori, Zone, Fattorini restano invariate, ma chiamano saveData() ) ...
                
                // --- Import/Export ---
                // ... (exportData, importData, clearCache restano invariati) ...

                // --- Utilit√† ---
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                },
                formatDateTime(isoString) {
                    const date = new Date(isoString);
                    return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) + ' ' + date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
                }
            },

            mounted() {
                this.loadData();
                this.updateCapacityWarning(); 
                
                // Inizializza Debounce per la ricerca clienti
                this.debouncedFilterCustomers = this.debounce(this.filterCustomers, 300);
                
                // Inizializza Debounce per la ricerca gusti
                this.debouncedGustoSearch = this.debounce((e) => { this.gustoSearchTerm = e.target.value; }, 300);

                // Aggiorna la capacit√† ogni 60 secondi per gli ordini in tempo reale e gli avvisi
                setInterval(() => {
                    if (this.view === 'ordini' || this.showModal) {
                        this.updateCapacityWarning(); 
                    }
                }, 60 * 1000); 
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
